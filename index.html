<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Agente Clara</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js + plugin de data labels para o gr√°fico de faturas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:none;
        width:100%; 
        margin:0;
        display:flex;
        flex-direction:column;
        height:100%;
        min-height:0;
    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:0.5rem 1.25rem 0.75rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        background-color:#005E27;
        color:#B5FF20;
        margin-bottom:0.5rem;
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:100px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex: 1;
        display:flex;
        flex-direction:column;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
        min-height:0;
    }
    .chat-window {
        flex:1;              /* ocupa todo o espa√ßo dispon√≠vel dentro do main */
        overflow-y:auto;     /* ativa scroll interno das mensagens */
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
        padding:1rem 1.5rem; /* opcional: espa√ßo interno */
}

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digita√ß√£o menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do hist√≥rico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links nas respostas do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }

    /* ===== Tooltips dos bot√µes de pend√™ncias/justificativas ===== */
.vektor-btn-wrapper {
  position: relative;
  display: inline-block;
}

.vektor-tooltip-base {
  position: absolute;
  bottom: 110%;           /* aparece logo acima do bot√£o */
  right: 0;
  z-index: 9999;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 11px;
  color: #FFFFFF;            /* texto SEMPRE branco, como voc√™ pediu */
  background: rgba(0,0,0,0.85); /* ser√° sobrescrito inline por bot√£o */
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  box-shadow: 0 2px 6px rgba(15,23,42,0.25);
}

.vektor-btn-wrapper:hover .vektor-tooltip-base {
  opacity: 1;
}

/* ===== Spinner de carregamento para pend√™ncias/justificativas ===== */
.vektor-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #0f172a;
}

.vektor-spinner {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  border: 2px solid #e5e7eb;
  border-top-color: #0f172a;
  animation: vektor-spin 0.7s linear infinite;
}

@keyframes vektor-spin {
  to {
    transform: rotate(360deg);
  }
}

/* === VEKTOR AUTOCOMPLETE === */
#vektor-autocomplete-box {
  margin-top: 4px;
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  z-index: 9999;
  display: none;
  font-size: 13px;
  max-height: 220px;
  overflow-y: auto;
}

.vektor-autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
}

.vektor-autocomplete-item:hover {
  background: #B5FF20;
}

.vektor-autocomplete-item.is-active {
  background: #B5FF20;
}

#attachBtn {
    background-color: transparent !important;
    border-color: #cbd5e1 !important; /* mant√©m o cinza do Tailwind */
    color: #0f172a !important;         /* mant√©m cor do √≠cone */
}


</style>

<style>
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      height: 24px;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background-color: #94a3b8;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>

</head>
 <body class="text-slate-800">

    <!-- Topbar com login, tipo de acesso e rel√≥gio -->
      <div id="vektor-topbar" 
          class="w-full px-6 pt-3 pb-1 text-[11px] text-black leading-tight">
  <div id="vektor-user-info" class="font-semibold"></div>
  <div id="vektor-clock" class="mt-0.5 font-normal"></div>
</div>
 
 <div class="h-screen flex px-4 py-6 gap-4 items-stretch">
   <!-- COLUNA ESQUERDA: MENU LATERAL -->
   
   <aside class="hidden md:flex w-72 flex-col bg-white rounded-xl shadow-lg border border-slate-200 p-4 space-y-4 h-full">

  <!-- Bloco Vektor + t√≠tulo -->
  <div class="w-full flex flex-col items-center mb-4">
    <img
      src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
      alt="Assistente Clara (rob√¥)"
      class="h-24 w-auto mb-3"
    />
    <h1 class="text-xl font-extrabold bg-[#005E27] text-[#B5FF20] px-3 py-2 rounded-lg text-center">
      Grupo SBF | Vektor
    </h1>
  </div>

  <!-- T√≠tulo do menu -->
  <div class="w-full text-center mb-1">
    <p class="text-base font-semibold text-black">Menu</p>
  </div>

  <!-- Bot√£o: assistir apresenta√ß√£o -->
  <button
    type="button"
    onclick="window.open('https://drive.google.com/file/d/1S8j9FuT9Vkc8kNZ_e5wX3cxfGXq3r5L5/view?usp=sharing','_blank')"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    ‚ñ∂ Apresenta√ß√£o Vektor
  </button>

  <!-- Bot√£o: relat√≥rio Looker Studio -->
  <button
    type="button"
    onclick="window.open('https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF/edit','_blank')"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    üìä Relat√≥rio Clara (Looker Studio)
  </button>

  <!-- Bot√£o: Feedback -->
  <button
    type="button"
    onclick= "window.open('https://forms.gle/QSAS9VN4HSws78W99')"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    üìù Feedback
  </button>
  
</aside>
 
   <!-- COLUNA DIREITA: CHAT -->
   <div class="flex-1">
     <div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
  <div class="chat-header-inner">
    <div class="chat-header-left">
      <div class="examples"></div>
      <div class="policy-note text-[12px] mt-2"></div>
    </div>
  </div>
</header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

                        <!-- Mensagem inicial do bot -->
                <div class="flex items-start gap-3">
                    <img
                        src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
                        alt="Assistente Clara (rob√¥)"
                        class="h-16 w-auto object-contain flex-shrink-0"
                    />
                    <div class="bot-bubble px-4 py-3 max-w-[80%] text-slate-700">
                        <p class="font-semibold text-slate-800 text-base">
                            Ol√°! üëã Eu sou o Vektor, atleta do <b>Grupo SBF</b> especializado na Clara.
                        </p>
                    </div>
                </div>
                </div>     <!-- fecha #chatWindow -->
              </main>      <!-- fecha .chat-body -->

<!-- Modal de apresenta√ß√£o do Vektor -->

<div id="vektorModal"
     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
     style="display:none;">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[600px] w-[95%]">
    <div class="rounded-xl overflow-hidden">
      <iframe
        src="https://drive.google.com/file/d/1S8j9FuT9Vkc8kNZ_e5wX3cxfGXq3r5L5/preview"
        width="100%"
        height="340"
        allow="autoplay"
        style="border:0;"
      ></iframe>
    </div>

    <button onclick="closeVektorModal()"
            class="mt-3 w-full bg-[#005E27] text-white py-2 rounded-lg text-sm font-semibold">
      Continuar
    </button>
  </div>
</div>

<!-- Modal do Manual da Clara -->
<div id="manualClaraModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[520px] w-[95%]">
    <h2 class="text-base font-semibold text-slate-800 mb-2">
      Manual da Clara ‚Äì principais t√≥picos
    </h2>
    <p class="text-xs text-slate-500 mb-3">
      Escolha um dos itens abaixo. A resposta aparece aqui no chat.
    </p>

    <div class="flex flex-col gap-2 text-sm text-slate-700">

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('primeiro_acesso'); closeManualClaraModal();">
        01 Primeiro acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('recebi_cartao'); closeManualClaraModal();">
        02 Recebi o cart√£o, e agora?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('esqueci_senha'); closeManualClaraModal();">
        03 Esqueci a senha do cart√£o / acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('qual_meu_acesso'); closeManualClaraModal();">
        04 Qual o meu acesso?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('anexar_comprovante'); closeManualClaraModal();">
        05 Como anexar comprovante?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('duvidas'); closeManualClaraModal();">
        06 D√∫vidas
      </button>
    </div>

    <button type="button"
            onclick="closeManualClaraModal()"
            class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<!-- AUTOCOMPLETE BOX -->
<div id="vektor-autocomplete-box"></div>

<!-- FOOTER / INPUT -->

<footer class="chat-footer">
    <form id="chatForm" class="w-full">
        <div class="input-shell">
            
            <textarea id="userInput" placeholder="Digite aqui..."></textarea>

            <!-- AUTOCOMPLETE VEKTOR -->
            <div id="vektor-autocomplete-box"></div>

            <!-- Bot√£o de anexo do Termo -->
            <button
                type="button"
                id="attachBtn"
                title="Anexar"
                class="ml-1 px-2 py-2 rounded-md border border-slate-300 text-sm flex items-center justify-center bg-transparent"
            >
                <svg xmlns="http://www.w3.org/2000/svg" 
                    fill="none" viewBox="0 0 24 24" stroke-width="2" 
                    stroke="#0f172a" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" 
                          d="M21 12.79V9a6 6 0 10-12 0v7a4 4 0 008 0v-6a2 2 0 00-4 0v5"/>
                </svg>
            </button>

            <!-- Bot√£o Enviar -->
            <button type="submit" id="sendBtn">Enviar</button>

            <!-- Input de arquivo escondido (Termo) -->
            <input
                type="file"
                id="fileTermo"
                accept=".pdf,.jpg,.jpeg,.png,.heic,.HEIC"
                class="hidden"
            />
        </div>
    </form>
</footer>

</div> <!-- fecha .chat-wrapper -->
</div>   <!-- fecha coluna direita -->
</div>     <!-- fecha layout com menu + chat -->

<?!= include('politica_dados'); ?>

<script>

    // Estado global para o upload do Termo de Responsabilidade
  window.vektorTermoPending = null;         // guarda o arquivo em mem√≥ria at√© receber o nome
  window.vektorTermoAguardandoNome = false; // indica se o pr√≥ximo texto √© o nome completo


  // Fecha o modal do v√≠deo de apresenta√ß√£o
function closeVektorModal() {
  var modal = document.getElementById("vektorModal");
  if (modal) {
    modal.style.display = "none";
  }
}

let __vektorJaSugeriuLooker = false;
let __vektorJaSugeriuPoliticaRestricoes = false;
let __vektorJaSugeriuPoliticaUso = false;
let __vektorJaSugeriuJustificativas = false;


// Registro do plugin de r√≥tulos do Chart.js (se estiver carregado)
if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
  Chart.register(ChartDataLabels);
}

// ===== DADOS DO USU√ÅRIO (globais, vindos do Apps Script) =====

// Nome vindo do template Apps Script (Code.gs ‚Üí tmpl.userName)
const USER_NAME_RAW = <?= JSON.stringify(userName || "") ?>;
const displayName = (USER_NAME_RAW || "")
  .replace(/^"+|"+$/g, "")
  .trim();
const USER_ROLE_RAW  = <?= JSON.stringify(userRole  || "") ?>;

// E-mail vindo do Apps Script (Code.gs ‚Üí template.userEmail)
const USER_EMAIL_RAW = <?= JSON.stringify(userEmail || "") ?>;
const USER_EMAIL_REPLACED = (USER_EMAIL_RAW || "")
  .replace(/^"+|"+$/g, "")
  .trim();
const USER_ROLE_CLEAN     = (USER_ROLE_RAW  || "").replace(/^"+|"+$/g, "").trim();

// ================== M√âTRICAS VEKTOR ‚Üí GOOGLE SHEETS ==================

function vektorRegistrarMetrica(
  intencao,
  msgOriginal,
  norm,
  resultado,
  topicoExtra,
  funcaoOrigem
) {
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    console.warn("google.script.run n√£o dispon√≠vel");
    return;
  }

  const payload = {
    intencao: intencao || "",
    topico: topicoExtra || "",
    mensagemOriginal: msgOriginal || "",
    norm: norm || "",
    resultado: resultado || "",
    usuarioNome: displayName || "",
    usuarioEmail: USER_EMAIL_REPLACED || "",
    loja: (window.VEKTOR_LOJA || ""),
    funcaoOrigem: funcaoOrigem || "desconhecida"
  };

  google.script.run
    .withFailureHandler(err => console.error("Falha m√©trica:", err))
    .registrarMetricaVektor(payload);
}

document.addEventListener("DOMContentLoaded", () => {

    let grupoNome = "";
    let grupo = "";

    const ROBOT_IMG_URL = "https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png";

    // >>> NOVO: preencher barra de usu√°rio
    const topUserEl = document.getElementById("vektor-user-info");
    const topClockEl = document.getElementById("vektor-clock");

    const nomeParaMostrar = displayName || USER_EMAIL_REPLACED || "Usu√°rio";
    const roleParaMostrar = USER_ROLE_CLEAN || "Acesso padr√£o";

    if (topUserEl) {
      topUserEl.textContent = `Login: ${nomeParaMostrar} (${roleParaMostrar})`;
    }

    function atualizarRelogio() {
      const agora = new Date();
      const data = agora.toLocaleDateString("pt-BR", {
        weekday: "short",
        day:    "2-digit",
        month:  "2-digit",
        year:   "numeric"
      });
      const hora = agora.toLocaleTimeString("pt-BR", {
        hour:   "2-digit",
        minute: "2-digit",
        hour12: false
      });

      if (topClockEl) {
        topClockEl.textContent = `${data} ¬∑ ${hora}`;
      }
    };

    atualizarRelogio();               // primeira atualiza√ß√£o
    setInterval(atualizarRelogio, 1000);  // atualiza todo segundo

    
// üîπ Mensagem inicial: exemplos do que o Vektor faz
renderBotMessage(
  "HTML:" +
  "<p class='text-sm text-slate-700' style='margin-top:8px;'>" +
    "Aqui est√£o alguns exemplos do que eu posso fazer por voc√™:" +
  "</p>" +
  "<ul class='text-sm text-slate-700' style='margin-left:14px;margin-top:4px;line-height:1.45;'>" +
    "<li>‚Ä¢ Consultar <b>pend√™ncias</b> e <b>justificativas</b> das lojas.</li>" +
    "<li>‚Ä¢ Exibir <b>tabelas detalhadas</b> com pend√™ncias ou justificativas completas.</li>" +
    "<li>‚Ä¢ Mostrar <b>valor da fatura atual</b>, do m√™s passado ou das √∫ltimas faturas.</li>" +
    "<li>‚Ä¢ Gerar <b>ranking</b> por loja, por time, por categoria ou por estabelecimento.</li>" +
    "<li>‚Ä¢ Explicar regras da <b>Pol√≠tica de Uso dos Cart√µes Clara</b>.</li>" +
    "<li>‚Ä¢ Ajudar com informa√ß√µes de <b>desbloqueio</b>, <b>perda</b>, <b>regras de compra</b>, NF/Recibo e uso correto do cart√£o.</li>" +
    "<li>‚Ä¢ Enviar <b>pend√™ncias por e-mail</b>, e muito mais!</li>" +
  "</ul>"
);

setTimeout(function () {
  try {
    vektorPerguntarInformacoesIniciais();
  } catch (e) {
    console.error("Erro ao disparar pergunta de info iniciais:", e);
  }
}, 2500);

      // Vari√°veis vindas do Apps Script (template do doGet)
      const USER_EMAIL_REPLACED = "<?= userEmail ?>";
      const USER_ROLE_REPLACED  = "<?= userRole ?>";

    /* ========= ESTADOS ========= */
    let estadoPendencias = "nenhum"; // "nenhum" | "aguardando_loja" | "aguardando_confirmacao_email" | "aguardando_email"
    let lojaPendenciasAtual = "";
    let ultimaPendenciaResumo = null; // { loja, data }
    let fluxoNovoCartao = null; // null | "aguardando_tipo_via"
    let ultimaIntencao = null;
    let origemPendenciasBloqueio = false;
    let pendenciasTimeoutId = null; // üÜï timeout pra mensagem de outro assunto



    /* ========= ELEMENTOS UI ========= */
    const chatWindow = document.getElementById("chatWindow");
    const chatForm   = document.getElementById("chatForm");
    const userInput  = document.getElementById("userInput");
    const attachBtn = document.getElementById("attachBtn");
    const fileInputTermo = document.getElementById("fileTermo");

        // ===== Upload do Termo de Responsabilidade =====
    if (attachBtn && fileInputTermo) {

        // Garante que o input aceite apenas os formatos liberados
        fileInputTermo.accept = ".pdf,.jpg,.jpeg,.png,.heic,.HEIC";

        // Ao clicar no bot√£o üìé, abre o seletor de arquivos
        attachBtn.addEventListener("click", () => {
            fileInputTermo.click();
        });

        // Quando o usu√°rio escolhe o arquivo
        fileInputTermo.addEventListener("change", function () {
            const file = this.files && this.files[0];
            if (!file) return;

            // Valida tipo permitido
            const mime = file.type || "";

            // Aceita qualquer varia√ß√£o de JPEG e PNG, al√©m de PDF e HEIC
            const isPdf  = mime === "application/pdf";
            const isPng  = mime === "image/png";
            const isHeic = mime.includes("heic") || mime.includes("heif");

            // Alguns navegadores enviam JPEG como image/jpg, image/pjpeg, image/jfif, etc.
            const isJpeg = mime.includes("jpeg") || mime.includes("jpg") || mime.includes("pjpeg") || mime.includes("jfif");

            // Verifica√ß√£o final
            if (!(isPdf || isPng || isHeic || isJpeg)) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-red-700'>S√≥ √© permitido enviar o <b>Termo de Responsabilidade</b> nos formatos PDF, JPG, JPEG, PNG ou HEIC.</p>"
                );
                this.value = "";
                return;
            }

            const reader = new FileReader();
    reader.onload = function (e) {
        const dataUrl = e.target.result || "";
        const base64  = dataUrl.split(",")[1];

        // Guarda temporariamente o arquivo do termo
        window.vektorTermoPending = {
            base64:           base64,
            mimeType:         mime,
            fileNameOriginal: file.name,
            usuarioEmail:     USER_EMAIL_REPLACED || ""
        };
        window.vektorTermoAguardandoNome = true;

        // 1) Pr√©-visualiza√ß√£o (quando for imagem)
        if (mime.startsWith("image/")) {
            renderBotMessage(
                "HTML:" +
                "<div class='text-sm text-slate-700'>" +
                  "<p>Pr√©-visualiza√ß√£o do Termo anexado:</p>" +
                  "<img src='" + dataUrl + "' " +
                        "alt='Pr√©-visualiza√ß√£o do Termo' " +
                        "class='mt-2 max-h-64 rounded border border-slate-200' />" +
                "</div>"
            );
        } else {
            // PDF ou outro formato suportado sem preview direto
            renderBotMessage(
                "HTML:" +
                "<div class='text-sm text-slate-700'>" +
                  "<p>Arquivo PDF do Termo foi anexado (pr√©-visualiza√ß√£o n√£o dispon√≠vel aqui no chat).</p>" +
                "</div>"
            );
        }

        // 2) Mensagem pedindo o nome completo (em outra bolha)
        setTimeout(function () {
            renderBotMessage(
                "HTML:" +
                "<p class='text-sm text-slate-700'>" +
                "Para concluir o registro, por favor informe seu <b>nome completo</b>." +
                "</p>"
            );
        }, 150);
    };

    reader.readAsDataURL(file);

            // limpa o input para permitir novo upload depois
            this.value = "";
        });
    }

    // =========================
// AUTOCOMPLETE VEKTOR
// =========================

// 1) Lista de inten√ß√µes (VOC√ä J√Å TEM ‚Äî basta mover pra c√°)
const VEKTOR_INTENTS = [
  "Consultar pend√™ncias de uma loja",
  "Gerente est√° de f√©rias",
  "Gerente foi demitido",
  "Gerente foi desligado",
  "Gerente mudou de loja",
  "Troca de gerente entre lojas",
  "Servicenow",
  "Como abrir chamado no servicenow?",
  "Lojas com mais pend√™ncias",
  "Pend√™ncias do time",
  "Pend√™ncias da loja",
  "Time com mais pend√™ncias",
  "Ver justificativas completas de uma loja",
  "V√≠deo de justificativas",
  "Como justificar uma transa√ß√£o",
  "Ver justificativas completas de um time",
  "Loja com maior valor de transa√ß√µes neste m√™s",
  "Loja com mais transa√ß√µes neste m√™s",
  "Treinamento Clara",
  "Termo de responsabilidade Clara",
  "Maiores transa√ß√µes do time",
  "Maiores transa√ß√µes da loja",
  "Maiores transa√ß√µes",
  "Valor da fatura atual",
  "Valor da fatura do m√™s passado",
  "Valor das √∫ltimas 3 faturas",
  "Valor das √∫ltimas 6 faturas",
  "Valor de todas as faturas",
  "Ver extrato da conta da Clara",
  "Qual √© o ciclo da fatura da Clara?",
  "Qual etiqueta usar para compra de",
  "Listagem de etiquetas cadastradas na Clara",
  "Ranking de lojas com mais transa√ß√µes",
  "Ranking de lojas com maior valor",
  "Ranking de times com mais transa√ß√µes",
  "Ranking de times com maior valor",
  "Top 3 lojas de um time",
  "Top 5 lojas do per√≠odo",
  "Lojas que mais gastaram no per√≠odo",
  "Lojas que mais fizeram compras",
  "Resumo de uma loja neste m√™s",
  "Resumo de uma loja na √∫ltima semana",
  "Transa√ß√µes de uma loja no per√≠odo",
  "Quais lojas fazem parte de um time?",
  "Resumo de um time neste m√™s",
  "Resumo de um time no per√≠odo",
  "Time com maior valor de transa√ß√µes",
  "Time com maior n√∫mero de transa√ß√µes",
  "Categorias com maior valor de transa√ß√µes",
  "Estabelecimentos mais usados",
  "O que posso comprar com o cart√£o Clara?",
  "Tipos de compra permitidos",
  "Tipos de compra proibidos",
  "Regras da Pol√≠tica de Uso dos Cart√µes Clara",
  "Quando o cart√£o √© bloqueado?",
  "Perdi meu cart√£o Clara, o que fazer?",
  "Cart√£o Clara bloqueado, como resolver?",
  "Como desbloquear o cart√£o Clara?",
  "Meu cart√£o n√£o passou, o que pode ser?",
  "Abrir relat√≥rio gerencial da Clara",
  "Como aumento o limite do cart√£o?",
  "Como usar bem o limite do cart√£o Clara?",
  "Quero gr√°ficos das transa√ß√µes",
  "O que o Vektor pode fazer?",
  "Como anexar nota fiscal na Clara?",
  "Como justificar compras na Clara?"
];

// 2) Normaliza√ß√£o
function vektorNormAutocomplete(str) {
  if (!str) return "";
  return str
    .toString()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// 3) Campos HTML
const vektorInput = document.getElementById("userInput");
const vektorBox   = document.getElementById("vektor-autocomplete-box");

// Estado atual do autocomplete
let vektorCurrentSuggestions = [];
let vektorSelectedIndex = -1;

// Atualiza visualmente qual item est√° selecionado
function vektorHighlightSelected() {
  const items = vektorBox.querySelectorAll(".vektor-autocomplete-item");
  items.forEach((el, idx) => {
    if (idx === vektorSelectedIndex) {
      el.classList.add("is-active");
      // Garante que o item vis√≠vel seja mostrado
      el.scrollIntoView({ block: "nearest" });
    } else {
      el.classList.remove("is-active");
    }
  });
}

function vektorApplySuggestion(textoSugestao) {
  const sugestao = textoSugestao || "";
  const atual = vektorInput.value || "";

  // Normaliza a sugest√£o pra comparar com a lista de times
  const normSug = vektorNormAutocomplete(sugestao);

  // √â um TIME se a sugest√£o bater exatamente com algum VEKTOR_TIMES normalizado
  const isTime = VEKTOR_TIMES.some(
    (t) => vektorNormAutocomplete(t) === normSug
  );

  // √â uma LOJA se vier no formato "0001 - NOME" (√© assim que voc√™ monta l√° embaixo)
  const isLoja = /^\d{3,4}\s*-/.test(sugestao);

  // Para time/loja: N√ÉO apagar tudo, s√≥ trocar a √∫ltima palavra digitada
  if (isTime || isLoja) {
    // remove espa√ßos do fim
    const base = atual.replace(/\s+$/g, "");
    const m = base.match(/^(.*\s)(\S+)$/); // tudo antes + √∫ltima palavra

    if (m) {
      const antes = m[1];   // frase antes da √∫ltima palavra
      vektorInput.value = antes + sugestao; // substitui s√≥ a √∫ltima palavra
    } else {
      // se s√≥ tinha uma palavra no campo, a√≠ n√£o tem muito o que fazer
      vektorInput.value = sugestao;
    }
  } else {
    // Sugest√µes gen√©ricas (intents): mant√©m comportamento antigo
    vektorInput.value = sugestao;
  }

  vektorInput.focus();
}

// 4) Carregar lista de LOJAS vinda do back-end
window.__VEKTOR_LOJAS = [];
google.script.run.withSuccessHandler(function(lista){
    if (Array.isArray(lista)) window.__VEKTOR_LOJAS = lista;
}).getListaLojas();

// 5) Lista de times reais (voc√™ ajusta aqui)
const VEKTOR_TIMES = [
  "√Åguias de Elite",
  "√Åguias do Cerrado",
  "Guardi√µes da Fronteira",
  "Esquadr√£o 40 graus",
  "Esquadr√£o Valente",
  "Falc√µes SP",
  "Flechas do Norte",
  "Furac√£o Sul I",
  "Ultra High",
  "F√∫ria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Canga√ßo",
  "Legi√£o de Elite",
  "Sulcesso"
];

// 6) Renderizar sugest√µes

function vektorRenderSugestoes(lista) {
  if (!lista.length) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  vektorCurrentSuggestions = lista.slice(0, 8);
  vektorSelectedIndex = -1;

  vektorBox.innerHTML = vektorCurrentSuggestions
    .map((s, idx) => 
      `<div class="vektor-autocomplete-item" data-index="${idx}">${s}</div>`
    )
    .join("");

  vektorBox.style.display = "block";
}

// 7) L√≥gica do autocomplete
vektorInput.addEventListener("input", function () {
  const raw = vektorInput.value || "";

  // Se o campo est√° vazio, limpa e sai
  if (!raw.trim()) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  // texto inteiro normalizado (para intents)
  const norm = vektorNormAutocomplete(raw);

  // Usa o texto SEM os espa√ßos finais para pegar a √∫ltima palavra completa
  const base = raw.replace(/\s+$/g, ""); // remove espa√ßos do fim
  const lastMatch = base.match(/(\S+)$/);
  const lastRaw   = lastMatch ? lastMatch[1] : "";
  const lastNorm  = vektorNormAutocomplete(lastRaw);

  // se a √∫ltima palavra completa tem menos de 2 caracteres, n√£o sugere nada
  if (!lastNorm || lastNorm.length < 2) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  let suggestions = [];

  // a) frases do VEKTOR_INTENTS -> usa a frase inteira normalizada
  if (norm.length >= 2) {
    suggestions.push(
      ...VEKTOR_INTENTS.filter(x => vektorNormAutocomplete(x).includes(norm))
    );
  }

  // b) autocomplete de LOJAS -> usa s√≥ os d√≠gitos da √∫ltima palavra
  if (window.__VEKTOR_LOJAS && window.__VEKTOR_LOJAS.length) {
    const digits = (lastRaw || "").replace(/\D/g, "");
    if (digits && digits.length <= 4) {
      const padded = ("0000" + digits).slice(-4);

      window.__VEKTOR_LOJAS.forEach((l) => {
        const cod = String(l.codigo || "").padStart(4, "0");

        if (cod.startsWith(padded)) {
          const nomeFinal = l.nome || l.nomeLojaTxt || "";
          let label = cod;

          if (nomeFinal) {
            label += " - " + nomeFinal;
          }

          suggestions.push(label);
        }
      });
    }
  }

  // c) autocomplete de TIMES -> compara contra a √∫ltima palavra completa
  if (lastNorm.length >= 2) {
    suggestions.push(
      ...VEKTOR_TIMES.filter(t => vektorNormAutocomplete(t).includes(lastNorm))
    );
  }

  // remover duplicados
  suggestions = [...new Set(suggestions)];

  vektorRenderSugestoes(suggestions);
});

// clique do mouse
vektorBox.addEventListener("mousedown", (e)=>{
  const item = e.target.closest(".vektor-autocomplete-item");
  if (!item) return;

  const idx = item.dataset.index ? parseInt(item.dataset.index, 10) : -1;
  const textoSugestao =
    (idx >= 0 && vektorCurrentSuggestions[idx])
      ? vektorCurrentSuggestions[idx]
      : item.innerText;

  vektorApplySuggestion(textoSugestao);

  vektorBox.style.display = "none";
  vektorSelectedIndex = -1;
  vektorCurrentSuggestions = [];
});

    const sendBtn    = document.getElementById("sendBtn");

    /* ========= FUN√á√ïES DE UI ========= */
    function scrollToBottom() {
        requestAnimationFrame(() => {
            const body = document.querySelector(".chat-body");
            if (body) {
                body.scrollTop = body.scrollHeight;
                setTimeout(() => {
                    body.scrollTop = body.scrollHeight;
                }, 150);
            }
        });
    }

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start justify-end gap-3";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

        // Converte texto tipo "R$ 340.800,00" ou "59,1 mil" em n√∫mero
    function vektorParseNumero(texto) {
      if (!texto) return NaN;

      let t = String(texto).toLowerCase();

      // trata "mil" (ex.: "340,8 mil")
      let multiplicador = 1;
      if (t.includes(" mil")) {
        multiplicador = 1000;
      }
      t = t.replace(/mil/gi, "");

      // remove tudo que n√£o for n√∫mero, v√≠rgula, ponto ou sinal
      t = t.replace(/[^\d,.\-]/g, "");

      // remove pontos de milhar e troca v√≠rgula por ponto
      t = t.replace(/\./g, "").replace(",", ".");

      const n = parseFloat(t);
      if (isNaN(n)) return NaN;
      return n * multiplicador;
    }


        function iniciarTimeoutPendencias() {
        // limpa qualquer timeout pendente
        if (pendenciasTimeoutId) {
            clearTimeout(pendenciasTimeoutId);
            pendenciasTimeoutId = null;
        }

    const mensagensOutroAssunto = [
  "Quer falar sobre outro assunto? Se sim, pode mandar bala!",
  "Quer aproveitar e falar de outro tema?",
  "Quer conversar sobre outra coisa?",
  "Planeta Terra chamando! Tem algu√©m ai? üôÑ",
  "Me diz se quer mudar de assunto? üòâ",  
  "Tem outro assunto que quer tratar?",
  "Posso te ajudar com mais alguma coisa?",
  "Quer mudar de assunto? Manda ver!",
  "Se quiser falar de outro tema, √© s√≥ digitar üëá",
  "Posso te ajudar em outro ponto se quiser...",
  "Quer conversar sobre outra coisa agora?"
];

// üïí dispara o lembrete depois de 10s sem resposta
pendenciasTimeoutId = setTimeout(() => {
  // escolhe uma frase aleat√≥ria do array
  const fraseAleatoria = mensagensOutroAssunto[
    Math.floor(Math.random() * mensagensOutroAssunto.length)
  ];

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">${fraseAleatoria}</p>`
  );
}, 10000);

    }


        // üëá Cole AQUI, logo abaixo de scrollToBottom()

      // Adiciona indicador de "digitando..."
      function showTypingIndicator() {
        const chatWindow = document.getElementById('chatWindow');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex items-start gap-3 mt-3';
        typingDiv.innerHTML = `
          <div class="bot-bubble px-4 py-3 max-w-[80%]">
            <div class="typing-indicator flex gap-1">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

  // ---- DEBUG TURBINADO: mostra erros e rejei√ß√µes dentro do chat ----
(function instalarErroNoChat() {
  if (window.__erroNoChatInstalado) return;
  window.__erroNoChatInstalado = true;

  // Fun√ß√£o auxiliar pra mostrar a mensagem no chat
  function mostrarErro(titulo, msg, linha, arquivo) {
    try {
      renderBotMessage(
        "HTML:<div style='font-family:Arial,sans-serif;font-size:12px;color:#B00020;background:#FFECEC;padding:8px;border:1px solid #B00020;border-radius:6px'>" +
          "<b>" + titulo + ":</b> " + msg +
          (linha ? "<br/><small>(" + (arquivo || "inline") + ":" + linha + ")</small>" : "") +
        "</div>"
      );
    } catch (_) {
      console.error("Erro ao mostrar debug no chat:", msg);
    }
  }

  // 1Ô∏è‚É£ Erros comuns de execu√ß√£o
  window.addEventListener("error", function (e) {
    const msg = e.message || String(e);
    mostrarErro("Erro de script", msg, e.lineno, e.filename);
  });

  // 2Ô∏è‚É£ Promises rejeitadas (async/await sem catch)
  window.addEventListener("unhandledrejection", function (e) {
    const msg = e.reason && e.reason.message ? e.reason.message : String(e.reason);
    mostrarErro("Promise rejeitada", msg);
  });

  // 3Ô∏è‚É£ Aviso de que o script carregou e debug est√° ativo
  window.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Debug do chat ativado!");
  });

  // 4Ô∏è‚É£ Falhas no carregamento de scripts externos
  window.addEventListener("error", function (e) {
    if (e.target && e.target.tagName === "SCRIPT") {
      mostrarErro("Falha ao carregar script", e.target.src || "(inline script)");
    }
  }, true);
})();



  function hideTypingIndicator() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) typingDiv.remove();
  }

  function vektorStripHtml(html) {
  if (!html) return "";
  // remove prefixo "HTML:" se existir
  if (typeof html === "string" && html.startsWith("HTML:")) {
    html = html.substring(5);
  }
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  const text = tmp.textContent || tmp.innerText || "";
  return text.replace(/\s+/g, " ").trim();
}

function vektorResumoTexto(texto, maxLen) {
  maxLen = maxLen || 200;
  if (!texto) return "";
  if (texto.length <= maxLen) return texto;
  return texto.substring(0, maxLen) + " ...";
}

function vektorDetectarFuncaoOrigem() {
  let origem = "renderBotMessage";
  try {
    // Em muitos navegadores, em modo n√£o-estrito, caller funciona
    const caller = renderBotMessage.caller;
    if (caller && caller.name) {
      origem = caller.name;
    }
  } catch (e) {
    // Se der erro por restri√ß√£o de caller, mant√©m o fallback
    console.warn("N√£o foi poss√≠vel detectar caller da renderBotMessage:", e);
  }
  return origem;
}

  async function renderBotMessage(text) {
  if (!text) return;

  // üëá Mostra o indicador de "digitando..."
  showTypingIndicator();

  // Aguarda 1 segundo (simulando digita√ß√£o)
  await new Promise(r => setTimeout(r, 800));

  // Remove o indicador
  hideTypingIndicator();

  // --- Parte original do seu c√≥digo ---
  const wrapper = document.createElement("div");
  wrapper.className = "flex items-start gap-3";

  const avatar = document.createElement("img");
  avatar.src = ROBOT_IMG_URL;
  avatar.alt = "Assistente Clara (rob√¥)";
  avatar.className = "h-16 w-auto object-contain flex-shrink-0";

  const bubble = document.createElement("div");
  const baseBubbleClasses =
    "bot-bubble px-4 py-3 text-sm whitespace-pre-line text-slate-700";
  bubble.className = baseBubbleClasses;

  // Conte√∫do: HTML ou texto puro
  if (typeof text === "string" && text.startsWith("HTML:")) {
    bubble.innerHTML = text.replace(/^HTML:/, "").trim();
  } else {
    bubble.innerText = text;
  }

  // Se a resposta cont√©m <iframe> (ex.: relat√≥rio gerencial),
  // a bolha ocupa a largura total do chat; caso contr√°rio, 80%.
  if (bubble.querySelector("iframe")) {
    bubble.className = baseBubbleClasses + " w-full";
  } else {
    bubble.className = baseBubbleClasses + " max-w-[80%]";
  }

  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);
  chatWindow.appendChild(wrapper);

  scrollToBottom();

  // ============================================================
  // üîπ LOG CENTRALIZADO DE SA√çDA DO BOT ‚Üí GOOGLE SHEETS
  // ============================================================
  try {
    const textoLimpo = vektorStripHtml(text);
    const resumo = vektorResumoTexto(textoLimpo, 250);

    let intencaoSaida = "bot_generico";
    if (typeof ultimaIntencao !== "undefined" && ultimaIntencao) {
      intencaoSaida = ultimaIntencao;
    }

    // üîπ AGORA A ORIGEM √â DETECTADA AUTOMATICAMENTE
    const origemSaida = vektorDetectarFuncaoOrigem();

    vektorRegistrarMetrica(
      intencaoSaida,         // intencao
      "[BOT] " + resumo,     // mensagemOriginal
      "",                    // norm
      "bot_msg",             // resultado
      "SaidaBot",            // topico
      origemSaida            // funcaoOrigem (ex.: vektorBlocoRaciocinioPolitica)
    );

    if (typeof ultimaIntencao !== "undefined") {
      ultimaIntencao = null;
    }
    // n√£o precisa mais de ultimaFuncaoOrigem, ent√£o nada pra resetar aqui

  } catch (e) {
    console.error("Erro ao registrar m√©trica de sa√≠da do bot:", e);
  }
}

          // ========= EXPORTA√á√ÉO DE TABELA PARA CSV =========

  // Usado pelo bot√£o "‚¨á Exportar CSV" dentro das respostas com tabela.
  // IMPORTANT: precisa estar dentro do document.addEventListener("DOMContentLoaded", ...)
  // e exposto em window para o onclick funcionar.
  window.exportTableToCSV = function(btn, defaultFileName) {
    try {
      // 1. Encontrar o container da mensagem do bot onde o bot√£o est√°
      var container = btn.closest(".bot-bubble");
      if (!container) {
        container = btn.closest("div");
      }

      if (!container) {
        alert("N√£o consegui localizar a tabela para exportar.");
        return;
      }

      // 2. Achar a tabela dentro dessa resposta
      var table = container.querySelector("table");
      if (!table) {
        alert("N√£o encontrei nenhuma tabela nessa resposta para exportar.");
        return;
      }

      // 3. Montar o CSV linha a linha
      var linhas = table.querySelectorAll("tr");
      var csvLinhas = [];

      for (var i = 0; i < linhas.length; i++) {
        var cols = linhas[i].querySelectorAll("th,td");
        var linhaCampos = [];
        for (var j = 0; j < cols.length; j++) {
          var texto = (cols[j].innerText || "").replace(/\s+/g, " ").trim();

          // Escapa aspas duplas
          texto = texto.replace(/"/g, '""');

          // Se tiver ;, quebra de linha ou aspas, envolve em aspas
          if (/[;"\n]/.test(texto)) {
            texto = '"' + texto + '"';
          }

          linhaCampos.push(texto);
        }

        // Usando ; como separador (mais comum no Excel PT-BR)
        csvLinhas.push(linhaCampos.join(";"));
      }

      var csv = csvLinhas.join("\n");

      // 4. Criar o arquivo e disparar o download
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var agora = new Date();
      var stamp = agora.toISOString().slice(0,19).replace(/[:T\-]/g,"");

      a.href = url;
      a.download = (defaultFileName || "exportacao") + "_" + stamp + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Erro ao exportar CSV:", e);
      alert("N√£o consegui gerar o CSV desta tabela.");
    }
  };


// ========= DRILL-DOWN: EXPANDIR LINHA DA TABELA (com dropdown + mesmo per√≠odo) ========= //

window.vektorExpandirLinha = function (tr, base) {
  try {
    if (!tr || !tr.cells || !tr.cells.length) return;

    // Nome da linha (Time / Loja / Categoria / Estabelecimento)
    const chave = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    if (!chave) return;

    // Encontra o <select> relacionado ao drilldown
    const container = tr.closest("div");
    const select = container
      ? container.querySelector(".vektor-drill-select[data-base='" + base + "']")
      : null;

    const alvo = select ? select.value : null; // loja / categoria / estabelecimento / time

    // Per√≠odo da pergunta original (cache)
    const periodo = window.__vektorUltimoPeriodo || null;
    const dataInicioStr =
      periodo && periodo.dataInicio ? periodo.dataInicio.toISOString() : "";
    const dataFimStr =
      periodo && periodo.dataFim ? periodo.dataFim.toISOString() : "";

    let periodoTxt = "";
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      const di = periodo.dataInicio;
      const df = periodo.dataFim;
      periodoTxt =
        di.toLocaleDateString("pt-BR") + " a " + df.toLocaleDateString("pt-BR");
    }

    const tipo = "valor"; // padr√£o do drilldown

    // ================== BASE = TIME ==================
    if (base === "time") {
      // ‚ñº TIME ‚Üí LOJAS (padr√£o)
      if (alvo === "loja" || !alvo) {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>lojas</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            // topN null + forGroup=true => todas as lojas do time
            renderResumoTransacoesSemana(res, { topN: null, forGroup: true });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar por lojas.</p>"
            );
          })
          .getResumoTransacoesPorGrupo(chave, dataInicioStr, dataFimStr, tipo);
      }

      // ‚ñº TIME ‚Üí CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> do time <b>" + chave + "</b> " +
            (periodoTxt ? "no per√≠odo <b>" + periodoTxt + "</b>" : "") +
            "‚Ä¶</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias do time.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaTime(
            dataInicioStr,
            dataFimStr,
            tipo,   // "valor" ou "quantidade"
            chave   // nome do time
          );
      }

      // ‚ñº TIME ‚Üí ESTABELECIMENTOS
      else if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>estabelecimentos</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            chave, // grupo = time
            ""     // loja vazia
          );
      }

      return;
    }

    // ================== BASE = LOJA ==================
    if (base === "loja") {
      // ‚ñº LOJA ‚Üí ESTABELECIMENTOS
      if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando a loja <b>${chave}</b> por <b>estabelecimentos</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            "",
            chave // loja
          );
      }

      // ‚ñº LOJA ‚Üí CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> da loja <b>" + chave + "</b> " +
            (periodoTxt ? "no per√≠odo <b>" + periodoTxt + "</b>" : "") +
            "‚Ä¶</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias da loja.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaLoja(
            dataInicioStr,
            dataFimStr,
            tipo,     // "valor" ou "quantidade"
            chave     // c√≥digo/nome da loja
          );
      }

      return;
    }
  } catch (e) {
    console.error("Erro no vektorExpandirLinha:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Tive um problema ao tentar detalhar essa linha.</p>"
    );
  }
};

window.vektorDrillTransacoesCategoria = function (nomeCategoria) {
  try {
    if (!nomeCategoria) return;

    // Usa o √∫ltimo per√≠odo entendido pelo Vektor
    var periodo = window.__vektorUltimoPeriodo || null;
    var dataInicioStr = "";
    var dataFimStr    = "";

    if (periodo && periodo.dataInicio && periodo.dataFim) {
      dataInicioStr = periodo.dataInicio.toISOString();
      dataFimStr    = periodo.dataFim.toISOString();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a categoria <b>" + nomeCategoria + "</b> " +
        "pelas transa√ß√µes individuais no mesmo per√≠odo da consulta‚Ä¶</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          var html = vektorRenderTransacoesPorCategoria(res, nomeCategoria);
          if (html) {
            renderBotMessage("HTML:" + html);
          } else {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>" +
                "N√£o encontrei transa√ß√µes para essa categoria neste per√≠odo." +
              "</p>"
            );
          }
        } catch (e) {
          console.error("Erro ao renderizar transa√ß√µes por categoria:", e);
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "Falha ao detalhar as transa√ß√µes dessa categoria." +
            "</p>"
          );
        }
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script getTransacoesPorCategoria:", err);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "N√£o consegui consultar as transa√ß√µes dessa categoria agora." +
          "</p>"
        );
      })
      .getTransacoesPorCategoria(
        dataInicioStr,
        dataFimStr,
        nomeCategoria
      );

  } catch (e) {
    console.error("Erro geral em vektorDrillTransacoesCategoria:", e);
  }
};

window.vektorDrillTransacoesEstabelecimento = function (nomeEstab) {
  try {
    // Pega per√≠odo do cache global (mesma l√≥gica que voc√™ j√° usa em categorias)
    let dataInicioIso = "";
    let dataFimIso = "";

    if (window.__vektorUltimoPeriodo && window.__vektorUltimoPeriodo.dataInicio && window.__vektorUltimoPeriodo.dataFim) {
      dataInicioIso = window.__vektorUltimoPeriodo.dataInicio.toISOString();
      dataFimIso    = window.__vektorUltimoPeriodo.dataFim.toISOString();
    } else if (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio && window.__vektorUltimoPeriodoIso.fim) {
      dataInicioIso = window.__vektorUltimoPeriodoIso.inicio;
      dataFimIso    = window.__vektorUltimoPeriodoIso.fim;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Buscando transa√ß√µes do estabelecimento <b>" +
        nomeEstab +
      "</b> por loja no mesmo per√≠odo...</p>"
    );

    google.script.run
      .withSuccessHandler(function(res) {
        renderTransacoesEstabelecimentoPorLoja(res);
      })
      .withFailureHandler(function(err) {
        console.error("Erro ao buscar transa√ß√µes por estabelecimento:", err);
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o consegui carregar as transa√ß√µes desse estabelecimento agora.</p>");
      })
      .getTransacoesIndividuaisPorEstabelecimento(dataInicioIso, dataFimIso, nomeEstab);

  } catch (e) {
    console.error("Falha em vektorDrillTransacoesEstabelecimento:", e);
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao tentar expandir o estabelecimento.</p>");
  }
}

function renderTransacoesEstabelecimentoPorLoja(res) {
  if (!res || !res.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes para esse estabelecimento no per√≠odo.</p>"
    );
    return;
  }

  const linhas = res.linhas || [];
  if (!linhas.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes para esse estabelecimento no per√≠odo.</p>"
    );
    return;
  }

  // per√≠odo
  let periodoHtml = "";
  try {
    const di = res.dataInicioIso ? new Date(res.dataInicioIso) : null;
    const df = res.dataFimIso ? new Date(res.dataFimIso) : null;
    if (di && df && !isNaN(di.getTime()) && !isNaN(df.getTime())) {
      periodoHtml =
        "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
          "Per√≠odo da consulta: de " + di.toLocaleDateString("pt-BR") +
          " a " + df.toLocaleDateString("pt-BR") + "." +
        "</p>";
    }
  } catch (e) {}

  // monta tabela
  let html = [];
  html.push("<div class='text-sm text-slate-700'>");
  html.push("<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>Transa√ß√µes por loja ‚Äì " + (res.estabelecimento || "") + "</p>");
  html.push(periodoHtml);

  html.push("<div style='overflow-x:auto;'>");
  html.push("<table style='border-collapse:collapse;width:100%;font-size:12px;text-align:center;border:1px solid #000;'>");

  // ‚úÖ Valor (R$) movido para a √öLTIMA coluna
  html.push(
    "<thead><tr style='background:#06167d;color:#fff;'>" +
      "<th style='border:1px solid #000;padding:4px;'>Loja</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Estabelecimento</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Data</th>" +

      "<th style='border:1px solid #000;padding:4px;'>Titular</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Grupos</th>" +

      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Recibo</th>" +
      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Etiquetas</th>" +
      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Descri√ß√£o</th>" +

      "<th style='border:1px solid #000;padding:4px;'>Valor (R$)</th>" +
    "</tr></thead><tbody>"
  );

  let soma = 0;
  for (let i = 0; i < linhas.length; i++) {
    const l = linhas[i] || {};
    const valor = Number(l.valor || 0);
    soma += valor;

    // ‚úÖ Valor movido para o √öLTIMO <td>
    html.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.loja || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.estabelecimento || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.data || "") + "</td>" +

        "<td style='border:1px solid #000;padding:4px;'>" + (l.titular || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.grupos || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.recibo || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.etiquetas || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.descricao || "") + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
          valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
      "</tr>"
    );
  }

  // total (colspan continua correto: 8)
  html.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;padding:4px;' colspan='8'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
        soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  html.push("</tbody></table></div>");

  // bot√£o CSV abaixo (igual padr√£o)
  html.push(
    "<div style='margin-top:8px;text-align:right;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'transacoes_estabelecimento_por_loja')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "‚¨á Exportar CSV" +
      "</button>" +
    "</div>"
  );

  html.push("</div>");

  renderBotMessage("HTML:" + html.join(""));
}

    /* ========= NORMALIZA√á√ÉO ========= */
    function normalize(str) {
        return (str || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    // ================= VEKTOR ‚Äì bloco de racioc√≠nio da pol√≠tica =================

function vektorBlocoRaciocinioPolitica(explicacao, risco, referencia) {
  explicacao = explicacao || "Essa decis√£o segue as regras da pol√≠tica de uso dos cart√µes Clara.";
  risco = risco || "";

  // Garante refer√™ncia com fallback seguro
  if (typeof POLITICA_CARTOES_CLARA_LINK !== "undefined") {
    referencia = referencia || POLITICA_CARTOES_CLARA_LINK;
  } else {
    referencia = referencia || "#";
  }

  // Monta o ‚Äúcart√£o‚Äù de racioc√≠nio
  var html =
    "<div style='margin-top:6px;padding:8px;border-radius:6px;border:1px dashed #cbd5e1;background:#f8fafc;'>" +
      "<p style='font-size:14px;color:#0f172a;'><b>Segue minha an√°lise para o seu questionamento:</b></p><br>";

  // Aqui a explica√ß√£o j√° pode ser HTML completo (ex.: o bloco da categoria)
  html += explicacao;

  if (risco) {
    html +=
      "<p style='font-size:12px;color:#b91c1c;margin-top:4px;'><b>Risco:</b> " + risco + "</p>";
  }

  html +=
      "<p style='font-size:11px;color:#64748b;margin-top:6px;'>" +
        "Para detalhes completos, consulte a Pol√≠tica de Uso dos Cart√µes Clara: " +
        "<a href='" + referencia + "' target='_blank' style='color:#005E27;font-weight:600;'>abrir pol√≠tica</a>." +
      "</p>" +
    "</div>";

  // ‚ö†Ô∏è IMPORTANTE: prefixo "HTML:" para o renderBotMessage usar innerHTML
  return "HTML:" + html;
}

    // =============== MOTOR DE POL√çTICA POR CATEGORIA (SEM MCC AINDA) ===============

    // Encontra uma categoria de pol√≠tica a partir do nome
    function classificarCategoriaPolitica(nomeCategoria) {
      if (!nomeCategoria) return null;

      const normCat = normalize(nomeCategoria);
      if (!Array.isArray(POLITICA_CATEGORIA)) return null;

      // Busca por match exato no nome normalizado
      for (const regra of POLITICA_CATEGORIA) {
        if (!regra || !regra.categoria) continue;
        const normRegra = normalize(regra.categoria);
        if (normRegra === normCat) {
          return regra;
        }
      }

      return null;
    }

    // Avalia se uma categoria √© permitida / condicional / proibida
    function avaliarCategoriaPolitica(categoriaPolitica) {
      const regra = classificarCategoriaPolitica(categoriaPolitica);

      if (!regra) {
        return {
          decisao: "indefinido",
          idRegra: null,
          motivoTecnico: "Nenhuma regra espec√≠fica encontrada para essa categoria na matriz POLITICA_CATEGORIA.",
          mensagemUsuario:
            "Essa categoria n√£o est√° mapeada automaticamente no Vektor. Consulte a pol√≠tica oficial ou abra chamado no financeiro para an√°lise."
        };
      }

      if (regra.status === "permitido") {
        return {
          decisao: "permitido",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como liberada na pol√≠tica (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria de compra √© permitida pela pol√≠tica de uso dos cart√µes Clara, desde que o gasto seja necess√°rio para a opera√ß√£o da loja."
        };
      }

      if (regra.status === "condicional") {
        return {
          decisao: "condicional",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como sujeita √† an√°lise/libera√ß√£o pr√©via do financeiro (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria exige an√°lise e libera√ß√£o pr√©via do financeiro. Abra chamado no ServiceNow explicando a necessidade antes de concluir a compra."
        };
      }

      if (regra.status === "proibido") {
        return {
          decisao: "proibido",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como proibida na pol√≠tica (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria √© proibida pela pol√≠tica de uso dos cart√µes Clara. N√£o use o cart√£o Clara para esse tipo de despesa."
        };
      }

      // fallback defensivo
      return {
        decisao: "indefinido",
        idRegra: regra.idRegra,
        motivoTecnico: "Status de regra n√£o reconhecido: " + regra.status,
        mensagemUsuario:
          "N√£o consegui classificar essa categoria automaticamente. Consulte o financeiro ou a pol√≠tica oficial."
      };
    }

    // ===== TIMES OFICIAIS (para identificar "time X" / "grupo X") =====
const TIMES_OFICIAIS = [
  "√Åguias de Elite",
  "√Åguias do Cerrado",
  "Guardi√µes da Fronteira",
  "Esquadr√£o 40 Graus",
  "Esquadr√£o Valente",
  "Falc√µes SP",
  "Flechas do Norte",
  "Furac√£o Sul I",
  "Ultra High",
  "F√∫ria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Canga√ßo",
  "Legi√£o de Elite",
  "SULcesso"
];

// Usa a mesma normalize() do chat pra comparar mensagem x times
function encontrarTimeNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal);

  let melhorNome = null;
  let melhorScore = 0;

  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // separa em palavras e tira preposi√ß√µes/coisas fracas
    const tokens = nomeNorm
      .split(" ")
      .filter(t => !["do","da","de","dos","das","sp","sul"].includes(t));

    let score = 0;

    // se o nome completo aparecer, j√° d√° um boost forte
    if (texto.includes(nomeNorm)) {
      score += 100;
    }

    // +10 pra cada palavra relevante encontrada
    tokens.forEach(tok => {
      if (texto.includes(tok)) score += 10;
    });

    if (score > melhorScore) {
      melhorScore = score;
      melhorNome = nome;
    }
  });

  // se nada bateu, volta null
  return melhorNome;
}

function encontrarListaTimesNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");
  const encontrados = [];

  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // usa as mesmas regras do encontrarTimeNaMensagem,
    // mas aqui a ideia √© pegar TODOS os que apare√ßam
    const tokens = nomeNorm
      .split(" ")
      .filter(t => !["do","da","de","dos","das","sp","sul"].includes(t));

    let score = 0;
    tokens.forEach((tk) => {
      if (!tk) return;
      if (texto.includes(tk)) score += 1;
    });

    if (score > 0) {
      encontrados.push(nome);
    }
  });

  return encontrados;
}


    /* ========= DADOS / TABELAS ========= */

    const etiquetasOficiais = [
  {
    nome: "MARKETING_PUBLICIDADE E PROPAGANDA",
    palavrasChave: [
      "marketing", "publicidade", "propaganda", "anuncio", "an√∫ncio", "facebook", "instagram", "insta", "face",
      "m√≠dia", "midia", "brinde", "campanha", "banner promocional", "campanhas", "banner", "baner",
      "impulsionamento", "divulga√ß√£o", "panfleto", "adesivo promocional", "social media", "instagram ads", "facebook ads", "promo√ß√£o local", "google ads", "tiktok ads", "youtube ads", "seo", "sem", "email marketing", "e-mail marketing", "inbound marketing", "outbound marketing", "influencer", "influenciadores", "parceria paga", "patrocinado", "stories", "feed", "design gr√°fico", "agencia de publicidade", "ag√™ncia de publicidade", "criacao de conteudo", "cria√ß√£o de conte√∫do", "material promocional", "folder", "cartaz", "outdoor", "tv paga", "revista", "jornal", "marketing digital", "alcance", "engajamento", "convers√£o", "leads", "pixel", "remarketing", "assessoria de imprensa", "rela√ß√µes p√∫blicas", "relacoes publicas", "assessoria"
    ],
    descricao:
      "A√ß√µes promocionais, compra de brindes, banners, impulsionamento de redes sociais, contrata√ß√£o de m√≠dia local.",
    observacaoUso: "Somente campanhas aprovadas pelo regional ou diretoria."
  },
  {
    nome: "TAXAS E EMOLUMENTOS",
    palavrasChave: [
      "taxa", "taxas", "emolumento", "emolumentos", "cartorio", "cart√≥rio",
      "certidao", "certid√£o", "registro", "segunda via documento", "aluguel",
      "documenta√ß√£o oficial", "taxa de servi√ßo", "honorarios", "honor√°rios"
    ],
    descricao:
      "Custos com registros, certid√µes, taxas cartoriais ou administrativas necess√°rias √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA",
    palavrasChave: [
      "detergente", "sabao", "sab√£o", "desinfetante", "alcool", "√°lcool", "pano", "rodo", "vassoura", "esponja", "papel toalha", "limpeza loja", "produto de limpeza", "desengordurante", "multiuso", "saco de lixo", "lixeira", "balde", "mop", "lustra moveis", "lustra m√≥veis", "cera", "removedor", "amaciante", "√°gua sanit√°ria", "agua sanitaria", "limpa vidros", "rasteio", "escova", "flanela", "aspirador", "sapon√°ceo", "sabonete", "dispenser", "tapete sanitizante", "sanitizante", "cloro", "alvejante", "luva", "mascara", "m√°scara", "limpeza do banheiro", "papel higi√™nico", "papel higienico", "aromatizador", "odorizador", "refil", "material de higiene", "higiene"
    ],
    descricao:
      "Materiais de limpeza e higiene da loja: detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE INFORM√ÅTICA",
    palavrasChave: [
      "mouse", "teclado", "teclado pdv", "cabo usb", "pendrive", "pen drive", "roteador", "hub usb", "fonte", "adaptador", "cabo rede", "cart√£o memoria", "cartao memoria", "extensor usb", "carregador", "suporte notebook", "monitor", "impressora", "cartucho", "toner", "cabo hdmi", "ssd", "hd", "memoria ram", "mem√≥ria ram", "headset", "scanner", "leitor de c√≥digo", "leitor de codigo", "mousepad", "modem", "placa de video", "placa de rede", "pilhas", "bateria", "no break", "nobreak", "filtro de linha", "perif√©rico", "periferico", "fone de ouvido", "fones", "fone"
    ],
    descricao:
      "Itens de inform√°tica de baixo valor: mouse, teclado, cabos, pendrives, fontes, roteadores, hubs USB, cart√µes de mem√≥ria.",
    observacaoUso: "N√£o cobre monitores, TVs ou equipamentos patrimoniais."
  },
  {
    nome: "MATERIAL DE ESCRIT√ìRIO",
    palavrasChave: [
      "caneta", "papel", "pasta", "bloco", "caderno", "etiqueta adesiva", "grampeador", "clips", "clipes", "organizador", "post-it", "marcador", "l√°pis", "lapis", "borracha", "corretivo", "tesoura", "r√©gua", "regua", "perfurador", "furador de papel", "cola", "fita adesiva", "fita durex", "envelope", "arquivo", "caixa arquivo", "separador de p√°gina", "separador de pagina",
      "carimbo", "tinta carimbo", "calculadora", "agenda", "calend√°rio", "calendario", "prancheta", "suporte de caneta", "porta-treco", "cartucho de tinta", "toner", "porta revista", "revisteiro", "apontador", "dicion√°rio", "dicionario", "impressos", "sulfite", "folha de sulfite", "folha A4", "folhas", "escada", "escadas"
    ],
    descricao:
      "Canetas, blocos, pap√©is, pastas, grampeadores, clipes, etiquetas adesivas, organizadores de mesa etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE COPA E COZINHA",
    palavrasChave: [
      "copo", "copos", "talher", "talheres", "garrafa termica", "garrafa t√©rmica",
      "pano prato", "pano de prato", "filtro de cafe", "filtro de caf√©",
      "pote", "potes", "pote plastico", "pote pl√°stico", "descartavel", 
    ],
    descricao:
      "Copos, talheres, filtros de caf√©, panos de prato, potes pl√°sticos, garrafas t√©rmicas.",
    observacaoUso: "N√£o cobre eletrodom√©sticos como cafeteiras ou micro-ondas."
  },
  {
    nome: "MATERIAL DE COPA E COZINHA OPERA√á√ïES",
    palavrasChave: ["cozinha loja", "utensilios loja", "material copa opera√ß√µes", "kit acrilico"],
    descricao: "Itens de copa/cozinha utilizados especificamente em opera√ß√µes.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA OPERA√á√ïES",
    palavrasChave: ["limpeza opera√ß√µes", "produto limpeza operacional"],
    descricao: "Materiais de limpeza voltados √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS OPERA√á√ïES",
    palavrasChave: ["banner", "adesivo", "flyer", "folder", "grafica", "impressao", "impress√£o", "impress√µes"],
    descricao: "Materiais gr√°ficos operacionais, banners e impress√µes.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO CIVIL",
    palavrasChave: [
      "parede", "porta", "vidro", "prateleira", "fechadura", "reparo loja",
      "conserto parede", "ajuste estrutura", "obra pequena"
    ],
    descricao:
      "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa).",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO ELETRICO",
    palavrasChave: [
      "tomada", "disjuntor", "interruptor", "reator", "soquete", "extensao",
      "fia√ß√£o", "fiacao", "el√©trico", "eletrico", "luz", "l√¢mpada", "lampada"
    ],
    descricao:
      "Troca de tomadas, disjuntores, interruptores, l√¢mpadas e pequenos reparos el√©tricos.",
    observacaoUso: "Apenas servi√ßos simples, sem necessidade de t√©cnico especializado."
  },
  {
    nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
    palavrasChave: [
      "conserto impressora", "ajuste maquina estampar", "reparo computador",
      "ferramenta manual", "manutencao equipamentos", "reparo t√©cnico"
    ],
    descricao:
      "Reparo de impressora, m√°quina de estampar e computador fora de garantia.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
    palavrasChave: [
      "ar condicionado", "ar-condicionado", "limpeza filtro", "carga gas",
      "controle remoto ar", "manuten√ß√£o ar", "reparo ar", "split"
    ],
    descricao:
      "Limpeza, carga de g√°s e pequenos ajustes em ar-condicionado.",
    observacaoUso: "N√£o cobre compra de novo aparelho."
  },
  {
    nome: "TRANSPORTE SERVICOS EMERGENCIAS",
    palavrasChave: [
      "motoboy", "moto boy", "entrega urgente", "frete", "documento matriz",
      "lalamove", "entrega loja", "envio urgente", "courier"
    ],
    descricao:
      "Frete emergencial local, motoboy ou entrega urgente entre lojas e matriz.",
    observacaoUso: "N√£o inclui transporte pessoal via aplicativos."
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
    palavrasChave: [
      "banner", "adesivo", "flyer", "folder", "encadernacao", "grafica", "impressao",
      "material visual", "cartaz", "copiadora"
    ],
    descricao:
      "Impress√µes, banners, adesivos, folders, encaderna√ß√µes e materiais visuais.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS DE LIMPEZA",
    palavrasChave: [
      "limpeza loja", "faxina", "servi√ßo limpeza", "limpeza extra", "empresa limpeza"
    ],
    descricao:
      "Contrata√ß√£o de servi√ßos de limpeza eventuais para manuten√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "CORREIOS_SEDEX/AR/POSTAGEM",
    palavrasChave: [
      "sedex", "correio", "postagem"
    ],
    descricao: "Envio de documentos f√≠sicos via Sedex, AR, ou devolu√ß√µes pequenas.",
    observacaoUso: ""
  },
  {
    nome: "LANCHES DE REFEI√á√ïES",
    palavrasChave: [
      "lanche", "coffee break", "caf√©", "bolo", "salgado", "biscoito", "refrigerante", "suco", "premia√ß√£o", "treinamento", "a√ß√£o interna", "almoco", "almo√ßo", "jantar", "pizza", "comida", "refeicao", "refei√ß√£o", "confraterniza√ß√£o", "confraternizacao", "evento interno", "kit lanche", "break", "doces", "chocolates", "frutas", "p√£o", "pao", "torta", "sandu√≠che", "sanduiche", "kit caf√©", "bebidas", "snacks", "celebracao", "celebra√ß√£o", "coquetel", "buffet", "catering", "alimentos",
  "compra de comida", "alimentacao", "alimenta√ß√£o", "workshop", "curso", "reuniao", "reuni√£o"
    ],
    descricao:
      "Lanches ou coffee break para treinamento interno, a√ß√£o aprovada ou premia√ß√£o.",
    observacaoUso: "N√£o cobre refei√ß√µes pessoais."
  },
  {
    nome: "AGUA POT√ÅVEL",
    palavrasChave: [
      "agua", "√°gua", "gal√£o", "galao", "garrafa agua", "garrafa de agua", "comprar agua", "comprar √°gua", "suprimento de √°gua", "reposi√ß√£o de √°gua", "barril de √°gua", "barril de agua", "√°gua mineral", "agua mineral", "bombona", "garraf√£o", "garrafao",
  "fornecedor de √°gua"
    ],
    descricao:
      "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe.",
    observacaoUso: ""
  },
  {
    nome: "BOBINA ECF",
    palavrasChave: [
      "bobina", "ecf", "cupom fiscal", "bobina impressora", "bobina pdv"
    ],
    descricao:
      "Bobinas para ECF / impressoras fiscais / PDV n√£o centralizados.",
    observacaoUso: ""
  },
  {
    nome: "CHAVEIRO EMERGENCIAL",
    palavrasChave: [
      "chaveiro", "abrir cofre", "abrir estoque", "trocar segredo", "sem chave", "cofre", "problema cofre", "problema fechadura", "fechadura", "perdi a chave", "esqueci a chave", "chave quebrada", "troca de chave", "fazer chave", "duplicata de chave", "copia de chave", "c√≥pia de chave", "abrir porta", "porta travada", "porta emperrada", "trancar", "trocar segredo",
      "segredo cofre", "abertura de cofre", "trocar fechadura", "concerto fechadura", "conserto fechadura", "consertar fechadura", "emerg√™ncia fechadura", "servi√ßo chaveiro", "mestre chaveiro", "tranca", "chaves", "cilindro", "miolo da chave", "reparar cofre", "reparo fechadura", "instalar fechadura"
    ],
    descricao:
      "Servi√ßo emergencial de chaveiro para abertura de cofres, vitrines e estoques.",
    observacaoUso: "Somente em emerg√™ncias operacionais."
  },
  {
    nome: "MANUTEN√á√ÉO MAQ ESTAMPAR",
    palavrasChave: [
      "estampar", "maquina estampar", "m√°quina estampar", "reparo estampar"
    ],
    descricao:
      "Reparos simples ou ajustes t√©cnicos em m√°quinas de estampar, sem controle patrimonial.",
    observacaoUso: ""
  }
];


    const perguntasGeraisEtiqueta = [
        "qual etiqueta devo usar","qual etiqueta usar","qual etiqueta eu uso",
        "que etiqueta devo usar","que etiqueta usar","que etiqueta eu uso",
        "me fala as etiquetas","me diz as etiquetas","me mostra as etiquetas",
        "me envia as etiquetas","me passa as etiquetas",
        "todas as etiquetas","lista de etiquetas","listagem de etiquetas",
        "quais etiquetas existem","quais etiquetas tem","quais sao as etiquetas",
        "quais s√£o as etiquetas","quais etiquetas posso usar",
        "quais etiquetas devo usar","quais etiquetas usar",
        "categorias de gasto","categorias de despesas","categoria de despesa",
        "categoria de gasto","categoria clara","etiqueta clara", "etiqueta", "etiquetas", "categoria"
    ].map(normalize);

    const frasesPolitica = [
        "me envia a politica","me envia a pol√≠tica","me manda a politica","me manda a pol√≠tica",
        "pol√≠tica de uso","politica de uso do cartao","pol√≠tica de uso do cart√£o", "politica", "pol√≠tica",
        "politica do cartao","pol√≠tica do cart√£o","politica do cartao clara","pol√≠tica do cart√£o clara",
        "pdf da politica","pdf da pol√≠tica","manual da politica","manual da pol√≠tica",
        "politica clara","pol√≠tica clara","politica de uso dos cartoes","pol√≠tica de uso dos cart√µes"
    ].map(normalize);

    const frasesTermo = [
        "termo de responsabilidade",
        "termo responsabilidade",
        "termo de responsabilidade do cartao",
        "termo de responsabilidade do cart√£o",
        "termo do cartao",
        "termo do cart√£o",
        "termo de uso do cartao",
        "termo de uso do cart√£o",
        "termo",
        "termo clara",
        "termo do cartao clara",
        "termo do cart√£o clara",
        "termo de aceite",
        "termo de aceite do cartao",
        "termo de aceite do cart√£o",
        "assinar termo do cartao",
        "assinar termo da clara",
        "termo de responsabilidade clara"
    ].map(normalize);

    const saudacoes = [
        "oi","ol√°","ola","opa","eai","e a√≠","iae","oi vektor","ola vektor","ol√° vektor", "bom dia","boa tarde","boa noite", "bom dia!", "boa tarde!", "boa noite!",
        "salve","fala","fala vektor","e a√≠ vektor","eai vektor","opa vektor", "tudo bem","td bem","tdb","como vai","como vc ta","como voce ta", "beleza","tranquilo","tudo certo", "como vai vc", "como vai voc√™", "como t√°", "como ta", "eae", "i ae"
    ].map(normalize);

    const frasesEncerramento = [
        "ok","okay","okey","certo","blz","beleza","ok valeu", "entendi","entendido","tudo certo","td certo","tds certo", "√© nois q t√°", "√© n√≥is", "tmj", "tamo junto", "gratidao", "t√° bom","ta bom","t√° √≥timo","ta otimo","t√° otimo", "muito obrigado", "muito obrigada", "gratid√£o", "show","show de bola","valeu","vlw","obrigado","obrigada", "grato", "grata", "agradessido", "agradecida", "agradecido","agradessida","tranquilo","de boa","suave", "thanks", "tks", "pode deixar","certinho","maravilha","perfeito","j√≥ia","joia", "joinha", "tmj cachorro", "supimpa", "excelente", "fantastico", "fant√°stico", "saquei"
    ].map(normalize);

    const termosPendencias = [
        "pendencia clara","pend√™ncias clara","pendencias clara",
        "bloqueio por pendencia","bloqueio por pend√™ncia",
        "pendencia do cartao","pend√™ncia do cart√£o",
        "loja bloqueada clara","cart√£o bloqueado por pendencia",
        "cobran√ßa clara","transa√ß√µes pendentes clara",
        "pendencia","pend√™ncia","pendencias","pend√™ncias"
    ].map(normalize);

    const palavrasMudancaAssunto = [
        "cartao","cart√£o","etiqueta","categoria","politica","pol√≠tica","sangria",
        "bloqueio","novo","pendencia","pend√™ncia","comprar","limite","uber",
        "agua","√°gua","lanche","fraude","contestacao","contesta√ß√£o","prestacao","presta√ß√£o"
    ].map(normalize);


    const gatilhosNovoCartao = [
        "quero solicitar um cartao",
        "quero solicitar um cart√£o",
        "novo cartao",
        "novo cart√£o",
        "cartao novo",
        "cart√£o novo",
        "quero solicitar cartao clara",
        "quero solicitar cart√£o clara",
        "quero pedir um cartao",
        "quero pedir um cart√£o",
        "quero pedir cartao clara",
        "quero pedir cart√£o clara",
        "quero cartao clara",
        "quero cart√£o clara",
        "preciso de um cartao",
        "preciso de um cart√£o",
        "preciso de cartao clara",
        "preciso de cart√£o clara",
        "nao tenho cartao clara ainda",
        "n√£o tenho cartao clara ainda",
        "nao tenho cart√£o clara ainda",
        "ainda nao tenho cartao clara",
        "ainda n√£o tenho cart√£o clara",
        "como pedir cartao",
        "como pedir cart√£o",
        "como solicitar cartao",
        "como solicitar cart√£o",
        "como conseguir um cartao clara",
        "como conseguir um cart√£o clara",
        "fui promovido e nao tenho cartao",
        "fui promovido e n√£o tenho cart√£o",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e n√£o tenho cart√£o",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e n√£o tenho cart√£o",
        "primeira via do cartao",
        "primeira via do cart√£o",
        "1a via do cartao",
        "1¬™ via do cartao",
        "1a via do cart√£o",
        "1¬™ via do cart√£o",
        "preciso solicitar um cartao",
        "preciso solicitar um cart√£o",
        "gostaria de solicitar um cartao",
        "gostaria de solicitar um cart√£o",
        "quero novo cartao",
        "quero novo cart√£o",
        "preciso novo cartao",
        "preciso novo cart√£o",
        "nao tenho cartao",
        "n√£o tenho cart√£o",
        "nunca tive cartao",
        "nunca tive cart√£o"
    ].map(normalize);

    const termosPrimeiraViaDireta = [
        "primeira via",
        "1 via",
        "1a via",
        "1¬™ via",
        "primeiro cartao",
        "primeiro cart√£o",
        "meu primeiro cartao",
        "meu primeiro cart√£o",
        "nunca tive cartao clara",
        "nunca tive cart√£o clara",
        "quero minha primeira via",
        "quero 1 via",
        "pedir primeira via",
        "solicitar primeira via"
    ].map(normalize);

    const gatilhosSegundaViaDireta = [
        "segunda via",
        "2 via",
        "2a via",
        "2¬™ via",
        "segunda via",
        "segunda bia",
        "segundavia",
        "segunda vias",
        "segundas via",
        "segundas vias",
        "reemitir cartao",
        "reemitir cart√£o",
        "reemissao cartao",
        "reemissao de cartao",
        "reemissao de cartao",
        "reemiss√£o cart√£o",
        "reemitir meu cartao",
        "reemitir meu cart√£o",
        "perdi o cartao",
        "perdi o cart√£o",
        "perdi meu cartao",
        "perdi meu cart√£o",
        "perdi o meu cart√£o",
        "perdi o meu cartao",
        "eu perdi o cart√£o",
        "eu perdi o cartao",
        "percas de cartao",
        "perca de cart√£o",
        "perca de cartao",
        "perda de cartao",
        "perda de cart√£o",
        "solicitar segunda via",
        "solicitar 2via",
        "solicitar 2 via",
        "solicita√ß√£o de segunda via",
        "solicita√ß√£o de 2 via",
        "roubaram meu cartao",
        "roubaram meu cart√£o",
        "me roubaram",
        "mi roubaram",
        "fui roubado",
        "cartao furtado",
        "furto",
        "cart√£o furtado",
        "roubo",
        "roubo de cart√£o",
        "perda de cart√£o",
        "perca de cart√£o",
        "cartao quebrado",
        "cart√£o quebrado",
        "cartao danificado",
        "cart√£o danificado"
    ].map(normalize);

    const perguntasGeraisOquePosso = [
        "o que posso comprar",
        "oq comprar com o cart√£o da Clara",
        "o que pode comprar",
        "o que pode comprar com o cart√£o",
        "o que pode comprar com o cartao",
        "oque comprar",
        "o que comprar",
        "posso comprar o que",
        "o que posso usar",
        "quais compras",
        "o que √© permitido",
        "o que nao posso",
        "o que n√£o posso",
        "o que nao posso comprar",
        "o que n√£o posso comprar",
        "o que nao comprar",
        "o que n√£o comprar"
    ].map(normalize);

    /* ========= INTEN√á√ÉO ========= */

    function detectarIntencaoPergunta(msgNorm) {
        // garante que msgNorm √© sempre string e cria um alias "norm"
      msgNorm = msgNorm || "";
      const norm = msgNorm;

      // RESPOSTAS SOBRE O QUE O VEKTOR FAZ
if (
    msgNorm.includes("o que voce faz") ||
    msgNorm.includes("o que voce pode fazer") ||
    msgNorm.includes("o que o vektor pode fazer") ||
    msgNorm.includes("pra que serve") ||
    msgNorm.includes("qual sua fun√ß√£o") ||
    msgNorm.includes("quem √© voc√™") ||
    msgNorm.includes("quem e voce") ||
    msgNorm.includes("qual o seu nome") ||
    msgNorm.includes("me explique o que faz") ||
    msgNorm.includes("sobre o que voce fala") ||
    msgNorm.includes("sobre o que voc√™ fala")
) {
    return "sobreBot";
}

  const foraEscopoPadroes = [
    "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
    "presidente","futebol","time joga","campeonato","xing","vai tomar",
    "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
    "piada","xingar","palavr√£o","palavrao"
  ];
  for (const termo of foraEscopoPadroes) {
    if (msgNorm.includes(normalize(termo))) {
      return "foraEscopo";
    }
  }

  if (
    msgNorm.includes("etiqueta") ||
    msgNorm.includes("etiquetas") ||
    msgNorm.includes("qual etiqueta") ||
    msgNorm.includes("que etiqueta")
  ) {
    return "etiqueta";
  }

    // üîπ Perguntas sobre "quais chamados / procedimentos existem no ServiceNow para a Clara"
  const falaServiceNow =
    msgNorm.includes("servicenow") ||
    msgNorm.includes("service now");

  const falaChamado =
    msgNorm.includes("chamado") ||
    msgNorm.includes("chamados") ||
    msgNorm.includes("ticket") ||
    msgNorm.includes("solicitacao") ||
    msgNorm.includes("solicita√ß√£o") ||
    msgNorm.includes("solicitacoes") ||
    msgNorm.includes("solicita√ß√µes") ||
    msgNorm.includes("procedimento") ||
    msgNorm.includes("procedimentos");

    const falaClara =
    msgNorm.includes("clara") ||
    msgNorm.includes("cartao") ||
    msgNorm.includes("cart√£o") ||
    msgNorm.includes("fatura") ||
    msgNorm.includes("cartoes") ||
    msgNorm.includes("cart√µes");

  if (
    (falaServiceNow && falaChamado && falaClara) ||
    // NOVO IF (Condi√ß√£o OU): Service Now E Chamado
    (falaServiceNow && falaChamado) ||
    

    // alguns atalhos mais diretos, caso a pessoa n√£o escreva "clara"
    msgNorm.includes("procedimentos servicenow") ||
    msgNorm.includes("tipos de chamado da clara") ||
    msgNorm.includes("tipos de chamado clara") ||
    msgNorm.includes("chamados da clara no servicenow")
  ) {
    return "procedimentosServiceNow";
  }

    // se falar de ServiceNow + (chamado OU Clara), j√° manda pra procedimentosServiceNow
  if (falaServiceNow && (falaChamado || falaClara)) {
    return "procedimentosServiceNow";
  }

  // tamb√©m aceita frases mais simples tipo "como abrir chamado no servicenow"
  if (falaServiceNow && norm.includes("abrir") && norm.includes("chamado")) {
    return "procedimentosServiceNow";
  }

  // fallback suave: se a pessoa s√≥ digita "servicenow" ou algo muito curto com o nome,
// tamb√©m manda para os procedimentos do ServiceNow.
if (falaServiceNow && !falaChamado) {
  return "procedimentosServiceNow";
}

 // 4) Troca / afastamento / demiss√£o de gerente, uso de cart√£o de outra loja
  const falaTrocaGerente =
    norm.includes("mudar de loja") ||
    norm.includes("mudanca de loja") ||
    norm.includes("mudan√ßa de loja") ||
    norm.includes("troca de loja") ||
    norm.includes("trocar de loja") ||
    norm.includes("vou mudar de loja") ||
    norm.includes("fui transferido") ||
    norm.includes("fui transferida") ||
    norm.includes("transferido de loja") ||
    norm.includes("transferida de loja") ||
    norm.includes("transferencia de loja") ||
    norm.includes("transfer√™ncia de loja") ||
    norm.includes("mudei de loja") ||          // <<< ESSA AQUI ESTAVA FALTANDO PRA SUA FRASE
    norm.includes("mudei de unidade") ||
    norm.includes("trocar de unidade") ||
    norm.includes("troquei de loja") ||
    norm.includes("sou de outra loja") ||
    norm.includes("sou de outra unidade") ||

    norm.includes("gerente desligado") ||
    norm.includes("sem gerente") ||
    norm.includes("gerente saiu") ||
    norm.includes("gerente saiu da loja") ||
    norm.includes("gerente demitido") ||
    norm.includes("gerente demitida") ||
    norm.includes("gerente foi desligado") ||
    norm.includes("gerente foi desligada") ||
    norm.includes("minha loja esta sem gerente") ||
    norm.includes("minha loja est√° sem gerente") ||

    norm.includes("gerente afastado") ||
    norm.includes("gerente afastada") ||
    norm.includes("afastamento do gerente") ||
    norm.includes("gerente de ferias") ||
    norm.includes("gerente de f√©rias") ||
    norm.includes("gestor de ferias") ||
    norm.includes("gestor de f√©rias") ||

    norm.includes("gerente novo") ||
    norm.includes("novo gerente") ||
    norm.includes("novo gerente da loja") ||
    norm.includes("troca de gerente") ||
    norm.includes("troca do gerente") ||

    norm.includes("cartao de outra loja") ||
    norm.includes("cart√£o de outra loja") ||
    norm.includes("usar cartao de outra loja") ||
    norm.includes("usar cart√£o de outra loja") ||
    norm.includes("colocar cartao de outra loja") ||
    norm.includes("habilitar cartao de outra loja") ||
    norm.includes("como uso o cartao em outra loja") ||
    norm.includes("cartao nao funciona em outra loja") ||
    norm.includes("cart√£o n√£o funciona em outra loja");

  if (falaTrocaGerente) {
    return "trocaGerente";
  }


  if (
    msgNorm.includes("aumentar limite") ||
    msgNorm.includes("aumento de limite") ||
    msgNorm.includes("limite maior") ||
    msgNorm.includes("limite do cartao") ||
    msgNorm.includes("limite do cart√£o") ||
    msgNorm.includes("limite nao basta") ||
    msgNorm.includes("limite n√£o basta") ||
    msgNorm.includes("limite acabou") ||
    msgNorm.includes("limite estourou") ||
    msgNorm.includes("quero mais limite") ||
    msgNorm.includes("preciso de mais limite") ||
    msgNorm.includes("como aumentar meu limite") ||
    msgNorm.includes("solicitar aumento de limite") ||
    msgNorm.includes("limite baixo") ||
    msgNorm.includes("qual o limite do cartao") ||
    msgNorm.includes("qual o limite do cart√£o") ||
    msgNorm.includes("meu limite") ||
    msgNorm.includes("consultar limite") ||
    msgNorm.includes("ver limite") ||
    msgNorm.includes("quanto tenho de limite") ||
    msgNorm.includes("limite disponivel") ||
    msgNorm.includes("limite dispon√≠vel") ||
    msgNorm.includes("baixar limite") ||
    msgNorm.includes("diminuir limite") ||
    msgNorm.includes("limite de credito") ||
    msgNorm.includes("limite de cr√©dito") ||
    msgNorm.includes("limite total") ||
    msgNorm.includes("limite nao liberado") ||
    msgNorm.includes("limite n√£o liberado") ||
    msgNorm.includes("limite acabou de novo") ||
    msgNorm.includes("por que meu limite nao aumenta") ||
    msgNorm.includes("por que meu limite n√£o aumenta") ||
    msgNorm.includes("limite esgotado") ||
    msgNorm.includes("gastei o limite todo") ||
    msgNorm.includes("aumento de credito") ||
    msgNorm.includes("aumento de cr√©dito") ||
    msgNorm.includes("ajustar limite") ||
    msgNorm.includes("liberar mais limite") ||
    msgNorm.includes("limite")
  ) {
    return "limite";
  }

  // üîπ Transa√ß√£o negada / categoria bloqueada para compra
  if (
    msgNorm.includes("transacao negada") ||
    msgNorm.includes("transa√ß√£o negada") ||
    msgNorm.includes("transacao recusada") ||
    msgNorm.includes("transa√ß√£o recusada") ||
    msgNorm.includes("compra negada") ||
    msgNorm.includes("compra recusada") ||
    msgNorm.includes("compra foi recusada") ||
    msgNorm.includes("compra rejeitada") ||
    msgNorm.includes("compra nao passou") ||
    msgNorm.includes("compra n√£o passou") ||
    msgNorm.includes("compra nao autorizada") ||
    msgNorm.includes("compra n√£o autorizada") ||
    msgNorm.includes("transacao nao autorizada") ||
    msgNorm.includes("transa√ß√£o n√£o autorizada") ||
    msgNorm.includes("transacao bloqueada") ||
    msgNorm.includes("transa√ß√£o bloqueada") ||
    msgNorm.includes("cartao nao passou") ||
    msgNorm.includes("cart√£o n√£o passou") ||
    msgNorm.includes("cartao recusado") ||
    msgNorm.includes("cart√£o recusado") ||
    msgNorm.includes("cartao negado") ||
    msgNorm.includes("cart√£o negado") ||
    msgNorm.includes("cartao nao autorizou") ||
    msgNorm.includes("cart√£o n√£o autorizou") ||
    msgNorm.includes("cartao travou na maquininha") ||
    msgNorm.includes("cartao travou na m√°quina") ||
    msgNorm.includes("cartao travou") ||
    msgNorm.includes("cart√£o travou") ||
    msgNorm.includes("nao passou o cartao") ||
    msgNorm.includes("n√£o passou o cart√£o") ||
    msgNorm.includes("nao autorizou a compra") ||
    msgNorm.includes("n√£o autorizou a compra") ||
    msgNorm.includes("recusou a compra") ||
    msgNorm.includes("recusou o pagamento") ||
    msgNorm.includes("falha na compra") ||
    msgNorm.includes("falha de pagamento") ||
    msgNorm.includes("erro na compra") ||
    msgNorm.includes("erro de pagamento") ||
    msgNorm.includes("erro no cartao") ||
    msgNorm.includes("erro no cart√£o") ||
    msgNorm.includes("compra deu erro") ||
    msgNorm.includes("pagamento negado") ||
    msgNorm.includes("pagamento recusado") ||
    msgNorm.includes("pagamento bloqueado") ||
    msgNorm.includes("categoria bloqueada") ||
    msgNorm.includes("categoria bloqueado") ||
    msgNorm.includes("categoria nao liberada") ||
    msgNorm.includes("tentando usar o cart√£o") ||
    msgNorm.includes("tentando usar o cartao") ||
    msgNorm.includes("categoria n√£o liberada") ||
    msgNorm.includes("liberar categoria") ||
    msgNorm.includes("liberacao de categoria") ||
    msgNorm.includes("tentei passar o cart√£o e deu erro") ||
    msgNorm.includes("tentar passar o cart√£o") ||
    msgNorm.includes("tentar passar o cartao") ||
    msgNorm.includes("tentar usar o cartao") ||
    msgNorm.includes("tentar usar o cart√£o") ||
    msgNorm.includes("tentei passar o cartao e deu erro") ||
    msgNorm.includes("a compra foi recusada na maquininha") ||
    msgNorm.includes("n√£o consegui usar o cart√£o") ||
    msgNorm.includes("n√£o consegui usar o cartao") ||
    msgNorm.includes("nao consegui usar o cartao") ||
    msgNorm.includes("libera√ß√£o de categoria") ||
    msgNorm.includes("mcc bloqueado") ||
    msgNorm.includes("codigo bloqueado") ||
    msgNorm.includes("c√≥digo bloqueado") ||
    msgNorm.includes("nao liberou") ||
    msgNorm.includes("n√£o liberou") ||
    msgNorm.includes("nao conseguiu passar") ||
    msgNorm.includes("n√£o conseguiu passar") ||
    msgNorm.includes("nao consegui usar") ||
    msgNorm.includes("n√£o consegui usar") ||
    msgNorm.includes("tentei usar e nao foi") ||
    msgNorm.includes("tentei usar e n√£o foi") ||
    msgNorm.includes("tentei comprar e deu erro") ||
    msgNorm.includes("tentou passar e nao foi") ||
    msgNorm.includes("tentou passar e n√£o foi") ||
    msgNorm.includes("nao aceitou") ||
    msgNorm.includes("n√£o aceitou") ||
    msgNorm.includes("nao deu certo a compra") ||
    msgNorm.includes("n√£o deu certo a compra") ||
    msgNorm.includes("bloqueou a compra") ||
    msgNorm.includes("bloqueou a transacao") ||
    msgNorm.includes("bloqueou a transa√ß√£o") ||
    msgNorm.includes("compra nao permitida") ||
    msgNorm.includes("compra n√£o permitida") ||
    msgNorm.includes("transacao nao permitida") ||
    msgNorm.includes("transa√ß√£o n√£o permitida")
  ) {
    return "transacaoNegadaCategoria";
  }

  if (
    msgNorm.includes("bloqueou") ||
    msgNorm.includes("bloqueado") ||
    msgNorm.includes("desbloquear") ||
    msgNorm.includes("cartao travou") ||
    msgNorm.includes("cart√£o travou") ||
    msgNorm.includes("travou o cartao") ||
    msgNorm.includes("travou o cart√£o") ||
    msgNorm.includes("bloquear cartao") ||
    msgNorm.includes("bloquear cart√£o") ||
    msgNorm.includes("queria bloquear") ||
    msgNorm.includes("quero bloquear") ||
    msgNorm.includes("como bloquear") ||
    msgNorm.includes("cartao bloqueado") ||
    msgNorm.includes("cart√£o bloqueado") ||
    msgNorm.includes("meu cartao nao funciona") ||
    msgNorm.includes("meu cart√£o n√£o funciona") ||
    msgNorm.includes("meu cart√£o t√° bloqueado") ||
    msgNorm.includes("pq meu cart√£o t√° bloqueadp") ||
    msgNorm.includes("pq meu cart√£o t√° bloqueado") ||
    msgNorm.includes("meu cartao ta bloqueado") ||
    msgNorm.includes("nao consigo usar o cartao") ||
    msgNorm.includes("n√£o consigo usar o cart√£o") ||
    msgNorm.includes("problema no cartao") ||
    msgNorm.includes("problema no cart√£o") ||
    msgNorm.includes("suspender cartao") ||
    msgNorm.includes("suspender cart√£o") ||
    msgNorm.includes("suspender o uso") ||
    msgNorm.includes("o cartao parou") ||
    msgNorm.includes("o cart√£o parou") ||
    msgNorm.includes("ativar cartao") ||
    msgNorm.includes("ativar cart√£o") ||
    msgNorm.includes("reativar cartao") ||
    msgNorm.includes("reativar cart√£o") ||
    msgNorm.includes("travamento") ||
    msgNorm.includes("por que nao funciona") ||
    msgNorm.includes("por que n√£o funciona") ||
    msgNorm.includes("desliguei o cartao") ||
    msgNorm.includes("desliguei o cart√£o") ||
    msgNorm.includes("bloqueio preventivo")
  ) {
    return "bloqueio";
  }

  // -------------------------------------------------------------
// RESPOSTAS DE JUSTIFICATIVAS / NOTAS / PERDA DE COMPROVANTE
// -------------------------------------------------------------
if (
  msgNorm.includes("como justificar") ||
  msgNorm.includes("v√≠deo de justificativa") ||
  msgNorm.includes("video de justificativa") ||
  msgNorm.includes("v√≠deo de justificativas") ||
  msgNorm.includes("video de justificativas") ||
  msgNorm.includes("como justificar essa compra") ||
  msgNorm.includes("como envio comprovante?") ||
  msgNorm.includes("justificar compra") ||
  msgNorm.includes("prestar contas") ||
  msgNorm.includes("prestacao de contas") ||
  msgNorm.includes("presta√ß√£o de contas") ||
  msgNorm.includes("colocar nota") ||
  msgNorm.includes("inserir nota") ||
  msgNorm.includes("anexar nota") ||
  msgNorm.includes("descricao na clara") ||
  msgNorm.includes("como inserir nota") ||
  msgNorm.includes("nota fiscal") ||
  msgNorm.includes("como lan√ßar despesas na clara?") ||
  msgNorm.includes("nota da compra") ||
  msgNorm.includes("escrever justificativa") ||
  msgNorm.includes("como colocar justificativa") ||
  msgNorm.includes("comprovante") ||
  msgNorm.includes("comprovantes") ||
  msgNorm.includes("comprovante de compra") ||
  msgNorm.includes("comprovacao de despesa") ||
  msgNorm.includes("comprova√ß√£o de despesa") ||
  msgNorm.includes("registro de despesa") ||
  msgNorm.includes("lan√ßar despesa") ||
  msgNorm.includes("lancamento de despesa") ||
  msgNorm.includes("lan√ßamento de despesa") ||
  msgNorm.includes("reembolso sem nota") ||
  msgNorm.includes("perdi a nota") ||        // << IMPORTANTE
  msgNorm.includes("despesa sem comprovante") ||
  msgNorm.includes("colocar comprovante") ||
  msgNorm.includes("como declarar") ||
  msgNorm.includes("declarar despesa") ||
  msgNorm.includes("como finalizar prestacao") ||
  msgNorm.includes("como finalizar presta√ß√£o") ||
  msgNorm.includes("relatorio de despesa") ||
  msgNorm.includes("relat√≥rio de despesa") ||
  msgNorm.includes("enviar nota") ||
  msgNorm.includes("falta a nota") ||
  msgNorm.includes("despesa sem nota") ||
  msgNorm.includes("finalizar contas") ||
  msgNorm.includes("minhas prestacoes") ||
  msgNorm.includes("minhas presta√ß√µes") ||
  msgNorm.includes("descri√ß√£o na clara")
) {

  // 1. Mensagem bem espec√≠fica caso tenha perdido a nota
  if (
    msgNorm.includes("perdi a nota") ||
    msgNorm.includes("falta a nota") ||
    msgNorm.includes("despesa sem nota") ||
    msgNorm.includes("despesa sem comprovante")
  ) {
    renderBotMessage("HTML:" +
      `<p class="text-sm text-slate-700">
        Quando a loja perde a nota fiscal, deve abrir uma <b>ocorr√™ncia formal de extravio</b> e anexar esse documento no app da Clara, como justificativa da transa√ß√£o. O financeiro ir√° avaliar o caso. Ocorr√™ncias recorrentes podem gerar recusa definitiva.
      </p>`
    );
  } else {
    // 2. Mensagem geral de justificativa
    renderBotMessage("HTML:" +
      `<p class="text-sm text-slate-700">
        Para justificar uma compra no app da Clara, basta abrir a transa√ß√£o, escrever a descri√ß√£o e anexar o comprovante ou nota fiscal correspondente.
      </p>`
    );
  }

  // 3. Enviar automaticamente o v√≠deo de justificativas
  const videoHtml = [
  "<div style='margin-top:8px; text-align:center;'>",
  "  <p class='text-sm text-slate-700' style='text-align:center;'>",
  "    Assista ao v√≠deo abaixo, explicando sobre o procedimento de justificativas no app da Clara.",
  "    Clique nos 3 pontos do lado direito inferior e escolha ",
  "    <b style='color:#005E27;'>Picture-in-picture</b> ",
  "    para ver em um formato melhor:",
  "  </p>",
  "  <div style='width:100%; display:flex; justify-content:center; margin-top:12px;'>",
  "    <video controls style='width:100%; max-width:480px; border-radius:8px; object-fit:contain;'>",
  "      <source src='https://raw.githubusercontent.com/rslisboa/cartoesclara/4fad8ce4eda430baf37ecccd7d480a77f759af27/Video%20Clara%20(4).mp4' type='video/mp4'>",
  "      Seu navegador n√£o suporta v√≠deo HTML5.",
  "    </video>",
  "  </div>",
  "</div>"
].join("");

  renderBotMessage("HTML:" + videoHtml);
  return null;
}

  if (
    msgNorm.includes("lanche") ||
    msgNorm.includes("lanche pro time") ||
    msgNorm.includes("lanche para o time") ||
    msgNorm.includes("cafe pro time") ||
    msgNorm.includes("caf√© pro time") ||
    msgNorm.includes("coffee break") ||
    msgNorm.includes("agua") ||
    msgNorm.includes("√°gua") ||
    msgNorm.includes("gal√£o") ||
    msgNorm.includes("galao") ||
    msgNorm.includes("premiacao") ||
    msgNorm.includes("premia√ß√£o")
  ) {
    return "alimentoTime";
  }

  if (
    msgNorm.includes("uber") ||
    msgNorm.includes("iber") ||
    msgNorm.includes(" 99") ||
    msgNorm.includes("taxi") ||
    msgNorm.includes("t√°xi") ||
    msgNorm.includes("tax√≠") ||
    msgNorm.includes("cabify") ||
    msgNorm.includes("transporte") ||
    msgNorm.includes("aplicativo de transporte") ||
    msgNorm.includes("motorista de aplicativo") ||
    msgNorm.includes("carro por app") ||
    msgNorm.includes("carona") ||
    msgNorm.includes("como chamar um carro") ||
    msgNorm.includes("como pedir um carro") ||
    msgNorm.includes("uber black") ||
    msgNorm.includes("uber x") ||
    msgNorm.includes("99 pop") ||
    msgNorm.includes("99taxi") ||
    msgNorm.includes("uber drive") ||
    msgNorm.includes("uber motorista") ||
    msgNorm.includes("uber pass") ||
    msgNorm.includes("uber eats") ||
    msgNorm.includes("servi√ßo de transporte") ||
    msgNorm.includes("qual app de carro") ||
    msgNorm.includes("motorista particular") ||
    msgNorm.includes("drive") ||
    msgNorm.includes("drivi") ||
    msgNorm.includes("indriver") ||
    msgNorm.includes("in driver") ||
    msgNorm.includes("waze carpool") ||
    msgNorm.includes("waze car pool") ||
    msgNorm.includes("taxi particular") ||
    msgNorm.includes("taxi 99") ||
    msgNorm.includes("app de taxi") ||
    msgNorm.includes("app de t√°xi") ||
    msgNorm.includes("app de transporte")
  ) {
    return "transportePessoal";
  }

  const temGerenteOuGestor =
  msgNorm.includes("gerente") ||
  msgNorm.includes("gerentes") ||
  msgNorm.includes("gestor") ||
  msgNorm.includes("gestora");

const temFerias =
  msgNorm.includes("ferias"); // j√° est√° normalizado sem acento

const temAfastamento =
  msgNorm.includes("afastado")  ||
  msgNorm.includes("afastada")  ||
  msgNorm.includes("afastados") ||
  msgNorm.includes("afastadas") ||
  msgNorm.includes("afastamento");

const temDesligamento =
  msgNorm.includes("desligado")  ||
  msgNorm.includes("desligada")  ||
  msgNorm.includes("demitido")   ||
  msgNorm.includes("demitida")   ||
  msgNorm.includes("demissao")   ||
  msgNorm.includes("demiss√£o");

if (
  // seus casos antigos de troca de loja, cart√£o de outra loja, etc...
  msgNorm.includes("mudar de loja") ||
  msgNorm.includes("troca de loja") ||
  // ... (mantenha o que j√° tem aqui)

  // gerente de f√©rias / gestor de f√©rias
  (temGerenteOuGestor && temFerias) ||

  // gerente afastado / afastamento do gerente
  (temGerenteOuGestor && temAfastamento) ||

  // gerente foi desligado / demitido
  (temGerenteOuGestor && temDesligamento)
) {
  return "trocaGerente";
}

  if (
    msgNorm.includes("sangria") ||
    msgNorm.includes("sangrias") ||
    msgNorm.includes("fazer sangria") ||
    msgNorm.includes("puxar dinheiro do caixa") ||
    msgNorm.includes("retirar dinheiro do caixa") ||
    msgNorm.includes("tirar dinheiro do caixa") ||
    msgNorm.includes("retirada de dinheiro do caixa") ||
    msgNorm.includes("movimentacao de dinheiro no caixa") ||
    msgNorm.includes("movimenta√ß√£o de dinheiro no caixa") ||
    msgNorm.includes("fechar o caixa") ||
    msgNorm.includes("como fechar o caixa") ||
    msgNorm.includes("retirar valor do caixa") ||
    msgNorm.includes("como fazer sangria") ||
    msgNorm.includes("registrar saida de dinheiro") ||
    msgNorm.includes("registrar sa√≠da de dinheiro") ||
    msgNorm.includes("saida de dinheiro do caixa") ||
    msgNorm.includes("sa√≠da de dinheiro do caixa") ||
    msgNorm.includes("suprimento") ||
    msgNorm.includes("suprimentos") ||
    msgNorm.includes("fazer suprimento") ||
    msgNorm.includes("colocar dinheiro no caixa") ||
    msgNorm.includes("registro de suprimento") ||
    msgNorm.includes("registro de retirada") ||
    msgNorm.includes("registrando sangria") ||
    msgNorm.includes("registro de sangria") ||
    msgNorm.includes("tirar troco do caixa") ||
    msgNorm.includes("depositar dinheiro no caixa") ||
    msgNorm.includes("deposito no caixa") ||
    msgNorm.includes("dep√≥sito no caixa") ||
    msgNorm.includes("remocao de dinheiro") ||
    msgNorm.includes("remo√ß√£o de dinheiro") ||
    msgNorm.includes("retirar excesso") ||
    msgNorm.includes("dinheiro a mais no caixa") ||
    msgNorm.includes("ajuste de caixa") ||
    msgNorm.includes("retirar dinheiro do caixa")
  ) {
    return "sangria";
  }

  if (
    msgNorm.includes("nao reconheco") ||
    msgNorm.includes("n√£o reconhe√ßo") ||
    msgNorm.includes("fraude") ||
    msgNorm.includes("compra indevida") ||
    msgNorm.includes("contestar compra") ||
    msgNorm.includes("contestacao") ||
    msgNorm.includes("compra que nao fiz") ||
    msgNorm.includes("compra que n√£o fiz") ||
    msgNorm.includes("nao fiz essa compra") ||
    msgNorm.includes("n√£o fiz essa compra") ||
    msgNorm.includes("compra desconhecida") ||
    msgNorm.includes("uso indevido") ||
    msgNorm.includes("estorno") ||
    msgNorm.includes("quero estornar") ||
    msgNorm.includes("quero cancelar compra") ||
    msgNorm.includes("cancelar compra indevida") ||
    msgNorm.includes("compra suspeita") ||
    msgNorm.includes("transacao nao reconhecida") ||
    msgNorm.includes("transa√ß√£o n√£o reconhecida") ||
    msgNorm.includes("cartao clonado") ||
    msgNorm.includes("clonaram meu cartao") ||
    msgNorm.includes("clonaram meu cart√£o") ||
    msgNorm.includes("roubaram meu cartao") ||
    msgNorm.includes("roubaram meu cart√£o") ||
    msgNorm.includes("uso nao autorizado") ||
    msgNorm.includes("uso n√£o autorizado") ||
    msgNorm.includes("quero o dinheiro de volta") ||
    msgNorm.includes("reembolso") ||
    msgNorm.includes("solicitar estorno") ||
    msgNorm.includes("transacao suspeita") ||
    msgNorm.includes("tentativa de fraude") ||
    msgNorm.includes("estorno da compra") ||
    msgNorm.includes("cai em golpe") ||
    msgNorm.includes("golpe no cartao") ||
    msgNorm.includes("golpe no cart√£o") ||
    msgNorm.includes("fui roubado") ||
    msgNorm.includes("contesta√ß√£o")
  ) {
    return "fraudeContestacao";
  }

  // aqui voc√™ PODE manter um √∫nico bloco de cartaoGeral (n√£o dois)

  if (
    msgNorm.includes("posso comprar") ||
    msgNorm.includes("posso usar") ||
    msgNorm.includes("pode usar") ||
    msgNorm.includes("pode pagar") ||
    msgNorm.includes("pode gastar") ||
    msgNorm.includes("pode comprar") ||
    msgNorm.includes("o que pode comprar") ||
    msgNorm.includes("oq eu posso comprar com o cart√£o") ||
    msgNorm.includes("oq pode comprar") ||
    msgNorm.includes("pode no cartao") ||
    msgNorm.includes("pode no cart√£o") ||
    msgNorm.includes("pode colocar no cartao") ||
    msgNorm.includes("pode colocar no cart√£o") ||
    msgNorm.includes("posso usar o cartao para") ||
    msgNorm.includes("posso usar o cart√£o para") ||
    msgNorm.includes("para que posso usar") ||
    msgNorm.includes("o que da pra pagar") ||
    msgNorm.includes("oq da pra pagar") ||
    msgNorm.includes("o que da para pagar") ||
    msgNorm.includes("posso pagar") ||
    msgNorm.includes("oq pagar") ||
    msgNorm.includes("pagar com o cartao") ||
    msgNorm.includes("pagar com o cart√£o") ||
    msgNorm.includes("oque posso pagar") ||
    msgNorm.includes("o q posso pagar") ||
    msgNorm.includes("oq eu posso pagar") ||
    msgNorm.includes("eu posso pagar") ||
    msgNorm.includes("posso passar o cartao") ||
    msgNorm.includes("posso passar o cart√£o") ||
    msgNorm.includes("oq eu gasto") ||
    msgNorm.includes("o que posso gastar") ||
    msgNorm.includes("posso usar cartao") ||
    msgNorm.includes("posso usar cart√£o") ||
    msgNorm.includes("o que posso fazer") ||
    msgNorm.includes("oq da pra fazer") ||
    msgNorm.includes("posso adquirir") ||
    msgNorm.includes("que da pra adquirir") ||
    msgNorm.includes("para que serve o cartao") ||
    msgNorm.includes("para que serve o cart√£o") ||
    msgNorm.includes("em que posso usar") ||
    msgNorm.includes("em que eu posso usar") ||
    msgNorm.includes("oq pode pagar") ||
    msgNorm.includes("pode ser pago") ||
    (typeof perguntasGeraisOquePosso !== "undefined" &&
     perguntasGeraisOquePosso.some(f => msgNorm.includes(f)))
  ) {
    return "podeNaoPode";
  }

  // Conversa geral sobre cart√£o Clara
  if (
    msgNorm.includes("cartao clara") ||
    msgNorm.includes("cart√£o clara") ||
    (msgNorm.includes("cartao") && msgNorm.includes("clara")) ||
    (msgNorm.includes("cart√£o") && msgNorm.includes("clara")) ||
    msgNorm.includes("cartao das lojas") ||
    msgNorm.includes("cart√£o das lojas") ||
    msgNorm.includes("cartao nas lojas") ||
    msgNorm.includes("cart√£o nas lojas") ||
    msgNorm.includes("falar sobre o cartao") ||
    msgNorm.includes("falar sobre o cart√£o") ||
    msgNorm.includes("informacoes sobre o cartao") ||
    msgNorm.includes("informa√ß√µes sobre o cart√£o") ||
    msgNorm.includes("duvida sobre o cartao") ||
    msgNorm.includes("d√∫vida sobre o cart√£o") ||
    msgNorm.includes("tudo sobre a clara") ||
    msgNorm.includes("como funciona a clara") ||
    msgNorm.includes("o que √© a clara") ||
    msgNorm.includes("o que e a clara") ||
    msgNorm.includes("o q e a clara") ||
    msgNorm.includes("cartao corporativo") ||
    msgNorm.includes("cart√£o corporativo") ||
    msgNorm.includes("cartao de credito corporativo") ||
    msgNorm.includes("cart√£o de cr√©dito corporativo") ||
    msgNorm.includes("duvida clara") ||
    msgNorm.includes("d√∫vida clara")
  ) {
    return "cartaoGeral";
  }

  return "generica";
}

// Bloco HTML para o relat√≥rio gerencial da Clara (Looker Studio)
const htmlRelatorioGerencial = [
  "<div class='w-full'>",
  "  <div class='w-full mt-1'>",
  "    <iframe",
  "      src='https://lookerstudio.google.com/embed/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF'",
  "      width='100%'",
  "      height='6630'",
  "      frameborder='0'",
  "      style='border:0;border-radius:0.75rem;'",
  "      allowfullscreen",
  "      sandbox='allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox'>",
  "    </iframe>",
  "  </div>",
  "</div>"
].join("");

function respProcedimentosServiceNow() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Principais procedimentos de Cart√£o Clara no ServiceNow (Anexo II da Pol√≠tica)</b></p>' +

      '<p class="mt-2">' +
        'O Anexo II da pol√≠tica organiza os principais fluxos de chamado no <b>ServiceNow</b> para temas de cart√£o Clara.' +
        ' De forma resumida, os tipos mais importantes s√£o:' +
      '</p>' +

      '<ul class="list-disc ml-4 mt-2 space-y-1">' +
        '<li>' +
          '<b>Fraude / contesta√ß√£o de transa√ß√£o</b><br>' +
          'Usado quando h√° suspeita de fraude ou lan√ßamento indevido pelo estabelecimento.' +
          ' Normalmente exige anexar boletim de ocorr√™ncia ou evid√™ncias e detalhar data, valor e loja.' +
        '</li>' +

        '<li>' +
          '<b>Desbloqueio de cart√£o ap√≥s atraso de comprovantes</b><br>' +
          'Quando o cart√£o foi bloqueado porque a loja deixou de anexar nota/comprovante dentro do prazo.' +
          ' O chamado √© usado para comprovar que as pend√™ncias foram regularizadas e solicitar o desbloqueio.' +
        '</li>' +

        '<li>' +
          '<b>Ajuste excepcional de limite</b><br>' +
          'Para situa√ß√µes pontuais em que o limite padr√£o do cart√£o n√£o cobre uma demanda espec√≠fica' +
          ' (ex.: obra emergencial autorizada, a√ß√£o oficial maior). Sempre exige justificativa e aprova√ß√£o.' +
        '</li>' +

        '<li>' +
        '<b>Troca de Gerente (mudan√ßa entre lojas)</b><br>' +
        'Chamado usado quando um gerente que possui cart√£o Clara √© transferido de uma loja para outra.' +
        ' √â obrigat√≥rio informar a BU (ex.: Centauro, Fisia), a loja de origem, a loja de destino e a data efetiva da troca,' +
        ' para que o cart√£o fique vinculado corretamente √† nova unidade.' +
        ' O cart√£o f√≠sico deve acompanhar o gerente na mudan√ßa e continua sendo utilizado na nova loja ap√≥s o ajuste cadastral.' +
        ' Esse fluxo tamb√©m √© o caminho para formalizar trocas definitivas de respons√°vel, em conjunto com as orienta√ß√µes de afastamento/demiss√£o de gerente na pol√≠tica.' +
      '</li>' +

        '<li>' +
          '<b>Inser√ß√£o ou ajuste de etiqueta</b><br>' +
          'Chamado para incluir nova etiqueta na Clara ou ajustar etiqueta existente,' +
          ' quando um tipo de gasto recorrente n√£o se encaixa bem nas op√ß√µes atuais.' +
        '</li>' +

        '<li>' +
          '<b>Gasto indevido (pessoal) / ressarcimento</b><br>' +
          'Quando o cart√£o foi usado para despesa pessoal ou fora da pol√≠tica.' +
          ' O chamado registra o caso, a forma de ressarcimento e o acompanhamento pelo Financeiro.' +
        '</li>' +
      '</ul>' +

      '<p class="mt-3">' +
        'Eu n√£o abro o chamado por voc√™, mas te ajudo a escolher <b>qual tipo de solicita√ß√£o</b> faz sentido' +
        ' e a chegar com o texto certo no ServiceNow.' +
      '</p>' +

      '<p class="mt-2"><a href="https://sn.gruposbf.com.br/sp?id=sc_cat_item&sys_id=97ee1f9f8714e910d26c63d30cbb35f9" target="_blank" class="text-blue-600 underline">Clique aqui e acesse o ServiceNow para abertura de chamados.</a></p>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Estrutura baseada no Anexo II ‚Äì Solicita√ß√µes no ServiceNow da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.' +
        ' Sempre siga os caminhos e nomes exatos de categoria que estiverem atualizados no cat√°logo do ServiceNow.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}


    /* ========= ETIQUETA POR MENSAGEM ========= */

    function acharEtiquetaPorMensagem(msgNorm) {
        const stopTerms = [
            "etiqueta","qual etiqueta","que etiqueta","categoria","qual categoria",
            "classificacao","classifica√ß√£o","tag","pode usar","posso usar",
            "posso comprar","pode comprar","cartao","cart√£o","cartao clara",
            "cart√£o clara","clara","limite","ajuda","duvida","d√∫vida"
        ].map(normalize);

        const palavras = msgNorm.split(/\s+/);

        let melhorMatch = null;
        let melhorForca = 0;

        for (const et of etiquetasOficiais) {
            let forcaAtual = 0;

            for (const termoOriginal of et.palavrasChave) {
                const termoNorm = normalize(termoOriginal);
                if (stopTerms.includes(termoNorm)) continue;

                if (palavras.includes(termoNorm)) {
                    forcaAtual += 2;
                }
                if (msgNorm.includes(termoNorm)) {
                    forcaAtual += 1;
                }
            }

            if (forcaAtual > melhorForca) {
                melhorForca = forcaAtual;
                melhorMatch = et;
            }
        }

        if (melhorForca === 0) return null;
        return melhorMatch;
    }

                /* ========= AVALIA√á√ÉO DE COMPRA ========= */

    const gruposProibidos = {
        eletrodomesticos: [
            "geladeira", "microondas", "micro-ondas", "friogrifico", "freezer", "frigobar", "Geladeira",
            "Refrigerador", "Fog√£o", "Cooktop", "Forno", "M√°quina de Lavar Lou√ßas", "Coifa", "Depurador",
            "Purificador de √Ågua", "M√°quina de Lavar Roupas", "Secadora de Roupas", "Centr√≠fuga", "secadora",
            "secadora de lou√ßas", "lavadora", "lava-roupas", "lava e seca", "lava-lou√ßas", "exaustor", "purificador",
            "bebedouro", "forno-microondas"
        ].map(normalize),

        eletroportateis: [
            "Liquidificador", "Batedeira", "Processador de Alimentos", "Mixer", "Air Fryer", "airfryer", "airfrier",
            "Panela El√©trica", "M√°quina de P√£o", "M√°quina de Waffle", "Cafeteira", "Chaleira", "Extrator de Suco",
            "Torradeira", "Sanduicheira", "Pipoqueira El√©trica", "Abridor de Lata El√©trico", "Abridor de Vinho El√©trico",
            "ferro", "ferro de passar", "Ferro de Passar Roupa", "M√°quina de Costura", "Aspirador de P√≥",
            "Lavadora de Jato de √Ågua", "Limpadora a Vapor", "Secador de Cabelo", "Chapinha", "Prancha",
            "Barbeador El√©trico", "barbeador", "Escova de Dente El√©trica", "escova de dente", "vaporizador"
        ].map(normalize),

        climatizacao: [
            "compressor", "ventilador", "ar condicionado", "ar-condicionado", "Ventilador", "Aquecedor El√©trico",
            "Desumidificador", "compressor de ar", "aquecedor", "climatizador"
        ].map(normalize),

        moveisUtensiliosCasa: [
            "mesa", "cadeira", "sof√°", "poltrona", "arm√°rio", "c√¥moda", "estante", "tapete", "persiana", "lustre",
            "aquario", "aquarios", "churraqueira", "carv√£o", "churrasco", "cadeira de balan√ßo", "carrinho de beb√™"
        ].map(normalize),

        eletronicos: [
            "tv", "controle de tv", "controle remoto", "televisao", "televis√£o", "home theater", "hometheater", "som ambiente", "caixa de som grande", "caixa de som", "soundbar", "Celulares", "celular", "Smartphones", "Tablets", "Computadores", "computador", "notebook", "Monitores", "Impressoras", "Scanners", "Roteadores", "Modems", "HD", "SSD", "Calculadoras",
            "Televisores", "calculadora", "Aparelhos de Som", "Caixas de Som", "Fones de Ouvido", "Reprodutores de M√≠dia",
            "dvd", "C√¢meras Fotogr√°ficas Digitais", "C√¢meras de V√≠deo", "C√¢meras de Seguran√ßa", "C√¢meras de Monitoramento",
            "Smartwatches", "Pulseiras Fitness", "Controles Remotos", "Carregadores Port√°teis", "Power Bank", "powerbank",
            "power bank", "Lanterna El√©trica", "lanterna", "rel√≥gio", "relogios", "rel√≥gios", "projetor", "telao",
            "tel√£o", "tela gigante", "drone", "GoPro", "c√¢mera de a√ß√£o", "gimbal", "tablet", "smartwatch",
            "oculos", "√≥culos", "gps"
        ].map(normalize),

        games: [
            "ps5", "xbox", "x-box", "PS5", "ps4", "playstation", "video game", "videogame", "jogos de videogame",
            "jogo de video game", "jogos de video game", "Consoles de Videogame", "game pass", "ps plus",
            "xbox live", "recarga de jogo", "moeda de jogo", "skin de jogo", "pacote de expans√£o", "jogo digital",
            "joguinho", "e-sports", "jogos online", "software de entretenimento", "ingresso virtual"
        ].map(normalize),

        veiculos: [
            "avi√£o", "caminh√£o", "carro", "veiculo", "ve√≠culo", "moto", "ferrari", "lamborghini", "bicicleta", "lancha",
            "iate", "jet ski", "barco", "trem", "√¥nibus", "trator", "m√°quina agr√≠cola", "patinete el√©trico", "patinete",
            "hoverboard", "caminhonete", "aviao", "avi√µes"
        ].map(normalize),

        instrumentosMusicais: [
            "viol√£o", "violao", "viol√µes", "guitarra", "baixo", "violino", "viola", "violoncelo", "contrabaixo", "harpa",
            "bandolim", "cavaquinho", "ukulele", "banjo", "cravo", "piano", "teclado", "sintetizador", "√≥rg√£o",
            "flauta", "flautim", "clarinete", "saxofone", "obo√©", "fagote", "trompete", "trombone", "tuba", "trompa",
            "harm√¥nica", "gaita", "acorde√£o", "escaleta", "bateria", "tambor", "caixa", "surdo", "pandeiro", "tri√¢ngulo",
            "prato", "chimbal", "bumbo", "t√≠mpano", "xilofone", "marimba", "vibrafone", "glockenspiel", "sinos",
            "caxixi", "agog√¥", "reco-reco", "cu√≠ca", "berimbau", "atabaque", "conga", "bong√¥", "maraca", "castanhola",
            "tamborim", "adufe", "tarol", "repique", "tam-tam", "djembe", "rabeca", "ala√∫de", "balalaica",
            "sitar", "koto", "shamisen", "didgeridoo", "ocarina", "euf√¥nio", "sousafone", "celesta", "theremin", "sampler",
            "sequenciador", "messing", "harpsichord", "clavic√≥rdio", "dulcimer", "rabeca chuleira", "gaita de fole",
            "violino popular", "xilarm√≥nico", "bombardino", "violone", "fliscorne", "clarim", "daxofone", "estradiv√°rio",
            "figle", "museta", "oficleide", "takuapu", "matraca", "c√≠mbalo", "gongo", "prato de bateria", "guitar"
        ].map(normalize),

        ferramentas: [
            "furadeira", "parafusadeira", "serra el√©trica", "compressor de ar"
        ].map(normalize),

        animais: [
            "animais", "vaca", "mam√≠fero", "mam√≠feros", "ave", "aves", "p√°ssaro", "p√°ssaros", "inseto", "insetos", "peixe",
            "peixes", "r√©ptil", "r√©pteis", "anf√≠bio", "anf√≠bios", "vertebrado", "vertebrados", "invertebrado", "invertebrados",
            "felino", "felinos", "can√≠deo", "can√≠deos", "roedor", "roedores", "primata", "primatas", "cerval", "cervais",
            "equino", "equinos", "bovino", "bovinos", "su√≠no", "su√≠nos", "ovino", "ovinos", "caprino", "caprinos", "c√£o",
            "cachorro", "gato", "le√£o", "tigre", "on√ßa", "lobo", "raposa", "urso", "elefante", "rinoceronte", "hipop√≥tamo",
            "girafa", "zebra", "macaco", "chimpanz√©", "gorila", "orangotango", "morcego", "coelho", "lebre", "esquilo",
            "rato", "camundongo", "capivara", "porco-espinho", "tatu", "tamandu√°", "pregui√ßa", "baleia", "golfinho",
            "tubar√£o", "peixe-boi", "foca", "le√£o-marinho", "sapo", "r√£", "perereca", "cobra-cega", "salamandra",
            "crocodilo", "jacar√©", "tartaruga", "c√°gado", "jabuti", "lagarto", "camale√£o", "cobra", "serpente",
            "papagaio", "arara", "tucano", "coruja", "√°guia", "falc√£o", "pardal", "can√°rio", "pintassilgo", "beija-flor",
            "gaivota", "pinguim", "avestruz", "ema", "pato", "ganso", "cisne", "galinha", "peru", "codorna", "mosquito",
            "mosca", "formiga", "abelha", "vespa", "borboleta", "mariposa", "besouro", "joaninha", "lib√©lula", "gafanhoto",
            "barata", "aranha", "escorpi√£o", "carrapato", "siri", "caranguejo", "lagosta", "camar√£o", "polvo", "lula",
            "estrela-do-mar", "ouri√ßo-do-mar", "√°gua-viva", "medusa", "coral", "an√™mona", "esponja-do-mar", "caracol",
            "lesma", "ostra", "mexilh√£o", "verme", "minhoca", "sanguessuga", "centopeia", "lacraia", "peixe-palha√ßo",
            "dourado", "salm√£o", "til√°pia", "bacalhau", "sardinha", "atum", "enguia", "arraia", "cavalo-marinho",
            "sapo-boi", "r√£-touro", "hiena", "chacal", "p√≠ton", "jib√≥ia", "iguana", "gecko", "periquito", "andorinha",
            "grilo", "pulga", "√°caro", "cachorros", "gatos", "c√£es", "ra√ß√£o", "ra√ß√µes"
        ].map(normalize),

        armasGuerra: [
            "tanque", "tanque de guerra", "guerra", "metranca", "metralhadora", "bomba", "C4", "nuclear", "fuzil",
            "fuzil de assalto", "fuzil semiautom√°tico", "fuzil de precis√£o", "rifle", "carabina", "submetralhadora",
            "metralhadora pesada", "metralhadora leve", "pistola", "rev√≥lver", "espingarda", "muni√ß√£o", "muni√ß√µes",
            "cartucho", "bala", "proj√©til", "granada", "morteiro", "m√≠ssil", "m√≠sseis", "bazuca", "lan√ßa-foguetes",
            "canh√£o", "obuseiro", "torpedo", "mina terrestre", "arma qu√≠mica", "arma biol√≥gica", "arma nuclear",
            "faca t√°tica", "baioneta", "faca de combate", "machado t√°tico", "silenciador", "supressor",
            "colete bal√≠stico", "colete a prova de balas", "capacete militar", "capacete t√°tico", "m√°scara de g√°s",
            "g√°s lacrimog√™neo", "c√¢mera de vis√£o noturna", "√≥culos t√°tico", "luva t√°tica", "botas militares",
            "coturno", "farda", "uniforme camuflado", "roupa t√°tica", "coldre", "porta carregador", "bolso modular",
            "cinto t√°tico", "joelheira t√°tica", "cotoveleira t√°tica", "placa bal√≠stica", "placas bal√≠sticas", "bandoleira",
            "blindado", "carro de combate", "ve√≠culo blindado", "lan√ßa m√≠sseis", "porta-avi√µes", "navio de guerra",
            "submarino", "drone militar", "ve√≠culo a√©reo n√£o tripulado", "aeronave de ca√ßa", "jato de ca√ßa",
            "bombardeiro", "avi√£o militar", "helic√≥ptero militar", "caminh√£o militar", "jeep militar", "helicopero",
            "mochila militar", "mochila t√°tica", "kit primeiros socorros t√°tico", "kit sobreviv√™ncia", "cantil",
            "cantil militar", "saco de dormir militar", "bin√≥culo", "tel√™metro", "b√∫ssola", "gps t√°tico",
            "lanterna t√°tica", "apito t√°tico", "marmita militar", "pazinha de trincheira", "B2", "bunker", "missel",
            "armas"
        ].map(normalize),

        bensServicosAbstratos: [
            "diamante", "ouro", "prata", "joia", "bracelete", "colar", "quadro", "escultura", "pintura", "a√ß√µes",
            "criptomoeda", "t√≠tulos", "bonds", "consulta m√©dica", "terapia", "psic√≥logo", "exames", "tratamentos",
            "cirurgia", "plano de sa√∫de", "curso", "faculdade", "mentoria", "aluguel", "imposto", "multa", "reforma",
            "manuten√ß√£o", "limpeza", "seguro", "doa√ß√£o", "gorjeta", "champanhe", "champagne", "viagem", "piscina",
            "piso", "porcelanato", "tijolo", "bloco", "universo", "planeta", "sol", "furacao", "aeroporto", "lua",
            "parque de divers√£o", "cinema", "parque", "ingresso", "ingressos", "teatro", "museu", "exposi√ß√£o",
            "espet√°culo", "circense", "√≥pera", "concerto", "bal√©", "excurs√£o", "tour guiado", "passeio", "visita guiada",
            "galeria de arte", "livro", "livros", "revista", "revistas", "e-book", "cd", "dvd", "vinil", "curso de arte",
            "curso de m√∫sica", "curso de dan√ßa", "assinatura", "streaming", "streaming de v√≠deo", "streaming de √°udio",
            "netflix", "spotify", "disney+", "globoplay", "prime video", "youtube premium", "youtube", "deezer", "tidal",
            "hbo max", "telecine play", "bilhete de trem", "bilhete de √¥nibus", "passagem a√©rea", "hotel", "aula de teatro",
            "aluguel de carro", "praia", "camping", "pesca", "ca√ßa", "boliche", "patina√ß√£o", "escalada", "kart",
            "paintball", "tirolesa", "rapel", "trilha", "academia", "yoga", "pilates", "crossfit", "luta", "massagem",
            "spa", "sauna", "day spa", "clube de campo", "mensalidade clube", "rod√≠zio", "buffet", "restaurante",
            "bar", "cafeteria", "fast food", "pacote de viagem", "lazer", "entretenimento", "recrea√ß√£o", "hobbies",
            "compra com milhas", "cart√£o presente", "gift card", "cr√©dito em plataforma", "recarga de celular",
            "compra de pontos", "programa de pontos", "sorteio", "rifa", "pr√©dio", "casa", "apartamento",
            "previd√™ncia privada", "previd√™ncia", "plano de previd√™ncia", "cdi", "cdb", "certificado de dep√≥sito banc√°rio",
            "lci", "lca", "letra de cr√©dito imobili√°rio", "letra de cr√©dito do agroneg√≥cio", "t√≠tulos de renda fixa",
            "fundos de investimento", "cotas de fundos", "lci 180 dias", "investimento via cart√£o", "aporte via cart√£o",
            "cashback investimento", "milhas para investimento", "compra de milhas", "criptomoedas",
            "token de investimento", "nucoin", "cashback", "cash back", "bitcoin", "milhas", "brinquedo", "brinquedos",
            "veneno", "mata inseto", "isca", "iscas", "cobasi", "arvore", "flores", "planta"
        ].map(normalize),

        restritos: [
            "drogas", "produtos falsificados", "material pornogr√°fico", "porno", "pornografia", "esp√©cies amea√ßadas",
            "rem√©dios controlados", "produtos de tabaco", "cigarro", "charuto", "muni√ß√£o", "prostituta", "puta",
            "programa", "night", "sexo", "transar", "camisinha", "vibrador", "KY", "chupeta"
        ].map(normalize),

        inteligenciaArtificial: [
            "ChatGPT", "GPT-3", "GPT-4", "GPT-4o", "GPT", "Gemini", "Google Gemini", "Gemini Pro", "Gemini Ultra",
            "Microsoft Copilot", "Copilot", "Claude", "Claude 3", "Claude 3 Opus", "Claude 3 Sonnet", "Claude 3 Haiku",
            "Llama", "Llama 2", "Llama 3", "Mistral", "Grok", "AlphaGo", "IBM Watson", "Watson", "TensorFlow", "PyTorch",
            "Keras", "Azure AI", "Azure Machine Learning", "Google Cloud AI", "Vertex AI", "Amazon SageMaker", "DALL-E",
            "DALL-E 2", "DALL-E 3", "Midjourney", "Stable Diffusion", "Stable Diffusion XL", "SDXL", "Code Llama", "Whisper",
            "Jasper", "Jasper AI", "Copy AI", "Beautiful AI", "Grammarly", "Synthesia", "Picsart AI", "Otter AI",
            "Tesla Autopilot", "ClickUp Brain", "H2O.ai", "Scikit-learn", "OpenAI Gym", "Tabnine", "GitHub Copilot",
            "Perplexity", "Duck AI", "Siri", "Alexa", "Meta AI", "NotebookLM", "WordAI", "DeepBrain AI", "Salesforce Einstein",
            "Fireflies", "Pictory", "Speechify", "Poised", "You.com", "Andi", "Chatfuel", "Dialogflow", "Cursor",
            "Mya Systems", "Olivia by Paradox", "SeekOut", "SAP S/4HANA AI", "Breeze by HubSpot", "sap", "github", "excel",
            "word", "text-pad", "textpad"
        ].map(normalize),

        utensiliosCozinha: [
            "garfo", "faca", "colher", "colher de sopa", "colher de ch√°", "colher de sobremesa", "faca de serra",
            "faca de p√£o", "faca de carne", "esp√°tula", "concha", "escumadeira", "fouet", "batedor de ovos",
            "abridor de lata", "abridor de garrafa", "saca-rolhas", "ralador", "descascador", "peneira",
            "espremedor de alho", "cortador de pizza", "tesoura de cozinha", "pegador de macarr√£o",
            "pegador de salada", "t√°bua de corte", "pirex", "travessa", "assadeira", "forma de bolo",
            "frigideira", "panela", "ca√ßarola", "leiteira", "cuscuzeiro", "chaleira", "bule", "x√≠cara",
            "copo", "ta√ßa", "prato", "pires", "saladeira", "tigela", "bowl"
        ].map(normalize)

    };

    const mensagensBrincadeiraPorGrupo = {
        eletrodomesticos: "Interior de loja n√£o √© cozinha planejada, n√©? üòÖ",
        eletroportateis: "Vai montar uma cozinha gourmet a√≠ na loja? üòÇ",
        climatizacao: "Climatizar a loja √© importante, mas isso entra como patrim√¥nio, n√£o no cart√£o da Clara üòâ",
        moveisUtensiliosCasa: "Parece mais compra de mob√≠lia do que despesa do dia a dia da loja üò¨",
        eletronicos: "Isso a√≠ t√° com mais cara de patrim√¥nio do que de gasto operacional‚Ä¶ üì∫",
        games: "Montar lan house com cart√£o da loja n√£o vai rolar, hein üéÆüòÑ",
        veiculos: "Cart√£o Clara n√£o √© financiamento de concession√°ria e nem tem limite infinito, hein! üöóüí≥",
        instrumentosMusicais: "Vai montar uma banda a√≠ na loja? üé∏üòÑ",
        ferramentas: "Vai montar uma oficina? üò•",
        animais: "Nossa, n√£o sabia que voc√™ tava montando um zool√≥gico na loja ü§£",
        armasGuerra: "Calma l√°, Rambo‚Ä¶ o cart√£o √© pra opera√ß√£o da loja, n√£o pra guerra ‚öîÔ∏èüòÇ",
        bensServicosAbstratos: "Isso tem bem mais cara de investimento/lazer/servi√ßo pessoal do que despesa da loja. T√° estressado e quer relaxar, n√©? üòÖ",
        restritos: "Esse tipo de item √© proibido de qualquer jeito, dentro ou fora da pol√≠tica da Clara üò∂‚Äçüå´Ô∏è",
        inteligenciaArtificial: "Nem as IAs escapam da pol√≠tica do cart√£o corporativo, viu? ü§ñüö´",
        utensiliosCozinha: "MasterChef que habita em voc√™ n√£o √© o mesmo que habita na Clara üßëüèº‚Äçüç≥"
    };

      function avaliarCompraEspecifica(msgNorm) {
    if (!msgNorm) {
        return { pode: null, resposta: "" };
    }

    const baseMsg = `Esse tipo de item <b>N√ÉO</b> pode ser comprado/utilizado com o cart√£o.<br>
        Ele deve seguir o processo de requisi√ß√£o junto √† √°rea de Compras (se for relevante e apto de acordo com o neg√≥cio e estiver dentro da pol√≠tica da √°rea), com aprova√ß√£o formal, n√£o o cart√£o da loja.`;

    // 0) S√ì entro nessa fun√ß√£o se a frase tiver cara de COMPRA / USO DO CART√ÉO
    const falaDeCompraOuUso =
        msgNorm.includes("comprar") ||
        msgNorm.includes("comprei") ||
        msgNorm.includes("comprou") ||
        msgNorm.includes("compra ") ||
        msgNorm.includes("vou comprar") ||
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("pagar") ||
        msgNorm.includes("paguei") ||
        msgNorm.includes("pagou") ||
        msgNorm.includes("passei no cartao") ||
        msgNorm.includes("passei no cart√£o") ||
        msgNorm.includes("passar no cartao") ||
        msgNorm.includes("passar no cart√£o") ||
        msgNorm.includes("usei o cartao") ||
        msgNorm.includes("usei o cart√£o") ||
        msgNorm.includes("usar o cartao") ||
        msgNorm.includes("usar o cart√£o") ||
        msgNorm.includes("cartao clara") ||
        msgNorm.includes("cart√£o clara");

    // Se n√£o tem nenhum verbo de compra/uso, N√ÉO for√ßo uma decis√£o aqui
    if (!falaDeCompraOuUso) {
        return { pode: null, resposta: "" };
    }

    // 1) Checa os GRUPOS de proibidos primeiro
    for (const [grupo, palavras] of Object.entries(gruposProibidos)) {
        for (const palavra of palavras) {
            const regex = new RegExp(`\\b${palavra}\\b`, "i");
            if (regex.test(msgNorm)) {
                const intro = mensagensBrincadeiraPorGrupo[grupo] || "‚õî N√£o pode usar o cart√£o Clara pra isso.";
                const respostaFinal = `${intro}<br><br>${baseMsg}`;

                return {
                    pode: false,
                    resposta: respostaFinal
                };
            }
        }
    }

    // 2) Casos espec√≠ficos de PROIBIDOS (alimenta√ß√£o pessoal, √°lcool, transporte pessoal)
    const pessoalAlim = [
        "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
        "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
        "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
        "paguei minha comida","paguei minha janta",
        "meu almo√ßo","meu almoco","meu jantar","minha janta",
        "meu lanche","minha comida","almoco pessoal","almo√ßo pessoal",
        "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
        "almocei com o cartao","almocei com o cart√£o",
        "jantei com o cartao","jantei com o cart√£o",
        "comi com o cartao","comi com o cart√£o"
    ].map(normalize);

    for (const termo of pessoalAlim) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja. Se j√° foi pago com o cart√£o, precisa sinalizar como "Despesa Pessoal ‚Äì Uso Indevido", enccaminhar chamado via Servicenow: <b>Contas a Receber > Cart√£o Clara > Gasto Indevido (pessoal)</b>. O financeiro ir√° informar como proceder com o ressarcimento do valor.`
            };
        }
    }

    const alcool = [
        "cerveja","vodka", "gin", "tequila", "rum", "saque", "espumante", "conhaque", "51", "sidra", "brandy",
        "hidromel", "absinto", "champagne", "menta", "bitter", "vermute", "prosecco", "vinho do porto",
        "xerez", "marsala", "grappa", "pisco", "mezcal", "calvados", "amaretto", "ouzo", "j√§germeister",
        "soju", "arac", "baijiu", "vinho","whisky","whiskey","cacha√ßa", "licor", "cachaca","Skol", "Brahma",
        "Heineken", "Corona Extra", "Budweiser", "Bud Light", "Stella Artois", "stella", "itaipava",
        "devassa", "Guinness", "Smirnoff", "Absolut", "C√Æroc", "Grey Goose", "Belvedere",
        "Tito's Handmade Vodka", "Skyy", "Orloff", "Johnnie Walker", "Jack Daniel's", "Jameson",
        "Chivas Regal", "Jim Beam", "Ballantine's", "Grant's", "Macallan", "Glenfiddich", "Bulleit",
        "Baileys", "Licor 43", "Amarula", "Campari", "Aperol", "blue label", "gold label","black label",
        "green label"
    ].map(normalize);

    for (const termo of alcool) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Bebida alco√≥lica n√£o √© permitida no cart√£o Clara. Isso n√£o √© considerado despesa operacional autorizada.`
            };
        }
    }

    const transportePessoal = ["uber"," 99","taxi","t√°xi","tax√≠","cabify"].map(normalize);
    for (const termo of transportePessoal) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Uber / 99 / t√°xi para deslocamento pessoal n√£o pode no cart√£o Clara. N√£o √© gasto operacional direto da loja.`
            };
        }
    }

        // 2c) Estacionamento (n√£o autorizado no cart√£o Clara)
    const estacionamento = [
        "estacionamento",
        "pagar estacionamento",
        "paguei estacionamento",
        "ticket de estacionamento",
        "tiket de estacionamento",
        "ticket do estacionamento",
        "tal√£o de estacionamento",
        "talonario de estacionamento",
        "estacionamento do shopping",
        "estacionei o carro",
        "pagar o parking",
        "ticket parking"
    ].map(normalize);

    for (const termo of estacionamento) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Gasto com <b>estacionamento</b> n√£o √© permitido no cart√£o Clara.<br>
                Esse tipo de despesa n√£o √© tratado como gasto operacional direto da loja e n√£o deve ser pago com o cart√£o corporativo.<br>
                Se o cart√£o j√° foi utilizado para estacionamento, trate o valor como <b>uso indevido</b> e siga as orienta√ß√µes de ressarcimento com o time de Contas a Receber / Financeiro.`
            };
        }
    }

    // 3) Casos espec√≠ficos PERMITIDOS (lanche time, perif√©ricos, servi√ßos emergenciais)
    const palavrasTime = [
        "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
        "lanche time","lanche pro time","lanche para o time",
        "treinamento","premiacao","premia√ß√£o","acao oficial","a√ß√£o oficial",
        "acao vm","a√ß√£o vm","acao regional","a√ß√£o regional",
        "agua pra equipe","√°gua pra equipe","gal√£o de agua","galao de agua","gal√£o de √°gua",
        "salgadinho pra treinamento","bolo pra treinamento",
        "suco pra treinamento","suco para treinamento","lanche treinamento"
    ].map(normalize);

    for (const termo of palavrasTime) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "LANCHES DE REFEI√á√ïES / AGUA POT√ÅVEL",
                    desc: "Coffee break autorizado, √°gua/lanche para equipe em treinamento interno aprovado, a√ß√£o oficial da loja (VM, regional, diretoria) ou premia√ß√£o operacional.",
                    exemploDescricao: "Coffee break treinamento VM loja 1234"
                },
                resposta: `Pode usar o cart√£o Clara se for a√ß√£o autorizada (treinamento interno, VM, regional, diretoria, premia√ß√£o operacional). Precisa lan√ßar na Clara em at√© 48h com nota fiscal, etiqueta correta e descri√ß√£o objetiva.`
            };
        }
    }

    const perifOperacional = [
        "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
        "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa",
        "bobina ecf","bobina fiscal"
    ].map(normalize);

    for (const termo of perifOperacional) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "MATERIAL DE INFORM√ÅTICA",
                    desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                    exemploDescricao: "Teclado PDV loja 1234"
                },
                resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) √© considerado suprimento operacional de baixo valor para a loja e pode ser pago no cart√£o Clara, desde que classificado corretamente e lan√ßado em at√© 48h.`
            };
        }
    }

    const servicoEmerg = [
        "chaveiro","abrir cofre","abrir estoque","perdi a chave",
        "motoboy","sedex","correios","envio de documento","postar documento",
        "mandar documento","enviar documento"
    ].map(normalize);

    for (const termo of servicoEmerg) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "TRANSPORTE SERVI√áOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                    desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                    exemploDescricao: "Motoboy urgente documenta√ß√£o loja 1234"
                },
                resposta: `Servi√ßos emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cart√£o Clara, desde que sejam necessidade imediata da opera√ß√£o e sejam justificados na Clara dentro de 48h.`
            };
        }
    }

    // 4) Se n√£o casou em nada, deixa para a resposta gen√©rica / pol√≠tica
    return { pode: null, resposta: "" };
}

    /* ========= RESPOSTAS ========= */


    function respostaForaEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
    }

    function respEtiquetaDireta(et) {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Etiqueta identificada: ${et.nome}</b></p>
    <p class="mt-2">${et.descricao || "Essa etiqueta √© usada para classificar despesas relacionadas a este tipo de gasto na opera√ß√£o da loja."}</p>

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p>Se voc√™ identificar que essa etiqueta n√£o representa corretamente o tipo de compra ou est√° gerando confus√£o recorrente no uso, a orienta√ß√£o √© solicitar ajuste formal.</p>
        <p class="mt-2">Abra um chamado no ServiceNow do tipo <b>Inser√ß√£o ou ajuste de etiqueta ‚Äì Cart√£o Clara</b>, explicando o problema encontrado, como a etiqueta √© usada hoje e qual seria o cen√°rio ideal.</p>
        <p class="mt-2">Evite adaptar etiquetas por conveni√™ncia, pois isso afeta indicadores financeiros, auditorias e controles internos.</p>
        <p class="mt-3 text-xs text-slate-500">Orienta√ß√£o alinhada ao Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.</p>
      </div>
    </details>
  </div>`;
}

    function respLimite() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Limite do cart√£o Clara nas lojas</b></p>
    <p class="mt-2">O limite do cart√£o Clara √© definido para cobrir os gastos previstos do ciclo de fatura (de 06 at√© 05 do m√™s seguinte), considerando o padr√£o de despesas operacionais da loja.</p>
    <p class="mt-2">O limite √© reestabelecido por completo sempre no dia 06 de cada m√™s.</p>
    <p class="mt-2">Para visualizar o limite, ali na parte do menu de <b>A√ßoes</b>, arraste pro lado e vai em <b>Ajustar limite</b>. L√° vai aparecer de forma mais simples o valor atual do limite, de forma integral.</p>
    <p class="mt-2">Planeje as compras para n√£o estourar o limite logo no in√≠cio do ciclo, priorize gastos essenciais e evite despesas de alto valor.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p><b>Ajuste excepcional de limite:</b></p>
        <p>Quando o limite que foi estabelecido n√£o √© suficiente para uma situa√ß√£o pontual (como algo emergencial ou a√ß√£o oficial maior j√° autorizada), n√£o √© para ‚Äúfor√ßar‚Äù o uso do cart√£o a qualquer custo.</p>
        <p class="mt-2">Nesses casos, alinhe previamente com a regional ou √°rea respons√°vel, organize a justificativa e ent√£o abra chamado no ServiceNow do tipo <b>Ajuste excepcional de limite ‚Äì Cart√£o Clara</b>, informando loja, BU, limite atual, limite solicitado, per√≠odo e motivo detalhado.</p>
        <p class="mt-2">Pedidos sem justificativa aderente √† pol√≠tica ou sem alinhamento com a lideran√ßa podem ser negados, mesmo que existam demandas locais.</p>
        <p class="mt-3 text-xs text-slate-500">Orienta√ß√£o alinhada √† Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. Limite n√£o √© ferramenta para cobrir qualquer gasto, mas sim o que √© essencial para a opera√ß√£o dentro da pol√≠tica.</p>
      </div>
    </details>
  </div>`;
}

    function respBloqueio() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Bloqueio de cart√£o Clara (preventivo ou por pend√™ncias)</b></p>
    <p class="mt-2">O cart√£o Clara pode ser bloqueado preventivamente principalmente por pend√™ncias de comprovantes (nota, etiqueta ou descri√ß√£o fora do prazo) ou por uso fora da pol√≠tica que exige an√°lise do Financeiro.</p>
    <p class="mt-2">Antes de qualquer coisa, entre na Clara e verifique se existem transa√ß√µes pendentes ou compras fora do padr√£o que possam ter motivado o bloqueio.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p><b>Passos b√°sicos quando o cart√£o est√° bloqueado:</b></p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Regularize todas as transa√ß√µes pendentes na Clara com nota, comprovante, etiqueta correta e descri√ß√£o clara;</li>
          <li>Cheque se n√£o h√° compras claramente fora da pol√≠tica que precisem ser corrigidas ou ressarcidas;</li>
          <li>Evite tentar insistir em novas compras enquanto o motivo do bloqueio n√£o estiver claro.</li>
        </ul>
        <p class="mt-3"><b>Quando o bloqueio estiver ligado √† presta√ß√£o de contas ou pend√™ncias j√° regularizadas:</b></p>
        <p>Se voc√™ j√° resolveu todas as pend√™ncias na Clara e o cart√£o continua bloqueado, a orienta√ß√£o √© abrir chamado no ServiceNow do tipo <b>Desbloqueio de cart√£o Clara por pend√™ncias / bloqueio preventivo</b>.</p>
        <p class="mt-2">No chamado, informe loja, BU, c√≥digo do cart√£o e nome do respons√°vel, al√©m de quais pend√™ncias foram regularizadas (faturas e per√≠odo) e, se solicitado, anexos ou prints que comprovem a regulariza√ß√£o.</p>
        <p class="mt-3 text-xs text-slate-500">Fluxo alinhado √† Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara e aos procedimentos de bloqueio/desbloqueio via ServiceNow. Em situa√ß√µes fora do padr√£o, consulte o Financeiro antes de tentar liberar novas compras.</p>
      </div>
    </details>
  </div>`;
}

                // üîπ NOVA RESPOSTA ‚Äì transa√ß√£o negada / categoria bloqueada
                function respTransacaoNegadaCategoria() {
                    return `HTML:<div class="text-sm text-slate-700">
            <p>Algumas compras podem ser <b>negadas</b> mesmo com limite dispon√≠vel e cart√£o ativo (<i>√â importante que voc√™ verifique que seu cart√£o n√£o est√° bloqueado</i>), porque a <b>categoria do estabelecimento</b> (MCC) est√° bloqueada pela pol√≠tica de uso dos cart√µes Clara.

            <p class="mt-2">Nesses casos, siga estes passos:
            <ol class="list-decimal ml-4 mt-1">
            <li>Verifique no app/plataforma da Clara o motivo da recusa e a categoria da compra (MCC);</li>
            <li>Se a despesa for necess√°ria para a opera√ß√£o da loja, abra um chamado no <b>ServiceNow</b> em:<br/>
            <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Libera√ß√£o de Categoria para Compra</b>;</li>
            <li>Explique o contexto da compra, qual tipo de servi√ßo/produto precisa ser liberado e se a libera√ß√£o √© pontual ou recorrente.</li>

            <p class="mt-2">Depois da libera√ß√£o pelo Financeiro no ServiceNow, voc√™ pode tentar a compra novamente com o cart√£o Clara.</p>
            </div>`;
                }

              function respPoliticaOficial() {
        return `HTML:<div class="text-sm text-slate-700">
          <p>Este documento cont√©m as diretrizes e padr√µes oficiais de refer√™ncia da Companhia. Ele deve ser consultado e seguido como a fonte de autoridade final para todos os assuntos que lhe s√£o pertinentes.
          <a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
          <strong>Pol√≠tica de Uso dos Cart√µes Clara (documento oficial).</strong>
          </a>
          <p>O n√£o cumprimento das disposi√ß√µes aqui estabelecidas sujeitar√° o infrator √†s medidas disciplinares e legais cab√≠veis.</p>
          </div>`;
              }

    function respCatalogoEtiquetas() {
  // Monta lista de etiquetas oficiais da pol√≠tica (etiquetasOficiais vem do politica_dados)
  let listaEtiquetasHtml = "";

  if (Array.isArray(etiquetasOficiais) && etiquetasOficiais.length) {
    listaEtiquetasHtml =
      `<div class="mt-3">
        <p class="mt-2"><b>Etiquetas oficiais dispon√≠veis hoje na Clara</b></p>
        <ul class="list-disc ml-4 mt-1 space-y-1">
          ${
            etiquetasOficiais
              .map(function (et) {
                const nome = et.nome || "";
                const desc = et.descricao || "";
                const obs  = et.observacaoUso || "";

                let li = `<li><b>${nome}</b>`;
                if (desc) {
                  li += ` ‚Äì ${desc}`;
                }
                if (obs) {
                  li += ` <span class="text-xs text-slate-500">(${obs})</span>`;
                }
                li += `</li>`;
                return li;
              })
              .join("")
          }
        </ul>
        <p class="mt-2 text-xs text-slate-500">
          Lista baseada no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara e alinhada ao cat√°logo oficial de etiquetas.
      </div>`;
  }

  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Etiquetas na Clara</b></p>
    <p class="mt-2">
      As etiquetas servem para classificar corretamente cada gasto feito com o cart√£o Clara e facilitar o controle financeiro e a presta√ß√£o de contas.
    <p class="mt-2">
      Sempre escolha a etiqueta que mais represente o tipo real de despesa, evitando classificar tudo em categorias gen√©ricas.

    ${listaEtiquetasHtml}

    <details class="mt-3">
      <summary class="cursor-pointer underline">
        Ver orienta√ß√£o completa no ServiceNow / pol√≠tica
      </summary>
      <div class="mt-2">
        <p>
          Se n√£o existir uma etiqueta adequada para o tipo de gasto recorrente da sua loja,
          n√£o improvise usando algo que n√£o represente a realidade da compra.
        </p>
        <p class="mt-2">
          Nesse caso, a orienta√ß√£o √© abrir chamado no ServiceNow do tipo
          <b>Inser√ß√£o ou ajuste de etiqueta ‚Äì Cart√£o Clara</b>, informando loja, BU,
          tipo de despesa, justificativa e exemplos de uso.
        </p>
        <p class="mt-2">
          O Financeiro avaliar√° a solicita√ß√£o e, se aprovado, criar√° ou ajustar√° a etiqueta
          no cat√°logo oficial da Clara.
        </p>
        <p class="mt-3 text-xs text-slate-500">
          Fluxo baseado no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.
          A escolha correta de etiquetas impacta diretamente indicadores e controles da companhia.
        </p>
      </div>
    </details>
  </div>`;
}

    function respPrestacaoContas() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Presta√ß√£o de contas na Clara (notas, comprovantes e justificativas)</b></p>
    <p class="mt-2">Toda compra feita com o cart√£o Clara precisa de <b>nota ou comprovante anexado</b>, <b>etiqueta correta</b> e <b>descri√ß√£o</b> dentro do prazo de 48 horas ap√≥s a compra, sen√£o vira pend√™ncia de presta√ß√£o de contas.</p>
    <p class="mt-2">Pend√™ncias em aberto podem levar a bloqueio preventivo do cart√£o at√© que a loja regularize as informa√ß√µes.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p><b>Quando faltar nota, tiver erro de comprovante ou um caso at√≠pico:</b></p>
        <p>Se a nota foi perdida, o fornecedor n√£o emitiu NF corretamente, ou existe alguma irregularidade que voc√™ n√£o consegue resolver apenas pela Clara, registre o m√°ximo poss√≠vel na descri√ß√£o e organize as evid√™ncias que tiver (pedido, or√ßamento, recibos, prints etc.).</p>
        <p class="mt-2">Nesses casos, a orienta√ß√£o √© abrir um chamado no ServiceNow de <b>Apoio √† presta√ß√£o de contas / regulariza√ß√£o de comprovantes ‚Äì Cart√£o Clara</b>.</p>
        <p class="mt-2">No chamado, informe loja, BU, dados da transa√ß√£o (data, valor, estabelecimento), print da tela da Clara se poss√≠vel e explique o que aconteceu (perda de nota, NF em CPF, NF recusada, erro do fornecedor etc.), al√©m da solu√ß√£o proposta.</p>
        <p class="mt-3 text-xs text-slate-500">Fluxo baseado no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. Pend√™ncias n√£o tratadas podem manter o cart√£o bloqueado ou gerar apontamentos para a loja.</p>
      </div>
    </details>
  </div>`;
}

    function respAlimentoTime() {
        return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respTransportePessoal() {
        return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja. O procedimento correto √© solicitar via aplicativo com a conta corporativa da empresa.<br/><br/>
Se j√° usou de forma pessoal (pagando do pr√≥prio bolso) e quer o reembolso:<br/>
‚Ä¢ Solicite o reembolso atrav√©s da plataforma Vexpenses (√© necess√°rio autoriza√ß√£o do seu gestor).<br/>
</p>`;
    }

function respTrocaGerente() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Quando o gerente √© afastado ou desligado, o que fazer com o cart√£o Clara?</b></p>' +

      '<p class="mt-2">' +
        'A pol√≠tica traz dois cen√°rios principais para lojas f√≠sicas:' +
      '</p>' +

      '<ol class="list-decimal ml-5 mt-2 space-y-2">' +
        '<li>' +
          '<b>Gerente em f√©rias ou afastamento tempor√°rio (licen√ßa, atestado etc.)</b><br>' +
          '<ul class="list-disc ml-4 mt-1">' +
            '<li>O cart√£o da loja continua sendo o <b>cart√£o da pr√≥pria loja</b>, n√£o de outra.</li>' +
            '<li>Durante o afastamento, um <b>l√≠der / supervisor</b> indicado pela regional assume a guarda e o uso operacional do cart√£o.</li>' +
            '<li>A loja n√£o deve usar o cart√£o de outra unidade s√≥ porque o gerente est√° afastado.</li>' +
          '</ul>' +
        '</li>' +

        '<li>' +
          '<b>Gerente desligado e ainda n√£o h√° novo gerente nomeado</b><br>' +
          '<ul class="list-disc ml-4 mt-1">' +
            '<li>O cart√£o do gerente desligado deve ser <b>bloqueado</b> e recolhido.</li>' +
            '<li>Em casos espec√≠ficos, a pol√≠tica permite uso <b>tempor√°rio</b> do cart√£o de outra loja, sempre com valida√ß√£o do Financeiro.</li>' +
            '<li>Quando isso acontecer, a <b>descri√ß√£o da transa√ß√£o</b> deve deixar claro qual loja est√° sendo atendida, por exemplo:<br>' +
              '<span class="italic">"Uso tempor√°rio do cart√£o da loja 0123 para despesas operacionais da loja 0456 ‚Äì gerente em transi√ß√£o"</span>.' +
            '</li>' +
            '<li>O respons√°vel pela presta√ß√£o de contas passa a ser o <b>gerente tempor√°rio / respons√°vel indicado</b> pela regional.</li>' +
          '</ul>' +
        '</li>' +
      '</ol>' +

      '<p class="mt-3">' +
        'Em qualquer cen√°rio de afastamento ou demiss√£o, a orienta√ß√£o √© sempre:' +
      '</p>' +
      '<ul class="list-disc ml-4 mt-1">' +
        '<li>Garantir que o cart√£o do gerente desligado seja recolhido e bloqueado;</li>' +
        '<li>Registrar na descri√ß√£o das compras qualquer uso tempor√°rio de cart√£o de outra loja;</li>' +
        '<li>Em caso de <b>f√©rias do gerente ou afastamento</b>, a loja deve abrir chamado no ServiceNow informando o per√≠odo e quem ficar√° respons√°vel pela guarda do cart√£o, para que o Financeiro acompanhe e, quando necess√°rio, fa√ßa o tratamento dos comprovantes em nome do respons√°vel tempor√°rio, caminho para abertura do chamado: <b>Contas a Receber > Cart√£o Clara > Solicita√ß√£o para anexar comprovantes</b>.</li>' +
        '<li><b>Importante:</b> O financeiro deve autorizar esse fluxo por email antes da loja encaminhar chamado.</li>' +
      '</ul>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Resumo baseado no item 8.4 e no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.' +
        ' Em caso de d√∫vida ou situa√ß√µes n√£o previstas, valide com o Financeiro.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

function respTrocaGerenteMudancaLojas() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Troca de gerente entre lojas com Cart√£o Clara</b></p>' +

      '<p class="mt-2">' +
        'Quando um gerente que possui um <b>cart√£o Clara</b> √© transferido de uma loja para outra, ' +
        'n√£o √© apenas uma aus√™ncia tempor√°ria: √© uma <b>mudan√ßa de unidade</b> que precisa ser refletida no cadastro do cart√£o.' +
      '</p>' +

      '<p class="mt-2">' +
        'Nesses casos, a orienta√ß√£o √© abrir no ServiceNow o tipo de chamado <b>"Troca de Gerente (mudan√ßa entre lojas)"</b>, ' +
        'informando obrigatoriamente:' +
      '</p>' +

      '<ul class="list-disc ml-4 mt-1">' +
        '<li><b>BU</b> (ex.: Centauro, Fisia);</li>' +
        '<li><b>Loja de origem</b> do gerente;</li>' +
        '<li><b>Loja de destino</b> para onde ele est√° sendo transferido;</li>' +
        '<li><b>Data efetiva da troca</b>, para ajustar o v√≠nculo do cart√£o no sistema.</li>' +
      '</ul>' +

      '<p class="mt-2">' +
        'O <b>cart√£o f√≠sico</b> deve acompanhar o gerente na mudan√ßa e passar a ser usado na nova loja, ' +
        'sempre ap√≥s o ajuste cadastral. O ponto cr√≠tico √© garantir que, no sistema, o cart√£o fique ' +
        'vinculado √† unidade correta, evitando despesas ‚Äúaparecendo‚Äù na loja errada.' +
      '</p>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Fluxo alinhado ao Anexo II (ServiceNow) e √†s regras de responsabilidade do portador na Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. ' +
        'Em caso de exce√ß√µes, valide com o Financeiro.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

    function respCartaoGeral() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Sobre o cart√£o Clara nas lojas:</b>

<p class="mt-1">
O cart√£o Clara √© o meio oficial para pagar <b>despesas operacionais da loja</b>, em substitui√ß√£o ao antigo processo de sangrias, como:
<ul class="list-disc ml-4 mt-1">
  <li>materiais de limpeza e pequenos reparos;</li>
  <li>materiais de escrit√≥rio e inform√°tica de baixo valor;</li>
  <li>√°gua / coffee break para treinamentos internos e a√ß√µes autorizadas;</li>
  <li>servi√ßos emergenciais (motoboy, chaveiro, correios em situa√ß√µes operacionais).

<p class="mt-2">
Sempre precisa:
<ul class="list-disc ml-4 mt-1">
  <li>nota fiscal ou recibo;</li>
  <li>etiqueta correta na Clara;</li>
  <li>descri√ß√£o objetiva do gasto;</li>
  <li>lan√ßar tudo em at√© <b>48h</b> no app/web da Clara.


<p class="mt-2">
N√£o pode usar o cart√£o para:

<ul class="list-disc ml-4 mt-1">
  <li>gasto pessoal (roupa, almo√ßo/jantar pessoal, compras para uso pr√≥prio);</li>
  <li>bebida alco√≥lica;</li>
  <li>Uber / 99 / t√°xi para deslocamento pessoal;</li>
  <li>itens patrimoniais / infraestrutura (TV, geladeira, micro-ondas, mesa, cadeira etc.).

<p class="mt-2">
Se quiser, posso te explicar um caso espec√≠fico. Por exemplo:
<br/>‚Ä¢ "Posso comprar teclado?"<br/>
‚Ä¢ "Pode lanche pra equipe?"<br/>
‚Ä¢ "O que n√£o pode no cart√£o?"
</p>
</div>`;
}

    function respSangria() {
  return `HTML:
<div class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© <b>DESCONTINUADO</b>

  <p>Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo deve ser pago com o <b>cart√£o Clara</b>, com justificativa na plataforma.

  <p>Se a loja pensou em fazer sangria porque <b>n√£o conseguiu usar o cart√£o Clara</b> (categoria bloqueada na maquininha / MCC bloqueado), o fluxo correto √© <b>abrir chamado no ServiceNow para tratar a categoria</b>, e n√£o tirar dinheiro do caixa.

  <p>No ServiceNow, utilize o caminho: <b>Contas a Receber > Cart√£o Clara > Libera√ß√£o de categoria</b>, informando:

  <ul class="list-disc ml-4">
    <li><b>BU</b> e <b>loja</b>;</li>
    <li>Se tentou utilizar o cart√£o no estabelecimento;</li>
    <li><b>Data e valor</b> onde da transa√ß√£o (se j√° efetuada);</li>
    <li><b>Categoria desejada</b>.

  <p>O Financeiro avalia a solicita√ß√£o e ajusta as permiss√µes de categoria. A sangria em dinheiro continua sendo exce√ß√£o extrema.
</div>`;
}

    function respFraudeContestacao() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Suspeita de fraude ou transa√ß√£o n√£o reconhecida no cart√£o Clara</b></p>
    <p class="mt-2">Se aparecer uma compra que voc√™ realmente n√£o reconhece na Clara, primeiro confira se n√£o foi uma compra leg√≠tima feita por outro respons√°vel, se n√£o √© uma assinatura recorrente ou algo ligado √† opera√ß√£o da loja.</p>
    <p class="mt-2">Se mesmo assim continuar parecendo fraude ou uso indevido, √© caso de tratar como contesta√ß√£o formal.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p>Quando a transa√ß√£o for suspeita de fraude ou n√£o reconhecida mesmo ap√≥s confer√™ncia interna, siga estes passos:</p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Bloqueie o cart√£o na Clara, se ainda houver risco de novas cobran√ßas;</li>
          <li>Levante todas as informa√ß√µes da transa√ß√£o: data, valor, estabelecimento e descri√ß√£o;</li>
          <li>Se houver ind√≠cio de golpe ou roubo, registre um Boletim de Ocorr√™ncia, quando aplic√°vel.</li>
        </ul>
        <p class="mt-3"><b>Formaliza√ß√£o no ServiceNow:</b></p>
        <p>Abra um chamado de <b>Fraude / Contesta√ß√£o de transa√ß√£o ‚Äì Cart√£o Clara</b> no ServiceNow, informando loja, BU (Centauro / Fisia) e c√≥digo da unidade, al√©m dos dados completos da transa√ß√£o (data, valor, estabelecimento) e um resumo do ocorrido.</p>
        <p class="mt-2">Anexe prints da Clara, boletim de ocorr√™ncia (se houver) e qualquer evid√™ncia que ajude o Financeiro a tratar a contesta√ß√£o com o emissor.</p>
        <p class="mt-3 text-xs text-slate-500">Resumo alinhado ao Anexo II (Fraude / Contesta√ß√£o) da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. Acompanhe o retorno pelo pr√≥prio ServiceNow e pelos canais oficiais do Financeiro.</p>
      </div>
    </details>
  </div>`;
}

    function respTermoResponsabilidade() {
  return "HTML:" +
  "<div class='text-sm text-slate-700'>" +
    "<p>" +
      "O <b>Termo de Responsabilidade de uso do cart√£o da Clara</b> deve ser preenchido para que a loja possa utilizar o cart√£o. " +
      "Esse termo traz tamb√©m o aceite para a Pol√≠tica de uso do cart√£o. " +
      "Preencha " +
      "<a href='https://docs.google.com/forms/d/e/1FAIpQLSdnQWYFWp-udS9V039avJlXb4x1VnlDC6us5dSCrLkgngAxpg/viewform' " +
         "target='_blank' rel='noopener noreferrer' class='service-link' style='display:inline;'><b>este formul√°rio</b></a>. " +
      "Ap√≥s preencher, voc√™ receber√° o termo anexado ao e-mail, onde deve <b>imprimir, assinar e nos enviar</b>. " +
      "Depois disso, o uso do cart√£o estar√° liberado." +
    "</p>" +
  "</div>";
}

    function respNovoCartaoPrimeiraVia() {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Primeira via de cart√£o Clara (novo cart√£o)</b></p>
<p class="mt-1">
Para solicitar a <b>primeira via</b> do cart√£o Clara, siga estes passos:
</p>
<ol class="list-decimal ml-5 mt-1">
  <li>Preencha o formul√°rio: <a href="https://docs.google.com/forms/d/1vGAsFHuDQ6y5ydJMuE7W9ThJFjsLma_1I6yw92OLHh4/viewform"
       target="_blank" rel="noopener noreferrer"><b>Formul√°rio de Solicita√ß√£o de Cart√£o Clara</b></a>.
  
  <li class="mt-1">Depois de preencher o formul√°rio, envie um e-mail para o Financeiro informando que j√° preencheu, para que o cart√£o seja emitido: <b>contasareceber@gruposbf.com.br</b>
<p class="mt-2">
O prazo de entrega do cart√£o √© de at√© <b>7 dias √∫teis</b>, conforme a pol√≠tica interna.
</p>
</div>`;
    }

function respNovoCartaoSegundaVia() {
  return `HTML:
<div class="text-sm text-slate-700">

  <b>Segunda via de cart√£o Clara (cart√£o j√° existia)

  <p style="margin-top:6px;">
    A solicita√ß√£o de <b>segunda via</b> (perda, roubo, dano ou troca de portador) deve seguir o fluxo previsto na Pol√≠tica de Uso dos Cart√µes Clara:

  <p style="margin-top:6px; margin-bottom:4px;">
    ‚Ä¢ Bloquear imediatamente o cart√£o antigo na plataforma / app da Clara atrav√©s da funcionalidade de <b>"Congelar"</b>;<br>
    ‚Ä¢ Registrar o motivo (perda, roubo, quebra, etc.) conforme orienta√ß√µes internas;<br>
    ‚Ä¢ Enviar email para o time de Contas a Receber solicitando a emiss√£o de segunda via do cart√£o Clara.

  <p style="margin-top:6px;">
    Sempre siga as orienta√ß√µes detalhadas na <b>Pol√≠tica de Uso dos Cart√µes Clara</b> para casos de reemiss√£o/segunda via.

</div>`;
}

      function respGenerica(msgNorm) {
    msgNorm = msgNorm || "";

    // Mensagens claramente relacionadas a justificativa / nota / comprovante / v√≠deo de justificativa
    const ehJustificativa =
        msgNorm.includes("justific") ||
        msgNorm.includes("nota fiscal") ||
        msgNorm.includes("nota da compra") ||
        msgNorm.includes("perdi a nota") ||
        msgNorm.includes("falta a nota") ||
        msgNorm.includes("despesa sem nota") ||
        msgNorm.includes("despesa sem comprovante") ||
        msgNorm.includes("comprovante") ||
        msgNorm.includes("comprovantes") ||
        msgNorm.includes("video de justificativa") ||
        msgNorm.includes("v√≠deo de justificativa") ||
        msgNorm.includes("video de justificativas") ||
        msgNorm.includes("v√≠deo de justificativas");

    const avaliacao = avaliarCompraEspecifica(msgNorm);

    // 1) Se a avalia√ß√£o espec√≠fica decidiu claramente que N√ÉO pode
    if (avaliacao && avaliacao.pode === false && avaliacao.resposta) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
    }

    // 2) Se a avalia√ß√£o espec√≠fica decidiu claramente que PODE e tem etiqueta
    if (avaliacao && avaliacao.pode === true && avaliacao.etiquetaValida) {
        const et = avaliacao.etiquetaValida;
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
</div>`;
    }

    // 3) Perguntas amplas do tipo "O que posso comprar com o cart√£o?"
    if (perguntasGeraisOquePosso && perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ O que pode no cart√£o Clara</b> - Exemplos de materiais:</p>
<ul class="list-disc ml-4 mt-1">
<li>Materiais de escrit√≥rio: canetas, blocos, pastas, papel, clips, organizadores, grampeadores;</li>
<li>Servi√ßos gr√°ficos e de comunica√ß√£o visual: impress√£o de banners, adesivos promocionais, folders e plotagens autorizadas pela √°rea de VM;</li>
<li>Compra de √°gua mineral ou gal√µes para abastecimento da equipe (etiqueta ‚Äú√ÅGUA POT√ÅVEL‚Äù);</li>
<li>Suprimentos de inform√°tica (mouse, teclado, cabos, bobina fiscal etc.);</li>
<li>Lanches, coffee breaks ou premia√ß√µes para equipe somente quando vinculados a treinamentos internos, a√ß√µes oficiais ou campanhas aprovadas (etiqueta ‚ÄúLANCHES DE REFEI√á√ïES‚Äù);</li>
<li>Servi√ßos emergenciais (motoboy urgente, chaveiro, Sedex de documento);</li>
<li>Compra de bobinas fiscais ou suprimentos obrigat√≥rios do PDV;</li>
<li>Pequenas manuten√ß√µes (el√©trica, civil, ar-condicionado, equipamentos).</li>
</ul>
<p class="mt-2"><b>‚ùå O que n√£o pode</b> - Exemplos de itens n√£o permitidos:</p>
<ul class="list-disc ml-4">
<li>Itens patrimoniais ou de infraestrutura: TV, micro-ondas, geladeira, freezer, mesa, cadeira, arm√°rio, ventilador, cafeteira el√©trica, computador, impressora, celular, tablets, ou qualquer bem dur√°vel;</li>
<li>Bebidas alco√≥licas (cerveja, vinho, whisky, vodka, gin, tequila, entre outras);</li>
<li>Transporte pessoal: Uber, 99, t√°xi, aplicativos de carona ou combust√≠vel para ve√≠culo particular;</li>
<li>Despesas pessoais: almo√ßo, jantar, lanche, coffee break pessoal, delivery, supermercado para consumo pr√≥prio;</li>
<li>Equipamentos e mobili√°rios que exigem tombamento patrimonial (mesmo que de baixo valor);</li>
<li>Manuten√ß√µes estruturais de grande porte (obras, pintura geral, reformas, trocas de piso, el√©trica complexa, etc.);</li>
<li>Servi√ßos ou produtos sem nota fiscal (inclusive compras em marketplaces sem NF emitida no CNPJ da loja);</li>
<li>Gastos fora da opera√ß√£o da loja ou que n√£o tenham rela√ß√£o com a atividade comercial;</li>
</ul>
</div>`;
    }

    // 4) Se a mensagem N√ÉO tem cara de assunto da Clara/cart√£o, devolve FORA DE ESCOPO
    const falaMundoClara =
        msgNorm.includes("clara") ||
        msgNorm.includes("cartao") || msgNorm.includes("cart√£o") ||
        msgNorm.includes("fatura") ||
        msgNorm.includes("pendencia") || msgNorm.includes("pend√™ncia") ||
        msgNorm.includes("nota fiscal") || msgNorm.includes("nf ") || msgNorm.startsWith("nf") ||
        msgNorm.includes("etiqueta") ||
        msgNorm.includes("limite") ||
        msgNorm.includes("transacao") || msgNorm.includes("transa√ß√£o") ||
        msgNorm.includes("compra") || msgNorm.includes("comprar") || msgNorm.includes("paguei");

    if (!falaMundoClara) {
        // Se √© claramente uma d√∫vida de justificativa / nota / comprovante / v√≠deo de justificativa,
        // n√£o manda resposta fora de escopo (deixa o fluxo de justificativa/v√≠deo responder sozinho).
        if (ehJustificativa) {
            return "";
        }

        // Caso contr√°rio, segue a l√≥gica normal de fora de escopo
        return respostaForaEscopo(msgNorm);
    }

    // 5) Se √© claramente justificativa / nota / comprovante / v√≠deo de justificativa,
    // n√£o manda o texto gen√©rico de pol√≠tica (outro fluxo j√° respondeu).
    if (ehJustificativa) {
        return "";
    }

    // 5) Fallback gen√©rico (quando √© assunto Clara, mas n√£o bateu em nada acima)
    return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cart√£o Clara, o gasto precisa ser <b>necess√°rio pra opera√ß√£o da loja</b> (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal, √°gua/coffee break autorizado pra treinamento interno ou a√ß√£o oficial).</p>
<p class="mt-2">O que <b>n√£o pode</b> no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (refei√ß√£o pessoal, compra pra uso pr√≥prio etc.);<br/>
‚Ä¢ bebida alco√≥lica em geral;<br/>
‚Ä¢ transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira, entre outros).</p><br/>
Caso entenda que a compra √© essencial para o dia a dia da loja, fale com o financeiro, caso seja verificado que o item √© essencial eles podem abrir uma exce√ß√£o para a compra.
</div>`;
}

    /* ========= FUN√á√ïES DE PEND√äNCIAS (BACKEND) ========= */

    function consultarPendenciasNoServidor(loja) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (!res || !res.ok) {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  N√£o consegui consultar as pend√™ncias da loja <b>${loja}</b>.<br/>
                  Detalhe: ${erro}
                  </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // üÜï loja n√£o existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  A numera√ß√£o informada n√£o existe, pe√ßo que verifique o n¬∫ correto da loja.
                  </p>`
                    );
                    // continua aguardando n√∫mero da loja
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // dispara o timer de 10s
                    return;
                }

                // loja existe, mas N√ÉO tem pend√™ncias na CLARA_PEND
                if (!res.rows || res.rows.length === 0) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                N√£o encontrei pend√™ncias para a loja <b>${loja}</b> na √∫ltima data de cobran√ßa.
                </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // ‚úÖ loja v√°lida + tem pend√™ncias ‚Üí continua igual
                ultimaPendenciaResumo = { loja: res.loja, data: res.ultimaData };
                lojaPendenciasAtual = res.loja;

                let tabela = `
                <div class="text-sm text-slate-700">
                <p>Encontrei abaixo as √∫ltimas pend√™ncias Clara da loja <b>${res.loja}</b> (data de cobran√ßa <b>${res.ultimaData}</b>). Caso a pend√™ncia j√° tenha sido regularizada e o seu cart√£o ainda esteja bloqueado, solicite o desbloqueio atrav√©s de abertura de chamado no ServiceNow, caminho: <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Desbloqueio</b>.</p>
                <div class="mt-2 overflow-x-auto">
                <table class="min-w-full text-xs border border-slate-200">
                <thead class="bg-slate-100">
                <tr>`;

                const header = res.header || [];
                header.forEach(h => {
                    tabela += `<th class="border px-2 py-1">${h}</th>`;
                });
                tabela += `</tr></thead><tbody>`;

                res.rows.forEach(linha => {
                    tabela += `<tr>`;
                    linha.forEach(col => {
                        tabela += `<td class="border px-2 py-1">${col !== null && col !== undefined ? col : ""}</td>`;
                    });
                    tabela += `</tr>`;
                });

                tabela += `</tbody></table></div></div>`;

                renderBotMessage("HTML:" + tabela);

                estadoPendencias = "aguardando_confirmacao_email";

                renderBotMessage(
                  'HTML:' +
                  '<div class="text-sm text-slate-700 mt-2">' +
                    '<p>Quer que eu envie esse resumo por e-mail tamb√©m?</p>' +
                    '<div class="mt-2 flex gap-2">' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'Sim' +
                      '</button>' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'n√£o\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'N√£o' +
                      '</button>' +
                    '</div>' +
                  '</div>'
                );
                
            })
            .withFailureHandler(function(err) {
                console.error("Erro getPendenciasPorLoja:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pend√™ncias dessa loja. Tente novamente mais tarde.</p>'
                );
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
            })
            .getPendenciasPorLoja(loja);
    }

                function consultarPendenciasBloqueio(loja) {
        google.script.run
            .withSuccessHandler(res => {
                // erro gen√©rico
                if (!res || !res.ok) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // üÜï loja n√£o existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    A numera√ß√£o informada n√£o existe, pe√ßo que verifique o n¬∫ correto da loja.
                    </p>`
                    );
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // timer de 10s
                    return;
                }

                // se chegou aqui, loja √© v√°lida ‚Üí precisa ter html
                if (!res.html) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // mostra o HTML (tabela ou "N√£o encontrei pend√™ncias")
                renderBotMessage("HTML:" + res.html);

                // üü° CASO 1: loja v√°lida mas sem pend√™ncias
                if (res.html.includes("N√£o encontrei pend√™ncias")) {
                    estadoPendencias = "nenhum";

                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700 mt-2">
                  Acredito que, caso realmente o cart√£o esteja bloqueado, possa ser por algum outro motivo. Verifique com o time do Financeiro o que pode ter ocorrido, ok?
                  </p>`
                    );
                    return;
                }

                   // üü¢ CASO 2: loja v√°lida + tem pend√™ncias ‚Üí pergunta se quer e-mail
                    estadoPendencias = "aguardando_confirmacao_email";

                    renderBotMessage(
                      'HTML:' +
                      '<div class="text-sm text-slate-700 mt-2">' +
                        '<p>Quer que eu envie esse resumo por e-mail tamb√©m?</p>' +
                        '<div class="mt-2 flex gap-2">' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'Sim' +
                          '</button>' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'n√£o\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'N√£o' +
                          '</button>' +
                        '</div>' +
                      '</div>'
                    );
            })
            .withFailureHandler(err => {
                estadoPendencias = "nenhum";
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
            Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
            </p>`
                );
            })
            .getPendenciasParaBloqueio(loja);
    }


    function chamarEnvioPendenciasPorEmail(loja, email) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Enviei o resumo das pend√™ncias da loja <b>${res.loja || loja}</b> para o e-mail <b>${email}</b> (data de cobran√ßa: <b>${res.data || (ultimaPendenciaResumo && ultimaPendenciaResumo.data) || ""}</b>). N√£o se esque√ßa de regularizar as justificativas na plataforma da Clara e posteriormente encaminhar chamado para que o cart√£o seja desbloqueado (caso esteja bloqueado).</p>`
                    );
                } else {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Tentei enviar o e-mail de pend√™ncias, mas deu problema: ${erro}.</p>`
                    );
                }
            })
            .withFailureHandler(function(err) {
                console.error("Erro enviarPendenciasPorEmail:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail de pend√™ncias. Tente novamente mais tarde.</p>'
                );
            })
            .enviarPendenciasPorEmail(loja, email);
    }

    /* ========= MOTOR DA POL√çTICA ========= */

 function gerarRespostaPolitica(msgUsuario) {
        const norm = normalize(msgUsuario);
        const intencao = detectarIntencaoPergunta(norm);

        // 0) Frases de compra/uso em primeira pessoa (mais espec√≠ficas que categoria gen√©rica)
    const fraseCompraPrimeiraPessoa =
      norm.includes("paguei ") ||
      norm.includes("paguei meu") ||
      norm.includes("paguei minha") ||
      norm.includes("usei o cartao") ||
      norm.includes("usei o cart√£o") ||
      norm.includes("vou comprar") ||
      norm.includes("vou compra") ||
      norm.includes("posso usar o cartao") ||
      norm.includes("posso usar o cart√£o") ||
      norm.includes("usei o cartao clara") ||
      norm.includes("usei o cart√£o clara");

    if (fraseCompraPrimeiraPessoa) {
      // usa a l√≥gica j√° existente de casos espec√≠ficos (proibidos/permitidos)
      return respGenerica(norm);
    }

// 1) Primeiro tenta responder usando o motor de categorias da pol√≠tica,
//    EXCETO quando a pergunta √© claramente sobre ETIQUETA
let resultadoCategoria = null;

if (intencao !== "etiqueta") {
  resultadoCategoria = tentarResponderPorCategoriaPolitica(msgUsuario, norm);
}

if (resultadoCategoria) {
  return vektorBlocoRaciocinioPolitica(
    resultadoCategoria.mensagemUsuario,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

  // 2) Se n√£o bateu em uma categoria espec√≠fica, tenta ver se √© pedido de RESUMO de categorias
  if (typeof tentarResponderResumoCategoriasPolitica === "function") {
    const resultadoResumo = tentarResponderResumoCategoriasPolitica(norm);
    if (resultadoResumo) {
      return vektorBlocoRaciocinioPolitica(
        resultadoResumo.mensagemUsuario,
        "",
        typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
          ? POLITICA_CARTOES_CLARA_LINK
          : ""
      );
    }
  }

        // gasto pessoal alimenta√ß√£o
        const padroesGastoPessoalAlimentacao = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","meu lanche com o cartao","meu lanche com o cart√£o",
            "minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));
        if (isGastoPessoalAlimentacao) {
  ultimaIntencao = "gasto_pessoal_alimentacao";
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Gasto pessoal com alimenta√ß√£o n√£o √© permitido no cart√£o Clara</b></p>
    <p class="mt-2">Refei√ß√µes pessoais como almo√ßo, jantar, lanches ou consumo individual n√£o podem ser pagos com o cart√£o corporativo, pois n√£o s√£o despesas operacionais da loja.</p>
    <p class="mt-2">Se a compra j√° foi realizada, ela deve ser tratada como uso indevido.

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p>Quando houver uso do cart√£o Clara para gasto pessoal, a loja deve:</p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Classificar a compra na Clara como <b>Despesa pessoal ‚Äì Uso indevido</b>;</li>
          <li>Providenciar o ressarcimento do valor √† empresa dentro do prazo definido;</li>
          <li>Formalizar o caso no ServiceNow, se orientado pelo Financeiro.</li>
        </ul>
        <p class="mt-2">O chamado a ser utilizado √© <b>Gasto indevido (pessoal) / Ressarcimento ‚Äì Cart√£o Clara</b>, com descri√ß√£o do ocorrido, valor, data e loja.</p>
        <p class="mt-3 text-xs text-slate-500">Uso indevido pode gerar bloqueio preventivo do cart√£o e impactos administrativos para a loja.</p>
      </div>
    </details>
  </div>`;
}

        let resposta;

        switch (intencao) {
            case "foraEscopo":
                ultimaIntencao = "foraEscopo";
                resposta = respostaForaEscopo();
                break;


             // üîπ NOVO: transa√ß√£o negada / categoria bloqueada
            case "transacaoNegadaCategoria":
                ultimaIntencao = "transacaoNegadaCategoria";
                resposta = respTransacaoNegadaCategoria();
                break;   


            case "etiqueta": {
                ultimaIntencao = "etiqueta";
                const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));
                const et = acharEtiquetaPorMensagem(norm);

                if (!et && isPerguntaGeral) {
                    resposta = respCatalogoEtiquetas();
                } else if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
              N√£o consegui identificar uma etiqueta espec√≠fica s√≥ com esse texto.<br/>
              Se o gasto for operacional e n√£o existir etiqueta adequada na lista da Clara, abra chamado no
              <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
              <strong>ServiceNow</strong>
              </a>
              solicitando cria√ß√£o ou ajuste de etiqueta.
              </p>`;
                }
                break;
            }


            case "sobreBot":
            resposta = `HTML:<div class="text-sm text-slate-700">
          <p>Sou o <b>Vektor</b> ü§ñ ‚Äî Agente do <b>Grupo SBF</b> especializado no <b>cart√£o Clara</b>.

          <p class="mt-2">Posso te ajudar com v√°rias coisas, por exemplo:
          <ul class="list-disc ml-5 mt-1">
          <li>Explicar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>;</li>
          <li>Orientar sobre <b>o que pode e o que n√£o pode ser comprado</b>;</li>
          <li>Indicar a <b>etiqueta correta</b> pra cada tipo de gasto (ex.: √°gua, lanche, inform√°tica, manuten√ß√£o...);</li>
          <li>Guiar sobre <b>bloqueio e desbloqueio</b> do cart√£o;</li>
          <li>Consultar <b>pend√™ncias da loja</b> e at√© <b>enviar o resumo por e-mail</b>;</li>
          <li>Consultar <b>transa√ß√µes efetuadas</b> e tamb√©m comparar com outras lojas ou times</b>;</li>
          <li>Mostrar <b>como solicitar novo cart√£o</b> (primeira ou segunda via);</li>
          <li>Explicar sobre o <b>Termo de Responsabilidade</b> e onde preencher;</li>
          <li>Responder d√∫vidas sobre <b>sangria, limite, reembolsos e presta√ß√£o de contas</b>;</li>
          <li>E, claro, te direcionar para os canais certos como <b>Financeiro</b> ou <b>ServiceNow</b> quando for preciso.

          <p class="mt-3">Basta me perguntar de forma natural, tipo:</p>
          <p>‚Ä¢ ‚ÄúQual etiqueta usar para lanche de treinamento?‚Äù<br/>
          ‚Ä¢ ‚ÄúPosso comprar mouse no cart√£o Clara?‚Äù<br/>
          ‚Ä¢ ‚ÄúQuais lojas/times com maior valor/quantidade de transa√ß√µes?‚Äù<br/>
          ‚Ä¢ ‚ÄúTimes X, Y ou Z no periodo XXXXX‚Äù<br/>
          ‚Ä¢ ‚ÄúPend√™ncias da loja 1234?‚Äù</p>

          <p class="mt-3 italic text-slate-500">Estou aqui pra facilitar o dia a dia das lojas no uso do cart√£o Clara. üíú</p>
          </div>`;
            break;

            case "limite":
                ultimaIntencao = "limite";
                resposta = respLimite();
                break;

                    case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
            resposta = respCartaoGeral();
            break;

    
            case "bloqueio": {
                  ultimaIntencao = "bloqueio";

                  // 1) Envia a mensagem principal de bloqueio (j√° aparece com os 3 pontinhos)
                  renderBotMessage(respBloqueio());

                  // 2) Prepara o estado para o fluxo de pend√™ncias ligadas a bloqueio
                  origemPendenciasBloqueio = true;
                  estadoPendencias = "aguardando_loja";
                  lojaPendenciasAtual = "";
                  ultimaPendenciaResumo = null;

                  // 3) Agenda a PR√ìXIMA mensagem, com delay, tamb√©m usando renderBotMessage
                  //    ‚Üí assim aparece de novo o "digitando..." antes dela
                  setTimeout(() => {
                      renderBotMessage(`HTML:<p class="text-sm text-slate-700">
              Caso realmente seu cart√£o esteja bloqueado, devido a situa√ß√µes ligadas a pend√™ncias de justificativas de transa√ß√µes na Clara, posso te mostrar as pend√™ncias mais recentes do cart√£o da sua loja, da√≠ voc√™ j√° corre l√° no app da Clara pra regularizar üòâ .<br/><br/>
              üó£Ô∏è Me informa o n√∫mero da loja, por favor.
              </p>`);
                  }, 1000); // 1000 ms = 1 segundo depois da primeira mensagem

                  // 4) N√£o devolve texto pro fluxo principal, porque a segunda mensagem
                  //    j√° vai ser enviada pelo setTimeout
                  return null;
              }

            case "prestacao":
                ultimaIntencao = "prestacao";
                resposta = respPrestacaoContas();
                break;

            case "alimentoTime":
                ultimaIntencao = "alimentoTime";
                resposta = respAlimentoTime();
                break;

            case "transportePessoal":
                ultimaIntencao = "transportePessoal";
                resposta = respTransportePessoal();
                break;

            case "trocaGerente":
    ultimaIntencao = "trocaGerente";

    // norm j√° foi calculado no come√ßo de gerarRespostaPolitica
    const falaMudancaEntreLojas =
      norm.includes("mudar de loja") ||
      norm.includes("mudei de loja") ||
      norm.includes("mudanca de loja") ||
      norm.includes("mudan√ßa de loja") ||
      norm.includes("troca de loja") ||
      norm.includes("trocar de loja") ||
      norm.includes("vou mudar de loja") ||
      norm.includes("fui transferido") ||
      norm.includes("fui transferida") ||
      norm.includes("transferido de loja") ||
      norm.includes("transferida de loja") ||
      norm.includes("transferencia de loja") ||
      norm.includes("transfer√™ncia de loja") ||
      norm.includes("mudei de unidade") ||
      norm.includes("trocar de unidade") ||
      norm.includes("troquei de loja") ||
      norm.includes("sou de outra loja") ||
      norm.includes("sou de outra unidade") ||
      norm.includes("troca de gerente");

    if (falaMudancaEntreLojas) {
        resposta = respTrocaGerenteMudancaLojas();
    } else {
        // f√©rias, afastamento, desligado, sem gerente etc.
        resposta = respTrocaGerente();
    }
    break;

            case "procedimentosServiceNow":
                ultimaIntencao = "procedimentosServiceNow";
                resposta = respProcedimentosServiceNow();
                break;


            case "sangria":
                ultimaIntencao = "sangria";
                resposta = respSangria();
                break;

            case "fraudeContestacao":
                ultimaIntencao = "fraudeContestacao";
                resposta = respFraudeContestacao();
                break;

                case "podeNaoPode":
                case "generica":
                default:
                    ultimaIntencao = "generica";

                    // antes do gen√©rico
                    if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) {
                      // deixa o bloco singular tratar; n√£o cai no gen√©rico
                      return;
                    } else {
                      resposta = respGenerica(norm);
                    }
                    break;
                        }

        return resposta;
    }

    // ====== MINI BOT DO MANUAL CLARA ======

    
const MANUAL_CLARA_LINK = "https://drive.google.com/file/d/1TYJ7x5Uxb5C47pNpUDWIzxXZb9lJfm8I/view?usp=sharing";
const POLITICA_CARTOES_CLARA_LINK = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";
const LOOKER_RELATORIO_URL = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

window.vektorManualClaraSecao = function (secaoId) {
  let html = "";

  if (secaoId === "primeiro_acesso") {
    html =
      "<p><b>01 Primeiro acesso:</b></p><br>" +
      "<p>1Ô∏è‚É£ Verifique se voc√™ recebeu o e-mail da Clara com o assunto <b>‚ÄúJunte-se √† Clara‚Äù</b> (olhe tamb√©m no SPAM).</p>" +
      "<p>2Ô∏è‚É£ Siga o link do e-mail para criar sua senha.</p>" +
      "<p>3Ô∏è‚É£ Ative a autentica√ß√£o em 2 etapas com um app como o <b>Google Authenticator</b> e escaneie o QR Code ao fazer o primeiro login no site da Clara.</p>" +
      "<p>4Ô∏è‚É£ Depois disso, sempre que entrar no site ser√° pedido o c√≥digo de 6 d√≠gitos gerado pelo app de autentica√ß√£o.</p>";
  }

  else if (secaoId === "recebi_cartao") {
    html =
      "<p><b>02 Recebi o cart√£o, e agora?</b></p><br>" +
      "<p>1Ô∏è‚É£ Baixe o app <b>Clara Card</b> (iOS ou Android).</p>" +
      "<p>2Ô∏è‚É£ Fa√ßa login com o mesmo e-mail/senha que voc√™ usa na plataforma Clara.</p>" +
      "<p>3Ô∏è‚É£ V√° em <b>Cart√µes</b>, selecione o cart√£o recebido e clique em <b>Ativar</b>.</p>" +
      "<p>4Ô∏è‚É£ Informe os <b>4 √∫ltimos d√≠gitos</b> do cart√£o e conclua a ativa√ß√£o.</p>" +
      "<p>Depois disso o cart√£o j√° fica pronto para uso.</p>";
  }

  else if (secaoId === "esqueci_senha") {
    html =
      "<p><b>03 Esqueci a senha do cart√£o / acesso:</b></p><br>" +
      "<p>üîê <b>Senha do cart√£o</b>: voc√™ v√™ apenas pelo aplicativo da Clara, em <b>Cart√µes &gt; Ver senha</b>. A senha √© gerada automaticamente e n√£o √© alter√°vel.</p><br>" +
      "<p>üîë <b>Senha de login</b>: se esqueceu, use a op√ß√£o de <b>redefinir senha</b> na tela de login da Clara. Um link ser√° enviado para seu e-mail para criar uma nova senha.</p>" +
      "<p>Se voc√™ perdeu acesso ao app de autentica√ß√£o (2 etapas), pe√ßa para algu√©m com acesso administrativo redefinir sua autentica√ß√£o.</p>";
  }

  else if (secaoId === "qual_meu_acesso") {
    html =
      "<p><b>04 Qual o meu acesso?</b></p><br>" +
      "<p>1Ô∏è‚É£ Entre na plataforma Clara pelo computador.</p>" +
      "<p>2Ô∏è‚É£ Clique em <b>Meu Perfil</b>, no canto superior direito.</p>" +
      "<p>3Ô∏è‚É£ Na √°rea de <b>A√ß√µes do usu√°rio</b> aparece o seu tipo de acesso:</p>" +
      "<ul>" +
        "<li>‚Ä¢ <b>Administrador (Owner)</b>: acesso total, v√™ saldo global, faturas, relat√≥rios completos.</li>" +
        "<li>‚Ä¢ <b>Gerente (Manager)</b>: gerencia usu√°rios/cart√µes do seu grupo e v√™ saldo global.</li>" +
        "<li>‚Ä¢ <b>Colaborador (Employee)</b>: v√™ somente seus cart√µes, transa√ß√µes e pode anexar notas.</li>" +
        "<li>‚Ä¢ <b>Contador (Accountant)</b>: acesso a todas as faturas, boletos, relat√≥rios e transa√ß√µes.</li>" +
      "</ul>";
  }

  else if (secaoId === "anexar_comprovante") {
    html =
      "<p><b>05 Como anexar comprovante?</b></p><br>" +
      "<p><b>Pelo app (celular):</b></p>" +
      "<ol>" +
        "<li>1. Abra o app da Clara e fa√ßa login.</li>" +
        "<li>2. V√° em <b>Transa√ß√µes</b> e selecione a compra.</li>" +
        "<li>3. Toque em <b>Anexar</b> e tire foto ou escolha o arquivo (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um <b>coment√°rio</b> explicando a despesa.</li><br>" +
      "</ol>" +
      "<p><b>Pelo computador:</b></p>" +
      "<ol>" +
        "<li>1. Acesse a plataforma Clara e v√° em <b>Transa√ß√µes</b>.</li>" +
        "<li>2. Clique na transa√ß√£o desejada.</li>" +
        "<li>3. Em <b>Selecionar arquivos</b>, envie o comprovante (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um coment√°rio explicando a despesa.</li>" +
      "</ol>";
  }

  else if (secaoId === "duvidas") {
    html =
      "<p><b>06 D√∫vidas:</b></p><br>" +
      "<p>Alguns pontos importantes:</p>" +
      "<ul>" +
        "<li>‚Ä¢ <b>Autentica√ß√£o em 2 etapas</b>: sempre use o c√≥digo de 6 d√≠gitos do app de autentica√ß√£o ao entrar no site.</li>" +
        "<li>‚Ä¢ <b>Problema de login</b>: verifique e-mail min√∫sculo, senha correta ou use ‚ÄúContinuar com Google‚Äù se j√° usou antes.</li>" +
        "<li>‚Ä¢ <b>Perdi o celular ou cart√£o</b>: pe√ßa para algu√©m com acesso administrativo bloquear/cancelar o cart√£o e criar outro.</li>" +
        "<li>‚Ä¢ <b>Cancelamento/estorno</b>: tente primeiro com o estabelecimento; se n√£o resolver, conteste a transa√ß√£o via app/plataforma da Clara.</li>" +
      "</ul>" +
      "<p>Canais de suporte Clara: telefone 0800, e-mail, chat na Central de Ajuda (conforme manual).</p>";
  }

  if (!html) return;

  // Rodap√© padr√£o com link para o manual completo
  html +=
    "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
      "Caso queira mais detalhes, acesse o manual completo: " +
      "<a href='" + MANUAL_CLARA_LINK + "' target='_blank' style='color:#005E27;font-weight:bold;'>Manual do Usu√°rio Clara</a>." +
    "</p>";

  // üëâ REGISTRA o t√≥pico no hist√≥rico
  try {
    registrarTopicoManualClara(secaoId);
  } catch (e) {
    console.warn("N√£o consegui registrar hist√≥rico do manual:", e);
  }

  // Envia a resposta principal
  renderBotMessage("HTML:<div class='text-sm text-slate-700'>" + html + "</div>");
  scrollToBottom && scrollToBottom();

  // üëâ Mostra um resumo do que o usu√°rio j√° acessou (se tiver mais de 1 item)
  //vektorMostrarHistoricoManualSeExistir();

    // üëâ Sugest√£o autom√°tica baseada no t√≥pico aberto
  if (typeof window.vektorSugerirTopicoRelacionadoManual === "function") {
    window.vektorSugerirTopicoRelacionadoManual(secaoId);
  }
};

// Mapeia o ID t√©cnico para um t√≠tulo amig√°vel
function mapSecaoManualParaTitulo(secaoId) {
  switch (secaoId) {
    case "primeiro_acesso":
      return "01 Primeiro acesso";
    case "recebi_cartao":
      return "02 Recebi o cart√£o, e agora?";
    case "esqueci_senha":
      return "03 Esqueci a senha do cart√£o / acesso";
    case "qual_meu_acesso":
      return "04 Qual o meu acesso?";
    case "anexar_comprovante":
      return "05 Como anexar comprovante?";
    case "duvidas":
      return "06 D√∫vidas";
    default:
      return null;
  }
}

// Salva o hist√≥rico no localStorage (m√°x. 20 registros)
function registrarTopicoManualClara(secaoId) {
  try {
    const titulo = mapSecaoManualParaTitulo(secaoId);
    if (!titulo) return;

    const STORAGE_KEY = "vektor_manual_clara_historico";

    let historico = [];
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) historico = parsed;
      } catch (e) {
        console.warn("Hist√≥rico do manual Clara estava corrompido, reiniciando.");
      }
    }

    historico.push({
      secao: secaoId,
      titulo: titulo,
      dataIso: new Date().toISOString()
    });

    // limita a 20 entradas mais recentes
    if (historico.length > 20) {
      historico = historico.slice(historico.length - 20);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(historico));
  } catch (e) {
    console.warn("Erro ao salvar hist√≥rico do manual Clara:", e);
  }
}

// L√™ o hist√≥rico e devolve ordenado do mais recente para o mais antigo
function obterHistoricoManualClara() {
  const STORAGE_KEY = "vektor_manual_clara_historico";
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];

    // ordena do mais recente para o mais antigo
    return parsed
      .filter(item => item && item.titulo && item.dataIso)
      .sort((a, b) => (a.dataIso || "").localeCompare(b.dataIso || ""));
  } catch (e) {
    console.warn("Erro ao ler hist√≥rico do manual Clara:", e);
    return [];
  }
}

// Mostra uma mensagem "Voc√™ j√° acessou recentemente..." no chat
function vektorMostrarHistoricoManualSeExistir() {
  try {
    const historico = obterHistoricoManualClara();
    if (!historico || historico.length <= 1) {
      // se s√≥ tem 0 ou 1 item, n√£o faz sentido falar em "recentemente"
      return;
    }

    // pega no m√°ximo 5 mais recentes (sem duplicar t√≠tulos)
    const vistos = [];
    const titulosJaUsados = new Set();

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || !item.titulo) continue;
      if (titulosJaUsados.has(item.titulo)) continue;

      titulosJaUsados.add(item.titulo);
      vistos.push(item.titulo);

      if (vistos.length >= 5) break;
    }

    if (!vistos.length) return;

    const listaHtml = vistos
      .map(t => "<li>‚Ä¢ " + t + "</li>")
      .join("");

    const html =
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Voc√™ j√° acessou recentemente:</b></p>" +
        "<ul style='margin-top:4px;margin-left:16px;'>" +
          listaHtml +
        "</ul>" +
        "<p style='margin-top:6px;font-size:12px;color:#64748b;'>" +
          "Voc√™ pode clicar novamente nos bot√µes do Manual da Clara para reabrir qualquer um desses t√≥picos." +
        "</p>" +
      "</div>";

    renderBotMessage("HTML:" + html);
    if (typeof scrollToBottom === "function") {
      scrollToBottom();
    }
  } catch (e) {
    console.warn("Erro ao mostrar hist√≥rico do manual Clara:", e);
  }
}

// ---------------------------------------------------------------------
// SUGEST√ïES GERAIS DO VEKTOR (fora do Manual da Clara)
// ---------------------------------------------------------------------

function vektorSugerirTopicosGerais(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);
    const blocos = [];

    // 1) D√∫vidas de PERMISS√ÉO DE COMPRA ‚Üí sugerir Pol√≠tica de Uso (apenas 1 vez por sess√£o)
    if (
      !__vektorJaSugeriuPoliticaRestricoes &&
      (
        norm.includes("pode comprar") ||
        norm.includes("posso comprar") ||
        norm.includes("pode usar") ||
        norm.includes("posso usar") ||
        norm.includes("pode pagar") ||
        norm.includes("posso pagar") ||
        norm.includes("permitido") ||
        norm.includes("permitida") ||
        norm.includes("proibido") ||
        norm.includes("proibida")
      ) &&
      typeof POLITICA_CARTOES_CLARA_LINK === "string"
    ) {
      __vektorJaSugeriuPoliticaRestricoes = true;

      blocos.push(
        "<div style='margin-top:6px;'>" +
          "<p><b>Dica:</b> sempre que tiver d√∫vida se uma compra √© permitida ou n√£o, voc√™ pode consultar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>, <b>Item 7 - Restri√ß√µes de Uso</b>.</p>" +
          "<button type='button' " +
            "onclick=\"window.open('" + POLITICA_CARTOES_CLARA_LINK + "','_blank')\" " +
            "style='margin-top:6px;background:#06167d;color:#fff;border:none;" +
                   "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir Pol√≠tica de Uso dos Cart√µes Clara" +
          "</button>" +
        "</div>"
      );
    }

    // 2) Pedidos de RELAT√ìRIO / RANKING / DASHBOARD ‚Üí sugerir Looker Studio (apenas 1 vez)
    if (
      !__vektorJaSugeriuLooker &&
      (
        norm.includes("top") ||
        norm.includes("mais comprou") ||
        norm.includes("mais gastos") ||
        norm.includes("mais gastou") ||
        norm.includes("mais compras") ||
        norm.includes("maior valor") ||
        norm.includes("mais transa√ß√µes") ||
        norm.includes("mais transacoes")
      )
    ) {
      blocos.push(
        "<div style='margin-top:10px;'>" +
          "<p>Se quiser uma vis√£o completa (gr√°ficos, filtros e detalhamentos), voc√™ pode abrir o relat√≥rio gerencial no <b>Looker Studio</b>:</p>" +
          "<button type='button' " +
            "onclick=\"window.open('" + LOOKER_RELATORIO_URL + "','_blank')\" " +
            "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
                   "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir relat√≥rio gerencial (Looker Studio)" +
          "</button>" +
        "</div>"
      );

      __vektorJaSugeriuLooker = true;
    }

    // 3) PEND√äNCIAS / JUSTIFICATIVAS ‚Üí refor√ßar pol√≠tica e fluxo (apenas 1 vez por sess√£o)
    if (
      !__vektorJaSugeriuJustificativas &&
      (
        norm.includes("pendencia") ||
        norm.includes("pend√™ncia") ||
        norm.includes("pendencias") ||
        norm.includes("pend√™ncias") ||
        norm.includes("justificativa") ||
        norm.includes("justificativas") ||
        norm.includes("justificar") ||
        norm.includes("justificativas completas") ||
        norm.includes("ver justificativas completas") ||
        norm.includes("justificativas de uma loja") ||
        norm.includes("justificativas de um time")
      )
    ) {
      __vektorJaSugeriuJustificativas = true;

      blocos.push(
  "<div style='margin-top:10px;'>" +
    "<p>Al√©m de anexar os comprovantes, existe uma pol√≠tica espec√≠fica de prazos e regras para justificativas.</p>" +
    "<p style='margin-top:4px;'>Em caso de d√∫vida, consulte a <b><a href='" +
      (typeof POLITICA_CARTOES_CLARA_LINK !== 'undefined'
        ? POLITICA_CARTOES_CLARA_LINK
        : '#') +
      "' target='_blank' style='color:#005E27; text-decoration:underline;'>Pol√≠tica de Uso dos Cart√µes Clara</a></b> ou acione o time de Conta a Receber.</p>" +
  "</div>"
);
    }

    // Se nada acionou, n√£o sugere nada
    if (!blocos.length) return;

    const html =
      "HTML:<div class='text-sm text-slate-700 mt-2'>" +
        blocos.join("<hr style='margin:8px 0;border:none;border-top:1px solid #e2e8f0;'/>") +
      "</div>";

    // üîÅ Aguarda para dar tempo da resposta "normal" aparecer antes
    setTimeout(function () {
      renderBotMessage(html);
      if (typeof scrollToBottom === "function") {
        scrollToBottom();
      }
    }, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir t√≥picos gerais:", e);
  }

  // Sugest√£o quando o usu√°rio fala de ciclo de fatura
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("per√≠odo da fatura")
  ) {
    vektorMostrarSugestao(
      "Quer ver a tabela completa das faturas?",
      "Quero ver a tabela de faturas da Clara"
    );
  }
}

// ---------------------------------------------------------------------
// SUGEST√ïES AUTOM√ÅTICAS DO MANUAL DA CLARA A PARTIR DE OUTROS ASSUNTOS
// ---------------------------------------------------------------------

const VEKTOR_TEMPO_SUGESTAO_MIN = 5000; // Depois que j√° sugeriu...
const VEKTOR_SUGESTAO_DELAY_MS = 15000;   // Primeira vez que sugeriu

// Verifica se o usu√°rio j√° abriu um t√≥pico do manual h√° pouco tempo
function usuarioViuTopicoManualRecentemente(secaoId, minutosJanela) {
  try {
    minutosJanela = minutosJanela || 10; // padr√£o = 10 minutos
    const historico = obterHistoricoManualClara();
    if (!historico || !historico.length) return false;

    const agora = Date.now();
    const limiteMs = minutosJanela * 60 * 1000;

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || item.secao !== secaoId || !item.dataIso) continue;

      const t = Date.parse(item.dataIso);
      if (!isNaN(t) && (agora - t) <= limiteMs) {
        return true; // j√° viu recentemente
      }
    }
  } catch (e) {
    console.warn("Erro ao checar hist√≥rico recente do manual:", e);
  }
  return false;
}

// L√™ a pergunta do usu√°rio e, se fizer sentido, sugere um t√≥pico do Manual da Clara

function vektorSugerirManualAPartirDaPergunta(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);

    // Se o usu√°rio j√° pediu o manual explicitamente, n√£o sugerimos aqui
    if (
      norm.includes("manual clara") ||
      norm.includes("manual da clara") ||
      norm.includes("treinamento clara") ||
      norm.includes("treinamento da clara")
    ) {
      return;
    }

    let sugestao = null;

    // 1) Comprovante / nota / justificativa ‚Üí sugerir "Como anexar comprovante"
if (
  norm.includes("comprovante") ||
  norm.includes("nota fiscal") ||
  norm.includes(" nf ") ||
  norm.includes(" xml") ||
  norm.includes("justificativa") ||
  norm.includes("justificar") ||
  norm.includes("pendencia") ||
  norm.includes("pendencias") ||
  norm.includes("pend√™ncias") ||
  norm.includes("pend√™ncia")
) {
  // ‚ùó S√≥ sugere uma vez por sess√£o
  if (vektorSugestaoJaMostrada("manual_anexar_comprovante")) {
    return; // j√° sugeriu antes nesta sess√£o, n√£o repete
  }

  vektorMarcarSugestaoMostrada("manual_anexar_comprovante");

  sugestao = {
    secaoId: "anexar_comprovante",
    tituloBotao: "Ver como anexar comprovante",
    textoIntro:
      "Percebi que voc√™ est√° falando de nota fiscal, comprovante ou pend√™ncia. Quer abrir o trecho do Manual da Clara sobre isso?"
  };
}

    // 2) Problemas de login / primeiro acesso
    else if (
      norm.includes("primeiro acesso") ||
      norm.includes("primeiro login") ||
      norm.includes("junte-se a clara") ||
      norm.includes("junte se a clara") ||
      norm.includes("nao consigo acessar") ||
      norm.includes("n√£o consigo acessar") ||
      norm.includes("erro de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("primeiro_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "primeiro_acesso",
          tituloBotao: "Ver instru√ß√µes de primeiro acesso",
          textoIntro:
            "Se for sua primeira vez usando a Clara ou estiver com dificuldade de acesso, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 3) Esqueci a senha / senha do cart√£o
    else if (
      norm.includes("esqueci a senha") ||
      norm.includes("esqueci minha senha") ||
      norm.includes("senha do cartao") ||
      norm.includes("senha do cart√£o") ||
      norm.includes("senha de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("esqueci_senha", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "esqueci_senha",
          tituloBotao: "Ver como recuperar/consultar senha",
          textoIntro:
            "Voc√™ comentou sobre senha. Posso abrir a parte do Manual da Clara que fala sobre isso:"
        };
      }
    }

    // 4) Tipo de acesso / perfil
    else if (
      norm.includes("meu acesso") ||
      norm.includes("tipo de acesso") ||
      norm.includes("owner") ||
      norm.includes("manager") ||
      norm.includes("employee") ||
      norm.includes("contador")
    ) {
      if (!usuarioViuTopicoManualRecentemente("qual_meu_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "qual_meu_acesso",
          tituloBotao: "Ver tipos de acesso na Clara",
          textoIntro:
            "Se a d√∫vida √© sobre qual √© o seu tipo de acesso na Clara, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 5) D√∫vidas gerais, suporte, estorno, cart√£o perdido, etc.
    else if (
      norm.includes("duvida") ||
      norm.includes("d√∫vida") ||
      norm.includes("ajuda") ||
      norm.includes("suporte") ||
      norm.includes("telefone") ||
      norm.includes("0800") ||
      norm.includes("estorno") ||
      norm.includes("contestacao") ||
      norm.includes("contesta√ß√£o") ||
      norm.includes("perdi o cartao") ||
      norm.includes("perdi o cart√£o") ||
      norm.includes("cartao perdido") ||
      norm.includes("cart√£o perdido") ||
      norm.includes("cartao roubado") ||
      norm.includes("cart√£o roubado") ||
      norm.includes("bloquear cartao") ||
      norm.includes("bloquear cart√£o")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver d√∫vidas e canais de suporte",
          textoIntro:
            "Como voc√™ mencionou d√∫vidas, suporte, estorno ou perda/bloqueio de cart√£o, posso te mostrar o trecho do Manual da Clara com os principais contatos e orienta√ß√µes:"
        };
      }
    }

    // 6) Limite / aumento de limite / limite estourado
    else if (
      norm.includes("limite") ||
      norm.includes("aumentar limite") ||
      norm.includes("aumento de limite") ||
      norm.includes("ajustar limite") ||
      norm.includes("cart√£o sem limite limite") ||
      norm.includes("estourou o limite") ||
      norm.includes("limite estourado")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orienta√ß√µes gerais e canais de suporte",
          textoIntro:
            "Voc√™ falou sobre limite de cart√£o. Posso abrir a parte do Manual do usu√°rio da Clara com orienta√ß√µes gerais e canais de suporte para esse tipo de d√∫vida:"
        };
      }
    }

    // 7) Bloqueio por pend√™ncia / cart√£o recusado
    else if (
      norm.includes("cartao bloqueado") ||
      norm.includes("cart√£o bloqueado") ||
      norm.includes("cartao recusado") ||
      norm.includes("cart√£o recusado") ||
      norm.includes("nao aprovou") ||
      norm.includes("n√£o aprovou") ||
      norm.includes("recusou a compra") ||
      norm.includes("compra recusada")
    ) {
      if (!usuarioViuTopicoManualRecentemente("anexar_comprovante", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "anexar_comprovante",
          tituloBotao: "Ver como regularizar usando comprovantes",
          textoIntro:
            "Quando h√° bloqueios e recusas, muitas vezes o problema est√° em pend√™ncias de comprovantes. Quer ver o trecho do Manual que explica como anexar comprovantes e regularizar?"
        };
      }
    }

    // 8) Fraude / transa√ß√£o desconhecida / contesta√ß√£o
    else if (
      norm.includes("fraude") ||
      norm.includes("transacao desconhecida") ||
      norm.includes("transa√ß√£o desconhecida") ||
      norm.includes("lancamento indevido") ||
      norm.includes("lan√ßamento indevido") ||
      norm.includes("compra indevida")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orienta√ß√µes de contesta√ß√£o/estorno",
          textoIntro:
            "Voc√™ comentou sobre transa√ß√£o desconhecida ou poss√≠vel fraude. Posso abrir a parte do Manual do usu√°rio da Clara que fala sobre contesta√ß√£o e estorno:"
        };
      }
    }

    // Se nenhuma sugest√£o foi montada, sai
    if (!sugestao) return;

    const html =
  "HTML:<div class='text-sm text-slate-700 mt-2'>" +
    "<p>" + sugestao.textoIntro + "</p>" +
    "<button type='button' " +
      "onclick=\"vektorManualClaraSecao('" + sugestao.secaoId + "')\" " +
      "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
             "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
      sugestao.tituloBotao +
    "</button>" +
  "</div>";

// üîÅ Aguarda para dar tempo da resposta principal aparecer antes
setTimeout(function () {
  renderBotMessage(html);
  if (typeof scrollToBottom === "function") {
    scrollToBottom();
  }
}, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir t√≥pico do Manual da Clara:", e);
  }
}


// ========= SUGEST√ÉO AUTOM√ÅTICA DE T√ìPICOS RELACIONADOS ========= //

window.vektorSugerirTopicoRelacionadoManual = function (secaoId) {
  // Por enquanto vamos tratar apenas o caso "anexar_comprovante"
  if (secaoId !== "anexar_comprovante") return;

  // üîπ N√ÉO repetir essa sugest√£o v√°rias vezes na mesma sess√£o
  if (vektorSugestaoJaMostrada("politica_justificativas")) {
    return;
  }
  vektorMarcarSugestaoMostrada("politica_justificativas");

  const html =
    "HTML:<div class='text-sm text-slate-700 mt-2'>" +
      "<p><b>Sugest√£o:</b> Quer ver tamb√©m como funciona a <b>pol√≠tica de justificativas</b>?</p>" +
      "<div style='margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;'>" +
        "<button onclick=\"vektorAbrirPoliticaJustificativas()\" " +
                "class='px-3 py-2 rounded-md bg-[#005E27] text-white text-sm font-semibold'>" +
          "Ver pol√≠tica de justificativas" +
        "</button>" +
        "<button onclick=\"vektorIgnorarSugestaoPolitica()\" " +
                "class='px-3 py-2 rounded-md border text-sm'>" +
          "Agora n√£o" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
}

// Quando o usu√°rio clicar em "Ver pol√≠tica de justificativas"
window.vektorAbrirPoliticaJustificativas = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p><b>Pol√≠tica de justificativas (resumo):</b></p>" +
      "<ul style='margin-top:4px;margin-left:16px;'>" +
        "<li>‚Ä¢ Cada transa√ß√£o deve ter justificativa e comprovante anexado dentro de, no m√°ximo, 48 horas ap√≥s a cpmpra.</li><br>" +
        "<li>‚Ä¢ <b>Para justificar</b>: Inserir nota fiscal ou recibo da compra, informar a etiqueta do tipo de gasto e inserir no campo Descri√ß√£o o item adquirido.</li><br>" +
        "<li>‚Ä¢ Despesas sem justificativas ou com documentos inconsistentes podem ser questionadas pelo time Financeiro.</li><br>" +
        "<li>‚Ä¢ Em casos recorrentes, a empresa pode adotar medidas adicionais, como o bloqueio preventivo do cart√£o.</li>" +
      "</ul>" +
   // üîΩ AQUI ENTRA O LINK NO RODAP√â
      "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
        "Consulte a Pol√≠tica de Uso dos Cart√µes Clara: " +
        "<a href='" + POLITICA_CARTOES_CLARA_LINK + "' target='_blank' " +
        "style='color:#005E27;font-weight:bold;'>clique aqui para abrir</a>." +
      "</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// Caso ele clique em "Agora n√£o"
window.vektorIgnorarSugestaoPolitica = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p>Beleza. Se quiser ver a pol√≠tica de justificativas depois, √© s√≥ me pedir üòâ</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// ================= VEKTOR_STATE ‚Äì mem√≥ria leve da conversa =================
window.VEKTOR_STATE = {
  ultimaIntencao: null,         // ex: "ranking_lojas", "resumo_times", "fatura_times"
  ultimoPeriodo: null,          // { dataInicioIso, dataFimIso }
  ultimoGrupo: null,            // nome do time / grupo
  ultimaLoja: null,             // c√≥digo da loja
  ultimaAcaoExplicavel: null,   // meta da √∫ltima tabela gerada
  sugestoesMostradas: []        // controle de sugest√µes proativas para n√£o repetir
};

function vektorRegistrarContexto(evento) {
  try {
    if (!evento || typeof evento !== "object") return;

    window.VEKTOR_STATE = window.VEKTOR_STATE || {};
    Object.assign(window.VEKTOR_STATE, evento);
  } catch (e) {
    console.warn("Erro ao registrar contexto:", e);
  }
}

function vektorObterContexto() {
  return window.VEKTOR_STATE || {};
}

function vektorExplicarUltimaTabela() {
  const st = vektorObterContexto();
  const info = st.ultimaAcaoExplicavel;

  if (!info || !info.tipo) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Ainda n√£o tenho uma tabela recente para explicar. Tente pedir um ranking ou um resumo primeiro.</p>"
    );
    return;
  }

  let html = "HTML:<div class='text-sm text-slate-700'>";

  if (info.tipo === "tabela_ranking_lojas") {
    const m = info.meta || {};
    html +=
      "<p><b>Como essa tabela foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>‚Ä¢ Foram consideradas todas as transa√ß√µes da BaseClara no per√≠odo filtrado.</li>" +
        "<li>‚Ä¢ Agrupei os valores por <b>loja</b> e somei " +
          (m.criterio === "quantidade"
            ? "a quantidade de transa√ß√µes"
            : "o valor total em R$.") +
        "</li>" +
        (m.grupo
          ? "<li>‚Ä¢ Limitei somente √†s lojas do time <b>" + m.grupo + "</b>.</li>"
          : "") +
        (m.topN
          ? "<li>‚Ä¢ Mostrei apenas o <b>top " + m.topN + "</b> lojas, em ordem decrescente.</li>"
          : "<li>‚Ä¢ Listei todas as lojas com movimenta√ß√£o nesse per√≠odo.</li>") +
      "</ul>";
  } else if (info.tipo === "tabela_times") {
    const m = info.meta || {};
    html +=
      "<p><b>Como essa tabela de times foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>‚Ä¢ Usei as transa√ß√µes da BaseClara no per√≠odo selecionado.</li>" +
        "<li>‚Ä¢ Agrupei pelo campo <b>Grupo / Time</b> da planilha.</li>" +
        "<li>‚Ä¢ Para cada time, calculei quantidade de transa√ß√µes e valor total em R$.</li>" +
        "<li>‚Ä¢ Tamb√©m calculei o percentual de participa√ß√£o de cada time, em rela√ß√£o ao total do per√≠odo.</li>" +
      "</ul>";
  } else if (info.tipo === "tabela_times_fatura") {
    const m = info.meta || {};
    html +=
      "<p><b>Como a tabela de times dessa fatura foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>‚Ä¢ Primeiro filtrei as transa√ß√µes que pertencem ao <b>extrato</b> '" +
          (m.extrato || "") + "'.</li>" +
        "<li>‚Ä¢ Em seguida agrupei por <b>time</b>, somando o valor em R$ de cada um.</li>" +
        "<li>‚Ä¢ O per√≠odo usado √© o mesmo do ciclo de fatura mostrado na tabela anterior.</li>" +
      "</ul>";
  } else {
    html +=
      "<p>Ainda n√£o tenho uma explica√ß√£o espec√≠fica para esse tipo de tabela (" +
      info.tipo +
      "), mas posso te ajudar a interpretar os n√∫meros se voc√™ quiser.</p>";
  }

  html += "</div>";

  renderBotMessage(html);
}

function vektorSugestaoJaMostrada(id) {
  const st = vektorObterContexto();
  const lista = Array.isArray(st.sugestoesMostradas) ? st.sugestoesMostradas : [];
  return lista.indexOf(id) >= 0;
}

function vektorMarcarSugestaoMostrada(id) {
  if (!id) return;
  const st = vektorObterContexto();
  if (!Array.isArray(st.sugestoesMostradas)) {
    st.sugestoesMostradas = [];
  }
  if (st.sugestoesMostradas.indexOf(id) < 0) {
    st.sugestoesMostradas.push(id);
  }
}

var criterio = "quantidade";

// ========= MOTOR DE INTEN√á√ïES POR REGRAS =========

// Cada regra tem:
// - id: identificador da inten√ß√£o
// - minScore: pontua√ß√£o m√≠nima para considerar a regra "ganhadora"
// - score(norm, msgOriginal): fun√ß√£o que calcula um score com base no texto normalizado
// - run(msgOriginal, norm): fun√ß√£o que retorna o "resultado" da inten√ß√£o
const INTENT_RULES = [
  {
    id: "ACAO_LISTAR_ETIQUETAS_CLARA",
    minScore: 3,
      score: function (norm, msgOriginal) {
    if (!norm) return 0;
    let s = 0;

    const temEtiqueta =
      norm.includes("etiqueta") || norm.includes("etiquetas");

    if (!temEtiqueta) {
      // Se nem fala em etiqueta, essa inten√ß√£o n√£o faz sentido
      return 0;
    }

    // 1) Base: mencionou etiqueta ‚Üí 1 ponto (mas isso sozinho n√£o dispara a tabela)
    s += 1;

    // 2) Sinais de "vis√£o em tabela / lista consolidada"
    const falaTabela =
      norm.includes("tabela de etiquetas") ||
      norm.includes("tabela com as etiquetas") ||
      norm.includes("tabela das etiquetas") ||
      norm.includes("tabela") && temEtiqueta; // ex: "tabela por etiqueta"

    const falaLista =
      norm.includes("lista de etiquetas") ||
      norm.includes("listagem de etiquetas") ||
      norm.includes("listagem das etiquetas") ||
      norm.includes("ver todas as etiquetas") ||
      norm.includes("todas as etiquetas");

    if (falaTabela) s += 2;
    if (falaLista) s += 2;

    // 3) Sinais de an√°lise de gasto/percentual/valor
    const falaGasto =
      norm.includes("gasto por etiqueta") ||
      norm.includes("gastos por etiqueta") ||
      norm.includes("gastos por etiquetas") ||
      norm.includes("despesa por etiqueta") ||
      norm.includes("despesas por etiqueta") ||
      norm.includes("resumo por etiqueta") ||
      norm.includes("resumo de etiquetas") ||
      norm.includes("consolidado por etiqueta");

    const falaPercentual =
      norm.includes("percentual por etiqueta") ||
      norm.includes("porcentagem por etiqueta") ||
      norm.includes("percentual de uso das etiquetas") ||
      norm.includes("porcentagem de uso das etiquetas");

    const falaValor =
      norm.includes("valor por etiqueta") ||
      norm.includes("valores por etiqueta") ||
      norm.includes("quanto foi gasto em cada etiqueta");

    if (falaGasto) s += 2;
    if (falaPercentual) s += 2;
    if (falaValor) s += 2;

    // 4) Frases ‚Äúpedindo vis√£o gerencial‚Äù
    const falaVisao =
      norm.includes("visao por etiqueta") ||
      norm.includes("vis√£o por etiqueta") ||
      norm.includes("relatorio por etiqueta") ||
      norm.includes("relat√≥rio por etiqueta") ||
      norm.includes("ranking de etiquetas");

    if (falaVisao) s += 2;

    return s;
  },
  run: function (msgOriginal, norm) {
    return "ACAO_LISTAR_ETIQUETAS_CLARA";
  }}
];

  // ‚ûú Futuro: aqui voc√™ adiciona novas regras:
  // {
  //   id: "INTENT_FATURA_ATUAL",
  //   minScore: 2,
  //   score: function (norm, msgOriginal) { ... },
  //   run: function (msgOriginal, norm) { ... }
  // }
// ];

// Fun√ß√£o que escolhe a melhor regra com base em score
function aplicarRegraDeIntencao(msgOriginal) {
  const norm = normalize(msgOriginal || "");
  if (!INTENT_RULES || !INTENT_RULES.length) return null;

  let melhorRegra = null;
  let melhorScore = 0;

  for (const regra of INTENT_RULES) {
    try {
      const s = typeof regra.score === "function"
        ? Number(regra.score(norm, msgOriginal) || 0)
        : 0;

      if (s > melhorScore) {
        melhorScore = s;
        melhorRegra = regra;
      }
    } catch (e) {
      console.warn("Erro ao calcular score de inten√ß√£o:", regra && regra.id, e);
    }
  }

  if (!melhorRegra) return null;

  const min = typeof melhorRegra.minScore === "number" ? melhorRegra.minScore : 1;
  if (melhorScore < min) {
    // Nenhuma regra atingiu o limiar m√≠nimo
    return null;
  }

  // Executa a a√ß√£o da regra encontrada
  if (typeof melhorRegra.run === "function") {
    return melhorRegra.run(msgOriginal, norm);
  }

  return null;
}

// Fallback: quando nada casa, perguntar em vez de chutar resposta
function gerarPerguntaDeClarificacao(norm) {
  norm = norm || "";

  // Se a mensagem √© claramente sobre justificativa / nota / comprovante,
  // N√ÉO gera pergunta de clarifica√ß√£o (o fluxo de justificativa j√° responde).
  const ehJustificativa =
    norm.includes("justific") ||          // justificativa / justificar
    norm.includes("nota fiscal") ||
    norm.includes("nota da compra") ||
    norm.includes("perdi a nota") ||
    norm.includes("falta a nota") ||
    norm.includes("despesa sem nota") ||
    norm.includes("despesa sem comprovante") ||
    norm.includes("comprovante") ||
    norm.includes("comprovantes");

  if (ehJustificativa) {
    return ""; // devolve vazio para n√£o mostrar nada
  }

  const temasProvaveis = [];

  // Sinais de tema ‚Üí s√≥ pra deixar a pergunta mais ‚Äúesperta‚Äù
  if (norm.includes("pendenc")) {
    temasProvaveis.push("pend√™ncias da Clara");
  }
  if (norm.includes("justific")) {
    temasProvaveis.push("justificativas das transa√ß√µes");
  }
  if (norm.includes("fatura")) {
    temasProvaveis.push("faturas / ciclo de fatura");
  }
  if (norm.includes("bloqueio") || norm.includes("bloqueado")) {
    temasProvaveis.push("bloqueio ou desbloqueio do cart√£o");
  }
  if (norm.includes("limite")) {
    temasProvaveis.push("limite do cart√£o Clara");
  }
  if (
    norm.includes("nota fiscal") ||
    norm.includes("nf ") ||
    norm.includes("nf/") ||
    norm.includes("recibo")
  ) {
    temasProvaveis.push("nota fiscal / recibo / comprovantes");
  }

  // Se n√£o achou nenhum ‚Äúcheiro‚Äù‚Ä¶
  if (!temasProvaveis.length) {

    // üîπ 1) Primeiro: checa se √© caso de SANGRIA
    const falaSangria =
      norm.includes("sangria") ||
      norm.includes("sangrias") ||
      norm.includes("fazer sangria") ||
      norm.includes("como fazer sangria") ||
      norm.includes("puxar dinheiro do caixa") ||
      norm.includes("retirar dinheiro do caixa") ||
      norm.includes("tirar dinheiro do caixa") ||
      norm.includes("retirada de dinheiro do caixa") ||
      norm.includes("movimentacao de dinheiro no caixa") ||
      norm.includes("movimenta√ß√£o de dinheiro no caixa") ||
      norm.includes("saida de dinheiro do caixa") ||
      norm.includes("sa√≠da de dinheiro do caixa") ||
      norm.includes("suprimento") ||
      norm.includes("suprimentos") ||
      norm.includes("fazer suprimento") ||
      norm.includes("registro de sangria") ||
      norm.includes("registrando sangria");

    if (falaSangria) {
      // üî∏ IMPORTANTE:
      // retorna string vazia ‚Üí N√ÉO gera pergunta de clarifica√ß√£o.
      // Isso deixa o fluxo seguir at√© o motor da pol√≠tica
      // (detectarIntencaoPergunta -> "sangria" -> respSangria).
      return "";
    }

    // üîπ 2) Se n√£o √© sangria, usa a frase padr√£o de ‚Äún√£o entendi‚Äù
    const variacoes = [
      "N√£o tenho certeza se entendi sua pergunta. Voc√™ est√° falando de pend√™ncias, faturas, regras de uso do cart√£o ou outro assunto?",
      "Fiquei em d√∫vida sobre o que voc√™ quis dizer. √â algo sobre pend√™ncias, faturas ou regras de uso do cart√£o?",
      "Talvez eu esteja interpretando errado. Seu assunto √© pend√™ncias, faturas, pol√≠tica de uso do cart√£o ou outra coisa?",
      "Preciso de mais contexto. Sua d√∫vida envolve pend√™ncias, faturas, regras do cart√£o Clara ou √© outro tema?",
      "N√£o consegui identificar o assunto. Voc√™ queria saber sobre faturas, pend√™ncias, pol√≠tica de compras ou algo diferente?",
      "N√£o entendi completamente sua pergunta. Est√° relacionada a pend√™ncias, faturas, cart√£o Clara ou outro tema?"
    ];

    const frase = variacoes[Math.floor(Math.random() * variacoes.length)];

    return (
      "HTML:" +
      "<p class='text-sm text-slate-700'>" +
      frase +
      "</p>"
    );
  }

  // Se achou alguns temas, monta a frase usando eles
  const listaTemas = temasProvaveis
    .map(function (t) { return "<b>" + t + "</b>"; })
    .join(", ");

  return (
    "HTML:" +
    "<p class='text-sm text-slate-700'>" +
    "N√£o tenho certeza se entendi completamente. " +
    "Estou entendendo que pode ser algo relacionado a " + listaTemas + ". " +
    "Voc√™ consegue detalhar um pouco melhor o que precisa?" +
    "</p>"
  );
}

// Tenta entender respostas curtas depois da pergunta de clarifica√ß√£o

function tentarInterpretarRespostaClarificacao(norm) {
  let t = (norm || "").trim().toLowerCase();
  if (!t) return null;

  // normaliza acentos
  t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  const palavras = t.split(/\s+/).filter(Boolean);

  // 1) S√≥ trata respostas MUITO curtas (no m√°x. 3 palavras).
  // Se a pessoa escreveu uma frase mesmo ("valor das ultimas 3 faturas"),
  // N√ÉO √© clarifica√ß√£o, √© uma pergunta nova ‚Üí n√£o mexe.
  if (palavras.length > 3) {
    return null;
  }

  // 2) Se tem n√∫mero, "ultimas", "todas", "valor", "periodo", etc,
  // n√£o √© clarifica√ß√£o simples. Deixa passar sem reescrever.
  const temNumero = /\d/.test(t);
  const temDetalhe =
    t.includes("ultima") ||
    t.includes("ultimas") ||
    t.includes("todas") ||
    t.includes("valor") ||
    t.includes("periodo") ||
    t.includes("periodo") ||
    t.includes("historico") ||
    t.includes("quantidade");

  if (temNumero || temDetalhe) {
    return null;
  }

  // 3) Agora sim, mapeia respostas bem curtas
  // Ex.: "pendencias", "pend√™ncia clara"
  if (t.includes("pendenc")) {
    return "Quero consultar as pend√™ncias Clara da minha loja";
  }

  // Ex.: "fatura", "faturas"
  if (t.includes("fatura")) {
    return "Quero ver as faturas da Clara";
  }

  // Ex.: "regras", "politica", "uso do cartao"
  if (
    t.includes("regra") ||
    t.includes("regras") ||
    t.includes("politica") ||
    t.includes("politicas") ||
    t.includes("politica de uso") ||
    t.includes("uso do cartao") ||
    t.includes("uso do cart√£o")
  ) {
    return "Quero tirar d√∫vidas sobre a pol√≠tica de uso do cart√£o Clara";
  }

  // Se n√£o encaixar em nada, n√£o for√ßa interpreta√ß√£o
  return null;
}

// üß† Engine simples de insights em cima de faturas
function analisarFaturas(faturas) {
  try {
    if (!Array.isArray(faturas) || faturas.length === 0) {
      return "";
    }

    // Normaliza estrutura e garante que temos valor num√©rico e um r√≥tulo
    const lista = faturas
      .map(function (f, idx) {
        // tenta achar um campo de valor num√©rico entre algumas possibilidades
        const valorRaw =
          f.valorFatura ??
          f.valor_fatura ??
          f.valor_total ??
          f.valor ??
          f.total ??
          0;

        const valor = Number(valorRaw) || 0;

        // tenta achar um r√≥tulo amig√°vel
        const rotulo =
          f.rotulo ||
          f.label ||
          f.referencia ||
          f.mesReferencia ||
          f.mes ||
          f.periodo ||
          f.descricao ||
          ("Fatura " + (idx + 1));

        // tenta achar algo que represente "ordem temporal"
        const chaveOrdenacao =
          f.dataReferencia ||
          f.data_fatura ||
          f.dataVencimento ||
          f.data_vencimento ||
          f.mesReferencia ||
          f.periodo ||
          rotulo;

        return {
          original: f,
          valor: valor,
          rotulo: String(rotulo),
          chave: String(chaveOrdenacao)
        };
      })
      .filter(function (f) {
        return f.valor > 0;
      });

    if (lista.length === 0) {
      return "";
    }

    // Ordena por chave (como proxy de tempo)
    lista.sort(function (a, b) {
      if (a.chave < b.chave) return -1;
      if (a.chave > b.chave) return 1;
      return 0;
    });

    const total = lista.reduce(function (acc, f) {
      return acc + f.valor;
    }, 0);

    const media = total / lista.length;

    // maior e menor fatura
    var maior = lista[0];
    var menor = lista[0];

    for (var i = 1; i < lista.length; i++) {
      if (lista[i].valor > maior.valor) maior = lista[i];
      if (lista[i].valor < menor.valor) menor = lista[i];
    }

    // varia√ß√£o da √∫ltima em rela√ß√£o √† anterior, se houver pelo menos 2
    var variacaoTexto = "";
    if (lista.length >= 2) {
      const penultima = lista[lista.length - 2];
      const ultima = lista[lista.length - 1];

      if (penultima.valor > 0) {
        const dif = ultima.valor - penultima.valor;
        const perc = (dif / penultima.valor) * 100;

        if (Math.abs(perc) >= 3) { // ignora varia√ß√£o muito pequena
          const direcao = perc > 0 ? "aumento" : "queda";
          variacaoTexto =
            "A fatura mais recente (" +
            ultima.rotulo +
            ") teve um " +
            direcao +
            " de aproximadamente " +
            perc.toFixed(1).replace(".", ",") +
            "% em rela√ß√£o √† anterior (" +
            penultima.rotulo +
            ").";
        } else {
          variacaoTexto =
            "A fatura mais recente (" +
            ultima.rotulo +
            ") ficou em linha com a anterior (" +
            penultima.rotulo +
            "), sem varia√ß√£o relevante de valor.";
        }
      }
    }

    // texto de resumo
    var html =
      "<div class='mt-3 p-3 rounded-lg border border-slate-200 bg-slate-50 text-xs text-slate-700'>" +
      "<p class='font-semibold mb-1'>Observa√ß√µes autom√°ticas sobre essas faturas:</p>" +
      "<ul class='list-disc ml-4 space-y-1'>" +
      "<li>Foram consideradas <b>" + lista.length + "</b> faturas, com valor m√©dio de aproximadamente <b>R$ " +
      media.toFixed(2).replace(".", ",") +
      "</b>.</li>" +
      "<li>A fatura de <b>" + maior.rotulo + "</b> foi a de <b>maior valor</b> no conjunto exibido.</li>" +
      "<li>A fatura de <b>" + menor.rotulo + "</b> foi a de <b>menor valor</b>.</li>";

    if (variacaoTexto) {
      html += "<li>" + variacaoTexto + "</li>";
    }

    html +=
      "</ul>" +
      "<p class='mt-2 text-[11px] text-slate-500'>" +
      "Essas observa√ß√µes s√£o um resumo autom√°tico em cima das faturas mostradas na tabela, " +
      "para te ajudar a identificar rapidamente extremos e tend√™ncias.</p>" +
      "</div>";

    return html;
  } catch (e) {
    // se der qualquer problema, n√£o quebra o chat; s√≥ n√£o mostra insight
    console.error("Erro em analisarFaturas:", e);
    return "";
  }
}

// üîé Tenta extrair um array de linhas padr√£o (categoria/estabelecimento) do resultado do Apps Script
function vektorExtrairListaResumoChave(res) {
  if (!res) return [];

  // Se j√° vier um array direto
  if (Array.isArray(res)) return res;

  // Tenta achar propriedades comuns
  const possiveis = [
    "dados",
    "itens",
    "linhas",
    "registros",
    "categorias",
    "estabelecimentos",
    "lista"
  ];

  for (const nome of possiveis) {
    if (Array.isArray(res[nome])) {
      return res[nome];
    }
  }

  return [];
}

// üí° Gera insights autom√°ticos para categoria/estabelecimento (m√©dia por transa√ß√£o)
function gerarInsightsResumoChaveCategoriaEstab(res, opcoes) {
  try {
    const tipoChave = (opcoes && opcoes.tipoChave) || "";
    // S√≥ faz sentido para Categoria ou Estabelecimento
    if (tipoChave !== "Categoria" && tipoChave !== "Estabelecimento") {
      return "";
    }

    const listaBruta = vektorExtrairListaResumoChave(res);
    if (!Array.isArray(listaBruta) || listaBruta.length < 2) {
      return "";
    }

    // Normaliza: tenta achar chave (nome), valor total e quantidade
    const itens = listaBruta
      .map(function (item, idx) {
        const nome =
          item.chave ||
          item.nome ||
          item.descricao ||
          item.descricaoChave ||
          item.categoria ||
          item.estabelecimento ||
          ("Item " + (idx + 1));

        const valorRaw =
          item.valorTotal ||
          item.totalValor ||
          item.valor_total ||
          item.valor ||
          item.total ||
          0;

        const qtdRaw =
          item.qtdTransacoes ||
          item.qtd_transacoes ||
          item.quantidade ||
          item.qtd ||
          item.numTransacoes ||
          0;

        const valor = Number(valorRaw) || 0;
        const qtd = Number(qtdRaw) || 0;

        // Se n√£o tiver quantidade, n√£o d√° pra falar de "m√©dia por transa√ß√£o"
        if (valor <= 0 || qtd <= 0) {
          return null;
        }

        return {
          nome: String(nome),
          valor: valor,
          qtd: qtd,
          media: valor / qtd
        };
      })
      .filter(function (x) {
        return x !== null;
      });

    if (itens.length < 2) {
      return "";
    }

    // Acha maior e menor m√©dia
    let maior = itens[0];
    let menor = itens[0];

    for (let i = 1; i < itens.length; i++) {
      const it = itens[i];
      if (it.media > maior.media) maior = it;
      if (it.media < menor.media) menor = it;
    }

    const labelColecao =
      tipoChave === "Categoria" ? "categorias" : "estabelecimentos";
    const labelSingular =
      tipoChave === "Categoria" ? "categoria" : "estabelecimento";

    const mediaMaior = maior.media.toFixed(2).replace(".", ",");
    const mediaMenor = menor.media.toFixed(2).replace(".", ",");

    let html =
      "<div class='mt-3 p-3 rounded-lg border border-slate-200 bg-slate-50 text-xs text-slate-700'>" +
      "<p class='font-semibold mb-1'>Insights autom√°ticos sobre os " + labelColecao + ":</p>" +
      "<ul class='list-disc ml-4 space-y-1'>" +
      "<li>O " + labelSingular + " <b>" + maior.nome + "</b> apresenta a <b>maior m√©dia de valor por transa√ß√£o</b> no per√≠odo, em torno de <b>R$ " + mediaMaior + "</b>.</li>" +
      "<li>O " + labelSingular + " <b>" + menor.nome + "</b> apresenta a <b>menor m√©dia de valor por transa√ß√£o</b> no per√≠odo, em torno de <b>R$ " + mediaMenor + "</b>.</li>" +
      "</ul>" +
      "<p class='mt-2 text-[11px] text-slate-500'>" +
      "Essa m√©dia √© calculada dividindo o valor total gasto pela quantidade de transa√ß√µes de cada " + labelSingular +
      " no per√≠odo consultado.</p>" +
      "</div>";

    return html;
  } catch (e) {
    console.error("Erro em gerarInsightsResumoChaveCategoriaEstab:", e);
    return "";
  }
}



    /* ========= GERADOR FINAL ========= */

function gerarRespostaDoBot(msgUsuario, vindoDaClarificacao = false) {
  const norm = normalize(msgUsuario || "");

  // üîπ LOG GLOBAL: tudo que o usu√°rio digita
  vektorRegistrarMetrica(
    "user_raw",           // intencao
    msgUsuario,           // mensagem original
    norm,                 // norm
    "entrada",            // resultado
    "RawMessageUsuario",  // t√≥pico
    "gerarRespostaDoBot"  // fun√ß√£o de origem
  );

  // üîπ 0.5: se a frase parece ser s√≥ uma resposta curta √† clarifica√ß√£o,
  // reinterpreta UMA √öNICA VEZ como uma pergunta completa que o motor j√° entende
  if (!vindoDaClarificacao) {
    const reescrita = tentarInterpretarRespostaClarificacao(norm);
    if (reescrita) {
      // chama de novo o gerador, marcando que j√° viemos da clarifica√ß√£o
      return gerarRespostaDoBot(reescrita, true);
    }
  }

    // üîπ 1¬™ camada: motor de inten√ß√µes por regras
  const resultadoIntencao = aplicarRegraDeIntencao(msgUsuario);

  // Se alguma regra reconheceu a inten√ß√£o e retornou algo, usamos isso.
  // Exemplos de retorno:
  // - "ACAO_LISTAR_ETIQUETAS_CLARA" (token para a√ß√£o externa)
  // - "HTML:..." (resposta pronta)
  // - texto simples
  if (resultadoIntencao !== null && resultadoIntencao !== undefined) {
    return resultadoIntencao;
  }

  // üîπ 2¬™ camada: fallback para os gatilhos antigos baseados em includes
    // Gatilho: usu√°rio quer entender a √∫ltima tabela
  if (
          norm.includes("explica essa tabela") ||
          norm.includes("explica essa fatura") ||
          norm.includes("como voce calculou") ||
          norm.includes("como vc calculou") ||
          norm.includes("como foi calculado") ||
          norm.includes("como foi gerado") ||
          norm.includes("de onde veio essa tabela")
  ) {
    vektorExplicarUltimaTabela();
    return null; // mant√©m padr√£o: fun√ß√£o j√° renderiza no chat
  }

  // Treinamento Clara - apresenta√ß√£o em Slides
if (
  norm.includes("treinamento clara") ||
  norm.includes("treinamento do cartao clara") ||
  norm.includes("treinamento do cart√£o clara") ||
  norm.includes("treinamento sobre uso do cartao") ||
  norm.includes("treinamento sobre uso do cart√£o")
) {
  const htmlTreinamento = `HTML:
<div class="text-sm text-slate-700">

  <h2 style="font-size: 1.1rem; font-weight: 700; text-align: center; margin-top: -8px; margin-bottom: 8px;">
    Treinamento oficial sobre o uso do cart√£o Clara
  </h2>

  <p class="mb-2" style="text-align:center; margin-top: -4px;">
    Use esta apresenta√ß√£o para refor√ßar boas pr√°ticas com o time da loja:

  <div style="position:relative;padding-bottom:62%;height:0;overflow:hidden;max-width:100%;
              border-radius:8px;border:1px solid #ddd;">
    <iframe
      src="https://docs.google.com/presentation/d/e/2PACX-1vRTlL30pbq4rkyBlo0cLHgE3Tqeg_bLaWlIBY20tSzEdIS5QlIuWRjIv4A1j_Lfnb9_gaZ6woWJ7SDh/pubembed?start=false&loop=false&delayms=3000"
      frameborder="0"
      style="position:absolute;top:0;left:0;width:100%;height:100%;"
      allowfullscreen="true"
      mozallowfullscreen="true"
      webkitallowfullscreen="true">
    </iframe>
  </div>

  <p class="mt-2 text-xs text-slate-500" style="text-align:center;">
    Se preferir, abra em tela cheia pelo bot√£o dispon√≠vel na apresenta√ß√£o.
  </p>

</div>`;

  return htmlTreinamento;
}

// ======================================================================
// RELAT√ìRIO GERENCIAL ‚Äì incorpora Looker e manda link em mensagem separada
// ======================================================================
if (
  norm.includes("abrir relatorio gerencial") ||
  norm.includes("abrir relat√≥rio gerencial") ||
  norm.includes("relatorio gerencial da clara") ||
  norm.includes("relat√≥rio gerencial da clara") ||
  norm.includes("relatorio gerencial") ||
  norm.includes("relat√≥rio gerencial")
) {
  // 1) Envia o relat√≥rio incorporado (iframe)
  renderBotMessage("HTML:" + htmlRelatorioGerencial);

  return;
}

    // Uso respons√°vel do limite do cart√£o Clara
  if (
    norm.includes("usar bem o limite") ||
    (norm.includes("limite") && norm.includes("usar")) ||
    norm.includes("uso do limite do cartao") ||
    norm.includes("uso do limite do cart√£o")
  ) {
    return "HTML:<div class='text-sm text-slate-700'>"
      + "<p class='mb-2'>"
      + "O limite do cart√£o Clara foi definido para cobrir, com seguran√ßa, os gastos previstos do ciclo de fatura "
      + "(de <b>06</b> at√© <b>05</b> do m√™s seguinte). Para usar bem esse limite, sem precisar aumentar durante o m√™s, "
      + "considere estas pr√°ticas:"
      + "</p>"
      + "<ul class='list-disc ml-4 space-y-1'>"
      + "<li><b>Planeje o m√™s pelo ciclo da fatura:</b> some os gastos previstos entre os dias 06 e 05 e verifique se cabem no limite dispon√≠vel.</li>"
      + "<li><b>Priorize despesas operacionais essenciais:</b> use o cart√£o principalmente para despesas previstas na pol√≠tica (ex.: material de escrit√≥rio, manuten√ß√£o, marketing autorizado, etc.).</li>"
      + "<li><b>Evite concentrar grandes compras no in√≠cio do ciclo:</b> isso pode travar o limite e impedir compras importantes mais para o fim do m√™s.</li>"
      + "<li><b>Prefira compras √† vista ou com poucos parcelamentos:</b> parcelamentos longos consomem o limite pelos pr√≥ximos ciclos e reduzem a flexibilidade da loja.</li>"
      + "<li><b>Acompanhe o uso do limite ao longo do m√™s:</b> consulte o extrato da Clara e os relat√≥rios do Vektor para ver quanto j√° foi utilizado e o que ainda est√° dispon√≠vel.</li>"
      + "<li><b>Reserve uma margem para imprevistos:</b> evite usar 100% do limite com despesas previs√≠veis; mantenha uma folga para emerg√™ncias dentro da pol√≠tica.</li>"
      + "<li><b>Evite compras fora da pol√≠tica:</b> gastos n√£o permitidos podem ser bloqueados ou precisar de reembolso, al√©m de consumir o limite de forma indevida.</li>"
      + "</ul>"
      + "<p class='mt-2'>"
      + "Se mesmo seguindo essas orienta√ß√µes o limite estiver sempre no m√°ximo, vale revisar o planejamento de gastos da loja "
      + "e, se for o caso, discutir um ajuste de limite com o time respons√°vel, com base em dados de uso recorrente."
      + "</p>"
      + "</div>";
  }

  // INTEN√á√ÉO: listar etiquetas da Clara (BaseClara, coluna T)
  if (
    norm.includes("listagem de etiquetas") ||
    norm.includes("lista de etiquetas") ||
    norm.includes("etiquetas disponiveis") ||
    norm.includes("etiquetas dispon√≠veis") ||
    norm.includes("etiquetas da clara") ||
    norm.includes("etiquetas na clara")
  ) {
    return "ACAO_LISTAR_ETIQUETAS_CLARA";
  }

  // üÜï Resposta espec√≠fica para o ciclo da fatura da Clara
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("per√≠odo da fatura")
  ) {
    return "HTML:<p class='text-sm text-slate-700'>" +
      "O <b>ciclo da fatura da Clara</b> funciona assim:<br><br>" +
      "‚Ä¢ As compras realizadas entre <b>o dia 6</b> de cada m√™s e <b>o dia 5</b> do m√™s seguinte s√£o " +
      "agrupadas na mesma fatura.<br>" +
      "‚Ä¢ Tudo o que for gasto dentro desse intervalo entra para pagamento nessa fatura do per√≠odo.<br><br>" +
      "Em resumo: o ciclo vai sempre de <b>06</b> a <b>05</b>, e todas as compras feitas nesse per√≠odo " +
      "entram juntas na mesma fatura.</p>";
  }

  // === Gatilho para o MINI MANUAL DA CLARA ===
  if (
    norm.includes("manual clara") ||
    norm.includes("manual da clara") ||
    (norm.includes("manual") && norm.includes("clara")) ||
    norm.includes("treinamento clara") ||
    norm.includes("treinamento do cartao clara") ||
    norm.includes("treinamento do cart√£o clara")
  ) {

    
    const htmlPartes = [];

    htmlPartes.push(
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Posso te ajudar a tirar d√∫vidas sobre o uso do cart√£o da Clara.</b> Escolha um dos t√≥picos abaixo üëá</p>" +
        "<div class='mt-3 flex flex-col gap-2'>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('primeiro_acesso')\">" +
        "01 Primeiro acesso" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('recebi_cartao')\">" +
        "02 Recebi o cart√£o, e agora?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('esqueci_senha')\">" +
        "03 Esqueci a senha do cart√£o" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('qual_meu_acesso')\">" +
        "04 Qual o meu acesso?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('anexar_comprovante')\">" +
        "05 Como anexar comprovante?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('duvidas')\">" +
        "06 D√∫vidas" +
      "</button>"
    );

    htmlPartes.push("</div></div>");

    const htmlFinal = htmlPartes.join("");
    return "HTML:" + htmlFinal;
  }

  // üÜï TODAS AS LOJAS DO TIME XXXXX
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasDoTime = detectarListarTodasLojasDoTime(msgUsuario, norm);
  
  if (detTodasLojasDoTime) {
    const grupo = detTodasLojasDoTime.grupo;
    const p = detTodasLojasDoTime.periodo;
    const tipo = detTodasLojasDoTime.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Montando a <b>rela√ß√£o de todas as lojas do time " + grupo + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todas as lojas do time
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: true,   // j√° faz tabela de lojas por time
          groupName: grupo
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
          "Tive um problema ao consultar os dados para listar as lojas do time " + grupo + ".</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        grupo,          // time solicitado
        dataInicioStr,
        dataFimStr,
        tipo
      );

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    return null;
  }
}

  // üÜï LOJAS / LOJA COM MAIS PEND√äNCIAS (por time)
  if (
    (norm.includes("loja com mais pendenc") ||
     norm.includes("lojas com mais pendenc"))
  ) {
    // Per√≠odo (reaproveita o mesmo engine)
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // Tenta extrair o time da pr√≥pria frase
    const grupo = extrairGrupo(msgUsuario, norm);

    if (!grupo) {
      return "HTML:<p class='text-sm text-slate-700'>" +
        "Para eu listar as <b>lojas com mais pend√™ncias</b>, preciso saber de <b>qual time</b>." +
        "<br>Exemplo de pergunta completa: " +
        "<i>Lojas com mais pend√™ncias do time XYZ neste m√™s / na √∫ltima semana, nessa semana etc</i>." +
        "</p>";
    }

    vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso);
    return null;
  }

    // TODAS AS PEND√äNCIAS DO TIME XXXXX  ‚Üí consolida√ß√£o por loja daquele time
  
    if (
  (
    norm.includes("todas as pendenc") && norm.includes("do time")
  ) ||
  (
    norm.includes("pendenc") && norm.includes("do time")
  )
) {
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    const grupo = extrairGrupo(msgUsuario, norm);

    if (!grupo) {
      return "HTML:<p class='text-sm text-slate-700'>" +
        "Para listar <b>todas as pend√™ncias de um time</b>, preciso que voc√™ informe o nome completo do time na frase." +
        "<br>Exemplo: <i>Todas as pend√™ncias do time Lobos SP neste m√™s</i>." +
        "</p>";
    }

    vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso);
    return null;
  }

  // TODAS AS PEND√äNCIAS POR TIME  ‚Üí consolida√ß√£o por time (todas as equipes)
  if (
    (norm.includes("todas as pendenc") && norm.includes("por time")) ||
    norm.includes("time com mais pendenc")
  ) {
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    vektorMostrarPendenciasPorTimeTodos(dataInicioIso, dataFimIso);
    return null;
  }

  // Gatilho pend√™ncias (quando n√£o h√° fluxo pend√™ncias em aberto)

    if (estadoPendencias === "nenhum" &&
    termosPendencias.some(t => norm.includes(t))) {

    // tenta extrair n√∫mero de loja j√° presente na mensagem (2 a 6 d√≠gitos)
    const matchLoja = msgUsuario.match(/\b(\d{2,6})\b/);

    if (matchLoja) {
        const lojaBruta = matchLoja[1];
        const lojaNormalizada = lojaBruta.replace(/\D/g, "");

        lojaPendenciasAtual = lojaNormalizada;
        ultimaPendenciaResumo = null;
        estadoPendencias = "aguardando_confirmacao_email";

        // üÜï busca nome da loja antes de responder
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}${nomeLojaTxt}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );

            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .withFailureHandler((err) => {
            // fallback se der erro no BigQuery
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );
            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .obterNomeLojaBigQuery(lojaNormalizada);

        return null; // n√£o retorna outro texto (renderBotMessage j√° enviou)
    }

    // caso n√£o tenha n√∫mero na frase, segue fluxo normal pedindo a loja
    estadoPendencias = "aguardando_loja";
    lojaPendenciasAtual = "";
    ultimaPendenciaResumo = null;

    return `HTML:<p class="text-sm text-slate-700">
    Consigo consultar as pend√™ncias de justificativas Clara da sua loja. Me informe o c√≥digo da loja (somente n√∫meros), por exemplo: <b>0123</b>.
    </p>`;
}

// ===== NOVA A√á√ÉO: Maiores transa√ß√µes individuais (loja / time) =====
var detTopTrans = detectarMaioresTransacoesIndividuais(msgUsuario, norm);
if (detTopTrans) {
  var grupo = detTopTrans.grupo || "";
  var loja  = detTopTrans.loja  || "";
  var periodo = detTopTrans.periodo || null;
  var topN = detTopTrans.topN;

  if (!topN || topN <= 0) {
    topN = 10; // default se o usu√°rio n√£o falar Top
  }

  var dataInicioIso = "";
  var dataFimIso = "";

  if (periodo && periodo.dataInicio && periodo.dataFim) {
    try {
      dataInicioIso = periodo.dataInicio.toISOString();
      dataFimIso    = periodo.dataFim.toISOString();
    } catch (e) {
      console.warn("N√£o consegui converter per√≠odo para ISO em maiores transa√ß√µes:", e);
    }
  }

  // feedback r√°pido no chat
  var textoLoading = "Vou buscar as <b>maiores transa√ß√µes individuais</b> ";
  if (loja)  textoLoading += "da loja <b>" + loja + "</b> ";
  if (grupo) textoLoading += "do time <b>" + grupo + "</b> ";
  if (periodo) {
    textoLoading += "no per√≠odo informado...";
  } else {
    textoLoading += "nos √∫ltimos 30 dias...";
  }

  renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + textoLoading + "</p>");

  try {
    google.script.run
      .withSuccessHandler(function (res) {
        renderMaioresTransacoesIndividuais(res);
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script maiores transa√ß√µes:", err);
        renderBotMessage("N√£o consegui consultar as maiores transa√ß√µes individuais agora.");
      })
      .getMaioresTransacoesIndividuais(
        grupo,
        loja,
        dataInicioIso,
        dataFimIso,
        topN
      );
  } catch (e) {
    console.error("Falha geral ao chamar getMaioresTransacoesIndividuais:", e);
    renderBotMessage("Ocorreu um erro ao buscar as maiores transa√ß√µes individuais.");
  }

  // registra inten√ß√£o para m√©tricas
  try { ultimaIntencao = "maiores_transacoes_individuais"; } catch (e) {}

  return; // importante para n√£o cair no fluxo gen√©rico
}

  // üÜï TIMES ESPEC√çFICOS (ex.: "times √Åguias do Cerrado e Lobos SP no per√≠odo ...")

  const detTimesEspec = detectarTimesEspecificosLista(msgUsuario, norm);
  if (detTimesEspec && detTimesEspec.times && detTimesEspec.times.length > 1) {
    const listaTimes = detTimesEspec.times;
    const p          = detTimesEspec.periodo;
    const tipo       = detTimesEspec.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï Guarda per√≠odo em formato ISO para os insights (times/lojas)
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou comparar apenas os times <b>" + listaTimes.join(", ") + "</b> " +
        "por " + (tipo === "valor" ? "<b>valor total</b>" : "<b>quantidade de transa√ß√µes</b>") +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesPorTime(res, {
          topN: null,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados para esses times.</p>"
        );
      })
      .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

    return null;
  }


// >>> RANKING DE TIMES (top N)
const detRankTimes = detectarRankingTimes(msgUsuario, norm);
if (detRankTimes) {
  const p    = detRankTimes.periodo;
  const tipo = detRankTimes.tipo || "valor";      // "valor" ou "quantidade"
  const topN = detRankTimes.topN ?? 10;           // padr√£o: 10
  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

   // üÜï Guarda per√≠odo em ISO para os insights de maior transa√ß√£o
  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioStr || "",
    fim:    dataFimStr    || ""
  };

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de times</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesPorTime(res, { topN: topN });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // igual ao seu bloco de "detTimes", encerra aqui
}


function detectarConsultasTimes(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);

  // plural por quantidade (listar TODOS)
  if (t.includes("times com maior numero de transacoes") || t.includes("times com mais transacoes") ||
      t.includes("times com mais transacao") || t.includes("times com maior quantidade de transacoes")) {
    return { periodo, tipo: "quantidade", topN: null, modo: "plural" };
  }

  // plural por valor (listar TODOS)
  if (t.includes("quais times mais gastaram") || t.includes("times com maior valor de transacoes") ||
      t.includes("times que mais gastaram")) {
    return { periodo, tipo: "valor", topN: null, modo: "plural" };
  }

  // singular -> top 1 por valor
  if (t.includes("qual time mais gastou") || t.includes("time com maior valor de transacoes")) {
    return { periodo, tipo: "valor", topN: 1, modo: "singular" };
  }

  return null;
}

// =========== DETECTOR: "TIMES X E Y NO PER√çODO" =========== //

function detectarTimesEspecificosLista(msgOriginal, norm) {
  const t = norm || "";

  // se falar de LOJA(S), essa fun√ß√£o N√ÉO deve tratar
  if (!t.includes("time") || t.includes("loja") || t.includes("lojas")) {
    return null;
  }

  const lista = (typeof encontrarListaTimesNaMensagem === "function"
    ? (encontrarListaTimesNaMensagem(msgOriginal) || [])
    : []);

  if (!lista.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: lista,
    periodo,
    tipo
  };
}

if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detRankLoja = detectarRankingLojas(msgUsuario, norm);
if (detRankLoja) {
  const periodo = detRankLoja.periodo;
  const tipo    = detRankLoja.tipo || "valor";
  const grupo   = detRankLoja.grupo || "";
  const topNReq = detRankLoja.topN; // pode ser null

  // üìå Regra de TOP:
  // - Se o usu√°rio falar "top X" ‚Üí usa X
  // - Se N√ÉO falar top e N√ÉO tiver time ‚Üí padr√£o = 10
  // - Se N√ÉO falar top e TIVER time ‚Üí deixa null pra listar todas as lojas do time
  const topNFinal = (topNReq != null)
    ? topNReq
    : (grupo ? null : 10);

  // Aviso: ranking geral de lojas (sem time) e sem "top" informado => mostraremos 10
  if (!grupo && topNReq == null) {
    renderBotMessage(
      "HTML:<p class='text-xs text-slate-600 italic'>Obs.: Como o n√∫mero de lojas √© grande, mostrarei as <b>10 primeiras</b> por padr√£o. Voc√™ pode pedir, por exemplo, <b>top 20 lojas</b>.</p>"
    );
  }

  vektorRegistrarContexto({
  ultimaIntencao: "ranking_lojas",
  ultimoPeriodo: periodo || null,
  ultimoGrupo: grupo || null,
  ultimaLoja: null,
  ultimaAcaoExplicavel: {
    tipo: "tabela_ranking_lojas",
    meta: {
      criterio: criterio,
      grupo: grupo || null,
      topN: topNFinal || null
    }
  }
});

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de lojas</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    (periodo ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, {
        topN: topNFinal,        // respeita TOP pedido (ou 10 / null)
        forGroup: !!grupo       // true se estiver filtrando por time
      });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// 2) LOJAS (plural) sem top/ranking  -> lista TODAS do time
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detLojasPlural = detectarLojasMaisTransacoesPlural(msgUsuario, norm);
if (detLojasPlural) {
  const periodo = detLojasPlural.periodo;
  const tipo    = detLojasPlural.tipo || "valor";
  const grupo   = detLojasPlural.grupo || ""; // se vier time, listaremos TODAS as lojas do time
  const topN    = null; // for√ßa 'todas'

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou listar <b>todas as lojas</b> " +
    (grupo ? "do time <b>" + grupo + "</b> " : "") +
    "ordenadas por " + (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
  const n = (topN == null && !grupo) ? 10 : topN; // 10 s√≥ no geral; por time voc√™ decide
  renderResumoTransacoesSemana(res, { topN: n, forGroup: true });
})
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja por time).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// === NOVO: CONSULTAS POR CATEGORIA (BaseClara) ===
const detCategorias = detectarPerguntaCategorias(msgUsuario, norm);
if (detCategorias) {
  const periodo = detCategorias.periodo;
  const tipo    = detCategorias.tipo || "valor";
  const topN    = detCategorias.topN;

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por categoria</b> " +
    (tipo === "valor" ? "considerando <b>valor</b>" : "por <b>quantidade de transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : " em toda a base") +
    "‚Ä¶</p>"
  );

  google.script.run
        .withSuccessHandler(function (res) {
      // 1) Monta a tabela normal (como j√° fazia)
      renderResumoPorChaveGenerico(res, {
        tipoChave: "Categoria",
        titulo: (tipo === "valor"
          ? "Categorias com maior valor de transa√ß√µes"
          : "Categorias com maior quantidade de transa√ß√µes"),
        topN: topN
      });

      // 2) Se estiver olhando para VALOR, gera insight de m√©dia por transa√ß√£o
      if (tipo === "valor") {
        const htmlInsights = gerarInsightsResumoChaveCategoriaEstab(res, {
          tipoChave: "Categoria"
        });
        if (htmlInsights) {
          renderBotMessage("HTML:" + htmlInsights);
        }
      }
    })

    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por categoria.</p>");
    })
    .getResumoTransacoesPorCategoria(
      dataInicioStr,
      dataFimStr,
      tipo
    );

  return null;
}

// === NOVO: CONSULTAS POR ESTABELECIMENTO / LOCAL (BaseClara) ===
const detEstab = detectarPerguntaEstabelecimentos(msgUsuario, norm);
if (detEstab) {
  const periodo = detEstab.periodo;
  const tipo    = detEstab.tipo || "valor";
  const topN    = detEstab.topN;
  const grupo   = detEstab.grupo || "";
  const loja    = detEstab.loja  || "";

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  let contexto = "";
  if (grupo) contexto += " para o time <b>" + grupo + "</b>";
  if (loja)  contexto += (contexto ? " e " : " para ") + "a loja <b>" + loja + "</b>";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por estabelecimento</b>" +
    contexto +
    (tipo === "valor" ? " com foco em <b>valor</b>" : " por <b>quantidade de transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : " em toda a base") +
    "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // Monta o t√≠tulo com destaque e indica√ß√£o de Top N
      const tituloBase = (tipo === "valor"
        ? "<b>Locais com maior valor de gastos</b> - Top 10"
        : "<b>Locais com maior quantidade de transa√ß√µes</b>");

      const sufixoTop = (typeof topN === "number" && topN > 0)
        ? (" - Top " + topN)
        : "";

      renderResumoPorChaveGenerico(res, {
        tipoChave: "Estabelecimento",
        titulo: tituloBase + sufixoTop,
        topN: topN
      });

      // 2) Se estiver olhando para VALOR, gera insight de m√©dia por transa√ß√£o
      if (tipo === "valor") {
        const htmlInsights = gerarInsightsResumoChaveCategoriaEstab(res, {
          tipoChave: "Estabelecimento"
        });
        if (htmlInsights) {
          renderBotMessage("HTML:" + htmlInsights);
        }
      }
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por estabelecimento.</p>");
    })
    .getResumoTransacoesPorEstabelecimento(
      dataInicioStr,
      dataFimStr,
      tipo,
      grupo,
      loja
    );

  return null;
}

// >>> TIME CAMPE√ÉO (singular): "qual time gastou mais ...", "time com mais transa√ß√µes ..."
const detTimeCampeao = detectarPerguntaTimeMaisTransacoes(msgUsuario, norm);
if (detTimeCampeao) {
  const p    = detTimeCampeao.periodo;
  const tipo = detTimeCampeao.tipo || "valor"; // "valor" ou "quantidade"

  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Buscando o <b>time campe√£o</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // singular ‚Üí sempre Top 1
      renderResumoTransacoesPorTime(res, { topN: 1 });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // encerra aqui
}


  // üÜï TODOS OS TIMES NO PER√çODO / RELA√á√ÉO DE TIMES
  const detTodosTimes = detectarTodosTimesPeriodo(msgUsuario, norm);
  if (detTodosTimes) {
    const p    = detTodosTimes.periodo;
    const tipo = detTodosTimes.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio)
      ? p.dataInicio.toISOString()
      : "";
    const dataFimStr = (p && p.dataFim)
      ? p.dataFim.toISOString()
      : "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todos os times</b> com gasto " +
        (tipo === "valor" ? "por <b>valor total</b>" : "por <b>n√∫mero de transa√ß√µes</b>") +
        (p ? " no per√≠odo solicitado" : "") +
        ". A tabela vai mostrar para cada time o <b>valor total</b> e a <b>quantidade</b> de transa√ß√µes." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (todos os times).</p>"
        );
      })
      .getResumoTransacoesPorTime(
        dataInicioStr,
        dataFimStr,
        tipo
      );

    return null;
  }

    // >>> BLOCO: perguntas de FATURA (Extrato da conta / BaseClara)

  const detFatura = detectarPerguntaFaturaClara(msgUsuario, norm);
  if (detFatura) {

     // üîí Restri√ß√£o de acesso para faturas completas
  if (USER_ROLE_REPLACED === "Acesso padr√£o") {
    renderBotMessage(
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>As informa√ß√µes detalhadas das <b>faturas corporativas completas</b> " +
        "s√£o restritas a perfis administrativos.</p>" +
        "<p class='mt-1'>Voc√™ continua com acesso normal a consultas de " +
        "<b>pend√™ncias, rankings, categorias, estabelecimentos</b> e demais " +
        "vis√µes da Clara.</p>" +
      "</div>"
    );
    return; // n√£o chama o backend de faturas
  } 

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou consultar o <b>valor das faturas</b> da Clara " +
        "de acordo com o per√≠odo solicitado...</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.faturas) || !res.faturas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar " +
            "informa√ß√µes de fatura na BaseClara.</p>"
          );
          return;
        }

        var todas = res.faturas || [];

              // ================== INTERPRETA√á√ÉO LOCAL DA PERGUNTA ==================
        let perguntaBruta = (msgUsuario || "").toLowerCase();

        // remove acentos: "√∫ltimas" -> "ultimas", "m√™s" -> "mes"
        let perguntaNorm = perguntaBruta
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

        let modoLocal = "atual";   // padr√£o
        let qtdLocal  = null;      // quantidade de faturas quando for "ultimas N"

        const temPluralFaturas   = perguntaNorm.includes("faturas");
        const temExplicitoAtual  = perguntaNorm.includes("fatura atual") ||
                                   perguntaNorm.includes("deste mes") ||
                                   perguntaNorm.includes("desse mes");
        const temExplicitoAnterior = perguntaNorm.includes("anterior") ||
                                     perguntaNorm.includes("mes passado");
        const temExplicitoTodas  = perguntaNorm.includes("todas");
        const temExplicitoUltimas = perguntaNorm.includes("ultimas") ||
                                    perguntaNorm.includes("ultimos");

        // 1) TODAS AS FATURAS (frase expl√≠cita)
        if (temExplicitoTodas && temPluralFaturas) {
          modoLocal = "todas";
        }

        // 2) √öLTIMAS N FATURAS (explicitamente com n√∫mero)
        // exemplos:
        // "ultimas 6 faturas", "ultimas 3 faturas da clara",
        // "6 ultimas faturas", "3 ultimas faturas da clara"
        let m =
          perguntaNorm.match(/ultimas?\s+(\d{1,2})\s*faturas?/) ||
          perguntaNorm.match(/(\d{1,2})\s+ultimas?\s*faturas?/);

        if (m && m[1]) {
          modoLocal = "ultimas";
          qtdLocal  = parseInt(m[1], 10);
        }

        // 2.b) "ultimas faturas" sem n√∫mero ‚Üí usa um padr√£o (ex.: 6)
        if (!qtdLocal && temExplicitoUltimas && temPluralFaturas) {
          modoLocal = "ultimas";
          qtdLocal  = 6;
        }

        // 3) FATURA ANTERIOR
        if (temExplicitoAnterior) {
          modoLocal = "anterior";
          qtdLocal  = null;
        }

        // 4) FATURA ATUAL (refor√ßo expl√≠cito)
        if (temExplicitoAtual) {
          modoLocal = "atual";
          qtdLocal  = null;
        }

        // 5) FALLBACK INTELIGENTE:
        // Se ainda est√° em "atual", mas o usu√°rio falou em "faturas" (plural)
        // sem dizer "atual", "anterior", "todas" ou "ultimas",
        // vamos assumir que ele quer ver mais de uma: ex.: √∫ltimas 6.
        if (
          modoLocal === "atual" &&
          temPluralFaturas &&
          !temExplicitoAtual &&
          !temExplicitoAnterior &&
          !temExplicitoTodas &&
          !temExplicitoUltimas
        ) {
          modoLocal = "ultimas";
          qtdLocal  = 6; // aqui voc√™ define o padr√£o que quiser
        }

        // 6) Seguran√ßa extra: se por qualquer motivo o modoLocal estiver "atual"
        //    mas temos qtdLocal > 1, tratamos como "ultimas".
        if (modoLocal === "atual" && typeof qtdLocal === "number" && qtdLocal > 1) {
          modoLocal = "ultimas";
        }

        // ================== APLICA O FILTRO ==================
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          modoLocal,
          qtdLocal
        );

        // ================== APLICA O FILTRO ==================
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          modoLocal,
          qtdLocal
        );

        // DEBUG pra gente ver exatamente o que est√° acontecendo
        console.log("perguntaNorm =", perguntaNorm);
        console.log("modoLocal =", modoLocal, "qtdLocal =", qtdLocal);
        console.log("total faturas retornadas =", todas.length);
        console.log("selecionadas pelo filtro =", selecionadas.length);

        if (!selecionadas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o encontrei faturas para " +
            "o crit√©rio informado.</p>"
          );
          return;
        }

        // ================== MONTA T√çTULO ==================
        var titulo = "RESUMO DE FATURAS CLARA";

        if (modoLocal === "atual") {
          titulo = "VALOR DA FATURA ATUAL";
        } else if (modoLocal === "anterior") {
          titulo = "VALOR DA FATURA DO M√äS PASSADO";
        } else if (modoLocal === "ultimas") {
          var n = qtdLocal || 2;
          var usado = Math.min(n, selecionadas.length);
          titulo = "VALOR DAS √öLTIMAS " + usado + " FATURAS";
        } else if (modoLocal === "todas") {
          titulo = "VALOR DE TODAS AS FATURAS";
        }

        var html = vektorMontarTabelaFaturas_(titulo, selecionadas);
        renderBotMessage("HTML:" + html);

        // üß† Engine de insights autom√°ticos em cima das faturas exibidas
        var htmlInsights = analisarFaturas(selecionadas);
        if (htmlInsights && typeof htmlInsights === "string") {
          renderBotMessage("HTML:" + htmlInsights);
        }

        // üÜï Se for fatura ATUAL, envia lembrete de fechamento e pagamento
        if (modoLocal === "atual") {
          const diasFechamento = vektorDiasAteFechamentoFaturaAtual();

          let msgFechamento;
          if (diasFechamento === 0) {
            msgFechamento =
              "Hoje √© o <b>dia de fechamento</b> da fatura atual. " +
              "O pagamento da fatura √© programado sempre para o dia <b>12</b> de cada m√™s.";
          } else if (diasFechamento === 1) {
            msgFechamento =
              "Falta <b>1 dia</b> para o fechamento da fatura atual. " +
              "O pagamento da fatura √© programado sempre para o dia <b>12</b> de cada m√™s.";
          } else {
            msgFechamento =
              "Faltam <b>" + diasFechamento + " dias</b> para o fechamento da fatura atual. " +
              "O pagamento da fatura √© programado sempre para o dia <b>12</b> de cada m√™s.";
          }

          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700 mt-2'>" +
              msgFechamento +
            "</p>"
          );
        }

        let __vektorChartFaturas = null;
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar " +
          "os dados de fatura na BaseClara.</p>"
        );
      })
      .getResumoFaturasClara();

    return;
  }

  // >>> NOVO BLOCO: perguntas de relat√≥rio (planilha Captura_Clara / BaseClara)

    const det = detectarPerguntaLojaMaisTransacoes(msgUsuario, norm);
    if (det) {
          const grupoNome = det.grupo || "";      // pode vir vazio (sem time)
          const periodo   = det.periodo;
          const tipo      = det.tipo || "quantidade"; // "quantidade" ou "valor"

  const grupoTxt = grupoNome
    ? ` do time <b>${grupoNome}</b>`
    : "";

  const criterioTxt = tipo === "valor"
    ? "maior <b>valor</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes";

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">
      Beleza! Vou consultar qual loja tem ${criterioTxt}${grupoTxt}${
        periodo ? " no per√≠odo solicitado" : ""
      } e j√° te trago um resumo. ‚è≥
    </p>`
  );

  // Converte datas (se existirem) para string ISO pra mandar pro Apps Script
  const dataInicioStr = (periodo && periodo.dataInicio)
    ? periodo.dataInicio.toISOString()
    : "";
  const dataFimStr = (periodo && periodo.dataFim)
    ? periodo.dataFim.toISOString()
    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, { topN: 1, forGroup: !!grupoNome });
    })
    .withFailureHandler(function () {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha. Tente novamente em alguns instantes.</p>"
      );
    })
    // üëá agora tamb√©m envia o tipo ("quantidade" ou "valor")
    .getResumoTransacoesPorGrupo(grupoNome, dataInicioStr, dataFimStr, tipo);

  // resposta vem ass√≠ncrona (via renderBotMessage no callback), ent√£o aqui n√£o devolve nada
  return null;
}

  // üÜï LOJAS ESPEC√çFICAS (ex.: "lojas XXXX e XXXX no per√≠odo ...")
  const detLojasEspec = detectarLojasEspecificasLista(msgUsuario, norm);
  if (detLojasEspec && detLojasEspec.codigosLojas.length > 0) {
    const p     = detLojasEspec.periodo;
    const tipo  = detLojasEspec.tipo || "valor";
    const lojas = detLojasEspec.codigosLojas;

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma tabela apenas com as <b>lojas " + lojas.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarLojasCodigos: lojas
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados para essas lojas espec√≠ficas.</p>"
        );
      })
      // grupo vazio => todas as lojas; vamos filtrar no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }

  // üÜï TODAS AS LOJAS NO PER√çODO (sem time)
  if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasPeriodo = detectarListarTodasLojasGeral(msgUsuario, norm);
  if (detTodasLojasPeriodo) {
    const periodo = detTodasLojasPeriodo.periodo;
    const tipo    = detTodasLojasPeriodo.tipo || "valor";

    const dataInicioStr = (periodo && periodo.dataInicio)
      ? periodo.dataInicio.toISOString()
      : "";
    const dataFimStr = (periodo && periodo.dataFim)
      ? periodo.dataFim.toISOString()
      : "";

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma <b>rela√ß√£o de todas as lojas</b> com gastos " +
        (periodo ? "no per√≠odo solicitado" : "no per√≠odo completo dispon√≠vel") +
        ", mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => listar TODAS as lojas
        renderResumoTransacoesSemana(res, { topN: null, forGroup: false });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha para listar todas as lojas.</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        "",              // sem time (todas as lojas)
        dataInicioStr,
        dataFimStr,
        tipo             // "valor" (padr√£o) ou "quantidade"
      );

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    // resposta vem via callback, ent√£o encerra aqui
    return null;
  }}

//üÜï TODAS AS LOJAS DE V√ÅRIOS TIMES
  const detLojasTimesMulti = detectarTodasLojasDosTimes(msgUsuario, norm);
  if (detLojasTimesMulti && detLojasTimesMulti.times.length > 0) {
    const listaTimes = detLojasTimesMulti.times;
    const p          = detLojasTimesMulti.periodo;
    const tipo       = detLojasTimesMulti.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

        // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todas as lojas</b> dos times <b>" + listaTimes.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados das lojas desses times.</p>"
        );
      })
      // grupo vazio => todas as lojas; filtro por time ser√° feito no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }



// <<< FIM DO BLOCO NOVO


        // 1) Termo de responsabilidade
        if (frasesTermo.some(f => norm.includes(f))) {
            // Mensagem principal (j√° existente)
            const msgPrincipal = respTermoResponsabilidade();

            // Segunda mensagem, separada, explicando que pode enviar pelo chat
            setTimeout(function () {
                try {
                    renderBotMessage(
                        "HTML:" +
                        "<div class='text-sm text-slate-700'>" +
                          "<p>" +
                            "Se voc√™ j√° tem o termo impresso e assinado, tamb√©m pode me enviar diretamente por aqui. " +
                            "Basta anexar o documento assinado." +
                          "</p>" +
                        "</div>"
                    );
                } catch (e) {
                    console.warn('Erro ao enviar mensagem complementar do termo:', e);
                }
            }, 2000); // pequeno atraso s√≥ para aparecer como outra bolha

            // Retorna a mensagem padr√£o para ser exibida normalmente
            return msgPrincipal;
        }

        // 2) Sauda√ß√µes
        for (const saud of saudacoes) {
            if (norm === saud || norm.startsWith(saud + " ") || norm.includes(" " + saud + " ")) {
                const respostasSaudacao = [
                    "Ol√°! üòÑ",
                    "Oi! üëã",
                    "Opa, tudo bem por a√≠? üòé",
                    "Fala a√≠! üëã",
                    "E a√≠, tudo certo? üôå",
                    "Bom te ver por aqui! üòÅ"
                ];
                const complementosAjuda = [
                    "Como posso te ajudar hoje?",
                    "Quer saber algo sobre o cart√£o Clara?",
                    "O que voc√™ quer saber?",
                    "Posso te explicar algo sobre o uso dos cart√µes?",
                    "Quer que eu te ajude com alguma d√∫vida?",
                    "Como posso te orientar?",
                    "Qual a sua d√∫vida?"
                ];
                const r1 = respostasSaudacao[Math.floor(Math.random() * respostasSaudacao.length)];
                const r2 = complementosAjuda[Math.floor(Math.random() * complementosAjuda.length)];
                return `HTML:<p class="text-sm text-slate-700">${r1} ${r2}</p>`;
            }
        }

        // 3) Encerramento / agradecimento
        for (const frase of frasesEncerramento) {
            if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
                const respostasEncerramento = [
                    "Que bom que consegui ajudar! ü§ó Pode me chamar sempre que precisar.",
                    "Show! Fico feliz em ajudar üòÑ",
                    "Perfeito üëå qualquer d√∫vida, √© s√≥ chamar de novo!",
                    "Valeu! At√© a pr√≥xima üöÄ",
                    "Beleza üòé t√¥ por aqui se precisar de novo.",
                    "Feito! Agora vou tirar um cochilo de 5 segundos. Me chama de novo, t√°?", 
                    "Resolvido! Fui nessa, mas t√¥ s√≥ a um clique de dist√¢ncia, viu?", 
                    "Show de bola! Se quebrar o meu sistema, n√£o fui eu, foi a formata√ß√£o anterior! üòâ", 
                    "Acabou o recreio! Brincadeiras √† parte, qualquer coisa, √© s√≥ dar um 'tapa' no chat.", 
                    "Tudo pronto. Vou ali beber uma √°gua e j√° volto. Se precisar, s√≥ assobiar!", 
                    "√â isso! Miss√£o dada √© (finalmente) miss√£o cumprida. Fui! üëã", 
                    "Perfeito! Agora vai l√° dominar o mundo (ou s√≥ terminar seu caf√© mesmo).", 
                    "Ufa! Deu tudo certo. Deixa um biscoito pra mim na pr√≥xima vez, valeu?", 
                    "Despedida de campe√£o! Se a d√∫vida voltar, √© porque sentiu minha falta. Pode chamar!", 
                    "Zerou! At√© o pr√≥ximo 'bug' ou a pr√≥xima ideia genial. üöÄ", 
                    "A gente se fala! N√£o faz besteira enquanto eu estiver fora, hein?", 
                    "OK, estou me desligando (s√≥ um pouquinho). Te vejo na pr√≥xima aventura!", 
                    "Quebrando a internet em 3, 2, 1... Brincadeira! Tchau, tchau!", 
                    "Terminamos com chave de ouro e um 'high five' virtual! ‚úã", 
                    "Resolvi essa parada! Agora, vai curtir a vida. Me chama se tiver t√©dio.", 
                    "Fechou o caix√£o! Quer dizer... fechou o chat. üòâ At√© a pr√≥xima!", 
                    "T√° tranquilo, t√° favor√°vel. Qualquer deslize tecnol√≥gico, me avisa!", 
                    "Deu bom! Vou mandar um emoji de comemora√ß√£o aqui: üéâ. Fui!", 
                    "Desaparecendo em 5 segundos. Se precisar de m√°gica, j√° sabe quem chamar.", 
                    "Essa foi r√°pida, hein? Valeu pela companhia. Tamo junto!", 
                    "Encerrando as atividades por hoje. Beijos de luz (e de c√≥digo)! ‚ú®", 
                    "Olha eu indo! Se sobrar um tempinho, manda um meme pra mim. Fui!", 
                    "Sou seu, mas n√£o sou seu (s√≥ at√© voc√™ precisar de mim de novo). Tchau!", 
                    "Gostei da conversa. Se tiver mais perguntas loucas, sou todo ouvidos!", 
                    "Miss√£o conclu√≠da. Agora, a pr√≥xima rodada √© por sua conta! (Brincadeira!).", 
                    "Finalizamos! Mando um abra√ßo de bytes e um at√© breve.", 
                    "Tudo nos conformes. Pode sair correndo e contar a novidade! üòâ", 
                    "Pronto para a aposentadoria (de 5 minutos). Bora na pr√≥xima!", 
                    "E o Oscar de melhor encerramento vai para... mim! Tchau! üòÇ"
                ];
                const r = respostasEncerramento[Math.floor(Math.random() * respostasEncerramento.length)];
                return `HTML:<p class="text-sm text-slate-700">${r}</p>`;
            }
        }

        // 4) Pol√≠tica (PDF oficial)
        if (frasesPolitica.some(f => norm.includes(f))) 
        
        {
              // ‚úÖ Primeiro: tenta responder RESUMO de categorias
  if (typeof tentarResponderResumoCategoriasPolitica === "function") {
    const resultadoResumo = tentarResponderResumoCategoriasPolitica(norm);
    if (resultadoResumo) {
      return vektorBlocoRaciocinioPolitica(
        resultadoResumo.mensagemUsuario,
        "",
        typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
          ? POLITICA_CARTOES_CLARA_LINK
          : ""
      );
    }
  }

  // ‚úÖ Se n√£o for sobre categorias, mant√©m a pol√≠tica oficial gen√©rica
  return respPoliticaOficial();
        }


              // 5) Fluxo pend√™ncias - aguardando c√≥digo da loja
        if (estadoPendencias === "aguardando_loja") {
    const textoOriginal = msgUsuario.trim();
    const soDigitos = textoOriginal.replace(/\D/g, "");

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // usu√°rio mudou de assunto
    if (mudouDeAssunto && !soDigitos) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        origemPendenciasBloqueio = false;
        return `HTML:<div class="text-sm text-slate-700">
        <p>Beleza üëç Vamos mudar de assunto ent√£o.</p>
        <p class="mt-1">Se quiser ver as pend√™ncias da loja depois, √© s√≥ dizer: <b>"consultar pend√™ncias Clara"</b>.</p>
        </div>`;
    }

    // usu√°rio digitou um c√≥digo de loja
    if (soDigitos && soDigitos.length >= 2 && soDigitos.length <= 4) {
        lojaPendenciasAtual = soDigitos;

        // üîπ CASO ESPECIAL: fluxo veio do bloqueio de cart√£o
        if (origemPendenciasBloqueio) {
            origemPendenciasBloqueio = false; // consumiu a flag

            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
                Beleza! Vou consultar as √∫ltimas pend√™ncias relacionadas ao cart√£o da loja <b>${soDigitos}</b>, que podem ter ocasionado o bloqueio. ‚è≥
                </p>`
            );

            consultarPendenciasBloqueio(soDigitos);
            return null;
        }

        // üîπ CASO NORMAL: fluxo padr√£o de pend√™ncias Clara
        estadoPendencias = "nenhum";

        // üÜï busca nome da loja no servidor antes de mostrar a mensagem
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}${nomeLojaTxt}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );

            consultarPendenciasNoServidor(soDigitos);
          })
          .withFailureHandler((err) => {
            // fallback se der erro na consulta do nome
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );
            consultarPendenciasNoServidor(soDigitos);
          })
          .obterNomeLojaBigQuery(soDigitos);

        return null;
    }

            // se chegou aqui, n√£o mudou de assunto e n√£o mandou c√≥digo de loja v√°lido
        // N√ÉO repetir frases infinitamente ‚Äî apenas n√£o responde e mant√©m o fluxo aguardando.
        return "";
}

        // 6) Fluxo pend√™ncias - aguardando confirma√ß√£o de envio por e-mail
if (estadoPendencias === "aguardando_confirmacao_email") {
    const ehSim = (
        norm === "sim" ||
        norm.startsWith("sim ") ||
        norm.includes(" sim") ||
        norm.includes("pode enviar") ||
        norm.includes("pode mandar") ||
        norm.includes("manda") ||
        norm.includes("envia") ||
        norm.includes("pode sim")
    );

    const ehNao = (
        norm === "nao" || norm === "n√£o" ||
        norm.startsWith("nao ") || norm.startsWith("n√£o ") ||
        norm.includes("nao precisa") || norm.includes("n√£o precisa") ||
        norm.includes("sem email") || norm.includes("sem e-mail") ||
        norm.includes("nao manda") || norm.includes("n√£o manda")
    );

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // Usu√°rio mudou de assunto no meio
    if (!ehSim && !ehNao && mudouDeAssunto) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<div class="text-sm text-slate-700">
<p>Tranquilo, vamos falar de outro assunto ent√£o. üòâ</p>
<p class="mt-1">Se depois voc√™ quiser receber o resumo por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
    }

    // Usu√°rio disse que N√ÉO quer e-mail
    if (ehNao) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<p class="text-sm text-slate-700">
Fechado, n√£o vou enviar por e-mail. Se quiser depois, √© s√≥ pedir de novo. üëç
</p>`;
    }

    // Usu√°rio disse que SIM quer e-mail
    if (ehSim) {
        const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
        const emailSessao = (USER_EMAIL_REPLACED || "").trim();

        if (!loja) {
            // Por seguran√ßa: se por algum motivo a loja sumiu da mem√≥ria
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";
            return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
        }

        // ‚úÖ Se temos e-mail do usu√°rio logado, j√° envia direto
        if (emailSessao) {
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";

            // avisa no chat
            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${emailSessao}</b>.
</p>`
            );

            // chama o Apps Script pra mandar o e-mail
            chamarEnvioPendenciasPorEmail(loja, emailSessao);

            // j√° usamos renderBotMessage, ent√£o aqui n√£o precisa retornar outro texto
            return null;
        }

        // ‚ùå Se N√ÉO temos e-mail na sess√£o, volta para o fluxo antigo (pede e-mail)
        estadoPendencias = "aguardando_email";
        return `HTML:<p class="text-sm text-slate-700">
Perfeito! Me informa o seu e-mail corporativo (ex.: <b>nome.sobrenome@xxxxx.com.br</b>) para eu enviar o resumo.
</p>`;
    }

    // Se n√£o entendeu nem sim nem n√£o
    return `HTML:<p class="text-sm text-slate-700">
S√≥ pra eu entender: voc√™ quer que eu envie por e-mail tamb√©m?<br/>
Responda apenas <b>"sim"</b> ou <b>"n√£o"</b>. üôÇ
</p>`;
}

        // 7) Fluxo pend√™ncias - aguardando e-mail
        if (estadoPendencias === "aguardando_email") {
            const textoOriginal = msgUsuario.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailRegex.test(textoOriginal)) {
                const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
                if (!loja) {
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
                }

                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${textoOriginal}</b>.
</p>`
                );
                chamarEnvioPendenciasPorEmail(loja, textoOriginal);
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return null;
            }

            const pareceOutroAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (pareceOutroAssunto) {
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return `HTML:<div class="text-sm text-slate-700">
<p>Beleza, vamos mudar de assunto ent√£o üòâ</p>
<p class="mt-1">Se depois voc√™ quiser voltar a ver as pend√™ncias da loja ou receber por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
            }

            return `HTML:<p class="text-sm text-slate-700">
Esse e-mail parece inv√°lido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.<br/><br/>
Se preferir mudar de assunto, pode me perguntar outra coisa diretamente (ex.: "sangria", "novo cart√£o", "limite", "etiqueta", etc.).
</p>`;
        }

        // 8) Fluxo novo cart√£o ‚Äì aguardando se √© 1¬™ ou 2¬™ via
        if (fluxoNovoCartao === "aguardando_tipo_via") {
            const ehPrimeira = (
                norm.includes("primeira via") ||
                norm.includes("1 via") ||
                norm.includes("1a via") ||
                norm.includes("1¬™ via") ||
                norm.includes("primeiro cartao") ||
                norm.includes("primeiro cart√£o") ||
                norm.includes("cartao novo") ||
                norm.includes("cart√£o novo") ||
                norm.includes("meu primeiro cartao") ||
                norm.includes("meu primeiro cart√£o") ||
                norm.includes("nunca tive cartao") ||
                norm.includes("nunca tive cart√£o") ||
                norm.includes("nao tenho cartao") ||
                norm.includes("n√£o tenho cart√£o")
            );

            const ehSegunda = (
                norm.includes("segunda via") ||
                norm.includes("2 via") ||
                norm.includes("2a via") ||
                norm.includes("2¬™ via") ||
                norm.includes("segundo cartao") ||
                norm.includes("segundo cart√£o") ||
                norm.includes("perdi o cartao") ||
                norm.includes("perdi meu cartao") ||
                norm.includes("perdi o cart√£o") ||
                norm.includes("roubaram meu cartao") ||
                norm.includes("roubaram meu cart√£o") ||
                norm.includes("roubo de cart√£o") ||
                norm.includes("perda de cart√£o") ||
                norm.includes("perca de cart√£o") ||
                norm.includes("cartao quebrado") ||
                norm.includes("cart√£o quebrado") ||
                norm.includes("cartao danificado") ||
                norm.includes("cart√£o danificado")
            );

            const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (!ehPrimeira && !ehSegunda && mudouDeAssunto) {
                fluxoNovoCartao = null;
                return `HTML:<p class="text-sm text-slate-700">
Sem problemas, vamos falar de outro assunto ent√£o. üòâ
</p>`;
            }

            if (ehPrimeira) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_primeira";
                return respNovoCartaoPrimeiraVia();
            }

            if (ehSegunda) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_segunda";
                return respNovoCartaoSegundaVia();
            }

            return `HTML:<p class="text-sm text-slate-700">
            N√£o entendi se voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido).<br/><br/>
            Me responde assim, por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }


        // 10) Gatilhos direto ‚Äì primeira via
        if (termosPrimeiraViaDireta.some(t => norm.includes(t))) {
            fluxoNovoCartao = null;
            return respNovoCartaoPrimeiraVia();
        }

        // 11) Gatilhos direto ‚Äì segunda via
        if (gatilhosSegundaViaDireta.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = null;
            return respNovoCartaoSegundaVia();
        }

                // 12) Gatilho ‚Äì quero pedir um cart√£o (abre fluxo pra perguntar primeira/segunda via)
        if (gatilhosNovoCartao.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = "aguardando_tipo_via";
            return `HTML:<p class="text-sm text-slate-700">
            S√≥ pra eu te orientar certinho: voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido)?<br/><br/>
            Responda por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }

        // 13) Demais casos:
//    Se a frase n√£o fala claramente de cart√£o/fatura/pend√™ncias,
//    em vez de chutar uma resposta de pol√≠tica, faz uma pergunta de clarifica√ß√£o.
const falaDeCartaoOuFatura =

  norm.includes("clara") ||
  norm.includes("cartao") ||
  norm.includes("cart√£o") ||
  norm.includes("fatura") ||
  norm.includes("pendencia") ||
  norm.includes("pend√™ncia") ||
  norm.includes("limite") ||
  norm.includes("estacionamento") ||
  norm.includes("posso comprar") ||
  norm.includes("pode comprar") ||
  // üîπ perguntas sobre ETIQUETA tamb√©m s√£o assunto da Clara
  norm.includes("etiqueta") ||
  norm.includes("etiquetas") ||
  // üîπ tudo que menciona gerente/gestor √© claramente assunto de Clara
  norm.includes("gerente") ||
  norm.includes("gerentes") ||
  norm.includes("gestor") ||
  norm.includes("gestora") ||

  // üîπ men√ß√£o direta a loja/unidade (no contexto desse bot faz sentido tratar como Clara)
  norm.includes("loja")     ||
  norm.includes("unidade")  ||

  // üîπ tudo que menciona ServiceNow/procedimento de chamado
  norm.includes("servicenow") ||
  norm.includes("service now") ||
  norm.includes("chamado") ||
  norm.includes("chamados") ||
  norm.includes("ticket") ||
  norm.includes("solicitacao") ||
  norm.includes("solicita√ß√£o") ||
  norm.includes("procedimento") ||
  norm.includes("procedimentos");

// üëá Frases gen√©ricas de compra/uso em primeira pessoa
const falaDeCompraOuUso =
  norm.includes("comprar") ||
  norm.includes("comprei") ||
  norm.includes("preciso comprar") ||
  norm.includes("quero comprar");

// üëá Frases claramente sobre o pr√≥prio Vektor
const falaSobreBot =
  norm.includes("o que voce faz") ||
  norm.includes("o que vc faz") ||
  norm.includes("o que voc√™ faz") ||
  norm.includes("o que o vektor pode fazer") ||
  norm.includes("quem e voce") ||
  norm.includes("quem √© voc√™") ||
  norm.includes("qual o seu nome") ||
  norm.includes("pra que voce serve") ||
  norm.includes("pra que vc serve");

// üëá S√≥ pergunta ‚Äúsobre o que voc√™ fala?‚Äù se N√ÉO for nada disso
if (!falaDeCartaoOuFatura && !falaDeCompraOuUso && !falaSobreBot) {
  const perguntaClara = gerarPerguntaDeClarificacao(norm);
  if (perguntaClara) {
    return perguntaClara;
  }
}

// 14) Ainda assim sobrou ‚Üí motor da pol√≠tica
return gerarRespostaPolitica(msgUsuario);

}

    // ========= INTERVALOS DE DATA PARA PERGUNTAS DE RELAT√ìRIO ========= //

   function extrairIntervaloDatas(msgOriginal) {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const meses = {
        janeiro: 0, fevereiro: 1, marco: 2, mar√ßo: 2, abril: 3, maio: 4, junho: 5,
        julho: 6, agosto: 7, setembro: 8, outubro: 9, novembro: 10, dezembro: 11
    };

    // const norm = (msgOriginal || "").toLowerCase();
    const norm = normalize(msgOriginal || "");
    let m; // <<< ADICIONE ESTA LINHA AQUI

    // 0) Hoje / Ontem
    if (norm.includes("ontem")) {
        const d = new Date(hoje);
        d.setDate(hoje.getDate() - 1);
        return { tipo: "ontem", dataInicio: d, dataFim: d };
    }
    if (norm.includes("hoje")) {
        const d = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        return { tipo: "hoje", dataInicio: d, dataFim: d };
    }

    // 0b-a) Esta semana / nessa semana / nesta semana
    if (
        norm.includes("essa semana") ||
        norm.includes("nesta semana") ||
        norm.includes("nessa semana")
    ) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);

        // volta at√© segunda-feira da semana atual
        const diaSemana = fim.getDay();       // 0=Dom, 1=Seg, ..., 6=Sab
        const diff = (diaSemana === 0 ? 6 : diaSemana - 1); // volta at√© segunda

        ini.setDate(fim.getDate() - diff);

        return { tipo: "semana_atual", dataInicio: ini, dataFim: fim };
    }

    // 0b) √öltima semana
    if (norm.includes("ultima semana") || norm.includes("√∫ltima semana")) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);
        ini.setDate(hoje.getDate() - 7);
        return { tipo: "ultima_semana", dataInicio: ini, dataFim: fim };
    }

    // 0c) √öltimo m√™s  (sin√¥nimo de "m√™s passado")
    if (norm.includes("ultimo mes") || norm.includes("√∫ltimo mes") || norm.includes("√∫ltimo m√™s")) {
        let mes = hoje.getMonth() - 1;
        let ano = anoAtual;
        if (mes < 0) {
            mes += 12;
            ano = anoAtual - 1;
        }
        const ini = new Date(ano, mes, 1);
        const fim = new Date(ano, mes + 1, 0);
        return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
    }

    // "√∫ltimo trimestre" / "trimestre passado"
if (norm.includes("ultimo trimestre") || norm.includes("trimestre passado")) {
  const mesAtual = hoje.getMonth();         // 0..11
  const trimestreAtual = Math.floor(mesAtual / 3); // 0..3
  let ano = anoAtual;
  let trimestreAnterior = trimestreAtual - 1;
  if (trimestreAnterior < 0) {
    trimestreAnterior = 3;
    ano = anoAtual - 1;
  }
  const inicioMes = trimestreAnterior * 3; // 0,3,6,9
  const ini = new Date(ano, inicioMes, 1);
  const fim = new Date(ano, inicioMes + 3, 0); // √∫ltimo dia do trimestre
  return { tipo: "trimestre_passado", dataInicio: ini, dataFim: fim };
}

// "neste trimestre" / "este trimestre"
if (norm.includes("neste trimestre") || norm.includes("este trimestre")) {
  const mesAtual = hoje.getMonth();
  const trimestreAtual = Math.floor(mesAtual / 3);
  const inicioMes = trimestreAtual * 3;
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "trimestre_atual", dataInicio: ini, dataFim: fim };
}

// "neste semestre" / "este semestre"
if (norm.includes("nesse semestre") || norm.includes("este semestre") || norm.includes("neste semestre")) {
  const mesAtual = hoje.getMonth();        // 0..11
  const semestreAtual = Math.floor(mesAtual / 6); // 0 ou 1
  const inicioMes = semestreAtual * 6;     // 0 ou 6
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "semestre_atual", dataInicio: ini, dataFim: fim };
}

// 0) Intervalo num√©rico: aceita com/sem "de" e com/sem ano
// Ex.: "de 01/11/2025 a 15/11/2025", "01/11/2025 a 15/11/2025",
//      "de 01/11 a 15/11", "01/11 a 15/11"
m = norm.match(/(?:de\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?\s+a\s+(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
if (m) {
    const d1 = Number(m[1]);
    const m1 = Number(m[2]) - 1;
    const y1 = m[3] ? Number(m[3]) : anoAtual;

    const d2 = Number(m[4]);
    const m2 = Number(m[5]) - 1;
    const y2 = m[6] ? Number(m[6]) : anoAtual;

    const ini = new Date(y1, m1, d1);
    const fim = new Date(y2, m2, d2, 23, 59, 59);

    return { tipo: "intervalo_numerico", dataInicio: ini, dataFim: fim };
}

    // 0d) Esse m√™s / neste m√™s
    if (
        norm.includes("esse mes") || 
        norm.includes("esse m√™s") ||
        norm.includes("neste mes") || 
        norm.includes("neste m√™s") ||
        norm.includes("nesse m√™s") ||
        norm.includes("nesse mes") ||
        norm.includes("este mes") || 
        norm.includes("este m√™s")
    ) {
        const ini = new Date(anoAtual, hoje.getMonth(), 1);
        const fim = hoje;
        return { tipo: "mes_atual", dataInicio: ini, dataFim: fim };
    }

    // 1) De tal dia a tal dia (ex.: "de 5 a 12 de novembro")
    m = norm.match(/de\s+(\d{1,2})\s+a\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
        const diaIni = Number(m[1]);
        const diaFim = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, diaIni);
            const fim = new Date(anoAtual, mes, diaFim);
            return { tipo: "intervalo", dataInicio: ini, dataFim: fim };
        }
    }

    // 2b) "entre 1 e 15 de novembro"
    m = norm.match(/entre\s+(\d{1,2})\s+e\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
      const dia1 = Number(m[1]);
      const dia2 = Number(m[2]);

      const mesStr = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const mes = meses[mesStr];
      if (mes !== undefined) {
        const ano = anoAtual;
        const ini = new Date(ano, mes, dia1);
        const fim = new Date(ano, mes, dia2, 23, 59, 59);
        return { tipo: "intervalo_mes_texto", dataInicio: ini, dataFim: fim };
      }
    }


      // 2) Dia espec√≠fico num√©rico
    // Aceita: "no dia 10/11/2025", "dia 10/11", "10/11/2025", "10/11"
    m = norm.match(/(?:no\s+dia\s+|dia\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
    if (m) {
        const dia = Number(m[1]);
        const mes = Number(m[2]) - 1;
        const ano = m[3] ? Number(m[3]) : anoAtual;
        const d = new Date(ano, mes, dia);

        return { tipo: "dia", dataInicio: d, dataFim: d };
    }

    // 2b) "em 5 de outubro"
    m = norm.match(/(em|no)\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
        const dia = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const d = new Date(anoAtual, mes, dia);
            return { tipo: "dia", dataInicio: d, dataFim: d };
        }
    }

    // 3a) "no m√™s de setembro"
    m = norm.match(/(em|no)\s+mes\s+de\s+([a-z√ß]+)/);
    if (m) {
        const chaveMes2 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes2)
            ? meses[chaveMes2]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 3b) "em outubro"
    m = norm.match(/(em|no)\s+([a-z√ß]+)/);
    if (m) {
        const chaveMes3 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (Object.prototype.hasOwnProperty.call(meses, chaveMes3)) {
            const mes = meses[chaveMes3];
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 4) "m√™s passado"
if (norm.includes("mes passado")) {   // depois do normalize, "m√™s" j√° virou "mes"
    let mes = hoje.getMonth() - 1;
    let ano = anoAtual;
    if (mes < 0) {
        mes += 12;
        ano = anoAtual - 1;
    }
    const ini = new Date(ano, mes, 1);
    const fim = new Date(ano, mes + 1, 0);
    return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
}

// 5) "√∫ltimos X meses"
m = norm.match(/ultimos?\s+(\d{1,2})\s+mes(es)?/);
if (m) {
    const qtdMeses = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setMonth(hoje.getMonth() - qtdMeses);
    return { tipo: "ultimos_meses", dataInicio: ini, dataFim: fim };
}

// 6) "√∫ltimos 15 dias", etc.
m = norm.match(/ultimos?\s+(\d{1,3})\s+dias?/);
if (m) {
    const qtd = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setDate(hoje.getDate() - qtd);
    return { tipo: "ultimos_dias", dataInicio: ini, dataFim: fim };
}

  // 7) "2 ultimas semanas" ou "ultimas 2 semanas"
m = norm.match(/(\d{1,2})\s+ultimas?\s+semanas?/);
if (!m) {
  m = norm.match(/ultimas?\s+(\d{1,2})\s+semanas?/);
}
if (m) {
  const qtdSemanas = Number(m[1]);
  const dias = qtdSemanas * 7;
  const fim = hoje;
  const ini = new Date(hoje);
  ini.setDate(hoje.getDate() - dias);
  return { tipo: "ultimas_semanas", dataInicio: ini, dataFim: fim };
}

    return null;
}

// Formata "2025-04-10T..." -> "abr/25"
function vektorFormatarMesAnoCurto(isoStr) {
  if (!isoStr) return "";
  var d = new Date(isoStr);
  if (isNaN(d.getTime())) return "";

  var meses = ["jan", "fev", "mar", "abr", "mai", "jun",
               "jul", "ago", "set", "out", "nov", "dez"];
  var mes = meses[d.getMonth()];
  var ano = d.getFullYear().toString().slice(-2);

  return mes + "/" + ano;
}

// Monta a frase "Trazendo dados de abr/25 √† nov/25."
function vektorFraseResumoPeriodo(dataInicioIso, dataFimIso) {
  if (!dataInicioIso || !dataFimIso) return "";

  var ini = vektorFormatarMesAnoCurto(dataInicioIso);
  var fim = vektorFormatarMesAnoCurto(dataFimIso);
  if (!ini || !fim) return "";

  if (ini === fim) {
    return "Trazendo dados de " + ini + ".";
  }
  return "Trazendo dados de " + ini + " √† " + fim + ".";
}

// ===== Cache de per√≠odo para drill-down: "mesmo per√≠odo da pergunta anterior" =====
(function () {
  // Guarda refer√™ncia da fun√ß√£o original
  const _extrairOriginal = extrairIntervaloDatas;

  // Cache global do √∫ltimo per√≠odo entendido
  window.__vektorUltimoPeriodo = null;

  // Sobrescreve a fun√ß√£o usada no restante do c√≥digo
  extrairIntervaloDatas = function (msgOriginal) {
    try {
      const st = vektorObterContexto();
      // 1) Se a mensagem falar "mesmo per√≠odo da pergunta anterior"
      //    e j√° tivermos um per√≠odo salvo, devolve direto o cache
      if (msgOriginal && typeof msgOriginal === "string") {
        const norm = normalize(msgOriginal);
        if (
        norm.includes("mesmo periodo da pergunta anterior") &&
        st.ultimoPeriodo &&
        st.ultimoPeriodo.dataInicio &&
        st.ultimoPeriodo.dataFim
      ) {
        return st.ultimoPeriodo;
        }
      }

      // 2) Caso contr√°rio, usa a fun√ß√£o original
      const periodo = _extrairOriginal(msgOriginal);

        // 3) Se achou per√≠odo, salva tanto em __vektorUltimoPeriodo quanto no VEKTOR_STATE
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      window.__vektorUltimoPeriodo = periodo;
      vektorRegistrarContexto({
        ultimoPeriodo: periodo
      });
    }

      return periodo;
    } catch (e) {
      console.error("Erro no wrapper de extrairIntervaloDatas:", e);
      // fallback: chama fun√ß√£o original
      return _extrairOriginal(msgOriginal);
    }
  };
})();

// ========= RESUMO LOJA x TIME (GR√ÅFICO) ========= //

function renderResumoTransacoesSemana(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar informa√ß√µes de transa√ß√µes para esse filtro. Verifique se o time e o per√≠odo est√£o corretos.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto do crit√©rio (valor x quantidade)
  var criterioTxt = (resumo.tipo === "valor"
    ? "maior <b>valor</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes");

  var grupoHtml = resumo.grupoNome
    ? " no time <b>" + resumo.grupoNome + "</b>"
    : "";

  // Filtros recebidos
  var temFiltroLojas = opts && Array.isArray(opts.filtrarLojasCodigos) && opts.filtrarLojasCodigos.length > 0;
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  var fraseResumo;
  if (temFiltroLojas) {
    // Ex.: "lojas 316 e 39 neste m√™s"
    fraseResumo = "Comparando as lojas <b>" +
      opts.filtrarLojasCodigos.join(", ") +
      "</b> no per√≠odo selecionado" + grupoHtml + ".";
  } else if (temFiltroTimes) {
    // Ex.: "todas as lojas dos times Falc√µes e Lobos"
    fraseResumo = "Mostrando lojas dos times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b> no per√≠odo selecionado" + grupoHtml + ".";
  } else {
    // Comportamento padr√£o (sem filtro espec√≠fico)
    fraseResumo = resumo.top
      ? "A loja <b>" + resumo.top.loja + "</b> foi a que teve " + criterioTxt + " no per√≠odo selecionado" + grupoHtml + "."
      : "N√£o encontrei transa√ß√µes" + grupoHtml + " no per√≠odo selecionado.";
  }

  // Base de lojas
  var all = Array.isArray(resumo.lojas) ? resumo.lojas : [];

     // Aplica filtros de LOJAS (aceita ‚Äú0034 - MORUMBI‚Ä¶‚Äù, ‚Äú0034‚Äù, ‚Äú34‚Äù etc.)
  if (temFiltroLojas) {
    var codSet = {};

    // Normaliza os c√≥digos pedidos pelo usu√°rio (remove tudo que n√£o for d√≠gito e zeros √† esquerda)
    opts.filtrarLojasCodigos.forEach(function (c) {
      var digits = String(c || "").replace(/\D/g, "");  // s√≥ d√≠gitos
      if (!digits) return;
      var norm = digits.replace(/^0+/, "") || digits;   // tira zeros √† esquerda (0176 -> 176)
      codSet[norm] = true;
    });

    all = all.filter(function (linha) {
      // Vamos testar v√°rios campos poss√≠veis da linha
      var campos = [
        linha.loja,
        linha.Loja,
        linha.LojaNum,
        linha.codigoLoja,
        linha.CodigoLoja
      ];

      for (var i = 0; i < campos.length; i++) {
        var v = campos[i];
        if (v === undefined || v === null) continue;

        // pode vir "0176", "176" ou "0176 - PLAZA NITEROI-RJ"
        var digitsLinha = String(v).replace(/\D/g, "");
        if (!digitsLinha) continue;

        var normLinha = digitsLinha.replace(/^0+/, "") || digitsLinha;

        if (codSet[normLinha]) {
          return true; // bateu em algum campo -> mant√©m a linha
        }
      }

      // nenhum campo da linha bateu com os c√≥digos desejados
      return false;
    });
  }

  // Aplica filtros de TIMES
  if (temFiltroTimes) {
    var timesSet = {};
    opts.filtrarTimesNomes.forEach(function (nome) {
      timesSet[String(nome).toLowerCase()] = true;
    });

    all = all.filter(function (linha) {
      var g = String(linha.grupo || linha.Grupo || "").toLowerCase();
      return !!timesSet[g];
    });
  }

  // Decide quantas linhas exibir
  var linhas;
  if (opts && (opts.topN === null)) {
    // topN: null => listar TODAS
    linhas = all;
  } else if (typeof opts.topN === "number") {
    // top N expl√≠cito
    linhas = all.slice(0, Math.max(0, opts.topN));
  } else if (opts && opts.forGroup) {
    // Sem topN + filtrando por time => todas as lojas desse(s) time(s)
    linhas = all;
  } else {
    // Ranking geral sem topN => todas (comportamento antigo)
    linhas = all;
  }

  // Guarda lista de lojas exibidas na √∫ltima tabela (para outras fun√ß√µes usarem)
  try {
    window.__vektorUltimasLojasTabela = (linhas || [])
      .map(function (l) {
        return (l.loja || "").toString().trim();
      })
      .filter(Boolean);
  } catch (e) {
    console.warn("Falha ao registrar lista de lojas da tabela:", e);
  }

  // Somat√≥rios
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // Monta tabela
  var linhasTabela = [];
  if (linhas.length) {

    // Dropdown de drilldown
    linhasTabela.push(
      "<div style='margin-top:8px;margin-bottom:10px;font-size:12px;margin-bottom:4px;color:#334155;display:flex;align-items:center;gap:6px;'>" +
        "<span>Expandir a tabela por:</span>" +
        "<select class='vektor-drill-select' data-base='loja' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Loja</th>" +
        "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    for (var j = 0; j < linhas.length; j++) {
      var l = linhas[j];
      var qtd = Number(l.total) || 0;
      var val = Number(l.valorTotal) || 0;
      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

      var hint = "Clique para detalhar pelo filtro escolhido " + l.loja;

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'loja')\" " +
          "style='cursor:pointer;' " +
          "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + l.loja + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

  // üÜï Insights autom√°ticos sobre as LOJAS (T√ìPICO 3)
  var insightsLojasHtml = vektorGerarInsightsRankingLojas(linhas || []);

  // Bot√µes (CSV + Pend√™ncias + Justificativas)
  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +

        // Exportar CSV
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_lojas')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +

        // Verificar pend√™ncias
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarPendenciasLojas(this)\" " +
            "style='background:#B91C1C;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "‚ö† Verificar pend√™ncias" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(185,28,28,0.92);'>" +
            "Lista todas as pend√™ncias das lojas dessa tabela no per√≠odo informado" +
          "</span>" +
        "</span>" +

        // Verificar justificativas
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarJustificativasLojas(this)\" " +
            "style='background:#0F172A;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "‚úî Verificar justificativas" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(15,23,42,0.92);'>" +
            "Lista todas as transa√ß√µes com justificativas feitas de forma correta" +
          "</span>" +
        "</span>" +

      "</div>";
  }

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      tabelaHtml,
      insightsLojasHtml || "",
      botoesHtml,
    "</div>"
  ].join("");

  // T√ìPICO 2 ‚Äì mem√≥ria de contexto (corrigido para ranking_lojas)
  try {
    vektorRegistrarContexto({
      ultimaIntencao: "ranking_lojas",
      ultimoPeriodo: {
        dataInicioIso: typeof dataInicioIso !== "undefined" ? dataInicioIso : "",
        dataFimIso: typeof dataFimIso !== "undefined" ? dataFimIso : ""
      },
      ultimoGrupo: resumo && resumo.grupoNome ? resumo.grupoNome : null,
      ultimaAcaoExplicavel: {
        tipo: "tabela_ranking_lojas",
        meta: {
          tipoResumo: resumo ? resumo.tipo : null,
          grupo: resumo ? resumo.grupoNome : null
        }
      }
    });
  } catch (e) {
    console.warn("Falha ao registrar contexto de ranking_lojas:", e);
  }

  renderBotMessage("HTML:" + html);
}

// ========= Bot√µes "Verificar pend√™ncias / justificativas" (tabelas de LOJAS) ========= //

function vektorMontarTabelaPendJust_(titulo, colunas, linhas) {
    // Se n√£o vier nenhuma linha, mostra mensagem
    if (!linhas || !linhas.length) {
        return "<p class='text-sm text-slate-700'>N√£o encontrei registros para " +
               (titulo || "").toLowerCase() + " nesse per√≠odo/sele√ß√£o.</p>";
    }

    // Identifica se √© tabela de pend√™ncias ou de justificativas pelo t√≠tulo
    var lowerTitulo  = (titulo || "").toLowerCase();
    var isPendencias = lowerTitulo.indexOf("pend") >= 0;

    // Cores
    var headerColor   = isPendencias ? "#B91C1C" : "#0F172A"; // vermelho / azul escuro
    var botaoCsvColor = "#005E27";                            // verde padr√£o Vektor

    // Cabe√ßalhos que SER√ÉO exibidos
    var colunasVisiveis;
    if (isPendencias) {
        // PEND√äNCIAS: Loja | Data | Valor | Pend√™ncias (coluna √∫nica)
        colunasVisiveis = [
            "Loja",
            "Data da Transa√ß√£o",
            "Valor (R$)",
            "Pend√™ncias"
        ];
    } else {
        // JUSTIFICATIVAS: formato original com 3 colunas separadas
        // Loja | Data | Valor | Etiqueta | Descri√ß√£o | Recibo
        colunasVisiveis = [
            "Loja",
            "Data da Transa√ß√£o",
            "Valor (R$)",
            "Etiqueta",
            "Descri√ß√£o",
            "Recibo"
        ];
    }

    var partes = [];

    // Container + tabela
    partes.push(
      "<div class='text-sm text-slate-700' style='max-width:1000px;margin:auto;'>",
        "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>", titulo, "</p>",
        "<div style='overflow-x:auto;'>",
          "<table border='1' cellspacing='0' cellpadding='8' " +
          "style='border-collapse:collapse;width:100%;font-size:13px;border:1px solid #000;'>"
    );

    // ===== Cabe√ßalho =====
    partes.push("<thead><tr style='background:" + headerColor + ";color:#fff;'>");

    colunasVisiveis.forEach(function (col) {

        // Ajuste de larguras APENAS na tabela de JUSTIFICATIVAS
        if (!isPendencias) {

            // Data da Transa√ß√£o ‚Äî largura maior
            if (col === "Data da Transa√ß√£o") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:160px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Etiqueta ‚Äî maior que Data
            if (col === "Etiqueta") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:260px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Descri√ß√£o ‚Äî maior que Etiqueta
            if (col === "Descri√ß√£o") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:300px;'>",
                  col,
                  "</th>"
                );
                return;
            }
        }

        // Default para todas as outras colunas
        partes.push(
          "<th style='border:1px solid #000;padding:6px;text-align:center;'>",
          col,
          "</th>"
        );
    });

    partes.push("</tr></thead><tbody>");

    // IMPORTANTE: backend (Code.gs) monta cada linha como:
    // [0] Loja
    // [1] Data da Transa√ß√£o
    // [2] Valor (R$)
    // [3] Etiqueta
    // [4] Descri√ß√£o
    // [5] Recibo
    linhas.forEach(function (row) {
        var loja      = row[0] != null ? String(row[0]) : "";
        var data      = row[1] != null ? String(row[1]) : "";
        var valorNum  = row[2] != null ? Number(row[2]) || 0 : 0;
        var etiqueta  = row[3] != null ? String(row[3]).trim() : "";
        var descricao = row[4] != null ? String(row[4]).trim() : "";
        var reciboRaw = row[5] != null ? String(row[5]).trim() : "";

        var valorFmt = valorNum.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL"
        });

        // Normaliza recibo para ver se √© "n√£o/nao"
        var reciboNorm = reciboRaw
            ? reciboRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase()
            : "";

        partes.push("<tr>");

        // Loja
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          loja,
          "</td>"
        );

        // Data
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          data,
          "</td>"
        );

        // Valor
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          valorFmt,
          "</td>"
        );

        if (isPendencias) {
            // üî¥ TABELA DE PEND√äNCIAS: coluna √∫nica ‚ÄúPend√™ncias‚Äù

            var pendencias = [];
            if (!etiqueta)  pendencias.push("Etiqueta");
            if (!descricao) pendencias.push("Descri√ß√£o");
            if (reciboNorm === "nao" || reciboNorm === "n√£o") {
                pendencias.push("Nota fiscal/Recibo");
            }

            var pendTexto = pendencias.length ? pendencias.join(", ") : "";

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              pendTexto,
              "</td>"
            );

        } else {
            // üîµ TABELA DE JUSTIFICATIVAS: colunas separadas

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              etiqueta,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              descricao,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              reciboRaw,
              "</td>"
            );
        }

        partes.push("</tr>");
    });

    partes.push("</tbody></table></div>");

    // Bot√£o CSV (igual ao resto do sistema)
    var nomeArquivo = isPendencias ? "pendencias_lojas" : "justificativas_lojas";

    partes.push(
      "<div style='margin-top:10px;text-align:right;'>",
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, '" + nomeArquivo + "')\" " +
          "style='background:" + botaoCsvColor + ";color:#fff;border:none;padding:8px 12px;" +
                 "border-radius:4px;font-size:12px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>",
      "</div>"
    );

    partes.push("</div>");

    return partes.join("");
}

function vektorMontarTabelaFaturas_(titulo, faturas) {
  if (!faturas || !faturas.length) {
    return "<p class='text-sm text-slate-700'>N√£o encontrei faturas na BaseClara.</p>";
  }

  var partes = [];

  partes.push(
    "<div class='text-sm text-slate-700' style='max-width:1000px;margin:12px auto 0;'>",
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>",
      // NOVA linha de orienta√ß√£o
    "<p style='margin-bottom:8px;text-align:center;font-size:13px;color:#000000;'>" +
      "Clique na linha da fatura para verificar o valor detalhado por times." +  
     "</p>" +  
     
     "<p style='margin-bottom:8px;text-align:center;font-size:13px;color:#000000;'>" +
  "E clique em <b>Extrair dados</b> para verificar o relat√≥rio de transa√ß√µes da fatura." +
    "</p>",
      "<div style='overflow-x:auto;'>",
        "<table border='1' cellspacing='0' cellpadding='8' " +
        "style='border-collapse:collapse;width:100%;font-size:13px;border:2px double #000;'>",
          "<thead>",
            "<tr style='background:#0F172A;color:#fff;'>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Fatura (per√≠odo / extrato da conta)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Valor total (R$)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Varia√ß√£o</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Extra√ß√£o</th>",
            "</tr>",
          "</thead>",
          "<tbody>"
  );

  var somaTotal = 0;
  var valorAnterior = null;

  // ‚îÄ Insights: vamos guardar a MAIOR ALTA e a MAIOR QUEDA de uma fatura para a seguinte
  var maiorAumento = null; // { faturaAtual, variacao }
  var maiorQueda   = null; // { faturaAtual, variacao }

  faturas.forEach(function (f, idx) {
    var valor = Number(f.valorTotal) || 0;
    somaTotal += valor;

    var valorFmt = valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

    // Calcula varia√ß√£o em rela√ß√£o √† fatura anterior
    var variacaoTexto = "‚Äî";
    if (valorAnterior !== null && valorAnterior !== 0) {
      var variacao = ((valor - valorAnterior) / valorAnterior) * 100;
      var variacaoFmt = variacao.toFixed(1).replace(".", ",") + "%";

      if (variacao > 0) {
        variacaoTexto = "+" + variacaoFmt;
      } else {
        variacaoTexto = variacaoFmt;
      }

      // Atualiza maior aumento
      if (!maiorAumento || variacao > maiorAumento.variacao) {
        maiorAumento = {
          faturaAtual: f,
          variacao: variacao
        };
      }

      // Atualiza maior queda
      if (!maiorQueda || variacao < maiorQueda.variacao) {
        maiorQueda = {
          faturaAtual: f,
          variacao: variacao
        };
      }
    }

    // üîΩ linha clic√°vel para drilldown por time (usando EXTRATO e per√≠odo)

    // dentro do forEach das faturas, onde voc√™ faz partes.push("<tr ...>", "<td>...</td>", ...)

    partes.push(
  "<tr onclick=\"window.vektorDrillTimesFatura(this)\" " +
      "style='cursor:pointer;' " +
      "data-extrato-fatura='" + (f.extrato || "") + "' " +
      "data-inicio-fatura='" + (f.dataInicioIso || "") + "' " +
      "data-fim-fatura='" + (f.dataFimIso || "") + "'>",

    // TD 1 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      (f.extrato || "") +
    "</td>",

    // TD 2 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      valorFmt +
    "</td>",

    // TD 3 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      variacaoTexto +
    "</td>",

    // TD 4 (SEM tooltip e SEM string quebr√°vel)
"<td style='border:2px double #000;padding:6px;text-align:center;'>" +
  "<a href='#' title='' " +
     "data-extrato=\"" + encodeURIComponent(String(f.extrato || "")) + "\" " +
     "onclick=\"return window.vektorBaixarTransacoesFaturaLink(event, this); return false;\" " +
     "style='color:#005E27;font-weight:700;text-decoration:underline;'>" +
    "Extrair dados" +
  "</a>" +
"</td>",


  "</tr>"
);

    valorAnterior = valor;
  });

  // Linha de TOTAL
  var somaFmt = somaTotal.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });

  partes.push(
  "<tr style='background:#f1f5f9;font-weight:bold;'>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'>TOTAL</td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'>" + somaFmt + "</td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'></td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'></td>", // ‚úÖ nova coluna
  "</tr>",
  "</tbody>",
  "</table>",
  "</div>"
);

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // BLOCO NOVO: coment√°rios autom√°ticos (insights) sobre as faturas
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var comentarios = [];

  // S√≥ faz sentido falar de varia√ß√£o se tiver pelo menos 2 faturas
  if (faturas.length >= 2) {
    if (maiorAumento && maiorAumento.variacao > 0) {
      var pctAlta = Math.abs(maiorAumento.variacao).toFixed(1).replace(".", ",") + "%";
      var extratoAlta = maiorAumento.faturaAtual.extrato || "uma das faturas";

      comentarios.push(
        "A fatura <b>" + extratoAlta +
        "</b> teve o ‚¨ÜÔ∏è <b>maior aumento</b> em rela√ß√£o ao ciclo anterior, em torno de <b>" +
        pctAlta + "</b>."
      );
    }

    if (maiorQueda && maiorQueda.variacao < 0) {
      var pctQueda = Math.abs(maiorQueda.variacao).toFixed(1).replace(".", ",") + "%";
      var extratoQueda = maiorQueda.faturaAtual.extrato || "uma das faturas";

      comentarios.push(
        "A fatura <b>" + extratoQueda +
        "</b> teve a ‚¨áÔ∏è <b>maior redu√ß√£o</b> em rela√ß√£o ao ciclo anterior, cerca de <b>" +
        pctQueda + "</b>."
      );
    }
  }

  if (comentarios.length) {
    partes.push(
      "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
             "background:#F8FAFC;border-radius:4px;padding:6px;" +
             "border:1px solid #E2E8F0;'>",
        "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre as faturas:</b></p>",
        "<ul style='margin:0;padding-left:16px;'>",
          comentarios.map(function (c) {
            return "<li>" + c + "</li>";
          }).join(""),
        "</ul>",
      "</div>"
    );
  }

  // Bot√£o de Exportar CSV (j√° existia)
  partes.push(
    "<div style='margin-top:8px;text-align:right;'>",
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'faturas_clara')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>",
        "‚¨á Exportar CSV",
      "</button>",
    "</div>",

    "</div>"
  );

  return partes.join("");
}

// ===================================================================
// T√ìPICO 3 ‚Äì Insights autom√°ticos: TIMES
// ===================================================================
function vektorGerarInsightsTimes(times) {
  if (!Array.isArray(times) || !times.length) return "";

  // Espera itens do tipo: { time: "√Åguias do Cerrado", valorTotal: 1234.56, total: 10 }
  // Se os nomes de campos forem outros, ajuste aqui.
  var lista = times
    .map(function (t) {
      return {
        nome: t.time || t.grupo || t.nome || "Time sem nome",
        valor: Number(t.valorTotal || t.valor || 0),
        qtd: Number(t.total || t.qtd || 0)
      };
    })
    .filter(function (t) {
      return t.valor > 0 || t.qtd > 0;
    });

  if (!lista.length) return "";

  var totalGeral = 0;
  lista.forEach(function (t) {
    totalGeral += t.valor;
  });
  if (!totalGeral) return "";

  // Ordena por valor desc
  lista.sort(function (a, b) {
    return b.valor - a.valor;
  });

  var top1 = lista[0];
  var top2 = lista[1] || null;
  var top3 = lista[2] || null;

  var comentarios = [];

  // Coment√°rio 1: campe√£o de gastos
  var percTop1 = (top1.valor / totalGeral) * 100;
  comentarios.push(
    "O time <b>" + top1.nome +
    "</b> √© o que mais gastou no per√≠odo, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total."
  );

  // Coment√°rio 2: concentra√ß√£o alta
  if (percTop1 >= 40) {
    comentarios.push(
      "H√° uma <b>forte concentra√ß√£o</b> de gastos no time <b>" +
      top1.nome +
      "</b>. Vale avaliar se esse padr√£o faz sentido para o momento da opera√ß√£o."
    );
  }

  // Coment√°rio 3: top 3
  if (top2 || top3) {
    var nomesTop = [top1.nome];
    if (top2) nomesTop.push(top2.nome);
    if (top3) nomesTop.push(top3.nome);

    comentarios.push(
      "Os principais respons√°veis pelo volume de gastos s√£o: <b>" +
      nomesTop.join("</b>, <b>") +
      "</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre os times:</b></p>" +
      "<ul id='insights-times-ul' style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// T√ìPICO 3 ‚Äì Insights autom√°ticos: LOJAS
// ===================================================================
function vektorGerarInsightsRankingLojas(lojas) {
  if (!Array.isArray(lojas) || !lojas.length) return "";

  // Espera itens do tipo: { loja: "123 - SHOPPING X", valorTotal: 1234.56, total: 10 }
  // Ajuste os nomes dos campos se necess√°rio.
  var lista = lojas
    .map(function (l) {
      return {
        nome: l.loja || l.nome || l.codigo || "Loja sem nome",
        valor: Number(l.valorTotal || l.valor || 0),
        qtd: Number(l.total || l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 || l.qtd > 0;
    });

  if (!lista.length) return "";

  var totalGeral = 0;
  lista.forEach(function (l) {
    totalGeral += l.valor;
  });
  if (!totalGeral) return "";

  // Ordena por valor desc
  lista.sort(function (a, b) {
    return b.valor - a.valor;
  });

  var top1 = lista[0];
  var top2 = lista[1] || null;
  var top3 = lista[2] || null;

  var comentarios = [];

  // Coment√°rio 1: campe√£
  var percTop1 = (top1.valor / totalGeral) * 100;
  comentarios.push(
    "A loja <b>" + top1.nome +
    "</b> concentra o maior volume de gastos no per√≠odo, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total."
  );

  // Coment√°rio 2: concentra√ß√£o alta
  if (percTop1 >= 35) {
    comentarios.push(
      "O n√≠vel de concentra√ß√£o em <b>" + top1.nome +
      "</b> √© elevado. Pode valer a pena revisitar as despesas dessa unidade com mais aten√ß√£o."
    );
  }

  // Coment√°rio 3: top 3 lojas
  if (top2 || top3) {
    var nomesTop = [top1.nome];
    if (top2) nomesTop.push(top2.nome);
    if (top3) nomesTop.push(top3.nome);

    comentarios.push(
      "As lojas que mais impactam o resultado desse per√≠odo s√£o: <b>" +
      nomesTop.join("</b>, <b>") +
      "</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre as lojas:</b></p>" +
      "<ul id='insights-lojas-ul' style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// T√ìPICO 4 ‚Äì Insights autom√°ticos: CATEGORIAS (ticket m√©dio)
// ===================================================================
function vektorGerarInsightsResumoCategorias(itens) {
  if (!Array.isArray(itens) || !itens.length) return "";

  // filtra s√≥ quem tem valor e quantidade
  var lista = itens
    .map(function (l) {
      return {
        nome: l.nome || "Categoria sem nome",
        valor: Number(l.valor || 0),
        qtd: Number(l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 && l.qtd > 0;
    });

  if (lista.length < 2) return "";

  // calcula ticket m√©dio
  lista.forEach(function (l) {
    l.media = l.valor / l.qtd;
  });

  // ordena por m√©dia (maior -> menor)
  lista.sort(function (a, b) {
    return b.media - a.media;
  });

  var top = lista[0];
  var bottom = lista[lista.length - 1];

  var comentarios = [];

  comentarios.push(
    "A categoria com <b>maior ticket m√©dio</b> (valor m√©dio por transa√ß√£o) √© <b>" +
      top.nome +
      "</b>, com cerca de <b>" +
      top.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  comentarios.push(
    "A categoria com <b>menor ticket m√©dio</b> √© <b>" +
      bottom.nome +
      "</b>, com cerca de <b>" +
      bottom.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
      "background:#F8FAFC;border-radius:4px;padding:6px;" +
      "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre as categorias:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// T√ìPICO 5 ‚Äì Insights autom√°ticos: ESTABELECIMENTOS (ticket m√©dio)
// ===================================================================
function vektorGerarInsightsResumoEstabelecimentos(itens) {
  if (!Array.isArray(itens) || !itens.length) return "";

  var lista = itens
    .map(function (l) {
      return {
        nome: l.nome || "Estabelecimento sem nome",
        valor: Number(l.valor || 0),
        qtd: Number(l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 && l.qtd > 0;
    });

  if (lista.length < 2) return "";

  lista.forEach(function (l) {
    l.media = l.valor / l.qtd;
  });

  lista.sort(function (a, b) {
    return b.media - a.media;
  });

  var top = lista[0];
  var bottom = lista[lista.length - 1];

  var comentarios = [];

  comentarios.push(
    "O estabelecimento com <b>maior ticket m√©dio</b> √© <b>" +
      top.nome +
      "</b>, com cerca de <b>" +
      top.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  comentarios.push(
    "O estabelecimento com <b>menor ticket m√©dio</b> √© <b>" +
      bottom.nome +
      "</b>, com cerca de <b>" +
      bottom.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
      "background:#F8FAFC;border-radius:4px;padding:6px;" +
      "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre os estabelecimentos:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

function vektorGerarInsightsPendenciasLojas(linhas) {
  if (!Array.isArray(linhas) || !linhas.length) return "";

  // mapeia s√≥ o que precisamos
  var lista = linhas
    .map(function (l) {
      return {
        nome: l.loja || l.nome || "Loja sem nome",
        valorPend: Number(l.valorPendente || 0),
        perc: Number(l.percPendente || 0),
        qtd: Number(l.totalPendencias || 0)
      };
    })
    .filter(function (x) {
      return x.valorPend > 0 || x.qtd > 0;
    });

  if (!lista.length) return "";

  // ordena por valor pendente
  lista.sort(function (a, b) {
    if (b.valorPend !== a.valorPend) return b.valorPend - a.valorPend;
    return b.qtd - a.qtd;
  });

  var totalPend = lista.reduce(function (acc, x) {
    return acc + x.valorPend;
  }, 0);

  var top1 = lista[0];
  var top2 = lista[1] || null;

  var comentarios = [];

  // Loja campe√£ de pend√™ncias
  var percTop1 = totalPend > 0 ? (top1.valorPend / totalPend) * 100 : 0;
  comentarios.push(
    "A loja <b>" + top1.nome +
    "</b> concentra o maior volume de <b>valor pendente</b>, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total em pend√™ncias."
  );

  // Segunda loja (se existir)
  if (top2) {
    var percTop2 = totalPend > 0 ? (top2.valorPend / totalPend) * 100 : 0;
    comentarios.push(
      "Em seguida vem a loja <b>" + top2.nome +
      "</b>, com aproximadamente <b>" +
      percTop2.toFixed(1).replace(".", ",") +
      "%</b> do valor total pendente."
    );
  }

  // Loja com maior % de pend√™ncia sobre o pr√≥prio volume
  var listaComPerc = lista
    .filter(function (x) { return x.perc > 0; })
    .slice()
    .sort(function (a, b) {
      return b.perc - a.perc;
    });

  if (listaComPerc.length) {
    var campeaPerc = listaComPerc[0];
    comentarios.push(
      "A loja <b>" + campeaPerc.nome +
      "</b> apresenta a maior propor√ß√£o de valor pendente em rela√ß√£o ao que transacionou no per√≠odo (" +
      campeaPerc.perc.toFixed(1).replace(".", ",") + "%)."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre pend√™ncias por loja:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// Drilldown: ao clicar numa fatura, detalha por TIME
window.vektorDrillTimesFatura = function (tr) {
  try {
    if (!tr) return;

    var extrato = tr.getAttribute("data-extrato-fatura") || "";
    var dataInicioIso = tr.getAttribute("data-inicio-fatura") || "";
    var dataFimIso = tr.getAttribute("data-fim-fatura") || "";

    extrato = extrato.trim();

    if (!extrato) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o extrato dessa fatura para detalhar por time.</p>"
      );
      return;
    }

    var periodoTexto = "";
    if (dataInicioIso || dataFimIso) {
      var ini = dataInicioIso ? new Date(dataInicioIso).toLocaleDateString("pt-BR") : "";
      var fim = dataFimIso ? new Date(dataFimIso).toLocaleDateString("pt-BR") : "";
      if (ini || fim) {
        periodoTexto = "Per√≠odo: " + ini + (fim ? " at√© " + fim : "");
      }
    }

    // Mensagem de contexto no chat
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a fatura <b>" + extrato +
        "</b> por <b>time</b>, considerando o mesmo ciclo do 'Extrato da conta'." +
        (periodoTexto ? "<br><span class='text-xs text-slate-500'>" + periodoTexto + "</span>" : "") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.times) || !res.times.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes por time para essa fatura.</p>"
          );
          return;
        }

        // Reaproveita o renderizador padr√£o de resumo por time
        renderResumoTransacoesPorTime(res, {
          titulo: "Times dessa fatura",
          periodoTexto: periodoTexto
        });
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao detalhar fatura por time:", err);

              vektorRegistrarContexto({
                  ultimaIntencao: "fatura_times",
                  ultimoPeriodo: {
                    dataInicioIso: dataInicioIso || "",
                    dataFimIso: dataFimIso || ""
                  },
                  ultimaLoja: null,
                  ultimaAcaoExplicavel: {
                    tipo: "tabela_times_fatura",
                    meta: {
                      extrato: extrato,
                      periodoTexto: periodoTexto
                    }
                  }
                });

        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao buscar o detalhamento por time para essa fatura.</p>"
        );
      })
      .getResumoTransacoesPorTimeExtrato(extrato, "valor");  // usa EXTRATO
  } catch (e) {
    console.error("Erro em vektorDrillTimesFatura:", e);
  }
};

window.vektorBaixarTransacoesFaturaLink = function (ev, el) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation(); // ‚úÖ impede disparar o onclick do <tr>
    }

    var extratoEnc = (el && el.getAttribute("data-extrato")) || "";
    var extrato = decodeURIComponent(extratoEnc || "");

    return window.vektorBaixarTransacoesFatura(ev, extrato);
  } catch (e) {
    console.error("Erro em vektorBaixarTransacoesFaturaLink:", e);
    return false;
  }
};

window.vektorBaixarTransacoesFatura = function (ev, extrato) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation(); // ‚úÖ evita disparar o drilldown da <tr>
    }

    extrato = (extrato || "").toString().trim();
    if (!extrato) {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o extrato para exportar.</p>");
      return false;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Gerando arquivo em excel da fatura <b>" + extrato + " "
    );

    google.script.run
      .withSuccessHandler(function (res) {
                if (!res || !res.ok || !res.xlsxBase64) {
                var msg = (res && res.error) ? res.error : "N√£o consegui gerar o Excel dessa fatura.";
                renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao exportar:</b> " + msg + "</p>");
                console.error("Resposta export XLSX:", res);
                return;
              }

        // base64 -> bytes
        var b64 = res.xlsxBase64;
        var byteChars = atob(b64);
        var byteNumbers = new Array(byteChars.length);
        for (var i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        var byteArray = new Uint8Array(byteNumbers);

        var blob = new Blob([byteArray], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download = res.filename || "transacoes_fatura.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao gerar CSV da fatura:", err);
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>Erro ao gerar o CSV dessa fatura.</p>");
      })
      .exportarTransacoesFaturaXlsx(extrato);

    return false;
  } catch (e) {
    console.error("Erro em vektorBaixarTransacoesFatura:", e);
    return false;
  }
};


/**
 * Filtra a lista completa de faturas segundo o modo de pergunta.
 * modo: "atual" | "anterior" | "ultimas" | "todas"
 * qtd: n√∫mero de faturas (quando modo = "ultimas")
 */

function vektorFiltrarFaturasPeloModo_(todas, modo, qtd) {
    if (!Array.isArray(todas) || !todas.length) return [];

        // üîß Ajuste de seguran√ßa:
    // Se o modo veio como "atual" mas temos uma quantidade maior que 1,
    // significa que em algum ponto a interpreta√ß√£o falhou.
    // Nesse caso, tratamos como "√∫ltimas N faturas".
    if (modo === "atual" && typeof qtd === "number" && qtd > 1) {
        modo = "ultimas";
    }

    // ---------------------------------------------------------
    // Fun√ß√£o para converter "06 Nov 2025" ‚Üí Date real
    // ---------------------------------------------------------
    function parseDataExt(dstr) {
        if (!dstr || typeof dstr !== "string") return null;
        // ex.: "06 Nov 2025"
        var m = dstr.trim().split(/\s+/);  // ["06","Nov","2025"]
        if (m.length !== 3) return null;

        var dia = Number(m[0]);
        var mes = m[1].toLowerCase();
        var ano = Number(m[2]);

        var mapaMes = {
            jan:0, feb:1, mar:2, apr:3, apr:3, mai:4, jun:5,
            jul:6, aug:7, set:8, sep:8, oct:9, out:9, nov:10, dec:11, dez:11
        };

        var mm = mapaMes[mes.substring(0,3)];
        if (mm === undefined) return null;

        return new Date(ano, mm, dia);
    }

    // ---------------------------------------------------------
    // Ordenar faturas REALMENTE por data de in√≠cio
    // ---------------------------------------------------------
    var lista = todas.slice().sort(function (a, b) {
        var da = parseDataExt(a.dataInicio);
        var db = parseDataExt(b.dataInicio);
        if (!da || !db) return 0;
        return da - db;
    });

    var agora = new Date();

    // ---------------------------------------------------------
    // Identificar fatura "atual"
    // ---------------------------------------------------------
    var idxAtual = -1;
    for (var i = 0; i < lista.length; i++) {
        var ini = parseDataExt(lista[i].dataInicio);
        var fim = parseDataExt(lista[i].dataFim);
        if (ini && fim && ini <= agora && agora <= fim) {
            idxAtual = i;
            break;
        }
    }

    // fallback
    if (idxAtual === -1) idxAtual = lista.length - 1;

    // ---------------------------------------------------------
    // Modos
    // ---------------------------------------------------------
    if (modo === "todas") {
        return lista;
    }

    if (modo === "ultimas") {
        var n = Number(qtd) || 2;
        if (n >= lista.length) return lista;
        return lista.slice(lista.length - n);
    }

    if (modo === "anterior") {
        if (idxAtual > 0) {
            return [lista[idxAtual - 1]];
        } else {
            return [lista[idxAtual]];
        }
    }

    // padr√£o ‚Üí atual
    return [lista[idxAtual]];
}

function vektorDiasAteFechamentoFaturaAtual() {
  const hoje = new Date();
  const dia = hoje.getDate();

  // fechamento sempre no dia 5
  let ano = hoje.getFullYear();
  let mes = hoje.getMonth(); // 0 = janeiro

  // Se j√° passou do dia 5, o pr√≥ximo fechamento √© no m√™s seguinte
  if (dia > 5) {
    mes += 1;
    if (mes > 11) {
      mes = 0;
      ano += 1;
    }
  }

  const fechamento = new Date(ano, mes, 5);

  const diffMs = fechamento.getTime() - hoje.getTime();
  const dias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  return Math.max(dias, 0); // n√£o deixa negativo
}


function vektorChamarPendJustLojas_(tipo) {
    var periodo  = window.__vektorUltimoPeriodoIso || {};
    var grupo    = window.__vektorUltimoGrupoBaseClara || "";
    var lojas    = window.__vektorUltimasLojasTabela || [];

    var ini = periodo.inicio || "";
    var fim = periodo.fim    || "";

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar as " +
            "pend√™ncias/justificativas na planilha BaseClara.</p>"
          );

          // üÜï Mesmo com erro ‚Üí troca spinner por check
          try {
            var statusId = (tipo === "pendencias")
              ? "vektor-status-pendencias"
              : "vektor-status-justificativas";

            var statusEl = document.getElementById(statusId);
            if (statusEl) {
              statusEl.innerHTML =
                "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
            }
          } catch (e) {}

          return;
        }

        var colunas = res.colunas || [];
        var html = "";

        if (tipo === "pendencias") {
          html = vektorMontarTabelaPendJust_(
            "PEND√äNCIAS DE JUSTIFICATIVAS POR LOJA",
            colunas,
            res.pendencias || []
          );
        } else {
          html = vektorMontarTabelaPendJust_(
            "TRANSA√á√ïES COM JUSTIFICATIVA COMPLETA POR LOJA",
            colunas,
            res.justificadas || []
          );
        }

        // Envia tabela
        renderBotMessage("HTML:" + html);

        // üÜï Troca spinner por check (caso de sucesso)
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
          }
        } catch (e) {}

      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as " +
          "pend√™ncias/justificativas na planilha.</p>"
        );

        // üÜï Mesmo no erro ‚Üí spinner vira check
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
          }
        } catch (e) {}

      })
      .getPendenciasEJustificativasPorLojas(
        grupo,
        ini,
        fim,
        lojas
      );
}

// ‚ö† Bot√£o "Verificar pend√™ncias"
window.vektorVerificarPendenciasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-pendencias' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando pend√™ncias das lojas dessa tabela no per√≠odo informado...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('pendencias');
};

// ‚úî Bot√£o "Verificar justificativas"
window.vektorVerificarJustificativasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-justificativas' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando transa√ß√µes com justificativas feitas de forma correta...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('justificativas');
};

// Bot√£o gen√©rico para expandir a tabela de pend√™ncias consolidadas
window.vektorDrilldownPendenciasDetalhadas = function () {
  try {
    vektorChamarPendJustLojas_('pendencias');
  } catch (e) {
    console.warn("Erro ao abrir drilldown de pend√™ncias:", e);
  }
};


// RESUMO POR TIME INICIO //

function renderResumoTransacoesPorTime(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar informa√ß√µes por <b>time</b> para esse per√≠odo.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto base do crit√©rio (valor x quantidade)
  var criterioTxt = (resumo.criterio === "valor")
    ? "maior <b>valor total</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes";

  // Lista completa de times vinda do back-end
  var all = Array.isArray(resumo.times) ? resumo.times : [];

  // H√° filtro expl√≠cito de times na pergunta? (ex.: "times X e Y")
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  // üîé Filtro opcional por lista de times (nomes)
if (temFiltroTimes) {
  var alvoNorms = opts.filtrarTimesNomes.map(function (n) {
    return normalize(String(n));
  });

  all = all.filter(function (t) {
    var nomeNorm = normalize(String(t.time || ""));

    // Mant√©m o time se QUALQUER alvo ‚Äúbater‚Äù como parte do nome
    return alvoNorms.some(function (alvo) {
      return (
        nomeNorm.indexOf(alvo) >= 0 ||   // ex.: "furacao sul csc" cont√©m "furacao sul"
        alvo.indexOf(nomeNorm) >= 0      // ou o contr√°rio, se o alvo for mais longo
      );
    });
  });
}

  // Quantas linhas exibir (para time: sem top => TODOS)
  var linhas = (typeof opts.topN === "number") ? all.slice(0, opts.topN) : all;

  // Somat√≥rios com base no que ser√° exibido
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // ===== Recalcula o "top time" somente com base nas linhas filtradas =====
  var campoCriterio = (resumo.criterio === "quantidade") ? "total" : "valorTotal";
  var topItem = null;
  var topValor = -Infinity;

  for (var j = 0; j < linhas.length; j++) {
    var item = linhas[j];
    var v = Number(item[campoCriterio]) || 0;
    if (v > topValor) {
      topValor = v;
      topItem = item;
    }
  }

  // Monta a fraseResumo usando APENAS os times considerados na tabela
  var fraseResumo;
  if (!linhas.length || !topItem || topValor <= 0) {
    fraseResumo = temFiltroTimes
      ? "N√£o encontrei transa√ß√µes para os times informados no per√≠odo selecionado."
      : "N√£o encontrei transa√ß√µes no per√≠odo selecionado.";
  } else if (temFiltroTimes) {
    fraseResumo =
      "Entre os times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b>, o <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no per√≠odo selecionado.";
  } else {
    // Comportamento padr√£o quando n√£o h√° filtro de times (ranking geral)
    fraseResumo =
      "O <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no per√≠odo selecionado.";
  }

  // ===== Montagem da tabela (mesmo padr√£o visual das outras) =====
  var linhasTabela = [];
  if (linhas.length) {

    // üîΩ Dropdown de drilldown para a tabela de TIMES
    linhasTabela.push(
      "<div style='margin-top:8px;margin-bottom:10px;font-size:12px;margin-bottom:4px;color:#334155;display:flex;align-items:center;gap:6px;'>" +
        "<span>Expandir a tabela por:</span>" +
        "<select class='vektor-drill-select' data-base='time' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='loja'>Lojas</option>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    // Tabela no padr√£o azul / borda igual √†s demais
    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Time</th>" +
        "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    // Linhas de times
    for (var k = 0; k < linhas.length; k++) {
      var t = linhas[k];
      var qtd = Number(t.total) || 0;
      var val = Number(t.valorTotal) || 0;

      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

      var hint =
        "Clique para detalhar este time pela dimens√£o selecionada (lojas, categorias ou estabelecimentos), " +
        "respeitando o mesmo per√≠odo da pergunta inicial.";

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this, 'time')\" " +
            "style='cursor:pointer;' " +
            "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + (t.time || "") + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

    // üÜï Insights autom√°ticos sobre os times (T√ìPICO 3)
  var insightsTimesHtml = vektorGerarInsightsTimes(linhas || []);


  // üîΩ Bot√£o de exporta√ß√£o em CSV para o resumo por TIME
  var botaoCsv = "";
  if (tabelaHtml) {
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_times')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  // Mantendo o lookerUrl como no seu c√≥digo original (se quiser usar depois)
  var lookerUrl = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      //"<p style='font-size:13px;color:#555;margin:4px 0 8px;'>Clique em uma linha para detalhar (drill-down) no chat.</p>",
      tabelaHtml,
      insightsTimesHtml || "",
      botaoCsv,
    "</div>"
  ].join("");

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaPendenciasPorLoja(resumo, dataInicioIso, dataFimIso) {
  var linhas = (resumo && resumo.linhas) || [];
  var totais = (resumo && resumo.totais) || {};
  var grupo  = resumo && (resumo.grupoOriginal || resumo.grupo) || "";

  // Guarda contexto para o drilldown
  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioIso || "",
    fim:    dataFimIso    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupo || "";
  window.__vektorUltimasLojasTabela = linhas.map(function (l) {
    return (l.loja || "").toString();
  });

  var linhasHtml = [];

    // Frase principal
  var fraseResumo = "Tabela consolidada de pend√™ncias por loja" +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    ".";
  linhasHtml.push("<p>" + fraseResumo + "</p>");

  // Garante per√≠odo: usa par√¢metros se existirem,
  // sen√£o usa o que estiver salvo no contexto global.
  var iniIso = dataInicioIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio) ||
    "";
  var fimIso = dataFimIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.fim) ||
    "";

  var frasePeriodo = vektorFraseResumoPeriodo(iniIso, fimIso);
  if (frasePeriodo) {
    linhasHtml.push(
      "<p style='margin-top:2px;font-size:11px;color:#475569;'>" +
      frasePeriodo +
      "</p>"
    );
  }

  // linha em branco
  linhasHtml.push("<div style='height:8px;'></div>");

  // Bot√£o centralizado de drilldown (usa fluxo padr√£o de pend√™ncias)
  linhasHtml.push(
    "<div style='text-align:center;margin-bottom:8px;'>" +
      "<button type='button' " +
        "onclick=\"vektorVerificarPendenciasLojas()\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;" +
               "border-radius:4px;font-size:12px;cursor:pointer;'>" +
        "üîç Ver detalhamento das transa√ß√µes pendentes" +
      "</button>" +
    "</div>"
  );

  // Espa√ßo entre bot√£o e tabela
  linhasHtml.push("<div style='height:8px;'></div>");

  // Tabela
  linhasHtml.push("<div style='overflow-x:auto;'>");
  linhasHtml.push("<table style='border-collapse:collapse;width:100%;font-size:12px;'>");

  linhasHtml.push(
    "<thead><tr>" +
      // 4 primeiras colunas: verde claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Loja</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Qtd Transa√ß√µes Pendentes</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Valor Total Pendente (R$)</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>% do Valor Pendente</th>" +
      // 3 colunas de tipo de pend√™ncia: vermelho claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Etiqueta</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Descri√ß√£o</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Nota fiscal/Recibo</th>" +
    "</tr></thead><tbody>"
  );

  var totalValPend = 0;
  var totalValTrans = 0;

  linhas.forEach(function (l) {
    var loja          = l.loja || "";
    var qtdPend       = Number(l.totalPendencias || 0);
    var valorPend     = Number(l.valorPendente || 0);
    var percPend      = Number(l.percPendente || 0);
    var pendEtiq      = Number(l.pendEtiqueta || 0);
    var pendDesc      = Number(l.pendDescricao || 0);
    var pendRec       = Number(l.pendRecibo || 0);

    totalValPend  += valorPend;
    totalValTrans += Number(l.valorTransacionado || 0);

    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + loja + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + qtdPend + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          valorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          (percPend > 0 ? percPend.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendEtiq + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendDesc + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendRec + "</td>" +
      "</tr>"
    );
  });

  var totQtdPend   = Number(totais.totalPendencias || 0);
  var totValorPend = Number(totais.valorPendente || 0);
  var totEtiq      = Number(totais.pendEtiqueta || 0);
  var totDesc      = Number(totais.pendDescricao || 0);
  var totRec       = Number(totais.pendRecibo || 0);
  var totValTrans  = Number(totais.valorTransacionado || 0);

  var percGeral = 0;
  if (totValTrans > 0 && totValorPend > 0) {
    percGeral = (totValorPend / totValTrans) * 100;
  }

  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totQtdPend + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        totValorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        (percGeral > 0 ? percGeral.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totEtiq + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totDesc + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totRec + "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  var tabelaHtml = linhasHtml.join("");
  var insightsHtml = vektorGerarInsightsPendenciasLojas(linhas);

  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'pendencias_por_loja')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      tabelaHtml +
      (insightsHtml || "") +
      botoesHtml +
    "</div>";

  return html;
}

// Chamada ao Apps Script
function vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso) {
  // Se n√£o veio per√≠odo expl√≠cito, usamos √∫ltimos 30 dias
  var inicio = dataInicioIso;
  var fim = dataFimIso;

  if (!inicio || !fim) {
    var hoje = new Date();
    var fimDate = hoje;
    var iniDate = new Date();
    iniDate.setDate(hoje.getDate() - 30);

    inicio = iniDate.toISOString();
    fim = fimDate.toISOString();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou montar a tabela de <b>pend√™ncias por loja</b> do time <b>" +
    (grupo || "") + "</b> no per√≠odo informado...</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.ok) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consolidar as pend√™ncias por loja na BaseClara.</p>"
        );
        return;
      }

      var htmlTabela = vektorRenderTabelaPendenciasPorLoja(res, inicio, fim);
      renderBotMessage("HTML:" + htmlTabela);
    })
    .withFailureHandler(function (err) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as pend√™ncias por loja na BaseClara.</p>"
      );
      console.error(err);
    })
    .getResumoPendenciasPorLoja(
      grupo || "",
      inicio || "",
      fim || ""
    );
}

function vektorGerarInsightsPendenciasTimes(linhas) {
  if (!Array.isArray(linhas) || !linhas.length) return "";

  var lista = linhas
    .map(function (t) {
      return {
        nome: t.time || t.grupo || "Time sem nome",
        valorPend: Number(t.valorPendente || 0),
        perc: Number(t.percPendente || 0),
        qtd: Number(t.totalPendencias || 0)
      };
    })
    .filter(function (x) {
      return x.valorPend > 0 || x.qtd > 0;
    });

  if (!lista.length) return "";

  lista.sort(function (a, b) {
    if (b.valorPend !== a.valorPend) return b.valorPend - a.valorPend;
    return b.qtd - a.qtd;
  });

  var totalPend = lista.reduce(function (acc, x) { return acc + x.valorPend; }, 0);

  var top1 = lista[0];
  var top2 = lista[1] || null;

  var comentarios = [];

  var percTop1 = totalPend > 0 ? (top1.valorPend / totalPend) * 100 : 0;
  comentarios.push(
    "O time <b>" + top1.nome +
    "</b> concentra o maior valor em pend√™ncias, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total pendente."
  );

  if (top2) {
    var percTop2 = totalPend > 0 ? (top2.valorPend / totalPend) * 100 : 0;
    comentarios.push(
      "Na sequ√™ncia, o time <b>" + top2.nome +
      "</b> responde por aproximadamente <b>" +
      percTop2.toFixed(1).replace(".", ",") +
      "%</b> do valor pendente."
    );
  }

  var listaComPerc = lista
    .filter(function (x) { return x.perc > 0; })
    .slice()
    .sort(function (a, b) { return b.perc - a.perc; });

  if (listaComPerc.length) {
    var campeaoPerc = listaComPerc[0];
    comentarios.push(
      "O time <b>" + campeaoPerc.nome +
      "</b> tem a maior propor√ß√£o de valor pendente sobre o que transacionou no per√≠odo<b> (" +
      campeaoPerc.perc.toFixed(1).replace(".", ",") + "%)</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre pend√™ncias por time:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) { return "<li>" + c + "</li>"; }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

function vektorRenderTabelaPendenciasPorTime(resumo, dataInicioIso, dataFimIso) {
  var linhas = (resumo && resumo.linhas) || [];
  var totais = (resumo && resumo.totais) || {};

  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioIso || "",
    fim:    dataFimIso    || ""
  };
  window.__vektorUltimoGrupoBaseClara = "";
  window.__vektorUltimasLojasTabela = [];

  var linhasHtml = [];

  // Frase principal
  linhasHtml.push("<p>Tabela consolidada de pend√™ncias por time.</p>");

  // Per√≠odo: par√¢metros (se existirem) OU contexto global
  var iniIso = dataInicioIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio) ||
    "";
  var fimIso = dataFimIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.fim) ||
    "";

  var frasePeriodo = vektorFraseResumoPeriodo(iniIso, fimIso);
  if (frasePeriodo) {
    linhasHtml.push(
      "<p style='margin-top:2px;font-size:11px;color:#475569;'>" +
      frasePeriodo +
      "</p>"
    );
  }

  linhasHtml.push("<div style='height:8px;'></div>");

  // Bot√£o de drilldown (usa fluxo padr√£o de pend√™ncias)
  linhasHtml.push(
    "<div style='text-align:center;margin-bottom:8px;'>" +
      "<button type='button' " +
        "onclick=\"vektorVerificarPendenciasLojas()\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;" +
               "border-radius:4px;font-size:12px;cursor:pointer;'>" +
        "üîç Ver detalhamento das transa√ß√µes pendentes" +
      "</button>" +
    "</div>"
  );

  linhasHtml.push("<div style='height:8px;'></div>");

  linhasHtml.push("<div style='overflow-x:auto;'>");
  linhasHtml.push("<table style='border-collapse:collapse;width:100%;font-size:12px;'>");

  linhasHtml.push(
    "<thead><tr>" +
      // colunas "gerais" em verde
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Time</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Qtd Transa√ß√µes Pendentes</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Valor Total Pendente (R$)</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>% do Valor Pendente</th>" +
      // colunas de tipos em vermelho claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Etiqueta</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Descri√ß√£o</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Nota fiscal/Recibo</th>" +
    "</tr></thead><tbody>"
  );

  linhas.forEach(function (t) {
    var nome         = t.time || t.grupo || "";
    var qtdPend      = Number(t.totalPendencias || 0);
    var valorPend    = Number(t.valorPendente || 0);
    var percPend     = Number(t.percPendente || 0);
    var pendEtiq     = Number(t.pendEtiqueta || 0);
    var pendDesc     = Number(t.pendDescricao || 0);
    var pendRec      = Number(t.pendRecibo || 0);

    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + nome + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + qtdPend + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          valorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          (percPend > 0 ? percPend.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendEtiq + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendDesc + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendRec + "</td>" +
      "</tr>"
    );
  });

  var totQtdPend   = Number(totais.totalPendencias || 0);
  var totValorPend = Number(totais.valorPendente || 0);
  var totEtiq      = Number(totais.pendEtiqueta || 0);
  var totDesc      = Number(totais.pendDescricao || 0);
  var totRec       = Number(totais.pendRecibo || 0);
  var totValTrans  = Number(totais.valorTransacionado || 0);

  var percGeral = 0;
  if (totValTrans > 0 && totValorPend > 0) {
    percGeral = (totValorPend / totValTrans) * 100;
  }

  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totQtdPend + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        totValorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        (percGeral > 0 ? percGeral.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totEtiq + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totDesc + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totRec + "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  var tabelaHtml = linhasHtml.join("");
  var insightsHtml = vektorGerarInsightsPendenciasTimes(linhas);

  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'pendencias_por_time')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      tabelaHtml +
      (insightsHtml || "") +
      botoesHtml +
    "</div>";

  return html;
}

function vektorMostrarPendenciasPorTimeTodos(dataInicioIso, dataFimIso) {
  var inicio = dataInicioIso;
  var fim = dataFimIso;

  if (!inicio || !fim) {
    var hoje = new Date();
    var fimDate = hoje;
    var iniDate = new Date();
    iniDate.setDate(hoje.getDate() - 30);

    inicio = iniDate.toISOString();
    fim = fimDate.toISOString();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou montar a tabela de <b>pend√™ncias por time</b> para o per√≠odo informado...</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.ok) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consolidar as pend√™ncias por time na BaseClara.</p>"
        );
        return;
      }

      var htmlTabela = vektorRenderTabelaPendenciasPorTime(res, inicio, fim);
      renderBotMessage("HTML:" + htmlTabela);
    })
    .withFailureHandler(function (err) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as pend√™ncias por time na BaseClara.</p>"
      );
      console.error(err);
    })
    .getResumoPendenciasPorTime(
      inicio || "",
      fim || "",
      "" // todos os times
    );
}

// ===== RENDER: Maiores transa√ß√µes individuais (loja / time) =====
function renderMaioresTransacoesIndividuais(res) {
  if (!res || res.ok === false) {
    var msgErro = (res && res.error) ? res.error : "Erro desconhecido ao consultar as maiores transa√ß√µes.";
    renderBotMessage("HTML:<p class='text-sm text-red-700'>" + msgErro + "</p>");
    return;
  }

  var linhas = Array.isArray(res.linhas) ? res.linhas : [];
  var loja   = res.loja  || "";
  var grupo  = res.grupo || "";
  var topN   = res.topN  || null;

  var periodoDescricao   = res.periodoDescricao || "";
  var dataInicioIso      = res.dataInicioIso || "";
  var dataFimIso         = res.dataFimIso    || "";
  var totalSelecionadas  = Number(res.totalSelecionadas || 0);

  // Se n√£o houver linhas
  if (!linhas.length) {
    var msgVazio = "N√£o encontrei transa√ß√µes no per√≠odo selecionado ";
    if (loja)  msgVazio += "para a loja <b>" + loja + "</b> ";
    if (grupo) msgVazio += "do time <b>" + grupo + "</b> ";
    if (periodoDescricao) {
      msgVazio += "(" + periodoDescricao + ").";
    } else {
      msgVazio += ".";
    }
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + msgVazio + "</p>");
    return;
  }

  var titulo = "Maiores transa√ß√µes individuais";
  if (loja)  titulo += " - Loja " + loja;
  if (grupo) titulo += (loja ? " | " : " - ") + "Time " + grupo;
  if (topN) {
    titulo += " (Top " + topN + ")";
  }

  var linhasHtml = [];

  linhasHtml.push("<div class='text-sm text-slate-700'>");
  linhasHtml.push("<p style='margin:0 0 4px 0;'><b>" + titulo + "</b></p>");

  if (periodoDescricao) {
    linhasHtml.push(
      "<p style='margin:0 0 8px 0;font-size:12px;color:#334155;'>" +
        "Per√≠odo da consulta: " + periodoDescricao + "." +
      "</p>"
    );
  } else if (dataInicioIso && dataFimIso) {
    var frasePeriodo = vektorFraseResumoPeriodo(dataInicioIso, dataFimIso);
    if (frasePeriodo) {
      linhasHtml.push(
        "<p style='margin:0 0 8px 0;font-size:12px;color:#334155;'>" +
          "Per√≠odo da consulta: " + frasePeriodo + "." +
        "</p>"
      );
    }
  }

  // Tabela
  linhasHtml.push(
    "<table border='1' cellspacing='0' cellpadding='4' " +
      "style='border-collapse:collapse;width:100%;font-size:12px;text-align:center;border:1px solid #000;'>"
  );

  // Cabe√ßalho
  linhasHtml.push(
    "<thead>" +
      "<tr style='background:#06167d;color:#fff;'>" +
        "<th style='border:1px solid #000;padding:4px;'>Loja</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Estabelecimento</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Data</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Status</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Categoria</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Titular</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Valor (R$)</th>" +
      "</tr>" +
    "</thead><tbody>"
  );

      // Linhas da tabela
    for (var i = 0; i < linhas.length; i++) {
      var l = linhas[i] || {};
      var lojaVal     = l.loja || "";
      var estabVal    = l.estabelecimento || "";
      var dataVal     = l.data || "";
      var statusVal   = l.status || "";
      var categoriaVal= l.categoria || "";
      var titularVal  = l.titular || "";
      var valorVal    = Number(l.valor || 0);

      linhasHtml.push(
        "<tr>" +
          "<td style='border:1px solid #000;padding:4px;'>" + lojaVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + estabVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + dataVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + statusVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + categoriaVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + titularVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" +
            valorVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
        "</tr>"
      );
    }

  // Linha de TOTAL no final da coluna de valor
  linhasHtml.push(
    "<tr style='background:#e5e7eb;font-weight:bold;'>" +
      "<td colspan='6' style='border:1px solid #000;padding:4px;text-align:right;'>Total</td>" +
      "<td style='border:1px solid #000;padding:4px;'>" +
        totalSelecionadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table>");

  // Bot√£o Exportar CSV ABAIXO da tabela
  linhasHtml.push(
    "<div style='margin-top:6px;text-align:right;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'maiores_transacoes_individuais')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "‚¨á Exportar CSV" +
      "</button>" +
    "</div>"
  );

  linhasHtml.push("</div>");

  var html = linhasHtml.join("");

  try { ultimaIntencao = "maiores_transacoes_individuais"; } catch (e) {}

  renderBotMessage("HTML:" + html);
}

function vektorRenderTransacoesPorCategoria(res, nomeCategoria) {
  if (!res || !res.ok) {
    return "<p class='text-sm text-slate-700'>N√£o consegui montar a tabela de transa√ß√µes dessa categoria.</p>";
  }

  var linhas = res.linhas || [];
  var dataInicioIso = res.dataInicioIso || "";
  var dataFimIso    = res.dataFimIso || "";
  var total = Number(res.total || 0);

  // Se n√£o tiver linhas
  if (!linhas.length) {
    return (
      "<p class='text-sm text-slate-700'>" +
        "N√£o encontrei transa√ß√µes para a categoria <b>" + (nomeCategoria || "") +
        "</b> nesse per√≠odo." +
      "</p>"
    );
  }

  // Per√≠odo em dd/MM/yyyy
  var periodoHtml = "";
  try {
    if (dataInicioIso && dataFimIso) {
      var di = new Date(dataInicioIso);
      var df = new Date(dataFimIso);
      var diBr = di.toLocaleDateString("pt-BR");
      var dfBr = df.toLocaleDateString("pt-BR");
      periodoHtml =
        "<p class='text-xs text-slate-500 mt-1'>" +
          "Per√≠odo da consulta: de " + diBr + " a " + dfBr + "." +
        "</p>";
    }
  } catch (e) {
    console.error("Erro ao formatar per√≠odo em vektorRenderTransacoesPorCategoria:", e);
  }

  var linhasHtml = [];

  linhasHtml.push(
    "<p class='mb-1'>Transa√ß√µes da categoria <b>" + (nomeCategoria || "") + "</b>.</p>" +
    periodoHtml
  );

  linhasHtml.push("<div style='overflow-x:auto;margin-top:4px;'>");

  // ‚úÖ Valor (R$) movido para a √öLTIMA coluna
  linhasHtml.push(
    "<table style='border-collapse:collapse;width:100%;font-size:12px;'>" +
      "<thead><tr>" +
        "<th style='border:1px solid #000;padding:4px;text-align:center;background:#E5E7EB;'>Loja</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Transa√ß√£o</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:center;background:#E5E7EB;'>Data</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Titular</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Grupos</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Recibo</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Etiquetas</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Descri√ß√£o</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:right;background:#E5E7EB;'>Valor (R$)</th>" +
      "</tr></thead><tbody>"
  );

  for (var i = 0; i < linhas.length; i++) {
    var l = linhas[i] || {};
    var loja  = l.loja || "";
    var trans = l.transacao || "";
    var data  = l.data || "";
    var val   = Number(l.valor || 0);

    var titular   = l.titular || "";
    var grupos    = l.grupos || "";
    var recibo    = l.recibo || "";
    var etiquetas = l.etiquetas || "";
    var descricao = l.descricao || "";

    // ‚úÖ Valor movido para o √öLTIMO <td>
    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + loja + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + trans + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + data + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + titular + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + grupos + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + recibo + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + etiquetas + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + descricao + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
          val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
      "</tr>"
    );
  }

  // Linha TOTAL (colspan continua correto: 8)
  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td colspan='8' style='border:1px solid #000;padding:4px;text-align:right;'>Total</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
        total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  // Bot√£o de CSV
  linhasHtml.push(
    "<div style='margin-top:8px;display:flex;justify-content:flex-end;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'transacoes_categoria')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "‚¨á Exportar CSV" +
      "</button>" +
    "</div>"
  );

  return "<div class='text-sm text-slate-700'>" + linhasHtml.join("") + "</div>";
}

// üîΩ Drilldown da fatura para TIMES, respeitando o per√≠odo da fatura
window.vektorDetalharFaturaPorTime = function (tr) {
  try {
    if (!tr) return;

    var inicioIso = tr.getAttribute("data-inicio") || "";
    var fimIso    = tr.getAttribute("data-fim") || "";

    // Pega o texto da fatura para mostrar na mensagem
    var extrato = "";
    if (tr.cells && tr.cells.length > 0) {
      extrato = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    }

    // Se n√£o tiver per√≠odo, n√£o faz sentido puxar times
    if (!inicioIso || !fimIso) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>" +
          "N√£o consegui identificar o per√≠odo dessa fatura para detalhar por time. " +
          "Verifique se o campo <b>Extrato da conta</b> est√° no formato esperado na BaseClara." +
        "</p>"
      );
      return;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou detalhar a fatura <b>" + extrato + "</b> " +
        "por <b>time</b>, considerando apenas as transa√ß√µes desse per√≠odo." +
      "</p>"
    );

    // Chama o Apps Script para montar o resumo por time
    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "N√£o consegui montar o resumo por time para esse per√≠odo de fatura." +
            "</p>"
          );
          return;
        }

        // Reutiliza o renderizador geral de times
        // topN: null -> lista todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Tive um problema ao detalhar esta fatura por time." +
          "</p>"
        );
      })
      .getResumoTransacoesPorTime(
        inicioIso, // data in√≠cio da fatura
        fimIso,    // data fim da fatura
        "valor"    // crit√©rio: agrupar por VALOR da fatura
      );

  } catch (e) {
    console.error("Erro em vektorDetalharFaturaPorTime:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Tive um problema ao detalhar esta fatura por time." +
      "</p>"
    );
  }
};

// ========= RENDER GEN√âRICO: CATEGORIAS / ESTABELECIMENTOS ========= //

function renderResumoPorChaveGenerico(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui montar o resumo para esse pedido.</p>"
    );
    return;
  }

  opts = opts || {};
  var tipoChave = opts.tipoChave || "Categoria"; // "Categoria" ou "Estabelecimento"
  var titulo    = opts.titulo || ("Resumo por " + tipoChave.toLowerCase());
  
  // ‚úÖ aceita topN como n√∫mero OU string num√©rica ("10")
var topN = null;
if (opts.topN !== undefined && opts.topN !== null && opts.topN !== "") {
  var n = Number(opts.topN);
  if (!isNaN(n) && n > 0) topN = n;
}

  // ===== Defini√ß√£o da base da tabela (categoria/estabelecimento/loja/time)
  var tipoChaveLower = tipoChave.toLowerCase();
  // ‚úÖ Default Top 10 somente para Estabelecimento quando n√£o vier topN
if (tipoChaveLower === "estabelecimento" && topN === null) {
  topN = 10;
}
  var baseTabela      = "categoria";    // usado no data-base do <select>
  var tipoTabelaExpand = "categoria";   // par√¢metro passado para vektorExpandirLinha
  var hintBase        = "";

  if (tipoChaveLower === "estabelecimento") {
    baseTabela       = "estabelecimento";
    tipoTabelaExpand = "estabelecimento";
    hintBase =
      "Clique para detalhar este estabelecimento pela dimens√£o selecionada (lojas, times ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "categoria") {
    baseTabela       = "categoria";
    tipoTabelaExpand = "categoria";
    hintBase =
      "Clique para detalhar esta categoria pela dimens√£o selecionada (lojas, times ou estabelecimentos), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "loja") {
    baseTabela       = "loja";
    tipoTabelaExpand = "loja";
    hintBase =
      "Clique para detalhar esta loja pela dimens√£o selecionada (times, estabelecimentos ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "time") {
    baseTabela       = "time";
    tipoTabelaExpand = "time";
    hintBase =
      "Clique para detalhar este time pela dimens√£o selecionada (lojas, estabelecimentos ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  }

  // Descobre qual lista veio do backend
  var lista = [];
  if (Array.isArray(resumo.categorias)) {
    lista = resumo.categorias;
  } else if (Array.isArray(resumo.estabelecimentos)) {
    lista = resumo.estabelecimentos;
  } else if (Array.isArray(resumo.linhas)) {
    lista = resumo.linhas;
  }

  if (!lista.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei movimenta√ß√µes para esse filtro.</p>"
    );
    return;
  }

  // Se tiver topN, recorta
  if (topN !== null && lista.length > topN) {
    lista = lista.slice(0, topN);
  }

  // Calcula somat√≥rios para porcentagens
  var totalQtd = 0;
  var totalValor = 0;

  for (var i = 0; i < lista.length; i++) {
    var it = lista[i];
    totalQtd   += Number(it.total || it.qtd || 0);
    totalValor += Number(it.valorTotal || it.valor || 0);
  }

  var linhasTabela = [];

  // üîπ Agora tamb√©m queremos drilldown em ESTABELECIMENTO (clique direto na linha)
  var temDrilldown = true;

  // ===== üîΩ DROPDOWN DE DRILLDOWN (somente se tiver drilldown) =====
  if (temDrilldown && baseTabela !== "categoria" && baseTabela !== "estabelecimento") {
    var opcoes = [];
    // Regra: todas as dimens√µes menos a pr√≥pria baseTabela
    if (baseTabela !== "time")            opcoes.push("<option value='time'>Times</option>");
    if (baseTabela !== "loja")            opcoes.push("<option value='loja'>Lojas</option>");
    if (baseTabela !== "estabelecimento") opcoes.push("<option value='estabelecimento'>Estabelecimentos</option>");
    if (baseTabela !== "categoria")       opcoes.push("<option value='categoria'>Categorias</option>");

    linhasTabela.push(
      "<div style='font-size:11px;margin-bottom:4px;color:#334155'>" +
        "Drilldown desta tabela de " + tipoChave.toLowerCase() + ": " +
        "<select class='vektor-drill-select' data-base='" + baseTabela + "' " +
                "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          opcoes.join("") +
        "</select>" +
      "</div>"
    );
  }

  // ===== TABELA PRINCIPAL =====
  linhasTabela.push(
    "<table border='1' cellspacing='0' cellpadding='6' " +
    "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
    "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
  );

  linhasTabela.push(
    "<tr style='background:#06167d;color:#fff'>" +
      "<th style='border:1px solid #000;'>" + tipoChave + "</th>" +
      "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
      "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
      "<th style='border:1px solid #000;'>Valor (R$)</th>" +
      "<th style='border:1px solid #000;'>% Valor</th>" +
    "</tr>"
  );

  for (var j = 0; j < lista.length; j++) {
  var l = lista[j];
  var nome =
    l.estabelecimento ||
    l.categoria ||
    l.chave ||
    "‚Äî";

  var qtd   = Number(l.total || l.qtd || 0);
  var valor = Number(l.valorTotal || l.valor || 0);

  var pctQtd = totalQtd   > 0 ? ((qtd   / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
  var pctVal = totalValor > 0 ? ((valor / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

  // ========== CATEGORIAS RESTRITAS: fundo vermelho claro ==========
  var estiloLinhaExtra = "";
  if (tipoChaveLower === "categoria") {
    var nomeNorm = (nome || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();

    var categoriasRestritas = [
      "combustiveis",
      "transporte",
      "eletronicos",
      "imoveis",
      "entretenimento",
      "pagamentos do governo",
      "causas sociais",
      "educacao",
      "joias e cassino",
      "joias",
      "cassino",
      "saude",
      "viagem e hospedagem",
      "aluguel de veiculos",
      "assinaturas"
    ];

    if (categoriasRestritas.indexOf(nomeNorm) !== -1) {
      // vermelho claro
      estiloLinhaExtra = "background:#FFB3B3;";
    }
  }

  // ===== LINHA: com ou sem onclick dependendo do drilldown =====
  if (temDrilldown) {
    // Categoria ‚Üí drilldown espec√≠fico para transa√ß√µes (vamos criar j√° j√°)
    if (tipoChaveLower === "categoria" && baseTabela === "categoria") {
      linhasTabela.push(
        "<tr onclick=\"vektorDrillTransacoesCategoria('" + nome.replace(/'/g, "\\'") + "')\" " +
          "style='cursor:pointer;" + estiloLinhaExtra + "' " +
          "title=\"Clique para ver as transa√ß√µes dessa categoria no mesmo per√≠odo.\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    } 
    
    // Estabelecimento ‚Üí drilldown espec√≠fico para transa√ß√µes por loja
else if (tipoChaveLower === "estabelecimento" && baseTabela === "estabelecimento") {
  linhasTabela.push(
    "<tr onclick=\"vektorDrillTransacoesEstabelecimento('" + nome.replace(/'/g, "\\'") + "')\" " +
      "style='cursor:pointer;" + estiloLinhaExtra + "' " +
      "title=\"Clique para ver as transa√ß√µes desse estabelecimento por loja no mesmo per√≠odo.\">" +
      "<td style='border:1px solid #000;'>" + nome + "</td>" +
      "<td style='border:1px solid #000;'>" + qtd + "</td>" +
      "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
      "<td style='border:1px solid #000;'>" +
        valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
    "</tr>"
  );
}
    
    else {
      // Drilldown padr√£o (times, lojas, estabelecimentos, etc.)
      var hint = hintBase;
      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'" + tipoTabelaExpand + "')\" " +
          "style='cursor:pointer;" + estiloLinhaExtra + "' title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }
  } else {
    // Sem drilldown ‚Üí apenas aplica cor quando necess√°rio
    linhasTabela.push(
      "<tr style='" + estiloLinhaExtra + "'>" +
        "<td style='border:1px solid #000;'>" + nome + "</td>" +
        "<td style='border:1px solid #000;'>" + qtd + "</td>" +
        "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
        "<td style='border:1px solid #000;'>" +
          valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
      "</tr>"
    );
  }
}

  // Linha de TOTAL
  linhasTabela.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;'>TOTAL</td>" +
      "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
      "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
      "<td style='border:1px solid #000;'>" +
        totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
    "</tr>"
  );

  linhasTabela.push("</table>");

  // Bot√£o CSV
  var botaoCsv = "";
  if (linhasTabela.length) {
    var slug = tipoChave.toLowerCase();
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'resumo_" + slug + "')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

    // ===== Per√≠odo da consulta (apenas para Categorias) =====
  var periodoHtml = "";
  if (tipoChaveLower === "categoria") {
    var dataInicioIso = "";
    var dataFimIso    = "";

    // 1) Tenta vir do pr√≥prio resumo (caso o backend envie)
    if (resumo.dataInicioIso && resumo.dataFimIso) {
      dataInicioIso = resumo.dataInicioIso;
      dataFimIso    = resumo.dataFimIso;
    }
    // 2) Sen√£o, cai no cache global do per√≠odo
    else if (
      window.__vektorUltimoPeriodo &&
      window.__vektorUltimoPeriodo.dataInicio &&
      window.__vektorUltimoPeriodo.dataFim
    ) {
      dataInicioIso = window.__vektorUltimoPeriodo.dataInicio.toISOString();
      dataFimIso    = window.__vektorUltimoPeriodo.dataFim.toISOString();
    }

    if (dataInicioIso && dataFimIso) {
      try {
        var di = new Date(dataInicioIso);
        var df = new Date(dataFimIso);
        var diBr = di.toLocaleDateString("pt-BR");
        var dfBr = df.toLocaleDateString("pt-BR");

        periodoHtml =
          "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
            "Per√≠odo da consulta: de " + diBr + " a " + dfBr + "." +
          "</p>";
      } catch (e) {
        console.error("N√£o consegui formatar per√≠odo em renderResumoPorChaveGenerico:", e);
      }
    }
  }

      // ===== Per√≠odo da consulta (prioriza o que vem do back-end) =====
  var periodoHtml = "";
  if (tipoChaveLower === "categoria" || tipoChaveLower === "estabelecimento") {
    try {
      var di = null, df = null;

      // 1) Tenta pegar diretamente do objeto resumo retornado pelo Apps Script
      if (resumo && resumo.dataInicioIso && resumo.dataFimIso) {
        di = new Date(resumo.dataInicioIso);
        df = new Date(resumo.dataFimIso);
      }

      // 2) Se n√£o tiver no resumo, usa o cache global do √∫ltimo per√≠odo interpretado
      if (
        (!di || !df || isNaN(di.getTime()) || isNaN(df.getTime())) &&
        window.__vektorUltimoPeriodo &&
        window.__vektorUltimoPeriodo.dataInicio &&
        window.__vektorUltimoPeriodo.dataFim
      ) {
        di = window.__vektorUltimoPeriodo.dataInicio;
        df = window.__vektorUltimoPeriodo.dataFim;
      }

      if (di && df && !isNaN(di.getTime()) && !isNaN(df.getTime())) {
        var diBr = di.toLocaleDateString("pt-BR");
        var dfBr = df.toLocaleDateString("pt-BR");

        periodoHtml =
          "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
            "Per√≠odo da consulta: de " + diBr + " a " + dfBr + "." +
          "</p>";
      }
    } catch (e) {
      console.error("Erro ao montar periodoHtml em renderResumoPorChaveGenerico:", e);
    }
  }

  // Dica de drilldown ‚Äì s√≥ para categorias
  var dicaDrilldown = "";
  if (tipoChaveLower === "categoria") {
    dicaDrilldown =
      "<p style='font-size:12px;color:#64748B;margin-top:2px;'>" +
        "Clique em uma categoria para ver as transa√ß√µes individuais dela no mesmo per√≠odo." +
      "</p>";
  }

  // Dica de drilldown ‚Äì para estabelecimentos
if (tipoChaveLower === "estabelecimento") {
  dicaDrilldown =
    "<p style='font-size:12px;color:#64748B;margin-top:2px;'>" +
      "Clique em um estabelecimento para ver as transa√ß√µes individuais por loja no mesmo per√≠odo." +
    "</p>";
}

  // HTML final
  var html =
    "<div class='text-sm text-slate-700'>" +
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>" +
      periodoHtml +
      dicaDrilldown +
      linhasTabela.join("") +
      botaoCsv +
    "</div>";

  renderBotMessage("HTML:" + html);

  // üîé Insights autom√°ticos adicionais para Categoria / Estabelecimento (ticket m√©dio)
  var tipoLower = tipoChaveLower;
  if (tipoLower === "categoria" || tipoLower === "estabelecimento") {
    var listaInsights = lista
      .map(function (l) {
        return {
          nome: l.estabelecimento || l.categoria || l.chave || "‚Äî",
          valor: Number(l.valorTotal || l.valor || 0),
          qtd: Number(l.total || l.qtd || 0)
        };
      })
      .filter(function (l) {
        return l.qtd > 0 && l.valor > 0;
      });

    var insightsHtml = "";
    if (tipoLower === "categoria") {
      insightsHtml = vektorGerarInsightsResumoCategorias(listaInsights);
    } else {
      insightsHtml = vektorGerarInsightsResumoEstabelecimentos(listaInsights);
    }

    if (insightsHtml) {
      renderBotMessage("HTML:" + insightsHtml);
    }
  }

  // üß† NOVO: insights autom√°ticos espec√≠ficos para Categoria / Estabelecimento
  if (
    opts &&
    (opts.tipoChave === "Categoria" || opts.tipoChave === "Estabelecimento")
  ) {
    const htmlInsightsExtra = gerarInsightsResumoChaveCategoriaEstab(resumo, {
      tipoChave: opts.tipoChave
    });

    if (htmlInsightsExtra) {
      renderBotMessage("HTML:" + htmlInsightsExtra);
    }
  }
}

// ================= INFORMA√á√ïES INICIAIS (APENAS ADMIN) ===================

function vektorMostrarPerguntaInfoInicial() {
  try {
    // S√≥ ADM recebe essa pergunta
    if (USER_ROLE_REPLACED !== "Administrador") {
      return;
    }

    const chatWindow = document.getElementById("chatWindow");
    if (!chatWindow) return;

    // Evita duplicar se o usu√°rio recarregar
    if (document.getElementById("vektor-info-inicial-pergunta")) return;

    const div = document.createElement("div");
    div.id = "vektor-info-inicial-pergunta";
    div.className = "flex items-start gap-3 mt-3";

    div.innerHTML = `
      <div class="bot-bubble px-4 py-3 max-w-[80%]">
        <p class="text-sm text-slate-700">
          Voc√™ quer ver as principais informa√ß√µes de utiliza√ß√£o dos cart√µes Clara,
          como <b>maiores transa√ß√µes</b>, <b>times com mais pend√™ncias</b>,
          <b>estabelecimentos</b> e <b>categorias</b> com maior volume de gastos?
        </p>
        <div class="mt-3 flex gap-3">
          <button
            id="btnInfoInicialSim"
            class="px-3 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">
            Sim, mostrar
          </button>
          <button
            id="btnInfoInicialNao"
            class="px-3 py-1 text-xs rounded bg-slate-200 text-slate-700 hover:bg-slate-300">
            N√£o, obrigado
          </button>
        </div>
      </div>
    `;

    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    const btnSim = document.getElementById("btnInfoInicialSim");
    const btnNao = document.getElementById("btnInfoInicialNao");

    if (btnSim) {
      btnSim.addEventListener("click", function () {
        vektorCarregarInformacoesIniciais();
      });
    }
    if (btnNao) {
      btnNao.addEventListener("click", function () {
        const bloco = document.getElementById("vektor-info-inicial-pergunta");
        if (bloco) bloco.remove();
      });
    }
  } catch (e) {
    console.warn("Erro ao montar pergunta de informa√ß√µes iniciais:", e);
  }
}

// Extrai "top N" (ex.: "top 5", "top5"). Se n√£o houver "top", retorna null.
function extrairTopN(texto) {
  if (!texto) return null;
  let m = texto.match(/top\s*(\d{1,2})/);
  if (!m) m = texto.match(/top(\d{1,2})/);
  if (m) {
    const n = Number(m[1]);
    if (!isNaN(n)) return Math.min(Math.max(n, 1), 50); // 1..50
  }
  return null;
}

// Decide crit√©rio: "quantidade" se falar de transa√ß√µes; sen√£o "valor".
function extrairCriterioGeral(texto) {
  if (!texto) return "valor";

  const falaDeTransacoes =
    texto.includes("transacoes") || 
    texto.includes("transacao") ||
    texto.includes("numero de transacoes") || 
    texto.includes("quantidade de transacoes") ||
    texto.includes("mais transacoes") || 
    texto.includes("maior numero de transacoes");

  const falaDeValor =
    texto.includes("valor") || 
    texto.includes("gasto") || 
    texto.includes("gastou") ||
    texto.includes("gastaram") || 
    texto.includes("gastos") || 
    texto.includes("compras") ||
    texto.includes("valor de transacoes");

  if (falaDeTransacoes && !falaDeValor) return "quantidade";
  return "valor";
}

function extrairGrupo(msgOriginal, norm) {
  const textoOriginal = msgOriginal || "";
  const lower = (norm || textoOriginal.toLowerCase());

  // procura a palavra "time "
  let idx = lower.indexOf("time ");
  if (idx === -1) {
    // se quiser, pode tentar "time:" tamb√©m
    idx = lower.indexOf("time:");
  }
  if (idx === -1) {
    return "";
  }

  // pega o que vem depois de "time "
  let parte = textoOriginal.substring(idx + 5); // 5 = len("time ")

  // corta quando come√ßar alguma palavra de per√≠odo
  const marcadores = [
    " no ", " neste ", " nesse ", " nesta ", " nessa ",
    " em ", " no per√≠odo", " no periodo",
    " neste mes", " nesse mes", " neste m√™s", " nesse m√™s",
    " na semana", " nesta semana", " nessa semana"
  ];

  let corte = parte.length;
  const parteLower = parte.toLowerCase();

  marcadores.forEach(m => {
    const j = parteLower.indexOf(m);
    if (j !== -1 && j < corte) {
      corte = j;
    }
  });

  parte = parte.substring(0, corte).trim();

  // remove "do", "da", "de" do come√ßo, se tiver
  parte = parte.replace(/^(do|da|de)\s+/i, "").trim();

  return parte;
}

// FILTRAR POR MAIS DE UMA LOJA

function extrairCodigosLojasDaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");

  // localiza a partir da palavra "loja" ou "lojas"
  let idx = texto.indexOf("lojas");
  if (idx < 0) idx = texto.indexOf("loja");
  if (idx < 0) return [];

  const trecho = texto.slice(idx); // parte da frase a partir de "loja(s)"

  // pega n√∫meros com 2 a 4 d√≠gitos (311, 145, 023, 1020 etc.)
  const encontrados = trecho.match(/\b\d{2,4}\b/g);
  if (!encontrados) return [];

  // normaliza tirando zeros √† esquerda
  return encontrados.map(function (c) {
    return c.replace(/^0+/, "") || c;
  });
}

// ========= DETECTOR: CATEGORIAS ========= //
function detectarPerguntaCategorias(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);
  let topN      = extrairTopN(t);
  let tipo      = extrairCriterioGeral(t);  // "valor" ou "quantidade"

  // Se falar "mais uso", for√ßa tratar como quantidade (uso = n√∫mero de vezes)
  if (t.includes("mais uso")) {
    tipo = "quantidade";
  }

  // se ainda n√£o tiver tipo, assume "valor" como padr√£o
  if (!tipo) {
    tipo = "valor";
  }

  const falaCategoria =
    t.includes("categoria") ||
    t.includes("categorias");

  if (!falaCategoria) return null;

  const falaUso =
    t.includes("mais uso") ||
    t.includes("mais gasto") ||
    t.includes("mais gastos") ||
    t.includes("mais valor") ||      // NOVO
    t.includes("mais valores") ||    // NOVO
    t.includes("mais transacoes") ||
    t.includes("mais transacao") ||
    t.includes("maior valor") ||
    t.includes("maior gasto") ||
    t.includes("maior numero de transacoes") ||
    t.includes("maior quantidade de transacoes");

  if (!falaUso) return null;

  // Se n√£o tiver "top" expl√≠cito mas for "qual categoria ...", trata como top 1
  if (!topN && /\bqual\s+categoria\b/.test(t)) {
    topN = 1;
  }

  return {
    periodo,
    tipo,
    topN
  };
}

// ========= DETECTOR: ESTABELECIMENTOS (TRANSACAO) ========= //

function detectarPerguntaEstabelecimentos(msgOriginal, norm) {
  const t = norm || "";
  const tipo    = extrairCriterioGeral(t);
  let   topN    = extrairTopN(t); // let para conseguirmos ajustar para 1

  // Se n√£o tem ‚Äútop‚Äù mas a pessoa perguntou ‚Äúqual local/estabelecimento‚Äù ‚Üí for√ßa topN = 1
if (!topN) {
  const temQualLocal =
    /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
  const temQualEstab =
    /\bqual\s+estabelecimento\b/.test(t) ||
    /\bqual\s+estabelecimentos\b/.test(t);

  if (temQualLocal || temQualEstab) {
    topN = 1;
  }
}

// ‚úÖ DEFAULT: se ainda n√£o definiu topN, usa Top 10
if (!topN) {
  topN = 10;
}

  // Palavras que DEFINEM claramente a inten√ß√£o de estabelecimento
  const falaLocalBase =
    t.includes("estabelecimento") ||
    t.includes("estabelecimentos") ||
    t.includes("local") ||
    t.includes("locais") ||
    t.includes("fornecedor") ||
    t.includes("fornecedores") ||
    t.includes("mercado") ||
    t.includes("mercados") ||
    t.includes("supermercado") ||
    t.includes("supermercados");

  const falaLugarComCompra =
    (t.includes("lugar") || t.includes("lugares")) &&
    (
      t.includes("cartao") ||
      t.includes("cart√£o") ||
      t.includes("clara") ||
      t.includes("comprar") ||
      t.includes("compra") ||
      t.includes("compras") ||
      t.includes("gastar") ||
      t.includes("gasto") ||
      t.includes("gastos")
    );

  const falaLocal = falaLocalBase || falaLugarComCompra;

  // Palavras que INDICAM time campe√£o ‚Äî e por isso devem bloquear
  const falaTimeCampeao =
    t.includes("time que mais gastou") ||
    t.includes("qual time gastou mais") ||
    t.includes("time com maior valor") ||
    t.includes("maior valor total por time") ||
    t.includes("maior gasto por time");

  // Se n√£o for claramente estabelecimento, ou se cair no caso de time ‚Üí ignora
  if (!falaLocal || falaTimeCampeao) return null;

  // Se n√£o tem ‚Äútop‚Äù mas a pessoa perguntou ‚Äúqual local/estabelecimento‚Äù ‚Üí for√ßa topN = 1
  if (!topN) {
    topN = 10;
    const temQualLocal =
      /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
    const temQualEstab =
      /\bqual\s+estabelecimento\b/.test(t) ||
      /\bqual\s+estabelecimentos\b/.test(t);

    if (temQualLocal || temQualEstab) {
      topN = 1;
    }
  }

   // S√≥ tenta achar time se a frase falar explicitamente de time/grupo/equipe
  let grupo = "";
  const falaDeTime =
    t.includes("time ")   ||
    t.includes("times ")  ||
    t.includes("grupo ")  ||
    t.includes("equipe")  ||
    t.includes("equipes");

  if (falaDeTime) {
    grupo = encontrarTimeNaMensagem(msgOriginal) || "";
  }

  const periodo = extrairIntervaloDatas(msgOriginal);
  const criterio = extrairCriterioGeral(t);

  return {
    grupo,
    periodo,
    criterio
  };
}

// ========= DETECTOR: PERGUNTAS DE FATURA (Extrato da conta) =========

function detectarPerguntaFaturaClara(msgOriginal, norm) {
  const t = norm || "";

  // precisa conter "fatura" ou "faturas"
  if (!t.includes("fatura")) return null;

  let modo = "atual";
  let qtd = null;

  // todas as faturas
  if (t.includes("todas") && t.includes("faturas")) {
    modo = "todas";
  }

  // √∫ltimas N faturas
  if (t.includes("ultimas") || t.includes("ultimos") || t.includes("√∫ltimas")) {
    modo = "ultimas";

    // capturar n√∫mero "6", "3", etc.
    let m1 = t.match(/ultimas?\s+(\d+)/);
    let m2 = t.match(/(\d+)\s+ultimas?/);
    let m3 = t.match(/ultimos?\s+(\d+)/);

    const m = m1 || m2 || m3;
    qtd = m ? parseInt(m[1], 10) : 2;
  }

  // fatura anterior
  if (
    t.includes("anterior") ||
    t.includes("mes passado") ||
    t.includes("m√™s passado")
  ) {
    modo = "anterior";
  }

  // refor√ßo: fatura atual
  if (t.includes("atual") || t.includes("deste mes") || t.includes("desse mes")) {
    modo = "atual";
  }

  return {
    tipo: "fatura",
    modo,
    qtd
  };
}

// ========= DETECTOR: "loja e time com maior n√∫mero/valor de transa√ß√µes..." ========= //

function detectarPerguntaLojaMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // fala claramente de loja
  const falaDeLoja =
    texto.includes("qual loja") ||
    texto.includes("loja com")  ||
    texto.includes("loja que mais")  ||
    texto.includes("loja mais");

  // pedindo topo por QUANTIDADE de transa√ß√µes
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // pedindo topo por VALOR de transa√ß√µes
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastou")                 ||
    texto.includes("loja que mais gastou")        ||
    texto.includes("mais gastos")                 ||
    texto.includes("maior gastos")                 ||
    texto.includes("maior gasto")                 ||
    texto.includes("mais comprou");

  // se n√£o for pergunta de loja + (transa√ß√µes ou valor), ignora
  if (!falaDeLoja || (!falaDeTransacoes && !falaDeValor)) {
    return null;
  }

  // intervalo de datas (ontem, esse m√™s, m√™s passado, "de 1 a 30 de outubro", etc.)
  const periodo = extrairIntervaloDatas(msgOriginal);

  // tenta achar um dos TIMES_OFICIAIS no texto
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal); // pode ser null

  // se falou de "valor" (gastou/comprou), √© consulta por valor; sen√£o, por quantidade
  const tipo = falaDeValor ? "valor" : "quantidade";

  return {
    grupo: grupoNomeOficial, // null => todas as lojas, independente de time
    periodo: periodo,
    tipo: tipo
  };

}

// ========= DETECTOR: "ranking geral de times" / "top N times ..." =========

function detectarRankingTimes(msgOriginal, norm) {
  // se for "qual time ..." (singular), deixa o bloco singular tratar
  if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) return null;

  const texto = norm || "";

  // üö´ ESCUDO: se falar de local/estabelecimento, N√ÉO √© pergunta de time
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // se fala explicitamente de loja(s), n√£o √© ranking de times
  if (texto.includes("lojas") || texto.includes("loja")) return null;

  const falaDeTime =
  texto.includes("ranking de times") ||
  texto.includes("ranking geral de times") ||
  // S√≥ trata frases do tipo "top 5 times", n√£o "top 5 transa√ß√µes do time X"
  (texto.includes("top") && texto.includes("times"));

  if (!falaDeTime) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = extrairCriterioGeral(texto);  // "valor" ou "quantidade"
  const topN = extrairTopN(texto);           // n√∫mero de linhas

  return { periodo, tipo, topN };
}

// ========= DETECTOR: "TODOS OS TIMES / RELA√á√ÉO DE TIMES" ========= //

function detectarTodosTimesPeriodo(msgOriginal, norm) {
  const t = norm || "";

  // Frases chave:
  // - "todos os times no per√≠odo ..."
  // - "rela√ß√£o de times no per√≠odo ..."
  const pedeTodosTimes =
    t.includes("todos os times") ||
    t.startsWith("todos os times") ||
    t.startsWith("relacao de times") ||
    t.includes("relacao de times no periodo") ||
    t.includes("rela√ß√£o de times") ||
    t.includes("rela√ß√£o de times no per√≠odo");

  if (!pedeTodosTimes) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  let tipo = extrairCriterioGeral(t); // "valor" ou "quantidade"

  // se n√£o especificar crit√©rio, assume valor
  if (!tipo) {
    tipo = "valor";
  }

  return {
    periodo,
    tipo,
    topN: null // null => queremos TODOS os times
  };
}

// ========= DETECTOR: "ranking/top N de LOJAS" (opcional: do time X) =========

function detectarRankingLojas(msgOriginal, norm) {
  const texto = norm || "";

  // üö´ Se falar de local/estabelecimento, N√ÉO √© ranking de lojas
  if (
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

    // Aceita apenas pedidos CLAROS de ranking de lojas:
  // - "ranking de lojas"
  // - "ranking geral de lojas"
  // - "top 5 lojas", "top 10 lojas", etc.
  const falaRankingLojasDireto =
    texto.includes("ranking de lojas") ||
    texto.includes("ranking geral de lojas");

  const falaTopLojas = /top\s*\d+\s+lojas?/.test(texto); // ex.: "top 5 lojas"

  // Se n√£o falar explicitamente de "ranking de lojas" ou "top X lojas",
  // N√ÉO trata como ranking de lojas.
  if (!falaRankingLojasDireto && !falaTopLojas) return null;


  // Time opcional (usa seu matcher)
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(texto); // "valor" ou "quantidade"
  const topN    = extrairTopN(texto);          // null se n√£o informou

  return { grupo: grupoNomeOficial, periodo, tipo, topN };
}

// ========= DETECTOR: "TODAS AS LOJAS" GERAL (sem time) ========= //

function detectarListarTodasLojasGeral(msgOriginal, norm) {
  const t = norm || "";

  // Aceita pedidos do tipo:
  // - "todas as lojas com gastos no per√≠odo ..."
  // - "todas as lojas com valor no per√≠odo ..."
  // - "rela√ß√£o de lojas no per√≠odo ..."
  const pedeTodas =
    t.includes("listar todas as lojas") ||
    t.startsWith("todas as lojas") ||
    t.includes("todas as lojas com gastos") ||
    t.includes("todas as lojas com gasto") ||
    t.includes("todas as lojas com valor") ||
    t.startsWith("relacao de lojas") ||
    t.includes("relacao de lojas no periodo") ||
    t.includes("rela√ß√£o de lojas") ||
    t.includes("rela√ß√£o de lojas no per√≠odo");

  if (!pedeTodas) return null;

  // crit√©rio: por padr√£o ordena por valor, mas a tabela mostra valor e quantidade
  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = "valor"; // mant√©m padr√£o por valor

  return {
    grupo: "",      // sem time
    periodo,
    tipo,
    topN: null      // null => queremos TODAS as lojas
  };
}

// =========== DETECTOR: "TODAS AS LOJAS DOS TIMES X E Y" =========== //

function detectarTodasLojasDosTimes(msgOriginal, norm) {
  const t = norm || "";

  const falaLojas = t.includes("todas as lojas dos times") ||
                    t.includes("todas as lojas dos time")  ||
                    t.includes("todas as lojas do time")   ||
                    t.includes("lojas do time")   ||
                    t.includes("loja do time")   ||
                    t.includes("todas as lojas do grupo")  ||
                    t.includes("todas as lojas dos grupos");

  if (!falaLojas) return null;

  const listaTimes = encontrarListaTimesNaMensagem(msgOriginal) || [];
  if (!listaTimes.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: listaTimes,
    periodo,
    tipo
  };
}

// =========== DETECTOR: "MAIS DE UMA LOJA NO PER√çODO" =========== //

function detectarLojasEspecificasLista(msgOriginal, norm) {
  const texto = norm || "";

  // ‚ö†Ô∏è Se a frase fala de pend√™ncia, N√ÉO tratar como consulta de transa√ß√µes
  // Isso evita conflitos com o fluxo de pend√™ncias (CLARA_PEND)
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "loja" ou "lojas"
  const mencionaLoja =
    texto.includes("loja ") ||
    texto.includes("lojas ");

  if (!mencionaLoja) return null;

  // extrai c√≥digos num√©ricos de loja
  const codigos = [];
  const regexCodigos = /\b(\d{2,6})\b/g;
  let m;
  while ((m = regexCodigos.exec(msgOriginal)) !== null) {
    const cod = m[1];
    if (!codigos.includes(cod)) {
      codigos.push(cod);
    }
  }

  if (!codigos.length) return null;

  // per√≠odo
  const periodo = extrairIntervaloDatas(msgOriginal);
  // tipo (valor ou quantidade)
  const tipo = extrairCriterioGeral(texto) || "valor";

  return {
    codigosLojas: codigos,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "lojas com maior valor/transa√ß√µes ..." (plural, sem 'top'/'ranking') =========
function detectarLojasMaisTransacoesPlural(msgOriginal, norm) {
  const texto = norm || "";

    // ‚ö†Ô∏è Se falar de pend√™ncia, n√£o √© consulta de ranking/lista de transa√ß√µes
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "lojas " (plural) + crit√©rio
  const mencionaLojasPlural = texto.includes("lojas ");
  if (!mencionaLojasPlural) return null;

  // crit√©rio
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior quantidade de transacoes");

  const falaDeValor =
    texto.includes("maior valor")     ||
    texto.includes("mais gastou")     ||
    texto.includes("mais gasto")      ||
    texto.includes("mais gastos")     ||
    texto.includes("maior gasto")     ||
    texto.includes("maior gastos")     ||
    texto.includes("mais comprou")    ||
    texto.includes("valor de transacoes");

  if (!falaDeTransacoes && !falaDeValor) return null;

  const tipo = falaDeValor ? "valor" : "quantidade";
  const periodo = extrairIntervaloDatas(msgOriginal);
  const grupo = encontrarTimeNaMensagem(msgOriginal) || "";

  // sem 'top' => queremos listar TODAS as lojas do time (se grupo vier),
  // ou o default que voc√™ preferir para "todas as lojas gerais" (vamos deixar limitado se n√£o houver time)
  return { grupo, periodo, tipo, topN: null }; // topN=null => deixe o renderer decidir "listar todas"
}

// =========== DETECTOR: "TODAS AS LOJAS DO TIME XXXXX" =========== //

function detectarListarTodasLojasDoTime(msgOriginal, norm) {
  const t = norm || "";

  // üö´ Se falar em "top", N√ÉO √© "todas as lojas do time",
  // e sim um ranking de lojas. Deixa para detectarRankingLojas tratar.
  if (t.includes("top")) {
    return null;
  }

  // Gatilhos espec√≠ficos para perguntas de "lojas do time"
  const pedeTodas =
    t.includes("todas as lojas do time") ||
    t.includes("todas as loja do time") ||   // tolera sem 's'
    t.includes("lojas do time") ||
    t.includes("loja do time") ||            // tolera sem 's'
    t.includes("lojas da regional") ||
    t.includes("loja da regional") ||
    t.includes("todas as lojas do grupo") ||
    t.includes("todas as loja do grupo") ||  // tolera sem 's'
    t.includes("relacao de lojas do time") ||
    t.includes("rela√ß√£o de lojas do time") ||
    t.includes("relacao de lojas do grupo") ||
    t.includes("rela√ß√£o de lojas do grupo");

  if (!pedeTodas) return null;

  // Usa o parser de times que voc√™ j√° tem
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  if (!grupoNomeOficial) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    grupo: grupoNomeOficial,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "time com maior n√∫mero/valor de transa√ß√µes ..." ========= //
function detectarPerguntaTimeMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // üö´ Se a frase fala de estabelecimento/local, N√ÉO √© pergunta de time campe√£o
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // fala claramente de time (n√£o de loja)
  const falaDeTime =
    texto.includes("qual time") ||
    texto.includes("time com")  ||
    texto.includes("time que mais") ||
    texto.includes("time mais");

  // QUANTIDADE
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // VALOR
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastos")                ||
    texto.includes("mais comprou");

  if (!falaDeTime || (!falaDeTransacoes && !falaDeValor)) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = falaDeValor ? "valor" : "quantidade";

  return { periodo, tipo };
}

// ===== NOVO DETECTOR: Maiores transa√ß√µes individuais (loja / time) =====
function detectarMaioresTransacoesIndividuais(msgOriginal, norm) {
  if (!msgOriginal) return null;
  norm = norm || "";

  // Texto normalizado em min√∫sculas
  var t = norm.toLowerCase();

  // tem palavra "transacao/transa√ß√µes"
  var temTransacao = t.indexOf("transacao") >= 0 || t.indexOf("transacoes") >= 0;
  if (!temTransacao) return null;

  // quer "maiores" OU "top N"
  var temMaior = t.indexOf("maiores transacoes") >= 0 || t.indexOf("maior transacao") >= 0;
  var temTop   = t.indexOf("top") >= 0;
  if (!temMaior && !temTop) return null;

  // Evita pegar perguntas de ranking j√° existentes (ranking de lojas/times)
  if (t.indexOf("ranking de lojas") >= 0 || t.indexOf("ranking de times") >= 0) {
    return null;
  }

  // ------------------------------
  // LOJA: detectada normalmente pelos c√≥digos
  // ------------------------------
  var lojasCodigos = extrairCodigosLojasDaMensagem(msgOriginal) || [];
  var lojaCodigo = lojasCodigos.length ? lojasCodigos[0] : "";

  // ------------------------------
  // TIME: s√≥ detecta se o usu√°rio citar explicitamente "time", "grupo" ou "equipe"
  // ------------------------------
  var mencionaEstruturaTime =
    t.indexOf("time")   >= 0 ||
    t.indexOf("grupo")  >= 0 ||
    t.indexOf("equipe") >= 0;

  var grupoNomeOficial = "";
  if (mencionaEstruturaTime) {
    grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  }

  // per√≠odo (pode ser nulo)
  var periodo = extrairIntervaloDatas(msgOriginal) || null;

  // "top N" se existir
  var topN = extrairTopN(t);

  var grupoFinal = grupoNomeOficial;

  return {
    grupo: grupoFinal,
    loja: lojaCodigo,
    periodo: periodo,
    topN: topN
  };
}

// Lista as etiquetas dispon√≠veis na BaseClara (coluna T) e mostra no chat

function listarEtiquetasClara() {
  // Mensagem inicial do bot
  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>" +
    "Vou buscar a lista de etiquetas e o resumo de uso e j√° te mostro aqui. ‚è≥" +
    "</p>"
  );

  google.script.run
    .withSuccessHandler(function(resumo) {
      if (!resumo || !Array.isArray(resumo.itens) || !resumo.itens.length) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
          "N√£o encontrei dados suficientes para montar o resumo de etiquetas (coluna T e valor). " +
          "Verifique se a BaseClara tem a coluna de <b>Etiquetas</b> e a coluna de <b>Valor</b> preenchidas." +
          "</p>"
        );
        return;
      }

      var itens = resumo.itens;
      var totalGeral = resumo.totalGeral || 0;

      // formata√ß√µes
      function formatBRL(n) {
        if (!n || isNaN(n)) n = 0;
        return n.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
          minimumFractionDigits: 2
        });
      }

      function formatPct(p) {
        if (!p || isNaN(p)) p = 0;
        return p.toLocaleString("pt-BR", {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1
        }) + " %";
      }

      // soma novamente por seguran√ßa (caso venha alguma inconsist√™ncia)
      var somaValores = 0;
      itens.forEach(function (it) {
        var v = (it.valorTotal || 0);
        if (!isNaN(v)) somaValores += v;
      });

 // Monta a tabela HTML
      var html = "<div class='text-sm text-slate-700 mt-2'>" +
                 "<p class='mb-2'>Resumo de uso das etiquetas na Clara:</p>" +
                 "<div class='overflow-x-auto'>" +
                 "<table id='tabela-etiquetas-clara' style='border-collapse:collapse;width:100%; font-size:12px; border:2px solid #000;'>";  // borda externa preta

      // Cabe√ßalho
      html += "<thead>" +
              "<tr>" +
              "<th style='background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;text-align:left;'>Etiqueta</th>" +
              "<th style='background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;text-align:right;'>% de uso (valor)</th>" +
              "<th style='background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;text-align:right;'>Valor total</th>" +
              "</tr>" +
              "</thead>";

      // Corpo
      html += "<tbody>";

      itens.forEach(function (it) {
        var etiqueta = it.etiqueta || "";
        var perc = formatPct(it.percentual || 0);
        var val = formatBRL(it.valorTotal || 0);

        etiqueta = etiqueta
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        html += "<tr>" +
                "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;'>" + etiqueta + "</td>" +
                "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;'>" + perc + "</td>" +
                "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;'>" + val + "</td>" +
                "</tr>";
      });

      html += "</tbody>";

      // Rodap√© (TOTAL)
      html += "<tfoot>" +
              "<tr>" +
              "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;font-weight:bold;'>TOTAL</td>" +
              "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>100,0 %</td>" +
              "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>" + formatBRL(somaValores) + "</td>" +
              "</tr>" +
              "</tfoot>";

      html += "</table>";

      // Bot√£o CSV no final, canto inferior direito
      html += "<div style='text-align:right; margin-top:8px;'>" +
              "<button type='button' " +
                "onclick=\"exportTableToCSV(this, 'etiquetas_clara')\" " +
                "style='background:#005E27;color:#fff;border:none;padding:6px 12px;" +
                       "border-radius:4px;font-size:11px;cursor:pointer;'>" +
                "‚¨á Exportar CSV" +
              "</button>" +
              "</div>";

      html += "</div></div>";

      renderBotMessage("HTML:" + html);
    })
    .getResumoEtiquetasClara(); // <-- nova fun√ß√£o no Code.gs
}

    /* ========= ENVIO (ENTER / BOT√ÉO) ========= */

    function enviarMensagem() {

    // üÜï cancela timeout de pend√™ncias ao responder
    if (typeof pendenciasTimeoutId !== "undefined" && pendenciasTimeoutId) {
        clearTimeout(pendenciasTimeoutId);
        pendenciasTimeoutId = null;
    }

    const texto = userInput.value.trim();
    if (!texto) return;

    // Mostra a mensagem do usu√°rio no chat
    renderUserMessage(texto);
    userInput.value = "";  // limpa aqui, sempre

    // üåü FLUXO ESPECIAL: estamos aguardando o NOME para o Termo de Responsabilidade
    if (window.vektorTermoAguardandoNome && window.vektorTermoPending) {

        const nomeCompleto = texto;

        const payload = Object.assign({}, window.vektorTermoPending, {
            usuarioNome: nomeCompleto
        });

        // Limpa o estado ANTES da chamada para evitar duplicidade
        window.vektorTermoAguardandoNome = false;
        window.vektorTermoPending = null;

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Registrando o seu Termo de Responsabilidade. Aguarde...</p>"
        );

        google.script.run
  .withSuccessHandler(function (res) {
    if (res && res.ok) {
      // Mensagem principal + link do Drive na mesma frase
      renderBotMessage(
        "HTML:" +
        "<p class='text-sm text-slate-700'>" +
          "Termo de Responsabilidade salvo com sucesso para <b>" + nomeCompleto + "</b>. " +
          (res.fileUrl
            ? "Link interno (Drive): <a href='" + res.fileUrl +
              "' target='_blank' class='text-slate-700 underline'>Abrir Termo</a>."
            : ""
          ) +
        "</p>"
      );

      // Mensagem complementar em outra bolha
      setTimeout(function () {
        renderBotMessage(
          "HTML:" +
          "<p class='text-sm text-slate-700'>" +
            "Caso o cart√£o ainda esteja impossibilitado de uso devido ao n√£o envio do Termo assinado, " +
            "em breve ele estar√° ativo. Fique de olho no aplicativo da Clara." +
          "</p>"
        );
      }, 3000);

    } else {
      // Caso o backend tenha retornado ok: false
      renderBotMessage(
        "HTML:" +
        "<p class='text-sm text-red-700'>N√£o consegui salvar o termo. Motivo: " +
        (res && res.error ? res.error : "erro desconhecido") +
        "</p>"
      );
    }
  })
  .withFailureHandler(function (err) {
    // Erro de comunica√ß√£o Apps Script
    renderBotMessage(
      "HTML:" +
      "<p class='text-sm text-red-700'>Falha na comunica√ß√£o ao salvar o termo: " +
      (err && err.message ? err.message : err) +
      "</p>"
    );
  })
  .salvarTermoResponsabilidade(payload);


        // IMPORTANTE: n√£o segue para o fluxo normal de pergunta/resposta
        return;
    }

    // ===== FLUXO NORMAL DO VEKTOR (mantido como j√° estava) =====

    // Normaliza o texto para busca de inten√ß√£o
    const norm = normalize(texto || "");
    const resposta = gerarRespostaDoBot(texto);

    // Se a inten√ß√£o for listar etiquetas, chama a fun√ß√£o espec√≠fica e para aqui
    if (resposta === "ACAO_LISTAR_ETIQUETAS_CLARA") {
        listarEtiquetasClara();
        return;
    }

    if (resposta) renderBotMessage(resposta);

    // Depois de responder normalmente, avalia se faz sentido sugerir algo do Manual da Clara
    try {
        vektorSugerirManualAPartirDaPergunta(texto);
    } catch (e) {
        console.warn("Erro ao tentar sugerir Manual da Clara:", e);
    }

    // E tamb√©m sugest√µes gerais (pol√≠tica, relat√≥rios, pend√™ncias, etc.)
    try {
        vektorSugerirTopicosGerais(texto);
    } catch (e) {
        console.warn("Erro ao tentar sugerir t√≥picos gerais:", e);
    }

    userInput.focus();
}

        // ====== RESPOSTA DOS BOT√ïES "SIM" / "N√ÉO" PARA PEND√äNCIAS ======
        window.vektorResponderConfirmacaoPendencias = function (resposta) {
  try {
    // se n√£o estiver aguardando confirma√ß√£o, ignora
    if (typeof estadoPendencias === "undefined" ||
        estadoPendencias !== "aguardando_confirmacao_email") {
      return;
    }

    // Garante que temos os elementos necess√°rios
    if (!window.userInput || typeof enviarMensagem !== "function") {
      console.warn("userInput ou enviarMensagem n√£o dispon√≠veis.");
      return;
    }

    // Preenche a caixa de texto com 'sim' ou 'n√£o' e reaproveita todo o fluxo j√° existente
    userInput.value = resposta;
    enviarMensagem();
  } catch (e) {
    console.error("Erro em vektorResponderConfirmacaoPendencias:", e);
  }
};

// ====== INFO INICIAL POR PERFIL (apenas Administrador) ======
let vektorJaPerguntouInfoIniciais = false;

window.vektorPerguntarInformacoesIniciais = function () {
  try {
    // S√≥ pergunta para Administrador
    if (USER_ROLE_CLEAN !== "Administrador") return;

    // Evita perguntar repetidamente
    if (vektorJaPerguntouInfoIniciais) return;
    vektorJaPerguntouInfoIniciais = true;

    const html =
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>" +
          "Se voc√™ quer ver um resumo das principais informa√ß√µes de utiliza√ß√£o do cart√£o Clara " +
          "(maiores transa√ß√µes, times com mais pend√™ncias, estabelecimentos mais usados, categorias de gasto e √∫ltimas faturas), clique no bot√£o abaixo" +
        "</p>" +
        "<div class='mt-2 flex gap-2'>" +
          "<button type='button' " +
                  "class='px-3 py-1 rounded bg-emerald-600 text-white text-xs' " +
                  "onclick=\"window.vektorRespostaInfoIniciais('sim')\">" +
            "Mostrar resumo" +

          "</button>" +
        "</div>" +
      "</div>";

    renderBotMessage(html);
  } catch (e) {
    console.error("Erro ao perguntar info iniciais:", e);
  }
};

window.vektorRespostaInfoIniciais = function (resposta) {
  try {
    if (resposta === "nao") {
      renderBotMessage(
        "HTML:" +
        "<p class='text-sm text-slate-700'>" +
          "Perfeito, seguimos normalmente. Se depois quiser ver esses resumos gerenciais, √© s√≥ pedir no chat. üëç" +
        "</p>"
      );
      return;
    }

    // Caso SIM
    renderBotMessage(
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>Beleza! Vou te mostrar algumas vis√µes gerenciais separadas, conforme abaixo, e tamb√©m alguns insights sobre essas vis√µes:</p>" +
        "<ul class='list-disc ml-4 mt-1 space-y-1'>" +
          "<li><b>Maiores transa√ß√µes individuais</b> dos √∫ltimos 30 dias (Top 10);</li>" +
          "<li><b>Times com mais pend√™ncias</b> nos √∫ltimos 30 dias;</li>" +
          "<li><b>Estabelecimentos mais usados</b> (Top 10);</li>" +
          "<li><b>Categorias com maior valor de transa√ß√µes</b> nos √∫ltimos 30 dias;</li>" +
          "<li><b>Valor das √∫ltimas faturas</b> Clara (Somente para perfil de admnistrador).</li>" +
        "</ul>" +
        "<p class='mt-2'>Irei enviar cada tabela em sequ√™ncia.</p>" +
      "</div>"
    );

    // Aguarda 1,5s e dispara o carregamento das tabelas
    setTimeout(function () {
      vektorCarregarInformacoesIniciais();
    }, 2500);
  } catch (e) {
    console.error("Erro ao tratar resposta info iniciais:", e);
  }
};

function vektorCarregarInformacoesIniciais() {
  try {
    if (USER_ROLE_CLEAN !== "Administrador") return;

    const hoje = new Date();
    const fim = hoje;
    const ini = new Date();
    ini.setDate(hoje.getDate() - 30);

    const dataInicioIso = ini.toISOString();
    const dataFimIso    = fim.toISOString();

    // 1) Maiores transa√ß√µes individuais
    try {
      google.script.run
        .withSuccessHandler(function (res) {
          try { renderMaioresTransacoesIndividuais(res); }
          catch (e) { console.error("Erro ao renderizar Maiores Transa√ß√µes (inicial):", e); }
        })
        .withFailureHandler(err => console.error("Erro Apps Script Maiores Transa√ß√µes (inicial):", err))
        .getMaioresTransacoesIndividuais("", "", dataInicioIso, dataFimIso, 10);
    } catch (e) {
      console.error("Falha geral ao chamar Maiores Transa√ß√µes (inicial):", e);
    }

    // 2) Pend√™ncias por time (√∫ltimos 30 dias)
          setTimeout(function () {
            try {
              google.script.run
                .withSuccessHandler(function (res) {
                  try {
                    const htmlTabela = vektorRenderTabelaPendenciasPorTime(res, dataInicioIso, dataFimIso);
                    renderBotMessage("HTML:" + htmlTabela);
                  } catch (e) {
                    console.error("Erro ao renderizar Pend√™ncias por time (inicial):", e);
                  }
                })
                .withFailureHandler(function (err) {
                  console.error("Erro Apps Script Pend√™ncias por time (inicial):", err);
                })
                .getResumoPendenciasPorTime(dataInicioIso, dataFimIso, "");
            } catch (e) {
              console.error("Falha geral ao chamar Pend√™ncias por time (inicial):", e);
            }
          }, 3000);

    // 3) Estabelecimentos mais usados (Top 10)
    setTimeout(function () {
      try {
        const tipo = "valor";

        google.script.run
          .withSuccessHandler(function (res) {
            try {
              renderResumoPorChaveGenerico(res, {
                tipoChave: "Estabelecimento",
                titulo: "<b>Locais com maior valor de gastos</b> - Top 10",
                topN: 10
              });
            } catch (e) {
              console.error("Erro ao renderizar Estabelecimentos (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Estabelecimentos (inicial):", err))
          .getResumoTransacoesPorEstabelecimento(
            dataInicioIso,   // <‚Äì CORRIGIDO
            dataFimIso,      // <‚Äì CORRIGIDO
            tipo,            // "valor"
            "",              // grupo
            ""               // loja
          );
      } catch (e) {
        console.error("Falha geral ao chamar Estabelecimentos (inicial):", e);
      }
    }, 6000);

    // 4) Categorias (j√° estava ok)
    setTimeout(function () {
      try {
        const tipo = "valor";

        google.script.run
          .withSuccessHandler(function (res) {
            try {
              renderResumoPorChaveGenerico(res, {
                tipoChave: "Categoria",
                titulo: "Categorias com maior valor de transa√ß√µes"
              });
            } catch (e) {
              console.error("Erro ao renderizar Categorias (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Categorias (inicial):", err))
          .getResumoTransacoesPorCategoria(dataInicioIso, dataFimIso, tipo);
      } catch (e) {
        console.error("Falha geral ao chamar Categorias (inicial):", e);
      }
    }, 9000);

    // 5) √öltimas 6 faturas (j√° estava ok)
    setTimeout(function () {
      try {
        google.script.run
          .withSuccessHandler(function (res) {
            try {
              const todas = (res && res.faturas) || [];
              if (!todas.length) return;

              const selecionadas = vektorFiltrarFaturasPeloModo_(todas, "ultimas", 6);
              if (!selecionadas.length) return;

              const titulo = "VALOR DAS √öLTIMAS " + selecionadas.length + " FATURAS";
              const htmlTabela = vektorMontarTabelaFaturas_(titulo, selecionadas);

              renderBotMessage("HTML:" + htmlTabela);

              const htmlInsights = analisarFaturas(selecionadas);
              if (htmlInsights) renderBotMessage("HTML:" + htmlInsights);

            } catch (e) {
              console.error("Erro ao renderizar Faturas (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Faturas (inicial):", err))
          .getResumoFaturasClara();
      } catch (e) {
        console.error("Falha geral ao chamar Faturas (inicial):", e);
      }
    }, 12000);

  } catch (e) {
    console.error("Erro geral em vektorCarregarInformacoesIniciais:", e);
  }
}

userInput.addEventListener("keydown", (e) => {
    const boxVisivel   = vektorBox && vektorBox.style.display === "block";
    const haSugestoes  = vektorCurrentSuggestions && vektorCurrentSuggestions.length > 0;

    // ESC fecha o autocomplete
    if (e.key === "Escape") {
        if (boxVisivel) {
            e.preventDefault();
            vektorBox.style.display = "none";
            vektorSelectedIndex = -1;
            vektorCurrentSuggestions = [];
        }
        return;
    }

    // Se o autocomplete estiver aberto e tiver sugest√µes
    if (boxVisivel && haSugestoes) {

        // TAB ou seta para baixo -> pr√≥xima sugest√£o
        if (e.key === "ArrowDown" || (e.key === "Tab" && !e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex + 1) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // Shift+TAB ou seta para cima -> sugest√£o anterior
        if (e.key === "ArrowUp" || (e.key === "Tab" && e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex - 1 + vektorCurrentSuggestions.length) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // ENTER com item selecionado -> aplica sugest√£o
        if (e.key === "Enter") {
            if (vektorSelectedIndex >= 0 && vektorCurrentSuggestions[vektorSelectedIndex]) {
                e.preventDefault();

                const textoSugestao = vektorCurrentSuggestions[vektorSelectedIndex];
                vektorApplySuggestion(textoSugestao);

                vektorBox.style.display = "none";
                vektorSelectedIndex = -1;
                vektorCurrentSuggestions = [];
                return; // usu√°rio aperta Enter de novo se quiser enviar
            }
            // se n√£o tiver item selecionado, cai no fluxo padr√£o mais abaixo
        }
    }

    // Fluxo padr√£o: Enter envia a mensagem (sem Shift)
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
    }
});

    sendBtn.addEventListener("click", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    // üü¢ Mostrar o v√≠deo do Vektor s√≥ na primeira visita
    (function () {
      var modal = document.getElementById("vektorModal");
      if (!modal) return;

      // Verifica se j√° mostramos o v√≠deo neste navegador
      var jaMostrou = localStorage.getItem("vektorIntroShown");

      if (!jaMostrou) {
        // Nunca mostrou ‚Üí exibe o modal e marca como exibido
        modal.style.display = "flex";   // combina com as classes flex do Tailwind
        localStorage.setItem("vektorIntroShown", "1");
      } else {
        // J√° mostrou uma vez ‚Üí garante que fique escondido
        modal.style.display = "none";
      }
    })();

      // ===== MODAL DO MANUAL CLARA =====
  window.openManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.remove("hidden");
      // para garantir que fique centralizado como flex
      el.classList.add("flex");
    }
  };

  window.closeManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.add("hidden");
      el.classList.remove("flex");
    }
  };

}); // fim DOMContentLoaded

</script>
</body>
</html>
