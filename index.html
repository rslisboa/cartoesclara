<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Agente Clara | Grupo SBF</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:800px;
        margin:2rem auto;
        display:flex;
        flex-direction:column;
        height:90vh;
    }
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
    }
    .chat-header-inner {
        display:flex;
        flex-direction:row;
        align-items:flex-start;
        justify-content:space-between;
        flex-wrap:wrap;
        row-gap:1rem;
    }

    .chat-header-area {
    background-color: #FFFFFF; /* fundo branco */
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
    border-bottom: 1px solid rgba(0,0,0,.08);
    padding: 1rem 1.25rem;
}

.chat-header-inner {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    position: relative;
}

.chat-header-left {
    width: 100%;
    text-align: center;
    color: #005E27; /* texto verde escuro */
}

.chat-header-left h1 {
    font-size: 1.5rem;
    font-weight: 800;
    color: #005E27; /* texto verde escuro */
    margin-bottom: 0.5rem;
}

.chat-header-left p,
.chat-header-left .examples,
.chat-header-left .policy-note {
    color: #1e293b;
    text-align: center;
    margin-top: 0.5rem;
}

.chat-header-avatar {
    position: absolute;
    top: 0.5rem;
    right: 1rem;
}

.chat-header-avatar img {
    height: 72px;
    width: auto;
    object-fit: contain;
    filter: none; /* remove sombra */
}

    .chat-body {
        flex:1 1 auto;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
    }
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .chat-window {
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
    }

    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;     /* caixa de digita√ß√£o pequena */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbars mais discretos */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links dentro da resposta HTML do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }
</style>
</head>
<body class="text-slate-800">

<div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Agente Clara | Grupo SBF</h1>
                <p>Pergunte sobre o uso do cart√£o Clara nas lojas.</p>
                <div class="examples">
                </p>
            </div>
            <div class="chat-header-avatar">
                <img src="Gemini_Generated_Image_nzni5znzni5znzni.png" alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

            <!-- Mensagem inicial do bot -->
            <div class="flex items-start gap-3">
                <img
                    src="Gemini_Generated_Image_nzni5znzni5znzni.png"
                    alt="Assistente Clara (rob√¥)"
                    class="h-14 w-auto object-contain flex-shrink-0"
                />
                <div class="bot-bubble px-4 py-3 max-w-[80%] text-sm text-slate-700">
                    <p class="font-semibold text-slate-800 text-base">
                        Ol√°! üëã Eu sou o agente do <b>Grupo SBF</b>.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar direto, tipo:<br/>
                        ‚Ä¢ "Posso comprar mouse?"<br/>
                        ‚Ä¢ "Como aumento o limite?"<br/>
                        ‚Ä¢ "Vou trocar de loja, o que fa√ßo com o cart√£o?"<br/>
                        ‚Ä¢ "Qual etiqueta pra √°gua/mineral?"<br/>
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Se o assunto n√£o tiver rela√ß√£o com a Pol√≠tica de Uso dos Cart√µes da Clara nas lojas eu n√£o estarei apto para responder.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Quer o documento oficial completo?
                        <a class="policy-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
                            Segue a Pol√≠tica de Uso dos Cart√µes Clara
                        </a>.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER / INPUT -->
    <footer class="chat-footer">
        <form id="chatForm" class="w-full">
            <div class="input-shell">
                <textarea id="userInput" placeholder="Digite sua d√∫vida sobre o cart√£o Clara..."></textarea>
                <button type="submit" id="sendBtn">Enviar</button>
            </div>
        </form>
    </footer>

</div>

<script>
// =====================================================
// POL√çTICA (resumo orientador)
// =====================================================
const POLITICA_COMPLETA = `
1. O cart√£o Clara √© o meio oficial para despesas operacionais das lojas.
2. Toda compra tem que ser justificada na plataforma Clara em at√© 48h:
   - etiqueta correta,
   - nota fiscal/recibo anexado,
   - descri√ß√£o objetiva.
3. Despesa pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal, cinema, bebida alco√≥lica etc.) √© proibida.
   - Se acontecer, avisar Financeiro, classificar como "Despesa Pessoal ‚Äì Uso Indevido" e ressarcir em at√© 2 dias √∫teis.
4. Itens patrimoniais/infraestrutura (geladeira, micro-ondas, cafeteira el√©trica, TV, home theater, mesa, cadeira etc.) n√£o entram no cart√£o Clara. Isso segue fluxo de Compras / patrim√¥nio.
5. Lanches/√°gua podem ser pagos pelo cart√£o SOMENTE se forem ligados a opera√ß√£o autorizada:
   - treinamento oficial,
   - a√ß√£o aprovada (VM, regional, diretoria),
   - premia√ß√£o operacional autorizada.
   Usa etiqueta correta e descreve o motivo.
6. Se o gerente saiu e ainda n√£o existe novo gerente, o Financeiro pode autorizar uso tempor√°rio do cart√£o de outra loja.
   - Cada transa√ß√£o precisa ter descri√ß√£o tipo: "Uso tempor√°rio do cart√£o na loja 1234".
7. Aumento de limite: abrir chamado no ServiceNow explicando necessidade operacional e urg√™ncia.
8. Se bloqueou por falta de justificativa, precisa regularizar (nota, etiqueta, descri√ß√£o) para avaliar desbloqueio.
9. Contesta√ß√£o de compra n√£o reconhecida deve ser aberta em at√© 2 dias √∫teis via suporte da Clara, com envolvimento do Financeiro.
10. Sangria de caixa deixa de existir depois que a loja recebe o cart√£o Clara, s√≥ pode ser liberada como exce√ß√£o com autoriza√ß√£o financeira pr√©via.
`;

// =====================================================
// Etiquetas oficiais padronizadas
// Cada item agora tem sempre as mesmas chaves:
// nome, palavrasChave, descricao, observacaoUso
// =====================================================
const etiquetasOficiais = [
    {
        nome: "AGUA POT√ÅVEL",
        palavrasChave: [
            "agua","√°gua","gal√£o","galao","garrafa de agua","garrafa de √°gua",
            "galao de agua","garrafa de √°gua","garrafa de agua"
        ],
        descricao: "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe/loja, quando previsto operacionalmente.",
        observacaoUso: ""
    },
    {
        nome: "LANCHES DE REFEI√á√ïES",
        palavrasChave: [
            "lanche","lanche equipe","lanche da equipe","coffee break","cafe","caf√©",
            "pao","p√£o","bolo","salgado","biscoito","biscoitos","refrigerante",
            "refris","suco","suco natural","suquinho","lanchinho","kit lanche",
            "croissant","torta","doces treinamento","premia√ß√£o","premiacao"
        ],
        descricao: "Lanche / coffee break ligado a treinamento interno oficial, a√ß√£o aprovada (VM, regional, diretoria) ou premia√ß√£o operacional autorizada.",
        observacaoUso: "N√£o cobre almo√ßo pessoal ou lazer particular."
    },
    {
        nome: "MATERIAL DE INFORM√ÅTICA",
        palavrasChave: [
            "mouse","teclado","teclado pdv","cabo usb","cabos","pendrive","pen drive",
            "roteador","hub usb","fonte notebook","fonte","adaptador","cabo rede"
        ],
        descricao: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hub USB, cart√µes de mem√≥ria de baixo valor.",
        observacaoUso: "Serve para manter PDV/opera√ß√£o rodando. N√£o cobre TV, monitor grande, console etc."
    },
    {
        nome: "MATERIAL DE ESCRIT√ìRIO",
        palavrasChave: [
            "caneta","canetas","pasta","pastas","papel","bloco","blocos","caderno",
            "cadernos","etiqueta adesiva","grampeador","organizador de mesa","clips","clipes"
        ],
        descricao: "Canetas, clips, pastas, blocos de anota√ß√£o, grampeadores, etiquetas, organizadores de mesa.",
        observacaoUso: ""
    },
    {
        nome: "MATERIAL DE LIMPEZA",
        palavrasChave: [
            "detergente","desinfetante","sabonete","pano de ch√£o","pano de chao","pano",
            "alcool","√°lcool","papel toalha","vassoura","rodo","limpeza loja"
        ],
        descricao: "Detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc. para uso da loja.",
        observacaoUso: "Materiais para manuten√ß√£o da limpeza da loja."
    },
    {
        nome: "MATERIAL DE COPA E COZINHA",
        palavrasChave: [
            "copo descartavel","copo","talher","talheres","garrafa t√©rmica","garrafa termica",
            "pano de prato","pano prato","filtro de cafe","filtro de caf√©","pote plastico",
            "pote pl√°stico","potes"
        ],
        descricao: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, potes pl√°sticos.",
        observacaoUso: "N√ÉO inclui eletrodom√©stico (cafeteira el√©trica, micro-ondas, etc.)."
    },
    {
        nome: "MANUTEN√á√ÉO EL√âTRICO",
        palavrasChave: [
            "tomada","tomadas","disjuntor","disjuntores","interruptor","interruptores",
            "reator","soquete","soquetes","extensao","extens√£o","fia√ß√£o","fiacao",
            "eletrico","el√©trico"
        ],
        descricao: "Troca de tomadas, disjuntores, interruptores, pequenos reparos de fia√ß√£o de baixa tens√£o.",
        observacaoUso: "Servi√ßos simples e pontuais, baixo valor, para manter a loja operando."
    },
    {
        nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
        palavrasChave: [
            "ar condicionado","ar-condicionado","arcondicionado","limpeza filtro ar",
            "carga de gas ar","controle remoto ar","manutencao ar","manuten√ß√£o ar",
            "controle ar"
        ],
        descricao: "Limpeza de filtro, carga de g√°s, troca de controle remoto ou ajuste simples de ar-condicionado.",
        observacaoUso: "Compra de um ar-condicionado novo n√£o entra."
    },
    {
        nome: "MANUTEN√á√ÉO CIVIL",
        palavrasChave: [
            "parafusar prateleira","arrumar porta","trocar fechadura loja","reparo parede",
            "trocar vidro","ajuste prateleira fixa","conserto parede","manuten√ß√£o civil",
            "manutencao civil"
        ],
        descricao: "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa), exceto chaveiro emergencial.",
        observacaoUso: ""
    },
    {
        nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
        palavrasChave: [
            "conserto impressora etiqueta","manutencao impressora","ajuste maquina estampar",
            "maquina estampar","reparo computador loja","ferramenta manual",
            "manuten√ß√£o equipamentos","manutencao equipamentos"
        ],
        descricao: "Reparo de impressora de etiqueta, m√°quina de estampar, computador fora de garantia, ferramenta manual pequena.",
        observacaoUso: "Equipamento grande/patrimonial n√£o."
    },
    {
        nome: "CHAVEIRO EMERGENCIAL",
        palavrasChave: [
            "chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar segredo",
            "perdi a chave","sem chave cofre"
        ],
        descricao: "Servi√ßo emergencial de chaveiro para abrir cofre, estoque, vitrine.",
        observacaoUso: "Somente emerg√™ncia operacional real."
    },
    {
        nome: "TRANSPORTE SERVI√áOS EMERGENCIAS",
        palavrasChave: [
            "motoboy","moto boy","moto-boy","frete urgente","entrega urgente",
            "pegar documento na matriz","levar documento","sedex urgente","courier",
            "lalamove","lala move","frete local","frete local emergencial"
        ],
        descricao: "Frete local emergencial / motoboy para levar/pegar item ou documento cr√≠tico entre loja e matriz.",
        observacaoUso: "Uber / 99 pessoal n√£o entra aqui. Uber pessoal n√£o pode no cart√£o Clara."
    },
    {
        nome: "CORREIOS_SEDEX/AR/POSTAGEM",
        palavrasChave: [
            "sedex","correios","ar","postagem","envio documento",
            "carta registrada","devolucao correios","devolu√ß√£o correios"
        ],
        descricao: "Envio de documentos f√≠sicos via Sedex/AR/postagem oficial; devolu√ß√µes pequenas.",
        observacaoUso: ""
    },
    {
        nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
        palavrasChave: [
            "banner","adesivo promocional","adesivo","flyer","folder",
            "encadernacao","encaderna√ß√£o","material visual loja",
            "impressao grafica","impress√£o gr√°fica"
        ],
        descricao: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√µes, material visual da loja.",
        observacaoUso: ""
    },
    {
        nome: "BOBINA ECF",
        palavrasChave: [
            "bobina","bobina ecf","bobina fiscal","bobina impressora fiscal",
            "ecf","cupom fiscal","bobina pdv","bobina caixa"
        ],
        descricao: "Bobina para ECF / impressora fiscal / PDV onde n√£o h√° fornecimento centralizado.",
        observacaoUso: ""
    }
];

// =====================================================
// Normaliza√ß√£o
// =====================================================
function normalize(str) {
    return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

// =====================================================
// Inten√ß√£o
// =====================================================
function detectarIntencaoPergunta(msgNorm) {

    // fora de escopo
    const foraEscopoPadroes = [
        "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
        "presidente","futebol","time joga","campeonato","xing","vai tomar",
        "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
        "piada","xingar","palavr√£o","palavrao"
    ];
    for (const termo of foraEscopoPadroes) {
        if (msgNorm.includes(normalize(termo))) {
            return "foraEscopo";
        }
    }

    // etiqueta direta
    if (msgNorm.includes("etiqueta") || msgNorm.includes("qual etiqueta") || msgNorm.includes("que etiqueta")) {
        return "etiqueta";
    }

    // limite
    if (
        msgNorm.includes("aumentar limite") ||
        msgNorm.includes("aumento de limite") ||
        msgNorm.includes("limite maior") ||
        msgNorm.includes("limite do cartao") ||
        msgNorm.includes("limite do cart√£o") ||
        msgNorm.includes("limite nao basta") ||
        msgNorm.includes("limite n√£o basta") ||
        msgNorm.includes("limite acabou") ||
        msgNorm.includes("limite estourou")
    ) {
        return "limite";
    }

    // bloqueio
    if (
        msgNorm.includes("bloqueou") ||
        msgNorm.includes("bloqueado") ||
        msgNorm.includes("desbloquear") ||
        msgNorm.includes("cartao travou") ||
        msgNorm.includes("cart√£o travou") ||
        msgNorm.includes("travou o cartao") ||
        msgNorm.includes("travou o cart√£o") ||
        msgNorm.includes("bloqueio preventivo")
    ) {
        return "bloqueio";
    }

    // presta√ß√£o de contas
    if (
        msgNorm.includes("como justificar") ||
        msgNorm.includes("justificar compra") ||
        msgNorm.includes("prestar contas") ||
        msgNorm.includes("prestacao de contas") ||
        msgNorm.includes("presta√ß√£o de contas") ||
        msgNorm.includes("colocar nota") ||
        msgNorm.includes("anexar nota") ||
        msgNorm.includes("descricao na clara") ||
        msgNorm.includes("descri√ß√£o na clara")
    ) {
        return "prestacao";
    }

    // lanche / √°gua / equipe
    if (
        msgNorm.includes("lanche") ||
        msgNorm.includes("lanche pro time") ||
        msgNorm.includes("lanche para o time") ||
        msgNorm.includes("cafe pro time") ||
        msgNorm.includes("caf√© pro time") ||
        msgNorm.includes("coffee break") ||
        msgNorm.includes("agua") ||
        msgNorm.includes("√°gua") ||
        msgNorm.includes("gal√£o") ||
        msgNorm.includes("galao") ||
        msgNorm.includes("premiacao") ||
        msgNorm.includes("premia√ß√£o")
    ) {
        return "alimentoTime";
    }

    // uber / transporte pessoal
    if (
        msgNorm.includes("uber") ||
        msgNorm.includes("99") ||
        msgNorm.includes("taxi") ||
        msgNorm.includes("t√°xi") ||
        msgNorm.includes("app de transporte")
    ) {
        return "transportePessoal";
    }

    // troca de gerente / transfer√™ncia de loja
    if (
        msgNorm.includes("mudar de loja") ||
        msgNorm.includes("trocar de loja") ||
        msgNorm.includes("vou mudar de loja") ||
        msgNorm.includes("fui transferido") ||
        msgNorm.includes("transferido de loja") ||
        msgNorm.includes("gerente desligado") ||
        msgNorm.includes("sem gerente") ||
        msgNorm.includes("gerente saiu") ||
        msgNorm.includes("gerente saiu da loja") ||
        msgNorm.includes("cartao de outra loja") ||
        msgNorm.includes("cart√£o de outra loja") ||
        msgNorm.includes("usar cartao de outra loja") ||
        msgNorm.includes("usar cart√£o de outra loja")
    ) {
        return "trocaGerente";
    }

    // sangria
    if (
        msgNorm.includes("sangria") ||
        msgNorm.includes("fazer sangria") ||
        msgNorm.includes("puxar dinheiro do caixa") ||
        msgNorm.includes("retirar dinheiro do caixa")
    ) {
        return "sangria";
    }

    // fraude / contesta√ß√£o
    if (
        msgNorm.includes("nao reconheco") ||
        msgNorm.includes("n√£o reconhe√ßo") ||
        msgNorm.includes("fraude") ||
        msgNorm.includes("compra indevida") ||
        msgNorm.includes("compra indevida no cartao") ||
        msgNorm.includes("compra indevida no cart√£o") ||
        msgNorm.includes("contestar compra") ||
        msgNorm.includes("contestacao") ||
        msgNorm.includes("contesta√ß√£o")
    ) {
        return "fraudeContestacao";
    }

    // posso comprar...? posso usar...?
    if (
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("posso usar") ||
        msgNorm.includes("pode usar") ||
        msgNorm.includes("pode pagar") ||
        msgNorm.includes("pode gastar") ||
        msgNorm.includes("pode comprar") ||
        msgNorm.includes("pode no cartao") ||
        msgNorm.includes("pode no cart√£o") ||
        msgNorm.includes("pode colocar no cartao") ||
        msgNorm.includes("pode colocar no cart√£o")
    ) {
        return "podeNaoPode";
    }

    return "generica";
}

// =====================================================
// Achar etiqueta mais aderente
// (ajustada: procura termo inteiro dentro da mensagem normalizada)
// =====================================================
function acharEtiquetaPorMensagem(msgNorm) {
    const palavras = msgNorm.split(/\s+/);
    for (const et of etiquetasOficiais) {
        for (const termo of et.palavrasChave) {
            const termoNorm = normalize(termo);
            if (palavras.includes(termoNorm)) {
                return et;
            }
            // tamb√©m tenta includes simples pra termos compostos tipo "coffee break"
            if (msgNorm.includes(termoNorm)) {
                return et;
            }
        }
    }
    return null;
}

// =====================================================
// Avaliar compra espec√≠fica
// =====================================================

function avaliarCompraEspecifica(msgNorm) {

    // 1. Itens claramente proibidos / patrimoniais / infraestrutura / coisa absurda tipo carro
    const itensPatrimoniaisGrandes = [
        "geladeira","frigobar","microondas","micro-ondas","micro ondas",
        "cafeteira","cafeteira eletrica","cafeteira el√©trica","bebedouro",
        "ar condicionado novo","ar-condicionado novo","arcondicionado novo",
        "tv","televisao","televis√£o","monitor","home theater","home-theater",
        "soundbar","som","caixa de som","caixa de som bluetooth",
        "fogao","fog√£o","forno","forno eletrico","forno el√©trico",
        "console ps5","ps5","playstation","xbox","videogame","video game",
        "mesa","mesa escritorio","mesa de escritorio","mesa grande",
        "cadeira","cadeira escritorio","cadeira de escritorio",
        "estacao de trabalho","esta√ß√£o de trabalho",
        "movel","m√≥vel","mobilia","mob√≠lia","mobiliario","mobili√°rio","armario","arm√°rio",
        "balcao","balc√£o","balcao de atendimento","balc√£o de atendimento",
        "carro","veiculo","ve√≠culo","moto","motocicleta","foguete","rocket","carro da loja"
    ];
    for (const proib of itensPatrimoniaisGrandes) {
        if (msgNorm.includes(normalize(proib))) {
            return {
                pode: false,
                tipo: "PATRIMONIAL",
                resposta:
`‚ùå N√£o pode usar o cart√£o Clara pra isso.

Itens patrimoniais / infraestrutura (ex.: geladeira, micro-ondas, TV, home theater, mesa, cadeira, ve√≠culo etc.) n√£o entram como despesa operacional imediata via cart√£o.

Isso deve seguir fluxo de Compras / patrim√¥nio. N√£o lan√ßar no cart√£o Clara.`
            };
        }
    }

    // 2. Uso pessoal / lazer pessoal / refei√ß√£o pessoal
    // Se o texto sugere gasto pra voc√™ mesmo, fam√≠lia, lazer etc.
    const padroesUsoPessoal = [
        "meu almoco","meu almo√ßo","meu jantar","minha janta",
        "meu lanche","minha comida","refeicao pessoal","refei√ß√£o pessoal",
        "almo√ßo pessoal","jantar pessoal","lanche pessoal",
        "uber pra mim","uber pra casa","99 pra mim","taxi pra mim","t√°xi pra mim",
        "cinema","pipoca","pipoquinha",
        "roupa pro meu filho","roupa para meu filho","pro meu filho","para meu filho",
        "pra mim","para mim","uso pessoal","gasto pessoal","pessoal meu"
    ];
    for (const pessoal of padroesUsoPessoal) {
        if (msgNorm.includes(normalize(pessoal))) {
            return {
                pode: false,
                tipo: "PESSOAL",
                resposta:
`‚ùå N√£o pode usar o cart√£o Clara para gasto pessoal, refei√ß√£o pessoal, lazer, presente pra fam√≠lia ou transporte pessoal (Uber/99/t√°xi pessoal).
            };
        }
    }

    // 3. Bebida alco√≥lica
    if (
        msgNorm.includes("cerveja") ||
        msgNorm.includes("vinho") ||
        msgNorm.includes("whisky") ||
        msgNorm.includes("vodka") ||
        msgNorm.includes("cachaca") ||
        msgNorm.includes("cacha√ßa") ||
        msgNorm.includes("alcool") ||
        msgNorm.includes("√°lcool")
    ) {
        return {
            pode: false,
            tipo: "ALCOOL",
            resposta:
`‚ùå N√£o pode comprar bebida alco√≥lica com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.`
        };
    }

    // 4. Lanche / √°gua / coffee break da equipe (operacional autorizado)
    // Aqui entram p√£o, suco, refrigerante, bolo etc.
    const termosLancheOperacional = [
        "lanche","pao","p√£o","paozinho","p√£ezinho",
        "bolo","salgado","biscoito","biscoitos",
        "cafe","caf√©","coffee break","refrigerante","refri","suco","suquinho",
        "agua","√°gua","gal√£o","galao","gal√£o de agua","gal√£o de √°gua",
        "premiacao","premia√ß√£o","premiacao equipe","premia√ß√£o equipe",
        "treinamento","treinamento interno","acao vm","a√ß√£o vm","acao regional","a√ß√£o regional"
    ];
    for (const termo of termosLancheOperacional) {
        if (msgNorm.includes(normalize(termo))) {
            return {
                pode: true,
                tipo: "LANCHES DE REFEI√á√ïES",
                resposta:
`‚úÖ Pode usar o cart√£o Clara SE for para atividade operacional autorizada da loja:
‚Ä¢ treinamento oficial interno,
‚Ä¢ a√ß√£o aprovada (VM / regional / diretoria),
‚Ä¢ premia√ß√£o operacional autorizada.

Etiqueta:
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL"
‚Ä¢ Lanche / coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"

Como lan√ßar:
‚Ä¢ anexar nota fiscal em at√© 48h,
‚Ä¢ escolher a etiqueta correta,
‚Ä¢ descrever: "Coffee break treinamento VM loja 1234".

‚ö† N√£o pode para almo√ßo pessoal / lazer particular.`
            };
        }
    }

    // 5. Itens operacionais que t√™m etiqueta direta (mouse, teclado, motoboy, sedex, chaveiro etc.)
    const etiquetaDetectada = acharEtiquetaPorMensagem(msgNorm);
    if (etiquetaDetectada) {
        return {
            pode: true,
            tipo: etiquetaDetectada.nome,
            resposta:
`‚úÖ Pode usar o cart√£o Clara, porque √© uma despesa operacional da loja.

Etiqueta: "${etiquetaDetectada.nome}"

O que cobre: ${etiquetaDetectada.descricao}${etiquetaDetectada.observacaoUso ? ` (${etiquetaDetectada.observacaoUso})` : ""}

Como lan√ßar (at√© 48h):
‚Ä¢ anexar nota fiscal/recibo,
‚Ä¢ selecionar "${etiquetaDetectada.nome}",
‚Ä¢ descrever objetivamente (ex.: "Teclado PDV loja 1234"),
‚Ä¢ guardar o documento f√≠sico na loja por pelo menos 180 dias.`
        };
    }

    // 6. Se n√£o reconheci, devolve seguro e N√ÉO inventa etiqueta tipo "CORREIOS"
    return {
        pode: null,
        tipo: "NAO_MAPEADO",
        resposta:
`N√£o encontrei isso como gasto operacional autorizado dentro das categorias padr√£o (√°gua/equipe autorizada, coffee break autorizado, material de inform√°tica de baixo valor, material de escrit√≥rio/limpeza, motoboy emergencial, chaveiro emergencial, manuten√ß√£o simples el√©trica/ar-condicionado/civil de baixo valor, bobina fiscal, envio Correios/Sedex da loja).

Se for algo pessoal, bebida alco√≥lica ou item patrimonial / infraestrutura (TV, mesa, geladeira, carro etc.), n√£o pode no cart√£o Clara.

Se voc√™ acredita que √© gasto operacional leg√≠timo da loja mas n√£o tem etiqueta adequada, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a> pedindo orienta√ß√£o/cria√ß√£o de etiqueta.`
    };
}

// =====================================================
// Respostas por inten√ß√£o
// =====================================================
function respostaForaEscopo() {
    return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
}

function respEtiquetaDireta(et) {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nome}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.descricao}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}
<p class="mt-2">
Lan√ßar na Clara em at√© 48h:<br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar "${et.nome}";<br/>
3. Descrever objetivamente o gasto (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar o documento f√≠sico na loja por pelo menos 180 dias.
</p>
</div>`;
}

function respLimite() {
    return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
}

function respBloqueio() {
    return `HTML:<p class="text-sm text-slate-700">
Bloqueio preventivo acontece quando tem compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
‚Ä¢ faltou nota fiscal/recibo,<br/>
‚Ä¢ n√£o colocou etiqueta correta,<br/>
‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
Passos pra desbloquear:<br/>
1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolhe etiqueta certa, descreve o motivo real).<br/>
2. Avise o Financeiro que j√° foi ajustado.<br/><br/>
Reincid√™ncia pode fazer a loja perder permiss√£o de uso do cart√£o.
</p>`;
}

function respPrestacaoContas() {
    return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 180 dias corridos. N√£o justificar no prazo => risco de bloqueio preventivo.
</p>`;
}

function respAlimentoTime() {
    return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
}

function respTransportePessoal() {
    return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja.<br/><br/>
Se j√° usou:<br/>
‚Ä¢ comunicar o Financeiro imediatamente,<br/>
‚Ä¢ classificar como "Despesa Pessoal ‚Äì Uso Indevido" na plataforma,<br/>
‚Ä¢ ressarcir o valor √† empresa em at√© 2 dias √∫teis.<br/><br/>
Falta de regulariza√ß√£o pode gerar bloqueio e at√© desconto em folha.
</p>`;
}

function respTrocaGerente() {
    return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja segue assim:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja.<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234".<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado,<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Se tiver caso especial, fale com o Financeiro e, se preciso, abra chamado no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>.
</p>`;
}

function respSangria() {
    return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© DESCONTINUADO.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
}

function respFraudeContestacao() {
    return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente.<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o.<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal, a√≠ precisa ressarcir em at√© 2 dias √∫teis; n√£o √© contesta√ß√£o.
</p>`;
}

// fallback contextual

function respGenerica(msgNorm) {
    const avaliacao = avaliarCompraEspecifica(msgNorm);

    // CASO 1: claramente proibido (pode === false)
    if (avaliacao.pode === false) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p class="mt-1">${avaliacao.resposta}</p>
</div>`;
    }

    // CASO 2: claramente permitido (pode === true)
    // Aqui a gente N√ÉO coloca mais aquele prefixo fixo "Pode usar o cart√£o Clara..."
    // porque esse prefixo era o que estava aparecendo errado em cen√°rios indevidos.
    if (avaliacao.pode === true) {
        return `HTML:<div class="text-sm text-slate-700">
<p>${avaliacao.resposta}</p>
</div>`;
    }

    // CASO 3: n√£o foi poss√≠vel classificar (pode === null)
    // Este √© o fallback SEGURO. Aqui a resposta explica pol√≠tica,
    // fala que provavelmente N√ÉO √© permitido se n√£o for claramente operacional,
    // e n√£o inventa etiqueta tipo "CORREIOS" pra qualquer coisa.
    return `HTML:<div class="text-sm text-slate-700">
<p><b>N√£o encontrei isso como gasto operacional autorizado na Pol√≠tica de Uso dos Cart√µes Clara.</b></p>

<p class="mt-2">O cart√£o s√≥ pode ser usado para despesas operacionais da loja, por exemplo:</p>
<ul class="list-disc ml-4">
<li>material de escrit√≥rio (caneta, pasta, bloco etc.);</li>
<li>material de inform√°tica de baixo valor (mouse, teclado, cabo, pendrive etc.);</li>
<li>√°gua pot√°vel / coffee break autorizado para treinamento interno oficial, a√ß√£o aprovada (VM / regional / diretoria) ou premia√ß√£o operacional autorizada;</li>
<li>motoboy / Sedex emergencial ligado √† opera√ß√£o da loja;</li>
<li>chaveiro emergencial (abrir estoque/cofre/estoque trancado etc.);</li>
<li>manuten√ß√£o simples el√©trica / civil / ar-condicionado de baixo valor (troca de tomada, ajuste pequeno, limpeza de filtro);</li>
<li>bobina fiscal / bobina de ECF se a loja √© respons√°vel por isso;</li>
<li>Correios/Sedex quando for envio operacional da loja.</li>
</ul>

<p class="mt-2"><b>N√£o pode usar o cart√£o Clara para:</b></p>
<ul class="list-disc ml-4">
<li>gasto pessoal (almo√ßo/jantar pessoal, lanche pessoal etc.);</li>
<li>bebida alco√≥lica;</li>
<li>transporte pessoal tipo Uber / 99 / t√°xi pessoal;</li>
<li>bens patrimoniais / eletr√¥nicos / infraestrutura grande (geladeira, micro-ondas, TV, home theater, PS5, carro, m√≥veis grandes);</li>
<li>qualquer compra sem v√≠nculo direto e imediato com a opera√ß√£o da loja.</li>
</ul>

<p class="mt-2">Se isso j√° foi pago no cart√£o:</p>
<ul class="list-disc ml-4">
<li>avisar o Financeiro;</li>
<li>classificar na Clara como "Despesa Pessoal ‚Äì Uso Indevido";</li>
<li>ressarcir o valor em at√© 2 dias √∫teis para evitar bloqueio preventivo do cart√£o.</li>
</ul>

<p class="mt-2">Se voc√™ acredita que √© um gasto operacional leg√≠timo mas n√£o existe etiqueta adequada, abra chamado no 
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a> pedindo orienta√ß√£o/cria√ß√£o de etiqueta espec√≠fica.</p>
</div>`;
}

function respFollowup(msgNorm) {
    if (ultimaIntencao === "limite") return respLimite();
    if (ultimaIntencao === "bloqueio") return respBloqueio();
    if (ultimaIntencao === "prestacao") return respPrestacaoContas();
    if (ultimaIntencao === "alimentoTime") return respAlimentoTime();
    if (ultimaIntencao === "transportePessoal") return respTransportePessoal();
    if (ultimaIntencao === "trocaGerente") return respTrocaGerente();
    if (ultimaIntencao === "sangria") return respSangria();
    if (ultimaIntencao === "fraudeContestacao") return respFraudeContestacao();
    return respGenerica(msgNorm);
}

// =====================================================
// Motor principal de resposta
// =====================================================
function gerarRespostaDoBot(msgUsuario) {
    const norm = normalize(msgUsuario);
    const intencao = detectarIntencaoPergunta(norm);
    let resposta;

    // 1. ASSUNTOS SOBRE LIMITE (aumento de limite, limite insuficiente, limite acabou etc.)
    // Mantemos apenas UMA checagem de "limite" aqui em cima, para n√£o ter duplicado.
    if (norm.includes("limite")) {
        ultimaIntencao = "limite";
        return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
    }

    // 2. USO PESSOAL / ALIMENTA√á√ÉO PESSOAL
    // Aqui vamos ampliar os padr√µes pra pegar janta, almo√ßo, lanche pessoal etc.
    const padroesGastoPessoalAlimentacao = [
        "paguei meu almoco",
        "paguei meu almo√ßo",
        "paguei meu jantar",
        "paguei meu lanche",
        "paguei meu caf√©",
        "paguei meu cafe",
        "paguei meu pastel",
        "paguei minha refeicao",
        "paguei minha refei√ß√£o",
        "paguei minha comida",
        "paguei minha janta",

        "meu almo√ßo",
        "meu almoco",
        "meu jantar",
        "minha janta",
        "meu lanche",
        "meu lanche com o cartao",
        "meu lanche com o cart√£o",
        "minha comida",

        "almoco pessoal",
        "almo√ßo pessoal",
        "jantar pessoal",
        "lanche pessoal",
        "refei√ß√£o pessoal",
        "refeicao pessoal",

        // varia√ß√µes tipo "almocei com o cart√£o", "jantei com o cart√£o"
        "almocei com o cartao",
        "almocei com o cart√£o",
        "jantei com o cartao",
        "jantei com o cart√£o",
        "comi com o cartao",
        "comi com o cart√£o"
    ];

    const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));

    if (isGastoPessoalAlimentacao) {
        ultimaIntencao = "gasto_pessoal_alimentacao";
        return `‚õî Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.

Se j√° foi pago com o cart√£o:
‚Ä¢ Avise o Financeiro e abra chamado no ServiceNow (Contas a Receber > Cart√£o Clara > Gasto Indevido - pessoal);
‚Ä¢ Classifique na Clara como "Despesa Pessoal ‚Äì Uso Indevido";
‚Ä¢ Ressar√ßa o valor √† empresa.

Se n√£o regularizar, o cart√£o pode ficar bloqueado preventivamente.`;
    }

    // 3. Agora seguimos com a sua inten√ß√£o principal detectada por detectarIntencaoPergunta()
    switch (intencao) {

        case "foraEscopo":
            // Perguntas tipo futebol, pol√≠tica nacional, matem√°tica etc.
            ultimaIntencao = "foraEscopo";
            resposta = respostaForaEscopo();
            break;

        case "etiqueta":
            // Usu√°rio perguntou algo tipo "qual etiqueta usar pra mouse?" ou "que etiqueta pra √°gua?"
            ultimaIntencao = "etiqueta";
            {
                const et = acharEtiquetaPorMensagem(norm);

                if (et) {
                    // Se achamos uma etiqueta v√°lida mapeada, vamos responder com a etiqueta
                    resposta = respEtiquetaDireta(et);
                } else {
                    // üîí ESTE √â O PONTO QUE EVITA A RESPOSTA 'CORREIOS' PRA TUDO
                    // Em vez de chutar uma etiqueta qualquer, devolvemos uma resposta segura.
                    resposta = `HTML:<p class="text-sm text-slate-700">
N√£o encontrei uma etiqueta clara para isso dentro das categorias operacionais autorizadas.

O cart√£o Clara s√≥ pode ser usado para despesas operacionais da loja (por ex.: material de escrit√≥rio, material de inform√°tica de baixo valor como mouse/teclado/cabo, √°gua pot√°vel para a equipe, coffee break autorizado para a√ß√£o de loja, motoboy emergencial, chaveiro emergencial, manuten√ß√£o simples el√©trica/ar-condicionado, bobina fiscal, Correios/Sedex da loja etc.).

Se for gasto pessoal, bebida alco√≥lica, item patrimonial/infraestrutura (geladeira, TV, home theater, carro, m√≥vel grande), transporte pessoal tipo Uber, ou qualquer compra que n√£o seja diretamente ligada √† opera√ß√£o imediata da loja ‚Äî n√£o pode no cart√£o Clara.

Se voc√™ acredita que √© um gasto operacional leg√≠timo mas n√£o existe etiqueta correspondente, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a> solicitando cria√ß√£o de etiqueta.</p>`;
                }
            }
            break;

        case "limite":
            // Voc√™ j√° trata "limite" logo no come√ßo. Este case aqui vira s√≥ um fallback.
            ultimaIntencao = "limite";
            resposta = respLimite ? respLimite() : 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ qual gasto precisa fazer,<br>‚Ä¢ urg√™ncia,<br>‚Ä¢ por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
            break;

        case "bloqueio":
            // "cart√£o bloqueou", "travou", "como desbloquear"
            ultimaIntencao = "bloqueio";
            resposta = respBloqueio();
            break;

        case "prestacao":
            // "como justificar a transa√ß√£o?", "como lan√ßar nota?", "quanto tempo eu tenho?"
            ultimaIntencao = "prestacao";
            resposta = respPrestacaoContas();
            break;

        case "alimentoTime":
            // "posso comprar lanche pro time?", "coffee break pra VM?"
            ultimaIntencao = "alimentoTime";
            resposta = respAlimentoTime();
            break;

        case "transportePessoal":
            // "Uber pode?", "99 pode?", "t√°xi pra mim pode?"
            ultimaIntencao = "transportePessoal";
            resposta = respTransportePessoal();
            break;

        case "trocaGerente":
            // "vou mudar de loja", "gerente desligou", "posso usar cart√£o de outra loja?"
            ultimaIntencao = "trocaGerente";
            resposta = respTrocaGerente();
            break;

        case "sangria":
            // "posso fazer sangria ainda?", "acabou a sangria?"
            ultimaIntencao = "sangria";
            resposta = respSangria();
            break;

        case "fraudeContestacao":
            // "compra que n√£o reconhe√ßo", "fraude no cart√£o"
            ultimaIntencao = "fraudeContestacao";
            resposta = respFraudeContestacao();
            break;

        case "podeNaoPode":
            // perguntas tipo "posso comprar geladeira?", "posso comprar carro?", "posso comprar lim√£o?"
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;

        case "generica":
        default:
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;
    }

    return resposta;
}


// =====================================================
// Renderiza√ß√£o das mensagens no chat
// =====================================================
const chatWindow = document.getElementById("chatWindow");
const chatForm = document.getElementById("chatForm");
const userInput = document.getElementById("userInput");

function scrollToBottom() {
    requestAnimationFrame(() => {
        chatWindow.scrollTop = chatWindow.scrollHeight;
        // garante 100% que desce at√© o fim
        setTimeout(() => {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }, 150);
    });
}

function renderUserMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start justify-end gap-3";

    const bubble = document.createElement("div");
    bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
    bubble.innerText = text;

    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

function renderBotMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start gap-3";

    const avatar = document.createElement("img");
    avatar.src = "Gemini_Generated_Image_nzni5znzni5znzni.png";
    avatar.alt = "Assistente Clara (rob√¥)";
    avatar.className = "h-14 w-auto object-contain flex-shrink-0";

    const bubble = document.createElement("div");
    bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

    if (text.startsWith("HTML:")) {
        bubble.innerHTML = text.replace(/^HTML:/, "").trim();
    } else {
        bubble.innerText = text;
    }

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

// =====================================================
// Envio de mensagem
// =====================================================

<script>
// pega os elementos do DOM UMA VEZ
const userInput = document.getElementById("userInput");
const sendButton = document.getElementById("sendButton");
const chatForm  = document.getElementById("chatForm"); // se existir <form id="chatForm">

// envia a mensagem: renderiza usu√°rio, gera resposta, renderiza bot
function enviarMensagem() {
    const pergunta = userInput.value.trim();
    if (!pergunta) return;

    renderUserMessage(pergunta);

    const resposta = gerarRespostaDoBot(pergunta);
    renderBotMessage(resposta);

    // limpa campo e foca de novo
    userInput.value = "";
    userInput.focus();

    // rolar pro final do chat depois de responder
    scrollChatToBottom();
}

// garante que o chat role sempre pro final
function scrollChatToBottom() {
    const chatBox = document.getElementById("chatMessages"); // <- esse deve ser o container da conversa
    if (chatBox) {
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

// ENTER (sem Shift) ENVIA
userInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault(); // n√£o quebra linha
        enviarMensagem();
    }
});

// CLIQUE NO BOT√ÉO "ENVIAR"
if (sendButton) {
    sendButton.addEventListener("click", function (e) {
        e.preventDefault();
        enviarMensagem();
    });
}

// SUBMIT DO FORM (se existir <form id="chatForm"> envolvendo input+bot√£o)
if (chatForm) {
    chatForm.addEventListener("submit", function (e) {
        e.preventDefault();
        enviarMensagem();
    });
}
</script>
</body>
</html>
