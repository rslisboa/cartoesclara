<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Agente Clara</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:800px;
        margin:2rem auto;
        display:flex;
        flex-direction:column;
        height:90vh;
    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        background-color:#005E27;
        color:#B5FF20;
        margin-bottom:0.5rem;
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:78px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex:1 1 auto;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
    }
    .chat-window {
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
    }

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digita√ß√£o menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do hist√≥rico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links nas respostas do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }
</style>
</head>
<body class="text-slate-800">

<div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Grupo SBF | Vektor</h1>

                <p>Pergunte sobre o uso do cart√£o Clara nas lojas.</p>

                <div class="examples"></div>
                <div class="policy-note text-[12px] mt-2"></div>
            </div>

            <div class="chat-header-avatar">
                <img src= "https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png"
                     alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

            <!-- Mensagem inicial do bot -->
            <div class="flex items-start gap-3">
                <img
                    src = "https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png";
                    alt="Assistente Clara (rob√¥)"
                    class="h-16 w-auto object-contain flex-shrink-0"
                />
                <div class="bot-bubble px-4 py-3 max-w-[80%] text-sm text-slate-700">
                    <p class="font-semibold text-slate-800 text-base">
                        Ol√°! üëã Eu sou o Vektor, agente do <b>Grupo SBF</b> especializado na Clara.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar direto, tipo:<br/>
                        ‚Ä¢ "Posso comprar mouse?"<br/>
                        ‚Ä¢ "Como aumento o limite?"<br/>
                        ‚Ä¢ "Vou trocar de loja, o que fa√ßo com o cart√£o?"<br/>
                        ‚Ä¢ "Qual etiqueta pra √°gua/mineral?"<br/>
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Se o assunto n√£o tiver rela√ß√£o com a Pol√≠tica de Uso dos Cart√µes da Clara nas lojas eu n√£o estarei apto para responder.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Quer o documento oficial completo?
                        <a class="policy-link"
                           href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing"
                           target="_blank" rel="noopener noreferrer">
                            Segue a Pol√≠tica de Uso dos Cart√µes Clara
                        </a>.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER / INPUT -->
    <footer class="chat-footer">
        <form id="chatForm" class="w-full">
            <div class="input-shell">
                <textarea id="userInput" placeholder="Digite sua d√∫vida sobre o cart√£o Clara..."></textarea>
                <button type="submit" id="sendBtn">Enviar</button>
            </div>
        </form>
    </footer>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

const ROBOT_IMG_URL = "https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png";



    /* ================= ESTADOS GLOBAIS ================= */

    // fluxo de pend√™ncias / e-mail
    let aguardandoLojaPendencias = false;
    let aguardandoConfirmacaoEnvioEmail = false;
    let aguardandoEmailPendencias = false;
    let lojaPendenciasAtual = "";
    // ===== Fluxo de pedido de novo cart√£o (1¬™ ou 2¬™ via) =====
    let fluxoNovoCartao = null; 
    // valores poss√≠veis: null ou "aguardando_tipo_via"
    let ultimaPendenciaResumo = null; // { loja, data }

    // √∫ltima inten√ß√£o de pol√≠tica (follow-up)
    let ultimaIntencao = null;

    /* ================= REFER√äNCIAS DO CHAT ================= */

    const chatWindow = document.getElementById("chatWindow");
    const chatForm   = document.getElementById("chatForm");
    const userInput  = document.getElementById("userInput");
    const sendBtn    = document.getElementById("sendBtn");

    /* ================= FUN√á√ïES UTILIT√ÅRIAS UI ================= */

    function scrollToBottom() {
        requestAnimationFrame(() => {
            const body = document.querySelector(".chat-body");
            if (body) {
                body.scrollTop = body.scrollHeight;
                setTimeout(() => {
                    body.scrollTop = body.scrollHeight;
                }, 150);
            }
        });
    }

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start justify-end gap-3";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

    function renderBotMessage(text) {
        if (!text) return;
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start gap-3";

        const avatar = document.createElement("img");
        avatar.src = "https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png";
        avatar.alt = "Assistente Clara (rob√¥)";
        avatar.className = "h-16 w-auto object-contain flex-shrink-0";

        const bubble = document.createElement("div");
        bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

        if (typeof text === "string" && text.startsWith("HTML:")) {
            bubble.innerHTML = text.replace(/^HTML:/, "").trim();
        } else {
            bubble.innerText = text;
        }

        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

    /* ==================== REGRAS / ETIQUETAS ==================== */

    const POLITICA_COMPLETA = `
1. O cart√£o Clara √© o meio oficial para despesas operacionais das lojas.
2. Toda compra tem que ser justificada na Clara em at√© 48h: etiqueta correta, nota fiscal/recibo anexado, descri√ß√£o objetiva.
3. Despesa pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal, cinema, bebida alco√≥lica etc.) √© proibida.
4. Itens patrimoniais/infraestrutura (geladeira, micro-ondas, cafeteira el√©trica, TV, home theater, mesa, cadeira etc.) n√£o entram no cart√£o Clara.
5. Lanches/√°gua: s√≥ se ligados a opera√ß√£o autorizada (treinamento oficial, a√ß√£o aprovada, premia√ß√£o operacional).
6. Troca de gerente / uso tempor√°rio de cart√£o de outra loja: s√≥ com autoriza√ß√£o Financeiro e descri√ß√£o correta na Clara.
7. Aumento de limite: chamado no ServiceNow explicando necessidade operacional e urg√™ncia.
8. Bloqueio por falta de justificativa: regularizar na Clara e acionar Financeiro.
9. Contesta√ß√£o de compra n√£o reconhecida: acionar Financeiro e suporte Clara em at√© 2 dias √∫teis.
10. Sangria: descontinuada ap√≥s implanta√ß√£o do cart√£o, s√≥ exce√ß√£o com autoriza√ß√£o pr√©via do Financeiro.
`;

    const etiquetasOficiais = [
        {
            nome: "AGUA POT√ÅVEL",
            palavrasChave: [
                "agua","√°gua","gal√£o","galao","garrafa de agua","garrafa de √°gua",
                "galao de agua","garrafa de agua","garrafa de √°gua"
            ],
            descricao: "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe/loja, quando previsto operacionalmente.",
            observacaoUso: ""
        },
        {
            nome: "LANCHES DE REFEI√á√ïES",
            palavrasChave: [
                "lanche","lanche equipe","lanche da equipe","coffee break","cafe","caf√©",
                "pao","p√£o","bolo","salgado","biscoito","biscoitos","refrigerante",
                "refris","suco","suco natural","suquinho","lanchinho","kit lanche",
                "croissant","torta","doces treinamento","premia√ß√£o","premiacao"
            ],
            descricao: "Lanche / coffee break ligado a treinamento interno oficial, a√ß√£o aprovada (VM, regional, diretoria) ou premia√ß√£o operacional autorizada.",
            observacaoUso: "N√£o cobre almo√ßo pessoal ou lazer particular."
        },
        {
            nome: "MATERIAL DE INFORM√ÅTICA",
            palavrasChave: [
                "mouse","teclado","teclado pdv","cabo usb","cabos","pendrive","pen drive",
                "roteador","hub usb","fonte notebook","fonte","adaptador","cabo rede"
            ],
            descricao: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hub USB, cart√µes de mem√≥ria de baixo valor.",
            observacaoUso: "Serve para manter PDV/opera√ß√£o rodando. N√£o cobre TV, monitor grande, console etc."
        },
        {
            nome: "MATERIAL DE ESCRIT√ìRIO",
            palavrasChave: [
                "caneta","canetas","pasta","pastas","papel","bloco","blocos","caderno",
                "cadernos","etiqueta adesiva","grampeador","organizador de mesa","clips","clipes"
            ],
            descricao: "Canetas, clips, pastas, blocos de anota√ß√£o, grampeadores, etiquetas, organizadores de mesa.",
            observacaoUso: ""
        },
        {
            nome: "MATERIAL DE LIMPEZA",
            palavrasChave: [
                "detergente","desinfetante","sabonete","pano de ch√£o","pano de chao","pano",
                "alcool","√°lcool","papel toalha","vassoura","rodo","limpeza loja"
            ],
            descricao: "Detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc. para uso da loja.",
            observacaoUso: "Materiais para manuten√ß√£o da limpeza da loja."
        },
        {
            nome: "MATERIAL DE COPA E COZINHA",
            palavrasChave: [
                "copo descartavel","copo","talher","talheres","garrafa t√©rmica","garrafa termica",
                "pano de prato","pano prato","filtro de cafe","filtro de caf√©","pote plastico",
                "pote pl√°stico","potes"
            ],
            descricao: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, potes pl√°sticos.",
            observacaoUso: "N√ÉO inclui eletrodom√©stico (cafeteira el√©trica, micro-ondas, etc.)."
        },
        {
            nome: "MANUTEN√á√ÉO EL√âTRICO",
            palavrasChave: [
                "tomada","tomadas","disjuntor","disjuntores","interruptor","interruptores",
                "reator","soquete","soquetes","extensao","extens√£o","fia√ß√£o","fiacao",
                "eletrico","el√©trico"
            ],
            descricao: "Troca de tomadas, disjuntores, interruptores, pequenos reparos de fia√ß√£o de baixa tens√£o.",
            observacaoUso: "Servi√ßos simples e pontuais, baixo valor, para manter a loja operando."
        },
        {
            nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
            palavrasChave: [
                "ar condicionado","ar-condicionado","arcondicionado","limpeza filtro ar",
                "carga de gas ar","controle remoto ar","manutencao ar","manuten√ß√£o ar",
                "controle ar"
            ],
            descricao: "Limpeza de filtro, carga de g√°s, troca de controle remoto ou ajuste simples de ar-condicionado.",
            observacaoUso: "Compra de um ar-condicionado novo n√£o entra."
        },
        {
            nome: "MANUTEN√á√ÉO CIVIL",
            palavrasChave: [
                "parafusar prateleira","arrumar porta","trocar fechadura loja","reparo parede",
                "trocar vidro","ajuste prateleira fixa","conserto parede","manuten√ß√£o civil",
                "manutencao civil"
            ],
            descricao: "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa), exceto chaveiro emergencial.",
            observacaoUso: ""
        },
        {
            nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
            palavrasChave: [
                "conserto impressora etiqueta","manutencao impressora","ajuste maquina estampar",
                "maquina estampar","reparo computador loja","ferramenta manual",
                "manuten√ß√£o equipamentos","manutencao equipamentos"
            ],
            descricao: "Reparo de impressora de etiqueta, m√°quina de estampar, computador fora de garantia, ferramenta manual pequena.",
            observacaoUso: "Equipamento grande/patrimonial n√£o."
        },
        {
            nome: "CHAVEIRO EMERGENCIAL",
            palavrasChave: [
                "chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar segredo",
                "perdi a chave","sem chave cofre"
            ],
            descricao: "Servi√ßo emergencial de chaveiro para abrir cofre, estoque, vitrine.",
            observacaoUso: "Somente emerg√™ncia operacional real."
        },
        {
            nome: "TRANSPORTE SERVI√áOS EMERGENCIAS",
            palavrasChave: [
                "motoboy","moto boy","moto-boy","frete urgente","entrega urgente",
                "pegar documento na matriz","levar documento","sedex urgente","courier",
                "lalamove","lala move","frete local","frete local emergencial"
            ],
            descricao: "Frete local emergencial / motoboy para levar/pegar item ou documento cr√≠tico entre loja e matriz.",
            observacaoUso: "Uber / 99 pessoal n√£o entra aqui. Uber pessoal n√£o pode no cart√£o Clara."
        },
        {
            nome: "CORREIOS_SEDEX/AR/POSTAGEM",
            palavrasChave: [
                "sedex","correios","ar","postagem","envio documento",
                "carta registrada","devolucao correios","devolu√ß√£o correios"
            ],
            descricao: "Envio de documentos f√≠sicos via Sedex/AR/postagem oficial; devolu√ß√µes pequenas.",
            observacaoUso: ""
        },
        {
            nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
            palavrasChave: [
                "banner","adesivo promocional","adesivo","flyer","folder",
                "encadernacao","encaderna√ß√£o","material visual loja",
                "impressao grafica","impress√£o gr√°fica"
            ],
            descricao: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√µes, material visual da loja.",
            observacaoUso: ""
        },
        {
            nome: "BOBINA ECF",
            palavrasChave: [
                "bobina","bobina ecf","bobina fiscal","bobina impressora fiscal",
                "ecf","cupom fiscal","bobina pdv","bobina caixa"
            ],
            descricao: "Bobina para ECF / impressora fiscal / PDV onde n√£o h√° fornecimento centralizado.",
            observacaoUso: ""
        }
    ];

    const perguntasGeraisEtiqueta = [
        "qual etiqueta devo usar","qual etiqueta usar","qual etiqueta eu uso",
        "que etiqueta devo usar","que etiqueta usar","que etiqueta eu uso",
        "me fala as etiquetas","me diz as etiquetas","me mostra as etiquetas",
        "me envia as etiquetas","me passa as etiquetas",
        "todas as etiquetas","lista de etiquetas","listagem de etiquetas",
        "quais etiquetas existem","quais etiquetas tem","quais sao as etiquetas",
        "quais s√£o as etiquetas","quais etiquetas posso usar",
        "quais etiquetas devo usar","quais etiquetas usar",
        "categorias de gasto","categorias de despesas","categoria de despesa",
        "categoria de gasto","categoria clara","etiqueta clara", "etiqueta", "etiquetas", "categoria"
    ].map(normalize);

    /* ==================== NORMALIZA√á√ÉO / INTEN√á√ÉO ==================== */

    function normalize(str) {
        return str
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    function detectarIntencaoPergunta(msgNorm) {
        const foraEscopoPadroes = [
            "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
            "presidente","futebol","time joga","campeonato","xing","vai tomar",
            "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
            "piada","xingar","palavr√£o","palavrao"
        ];
        for (const termo of foraEscopoPadroes) {
            if (msgNorm.includes(normalize(termo))) {
                return "foraEscopo";
            }
        }

        if (msgNorm.includes("etiqueta") ||
            msgNorm.includes("qual etiqueta") ||
            msgNorm.includes("que etiqueta")) {
            return "etiqueta";
        }

        if (msgNorm.includes("aumentar limite") ||
            msgNorm.includes("aumento de limite") ||
            msgNorm.includes("limite maior") ||
            msgNorm.includes("limite do cartao") ||
            msgNorm.includes("limite do cart√£o") ||
            msgNorm.includes("limite nao basta") ||
            msgNorm.includes("limite n√£o basta") ||
            msgNorm.includes("limite acabou") ||
            msgNorm.includes("limite estourou") ||
            msgNorm.includes("limite")) {
            return "limite";
        }

        if (msgNorm.includes("bloqueou") ||
            msgNorm.includes("bloqueado") ||
            msgNorm.includes("desbloquear") ||
            msgNorm.includes("cartao travou") ||
            msgNorm.includes("cart√£o travou") ||
            msgNorm.includes("travou o cartao") ||
            msgNorm.includes("travou o cart√£o") ||
            msgNorm.includes("bloqueio preventivo")) {
            return "bloqueio";
        }

        if (msgNorm.includes("como justificar") ||
            msgNorm.includes("justificar compra") ||
            msgNorm.includes("prestar contas") ||
            msgNorm.includes("prestacao de contas") ||
            msgNorm.includes("presta√ß√£o de contas") ||
            msgNorm.includes("colocar nota") ||
            msgNorm.includes("anexar nota") ||
            msgNorm.includes("descricao na clara") ||
            msgNorm.includes("descri√ß√£o na clara")) {
            return "prestacao";
        }

        if (msgNorm.includes("lanche") ||
            msgNorm.includes("lanche pro time") ||
            msgNorm.includes("lanche para o time") ||
            msgNorm.includes("cafe pro time") ||
            msgNorm.includes("caf√© pro time") ||
            msgNorm.includes("coffee break") ||
            msgNorm.includes("agua") ||
            msgNorm.includes("√°gua") ||
            msgNorm.includes("gal√£o") ||
            msgNorm.includes("galao") ||
            msgNorm.includes("premiacao") ||
            msgNorm.includes("premia√ß√£o")) {
            return "alimentoTime";
        }

        if (msgNorm.includes("uber") ||
            msgNorm.includes("iber") ||
            msgNorm.includes("99") ||
            Norm.includes(" 99") ||
            msgNorm.includes("taxi") ||
            msgNorm.includes("t√°xi") ||
            msgNorm.includes("tax√≠") ||
            msgNorm.includes("cabify") ||
            msgNorm.includes("app de transporte")) {
            return "transportePessoal";
        }

        if (msgNorm.includes("mudar de loja") ||
            msgNorm.includes("troca de loja") ||
            msgNorm.includes("trocar de loja") ||
            msgNorm.includes("mudan√ßa de loja") ||
            msgNorm.includes("mudanca de loja") ||
            msgNorm.includes("vou mudar de loja") ||
            msgNorm.includes("fui transferido") ||
            msgNorm.includes("transferido de loja") ||
            msgNorm.includes("transferencia de loja") ||
            msgNorm.includes("transfer√™ncia de loja") ||
            msgNorm.includes("gerente desligado") ||
            msgNorm.includes("sem gerente") ||
            msgNorm.includes("gerente saiu") ||
            msgNorm.includes("gerente saiu da loja") ||
            msgNorm.includes("cartao de outra loja") ||
            msgNorm.includes("cart√£o de outra loja") ||
            msgNorm.includes("usar cartao de outra loja") ||
            msgNorm.includes("usar cart√£o de outra loja")) {
            return "trocaGerente";
        }

        if (msgNorm.includes("sangria") ||
            msgNorm.includes("sangrias") ||
            msgNorm.includes("fazer sangria") ||
            msgNorm.includes("puxar dinheiro do caixa") ||
            msgNorm.includes("retirar dinheiro do caixa")) {
            return "sangria";
        }

        if (msgNorm.includes("nao reconheco") ||
            msgNorm.includes("n√£o reconhe√ßo") ||
            msgNorm.includes("fraude") ||
            msgNorm.includes("compra indevida") ||
            msgNorm.includes("contestar compra") ||
            msgNorm.includes("contestacao") ||
            msgNorm.includes("contesta√ß√£o")) {
            return "fraudeContestacao";
        }

        if (msgNorm.includes("posso comprar") ||
            msgNorm.includes("posso usar") ||
            msgNorm.includes("pode usar") ||
            msgNorm.includes("pode pagar") ||
            msgNorm.includes("pode gastar") ||
            msgNorm.includes("pode comprar") ||
            msgNorm.includes("pode no cartao") ||
            msgNorm.includes("pode no cart√£o") ||
            msgNorm.includes("pode colocar no cartao") ||
            msgNorm.includes("pode colocar no cart√£o")) {
            return "podeNaoPode";
        }

        return "generica";
    }

    /* ==================== ETIQUETA POR MENSAGEM ==================== */

    function acharEtiquetaPorMensagem(msgNorm) {
        const stopTerms = [
            "etiqueta","qual etiqueta","que etiqueta","categoria","qual categoria",
            "classificacao","classifica√ß√£o","tag","pode usar","posso usar",
            "posso comprar","pode comprar","cartao","cart√£o","cartao clara",
            "cart√£o clara","clara","limite","ajuda","duvida","d√∫vida"
        ].map(normalize);

        const palavras = msgNorm.split(/\s+/);

        let melhorMatch = null;
        let melhorForca = 0;

        for (const et of etiquetasOficiais) {
            let forcaAtual = 0;

            for (const termoOriginal of et.palavrasChave) {
                const termoNorm = normalize(termoOriginal);
                if (stopTerms.includes(termoNorm)) continue;

                if (palavras.includes(termoNorm)) {
                    forcaAtual += 2;
                }
                if (msgNorm.includes(termoNorm)) {
                    forcaAtual += 1;
                }
            }

            if (forcaAtual > melhorForca) {
                melhorForca = forcaAtual;
                melhorMatch = et;
            }
        }

        if (melhorForca === 0) return null;
        return melhorMatch;
    }

    /* ==================== AVALIAR COMPRA ESPEC√çFICA ==================== */

    function avaliarCompraEspecifica(msgNorm) {
        const proibidosPatrimonio = [
            "geladeira","microondas","micro-ondas","tv","televisao","televis√£o",
            "home theater","mesa","cadeira","friogrifico","freezer",
            "ar condicionado","ar-condicionado","frigobar",
            "carro","veiculo","ve√≠culo","moto",
            "playstation","ps5","xbox","video game","videogame",
            "som ambiente","caixa de som grande","caixa de som","soundbar",
            "projetor","tel√£o","tela gigante","foguete","foguetes","foguetinho"
        ].map(normalize);

        for (const palavra of proibidosPatrimonio) {
            if (msgNorm.includes(palavra)) {
                return {
                    pode: false,
                    resposta: `Isso √© item patrimonial / infraestrutura de loja ou bem de alto valor. Esses itens N√ÉO podem ser comprados com o cart√£o Clara. Eles devem seguir o processo de Compras / aprova√ß√£o formal, n√£o o cart√£o da loja.`
                };
            }
        }

        const pessoalAlim = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal"
        ].map(normalize);

        for (const termo of pessoalAlim) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja. Se j√° foi pago com o cart√£o, precisa sinalizar como "Despesa Pessoal ‚Äì Uso Indevido", avisar o Financeiro e ressarcir em at√© 2 dias √∫teis.`
                };
            }
        }

        const alcool = ["cerveja","vodka","vinho","whisky","whiskey","cacha√ßa","cachaca","gin","tequila"].map(normalize);
        for (const termo of alcool) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Bebida alco√≥lica n√£o √© permitida no cart√£o Clara. Isso n√£o √© considerado despesa operacional autorizada.`
                };
            }
        }

        const transportePessoal = ["uber"," 99","taxi","t√°xi","tax√≠","cabify"].map(normalize);
        for (const termo of transportePessoal) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Uber / 99 / t√°xi para deslocamento pessoal n√£o pode no cart√£o Clara. N√£o √© gasto operacional direto da loja.`
                };
            }
        }

        const palavrasTime = [
            "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
            "lanche time","lanche pro time","lanche para o time",
            "treinamento","premiacao","premia√ß√£o","acao oficial","a√ß√£o oficial",
            "acao vm","a√ß√£o vm","acao regional","a√ß√£o regional",
            "agua pra equipe","√°gua pra equipe","gal√£o de agua","gal√£o de √°gua",
            "salgadinho pra treinamento","bolo pra treinamento",
            "suco pra treinamento","suco para treinamento","lanche treinamento"
        ].map(normalize);

        for (const termo of palavrasTime) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "LANCHES DE REFEI√á√ïES / AGUA POT√ÅVEL",
                        desc: "Coffee break autorizado, √°gua/lanche para equipe em treinamento interno aprovado, a√ß√£o oficial da loja (VM, regional, diretoria) ou premia√ß√£o operacional.",
                        exemploDescricao: "Coffee break treinamento VM loja 1234"
                    },
                    resposta: `Pode usar o cart√£o Clara se for a√ß√£o autorizada (treinamento interno, VM, regional, diretoria, premia√ß√£o operacional). Precisa lan√ßar na Clara em at√© 48h com nota fiscal, etiqueta correta e descri√ß√£o objetiva.`
                };
            }
        }

        const perifOperacional = [
            "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
            "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa",
            "bobina ecf","bobina fiscal"
        ].map(normalize);

        for (const termo of perifOperacional) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "MATERIAL DE INFORM√ÅTICA",
                        desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                        exemploDescricao: "Teclado PDV loja 1234"
                    },
                    resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) √© considerado suprimento operacional de baixo valor para a loja e pode ser pago no cart√£o Clara, desde que classificado corretamente e lan√ßado em at√© 48h.`
                };
            }
        }

        const servicoEmerg = [
            "chaveiro","abrir cofre","abrir estoque","perdi a chave",
            "motoboy","sedex","correios","envio de documento","postar documento",
            "mandar documento","enviar documento"
        ].map(normalize);

        for (const termo of servicoEmerg) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "TRANSPORTE SERVI√áOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                        desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                        exemploDescricao: "Motoboy urgente documenta√ß√£o loja 1234"
                    },
                    resposta: `Servi√ßos emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cart√£o Clara, desde que sejam necessidade imediata da opera√ß√£o e sejam justificados na Clara dentro de 48h.`
                };
            }
        }

        return {
            pode: null,
            resposta: `N√£o ficou claro se isso √© uma despesa operacional imediata da loja ou algo pessoal/patrimonial.`
        };
    }

    /* ==================== RESPOSTAS PADR√ÉO ==================== */

    function respostaForaEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
    }

    function respEtiquetaDireta(et) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nome}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.descricao}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}

<p class="mt-2">
<b>Como lan√ßar na Clara (at√© 48h):</b><br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar "${et.nome}";<br/>
3. Descrever objetivamente o gasto (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar o documento f√≠sico na loja pelo prazo indicado pela pol√≠tica.
</p>
</div>`;
    }

    function respLimite() {
        return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
    }

    function respBloqueio() {
        return `HTML:<p class="text-sm text-slate-700">
O bloqueio preventivo acontece quando tem alguma compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
‚Ä¢ faltou nota fiscal/recibo;<br/>
‚Ä¢ n√£o colocou etiqueta correta;<br/>
‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
Passos pra desbloquear:<br/>
1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolher etiqueta certa, descrever o motivo real).<br/>
2. Encaminhar chamado via ServiceNow para desbloqueio.<br/><br/>
Reincid√™ncia pode fazer a loja perder permiss√£o de uso do cart√£o.
</p>`;
    }

    function respPoliticaOficial() {
        return `HTML:<div class="text-sm text-slate-700">
<p>Seguem as regras oficiais de refer√™ncia da empresa.</p>
<p>
<a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
<strong>Pol√≠tica de Uso dos Cart√µes Clara (documento oficial)</strong>
</a>.
</p>
<p>Use sempre esse documento como fonte final.</p>
</div>`;
    }

    function respCatalogoEtiquetas() {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiquetas oficiais e quando usar:</b></p>

<p class="mt-2"><b>MATERIAL DE INFORM√ÅTICA</b><br/>
Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (baixo valor, sem controle patrimonial).<br/>
Exemplo de descri√ß√£o: "Teclado PDV loja 1234".</p>

<p class="mt-2"><b>MATERIAL DE ESCRIT√ìRIO</b><br/>
Caneta, pasta, bloco de anota√ß√£o, grampeador, etiqueta adesiva, organizador de mesa, papelaria b√°sica da opera√ß√£o administrativa da loja.</p>

<p class="mt-2"><b>AGUA POT√ÅVEL</b><br/>
Gal√£o de √°gua mineral / garrafas de √°gua para abastecimento da equipe ou uso da loja, quando previsto e autorizado operacionalmente.</p>

<p class="mt-2"><b>LANCHES DE REFEI√á√ïES</b><br/>
Coffee break ou lanche para treinamento interno autorizado, a√ß√£o oficial da √°rea (VM, regional, diretoria) ou premia√ß√£o operacional da equipe (n√£o vale refei√ß√£o pessoal).</p>

<p class="mt-2"><b>TRANSPORTE SERVI√áOS EMERGENCIAS</b><br/>
Motoboy emergencial / frete local urgente para levar ou buscar material importante entre lojas ou matriz.</p>

<p class="mt-2"><b>CORREIOS_SEDEX/AR/POSTAGEM</b><br/>
Envio de documentos oficiais da loja via Sedex/AR/postagem. Tamb√©m serve para devolu√ß√µes pequenas quando for processo formal.</p>

<p class="mt-2"><b>CHAVEIRO EMERGENCIAL</b><br/>
Abertura urgente de cofre / estoque / sala administrativa quando houve perda de chave ou travamento, s√≥ em situa√ß√£o emergencial.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO CIVIL</b><br/>
Pequenos reparos estruturais internos de baixa complexidade: ajuste em porta, troca de vidro quebrado, fixar prateleira, ajuste de revestimento etc.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO EL√âTRICA</b><br/>
Troca de tomada, disjuntor, interruptor, soquete, reator, extens√£o, pequenos reparos de baixa tens√£o necess√°rios pro funcionamento da loja.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO AR-CONDICIONADO</b><br/>
Limpeza de filtro, troca de controle remoto, carga de g√°s simples, pequenos ajustes que mantenham o ar funcionando.</p>

<p class="mt-2"><b>BOBINA ECF</b><br/>
Bobina fiscal / bobina de impressora obrigat√≥ria pro PDV, quando n√£o h√° fornecimento centralizado.</p>

<p class="mt-2"><b>SERVI√áOS GR√ÅFICOS E DE COPIADORAS</b><br/>
Impress√£o de banner, adesivo de campanha, plotagem promocional, encaderna√ß√£o de material de comunica√ß√£o da loja.</p>

<p class="mt-2"><b>MARKETING / PUBLICIDADE E PROPAGANDA</b><br/>
A√ß√£o promocional local autorizada, compra de brindes para campanha, m√≠dia local aprovada, banner promocional, impulsionamento oficial autorizado.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO EQUIPAMENTOS</b><br/>
Ajustes/reparos em m√°quinas de estampar, impressoras de etiqueta, computadores fora de garantia e de baixo valor etc. (nada de compra de equipamento grande).</p>

<p class="mt-4">Se voc√™ n√£o encontrou nada que encaixa no seu caso, abra chamado no 
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer"><strong>ServiceNow</strong></a>
pedindo cria√ß√£o ou libera√ß√£o de etiqueta.</p>
</div>`;
    }

    function respPrestacaoContas() {
        return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 180 dias corridos. N√£o justificar no prazo =&gt; risco de bloqueio preventivo.
</p>`;
    }

    function respAlimentoTime() {
        return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respTransportePessoal() {
        return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja. O procedimento correto √© solicitar via aplicativo com a conta corporativa da empresa.<br/><br/>
Se j√° usou de forma pessoal (pagando do pr√≥prio bolso) e quer o reembolso:<br/>
‚Ä¢ Solicite o reembolso atrav√©s da plataforma Vexpenses (√© necess√°rio autoriza√ß√£o do seu gestor).<br/>
</p>`;
    }

    function respTrocaGerente() {
        return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja segue assim:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja;<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234";<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado;<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Se tiver caso especial, fale com o Financeiro e, se preciso, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow.
</a>.
</p>`;
    }

    function respSangria() {
        return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© DESCONTINUADO.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
    }

    function respFraudeContestacao() {
        return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente;<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o;<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal, a√≠ precisa ressarcir em at√© 2 dias √∫teis; n√£o √© contesta√ß√£o.
</p>`;
    }

    function respNovoCartaoPrimeiraVia() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Primeira via de cart√£o Clara (novo cart√£o)</b></p>
<p class="mt-1">
Para solicitar a <b>primeira via</b> do cart√£o Clara, siga estes passos:
</p>
<ol class="list-decimal ml-5 mt-1">
  <li>Preencha o formul√°rio:<br/>
    <a href="https://docs.google.com/forms/d/1vGAsFHuDQ6y5ydJMuE7W9ThJFjsLma_1I6yw92OLHh4/viewform"
       target="_blank" rel="noopener noreferrer"><b>Formul√°rio de Solicita√ß√£o de Cart√£o Clara</b></a>.
  </li>
  <li class="mt-1">
    Depois de preencher o formul√°rio, envie um e-mail para o Financeiro informando que j√° preencheu,<br/>
    para que o cart√£o seja emitido:<br/>
    <b>contasareceber@gruposbf.com.br</b>
  </li>
</ol>
<p class="mt-2">
O prazo de entrega do cart√£o √© de at√© <b>7 dias √∫teis</b>, conforme a pol√≠tica interna.
</p>
</div>`;
}

function respNovoCartaoSegundaVia() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Segunda via de cart√£o Clara (cart√£o j√° existia)</b></p>
<p class="mt-1">
A solicita√ß√£o de <b>segunda via</b> (perda, roubo, dano ou troca de portador) deve seguir o fluxo previsto na Pol√≠tica de Uso dos Cart√µes Clara:
</p>
<ul class="list-disc ml-5 mt-1">
  <li>Bloquear imediatamente o cart√£o antigo na plataforma / app da Clara (se aplic√°vel);</li>
  <li>Registrar o motivo (perda, roubo, quebra, etc.) conforme orienta√ß√µes internas;</li>
  <li>Abrir chamado no 
    <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6"
       target="_blank" rel="noopener noreferrer"><b>ServiceNow</b></a>
    solicitando a emiss√£o de segunda via do cart√£o Clara.
  </li>
</ul>
<p class="mt-2">
Sempre siga as orienta√ß√µes detalhadas na <b>Pol√≠tica de Uso dos Cart√µes Clara</b> para casos de reemiss√£o/segunda via.
</p>
</div>`;
}

    function respGenerica(msgNorm) {
        const avaliacao = avaliarCompraEspecifica(msgNorm);

        if (avaliacao.pode === false) {
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
        }

        if (avaliacao.pode === true && avaliacao.etiquetaValida) {
            const et = avaliacao.etiquetaValida;
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
<p class="mt-2"><b>Como lan√ßar na Clara (at√© 48h):</b><br/>
‚Ä¢ Anexar a nota fiscal/recibo;<br/>
‚Ä¢ Selecionar "${et.nome}";<br/>
‚Ä¢ Descrever objetivamente o gasto (ex.: "${et.exemploDescricao}");<br/>
‚Ä¢ Guardar o documento f√≠sico na loja pelo prazo indicado pela pol√≠tica.</p>
</div>`;
        }

        return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cart√£o Clara, o gasto precisa ser <b>necess√°rio pra opera√ß√£o da loja</b> (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal, √°gua/coffee break autorizado pra treinamento interno ou a√ß√£o oficial).</p>
<p class="mt-2">O que <b>n√£o pode</b> no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (refei√ß√£o pessoal, compra pra uso pr√≥prio etc.);<br/>
‚Ä¢ bebida alco√≥lica;<br/>
‚Ä¢ transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira etc.).</p>
<p class="mt-2">Se voc√™ acha que √© uma necessidade real da loja, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer"><strong>ServiceNow</strong></a> informando o caso.</p>
</div>`;
    }

    /* ==================== CONSULTA PEND√äNCIAS (Apps Script) ==================== */

    function consultarPendenciasNoServidor(loja) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (!res || !res.ok) {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
N√£o consegui consultar as pend√™ncias da loja <b>${loja}</b>.<br/>
Detalhe: ${erro}
</p>`
                    );
                    aguardandoConfirmacaoEnvioEmail = false;
                    aguardandoEmailPendencias = false;
                    lojaPendenciasAtual = "";
                    return;
                }

                if (!res.rows || res.rows.length === 0) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    N√£o encontrei pend√™ncias para a loja <b>${loja}</b> na √∫ltima data de cobran√ßa. Verifique se o n√∫mero da loja est√° correto.
</p>`
                    );
                    aguardandoConfirmacaoEnvioEmail = false;
                    aguardandoEmailPendencias = false;
                    lojaPendenciasAtual = "";
                    return;
                }

                ultimaPendenciaResumo = { loja: res.loja, data: res.ultimaData };

                let tabela = `
              <div class="text-sm text-slate-700">
              <p>Encontrei as seguintes pend√™ncias Clara da loja <b>${res.loja}</b> (data de cobran√ßa <b>${res.ultimaData}</b>). Caso a pendencia j√° tenha sido regularizada e o seu cart√£o ainda estiver bloqueado, solicite o desbloqueio atrav√©s de abertura de chamado no ServiceNow, caminho: <b>Contas a Receber > Cart√£o Clara > Solicita√ß√£o de Desbloqueio</b>.</p>
              <div class="mt-2 overflow-x-auto">
              <table class="min-w-full text-xs border border-slate-200">
              <thead class="bg-slate-100">
              <tr>
              `;
                const header = res.header || [];
                header.forEach(h => {
                    tabela += `<th class="border px-2 py-1">${h}</th>`;
                });
                tabela += `</tr></thead><tbody>`;

                res.rows.forEach(linha => {
                    tabela += `<tr>`;
                    linha.forEach(col => {
                        tabela += `<td class="border px-2 py-1">${col !== null && col !== undefined ? col : ""}</td>`;
                    });
                    tabela += `</tr>`;
                });

                tabela += `</tbody></table></div></div>`;

                renderBotMessage("HTML:" + tabela);

                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700 mt-2">Quer que eu envie esse resumo por e-mail tamb√©m? (responda "sim" ou "n√£o")</p>'
                );

                aguardandoConfirmacaoEnvioEmail = true;
            })
            .withFailureHandler(function(err) {
                console.error("Erro getPendenciasPorLoja:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pend√™ncias dessa loja. Tente novamente mais tarde.</p>'
                );
                aguardandoConfirmacaoEnvioEmail = false;
                aguardandoEmailPendencias = false;
                lojaPendenciasAtual = "";
            })
            .getPendenciasPorLoja(loja);
    }

    function chamarEnvioPendenciasPorEmail(loja, email) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
Enviei o resumo das pend√™ncias da loja <b>${res.loja || loja}</b> para o e-mail <b>${email}</b> (data de cobran√ßa: <b>${res.data || (ultimaPendenciaResumo && ultimaPendenciaResumo.data) || ""}</b>). N√£o se esque√ßa de regularizar as justificativas na plataforma da Clara e posteriormente encaminhar chamado para que o cart√£o seja desbloqueado (caso esteja bloqueado).</p>`
                    );
                } else {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
Tentei enviar o e-mail de pend√™ncias, mas deu problema: ${erro}.</p>`
                    );
                }
            })
            .withFailureHandler(function(err) {
                console.error("Erro enviarPendenciasPorEmail:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail de pend√™ncias. Tente novamente mais tarde.</p>'
                );
            })
            .enviarPendenciasPorEmail(loja, email);
    }

    /* ==================== MOTOR DE RESPOSTA DA POL√çTICA ==================== */

    function gerarRespostaPolitica(msgUsuario) {
        const norm = normalize(msgUsuario);
        const intencao = detectarIntencaoPergunta(norm);
        let resposta;

        // Gasto pessoal alimenta√ß√£o muito expl√≠cito
        const padroesGastoPessoalAlimentacao = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","meu lanche com o cartao","meu lanche com o cart√£o",
            "minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));

        if (isGastoPessoalAlimentacao) {
            ultimaIntencao = "gasto_pessoal_alimentacao";
            return `HTML:<div class="text-sm text-slate-700">
<p>‚õî Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.</p>
<p class="mt-2">Se j√° foi pago com o cart√£o:</p>
<ul class="list-disc ml-4">
<li>Avise o Financeiro e abra chamado no ServiceNow (Contas a Receber &gt; Cart√£o Clara &gt; Gasto Indevido - pessoal);</li>
<li>Classifique na Clara como "Despesa Pessoal ‚Äì Uso Indevido";</li>
<li>Ressar√ßa o valor √† empresa em at√© 2 dias √∫teis.</li>
</ul>
<p class="mt-2">Se n√£o regularizar, o cart√£o pode ficar bloqueado preventivamente.</p>
</div>`;
        }

            // üéØ Gatilho: usu√°rio falando em solicitar cart√£o Clara (novo cart√£o)
    const gatilhosNovoCartao = [
        // formas diretas
        "quero solicitar um cartao",
        "quero solicitar um cart√£o",
        "novo cartao",
        "novo cart√£o",
        "cartao novo",
        "cart√£o novo",
        "quero solicitar cartao clara",
        "quero solicitar cart√£o clara",
        "quero pedir um cartao",
        "quero pedir um cart√£o",
        "quero pedir cartao clara",
        "quero pedir cart√£o clara",
        "quero cartao clara",
        "quero cart√£o clara",
        "preciso de um cartao",
        "preciso de um cart√£o",
        "preciso de cartao clara",
        "preciso de cart√£o clara",
        "nao tenho cartao clara ainda",
        "n√£o tenho cartao clara ainda",
        "nao tenho cart√£o clara ainda",
        "ainda nao tenho cartao clara",
        "ainda n√£o tenho cart√£o clara",
        "como pedir cartao",
        "como pedir cart√£o",
        "como pe√ßo cartao",
        "como peco cartao",
        "como pe√ßo cart√£o",
        "como solicitar cartao",
        "como solicitar cart√£o",
        "como conseguir um cartao clara",
        "como conseguir um cart√£o clara",
        "quero receber um cartao clara",
        "quero receber um cart√£o clara",

        // promo√ß√£o / novo gerente
        "fui promovido e nao tenho cartao",
        "fui promovido e n√£o tenho cartao",
        "fui promovido e nao tenho cart√£o clara",
        "fui promovido e n√£o tenho cart√£o clara",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e n√£o tenho cartao",
        "sou novo gerente e nao tenho cart√£o clara",
        "sou novo gerente e n√£o tenho cart√£o clara",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e n√£o tenho cart√£o clara",

        // abrevia√ß√µes / erros
        "quero cartao",
        "quero um cartao",
        "quero um cart√£o",
        "pedir cartao",
        "pedir cart√£o",
        "solicitar cartao",
        "solicitar cart√£o",
        "primeira via do cartao",
        "primeira via do cart√£o",
        "1a via do cartao",
        "1¬™ via do cartao",
        "1a via do cart√£o",
        "1¬™ via do cart√£o",
        "quero solicitar um cartao",
        "quero solicitar um cart√£o",
        "quero solicitar cartao clara",
        "quero solicitar cart√£o clara",
        "quero pedir um cartao",
        "quero pedir um cart√£o",
        "preciso solicitar um cartao",
        "preciso solicitar um cart√£o",
        "preciso pedir um cartao",
        "preciso pedir um cart√£o",
        "gostaria de solicitar um cartao",
        "gostaria de solicitar um cart√£o",
        "como solicitar um cartao",
        "como solicitar um cart√£o",
        "como pedir um cartao",
        "como pedir um cart√£o",
        "como faco pra solicitar cartao",
        "como fa√ßo pra solicitar cart√£o",
        "como pedir o cartao clara",
        "como pedir o cart√£o clara",
        "quero o cartao clara",
        "quero o cart√£o clara",

        // üü° Varia√ß√µes informais e curtas
        "cartao novo",
        "cart√£o novo",
        "novo cartao",
        "meu cartao novo",
        "meu cart√£o novo",
        "preciso de cartao novo",
        "preciso de cart√£o novo",
        "vou receber cartao novo",
        "vou receber cart√£o novo",
        "pedi cartao novo",
        "pedi cart√£o novo",
        "cartao da loja nova",
        "cart√£o da loja nova",
        "novo cartao da loja",
        "novo cart√£o da loja",
        "cartao pra loja nova",
        "cart√£o pra loja nova",
        "cartao nova loja",
        "cart√£o nova loja",
        "solicitar novo cartao",
        "solicitar novo cart√£o",
        "solicitar cartao novo",
        "solicitar cart√£o novo",
        "pedir novo cartao",
        "pedir novo cart√£o",
        "preciso do meu cartao",
        "preciso do meu cart√£o",
        "preciso do cartao clara",
        "preciso do cart√£o clara",
        "quero cartao clara",
        "quero cart√£o clara",
        "preciso cartao clara",
        "preciso cart√£o clara",

        // üü† Com erros ou abrevia√ß√µes comuns
        "cartao clara novo",
        "cartao clara nova loja",
        "cartao cllara",
        "cartao clra",
        "cartao carla",
        "novo cartao cllara",
        "novo cartao clra",
        "novo cartao carla",
        "solicitar cartao cllara",
        "solicitar cartao clra",
        "solicitar cartao carla",
        "pedir cartao cllara",
        "pedir cartao clra",
        "pedir cartao carla",
        "preciso cartao cllara",
        "preciso cartao clra",
        "preciso cartao carla",

        // üîµ Men√ß√µes gen√©ricas sobre precisar do cart√£o
        "preciso de um cartao",
        "preciso de um cart√£o",
        "preciso do cartao",
        "preciso do cart√£o",
        "ainda nao tenho cartao",
        "ainda n√£o tenho cart√£o",
        "nao tenho cartao",
        "n√£o tenho cart√£o",
        "nunca tive cartao",
        "nunca tive cart√£o",
        "sem cartao clara",
        "sem cart√£o clara",
        "estou sem cartao clara",
        "estou sem cart√£o clara",
        "perdi o acesso ao cartao",
        "perdi o acesso ao cart√£o",
        "nao recebi cartao clara",
        "n√£o recebi cart√£o clara",
        "nao recebi meu cartao",
        "n√£o recebi meu cart√£o",
        "nao tenho cartao ainda",
        "n√£o tenho cart√£o ainda",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e n√£o tenho cart√£o",
        "fui promovido e nao tenho cartao",
        "fui promovido e n√£o tenho cart√£o",
        "mudei de loja e nao tenho cartao",
        "mudei de loja e n√£o tenho cart√£o",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e n√£o tenho cart√£o",
        "sou novo na loja e nao tenho cartao",
        "sou novo na loja e n√£o tenho cart√£o",

        // üü£ Fala direta sobre ‚Äúquero novo cart√£o‚Äù
        "quero novo cartao",
        "quero novo cart√£o",
        "preciso novo cartao",
        "preciso novo cart√£o",
        "solicitar novo cartao clara",
        "solicitar novo cart√£o clara",
        "como solicitar novo cartao",
        "como solicitar novo cart√£o",
        "como pedir novo cartao clara",
        "como pedir novo cart√£o clara",
        "preciso pedir novo cartao clara",
        "preciso pedir novo cart√£o clara"
    ].map(normalize);

    //  üü¢ Novo cart√£o ‚Äì iniciar fluxo
      
      for (const frase of gatilhosNovoCartao) {
          if (norm.includes(frase)) {
              fluxoNovoCartao = "aguardando_tipo_via";
              return `HTML:<p class="text-sm text-slate-700">
      S√≥ pra eu te orientar certinho: voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido)?<br/><br/>
      Responda por favor:<br/>
      ‚Ä¢ "√â primeira via"<br/>
      ‚Ä¢ ou "√â segunda via"
      </p>`;
          }
      }

        switch (intencao) {
            case "foraEscopo":
                ultimaIntencao = "foraEscopo";
                resposta = respostaForaEscopo();
                break;

            case "etiqueta": {
                ultimaIntencao = "etiqueta";
                const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));
                const et = acharEtiquetaPorMensagem(norm);

                if (!et && isPerguntaGeral) {
                    resposta = respCatalogoEtiquetas();
                } else if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
          N√£o consegui identificar uma etiqueta espec√≠fica s√≥ com esse texto.<br/>
          Se o gasto for operacional e n√£o existir etiqueta adequada na lista da Clara, abra chamado no
          <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
          <strong>ServiceNow</strong>
          </a>
          solicitando cria√ß√£o ou ajuste de etiqueta.
          </p>`;
                }
                break;
            }

            case "limite":
                ultimaIntencao = "limite";
                resposta = respLimite();
                break;

            case "bloqueio":
                ultimaIntencao = "bloqueio";
                resposta = respBloqueio();
                break;

            case "prestacao":
                ultimaIntencao = "prestacao";
                resposta = respPrestacaoContas();
                break;

            case "alimentoTime":
                ultimaIntencao = "alimentoTime";
                resposta = respAlimentoTime();
                break;

            case "transportePessoal":
                ultimaIntencao = "transportePessoal";
                resposta = respTransportePessoal();
                break;

            case "trocaGerente":
                ultimaIntencao = "trocaGerente";
                resposta = respTrocaGerente();
                break;

            case "sangria":
                ultimaIntencao = "sangria";
                resposta = respSangria();
                break;

            case "fraudeContestacao":
                ultimaIntencao = "fraudeContestacao";
                resposta = respFraudeContestacao();
                break;

            case "podeNaoPode":
            case "generica":
            default:
                ultimaIntencao = "generica";
                resposta = respGenerica(norm);
                break;
        }

        return resposta;
    }

    /* ==================== WRAPPER: GERADOR FINAL DE RESPOSTA ==================== */

    function gerarRespostaDoBot(msgUsuario) {
        const norm = normalize(msgUsuario);

            // üéØ DETECTA SAUDA√á√ïES INICIAIS
    const saudacoes = [
        "oi", "ol√°", "ola", "opa", "eai", "e a√≠", "iae", "iae vektor", "oi vektor", "OI", "Oi", "oI",
        "bom dia", "boa tarde", "boa noite", "Bom dia!", "Boa tarde!", "Boa noite!",
        "salve", "fala", "fala vektor", "fala ai", "fala a√™", "e a√≠ vektor", "opa vektor",
        "tudo bem?", "Tudo bem?", "td bem", "tdb", "como vai", "como vc t√°", "como voce ta",
        "beleza", "tranquilo", "tudo certo", "como est√°", "como t√°", "como vai vektor"
    ].map(normalize);

    for (const saud of saudacoes) {
        if (norm === saud || norm.startsWith(saud + " ") || norm.includes(" " + saud + " ")) {
            const respostasSaudacao = [
                "Ol√°! üòÑ",
                "Oi! üëã",
                "Opa, tudo bem por a√≠? üòé",
                "Fala a√≠! üëã",
                "E a√≠, tudo certo? üôå",
                "Oi! Que bom te ver por aqui üòÅ",
                "Bom te ver por aqui! üëã"
            ];
            const complementosAjuda = [
                "Como posso te ajudar hoje?",
                "Quer saber algo sobre o cart√£o Clara?",
                "O que voc√™ quer saber?",
                "Posso te explicar algo sobre o uso dos cart√µes?",
                "Quer que eu te ajude com alguma d√∫vida?",
                "Como posso te orientar?",
                "Qual a sua d√∫vida?"
            ];

            const r1 = respostasSaudacao[Math.floor(Math.random() * respostasSaudacao.length)];
            const r2 = complementosAjuda[Math.floor(Math.random() * complementosAjuda.length)];

            return `HTML:<p class="text-sm text-slate-700">${r1} ${r2}</p>`;
        }
    }

        // üß© Fluxo em andamento: usu√°rio j√° falou que quer cart√£o e agora
    // estamos perguntando se √© 1¬™ via ou 2¬™ via
    if (fluxoNovoCartao === "aguardando_tipo_via") {
        const ehPrimeira = (
            norm.includes("primeira via") ||
            norm.includes("como pedir novo cart√£o") ||
            norm.includes("como pedir novo cartao") ||
            norm.includes("Quero solicitar um novo cart√£o") ||
            norm.includes("Quero solicitar um novo cartao") ||
            norm.includes("novo cart√£o") ||
            norm.includes("novo cartao") ||
            norm.includes("1 via") ||
            norm.includes("1a via") ||
            norm.includes("1¬™ via") ||
            norm.includes("primeiro cartao") ||
            norm.includes("primeiro cart√£o") ||
            norm.includes("cartao novo") ||
            norm.includes("cart√£o novo") ||
            norm.includes("nunca tive cartao") ||
            norm.includes("nunca tive cart√£o") ||
            norm.includes("ainda nao tenho cartao") ||
            norm.includes("ainda n√£o tenho cart√£o") ||
            norm.includes("meu primeiro cartao") ||
            norm.includes("n√£o tenho cart√£o") ||
            norm.includes("nao tenho cartao") ||
            norm.includes("meu primeiro cart√£o")
        );

        const ehSegunda = (
            norm.includes("segunda via") ||
            norm.includes("2 via") ||
            norm.includes("2a via") ||
            norm.includes("2¬™ via") ||
            norm.includes("segunda copia") ||
            norm.includes("segunda c√≥pia") ||
            norm.includes("segundo cartao") ||
            norm.includes("segundo cart√£o") ||
            norm.includes("perdi o cartao") ||
            norm.includes("perdi o cart√£o") ||
            norm.includes("roubaram meu cartao") ||
            norm.includes("roubaram meu cart√£o") ||
            norm.includes("roubo de cart√£o") ||
            norm.includes("fui roubado") ||
            norm.includes("perda de cart√£o") ||
            norm.includes("perca de cart√£o") ||
            norm.includes("cartao quebrado") ||
            norm.includes("cart√£o quebrado") ||
            norm.includes("cartao danificado") ||
            norm.includes("cart√£o danificado")
        );

        if (ehPrimeira) {
            fluxoNovoCartao = null;
            ultimaIntencao = "novoCartao_primeira";
            return respNovoCartaoPrimeiraVia();
        }

        if (ehSegunda) {
            fluxoNovoCartao = null;
            ultimaIntencao = "novoCartao_segunda";
            return respNovoCartaoSegundaVia();
        }

        // n√£o consegui entender se √© 1¬™ ou 2¬™
        return `HTML:<p class="text-sm text-slate-700">
N√£o entendi se voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido).<br/><br/>
Me responde assim, por favor:<br/>
‚Ä¢ "√â primeira via"<br/>
‚Ä¢ ou "√â segunda via".
</p>`;
    }

        // 1) fim de conversa
        const frasesEncerramento = [
            "ok","okay","okey","certo","blz","beleza","ok valeu",
            "entendi","entendido","tudo certo","td certo","tds certo",
            "t√° bom","ta bom","t√° √≥timo","ta otimo","t√° otimo",
            "show","show de bola","valeu","vlw","obrigado","obrigada",
            "agradecido","agradecida","tranquilo","de boa","suave",
            "pode deixar","certinho","maravilha","perfeito","j√≥ia","joia"
        ].map(normalize);

        for (const frase of frasesEncerramento) {
            if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
                const respostasEncerramento = [
                    "Que bom que consegui ajudar! ü§ó Pode me chamar sempre que precisar.",
                    "Show! Fico feliz em ajudar üòÑ",
                    "Perfeito üëå qualquer d√∫vida, √© s√≥ chamar de novo!",
                    "Valeu! At√© a pr√≥xima üöÄ",
                    "Beleza üòé t√¥ por aqui se precisar de novo."
                ];
                const r = respostasEncerramento[Math.floor(Math.random() * respostasEncerramento.length)];
                return `HTML:<p class="text-sm text-slate-700">${r}</p>`;
            }
        }

        // 2) pol√≠tica PDF / documento oficial
        const frasesPolitica = [
            "me envia a politica","me envia a pol√≠tica","me manda a politica","me manda a pol√≠tica",
            "pol√≠tica de uso","politica de uso do cartao","pol√≠tica de uso do cart√£o",
            "politica do cartao","pol√≠tica do cart√£o","politica do cartao clara","pol√≠tica do cart√£o clara",
            "pdf da politica","pdf da pol√≠tica","manual da politica","manual da pol√≠tica",
            "politica clara","pol√≠tica clara","politica de uso dos cartoes","pol√≠tica de uso dos cart√µes"
        ].map(normalize);

        if (frasesPolitica.some(f => norm.includes(f))) {
            return respPoliticaOficial();
        }

            // üîπ Atalho: usu√°rio j√° come√ßa falando "primeira via" / "1¬™ via" etc
    const termosPrimeiraViaDireta = [
        "primeira via",
        "1 via",
        "1a via",
        "1¬™ via",
        "primeiro cartao",
        "primeiro cart√£o",
        "meu primeiro cartao",
        "meu primeiro cart√£o",
        "nunca tive cartao clara",
        "nunca tive cart√£o clara",
        "quero minha primeira via",
        "quero 1 via",
        "pedir primeira via",
        "solicitar primeira via"
    ].map(normalize);

    if (termosPrimeiraViaDireta.some(t => norm.includes(t))) {
        // garante que n√£o fique preso em fluxo antigo
        fluxoNovoCartao = null;

        return `HTML:<div class="text-sm text-slate-700">
<p><b>Primeira via de cart√£o Clara (novo cart√£o)</b></p>
<p class="mt-1">
Para solicitar uma primeira via de cart√£o voc√™ deve preencher este formul√°rio:
<a class="service-link"
   href="https://docs.google.com/forms/d/1vGAsFHuDQ6y5ydJMuE7W9ThJFjsLma_1I6yw92OLHh4/viewform"
   target="_blank" rel="noopener noreferrer"><b>Formul√°rio de solicita√ß√£o de cart√£o</b></a>.
</p>
<p class="mt-1">
Depois, envie um e-mail para <b>contasareceber@gruposbf.com.br</b> informando que o formul√°rio foi preenchido, para que o Financeiro providencie a emiss√£o do cart√£o.
</p>
<p class="mt-1">
O prazo de entrega do cart√£o √© de at√© <b>7 dias √∫teis</b>.
</p>
</div>`;
    }

        // 3) fluxo de pend√™ncias ‚Äì pergunta inicial
        const termosPendencias = [
            "pendencia clara","pend√™ncias clara","pendencias clara",
            "bloqueio por pendencia","bloqueio por pend√™ncia",
            "pendencia do cartao","pend√™ncia do cart√£o",
            "loja bloqueada clara","cart√£o bloqueado por pendencia",
            "cobran√ßa clara","transa√ß√µes pendentes clara", "pendencia", "pend√™ncia", "pendencias", "pend√™ncias",
            "email de pendencia clara","pendencias","pend√™ncias"
        ].map(normalize);

        if (!aguardandoLojaPendencias &&
            !aguardandoConfirmacaoEnvioEmail &&
            !aguardandoEmailPendencias &&
            termosPendencias.some(t => norm.includes(t))) {

            aguardandoLojaPendencias = true;
            aguardandoConfirmacaoEnvioEmail = false;
            aguardandoEmailPendencias = false;
            lojaPendenciasAtual = "";
            ultimaPendenciaResumo = null;

            return `HTML:<p class="text-sm text-slate-700">
Consigo consultar as pend√™ncias Clara da sua loja.<br/>
Me informe o c√≥digo da loja (somente n√∫meros), por exemplo: <b>0123</b>.
</p>`;
        }

        // 3.1) aguardando c√≥digo da loja
        if (aguardandoLojaPendencias) {
            const loja = norm.replace(/\D/g, "");
            if (!loja) {
                return 'HTML:<p class="text-sm text-slate-700">N√£o entendi o c√≥digo da loja. Me envie s√≥ os n√∫meros, ex.: <b>0171</b>.</p>';
            }

            lojaPendenciasAtual = loja;
            aguardandoLojaPendencias = false;

            consultarPendenciasNoServidor(loja);

            return `HTML:<p class="text-sm text-slate-700">
Beleza! Vou consultar as pend√™ncias Clara da loja <b>${loja}</b> e j√° te mostro aqui no chat.</p>`;
        }

        // 3.2) j√° mostrou tabela, aguardando "sim"/"n√£o" para envio de e-mail
        if (aguardandoConfirmacaoEnvioEmail) {
            const sim = ["sim","s","ss","claro","pode","manda","mande","envia","envie"].map(normalize);
            const nao = ["nao","n√£o","n","nem","agora nao","agora n√£o","depois"].map(normalize);

            if (sim.some(s => norm.startsWith(s))) {
                aguardandoConfirmacaoEnvioEmail = false;
                aguardandoEmailPendencias = true;
                return 'HTML:<p class="text-sm text-slate-700">Fechado! Me informa o seu e-mail corporativo pra eu enviar o resumo das pend√™ncias.</p>';
            }

            if (nao.some(n => norm.startsWith(n))) {
                aguardandoConfirmacaoEnvioEmail = false;
                aguardandoEmailPendencias = false;
                return 'HTML:<p class="text-sm text-slate-700">Tranquilo! Qualquer coisa √© s√≥ pedir de novo que eu consulto as pend√™ncias aqui no chat. üòâ</p>';
            }

            // se o usu√°rio escrever outra coisa, cai na resposta normal da pol√≠tica
        }

        // 3.3) aguardando e-mail
        if (aguardandoEmailPendencias) {
            const email = msgUsuario.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return 'HTML:<p class="text-sm text-slate-700">Esse e-mail parece inv√°lido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.</p>';
            }

            aguardandoEmailPendencias = false;

            chamarEnvioPendenciasPorEmail(lojaPendenciasAtual, email);

            return `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${lojaPendenciasAtual}</b> para o e-mail <b>${email}</b>.</p>`;
        }

        // 4) Se nada de fluxo especial, cai na l√≥gica normal da pol√≠tica
        return gerarRespostaPolitica(msgUsuario);
    }

    /* ==================== ENVIO DE MENSAGEM (ENTER / BOT√ÉO) ==================== */
function enviarMensagem() {
  const texto = userInput.value.trim();
  if (!texto) return;

  renderUserMessage(texto);

  const resposta = gerarRespostaDoBot(texto);
  if (resposta) renderBotMessage(resposta);

  userInput.value = "";
  userInput.focus();
  scrollToBottom();
}

// Envio com Enter (sem Shift)
userInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    enviarMensagem();
  }
});

// Envio com clique no bot√£o
sendBtn.addEventListener("click", (e) => {
  e.preventDefault();
  enviarMensagem();
});

// Envio via submit do formul√°rio (garantia extra)
chatForm.addEventListener("submit", (e) => {
  e.preventDefault();
  enviarMensagem();
});


}); // fim DOMContentLoaded
</script>
</body>
</html>
