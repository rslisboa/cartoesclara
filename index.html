<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistente Clara | Uso do Cart√£o na Loja</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet"
    />

    <style>
        :root {
            --brand-main: #005E27; /* verde escuro */
            --brand-highlight: #B5FF20; /* verde claro do header */
        }

        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: #f8fafc;
        }

        /* bolhas */
        .user-bubble {
            background-color: var(--brand-main);
            color: #fff;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.25);
        }
        .bot-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1); /* slate-200 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
        }

        /* avatar Clara (nas mensagens) */
        .bot-avatar {
            background-color: var(--brand-main);
            color: #fff;
        }

        /* bot√£o enviar */
        .send-button {
            background-color: var(--brand-main);
        }
        .send-button:hover {
            filter: brightness(1.1);
        }

        /* focus do input */
        .user-input:focus {
            --tw-ring-color: var(--brand-main);
            outline: 2px solid var(--brand-main);
            border-color: var(--brand-main);
        }

        /* "digitando..." */
        .typing-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
            font-size: 13px;
            color: #475569;
        }
        .dot {
            width: 6px;
            height: 6px;
            background-color: #475569;
            border-radius: 9999px;
            display: inline-block;
            animation: bounce 1.2s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.15s; }
        .dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-4px); opacity: 1; }
        }

        /* scrollbar da janela de chat */
        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }
        #chatWindow::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 9999px;
        }
        #chatWindow::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 9999px;
        }

        /* links clic√°veis nas respostas */
        .bot-link {
            color: var(--brand-main);
            font-weight: 600;
            text-decoration: underline;
            word-break: break-word;
        }
    </style>
</head>
<body class="text-slate-800 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col min-h-[600px] max-h-[90vh]">

        <!-- HEADER DESTACADO (fundo verde claro + robo mascote) -->
        <header class="px-5 py-6 border-b border-slate-200 relative" style="background-color: var(--brand-highlight);">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="leading-tight text-slate-900 pr-24 md:pr-0">
                    <p class="font-extrabold text-slate-900 text-base md:text-lg uppercase tracking-tight">
                        Assistente Clara | Grupo SBF
                    </p>
                    <p class="text-[13px] text-slate-800 mt-2 font-medium">
                        Pergunte sobre o uso do cart√£o Clara nas lojas.
                    </p>
                    <p class="text-[12px] text-slate-800 mt-1">
                        üí¨ Exemplos:
                        ‚ÄúPosso comprar micro-ondas?‚Äù ‚Ä¢
                        ‚ÄúUber pode?‚Äù ‚Ä¢
                        ‚ÄúTravou o cart√£o, fa√ßo o qu√™?‚Äù
                    </p>
                    <p class="text-[11px] text-slate-700 italic mt-3 font-medium">
                        ‚ö† Minhas respostas seguem a Pol√≠tica de Uso dos Cart√µes Clara.
                        Em conflito, vale sempre o documento oficial da empresa.
                    </p>
                </div>

                <!-- avatar rob√¥ -->
                <div class="flex-shrink-0 flex justify-center md:justify-end w-full md:w-auto">
                    <img
                        src="Gemini_Generated_Image_e9xsase9xsase9xs.png"
                        alt="Assistente Clara (rob√¥)"
                        class="h-24 object-contain drop-shadow-[0_8px_8px_rgba(0,0,0,0.25)]"
                        style="max-width:96px;"
                    />
                </div>
            </div>
        </header>

        <!-- Janela de chat -->
        <section id="chatWindow" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 text-[15px] leading-relaxed bg-slate-50/40 min-h-[360px]">
            <!-- Mensagem inicial da Clara -->
            <div class="flex items-start gap-3">
                <div class="w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0">
                    C
                </div>
                <div class="bot-bubble px-4 py-3 max-w-[80%]">
                    <p class="font-semibold text-slate-800">
                        Ol√°! üëã Eu sou a Clara.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pergunte se um gasto pode no cart√£o, como justificar, prazos, bloqueio,
                        etiquetas, aumento de limite, emerg√™ncia, etc.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-3">
                    </p>
                </div>
            </div>
        </section>

        <!-- Input -->
        <section class="border-t border-slate-200 bg-white rounded-b-2xl px-4 py-4 flex flex-col gap-3">
            <form id="chatForm" class="flex w-full gap-3">
                <input
                    id="userInput"
                    type="text"
                    class="user-input flex-1 text-[15px] border border-slate-300 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-[var(--brand-main)] focus:border-[var(--brand-main)]"
                    placeholder="Escreva sua d√∫vida"
                    autocomplete="off"
                />
                <button
                    class="send-button text-white font-semibold text-sm rounded-xl px-4 py-3 shadow-md transition"
                    type="submit"
                >
                    Enviar
                </button>
            </form>

            <div class="text-[11px] text-slate-500 text-center leading-snug">
            </div>
        </section>
    </main>

 <script>
    // -----------------------
    // CONFIG
    // -----------------------
    const SERVICE_NOW_URL = "https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6";
    const POLITICA_PDF_URL = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";

    // mem√≥ria de contexto pra follow-up
    let ultimaIntencao = null;

    // -----------------------
    // ETIQUETAS / CATEGORIAS
    // -----------------------
    // Agora cada categoria tamb√©m carrega "podeUsarCartao": true/false
    // true = permitido como despesa operacional da loja
    // false = indicaria bloqueio (mas esses casos j√° caem em outras inten√ß√µes tipo geladeira/PS5/bebida alco√≥lica)
    const tabelaEtiquetas = [
        {
            nomeEtiqueta: "MARKETING_PUBLICIDADE E PROPAGANDA",
            gastosAtrelados: "A√ß√µes promocionais, brindes de campanha, m√≠dia local, impulsionamento de redes sociais, banners promocionais.",
            termosChave: ["marketing","publicidade","propaganda","brinde","brindes","banner","divulga√ß√£o","divulgacao","promo√ß√£o","promocao","m√≠dia local","midia local","impulsionar rede","impulsionar post"],
            podeUsarCartao: true,
            observacaoUso: "Somente para a√ß√µes autorizadas e operacionais da loja (promo, VM, etc.)."
        },
        {
            nomeEtiqueta: "MATERIAL DE LIMPEZA",
            gastosAtrelados: "Detergente, desinfetante, papel toalha, pano de ch√£o, rodo, vassoura, √°lcool, produtos de higiene ambiental.",
            termosChave: ["limpeza","detergente","desinfetante","pano de chao","pano de ch√£o","rodo","vassoura","papel toalha","esponja","alcool","√°lcool","higiene"],
            podeUsarCartao: true,
            observacaoUso: "Materiais de limpeza de uso di√°rio da loja, baixo valor."
        },
        {
            nomeEtiqueta: "MATERIAL DE INFORM√ÅTICA",
            gastosAtrelados: "Mouse, teclado, cabos, pendrive, suporte de notebook, fonte simples, roteador, hub USB, cart√£o de mem√≥ria (sem controle patrimonial).",
            termosChave: ["teclado","mouse","cabo usb","cabo","pendrive","hub usb","roteador","fonte notebook","fonte de notebook","cartao de memoria","cart√£o de mem√≥ria","suporte notebook","teclado pdv","mouse pdv","cabo pdv"],
            podeUsarCartao: true,
            observacaoUso: "Perif√©rico/acess√≥rio de baixo valor para opera√ß√£o da loja / PDV, n√£o √© bem patrimonial grande."
        },
        {
            nomeEtiqueta: "MATERIAL DE ESCRIT√ìRIO",
            gastosAtrelados: "Canetas, cadernos, pastas, blocos, grampeadores, etiquetas, organizadores de mesa, papel etc.",
            termosChave: ["caneta","canetas","caderno","pasta","pastas","bloco","blocos","post-it","postit","grampeador","grampeadores","etiqueta adesiva","organizador de mesa","clips","clip","papel sulfite","sulfite"],
            podeUsarCartao: true,
            observacaoUso: "Materiais administrativos normais da loja."
        },
        {
            nomeEtiqueta: "MATERIAL DE COPA E COZINHA",
            gastosAtrelados: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, esponjas, potes pl√°sticos (sem el√©tricos).",
            termosChave: ["copo descartavel","copo descart√°vel","talher","talheres","prato","pratos","pano de prato","filtro de caf√©","filtro de cafe","garrafa t√©rmica","garrafa termica","pote plastico","pote pl√°stico"],
            podeUsarCartao: true,
            observacaoUso: "Itens simples de apoio interno, n√£o inclui eletrodom√©stico (cafeteira, micro-ondas etc.)."
        },
        {
            nomeEtiqueta: "MANUTEN√á√ÉO CIVIL",
            gastosAtrelados: "Pequenos reparos em parede, troca de revestimento, conserto de porta/prateleira/vidro (exceto chaveiro emergencial).",
            termosChave: ["reparo parede","prateleira","prateleiras","revestimento","troca de vidro","conserto porta","ajuste porta","ajuste prateleira","paredes"],
            podeUsarCartao: true,
            observacaoUso: "Conserto leve e urgente na estrutura f√≠sica da loja."
        },
        {
            nomeEtiqueta: "MANUTEN√á√ÉO ELETRICO",
            gastosAtrelados: "Troca de tomadas, disjuntores, interruptores, reatores, soquetes, extens√µes, pequeno reparo de fia√ß√£o baixa tens√£o.",
            termosChave: ["tomada","disjuntor","disjuntores","interruptor","reator","soquete","extens√£o","extensao","fio eletrico","fia√ß√£o","fiacao","baixa tensao","baixa tens√£o"],
            podeUsarCartao: true,
            observacaoUso: "Ajuste el√©trico simples e necess√°rio pro funcionamento imediato da loja."
        },
        {
            nomeEtiqueta: "MANUTEN√á√ÉO EQUIPAMENTOS",
            gastosAtrelados: "Reparo em impressora de etiqueta, m√°quina de estampar, computador fora de garantia e baixo valor, ferramenta manual.",
            termosChave: ["manutencao impressora","manuten√ß√£o impressora","manutencao maquina estampar","maquina de estampar","computador conserto","ajuste equipamento","ferramenta manual","reparo equipamento loja"],
            podeUsarCartao: true,
            observacaoUso: "Conserto de equipamento usado na opera√ß√£o di√°ria."
        },
        {
            nomeEtiqueta: "MANUTEN√á√ÉO AR-CONDICIONADO",
            gastosAtrelados: "Troca de controle remoto simples, limpeza de filtro, carga de g√°s, pequenos ajustes.",
            termosChave: ["ar condicionado","ar-condicionado","carga de gas","carga de g√°s","limpeza filtro ar","controle remoto ar","manutencao ar","manuten√ß√£o ar"],
            podeUsarCartao: true,
            observacaoUso: "Manuten√ß√£o pontual pra manter a loja funcionando."
        },
        {
            nomeEtiqueta: "TRANSPORTE SERVI√áOS EMERGENCIAS",
            gastosAtrelados: "Frete local emergencial, motoboy pra transportar documento/item urgente entre lojas ou matriz.",
            termosChave: ["motoboy","moto boy","frete rapido","frete urgente","entrega urgente","transporte urgente","courier","levar pe√ßa","levar peca","trazer pe√ßa","trazer peca","mandar documento","enviar documento","entrega matriz","levar pra matriz"],
            podeUsarCartao: true,
            observacaoUso: "S√≥ para necessidade real e urgente da opera√ß√£o da loja. N√£o √© Uber pessoal."
        },
        {
            nomeEtiqueta: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
            gastosAtrelados: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√£o, manuais impressos.",
            termosChave: ["banner impresso","adesivo promocional","adesivagem","flyer","folder","plotagem","grafica","gr√°fica","copiadora","encaderna√ß√£o","encadernacao","manual impresso"],
            podeUsarCartao: true,
            observacaoUso: "Materiais visuais/comunica√ß√£o aprovados para a loja."
        },
        {
            nomeEtiqueta: "CORREIOS_SEDEX/AR/POSTAGEM",
            gastosAtrelados: "Sedex, AR, carta registrada, devolu√ß√£o via Correios, envio de documentos/pacotes pequenos.",
            termosChave: ["sedex","correios","postagem","ar correios","carta registrada","enviar documento","devolucao correios","devolu√ß√£o correios","pacote pequeno","remessa loja"],
            podeUsarCartao: true,
            observacaoUso: "Envio relacionado √† opera√ß√£o da loja (documentos, pe√ßas)."
        },
        {
            nomeEtiqueta: "LANCHES DE REFEI√á√ïES",
            gastosAtrelados: "Coffee break p/ treinamentos internos autorizados, lanches em a√ß√£o oficial (VM, regional, diretoria), eventos internos autorizados, premia√ß√£o operacional.",
            termosChave: ["lanche time","lanche equipe","cafe time","caf√© time","coffee break","cafe da manha time","caf√© da manh√£ time","treinamento interno","premiacao","premia√ß√£o","evento interno","visita regional","visita diretor","vm na loja","vm da loja","lanche autorizado","lanche autorizado time"],
            podeUsarCartao: true,
            observacaoUso: "Somente em contexto operacional autorizado (treinamento/a√ß√£o oficial). N√£o cobre lazer pessoal ou refei√ß√£o pessoal."
        },
        {
            nomeEtiqueta: "AGUA POT√ÅVEL",
            gastosAtrelados: "Gal√£o de √°gua mineral ou garrafas para abastecimento da equipe / cliente, se previsto.",
            termosChave: ["gal√£o de agua","gal√£o de √°gua","galao de agua","agua potavel","√°gua pot√°vel","garrafa de agua","garrafa de √°gua","repor agua","repor √°gua","√°gua pra loja","agua pra loja","√°gua equipe","agua equipe"],
            podeUsarCartao: true,
            observacaoUso: "Abastecimento da loja/equipe, n√£o uso pessoal/lazer."
        },
        {
            nomeEtiqueta: "BOBINA ECF",
            gastosAtrelados: "Bobina para ECF/impressora fiscal/PDV em loja sem fornecimento centralizado.",
            termosChave: ["bobina ecf","bobina fiscal","bobina impressora fiscal","bobina pdv","bobina cupom","bobina do pdv"],
            podeUsarCartao: true,
            observacaoUso: "Item necess√°rio pro funcionamento do PDV."
        },
        {
            nomeEtiqueta: "CHAVEIRO EMERGENCIAL",
            gastosAtrelados: "Abertura/troca de fechadura de cofre, estoque, sala administrativa, vitrine ‚Äì s√≥ emerg√™ncia.",
            termosChave: ["chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar fechadura","perdi a chave","sem chave do cofre","sem chave do estoque","sem chave da vitrine","chave quebrou","quebrou a chave"],
            podeUsarCartao: true,
            observacaoUso: "Emerg√™ncia operacional real (acesso a √°rea cr√≠tica da loja)."
        },
        {
            nomeEtiqueta: "MANUTEN√á√ÉO MAQ ESTAMPAR",
            gastosAtrelados: "Ajuste t√©cnico simples em m√°quina de estampar produtos promocionais da loja (sem controle patrimonial).",
            termosChave: ["maquina estampar","m√°quina estampar","estamparia","manutencao estampar","manuten√ß√£o estampar","ajuste estampar","conserto estampar","estampa produto promocional","m√°quina de estampar loja","maquina de estampar loja"],
            podeUsarCartao: true,
            observacaoUso: "Manuten√ß√£o pontual da m√°quina de estampar da loja."
        }
    ];

    function normalize(text) {
        return text
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
    }

    function contemAlgum(msgNorm, lista) {
        return lista.some(k => msgNorm.includes(normalize(k)));
    }

    // tenta achar etiqueta por palavras do usu√°rio
    function acharEtiquetaPorMensagem(msgNorm) {
        for (const cat of tabelaEtiquetas) {
            for (const termo of cat.termosChave) {
                if (msgNorm.includes(normalize(termo))) {
                    return cat;
                }
            }
        }
        return null;
    }

    // -----------------------
    // INTEN√á√ïES
    // -----------------------
    const intents = {
        bebidaAlcoolica: ["cerveja","cervejinha","whisky","whiskey","vodka","vinho","champagne","espumante","bebida alcoolica","bebida alco√≥lica","alcool","√°lcool","chopp","chope"],
        eletronicos: ["ps5","playstation","play station","xbox","tv","televisao","televis√£o","monitor","som","r√°dio","radio","caixa de som","soundbar","notebook","laptop","tablet","fone","headset"],
        eletrodomesticos: ["micro-ondas","microondas","micro ondas","geladeira","frigobar","cafeteira","bebedouro","airfryer","air fryer","aspirador"],
        transportePessoal: ["uber","99","app de transporte","app 99","app99","corrida","taxi","t√°xi","taxi99","viagem","passagem","passagens","uber pessoal","uber pra casa","uber para casa"],
        alimentoTime: ["lanche","lanche time","lanche equipe","cafe time","caf√© time","coffee break","cafe da manha time","caf√© da manh√£ time","treinamento interno","premiacao","premia√ß√£o","evento interno","visita regional","visita diretor","vm na loja","vm da loja","√°gua","agua","gal√£o","galao","√°gua pot√°vel","agua potavel","√°gua potavel","agua pot√°vel"],
        manutencao: ["chaveiro","fechadura","troca de tomada","tomada","manuten√ß√£o ar","manutencao ar","ar condicionado","ar-condicionado","motoboy","frete urgente","entrega urgente","courier","prateleira","quebrou parede","quebrou porta","rompeu vidro","vidro quebrou","porta quebrou","carga de g√°s","carga de gas"],
        bloqueio: ["bloqueou","bloqueio","bloqueada","bloquearam","cart√£o bloqueado","cartao bloqueado","desbloquear","desbloqueia","desbloqueio","travou","cart√£o travou","cartao travou","preventivo","bloqueio preventivo","cartao travado","cart√£o travado"],
        prazo48h: ["48h","48 h","48 horas","prazo","quanto tempo","deadline","quando preciso lan√ßar","ate quando lan√ßo","at√© quando lan√ßo","qual prazo pra lan√ßar","prazo pra justificar","prazo pra justificativa","tempo pra justificar","ate quando justifico","at√© quando justifico"],
        justificar: ["como justificar","justificar compra","justificar transa√ß√£o","justificar a transa√ß√£o","prestar conta","presta√ß√£o de contas","prestacao de contas","o que eu coloco na descri√ß√£o","o que eu coloco na descricao","o que tenho que anexar","o que precisa lan√ßar na clara","como lan√ßo","como lan√ßar","como justifico","como subo nota","como sobe nota"],
        emergenciaSangria: ["emerg√™ncia","emergencia","urgente","sangria","tirar dinheiro do caixa","pegar dinheiro do caixa","sem limite","acabou limite","limite acabou","estourou limite","sem cart√£o","sem cartao","cartao nao passa","cart√£o nao passa","cartao n√£o passa","cart√£o n√£o passa","sem cartao clara","sem cart√£o clara"],
        usoPessoal: ["usei pra mim","usei para mim","pra mim","para mim","gasto pessoal","despesa pessoal","comprei pro meu filho","body pro meu filho","roupa pro meu filho","pessoal","uso pessoal","coisa minha","minha necessidade","comprei pra mim","comprei para mim"],
        outraLoja: ["cart√£o de outra loja","cartao de outra loja","emprestado","usar cart√£o da outra loja","usar cartao da outra loja","gerente desligado","sem gerente","gerente saiu","mudan√ßa de gerente","mudanca de gerente","troca de gerente","respons√°vel mudou","responsavel mudou","responsavel trocou","respons√°vel trocou","responsavel temporario","respons√°vel tempor√°rio","uso temporario do cartao","uso tempor√°rio do cart√£o"],
        notaFiscalRetencao: ["guardar nota","nota fisica","nota f√≠sica","nota fiscal fisica","nota fiscal f√≠sica","comprovante fisico","comprovante f√≠sico","auditoria","180 dias","guardar comprovante","guardar recibo","onde guardo a nota","tenho que guardar a nota"],
        servicenow: ["servicenow","service now","abre chamado","abrir chamado","abrir um chamado","chamado de aumento de limite","chamado de limite","chamado desbloqueio","desbloqueio no servicenow","categoria nova","nova etiqueta","nova categoria","troca de gerente","mudan√ßa de gerente","mudanca de gerente","transferir gerente","cart√£o bloqueado preciso abrir chamado","cartao bloqueado preciso abrir chamado","o que posso abrir no servicenow","quais chamados posso abrir","aumentar o limite","aumento de limite","limite maior","pedir aumento de limite"],
        politicaPdf: ["me manda a pol√≠tica","me manda a politica","manda a pol√≠tica","manda a politica","pdf da politica","pdf da pol√≠tica","politica clara","pol√≠tica clara","documento oficial","politica completa","politica em pdf","pol√≠tica em pdf","politica de uso","pol√≠tica de uso","politica dos cart√µes","pol√≠tica dos cart√µes"],
        etiqueta: ["qual etiqueta","que etiqueta","etiqueta usar","etiqueta devo usar","etiqueta pra","etiqueta para","qual categoria","qual classificacao","qual classifica√ß√£o","classificar gasto","classificar compra","em qual categoria entra isso","qual etiqueta pro teclado","qual etiqueta para teclado","que etiqueta usar pra mouse","que etiqueta usar para mouse","qual etiqueta mouse","etiqueta mouse","etiqueta teclado"]
    };

    // termos fora de escopo
    const termosForaEscopo = [
        "palmeiras","spfc","sao paulo fc","s√£o paulo fc","corinthians","flamengo","futebol","gol do",
        "presidente do brasil","elei√ß√£o","eleicao","voto","politica","pol√≠tica",
        "imposto de renda","irpf",
        "quanto √©","quanto e","qto √©","qto e","2+2","2 + 2","conta de matematica","conta de matem√°tica",
        "vacina","covid","saude","sa√∫de","hospital",
        "lula","bolsonaro",
        "puta","merda","caralho","vai tomar","vai se ferrar","vai se fuder"
    ];

    function ehFollowUpCurto(msgNorm) {
        if (msgNorm.length <= 80) {
            const chaves = [
                "como","e agora","e fa√ßo o que","e faco o que","e fa√ßo o qu√™","e fa√ßo oq",
                "o que eu fa√ßo","o que eu faco","o que fa√ßo","o que faco",
                "qual etiqueta","que etiqueta","qual categoria",
                "explica melhor","me explica","me ajuda",
                "e depois","e ai","e a√≠","e ai?",
                "como regularizo","como regularizar","como fa√ßo pra corrigir","como faco pra corrigir",
                "posso mesmo","pode mesmo","tem certeza"
            ];
            return chaves.some(k => msgNorm.includes(normalize(k)));
        }
        return false;
    }

    function classificarMensagem(msg) {
        const norm = normalize(msg);

        if (contemAlgum(norm, intents.politicaPdf))      return "politicaPdf";
        if (contemAlgum(norm, intents.servicenow))       return "aumentoLimite"; // mesmo fluxo (ServiceNow)
        if (contemAlgum(norm, intents.bloqueio))         return "bloqueio";
        if (contemAlgum(norm, intents.justificar))       return "justificar";
        if (contemAlgum(norm, intents.prazo48h))         return "prazo48h";
        if (contemAlgum(norm, intents.bebidaAlcoolica))  return "bebidaAlcoolica";
        if (contemAlgum(norm, intents.eletronicos))      return "eletronicos";
        if (contemAlgum(norm, intents.eletrodomesticos)) return "eletrodomesticos";
        if (contemAlgum(norm, intents.transportePessoal))return "transportePessoal";
        if (contemAlgum(norm, intents.alimentoTime))     return "alimentoTime";
        if (contemAlgum(norm, intents.manutencao))       return "manutencao";
        if (contemAlgum(norm, intents.emergenciaSangria))return "emergenciaSangria";
        if (contemAlgum(norm, intents.usoPessoal))       return "usoPessoal";
        if (contemAlgum(norm, intents.outraLoja))        return "outraLoja";
        if (contemAlgum(norm, intents.notaFiscalRetencao))return "notaFiscalRetencao";
        if (contemAlgum(norm, intents.etiqueta) || acharEtiquetaPorMensagem(norm)) return "etiqueta";

        if (
            norm.includes("aumento de limite") ||
            norm.includes("aumentar o limite") ||
            norm.includes("limite maior") ||
            (norm.includes("limite") && norm.includes("aument"))
        ) {
            return "aumentoLimite";
        }

        // se cair aqui e tiver termo fora de escopo ‚Üí fora do escopo
        if (contemAlgum(norm, termosForaEscopo)) {
            return "foraDoEscopo";
        }

        return "generica";
    }

    // -----------------------
    // RESPOSTAS
    // -----------------------

    function respForaDoEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
N√£o consigo responder sobre esse contexto.<br/>
Sou um agente especializado na <strong>Pol√≠tica de Uso dos Cart√µes Clara nas lojas</strong>.
</p>`;
    }

    function respPoliticaPDF() {
        return `HTML:<p class="text-sm text-slate-700">
Segue a <strong>Pol√≠tica de Uso dos Cart√µes Clara</strong> (documento oficial):<br/>
<a class="bot-link" href="${POLITICA_PDF_URL}" target="_blank" rel="noopener noreferrer">
Abrir Pol√≠tica de Uso dos Cart√µes Clara (PDF)
</a>
</p>
<p class="mt-2 text-[13px] text-slate-500">
Esse documento define: o que pode / n√£o pode, prazo de 48h, bloqueio preventivo, uso pessoal e ressarcimento.
</p>`;
    }

    function respBebidaAlcoolica() {
        return `HTML:<p class="text-sm text-slate-700">
<b>N√£o pode. üö´</b><br/><br/>
Bebida alco√≥lica (cerveja, vinho, whisky etc.) <b>n√£o √© despesa operacional da loja</b> e
<b>n√£o pode ser paga com o cart√£o Clara</b> ‚Äî nem pra comemorar, nem "pro time".<br/><br/>
Se j√° passou no cart√£o:<br/>
1. avisa o Financeiro;<br/>
2. classifica como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce o valor em at√© 2 dias √∫teis.<br/><br/>
Se n√£o ressarcir, pode ter desconto em folha e bloqueio definitivo do cart√£o.
</p>`;
    }

    function respEletronicos() {
        return `HTML:<p class="text-sm text-slate-700">
<b>N√£o pode comprar esse tipo de item no cart√£o Clara.</b><br/><br/>
Eletr√¥nicos tipo TV, monitor, videogame, notebook, caixa de som, etc. s√£o considerados
<b>bens patrimoniais / infraestrutura</b>, e devem seguir fluxo de Compras.<br/><br/>
Se comprou no cart√£o:<br/>
‚Ä¢ avisa o Financeiro;<br/>
‚Ä¢ marca a transa√ß√£o como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
‚Ä¢ ressarce em at√© 2 dias √∫teis.
</p>`;
    }

    function respEletrodomesticos() {
        return `HTML:<p class="text-sm text-slate-700">
Itens como micro-ondas, geladeira, frigobar, cafeteira, bebedouro etc.
<b>n√£o entram no cart√£o Clara</b>.<br/><br/>
Isso √© infraestrutura fixa/patrimonial da loja e precisa seguir o fluxo de Compras, n√£o despesa direta via cart√£o.<br/><br/>
Se j√° passou no cart√£o:<br/>
1. avisa o Financeiro;<br/>
2. classifica como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce em at√© 2 dias √∫teis.
</p>`;
    }

    function respTransportePessoal() {
        ultimaIntencao = "transportePessoal";
        return `HTML:<p class="text-sm text-slate-700">
<b>Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode no cart√£o Clara.</b><br/><br/>
Isso n√£o √© despesa operacional direta da loja.<br/><br/>
Se j√° pagou com o cart√£o:<br/>
1. avisa o Financeiro;<br/>
2. classifica como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce o valor em at√© 2 dias √∫teis.<br/><br/>
Se n√£o ressarcir, pode ter desconto em folha e bloqueio definitivo.
</p>`;
    }

    function respTransportePessoalFollowup() {
        return `HTML:<p class="text-sm text-slate-700">
Pra corrigir uma corrida de Uber que caiu no cart√£o:<br/><br/>
1. Abra a transa√ß√£o na Clara;<br/>
2. Na descri√ß√£o, informe que foi uso pessoal;<br/>
3. Classifique como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
4. Avise o Financeiro;<br/>
5. Ressa√ßa o valor em at√© 2 dias √∫teis.<br/><br/>
N√£o regularizar = risco de bloqueio definitivo do cart√£o.
</p>`;
    }

    function respAlimentoTime() {
        ultimaIntencao = "alimentoTime";
        return `HTML:<p class="text-sm text-slate-700">
<b>Depende.</b><br/><br/>
‚úî Pode usar o cart√£o Clara para:<br/>
‚Ä¢ √°gua / lanche / coffee break para <b>treinamento interno autorizado</b>,<br/>
‚Ä¢ a√ß√£o oficial (VM, regional, diretoria),<br/>
‚Ä¢ evento interno autorizado / premia√ß√£o operacional.<br/><br/>
‚ùå N√£o pode:<br/>
‚Ä¢ lazer pessoal (almo√ßo pessoal, pipoca no cinema, comemora√ß√£o particular etc.).<br/><br/>
Quando for permitido:<br/>
‚Ä¢ anexa a nota fiscal;<br/>
‚Ä¢ usa a etiqueta correta (ex.: "AGUA POT√ÅVEL" ou "LANCHES DE REFEI√á√ïES");<br/>
‚Ä¢ descreve: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respAlimentoTimeFollowup(msgNorm) {
        const e = acharEtiquetaPorMensagem(msgNorm);
        if (e) {
            return respEtiquetaDireta(e);
        }
        return `HTML:<p class="text-sm text-slate-700">
Quando o lanche √© pra a√ß√£o autorizada / treinamento oficial:<br/><br/>
1. Usa "AGUA POT√ÅVEL" (√°gua) ou "LANCHES DE REFEI√á√ïES" (coffee break autorizado);<br/>
2. Anexa a nota;<br/>
3. Descreve: "Coffee break treinamento VM loja 1234".<br/><br/>
Refei√ß√£o pessoal / lazer n√£o pode.
</p>`;
    }

    function respManutencao() {
        ultimaIntencao = "manutencao";
        return `HTML:<p class="text-sm text-slate-700">
Gastos operacionais emergenciais / manuten√ß√£o simples da loja <b>podem</b> entrar no cart√£o Clara:<br/><br/>
‚Ä¢ chaveiro emergencial pra abrir estoque/cofre/vitrine;<br/>
‚Ä¢ troca de tomada, interruptor, disjuntor;<br/>
‚Ä¢ ajuste simples em ar-condicionado (filtro, controle, carga de g√°s);<br/>
‚Ä¢ motoboy / frete urgente pra levar/pegar item cr√≠tico;<br/>
‚Ä¢ pequeno reparo civil tipo prateleira, porta, vidro, parede;<br/><br/>
Sempre fa√ßa:<br/>
1. anexa a nota fiscal ou recibo;<br/>
2. usa a etiqueta certa ("CHAVEIRO EMERGENCIAL", "MANUTEN√á√ÉO ELETRICO", "MANUTEN√á√ÉO AR-CONDICIONADO", "TRANSPORTE SERVI√áOS EMERGENCIAS"...);<br/>
3. descreve claro: "Chaveiro emergencial - troca fechadura estoque loja 1234".<br/><br/>
<b>Importante:</b> compra patrimonial grande (geladeira, TV, micro-ondas etc.) N√ÉO entra no cart√£o.
</p>`;
    }

    function respManutencaoFollowup(msgNorm) {
        const e = acharEtiquetaPorMensagem(msgNorm);
        if (e) {
            return respEtiquetaDireta(e);
        }
        return `HTML:<p class="text-sm text-slate-700">
Use a etiqueta de manuten√ß√£o/servi√ßo emergencial correspondente (ex.: "CHAVEIRO EMERGENCIAL", "MANUTEN√á√ÉO ELETRICO", "TRANSPORTE SERVI√áOS EMERGENCIAS").<br/><br/>
Descreve o que foi feito e onde:
"Troca de fechadura estoque loja 1234", "Motoboy urgente pe√ßa vitrine loja 5678".<br/><br/>
Compra de equipamento fixo (geladeira, micro-ondas etc.) N√ÉO pode no cart√£o.
</p>`;
    }

    function respBloqueio() {
        ultimaIntencao = "bloqueio";
        return `HTML:<p class="text-sm text-slate-700">
Isso √© bloqueio preventivo. üîí<br/><br/>
O cart√£o pode ser travado se a compra n√£o foi justificada no prazo.<br/><br/>
Justificar = anexar nota fiscal/recibo + escolher etiqueta correta + escrever descri√ß√£o objetiva at√© 48h.<br/><br/>
<b>Como desbloquear:</b><br/>
1. Corrige tudo na Clara;<br/>
2. Depois abre chamado no ServiceNow pedindo desbloqueio (informa que j√° regularizou).<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow
</a><br/><br/>
Obs: pode bloquear independente do valor. Reincid√™ncia pode fazer a loja perder o cart√£o.
</p>`;
    }

    function respBloqueioFollowup() {
        return `HTML:<p class="text-sm text-slate-700">
Passo a passo pra liberar o cart√£o:<br/><br/>
1. Vai na transa√ß√£o que gerou o bloqueio;<br/>
2. Anexa a nota fiscal/recibo;<br/>
3. Escolhe a etiqueta correta;<br/>
4. Escreve descri√ß√£o clara ("Chaveiro emergencial - troca fechadura estoque 1234");<br/>
5. Depois abre chamado avisando que regularizou e pede desbloqueio.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow
</a>
</p>`;
    }

    function respPrazo48h() {
        ultimaIntencao = "prazo48h";
        return `HTML:<p class="text-sm text-slate-700">
<b>Prazo oficial:</b><br/>
Voc√™ tem at√© <b>48 horas depois da compra</b> pra:<br/>
1. anexar a nota fiscal/recibo;<br/>
2. escolher a etiqueta correta;<br/>
3. escrever a descri√ß√£o do gasto.<br/><br/>
Se n√£o fizer isso no prazo, o cart√£o pode ser <b>bloqueado preventivamente</b> at√© voc√™ ajustar.
</p>`;
    }

    function respJustificar() {
        ultimaIntencao = "justificar";
        return `HTML:<p class="text-sm text-slate-700">
Pra justificar / prestar contas na Clara voc√™ faz 3 coisas (at√© 48h):<br/><br/>
1. <b>Anexar o comprovante fiscal</b> (nota fiscal ou recibo);<br/><br/>
2. <b>Escolher a etiqueta certa</b><br/>
   Ex.: "AGUA POT√ÅVEL", "LANCHES DE REFEI√á√ïES",
   "MATERIAL DE INFORM√ÅTICA", "CHAVEIRO EMERGENCIAL", etc.<br/><br/>
3. <b>Preencher a descri√ß√£o</b><br/>
   Explicar objetivamente o gasto:
   "Teclado PDV loja 1234", "Motoboy urgente pe√ßa vitrine loja 5678".<br/><br/>
Sem isso, o cart√£o pode ser bloqueado preventivamente.
</p>`;
    }

    function respJustificarFollowup() {
        return `HTML:<p class="text-sm text-slate-700">
Checklist r√°pido pra justificar certo:<br/><br/>
‚Ä¢ Nota fiscal anexada (foto leg√≠vel);<br/>
‚Ä¢ Etiqueta coerente:<br/>
&nbsp;&nbsp;- √Ågua ‚Üí "AGUA POT√ÅVEL"<br/>
&nbsp;&nbsp;- Coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"<br/>
&nbsp;&nbsp;- Teclado/mouse/cabo ‚Üí "MATERIAL DE INFORM√ÅTICA"<br/>
&nbsp;&nbsp;- Motoboy urgente ‚Üí "TRANSPORTE SERVI√áOS EMERGENCIAS"<br/>
&nbsp;&nbsp;- Chaveiro emerg√™ncia ‚Üí "CHAVEIRO EMERGENCIAL"<br/><br/>
‚Ä¢ Descri√ß√£o clara:
"Teclado PDV loja 1234", "Coffee break treinamento VM loja 1234".<br/><br/>
Isso evita cobran√ßa e bloqueio.
</p>`;
    }

    function respEmergenciaSangria() {
        ultimaIntencao = "emergenciaSangria";
        return `HTML:<p class="text-sm text-slate-700">
"Sangria emergencial" N√ÉO √© "acabou meu limite".<br/><br/>
√â emerg√™ncia real quando:<br/>
1. a loja n√£o consegue operar sem aquele gasto agora;<br/>
2. n√£o d√° pra usar o cart√£o Clara (falha t√©cnica etc.).<br/><br/>
<b>ANTES</b> de tirar dinheiro do caixa, precisa autoriza√ß√£o do Financeiro via chamado.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow
</a><br/><br/>
Sem autoriza√ß√£o PR√âVIA n√£o pode pegar dinheiro do caixa e depois ‚Äúeu reembolso‚Äù.
</p>`;
    }

    function respUsoPessoal() {
        ultimaIntencao = "usoPessoal";
        return `HTML:<p class="text-sm text-slate-700">
Uso pessoal do cart√£o √© <b>proibido</b>.<br/><br/>
Pra corrigir:<br/>
1. avisa o Financeiro;<br/>
2. marca a transa√ß√£o na Clara como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce o valor em at√© 2 dias √∫teis.<br/><br/>
Se voc√™ n√£o ressarcir:<br/>
‚Ä¢ pode ter desconto em folha,<br/>
‚Ä¢ pode ter medida disciplinar,<br/>
‚Ä¢ e o cart√£o pode ser bloqueado definitivamente pra voc√™.
</p>`;
    }

    function respOutraLoja() {
        ultimaIntencao = "outraLoja";
        return `HTML:<p class="text-sm text-slate-700">
Usar cart√£o de outra loja s√≥ pode em cen√°rio MUITO espec√≠fico:<br/><br/>
‚Ä¢ o gerente titular saiu / foi desligado;<br/>
‚Ä¢ ainda n√£o existe cart√£o novo vinculado √† loja;<br/>
‚Ä¢ o Financeiro autorizou uso tempor√°rio.<br/><br/>
Obrigat√≥rio escrever na descri√ß√£o da compra na Clara:<br/>
"Uso tempor√°rio do cart√£o na loja XXXX".<br/><br/>
Mudan√ßa de respons√°vel/gerente precisa ser formalizada via chamado pro Financeiro.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow (troca de respons√°vel)
</a>
</p>`;
    }

    function respNotaFiscalRetencao() {
        ultimaIntencao = "notaFiscalRetencao";
        return `HTML:<p class="text-sm text-slate-700">
Mesmo depois de subir a nota fiscal/recibo na Clara, a loja precisa <b>guardar o documento f√≠sico original</b>.<br/><br/>
Prazo: manter guardado por <b>180 dias corridos</b> na loja.<br/><br/>
A √°rea financeira pode pedir esses comprovantes f√≠sicos em auditoria.
</p>`;
    }

    function respAumentoLimite() {
        ultimaIntencao = "aumentoLimite";
        return `HTML:<p class="text-sm text-slate-700">
Sobre aumento de limite do cart√£o Clara üëá<br/><br/>
‚Ä¢ O limite √© definido por loja e √© mensal;<br/>
‚Ä¢ Pode ser ajustado pelo Financeiro, mas s√≥ com justificativa operacional real (n√£o √© pra gasto pessoal).<br/><br/>
Como pedir:<br/>
1. Abra um chamado no ServiceNow para o Financeiro / Contas a Receber;<br/>
2. Informe a loja, a urg√™ncia e o motivo operacional do aumento;<br/>
3. Deixe claro que √© uma despesa da LOJA, n√£o algo pessoal.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow (Aumento de limite)
</a><br/><br/>
Obs: Equipamento patrimonial (geladeira, TV, etc.) n√£o √© ‚Äúaumentar limite‚Äù; isso √© via Compras.
</p>`;
    }

    // ETIQUETA DETALHADA
    // agora come√ßa dizendo explicitamente se pode usar o cart√£o e o porqu√™
    function respEtiquetaDireta(et) {
        const pode = et.podeUsarCartao;
        const introPermissao = pode
            ? `<p><b>Sim.</b> Esse tipo de gasto √© considerado despesa operacional da loja e pode ser pago com o cart√£o Clara, desde que seja realmente para a opera√ß√£o da loja e seja de baixo valor (n√£o uso pessoal).</p>`
            : `<p><b>N√£o deve usar o cart√£o Clara pra esse tipo de gasto.</b> Isso cai como item que precisa de outro fluxo (Compras / patrimonial / etc.).</p>`;

        return `HTML:<div class="text-sm text-slate-700">
${introPermissao}

<p class="mt-3"><b>Use a etiqueta:</b> "${et.nomeEtiqueta}"</p>

<p class="mt-2"><b>O que entra nessa etiqueta:</b><br/>${et.gastosAtrelados}</p>

<p class="mt-2 text-slate-700"><i>${et.observacaoUso || ""}</i></p>

<p class="mt-4 text-slate-700">
<b>Como lan√ßar na Clara (at√© 48h):</b><br/>
1. Anexar a nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar a etiqueta "${et.nomeEtiqueta}";<br/>
3. Escrever uma descri√ß√£o objetiva (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar o documento f√≠sico na loja por 180 dias.
</p>

<p class="mt-4 text-[13px] text-slate-500">
Se nenhuma etiqueta existente encaixa, solicite cria√ß√£o de etiqueta nova:
</p>
<p class="text-sm mt-1">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow para criar etiqueta
</a>
</p>
</div>`;
    }

    function respEtiqueta(msgNorm) {
        ultimaIntencao = "etiqueta";
        const et = acharEtiquetaPorMensagem(msgNorm);
        if (et) {
            return respEtiquetaDireta(et);
        }

        // fallback sem contexto suficiente
        return `HTML:<div class="text-sm text-slate-700">
<p>Vou te ajudar a escolher a etiqueta certa üëá</p>

<p class="mt-3"><b>Exemplos comuns permitidos no cart√£o Clara:</b></p>
<ul class="list-disc pl-5 mt-1">
<li>√Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL"</li>
<li>Coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"</li>
<li>Teclado / mouse / cabo USB / pendrive ‚Üí "MATERIAL DE INFORM√ÅTICA"</li>
<li>Caneta / pasta / bloco / post-it ‚Üí "MATERIAL DE ESCRIT√ìRIO"</li>
<li>Motoboy urgente ‚Üí "TRANSPORTE SERVI√áOS EMERGENCIAS"</li>
<li>Chaveiro pra abrir estoque/cofre ‚Üí "CHAVEIRO EMERGENCIAL"</li>
<li>Trocar tomada / ajuste ar-condicionado ‚Üí "MANUTEN√á√ÉO ELETRICO" ou "MANUTEN√á√ÉO AR-CONDICIONADO"</li>
<li>Banner, adesivo, m√≠dia local ‚Üí "MARKETING_PUBLICIDADE E PROPAGANDA" ou "SERVI√áOS GR√ÅFICOS E DE COPIADORAS"</li>
</ul>

<p class="mt-4 text-[13px] text-slate-500">
Se nenhuma etiqueta existente encaixa, voc√™ pede cria√ß√£o de nova etiqueta via chamado:
</p>
<p class="text-sm mt-1">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow para criar etiqueta
</a>
</p>
</div>`;
    }

    function respGenerica() {
        ultimaIntencao = "generica";
        return `HTML:<p class="text-sm text-slate-700">
Vamos validar se pode usar o cart√£o Clara üëá<br/><br/>
1. √â despesa operacional da LOJA (necess√°ria pro funcionamento da loja agora)?<br/>
   ‚Ä¢ Ex.: chaveiro emergencial, √°gua pra equipe, motoboy urgente, material de limpeza, teclado do PDV.<br/><br/>
2. Voc√™ vai anexar nota fiscal/recibo, escolher etiqueta correta e descrever o gasto em at√© 48h?<br/><br/>
‚õî N√ÉO pode no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal etc.);<br/>
‚Ä¢ bebida alco√≥lica;<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV etc.).<br/><br/>
Uso pessoal precisa ser ressarcido em 2 dias √∫teis. Se n√£o regularizar, pode bloquear o cart√£o.
</p>`;
    }

    function respFollowup(ultimaIntencaoLocal, msgNorm) {
        switch (ultimaIntencaoLocal) {
            case "transportePessoal":   return respTransportePessoalFollowup();
            case "alimentoTime":        return respAlimentoTimeFollowup(msgNorm);
            case "manutencao":          return respManutencaoFollowup(msgNorm);
            case "bloqueio":            return respBloqueioFollowup();
            case "justificar":          return respJustificarFollowup();
            case "etiqueta":
                const et = acharEtiquetaPorMensagem(msgNorm);
                if (et) return respEtiquetaDireta(et);
                return respEtiqueta(msgNorm);
            default:
                return respGenerica();
        }
    }

    // -----------------------
    // RENDER DO CHAT
    // -----------------------
    const chatWindow = document.getElementById("chatWindow");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");

    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start gap-3 justify-end";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
    }

    function renderTyping() {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start gap-3 clara-typing";

        const avatar = document.createElement("div");
        avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
        avatar.innerText = "C";

        const bubble = document.createElement("div");
        bubble.className = "typing-bubble px-4 py-3 max-w-[80%] text-[13px]";
        bubble.innerHTML = `
            <span class="dot"></span>
            <span class="dot ml-1"></span>
            <span class="dot ml-1"></span>
            <span class="ml-2 text-slate-500">digitando...</span>
        `;

        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);

        chatWindow.appendChild(wrapper);
        scrollToBottom();

        return wrapper;
    }

    // render da Clara (aceita HTML:)
    function renderBotMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start gap-3";

        const avatar = document.createElement("div");
        avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
        avatar.innerText = "C";

        const bubble = document.createElement("div");
        bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

        if (text.startsWith("HTML:")) {
            bubble.innerHTML = text.replace(/^HTML:/, "").trim();
        } else {
            bubble.innerText = text;
        }

        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);

        chatWindow.appendChild(wrapper);
    }

    // -----------------------
    // PIPELINE DE RESPOSTA
    // -----------------------
    chatForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const textoUsuario = userInput.value.trim();
        if (!textoUsuario) return;

        renderUserMessage(textoUsuario);
        userInput.value = "";

        const typingEl = renderTyping();

        const norm = normalize(textoUsuario);

        let resposta;
        let intent = classificarMensagem(textoUsuario);

        // follow-up curto? aproveita contexto anterior
        if (ehFollowUpCurto(norm) && ultimaIntencao && intent === "generica") {
            resposta = respFollowup(ultimaIntencao, norm);
        } else {
            // inten√ß√£o principal
            switch (intent) {
                case "foraDoEscopo":        resposta = respForaDoEscopo(); break;
                case "politicaPdf":         resposta = respPoliticaPDF(); break;
                case "aumentoLimite":       resposta = respAumentoLimite(); break;
                case "bloqueio":            resposta = respBloqueio(); break;
                case "justificar":          resposta = respJustificar(); break;
                case "prazo48h":            resposta = respPrazo48h(); break;
                case "bebidaAlcoolica":     resposta = respBebidaAlcoolica(); break;
                case "eletronicos":         resposta = respEletronicos(); break;
                case "eletrodomesticos":    resposta = respEletrodomesticos(); break;
                case "transportePessoal":   resposta = respTransportePessoal(); break;
                case "alimentoTime":        resposta = respAlimentoTime(); break;
                case "manutencao":          resposta = respManutencao(); break;
                case "emergenciaSangria":   resposta = respEmergenciaSangria(); break;
                case "usoPessoal":          resposta = respUsoPessoal(); break;
                case "outraLoja":           resposta = respOutraLoja(); break;
                case "notaFiscalRetencao":  resposta = respNotaFiscalRetencao(); break;
                case "etiqueta":            resposta = respEtiqueta(norm); break;
                default:                    resposta = respGenerica(); break;
            }
        }

        // render resposta e limpa o "digitando..."
        setTimeout(() => {
            typingEl.remove();
            renderBotMessage(resposta);
            scrollToBottom();
        }, 400);
    });
</script>



