<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Vektor</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js + plugin de data labels para o gr√°fico de faturas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:none;
        width:100%; 
        margin:0;
        display:flex;
        flex-direction:column;
        height:100%;
        min-height:0;
        position: relative;
        overflow: hidden;

    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:0.5rem 1.25rem 0.75rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        background-color:#005E27;
        color:#B5FF20;
        margin-bottom:0.5rem;
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:100px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex: 1;
        display:flex;
        flex-direction:column;
        overflow-y:hidden;
        padding:1rem 1.25rem;
        background-color:#fff;
        min-height:0;
    }
    .chat-window {
        flex:1;              /* ocupa todo o espa√ßo dispon√≠vel dentro do main */
        overflow-y:auto;     /* ativa scroll interno das mensagens */
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
        padding:1rem 1.5rem; /* opcional: espa√ßo interno */
}

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
        position: relative;
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digita√ß√£o menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do hist√≥rico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links nas respostas do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }

    /* ===== Tooltips dos bot√µes de pend√™ncias/justificativas ===== */
.vektor-btn-wrapper {
  position: relative;
  display: inline-block;
}

/* ===== Radar Tooltip (tabela com scroll, sem afetar tooltips globais) ===== */
.vektor-btn-wrapper.vektor-radar-tip:hover .vektor-tooltip-base,
.vektor-tooltip-base.vektor-radar-tip:hover {
  opacity: 1;
  pointer-events: auto; /* permite rolar/interagir */
}



/* Tooltip "grande" apenas quando tiver a classe vektor-radar-tip */
.vektor-tooltip-base.vektor-radar-tip {
  white-space: normal;
  width: min(1100px, 92vw);
  max-height: 360px;
  padding: 10px;
  border-radius: 10px;
  background: rgba(15,23,42,0.97);
  border: 2px solid rgba(226,232,240,0.9);
  box-shadow: 0 10px 25px rgba(0,0,0,0.45);
}

/* Container interno rol√°vel: scroll s√≥ no conte√∫do da tabela */
.vektor-tooltip-base.vektor-radar-tip .vektor-radar-tip-scroll {
  overflow: auto;
  max-height: 320px;
  max-width: 100%;
  padding-right: 6px;
}

.vektor-tooltip-base {
  position: absolute;
  bottom: 110%;           /* aparece logo acima do bot√£o */
  right: 0;
  z-index: 9999;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 11px;
  color: #FFFFFF;            /* texto SEMPRE branco, como voc√™ pediu */
  background: rgba(0,0,0,0.85); /* ser√° sobrescrito inline por bot√£o */
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  box-shadow: 0 2px 6px rgba(15,23,42,0.25);
}

.vektor-btn-wrapper:hover .vektor-tooltip-base {
  opacity: 1;
}

/* ===== Radar: barra de legenda (animada) ===== */
.radar-legend-bar {
  margin-top: 10px;
  height: 10px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.18);
  background: linear-gradient(
    90deg,
    rgba(59,130,246,0.95),
    rgba(148,163,184,0.35),
    rgba(239,68,68,0.95)
  );
  position: relative;
  overflow: hidden;
}

/* brilho suave passando por cima */
.radar-legend-bar::after {
  content: "";
  position: absolute;
  top: -40%;
  left: -35%;
  width: 35%;
  height: 180%;
  background: linear-gradient(
    90deg,
    rgba(255,255,255,0),
    rgba(255,255,255,0.25),
    rgba(255,255,255,0)
  );
  transform: skewX(-18deg);
  pointer-events: none;
}

/* anima SOMENTE quando o Radar estiver aberto */
#radarView.is-open .radar-legend-bar::after {
  animation: radarSheen 2.8s ease-in-out infinite;
}

@keyframes radarSheen {
  0%   { left: -35%; opacity: 0.0; }
  15%  { opacity: 0.55; }
  50%  { left: 105%; opacity: 0.35; }
  85%  { opacity: 0.0; }
  100% { left: 105%; opacity: 0.0; }
}

/* ===== Spinner de carregamento para pend√™ncias/justificativas ===== */
.vektor-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #0f172a;
}

.vektor-spinner {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  border: 2px solid #e5e7eb;
  border-top-color: #0f172a;
  animation: vektor-spin 0.7s linear infinite;
}

/* ===== Overlay Envio de Pend√™ncias (spinner) ===== */
.envPend_spinner{
  width: 42px;
  height: 42px;
  border-radius: 999px;
  border: 4px solid rgba(226,232,240,0.18);
  border-top-color: #B5FF20;
  animation: envPendSpin 0.9s linear infinite;
}
@keyframes envPendSpin{
  to { transform: rotate(360deg); }
}

@keyframes vektor-spin {
  to {
    transform: rotate(360deg);
  }
}

/* === VEKTOR AUTOCOMPLETE === */
#vektor-autocomplete-box {
  position: absolute;
  left: 0;
  right: 0;

  /* aparece acima do input, sem empurrar layout */
  bottom: calc(100% + 8px);

  margin-top: 0;
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.14);
  z-index: 9999;
  display: none;
  font-size: 13px;
  max-height: 220px;
  overflow-y: auto;
}

.vektor-autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
}

.vektor-autocomplete-item:hover {
  background: #B5FF20;
}

.vektor-autocomplete-item.is-active {
  background: #B5FF20;
}

#attachBtn {
    background-color: transparent !important;
    border-color: #cbd5e1 !important; /* mant√©m o cinza do Tailwind */
    color: #0f172a !important;         /* mant√©m cor do √≠cone */
}

/* === FIX: op√ß√µes de SELECT vis√≠veis no tema escuro (My Alerts) === */
#myAlertsView select,
#myAlertsView option {
  color: #ffffff;
}

#myAlertsView option {
  background: #0b1220; /* mesmo fundo do header/cards */
}

/* multi-select (etiquetas) */
#myAlertsView select[multiple] option {
  background: #0b1220;
}

/* hover/selecionado (alguns browsers) */
#myAlertsView option:checked,
#myAlertsView option:hover {
  background: rgba(22,163,74,0.35);
}

/* === FIX: op√ß√µes de SELECT vis√≠veis no tema escuro (Radar Itens) === */
#radarItensView select,
#radarItensView option {
  color: #ffffff;
}
#radarItensView option {
  background: #0b1220;
}
#radarItensView option:checked,
#radarItensView option:hover {
  background: rgba(22,163,74,0.35);
}

/* === FIX: op√ß√µes de SELECT vis√≠veis no tema escuro (Modal Itens Irregulares) === */
#itensIrregDetalhamentoModal select,
#itensIrregDetalhamentoModal option {
  color: #ffffff;
}
#itensIrregDetalhamentoModal option {
  background: #0b1220;
}
#itensIrregDetalhamentoModal option:checked,
#itensIrregDetalhamentoModal option:hover {
  background: rgba(22,163,74,0.35);
}

/* √çcone do calend√°rio (Chrome/Edge) */
#envioPendView input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(1.6);
  opacity: 1;
  cursor: pointer;
}

/* remove ‚Äúbot√µes‚Äù extras se aparecerem */
#envioPendView input[type="date"]::-webkit-inner-spin-button,
#envioPendView input[type="date"]::-webkit-clear-button {
display: none;
}

/* √çcone do calend√°rio (Chrome/Edge) ‚Äî Radar Itens Irregulares */
#radarItensView input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(1.6);
  opacity: 1;
  cursor: pointer;
}
#radarItensView input[type="date"]::-webkit-inner-spin-button,
#radarItensView input[type="date"]::-webkit-clear-button {
  display: none;
}

/* √çcone do calend√°rio */
#cicloResumoView input[type="date"]::-webkit-calendar-picker-indicator{
  filter: invert(1) brightness(2) contrast(1.2) !important;
  opacity: 1 !important;
  cursor: pointer;
  width: 18px;
  height: 18px;
}

/* evita bot√µes extras */
#cicloResumoView input[type="date"]::-webkit-inner-spin-button,
#cicloResumoView input[type="date"]::-webkit-clear-button{
  display: none;
}

/* ‚úÖ Fundo cinza claro na faixa do filtro de per√≠odo */
#cicloResumoView .cicloResumoPeriodoBox{
  background: #e5e7eb !important;   /* cinza claro */
  border: 1px solid #cbd5e1 !important;
  border-radius: 14px !important;
  padding: 10px 12px !important;
}

/* =========================
   RESUMO DO CICLO - VISUAL
   ========================= */
.cicloResumoPage {
  background:#ffffff !important;
}

.cicloCard {
  background:#fff;
  border:2px double #005E27;
  border-radius:14px;
  padding:12px;
  box-shadow:0 10px 22px rgba(0,0,0,0.08);
}

.cicloCardLabel {
  color:#0f172a;
  font-size:13px;
  font-weight:900;
}

.cicloCardValue {
  margin-top:6px;
  color:#0b1220;
  font-size:26px;
  font-weight:1000;
}

.cicloCardSub {
  margin-top:2px;
  color:#334155;
  font-size:12px;
  font-weight:800;
}

#cicloResumoTableBox {
  background:#fff;
  border:2px solid #000;
  border-radius:12px;
  overflow:auto;
  max-height:45vh; /* ‚úÖ necess√°rio p/ o sticky ‚Äúfazer sentido‚Äù */
}

/* ===== Resumo do ciclo | Tabela com grade + cabe√ßalho sticky ===== */
#cicloResumoTable {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  color: #0b1220;
}

#cicloResumoTable thead th{
  position: sticky;
  text-align:center !important;
  vertical-align:middle !important;
  top: 0;
  z-index: 2;
  background: #123a63;
  color: #ffffff;
  font-size: 13px;               /* +1 ponto */
  border-right: 2px double #005E27;
  border-bottom: 2px double #005E27;
  padding: 10px 10px;
}

#cicloResumoTable thead th[data-sort]::after{
  content:" ‚áÖ";
  opacity:0;
  transition: opacity .15s ease;
  margin-left:6px;
}

#cicloResumoTable thead th[data-sort]:hover::after{
  opacity:0.75;
}

#cicloResumoTable tbody td{
  font-size: 12px;               /* +1 ponto */
  border-right: 2px double #111;
  border-bottom: 2px double #111;
  padding: 10px 10px;
  background: #ffffff;
}

#cicloResumoTable thead th:last-child,
#cicloResumoTable tbody td:last-child{
  border-right: none;
}

.cicloResumoRow { cursor: default; }

.cicloResumoRow:hover td {
  background:#f8fafc;
}

#cicloResumoTooltipHeader {
  background:#005E27;
  color:#fff;
  padding:12px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
#cicloResumoTooltipBody {
  background:#fff;
  padding:12px 14px;
  color:#0f172a;
}

/* =========================
   STATUS (Estado Operacional) - background blur
   ========================= */
.vektor-status-card{
  position: relative;
}

/* layer do fundo */
.vektor-status-card::before{
  content: "";
  position: absolute;
  inset: 0;
  background-image: url("https://raw.githubusercontent.com/rslisboa/cartoesclara/b2a74cc141e69f3940ecaa90855709f743979a34/back_v.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  /* desfoca e deixa bem leve */
  filter: blur(6px);
  opacity: 0.35;

  /* evita borda ‚Äúfantasma‚Äù do blur */
  transform: scale(1.08);

  /* garante que fica atr√°s do conte√∫do */
  z-index: 0;
}

/* conte√∫do sempre acima do fundo */
.vektor-status-card > *{
  position: relative;
  z-index: 1;
}

/* =========================
   FLUXOGRAMA - background blur (layer real)
   ========================= */
.vektor-fluxo-bg{
  position: relative;
  overflow: hidden;
  background: transparent !important;
}

.vektor-fluxo-bg-layer{
  position: absolute;
  inset: 0;
  pointer-events: none;

  background-image: url("https://raw.githubusercontent.com/rslisboa/cartoesclara/b2a74cc141e69f3940ecaa90855709f743979a34/back_v.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  filter: blur(6px);
  opacity: 0.30;

  transform: scale(1.12);
  z-index: 0;
}

/* garante que o conte√∫do fica por cima */
.vektor-fluxo-bg > :not(.vektor-fluxo-bg-layer){
  position: relative;
  z-index: 2;
}

</style>

<style>
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      height: 24px;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background-color: #94a3b8;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>

  <style>
  /* VEKTOR - APP INVIS√çVEL AT√â LOGIN OK */
  #vektorAppRoot.hidden { display: none !important; }
</style>

<style id="vektorSidebarCollapseStyle">

/* =========================
   SIDEBAR COLLAPSE (menu recolh√≠vel)
   ========================= */

#vektorShell.sidebar-collapsed aside{
  width: 72px !important;      /* ‚Äúmodo √≠cones‚Äù */
  padding: 12px !important;
}

#vektorShell.sidebar-collapsed aside h1,
#vektorShell.sidebar-collapsed aside #vektorMenuTitle{
  display: none !important;     /* some o t√≠tulo */
}

/* some o texto e deixa s√≥ o √≠cone */
#vektorShell.sidebar-collapsed .vektor-nav-label{
  display: none !important;
}

/* mant√©m alinhamento bonito no modo recolhido */
#vektorShell.sidebar-collapsed .vektor-nav-btn{
  justify-content: center !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
}

/* evita que o emoji ‚Äúencolha‚Äù */
.vektor-nav-ico{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.5rem;
}

/* no recolhido, centraliza o bot√£o do header */
#vektorShell.sidebar-collapsed #vektorMenuHeader{
  justify-content: center !important;
}

/* garante que ‚ÄúMenu‚Äù n√£o aparece */
#vektorShell.sidebar-collapsed #vektorMenuTitle{
  display: none !important;
}

/* garante que o bot√£o fica centralizado */
#vektorShell.sidebar-collapsed #vektorSidebarToggleBtn{
  margin: 0 auto !important;
}

/* remove qualquer ‚Äúempurr√£o‚Äù do bot√£o */
#vektorShell.sidebar-collapsed #vektorSidebarToggleBtn{
  margin: 0 !important;
}

#vektorShell.sidebar-collapsed #vektorSidebarFooterVersion{
  display: none !important;
}

#vektorMenuHeader{
  position: relative;
}

#vektorMenuTitle{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}

/* Tooltip no menu recolhido */
#vektorShell.sidebar-collapsed aside button{
  position: relative;
}

#vektorShell.sidebar-collapsed aside button:hover::after{
  content: attr(title);
  position: absolute;
  left: calc(100% + 10px);
  top: 50%;
  transform: translateY(-50%);
  white-space: nowrap;

  background: rgba(15,23,42,0.95);
  color: #fff;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 12px;
  line-height: 1.2;
  z-index: 9999;
  pointer-events: none;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
 <body class="text-slate-800">

    <!-- Topbar com login, tipo de acesso, rel√≥gio e banner sazonal -->
<div id="vektor-topbar"
     class="w-full px-6 pt-3 pb-1 text-[11px] text-black leading-tight flex items-start gap-3">

  <!-- ESQUERDA: login + rel√≥gio -->
  <div class="shrink-0">
    <div id="vektor-user-info" class="font-semibold"></div>
    <div id="vektor-clock" class="mt-0.5 font-normal"></div>
  </div>

  <!-- CENTRO: banner (somente quando tiver feriado na regra) -->
  <div id="vektor-holiday-banner"
     class="flex-1 flex items-center justify-center text-center font-extrabold"
     style="display:none; font-size:16px; text-shadow: 0 1px 2px rgba(0,0,0,0.15);  line-height:1.3;">
</div>

  <!-- DIREITA: logout -->
  <div class="shrink-0 flex items-start justify-end">
    <button
      id="vektorLogoutBtn"
      type="button"
      class="text-[11px] font-extrabold px-5 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 transition"
      style="cursor:pointer;"
      title="Sair"
    >
      Logout
    </button>
  </div>

</div>

<!-- =======================
     MODAL LOGIN (OBRIGAT√ìRIO)
     ======================= -->
  <div id="vektorLoginModal" class="fixed inset-0 z-[9999] hidden" style="display:none">

  <!-- T√≠tulo superior (acima do card) -->
<div class="absolute top-10 left-1/2 -translate-x-1/2 w-[95%] max-w-[900px] text-center text-white z-[10020] pointer-events-none">
  <div class="text-[18px] md:text-[22px] font-extrabold tracking-tight drop-shadow-lg">
    Plataforma de Governan√ßa Financeira do Cart√£o Clara
  </div>
</div>

  <!-- camada que ESCONDE 100% de tudo atr√°s -->
  <div class="absolute inset-0 bg-white"></div>

  <!-- camada de escurecimento (visual) -->
  <div class="absolute inset-0 bg-black/60"></div>

  <!-- conte√∫do do modal (CENTRALIZADO DE VERDADE) -->
  <div class="absolute inset-0 flex items-center justify-center">
  <!-- Camada decorativa (logos), atr√°s do card -->
  <div class="absolute inset-0 pointer-events-none">
    <!-- Logo esquerda -->
    <img
      src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b4a49fd8563aa5311a25d23c977061710da8042b/LOGO%20-%20VERDE%2001.png"
      alt=""
      class="absolute left-10 top-1/2 -translate-y-1/2 w-[320px] opacity-45 blur-[1.5px] hidden md:block"
    />

    <img
      src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b4a49fd8563aa5311a25d23c977061710da8042b/LOGO%20-%20VERDE%2001.png"
      alt=""
      class="absolute right-10 top-1/2 -translate-y-1/2 w-[320px] opacity-45 blur-[1.5px] hidden md:block"
    />
  </div>

  <!-- Card do login (fica acima das logos) -->
  <div class="relative w-[95%] max-w-[520px] rounded-2xl bg-white shadow-2xl border border-slate-200 overflow-hidden">

      <!-- Header -->
      <div class="px-6 py-5 bg-[#0b1220] text-white">
        <div class="text-lg font-extrabold">Acesso ao Vektor</div>
        <div class="text-xs opacity-90 mt-1">
          Valida√ß√£o obrigat√≥ria. O e-mail deve ser o mesmo do seu login Google e estar habilitado.
        </div>
      </div>

      <!-- Body -->
        <div class="px-6 py-5">
          <label class="block text-sm font-semibold text-slate-800 mb-2">
            E-mail corporativo
          </label>

          <input
            id="vektorLoginEmail"
            type="email"
            autocomplete="email"
            placeholder="insira seu email aqui"
            class="w-full rounded-xl border border-slate-300 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-slate-900/20"
          />

          <div
            id="vektorLoginError"
            class="hidden mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl px-4 py-3"
          ></div>

          <!-- BOT√ïES (mesmo tamanho, alinhados) -->
          <div class="mt-4 grid grid-cols-2 gap-3">

            <!-- Login com Google -->
            <button
              id="vektorLoginGoogleBtn"
              type="button"
              class="flex items-center justify-center gap-2 h-[48px] rounded-xl border border-slate-300 text-sm font-semibold text-slate-800 hover:bg-slate-50 transition"
            >
              <img
                src="https://raw.githubusercontent.com/rslisboa/cartoesclara/e99ecd5a39c515e09bac6546c9aa5d2324c243c2/google.png"
                alt=""
                class="w-[16px] h-[16px]"
              />
              <span>Login com Google</span>
            </button>

            <!-- Entrar -->
            <button
              id="vektorLoginBtn"
              type="button"
              class="h-[48px] rounded-xl bg-[#005E27] text-white text-sm font-extrabold hover:opacity-95 transition"
            >
              Entrar
            </button>

          </div>

          <div class="mt-3 text-[11px] text-slate-500">
            Se voc√™ n√£o tiver acesso, solicite inclus√£o na whitelist do Vektor.
          </div>
        </div>

    </div>
  </div>
</div>

  <!-- =======================
     OVERLAY MANUTEN√á√ÉO
     ======================= -->
<div id="vektorMaintenanceOverlay" class="fixed inset-0 z-[10050] hidden" style="display:none">
  <!-- fundo (mant√©m o padr√£o branco) -->
  <div class="absolute inset-0 bg-white"></div>

  <!-- conte√∫do central -->
  <div class="absolute inset-0 flex items-center justify-center">
    <div class="w-[95%] max-w-[560px] rounded-2xl bg-white border border-slate-200 shadow-2xl p-6 text-center">
      <div class="text-2xl font-extrabold text-slate-900">Em manuten√ß√£o</div>
      <div class="mt-2 text-sm text-slate-600">
        O Vektor est√° temporariamente indispon√≠vel. Tente novamente mais tarde.
      </div>
    </div>
  </div>
</div>

<script>
/**
 * VEKTOR ‚Äî Single Tab Guard (aba √∫nica)
 * Regra: a aba mais recente toma posse e desativa a anterior.
 * - Usa localStorage (compat√≠vel geral)
 * - Usa BroadcastChannel quando dispon√≠vel (mais r√°pido)
 */
(function vektorSingleTabGuard_(){
  const LOCK_KEY = "VEKTOR_ACTIVE_TAB_LOCK";
  const CHANNEL  = "vektor-single-tab";
  const HEARTBEAT_MS = 5000;     // atualiza "vida" da aba dona
  const STALE_MS = 15000;        // se n√£o bater heartbeat nesse tempo, considera morto
  const TAKEOVER_GRACE_MS = 800; // evita flicker em loads r√°pidos

  // id √∫nico da aba (vive enquanto a aba existir)
  let tabId = "";
  try {
    tabId = sessionStorage.getItem("VEKTOR_TAB_ID") || "";
    if (!tabId) {
      tabId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID()
        : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));
      sessionStorage.setItem("VEKTOR_TAB_ID", tabId);
    }
  } catch (e) {
    // fallback: ainda d√° pra funcionar, s√≥ menos robusto
    tabId = "tab_" + String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  }

  const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(CHANNEL) : null;

  function now_(){ return Date.now(); }

  function safeJsonParse_(s){
    try { return JSON.parse(s); } catch (e) { return null; }
  }

  function readLock_(){
    return safeJsonParse_(localStorage.getItem(LOCK_KEY) || "null");
  }

  function writeLock_(obj){
    localStorage.setItem(LOCK_KEY, JSON.stringify(obj || {}));
  }

  function removeLock_(){
    localStorage.removeItem(LOCK_KEY);
  }

  function isStale_(lock){
    if (!lock || !lock.ts) return true;
    return (now_() - Number(lock.ts || 0)) > STALE_MS;
  }

  function showDisabledOverlay_(title, msg){
    let el = document.getElementById("vektorSingleTabOverlay");
    if (!el) {
      el = document.createElement("div");
      el.id = "vektorSingleTabOverlay";
      el.className = "fixed inset-0 z-[10060]";
      el.style.display = "none";
      el.innerHTML = `
        <div class="absolute inset-0 bg-white"></div>
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="w-[95%] max-w-[560px] rounded-2xl bg-white border border-slate-200 shadow-2xl p-6 text-center">
            <div id="vektorSingleTabOverlayTitle" class="text-2xl font-extrabold text-slate-900"></div>
            <div id="vektorSingleTabOverlayMsg" class="mt-2 text-sm text-slate-600"></div>
            <div class="mt-4 text-[11px] text-slate-500">
              Esta guia foi desativada para evitar m√∫ltiplas sess√µes abertas. Use a guia mais recente.
            </div>
          </div>
        </div>`;
      document.body.appendChild(el);
    }

    el.querySelector("#vektorSingleTabOverlayTitle").textContent = title || "Aba desativada";
    el.querySelector("#vektorSingleTabOverlayMsg").textContent = msg || "";
    el.style.display = "block";
  }

  function hideDisabledOverlay_(){
    const el = document.getElementById("vektorSingleTabOverlay");
    if (el) el.style.display = "none";
  }

  function forceLogoutUI_(reason){
    // 1) tenta clicar no Logout (se existir)
    try {
      const btn = document.getElementById("vektorLogoutBtn");
      if (btn) btn.click();
    } catch (e) {}

    // 2) mostra mensagem no modal de login (se existir)
    try {
      const err = document.getElementById("vektorLoginError");
      if (err) {
        err.classList.remove("hidden");
        err.textContent = reason || "Sess√£o movida para outra aba.";
      }
      const modal = document.getElementById("vektorLoginModal");
      if (modal) modal.style.display = "block";
    } catch (e) {}

    // 3) esconde app root (se existir)
    try {
      const root = document.getElementById("vektorAppRoot");
      if (root) root.classList.add("hidden");
    } catch (e) {}
  }

  function disableThisTab_(lockOwnerId){
    if (window.__vektorTabDisabled) return;
    window.__vektorTabDisabled = true;

    forceLogoutUI_("Voc√™ abriu o Vektor em outra guia. Esta guia foi desativada.");

    showDisabledOverlay_(
      "Esta aba foi desativada",
      "Voc√™ abriu o Vektor em outra guia. Use a guia mais recente."
    );
  }

  function enableThisTab_(){
    if (!window.__vektorTabDisabled) return;
    window.__vektorTabDisabled = false;
    hideDisabledOverlay_();
  }

  function broadcast_(payload){
    try { if (bc) bc.postMessage(payload); } catch (e) {}
  }

  function takeover_(why){
    const ts = now_();
    writeLock_({ tabId, ts });
    broadcast_({ type: "TAKEOVER", tabId, ts, why: why || "" });
  }

  // Regra: SEMPRE que esta aba carregar, ela toma posse (aba mais recente manda).
  // Pequena gra√ßa pra evitar flicker em refresh instant√¢neo.
  setTimeout(function(){
    takeover_("init");
    enableThisTab_();
  }, TAKEOVER_GRACE_MS);

  // Heartbeat: se eu sou dono, atualizo timestamp
  setInterval(function(){
    const lock = readLock_();
    if (lock && lock.tabId === tabId) {
      writeLock_({ tabId, ts: now_() });
    }
  }, HEARTBEAT_MS);

  // Se outra aba tomar posse (localStorage), eu desativo
  window.addEventListener("storage", function(e){
    if (e.key !== LOCK_KEY) return;

    const lock = readLock_();
    if (!lock) return;

    // se eu n√£o sou dono e o lock est√° vivo, desabilita
    if (lock.tabId !== tabId && !isStale_(lock)) {
      disableThisTab_(lock.tabId);
    }
  });

  // BroadcastChannel: resposta mais r√°pida que storage event
  if (bc) {
    bc.onmessage = function(ev){
      const m = ev && ev.data ? ev.data : null;
      if (!m || m.type !== "TAKEOVER") return;

      if (m.tabId !== tabId) {
        // algu√©m tomou posse
        const lock = readLock_();
        if (lock && lock.tabId !== tabId && !isStale_(lock)) {
          disableThisTab_(lock.tabId);
        }
      }
    };
  }

  // Se eu fechar e eu era dono, removo lock (boa pr√°tica; heartbeat j√° cobre queda)
  window.addEventListener("beforeunload", function(){
    const lock = readLock_();
    if (lock && lock.tabId === tabId) {
      removeLock_();
      broadcast_({ type: "RELEASE", tabId, ts: now_() });
    }
  });

  // Export (debug manual)
  window.vektorSingleTabTakeover = function(){
    takeover_("manual");
    enableThisTab_();
  };
})();
</script>

 <div id="vektorAppRoot" class="hidden">
 <div id="vektorShell" class="h-screen flex px-4 py-6 gap-4 items-stretch overflow-hidden">
   <!-- COLUNA ESQUERDA: MENU LATERAL -->
   
  <aside class="hidden md:flex w-72 shrink-0 flex-none flex-col bg-white rounded-xl shadow-lg border border-slate-200 p-4 self-stretch min-h-0">

  <!-- Bloco Vektor + t√≠tulo -->
  <div class="w-full flex flex-col items-center mb-4">
    <h1 class="text-xl font-extrabold bg-[#005E27] text-[#B5FF20] px-3 py-2 rounded-lg text-center">
      Grupo SBF | Vektor
    </h1>
  </div>

  <!-- Header do menu: t√≠tulo + recolher -->
<div id="vektorMenuHeader" class="w-full mb-1 flex items-center justify-between">
  <p id="vektorMenuTitle" class="text-base font-semibold text-black m-0">Menu</p>

  <button
    id="vektorSidebarToggleBtn"
    type="button"
    class="w-9 h-9 inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition"
    title="Recolher/Expandir menu"
    aria-label="Recolher/Expandir menu"
    style="cursor:pointer;"
  >
    <!-- √≠cone simples -->
    <span id="vektorSidebarToggleIcon" style="font-size:18px; line-height:1;">‚´∑</span>
  </button>
</div>

 <!-- Conte√∫do rol√°vel do menu (bot√µes) -->
<div class="flex-1 min-h-0 overflow-y-auto space-y-3.5 pb-2.5">

  <!-- Apresenta√ß√£o Vektor desativada -->
  <!-- Relat√≥rio Clara (Looker Studio) desativado -->

  <button
    id="navChatBtn"
    type="button"
    onclick="window.vektorShowChatView()"
    title="Chat"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">üí¨</span>
    <span class="vektor-nav-label">Chat</span>
  </button>

  <button
    type="button"
    onclick="openStatusVektorModal()"
    title="Estado Operacional"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">üü¢</span>
    <span class="vektor-nav-label">Estado Operacional</span>
  </button>

  <button
    type="button"
    onclick="window.vektorOpenResumoCiclo()"
    title="Resumo do Ciclo"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">üìå</span>
    <span class="vektor-nav-label">Resumo do Ciclo</span>
  </button>

  <button
    type="button"
    onclick="window.vektorOpenFluxograma()"
    title="Fluxograma"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">üß©</span>
    <span class="vektor-nav-label">Fluxograma</span>
  </button>

  <button
    type="button"
    onclick="window.vektorOpenMyAlerts()"
    title="Alertas Programados"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">‚è±Ô∏è</span>
    <span class="vektor-nav-label">Alertas Programados</span>
  </button>

  <? if ((userRole || "") === "Administrador") { ?>

    <button
      type="button"
      onclick="openAlertasRecentesModal()"
      title="Disparo de Ocorr√™ncias"
      class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
    >
      <span class="vektor-nav-ico" aria-hidden="true">üìã</span>
      <span class="vektor-nav-label">Disparo de Ocorr√™ncias</span>
    </button>

    <button
      type="button"
      onclick="window.vektorOpenRadar('7d')"
      title="Radar de Irregularidade"
      class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
    >
      <span class="vektor-nav-ico" aria-hidden="true">üìà</span>
      <span class="vektor-nav-label">Radar de Irregularidade</span>
    </button>

    <button
      type="button"
      onclick="window.vektorOpenEnvioPendencias()"
      title="Envio de Pend√™ncias"
      class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
    >
      <span class="vektor-nav-ico" aria-hidden="true">üì©</span>
      <span class="vektor-nav-label">Envio de Pend√™ncias</span>
    </button>

  <? } ?>

</div>

  <!-- Rodap√© do menu: Vers√£o do Vektor -->
<div id="vektorSidebarFooterVersion" class="mt-4 px-3 py-3 text-center border-t border-slate-200">
  <div class="text-[11px] text-slate-500 leading-tight">
    Vektor v1.6.0<br>
    <span class="text-slate-400">Build 12/01/2026</span>
  </div>
</div>
  
</aside>
 
   <!-- COLUNA DIREITA: CHAT -->
   <div class="flex-1 min-w-0 min-h-0" style="position:relative; overflow:hidden;">
     <div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
  <div class="chat-header-inner">
    <div class="chat-header-left">
      <div class="examples"></div>
      <div class="policy-note text-[12px] mt-2"></div>
    </div>
  </div>
</header>

<!-- HOME (aparece ao carregar o sistema) -->
<div id="homeView"
     style="position:absolute; inset:0; display:flex; flex-direction:column;
            opacity:0; filter:blur(10px);
            transition:opacity 900ms ease, filter 900ms ease;">
    <img
    id="homeHeroImg"
    src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b4a53c6c2516825897ee0080048ddab3f57c0964/sys_vek_2.png"
    alt="Vektor"
    style="width:100%; height:100%; object-fit:cover; display:block;"
  />
</div>

<!-- BODY -->
<div id="chatView" class="hidden" style="height:100%; display:none; flex-direction:column; min-height:0;">
  <main class="chat-body">
    <div id="chatWindow" class="chat-window">

      <!-- Mensagem inicial do bot -->
      <div class="flex items-start gap-3">
        <img
          src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
          alt="Assistente Clara (rob√¥)"
          class="h-16 w-auto object-contain flex-shrink-0"
        />
        <div class="bot-bubble px-4 py-3 max-w-[80%] text-slate-700">
          <p id="vektorGreeting" class="text-slate-800 text-base">
          </p>
          
        </div>
      </div>

    </div> <!-- fecha #chatWindow -->
  </main> <!-- fecha .chat-body -->

<!-- FOOTER / INPUT (AGORA DENTRO DO chatView) -->
  <footer class="chat-footer">
    <form id="chatForm" class="w-full">
      <div class="input-shell">
        <textarea id="userInput" placeholder="Digite aqui."></textarea>

        <!-- AUTOCOMPLETE VEKTOR -->
        <div id="vektor-autocomplete-box"></div>

        <!-- Bot√£o de anexo do Termo -->
        <button
          type="button"
          id="attachBtn"
          title="Anexar"
          class="ml-1 px-2 py-2 rounded-md border border-slate-300 text-sm flex items-center justify-center bg-transparent"
        >
          <svg xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 24 24" stroke-width="2"
            stroke="#0f172a" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 12.79V9a6 6 0 10-12 0v7a4 4 0 008 0v-6a2 2 0 00-4 0v5"/>
          </svg>
        </button>

        <!-- Bot√£o Enviar -->
        <button type="submit" id="sendBtn">Enviar</button>

        <!-- Input de arquivo escondido (Termo) -->
        <input
          type="file"
          id="fileTermo"
          accept=".pdf,.jpg,.jpeg,.png,.heic,.HEIC"
          class="hidden"
        />
      </div>
    </form>
  </footer>
</div> <!-- fecha #chatView -->

<!-- VIEW: RESUMO DO CICLO -->
<div id="cicloResumoView"
     class="hidden"
     style="position:absolute; inset:0; z-index:20; display:none;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column; min-height:0;">

      <!-- Header (t√≠tulo/sub + filtros) -->
      <div style="padding:14px 16px; background:#0b1220; border-bottom:1px solid rgba(148,163,184,0.18);">
        <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:14px; flex-wrap:wrap;">

          <!-- Esquerda: t√≠tulo + subt√≠tulo -->
          <div style="min-width:240px;">
            <div style="font-size:18px;font-weight:1000;color:#fff;line-height:1.1;">Resumo do ciclo</div>
            <div id="cicloResumoSubTitle"
                 style="margin-top:5px;font-size:12px;font-weight:800;color:rgba(226,232,240,0.8);">
              Consolidado das pend√™ncias no ciclo atual, considerando transa√ß√µes com status <b>Autorizada</b>.
            </div>
          </div>

          <!-- Direita: filtros -->
          <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;">

            <!-- Per√≠odo -->
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Per√≠odo</div>

              <!-- ‚úÖ APENAS 1 BLOCO DE CALEND√ÅRIO (n√£o duplique IDs) -->
              <div style="display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid rgba(226,232,240,0.45); border-radius:12px; background:rgba(226,232,240,0.85);">
                <input id="cicloResumo_dtIni" type="date"
                       style="border:none; outline:none; background:rgba(255,255,255,0.06); border-radius:10px; padding:4px 8px; color:#000000; font-weight:800; font-size:12px;" />
                <span style="opacity:0.65;">‚Äî</span>
                <input id="cicloResumo_dtFim" type="date"
                       style="border:none; outline:none; background:rgba(255,255,255,0.06); border-radius:10px; padding:4px 8px; color:#000000; font-weight:800; font-size:12px;" />
              </div>
            </div>

            <!-- Time -->
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Time</div>
              <select id="cicloResumo_selTime"
                      style="height:34px;border-radius:12px;background:#0f172a;color:#fff;border:1px solid rgba(181,255,32,0.35);padding:0 10px;font-weight:900;font-size:12px;min-width:180px;">
                <option value="">Todos</option>
              </select>
            </div>

            <!-- Loja -->
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Loja</div>
              <select id="cicloResumo_selLoja"
                      style="height:34px;border-radius:12px;background:#0f172a;color:#fff;border:1px solid rgba(181,255,32,0.35);padding:0 10px;font-weight:900;font-size:12px;min-width:180px;">
                <option value="">Todas</option>
              </select>
            </div>

           <button id="cicloResumo_btnLimpar" type="button"
              onclick="window.vektorResumoCicloLimparFiltros && window.vektorResumoCicloLimparFiltros()"
              style="height:34px;border-radius:12px;padding:0 14px;background:transparent;color:#B5FF20;border:1px solid rgba(181,255,32,0.45);font-weight:1000; font-size: 12px; cursor:pointer;">
                    Limpar
                  </button>

            <button id="cicloResumo_btnAtualizar" type="button"
                    onclick="window.vektorLoadResumoCiclo && window.vektorLoadResumoCiclo(true)"
                    style="height:34px;border-radius:12px;padding:0 14px;background:rgba(255,255,255,0.06);color:#fff;border:1px solid rgba(255,255,255,0.18);font-weight:1000; font-size: 12px; cursor:pointer;">
              Atualizar
            </button>

                      <button id="cicloResumo_aiBtn" type="button"
                          style="
                            height:34px;
                            padding:0 14px;
                            border-radius:12px;
                            border:1px solid rgba(181,255,32,0.55);
                            background: linear-gradient(180deg, rgba(22,163,74,0.55), rgba(0,94,39,0.55));
                            font-weight:1000;
                            font-size: 12px;
                            color:#ffffff;
                            box-shadow:0 10px 22px rgba(0,0,0,0.18);
                            cursor:pointer;
                            white-space:nowrap;
                          ">
                          An√°lise do Ciclo
                        </button>

          </div>
        </div>
      </div>

      <!-- Conte√∫do -->
      <div class="cicloResumoPage" style="flex:1; min-height:0; overflow:auto; background:#fff; padding:14px 16px;">
        
        <div id="cicloResumoContent" style="display:none;">

          <!-- Cards (mant√©m layout ‚Äúcomo era‚Äù ‚Äì cards em cima) -->
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:stretch;">
            <div class="cicloCard">
              <div class="cicloCardLabel">üè¨ Lojas com pend√™ncias</div>
              <div id="cicloResumo_totalLojas" class="cicloCardValue">‚Äî</div>
            </div>

            <!-- ‚úÖ sem clique -->
            <div class="cicloCard" id="cicloResumo_cardTotalPend" style="cursor:default;">
              <div class="cicloCardLabel">üßæ Qtde de pend√™ncias</div>
              <div id="cicloResumo_totalPend" class="cicloCardValue">‚Äî</div>
            </div>

            <div class="cicloCard">
              <div class="cicloCardLabel">üí∞ Valor pendente</div>
              <div id="cicloResumo_totalValor" class="cicloCardValue">‚Äî</div>
            </div>

            <!-- ‚úÖ sem clique -->
            <div class="cicloCard" id="cicloResumo_cardTopTime" style="cursor:default;">
              <div class="cicloCardLabel">üèÜ Top time (mais pend√™ncias)</div>
              <div id="cicloResumo_topTime" class="cicloCardValue">‚Äî</div>
              <div id="cicloResumo_topTimeSub" class="cicloCardSub">‚Äî</div>
            </div>

            <div class="cicloCard">
              <div class="cicloCardLabel">üî• Top loja (mais pend√™ncias)</div>
              <div id="cicloResumo_topLoja" class="cicloCardValue">‚Äî</div>
              <div id="cicloResumo_topLojaSub" class="cicloCardSub">‚Äî</div>
            </div>

          </div>

          <!-- Tabela (transa√ß√µes detalhadas / filtradas) -->
         <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 8px 0;">
            <div style="font-weight:1000; font-size:13px;">
              Transa√ß√µes pendentes (detalhado) ‚Äî ordene clicando no cabe√ßalho
            </div>

            <button id="cicloResumo_btnCsv"
              style="border:none; cursor:pointer; border-radius:10px; padding:6px 10px; font-weight:900;
                    font-size:12px; background:#0f172a; color:#fff; border:1px solid rgba(148,163,184,0.35);">
              Exportar CSV
            </button>

          </div>

            <!-- wrapper com scroll vertical + horizontal -->
            <div id="cicloResumoTableWrap"
                 style="margin-top:10px; overflow:auto; max-height:520px; border-radius:12px; border:2px solid #000; background:#fff;">

              <table id="cicloResumoTable"
                     style="width:max-content; min-width:100%; border-collapse:separate; border-spacing:0; font-size:13px; color:#000; background:#fff;">
                <thead>
                  <tr>
                    <th data-sort="loja"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Loja
                    </th>

                    <th data-sort="time"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Time
                    </th>

                    <th data-sort="dataISO"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Data da transa√ß√£o
                    </th>

                    <th data-sort="estabelecimento"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Estabelecimento
                    </th>

                    <th data-sort="valor"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:right; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Valor
                    </th>

                    <th data-sort="categoria"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Categoria
                    </th>

                    <th data-sort="pendencias"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Pend√™ncias
                    </th>
                  </tr>
                </thead>

                <tbody id="cicloResumo_tbody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <!-- ‚úÖ OVERLAY IA: FORA da tabela e FORA do grid (n√£o quebra layout) -->
      <div id="cicloResumoAI" style="display:none; position:fixed; inset:0; z-index:120; background:rgba(2,6,23,0.55);">
        <div style="position:absolute; left:50%; top:12vh; transform:translateX(-50%);
                    width:min(920px, 94vw); border-radius:18px; overflow:hidden;
                    border:1px solid rgba(148,163,184,0.55);
                    box-shadow:0 22px 60px rgba(0,0,0,0.35);">
          <div style="background:#0b1220; color:#fff; padding:14px 16px; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:1000;">An√°lise do Ciclo</div>
            <button id="cicloResumoAIClose" type="button"
              style="background:rgba(255,255,255,0.12); padding:8px 12px; border-radius:12px; font-weight:900; color:#fff; border:1px solid rgba(255,255,255,0.18); cursor:pointer;">
              Fechar
            </button>
          </div>
          <div id="cicloResumoAIBody" style="background:#fff; padding:14px 16px; color:#0f172a;">
            <!-- preenchido via JS -->
          </div>
        </div>
      </div>

      <!-- OVERLAY (bloqueia tela) - Resumo do Ciclo -->
<div id="cicloResumo_overlay"
     style="display:none; position:absolute; inset:0; z-index:110; background:rgba(0,0,0,0.65);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
    <div style="width:min(520px, 92vw); background:#0b1220; border:1px solid rgba(148,163,184,0.22);
                border-radius:16px; padding:18px; box-shadow:0 18px 46px rgba(0,0,0,0.55); text-align:center;">
      <div style="display:flex; justify-content:center; margin-bottom:12px;">
        <div class="envPend_spinner"></div>
      </div>
      <div id="cicloResumo_overlayTitle" style="color:#fff; font-weight:1000; font-size:16px;">Carregando‚Ä¶</div>
      <div id="cicloResumo_overlaySub" style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:6px;">
        Aguarde um instante.
      </div>
    </div>
  </div>
</div>

    </div>
  </main>
</div>

<!-- VIEW: ENVIO DE PEND√äNCIAS (sobrep√µe SOMENTE a √°rea do chat) -->
<div id="envioPendView" class="hidden" style="position:absolute; inset:0; z-index:20;">
  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Envio de Pend√™ncias</div>
            <div style="color:rgba(226,232,240,0.85); font-size:12px; margin-top:2px;">
              Pr√©via + sele√ß√£o (checkbox) + rastreabilidade (envio √∫nico por transa√ß√£o)
            </div>
          </div>
        </div>

        <!-- Modal: Como funciona a an√°lise? (Envio de Pend√™ncias) -->
<div id="envPendAnaliseModal"
     class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[920px] overflow-hidden border border-slate-200">

    <!-- Header -->
    <div class="px-5 py-4 text-white flex items-center justify-between"
         style="background:#005E27;">
      <div>
        <div class="text-base font-extrabold">Como funciona a an√°lise (Envio de Pend√™ncias)</div>
        <div class="text-xs opacity-90">
          Tutorial r√°pido do fluxo: pr√©via ‚Üí sele√ß√£o ‚Üí envio ‚Üí rastreabilidade
        </div>
      </div>

      <button type="button"
              onclick="closeEnvPendAnaliseModal()"
              class="transition rounded-lg px-3 py-2 text-sm font-semibold"
              style="background:rgba(255,255,255,0.18);">
        Fechar
      </button>
    </div>

    <!-- Faixa destaque -->
    <div style="height:6px; background:#B5FF20;"></div>

    <!-- Body -->
    <div class="p-5 text-sm text-slate-800 space-y-4 max-h-[72vh] overflow-y-auto">

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">1) O que a p√°gina analisa</div>
        <div class="mt-2">
          O Vektor l√™ a <b>base de transa√ß√µes da Clara</b> no per√≠odo selecionado (Data inicial / Data final) e identifica transa√ß√µes com:
          <ul class="list-disc ml-5 mt-2 space-y-1">
            <li><b>Status de aprova√ß√£o = Recusada</b></li>
            <li>Pend√™ncias de justificativa: <b>NF/Recibo</b>, <b>Etiqueta</b>, <b>Descri√ß√£o</b> e/ou <b>NF/Recibo divergente</b> - Para essa pendencia de diverg√™cnia na nota fiscal, ser√° identificado sempre que houver no momento da recusa da transa√ß√£o a informa√ß√£o de: <i>NF/Recibo divergente</i>, ou seja, √© necess√°rio colocar essa chave de texto para identifica√ß√£o da pend√™ncia.</li>
          </ul>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">2) Bot√£o ‚ÄúGerar pr√©via‚Äù</div>
        <div class="mt-2">
          Monta a lista de transa√ß√µes eleg√≠veis, calcula m√©tricas (quantidade, lojas, valor total, distribui√ß√£o por tipo),
          e prepara a tabela de revis√£o.
        </div>
        <div class="mt-3 rounded-lg p-3" style="background:rgba(0,94,39,0.06); border:1px solid rgba(0,94,39,0.15);">
          <div class="font-extrabold" style="color:#005E27;">Dica</div>
          <div class="mt-1">
            Se o per√≠odo for grande, a pr√©via pode demorar mais. Prefira rodar por semana/datas focadas quando poss√≠vel.
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">3) Bot√£o ‚ÄúRevisar linhas‚Äù (checkbox)</div>
        <div class="mt-2">
          Abre o modal com a lista detalhada e permite <b>desmarcar</b> transa√ß√µes espec√≠ficas para n√£o enviar naquele disparo.
        </div>
        <ul class="list-disc ml-5 mt-2 space-y-1">
          <li>Por padr√£o, o sistema marca o que <b>ainda n√£o foi enviado</b>.</li>
          <li>Transa√ß√µes j√° enviadas aparecem como <b>bloqueadas</b> (n√£o devem ser reenviadas).</li>
        </ul>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">4) Bot√£o ‚ÄúEnviar selecionadas‚Äù</div>
        <div class="mt-2">
          Envia e-mails agrupados por <b>Loja</b> (e data, quando aplic√°vel) apenas para as linhas selecionadas.
          Ap√≥s o envio, as transa√ß√µes s√£o registradas no hist√≥rico de rastreabilidade para <b>n√£o serem reenviadas</b>.
        </div>
        <div class="mt-3 rounded-lg p-3"
             style="background:rgba(181,255,32,0.22); border:1px solid rgba(0,94,39,0.18);">
          <div class="font-extrabold" style="color:#0b1220;">Regra cr√≠tica</div>
          <div class="mt-1">
            <b>Cada transa√ß√£o deve ser enviada uma √∫nica vez.</b> O controle √© feito por chave/hash da transa√ß√£o.
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">5) Feedback de envio</div>
        <div class="mt-2">
          A p√°gina exibe o status do disparo e lista:
          <ul class="list-disc ml-5 mt-2 space-y-1">
            <li><b>Enviados</b>: lojas que receberam e-mail e quantidade de transa√ß√µes</li>
            <li><b>Falhas</b>: lojas que n√£o foi poss√≠vel enviar (ex.: e-mail ausente, erro de servi√ßo)</li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Popup central: gr√°fico de valores por loja (Envio de Pend√™ncias) -->
<div id="envPendLojasPopup"
     style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.72);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
    <div style="
      width:min(980px, 96vw);
      max-height:min(78vh, 820px);
      background:#f8fafc;
      border:1px solid rgba(148,163,184,0.22);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    ">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(148,163,184,0.18);">
  <!-- Esquerda -->
  <div style="min-width:0;">
    <!-- Linha 1: t√≠tulo + filtro -->
    <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
      <div style="color:#0b1220; font-weight:1000; font-size:14px; white-space:nowrap;">
        Pend√™ncias recusadas ‚Äî Valor por loja
      </div>

      <div style="display:flex; align-items:center; gap:8px;">
        <div style="color:rgba(15,23,42,0.75); font-size:12px; font-weight:900; white-space:nowrap;">
          Filtrar por Time
        </div>

        <select id="envPendLojasTimeFilter"
          style="height:34px; border-radius:10px; background:#ffffff; color:#0b1220;
                 border:1px solid rgba(15,23,42,0.18); padding:0 10px; font-weight:900; font-size:12px; min-width:180px;">
          <option value="">Todos</option>
        </select>
      </div>
    </div>

    <!-- Linha 2: per√≠odo -->
    <div id="envPendLojasPopupSub" style="color:rgba(15,23,42,0.75); font-size:12px; margin-top:2px;"></div>
  </div>

  <!-- Direita: bot√£o fechar -->
  <button type="button"
    onclick="window.vektorEnvPendLojasPopupClose_()"
    style="background:#005E27;color:#fff;border:none;padding:8px 14px;border-radius:12px;font-weight:900;cursor:pointer;">
    Fechar
  </button>
</div>

      <!-- Scroll vertical quando tiver muitas lojas -->
      <div style="padding:12px 14px; overflow:auto;">
        <canvas id="envPendLojasChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div id="envPend_distOverlay"
     style="position:fixed; inset:0; display:none; z-index:99998;">
  <div id="envPend_distOverlayBg"
       style="position:absolute; inset:0; background:rgba(15,23,42,0.55);"></div>

  <div id="envPend_distOverlayCard"
       style="
         position:absolute;
         left:50%; top:50%;
         transform:translate(-50%,-50%);
         width:min(980px, 92vw);
         max-height:min(640px, 82vh);
         background:#ffffff;
         border-radius:18px;
         border:1px solid rgba(15,23,42,0.18);
         box-shadow:0 18px 50px rgba(0,0,0,0.35);
         padding:14px 14px 12px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div style="font-weight:1000; color:#0f172a;">Distribui√ß√£o de pend√™ncias por loja</div>
      <button type="button"
              id="envPend_distOverlayClose"
              style="height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,94,39,0.35); background:#005E27; color:#fff; font-weight:900; font-size:12px; cursor:pointer;">
        Fechar
      </button>
    </div>

    <div style="margin-top:6px; color:#334155; font-size:12px;">
      Cada barra soma 100% (composi√ß√£o por tipo de pend√™ncia dentro da loja).
    </div>

    <div id="envPend_distOverlayBody"
         style="margin-top:10px; overflow:auto; max-height:calc(82vh - 120px); padding-right:6px;">
    </div>

    <div style="margin-top:10px; display:flex; gap:14px; flex-wrap:wrap; font-size:12px; color:#334155;">
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#005E27;margin-right:6px;"></span>NF/Recibo</div>
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#0ea5e9;margin-right:6px;"></span>Etiqueta</div>
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#a855f7;margin-right:6px;"></span>Descri√ß√£o</div>
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#f59e0b;margin-right:6px;"></span>NF divergente</div>
    </div>
  </div>
</div>

<!-- Bot√£o central: Como funciona a an√°lise? -->
        <div style="flex:1; display:flex; justify-content:center; align-items:center; padding:0 10px;">
          <button
            type="button"
            onclick="openEnvPendAnaliseModal()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:1px solid rgba(255,255,255,0.22);
              background:rgba(255,255,255,0.86);
              color:#0b1220;
              font-weight:900;
              font-size:12px;
              cursor:pointer;
              box-shadow:0 10px 22px rgba(0,0,0,0.18);
            ">
            Como funciona a an√°lise?
          </button>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" onclick="window.vektorEnvioPendenciasPreview()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
            Gerar pr√©via
          </button>

          <button type="button" onclick="window.vektorEnvioPendenciasAbrirModal()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(59,130,246,0.35); background:rgba(59,130,246,0.15); color:#fff; font-weight:900; font-size:12px;">
            Revisar linhas
          </button>

          <button
            id="envPend_btnEnviarSelecionadas"
            type="button"
            onclick="window.vektorEnvioPendenciasEnviarSelecionadas()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:none;
              background:#B5FF20;
              color:#0b1f3a;
              font-weight:900;
              font-size:12px;
              cursor:pointer;
            ">
            Enviar selecionadas
          </button>

        </div>
      </div>

      <!-- Conte√∫do -->
      <div style="flex:1; overflow:auto; background:#070b14; padding:14px 16px;">
        <!-- filtros -->
        <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
            <div style="display:flex; flex-direction:column; gap:4px;">
              <label style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900;">Data inicial</label>
              <input id="envPend_ini" type="date"
                style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
            </div>

            <div style="display:flex; flex-direction:column; gap:4px;">
              <label style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900;">Data final</label>
              <input id="envPend_fim" type="date"
                style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
            </div>

           <div id="envPend_statusText"
              style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:800; white-space:nowrap;">
          </div>

          <div id="envPend_statusCards"
              style="margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; justify-content:flex-end;">
          </div>
          </div>
        </div>

        <!-- resumo -->
        <div class="mt-3" style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
          <div style="color:#fff; font-weight:900; font-size:14px;">Resumo</div>
          <div id="envPend_resumo" style="margin-top:8px; color:rgba(226,232,240,0.85); font-size:12px;">
            Gere uma pr√©via para ver o resumo.
          </div>
          <div id="envPend_falhas" style="margin-top:10px;"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- OVERLAY (bloqueia tela) - Envio de Pend√™ncias -->
<div id="envPend_overlay" style="display:none; position:absolute; inset:0; z-index:90; background:rgba(0,0,0,0.65);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
    <div style="width:min(520px, 92vw); background:#0b1220; border:1px solid rgba(148,163,184,0.22); border-radius:16px; padding:18px; box-shadow:0 18px 46px rgba(0,0,0,0.55); text-align:center;">
      <div style="display:flex; justify-content:center; margin-bottom:12px;">
        <div class="envPend_spinner"></div>
      </div>
      <div id="envPend_overlayTitle" style="color:#fff; font-weight:1000; font-size:16px;">Carregando‚Ä¶</div>
      <div id="envPend_overlaySub" style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:6px;">Aguarde um instante.</div>
    </div>
  </div>
</div>

<!-- MODAL: Revisar pr√©-listagem (checkbox) -->
<div id="envPendModal" class="hidden" style="position:absolute; inset:0; z-index:60; background:rgba(0,0,0,0.55);">
  <div style="position:absolute; inset:22px; background:#0b1220; border:1px solid rgba(148,163,184,0.25); border-radius:16px; overflow:hidden; display:flex; flex-direction:column;">
    <div style="padding:12px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(148,163,184,0.18);">
      <div style="color:#fff; font-weight:900;">Revisar linhas (desmarque o que n√£o deve ir)</div>
      <div style="display:flex; gap:8px;">
          <button type="button" onclick="window.vektorEnvPendExportCsv()"
          style="height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          Exportar CSV
        </button>
        <button type="button" onclick="window.vektorEnvPendSelectAll(true)"
          style="height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          Marcar tudo
        </button>
        <button type="button" onclick="window.vektorEnvPendSelectAll(false)"
          style="height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          Desmarcar tudo
        </button>
        <button type="button" onclick="window.vektorEnvioPendenciasFecharModal()"
          style="height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(248,113,113,0.35); background:rgba(248,113,113,0.12); color:#fff; font-weight:900;font-size:12px;">
          Fechar
        </button>
      </div>
    </div>

    <div style="padding:12px 14px; flex:1; overflow:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:12px; color:rgba(226,232,240,0.9);">
        <thead>
          <tr>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Enviar</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Loja</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Data Transa√ß√£o</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Estabelecimento</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Valor</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Cart√£o</th>
            <th style="position:sticky; top:0; background:#ef4444; color:#fff; padding:8px; text-align:left;">Pend√™ncias</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">J√° enviado?</th>
          </tr>
        </thead>
        <tbody id="envPend_tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- VIEW: RADAR (sobrep√µe SOMENTE a √°rea do chat) -->
<div id="radarView" class="hidden" style="position:absolute; inset:0; z-index:20;">

    <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
      <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header do Radar -->
        <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
          <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Radar de Irregularidade</div>
           <div id="radarSubTitle" style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
            Correla√ß√£o entre m√©tricas + ranking de proximidade por loja
          </div>
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="radarBtnItens" type="button" onclick="window.vektorToggleRadarItensIrregulares()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.25);
                  background:#fde68a; color:#111827; font-weight:1000; font-size:12px;
                  margin-right:18px;">
            Itens Irregulares
          </button>
         <button id="radarBtn7d" type="button" onclick="window.vektorOpenRadar('7d')"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            7 dias
          </button>

          <button id="radarBtnCiclo" type="button" onclick="window.vektorOpenRadar('ciclo')"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            Ciclo
          </button>

          <button id="radarBtnFull" type="button" onclick="window.vektorOpenRadar('full')"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            Base toda
          </button>

          <button
          id="radarBtnComoAnalise"
            type="button"
            onclick="openRadarAnaliseModal()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            Como acontece a an√°lise?
          </button>

        </div>
      </div>

      <!-- Conte√∫do -->
      <div style="flex:1; overflow:auto; background:#070b14; padding:14px 16px;">
        <div id="radarLoading" style="display:none; color:rgba(226,232,240,0.9); font-size:13px; font-weight:700;">
          Carregando dados do Radar...
        </div>

        <!-- ‚úÖ NOVA VIS√ÉO: ITENS IRREGULARES (substitui o radar tradicional quando ativo) -->
<div id="radarItensView" style="display:none;">

  <!-- Filtros -->
  <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Data inicial</div>
        <input id="itensIrregDtIni" type="date"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22); background:rgba(255,255,255,0.06); color:#fff; font-weight:800; font-size:12px;">
      </div>

      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Data final</div>
        <input id="itensIrregDtFim" type="date"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22); background:rgba(255,255,255,0.06); color:#fff; font-weight:800; font-size:12px;">
      </div>

      <div style="min-width:260px; flex:1;">
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Item comprado (cont√©m)</div>
        <input id="itensIrregItemQ" type="text" placeholder="Ex.: √°gua, impress√£o, pilha..."
          style="height:36px; width:100%; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22); background:rgba(255,255,255,0.06); color:#fff; font-weight:800; font-size:12px;">
      </div>

            <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">&nbsp;</div>
        <button type="button" onclick="window.vektorLoadRadarItensIrregulares()"
          style="height:36px; padding:0 14px; border-radius:10px;
                display:inline-flex; align-items:center; justify-content:center;
                border:1px solid rgba(0,0,0,0.25);
                background:#7CFC00; color:#111827; font-weight:1000; font-size:12px;">
          Atualizar
        </button>
      </div>

      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Conformidade</div>
        <select id="itensIrregConf" onchange="window.vektorLoadRadarItensIrregulares()"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22);
                background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          <option value="" selected>Todos</option>
          <option value="OK">OK</option>
          <option value="REVISAR">REVISAR</option>
          <option value="ALERTA">ALERTA</option>
        </select>
      </div>

      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Gr√°fico por</div>
        <select id="itensIrregGroupBy" onchange="window.vektorLoadRadarItensIrregulares()"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22);
                background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          <option value="loja" selected>Loja</option>
          <option value="time">Time</option>
        </select>
      </div>

      <div style="display:flex; gap:8px; margin-left:auto; flex-wrap:wrap;">

        <button type="button" onclick="window.vektorExportRadarItensIrregularesCSV()"
          style="height:36px; padding:0 14px; border-radius:10px;
                display:inline-flex; align-items:center; justify-content:center;
                border:1px solid rgba(255,255,255,0.18);
                background:rgba(255,255,255,0.06); color:#fff; font-weight:1000; font-size:12px;">
          Exportar CSV
        </button>

        <button type="button" onclick="window.vektorOpenItensIrregDetalhamentoModal()"
          style="height:36px; padding:0 14px; border-radius:10px;
                display:inline-flex; align-items:center; justify-content:center;
                border:1px solid rgba(181,255,32,0.30);
                background:rgba(181,255,32,0.10); color:#B5FF20; font-weight:1000; font-size:12px;">
          Ver detalhamento
        </button>

      </div>
      </div>
      </div>

  <!-- KPIs -->
  <div style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin-top:12px;">
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Itens (total)</div>
      <div id="itensIrregKpiTotal" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">‚Äî</div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Valor (total)</div>
      <div id="itensIrregKpiValor" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">‚Äî</div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">ALERTA (qtd)</div>
      <div id="itensIrregKpiAlertas" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">‚Äî</div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">ALERTA (% valor)</div>
      <div id="itensIrregKpiPctAlertas" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">‚Äî</div>
    </div>
  </div>

  <!-- Agrega√ß√µes + gr√°fico -->
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:#fff; font-weight:1000; font-size:14px;">Por Loja (valor + %)</div>
      <div id="itensIrregAggLoja" style="margin-top:10px;"></div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:#fff; font-weight:1000; font-size:14px;">Por Time (valor + %)</div>
      <div id="itensIrregAggTime" style="margin-top:10px;"></div>
    </div>
  </div>

  <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px; margin-top:12px;">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
      <div>
        <div style="color:#fff; font-weight:1000; font-size:14px;">ALERTA ‚Äî quantidade por <span id="itensIrregChartLabel">Loja</span></div>
        <div style="color:rgba(226,232,240,0.7); font-size:12px; margin-top:2px;">Somente itens com conformidade ALERTA.</div>
      </div>
    </div>
    <div id="itensIrregChart" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
  </div>

</div>

<!-- MODAL: Detalhamento de Itens Irregulares -->
<div id="itensIrregDetalhamentoModal"
  style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.65); backdrop-filter: blur(6px);">

  <div style="position:absolute; inset:40px; max-width:1200px; margin:0 auto;
              background:rgba(15,23,42,0.92);
              border:1px solid rgba(148,163,184,0.22);
              border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,0.55);
              display:flex; flex-direction:column; overflow:hidden;">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px;
                border-bottom:1px solid rgba(148,163,184,0.18);
                background:rgba(255,255,255,0.04);">
      <div>
        <div style="color:#fff; font-weight:1000; font-size:14px;">Detalhamento ‚Äî Itens Irregulares</div>
        <div style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:2px;">
          Data, Valor, Loja, Time, Item, Conformidade e Motivo.
        </div>
      </div>

      <button type="button" onclick="window.vektorCloseItensIrregDetalhamentoModal()"
        style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
               background:rgba(255,255,255,0.06); color:#fff; font-weight:1000; font-size:12px; cursor:pointer;">
        Fechar
      </button>

    </div>

    <!-- Filtros (LOCAL, sem recarregar backend) -->
<div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; padding:12px 14px;
            border-bottom:1px solid rgba(148,163,184,0.18);">

  <!-- Loja -->
  <div style="display:flex; flex-direction:column; gap:6px; min-width:160px;">
    <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Loja</div>
    <select id="itensIrregDetFiltroLoja"
      style="height:34px; border-radius:10px; padding:0 10px;
             background:rgba(255,255,255,0.06); border:1px solid rgba(148,163,184,0.18);
             color:#fff; font-weight:900; font-size:12px;">
      <option value="">Todas</option>
    </select>
  </div>

  <!-- Time -->
  <div style="display:flex; flex-direction:column; gap:6px; min-width:220px;">
    <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Time</div>
    <select id="itensIrregDetFiltroTime"
      style="height:34px; border-radius:10px; padding:0 10px;
             background:rgba(255,255,255,0.06); border:1px solid rgba(148,163,184,0.18);
             color:#fff; font-weight:900; font-size:12px;">
      <option value="">Todos</option>
    </select>
  </div>

  <!-- Limpar filtros -->
  <button type="button" onclick="window.vektorClearItensIrregDetFilters_()"
    style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(181,255,32,0.30);
           background:rgba(181,255,32,0.10); color:#B5FF20;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Limpar filtros
  </button>

  <!-- ‚úÖ NOVO: Pr√©via (fica no ‚Äúlugar‚Äù do enviar) -->
  <button type="button" onclick="window.vektorOpenPreviewItensIrregDet_()"
    style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Pr√©via
  </button>

  <!-- ‚úÖ Espa√ßo do meio: Sel. All / Desel. All -->
<div style="flex:1 1 auto; display:flex; justify-content:flex-end; gap:10px; padding-right:10px;">

  <button type="button" onclick="window.vektorItensIrregDetSelectAll_()"
    style="height:34px; padding:0 12px; border-radius:10px;
           border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Sel. All
  </button>

  <button type="button" onclick="window.vektorItensIrregDetDeselectAll_()"
    style="height:34px; padding:0 12px; border-radius:10px;
           border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Desel. All
  </button>

</div>

  <!-- ‚úÖ Enviar Notifica√ß√£o no canto direito -->
  <button type="button" onclick="window.vektorEnviarNotificacaoItensIrregularesSelecionados_()"
    style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Enviar Notifica√ß√£o
  </button>

</div>

    <!-- Table (scroll) -->
    <div style="padding:12px;">
      <div style="border-radius:12px; border:1px solid rgba(148,163,184,0.18);
            overflow:auto; max-height:65vh; background:rgba(226,232,240,0.92);">

        <table style="width:100%; border-collapse:separate; border-spacing:0; min-width:980px;">
          <thead>
            <tr>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Data
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:right; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Valor (R$)
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Loja
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Time
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Item Comprado
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Conformidade
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Motivo
              </th>
            </tr>
          </thead>

          <tbody id="itensIrregDetTbody">
            <tr>
              <td colspan="7" style="padding:12px; color:rgba(226,232,240,0.75); font-weight:800; font-size:12px;">
                Clique em ‚ÄúAtualizar‚Äù para carregar e depois use ‚ÄúVer detalhamento‚Äù.
              </td>
            </tr>
          </tbody>

        <!-- ‚úÖ MINI MODAL: Pr√©via sele√ß√£o -->
<div id="itensIrregPreviewModal" style="display:none; position:fixed; inset:0; z-index:999999;">
  <div onclick="window.vektorClosePreviewItensIrregDet_()"
       style="position:absolute; inset:0; background:rgba(0,0,0,0.55);"></div>

  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
              width:min(900px, calc(100vw - 28px));
              max-height:calc(100vh - 120px);
              overflow:auto;
              background:linear-gradient(180deg, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
              border:1px solid rgba(148,163,184,0.22);
              border-radius:16px;
              box-shadow:0 18px 50px rgba(0,0,0,0.45);">

    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px;
                border-bottom:1px solid rgba(148,163,184,0.18);">
      <div style="color:#fff; font-weight:1000; font-size:14px;">Pr√©via ‚Äî Itens selecionados</div>
      <button type="button" onclick="window.vektorClosePreviewItensIrregDet_()"
        style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
               background:rgba(255,255,255,0.06); color:#fff; font-weight:1000; font-size:12px; cursor:pointer;">
        Fechar
      </button>
    </div>

    <div id="itensIrregPreviewBody" style="padding:14px 16px; color:rgba(226,232,240,0.92);">
      <!-- preenchido via JS -->
    </div>

  </div>
</div>

        </table>

      </div>
    </div>

  </div>
</div>

        <div id="radarContent" style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px;">
          <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
              <div style="color:#fff; font-weight:900; font-size:14px;">Correla√ß√£o (Pearson)</div>
              <div style="color:rgba(226,232,240,0.75); font-size:11px;">-1 ¬∑ 0 ¬∑ +1</div>
            </div>
            <div id="radarHeatmap" style="margin-top:10px;"></div>
            <div class="radar-legend-bar"></div>
           <!-- INSIGHTS din√¢micos (explica√ß√£o "tipo IA") -->
            <div id="radarInsights"
                style="margin-top:12px; padding:12px; border-radius:12px;
                border:1px solid rgba(148,163,184,0.18);
                background:rgba(255,255,255,0.03);
                color:rgba(226,232,240,0.9);
                font-size:12px; line-height:1.5;
                min-height:260px; max-height:360px; overflow:auto;">
              <div style="font-weight:900; color:#fff; margin-bottom:6px; font-size:14px;">
                Leitura autom√°tica do Radar
              </div>
              <div style="opacity:0.85;">
                Carregando interpreta√ß√£o‚Ä¶
              </div>
            </div>
          </div>
          <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
            <div style="color:#fff; font-weight:900; font-size:14px;">Lojas mais pr√≥ximas</div>
            <div style="color:rgba(226,232,240,0.7); font-size:12px; margin-top:2px;">
              Ranking de proximidade (baseado em MAX_SCORE, CASOS e PEND√äNCIA)
            </div>
            <div id="radarRanking" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>
      </div>

    </div>
  </main>
 </div> <!-- fecha #radarView -->

 <!-- VIEW: MEUS ALERTAS (sobrep√µe SOMENTE a √°rea do chat) -->
<div id="myAlertsView" class="hidden" style="position:absolute; inset:0; z-index:20;">

  <!-- MODAL: Tutorial (Alertas Programados) -->
  <div id="myAlTutorialModal"
       class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center"
       style="display:none;">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[980px] overflow-hidden border border-slate-200">
      <!-- Header -->
      <div class="px-5 py-4 text-white flex items-center justify-between"
           style="background:#005E27;">
        <div>
          <div class="text-base font-extrabold">Tutorial ‚Äî Alertas Programados</div>
          <div class="text-xs opacity-90">V√≠deo r√°pido de uso da p√°gina</div>
        </div>

        <button type="button"
                onclick="closeMyAlTutorialModal()"
                class="transition rounded-lg px-3 py-2 text-sm font-semibold"
                style="background:rgba(255,255,255,0.18);">
          Fechar
        </button>
      </div>

      <!-- Faixa destaque -->
      <div style="height:6px; background:#B5FF20;"></div>

      <!-- Body -->
      <div class="p-4" style="background:#f8fafc;">
        <div style="position:relative; padding-bottom:56.25%; height:0; border-radius:12px; overflow:hidden; border:1px solid rgba(15,23,42,0.12); background:#000;">
          <iframe
            src="https://www.loom.com/embed/4c49cc7ba6444bc9ae7931e4a9940b57"
            frameborder="0"
            webkitallowfullscreen
            mozallowfullscreen
            allowfullscreen
            style="position:absolute; top:0; left:0; width:100%; height:100%;">
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center; gap:10px;">

          <div>
            <div id="myAl_title" style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Defini√ß√£o de Alertas</div>
            <div style="color:rgba(226,232,240,0.9); font-size:13px; margin-top:2px;">
              <span id="myAl_subtitle">Alertas de Transa√ß√µes por Lojas, Times e Tags (com hist√≥rico e execu√ß√£o programada), disparado sempre em dias √∫teis.</span>
            </div>
          </div>
        </div>

        <div id="myAl_headerBtns"
             style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; transform: translateY(13px);">

          <button
            id="myAl_btnValores"
            type="button"
            onclick="openMyAlValoresContabilizadosView()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:1px solid rgba(148,163,184,0.28);
              background:rgba(255,255,255,0.10);
              color:#fff;
              font-weight:900;
              font-size:12px;
              display:flex;
              align-items:center;
              gap:8px;
            ">
            üìä Valores Contabilizados
          </button>

          <button
            id="myAl_btnTutorial"
            type="button"
            onclick="openMyAlTutorialModal()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:1px solid rgba(0,0,0,0.25);
              background:#00FFFF;
              color:#000;
              font-weight:900;
              font-size:12px;
              display:flex;
              align-items:center;
              gap:6px;
            ">
            ‚ñ∂ Tutorial (v√≠deo)
          </button>
        </div>

        <div id="myAl_typeWrap" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
            <div style="color:rgba(226,232,240,0.85); font-size:13px; font-weight:900;">Tipo de alerta</div>
            <select id="myAl_alertType"
              style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                    border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
              <option value="TRANSACOES">Transa√ß√µes</option>
              <option value="PENDENCIAS">Pend√™ncias</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Conte√∫do -->
      <div style="flex:1; overflow:auto; background:#070b14; padding:14px 16px;">

        <!-- ===== VIEW 1: Defini√ß√£o de Alertas (tudo que j√° existe) ===== -->
        <div id="myAl_defView">

          <!-- Cards: Criar + Listagem -->
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">

            <!-- Card: Criar alerta -->
            <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
              <div style="color:#fff; font-weight:900; font-size:15px;">Criar alerta</div>
              <div style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:2px;">
                <span id="myAl_createHint">O alerta gera uma tabela (Loja, Time, Data, Estabelecimento, Valor, Etiqueta, Descri√ß√£o).</span>
              </div>

              <div style="margin-top:10px; display:grid; gap:10px;">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                  <div>
                    <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Frequ√™ncia</label>
                    <select id="myAl_freq" style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;">
                      <option value="DAILY">Di√°rio</option>
                      <option value="3D">A cada 3 dias</option>
                      <option value="WEEKLY">Semanal</option>
                      <option value="MONTHLY">Mensal</option>
                    </select>
                  </div>

                  <div>
                    <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Janela de an√°lise (dias)</label>
                    <input id="myAl_windowDays" type="number" min="1" max="365" placeholder="30"
                      title="Se vazio, considera automaticamente os √∫ltimos 30 dias."
                      style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
                  </div>
                </div>

                <div>
                  <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">
                    Hor√°rio do e-mail (opcional)
                  </label>
                  <input id="myAl_sendAt" type="time"
                    style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
                  <div style="margin-top:6px; font-size:11px; color:rgba(226,232,240,0.75);">
                    Se vazio, o Vektor dispara assim que a frequ√™ncia vencer.
                  </div>
                </div>

                <div>
                  <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Time</label>
                  <select id="myAl_team" style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;">
                    <option value="__ALL__">Todos os times</option>
                    <option value="" disabled>Carregando‚Ä¶</option>
                  </select>
                </div>

                <div>
                  <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Lojas (do time)</label>
                  <div id="myAl_storesBox" style="max-height:160px; overflow:auto; border-radius:12px; border:1px solid rgba(148,163,184,0.18); padding:10px; background:rgba(255,255,255,0.03); color:#fff;">
                    <div style="opacity:0.8; font-size:12px;">Selecione um time para listar as lojas.</div>
                  </div>
                </div>

                <div>
                  <div id="myAl_labelWrap">
                    <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">
                      Etiquetas (multi-sele√ß√£o)
                    </label>

                    <select id="myAl_label" multiple
                      style="width:100%; min-height:120px; border-radius:12px; background:rgba(255,255,255,0.06);
                            color:#fff; border:1px solid rgba(148,163,184,0.18); padding:8px 10px; font-size:12px;">
                      <option value="__ALL__">Todas</option>
                    </select>

                    <div style="margin-top:6px; font-size:11px; color:rgba(226,232,240,0.75);">
                      Dica: segure Ctrl (Windows) ou Cmd (Mac) para selecionar mais de uma etiqueta.
                    </div>
                  </div>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                  <button id="myAl_saveBtn" type="button" onclick="window.vektorMyAlertsCreate()"
                    style="height:36px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:#16a34a; color:#04110a; font-weight:900; font-size:12px;">
                    Criar alerta
                  </button>

                  <button type="button" onclick="window.vektorMyAlertsRefresh()"
                    style="height:36px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
                    Atualizar lista
                  </button>

                  <button id="myAl_cancelEditBtn" type="button" onclick="window.vektorMyAlertsCancelEdit_()"
                    style="display:none;
                    height:36px;
                    padding:0 14px;
                    border-radius:10px;
                    border:1px solid rgba(148,163,184,0.18);
                    background:rgba(255,255,255,0.06);
                    color:#fff;
                    font-weight:900;
                    font-size:12px;
                    align-items:center;
                    justify-content:center;
                    line-height:1;">
                    Cancelar edi√ß√£o
                  </button>
                </div>

                <div id="myAl_createStatus" style="margin-top:4px; font-size:12px; color:rgba(226,232,240,0.85);"></div>

              </div>
            </div>

            <!-- Card: Alertas existentes -->
            <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">

              <!-- Header do card -->
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:#fff; font-weight:900; font-size:15px;">
                  Alertas cadastrados
                </div>
                <div style="color:rgba(226,232,240,0.75); font-size:12px;">
                  Seu hist√≥rico √© privado. O bot√£o <b>Executar</b> ir√° enviar o alerta diretamente aqui no chat. O envio por e-mail ocorrer√° <b>automaticamente</b> conforme a <b>frequ√™ncia</b> configurada neste alerta.
                </div>
              </div>

              <!-- Filtros ADMIN -->
              <div id="myAl_adminFilterBox" style="display:none; margin-top:12px;">

                <div style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">
                  Filtros (Admin)
                </div>

                <div style="display:flex; gap:8px; width:100%;">

                  <input
                    id="myAl_adminEmail"
                    type="text"
                    placeholder="filtrar por e-mail"
                    style="flex:1; height:34px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-size:12px;"
                  />

                  <select
                    id="myAl_adminRole"
                    style="flex:1; height:34px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-size:12px;"
                  >
                    <option value="">Todas as √°reas</option>
                  </select>

                </div>
              </div>

              <!-- ‚úÖ LISTA: agora DENTRO do card Alertas cadastrados -->
              <div id="myAl_list"
                style="margin-top:12px; display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto; padding-right:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px;">Carregando‚Ä¶</div>
              </div>
            </div>

          </div> <!-- /Cards grid -->

        </div> <!-- /myAl_defView -->


        <!-- ===== VIEW 2: Valores Contabilizados (NOVA P√ÅGINA) ===== -->

      <div id="myAl_valoresView" style="display:none;">
      
          <!-- Filtros -->
          <div style="
              background:#0b1220;
              border:1px solid rgba(148,163,184,0.18);
              border-radius:14px;
              padding:12px;
              margin-bottom:12px;
            ">
            <div style="color:#fff; font-weight:900; font-size:13px; margin-bottom:10px;">Filtros</div>

            <div style="display:grid; grid-template-columns: 1.0fr 1.2fr 170px 170px auto; gap:10px; align-items:end;">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Time</div>
                <select id="myAl_val_time"
                  style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                         border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
                </select>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Loja</div>
                <select id="myAl_val_loja"
                  style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                         border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
                </select>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Per√≠odo (In√≠cio)</div>
                <input id="myAl_val_dtIni" type="date"
                  style="height:34px; border-radius:10px; background:#e5e7eb; color:#0b1220;
                    border:1px solid #cbd5e1; padding:0 10px; font-weight:900; font-size:12px;"/>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Per√≠odo (Fim)</div>
                <input id="myAl_val_dtFim" type="date"
                  style="height:34px; border-radius:10px; background:#e5e7eb; color:#0b1220;
       border:1px solid #cbd5e1; padding:0 10px; font-weight:900; font-size:12px;"/>
              </div>

              <button
                type="button"
                onclick="myAlValoresClearFilters()"
                style="
                  height:36px;
                  padding:0 12px;
                  border-radius:10px;
                  border:1px solid rgba(148,163,184,0.22);
                  background:rgba(255,255,255,0.06);
                  color:#fff;
                  font-weight:900;
                  font-size:12px;
                ">
                Limpar
              </button>
            </div>
          </div>

            <!-- Loading (Valores Contabilizados) -->
              <div id="myAl_valLoading"
                  style="display:none; margin-bottom:12px; padding:10px 12px; border-radius:12px;
                          background:#0b1220; border:1px solid rgba(148,163,184,0.18); color:#fff; font-weight:900;">
                Carregando valores contabilizados‚Ä¶
                <div style="margin-top:4px; font-size:12px; color:rgba(226,232,240,0.75); font-weight:700;">
                  Aguarde a consolida√ß√£o por etiqueta e categoria.
                </div>
              </div>

          <!-- Layout: Funil + Tabela -->
<div style="display:grid; grid-template-columns: 560px 1fr; gap:12px; align-items:start;">

  <!-- Gr√°fico por categoria (barras) -->
  <div style="background:#0b1220; border:1px solid rgba(255,255,255,0.85); border-radius:14px; padding:12px;">
    <div style="color:#fff; font-weight:900; font-size:13px; margin-bottom:10px;">
      Barras por clusteriza√ß√£o das categorias (valor e %)
    </div>

    <div id="myAl_funilWrap" style="width:100%; overflow:hidden;">
  <div id="myAl_catChartWrap" style="height:360px; position:relative; width:100%;">
    <canvas id="myAl_catChart" style="width:100%; height:100%; display:none;"></canvas>
  </div>

  <div id="myAl_catHint"
       style="margin-top:10px; font-size:12px; color:rgba(226,232,240,0.75); font-weight:800;">
    Defina o per√≠odo para exibir o gr√°fico.
  </div>
</div>

  </div>

  <!-- Tabela - wrapper com scroll -->
  <div style="background:#e5e7eb; border:1px solid #000; border-radius:14px; padding:10px; overflow:auto; max-height:420px;">
    <table style="width:100%; border-collapse:collapse; font-size:12px; background:#f8fafc;">
      <thead>
        <tr>
          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">Etiquetas</th>

          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">Conta Cont√°bil</th>

          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">Valor</th>

          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">% Valor</th>
        </tr>
      </thead>

      <tbody id="myAl_valoresTbody"></tbody>
    </table>
  </div>
</div>

        </div> <!-- /myAl_valoresView -->

      </div> <!-- /Conte√∫do -->


      <!-- ‚úÖ Overlay / Toast (My Alerts) -->
      <div id="myAl_overlay" style="display:none; position:absolute; inset:0; z-index:60; background:rgba(0,0,0,0.55);">
        <div style="height:100%; display:flex; align-items:center; justify-content:center; padding:16px;">
          <div style="width:min(420px, 92vw); background:#0b1220; border:1px solid rgba(148,163,184,0.25); border-radius:16px; padding:14px;">
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="vektor-spinner" style="border-top-color:#16a34a;"></div>
              <div>
                <div id="myAl_overlayTitle" style="color:#fff; font-weight:900; font-size:13px;">Carregando‚Ä¶</div>
                <div id="myAl_overlaySub" style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:2px;">Aguarde um instante.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="myAl_toast" style="display:none; position:absolute; right:16px; bottom:16px; z-index:70;
        background:#0b1220; border:1px solid rgba(148,163,184,0.25); border-radius:14px; padding:10px 12px; min-width:260px;">
        <div id="myAl_toastMsg" style="color:#fff; font-weight:900; font-size:12px;">OK</div>
      </div>

    </div>
  </main>
</div>

 <!-- VIEW: FEEDBACK (sobrep√µe SOMENTE a √°rea do chat) -->
<div id="feedbackView" class="hidden" style="position:absolute; inset:0; z-index:20;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header do Feedback -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Feedback do Vektor</div>
            <div style="color:rgba(226,232,240,0.9); font-size:12px; margin-top:2px;">
              Preencha e envie o formul√°rio sem sair do Vektor
            </div>
          </div>
        </div>
      </div>

      <!-- Conte√∫do (iframe do Google Forms) -->
      <div style="flex:1; background:#0b1220; padding:14px 16px;">
        <div style="height:100%; background:#ffffff; border-radius:14px; overflow:hidden; border:1px solid rgba(148,163,184,0.25);">
          <iframe
            id="feedbackFrame"
            title="Formul√°rio de Feedback"
            src="https://docs.google.com/forms/d/e/1FAIpQLSfk-XlpYWvA_WgfcMq9o0VC-QhqXfygFgwdTsrlJmQ-OEyKIw/viewform?embedded=true"
            style="width:100%; height:100%; border:0;"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
          ></iframe>
        </div>
      </div>

    </div>
  </main>

</div> <!-- fecha #feedbackView -->

<!-- VIEW: FLUXOGRAMA (sobrep√µe SOMENTE a √°rea do chat) -->
<div id="fluxogramaView" class="hidden" style="position:absolute; inset:0; z-index:20;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div class="vektor-fluxo-bg relative overflow-hidden"
     style="height:100%; width:100%; display:flex; flex-direction:column;">
        <div class="vektor-fluxo-bg-layer" aria-hidden="true"></div>

      <!-- Header do Fluxograma -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Fluxograma do Vektor</div>
            <div style="color:rgba(226,232,240,0.9); font-size:14px; margin-top:2px;">
              Vis√£o interna do funcionamento (bases, jobs, consultas e entregas)
            </div>
          </div>
        </div>
      </div>

      <!-- Conte√∫do -->
      <div style="flex:1; padding:16px; overflow:auto; background:radial-gradient(1200px 900px at 20% 0%, rgba(181,255,32,0.14), transparent 55%), radial-gradient(900px 700px at 90% 20%, rgba(0,94,39,0.22), transparent 55%), #07110c;">
        <div style="max-width:1100px; margin:0 auto;">

          <!-- Legend -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <div style="color:rgba(226,232,240,0.92); font-size:14px;">
              <b>Objetivo:</b> mostrar como o Vektor percorre <b>fontes ‚Üí processamento ‚Üí regras ‚Üí sa√≠das</b>.
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(181,255,32,0.35); background:rgba(2,6,23,0.35); color:#fff; font-size:11px; font-weight:800;">
                ‚ñ† Caixas: componentes
              </span>
              <span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(181,255,32,0.35); background:rgba(2,6,23,0.35); color:#fff; font-size:11px; font-weight:800;">
                ‚ü∂ Setas: fluxo de dados
              </span>
            </div>
          </div>

          <!-- Flow container (zig-zag) -->
          <div class="flow-container" style="position:relative; padding:14px 12px 24px; border-radius:18px; border:1px solid rgba(148,163,184,0.20); background:rgba(2,6,23,0.35);">

            <!-- SVG overlay dos conectores (setas ‚Äúcoladas‚Äù nas caixas, com cotovelo reto) -->
            <svg id="fluxoConnectorsSvg"
                style="position:absolute; inset:0; width:100%; height:100%; z-index:5; pointer-events:none; shape-rendering:geometricPrecision;"
                viewBox="0 0 1000 1000" preserveAspectRatio="none">
              <defs>
              <marker id="arrowHeadGreen" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto">
              <polygon points="0,0 7,3.5 0,7" fill="rgb(181,255,32)" fill-opacity="1"></polygon>
            </marker>

            <marker id="arrowHeadDarkGreen" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto">
              <polygon points="0,0 7,3.5 0,7" fill="rgb(34,197,94)" fill-opacity="1"></polygon>
            </marker>

              </defs>
            </svg>

            <!-- Step 1 (left) -->
<div style="display:flex; justify-content:flex-start;">
  <div id="fgStep1" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(181,255,32,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">1) Fontes (entrada)</div>
    <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
      ‚Ä¢ <b>API CLara</b>: Em desenvolvimento<br/>
      ‚Ä¢ <b>Google Sheets</b>: Base de transa√ß√µes da Clara + consultas auxiliares<br/>
      ‚Ä¢ <b>BigQuery</b>: consultas e valida√ß√µes (deduplica√ß√£o, agrega√ß√µes e cruzamentos quando aplic√°vel)<br/>
      ‚Ä¢ <b>PropertiesService</b>: controle de execu√ß√£o (√∫ltima execu√ß√£o, estado de jobs, par√¢metros, anti-spam)<br/>
      ‚Ä¢ <b>Drive</b>: anexos/exports (CSV/XLSX), evid√™ncias e arquivos de apoio
    </div>
  </div>
</div>

<!-- Spacer (sem connector SVG solto) -->
<div style="height:26px;"></div>

<!-- Step 2 (right) -->
<div style="display:flex; justify-content:flex-end;">
  <div id="fgStep2" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(34,197,94,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">2) Orquestra√ß√£o (jobs & gatilhos)</div>
    <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
      ‚Ä¢ <b>Triggers</b>: agendadores (ex.: execu√ß√£o peri√≥dica para alertas, monitoramento e rotinas)<br/>
      ‚Ä¢ <b>Jobs</b>: consolida√ß√£o, verifica√ß√£o de consist√™ncia, enriquecimento e atualiza√ß√£o de sinais operacionais<br/>
      ‚Ä¢ <b>APIs/Servi√ßos</b>: Drive, Sheets, BigQuery, MailApp (chamadas conforme necessidade do fluxo)<br/>
      ‚Ä¢ <b>Logs</b>: registro de execu√ß√£o (sucesso/erro), auditoria e rastreabilidade operacional
    </div>
  </div>
</div>

<!-- Spacer -->
<div style="height:26px;"></div>

<!-- Step 3 (left) -->
<div style="display:flex; justify-content:flex-start;">
  <div id="fgStep3" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(181,255,32,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">3) Motor de regras (governan√ßa & intelig√™ncia)</div>
    <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
      ‚Ä¢ <b>Regras de pend√™ncia</b>: etiqueta vazia, recibo = ‚ÄúN√£o‚Äù, descri√ß√£o vazia<br/>
      ‚Ä¢ <b>Classifica√ß√µes e alertas</b>: padr√µes, exce√ß√µes, limites, lojas ofensoras e poss√≠veis irregularidades (quando aplic√°vel)<br/>
      ‚Ä¢ <b>Normaliza√ß√£o</b>: datas, valores, textos, lojas (CE####), times e filtros consistentes<br/>
      ‚Ä¢ <b>Consolida√ß√µes</b>: m√©tricas por Loja, Time, per√≠odo e tipo (Etiqueta / NF / Descri√ß√£o)
    </div>
  </div>
</div>

<!-- Spacer -->
<div style="height:26px;"></div>

<!-- Step 4 (right) -->
<div style="display:flex; justify-content:flex-end;">
  <div id="fgStep4" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(34,197,94,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">4) Produtos (sa√≠das vis√≠veis)</div>
    <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
      ‚Ä¢ <b>Chat</b>: consultas, tabelas, rankings e resumos com explica√ß√£o de ‚Äúcomo foi calculado‚Äù<br/>
      ‚Ä¢ <b>Alertas Programados</b>: Transa√ß√µes e Pend√™ncias (hist√≥rico + execu√ß√£o programada por e-mail)<br/>
      ‚Ä¢ <b>Alertas Operacionais</b>: limites de cart√µes, lojas ofensoras, irregularidades e monitoramentos (quando aplic√°vel)<br/>
      ‚Ä¢ <b>Disparo de Pend√™ncias</b>: Envio de e-mails alertando sobre pendencias, procedimento automtizado via Script<br/>
      ‚Ä¢ <b>Radar</b>: indicadores e ranking de risco (admin, quando aplic√°vel)<br/>
      ‚Ä¢ <b>Exporta√ß√µes</b>: CSV/XLSX e evid√™ncias conforme necessidade do processo
    </div>
  </div>
</div>

<!-- Spacer -->
<div style="height:26px;"></div>

<!-- Step 5 (left) -->
<div style="display:flex; justify-content:flex-start;">
  <div id="fgStep5" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(181,255,32,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">5) Evid√™ncias, auditoria & governan√ßa</div>
    <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
      ‚Ä¢ <b>E-mail (MailApp)</b>: envio com <b>anexo</b> (CSV/XLSX) e corpo consolidado (quando aplic√°vel)<br/>
      ‚Ä¢ <b>Logs de execu√ß√£o</b>: rastreabilidade por job/alerta/rodada/quantidade de linhas e per√≠odo<br/>
      ‚Ä¢ <b>RBAC</b>: controle de acesso por role/whitelist (sem expor dados indevidos)<br/>
      ‚Ä¢ <b>Confiabilidade</b>: valida√ß√µes, consist√™ncia e hist√≥rico para suporte e auditoria
    </div>
  </div>
</div>

          </div><!-- /flow container -->

        </div>
      </div>

    </div>
  </main>

</div> <!-- fecha #fluxogramaView -->

 <!-- Modal: Como acontece a an√°lise? (Radar) -->
<div id="radarAnaliseModal"
     class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[860px] overflow-hidden border border-slate-200">
    <!-- Header -->
    <div class="px-5 py-4 bg-[#0b1220] text-white flex items-center justify-between">
      <div>
        <div class="text-base font-extrabold">Como acontece a an√°lise?</div>
        <div class="text-xs opacity-90">Leitura objetiva do heatmap (correla√ß√£o) e do ranking de risco</div>
      </div>
      <button type="button"
              onclick="closeRadarAnaliseModal()"
              class="bg-white/15 hover:bg-white/25 transition rounded-lg px-3 py-2 text-sm font-semibold">
        Fechar
      </button>
    </div>

    <!-- Body -->
    <div class="p-5 text-sm text-slate-700 space-y-4 max-h-[70vh] overflow-y-auto">
      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-semibold text-slate-900">1) Correla√ß√£o (Pearson)</div>
        <div class="mt-2 text-sm">
          O heatmap mede <b>rela√ß√£o entre m√©tricas</b> (n√£o aponta loja individual).
          <br/>
          <b>+1</b> = sobem juntas ¬∑ <b>0</b> = sem rela√ß√£o ¬∑ <b>-1</b> = uma sobe e a outra tende a descer.
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold text-slate-900">Interpreta√ß√£o (positiva)</div>
          <div class="mt-2 overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-xl overflow-hidden">
              <thead class="bg-slate-100">
                <tr>
                  <th class="text-left px-3 py-2 border-b">Valor</th>
                  <th class="text-left px-3 py-2 border-b">Interpreta√ß√£o</th>
                </tr>
              </thead>
              <tbody>
                <tr><td class="px-3 py-2 border-b">0.00 ‚Äì 0.19</td><td class="px-3 py-2 border-b">Irrelevante</td></tr>
                <tr><td class="px-3 py-2 border-b">0.20 ‚Äì 0.39</td><td class="px-3 py-2 border-b">Fraca</td></tr>
                <tr><td class="px-3 py-2 border-b">0.40 ‚Äì 0.59</td><td class="px-3 py-2 border-b">Moderada</td></tr>
                <tr><td class="px-3 py-2 border-b">0.60 ‚Äì 0.79</td><td class="px-3 py-2 border-b">Forte</td></tr>
                <tr><td class="px-3 py-2">0.80 ‚Äì 1.00</td><td class="px-3 py-2">Muito forte</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold text-slate-900">Interpreta√ß√£o (negativa)</div>
          <div class="mt-2 text-sm">
            A escala negativa tem a mesma ‚Äúfor√ßa‚Äù, mas no sentido inverso:
            <br/>
            <b>-1</b> = quando uma m√©trica sobe, a outra tende a descer.
          </div>
          <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-xl overflow-hidden">
              <thead class="bg-slate-100">
                <tr>
                  <th class="text-left px-3 py-2 border-b">Valor</th>
                  <th class="text-left px-3 py-2 border-b">Interpreta√ß√£o</th>
                </tr>
              </thead>
              <tbody>
                <tr><td class="px-3 py-2 border-b">-0.00 ‚Äì -0.19</td><td class="px-3 py-2 border-b">Irrelevante</td></tr>
                <tr><td class="px-3 py-2 border-b">-0.20 ‚Äì -0.39</td><td class="px-3 py-2 border-b">Fraca (inversa)</td></tr>
                <tr><td class="px-3 py-2 border-b">-0.40 ‚Äì -0.59</td><td class="px-3 py-2 border-b">Moderada (inversa)</td></tr>
                <tr><td class="px-3 py-2 border-b">-0.60 ‚Äì -0.79</td><td class="px-3 py-2 border-b">Forte (inversa)</td></tr>
                <tr><td class="px-3 py-2">-0.80 ‚Äì -1.00</td><td class="px-3 py-2">Muito forte (inversa)</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-semibold text-slate-900">
          M√©tricas utilizadas no Radar
        </div>

        <ul class="mt-3 text-sm space-y-2">
          <li>
            <b>AVG (Average Score)</b> ‚Äì m√©dia do score de irregularidade das transa√ß√µes da loja no per√≠odo.
            Indica se o comportamento √© recorrente ou pontual.
          </li>

          <li>
            <b>MAX (Maximum Score)</b> ‚Äì maior score de irregularidade identificado em uma √∫nica transa√ß√£o.
            Destaca picos cr√≠ticos mesmo que isolados.
          </li>

          <li>
            <b>PEND (Pending Rate)</b> ‚Äì percentual de transa√ß√µes com pend√™ncia de justificativa ou documenta√ß√£o.
            Mede risco operacional e falhas de conformidade.
          </li>

          <li>
            <b>QTD/D (Quantidade por Dia)</b> ‚Äì m√©dia de transa√ß√µes realizadas por dia no per√≠odo analisado.
            Ajuda a identificar frequ√™ncia at√≠pica de uso.
          </li>

          <li>
            <b>VALOR (Valor Financeiro)</b> ‚Äì valor financeiro m√©dio ou m√°ximo das transa√ß√µes analisadas.
            Auxilia na avalia√ß√£o de impacto financeiro potencial.
          </li>
        </ul>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-semibold text-slate-900">2) Ranking ‚ÄúLojas mais pr√≥ximas‚Äù</div>
        <div class="mt-2 text-sm">
          O n√∫mero do ranking (ex.: <b>55</b>) √© um <b>√≠ndice relativo de prioridade</b> (0‚Äì100), calculado por score composto:
          <br/>
          <b>55% MAX_SCORE + 30% CASOS + 15% PEND_RATE</b> (com normaliza√ß√£o 0‚Äì1 por per√≠odo).
          <br/>
          Quanto maior, maior a prioridade de an√°lise ‚Äî <b>n√£o</b> √© prova de fraude.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de apresenta√ß√£o do Vektor -->

<div id="vektorModal"
     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
     style="display:none;">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[600px] w-[95%]">
    <div class="rounded-xl overflow-hidden">
      <iframe
        src="https://drive.google.com/file/d/1nYhrveAoL2A5cYfV_LdzXECC2_5BpM-b/preview"
        width="100%"
        height="340"
        allow="autoplay"
        style="border:0;"
      ></iframe>
    </div>

    <button onclick="closeVektorModal()"
            class="mt-3 w-full bg-[#005E27] text-white py-2 rounded-lg text-sm font-semibold">
      Continuar
    </button>
  </div>
</div>

<!-- Modal do Manual da Clara -->
<div id="manualClaraModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[520px] w-[95%]">
    <h2 class="text-base font-semibold text-slate-800 mb-2">
      Manual da Clara ‚Äì principais t√≥picos
    </h2>
    <p class="text-xs text-slate-500 mb-3">
      Escolha um dos itens abaixo. A resposta aparece aqui no chat.
    </p>

    <div class="flex flex-col gap-2 text-sm text-slate-700">

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('primeiro_acesso'); closeManualClaraModal();">
        01 Primeiro acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('recebi_cartao'); closeManualClaraModal();">
        02 Recebi o cart√£o, e agora?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('esqueci_senha'); closeManualClaraModal();">
        03 Esqueci a senha do cart√£o / acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('qual_meu_acesso'); closeManualClaraModal();">
        04 Qual o meu acesso?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('anexar_comprovante'); closeManualClaraModal();">
        05 Como anexar comprovante?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('duvidas'); closeManualClaraModal();">
        06 D√∫vidas
      </button>
    </div>

    <button type="button"
            onclick="closeManualClaraModal()"
            class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<div id="statusVektorModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[520px] w-[95%] text-sm text-slate-700 relative overflow-hidden vektor-status-card">
    <h2 class="text-base font-semibold text-slate-800 mb-3">
      Status
    </h2>

    <ul class="space-y-2">
    <!-- Sempre vis√≠vel -->
    <li><b>√öltima atualiza√ß√£o da Base de Transa√ß√µes:</b> <span id="status-baseclara">‚Äî</span></li>
    <li><b>Status Geral:</b> <span id="status-geral">‚Äî</span></li>

    <? if ((userRole || "") === "Administrador") { ?>
      <!-- Somente Admin -->
      <li><b>√öltima execu√ß√£o dos jobs:</b> <span id="status-jobs">‚Äî</span></li>
      <li><b>Usu√°rios ativos hoje:</b> <span id="status-ativos-hoje">‚Äî</span></li>
      <li><b>Servi√ßos Google (Apps Script / E-mail):</b> <span id="status-google">‚Äî</span></li>
      <li><b>BigQuery:</b> <span id="status-bigquery">‚Äî</span></li>
      <!-- <li><b>Manuten√ß√£o:</b> <span id="status-manutencao">‚Äî</span></li>-->
    <? } ?>
  </ul>


    <button
      onclick="closeStatusVektorModal()"
      class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<!-- Modal do Como Usar o Vektor -->
<div id="ajudaVektorModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[720px] w-[95%]">
    <h2 class="text-base font-semibold text-slate-800 mb-2">
      Como usar o Vektor ‚ùì
    </h2>
    <p class="text-xs text-slate-500 mb-3">
      Guia r√°pido dos principais procedimentos e exemplos de uso.
    </p>

    <!-- Conte√∫do com scroll (para n√£o estourar a tela) -->
    <div class="text-sm text-slate-700 space-y-3 max-h-[60vh] overflow-y-auto pr-2">

      <p>
        O Vektor √© a plataforma de governan√ßa financeira do cart√£o Clara, onde √© poss√≠vel, entre outras coisas: consultar bases, aplicar regras padronizadas e criar a√ß√µes para reduzir pend√™ncias.
      </p>

      <div>
        <p class="font-semibold text-slate-800">Principais procedimentos:</p>
        <ul style="margin-left:14px; line-height:1.55; margin-top:6px;">
          <li>
            <b>1) Pend√™ncias e regulariza√ß√£o</b><br/>
            ‚Ä¢ Consultar pend√™ncias por loja/time e exibir tabela detalhada.<br/>
            <i>Exemplos:</i> ‚Äúpend√™ncias da loja 0297‚Äù, ‚Äúlojas com mais pend√™ncias‚Äù, ‚Äúpend√™ncias do time Furac√£o Sul‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>2) Relat√≥rio Gerencial</b><br/>
            ‚Ä¢ Relat√≥rio Looker Studio com as principais m√©tricas de uso do cart√£o.<br/>
            <i>Exemplos:</i> ‚ÄúAbrir relat√≥rio gerencial da Clara‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>3) Faturas e comparativos</b><br/>
            ‚Ä¢ Consulta valores, extrai informa√ß√µes e compara com fatura anterior.<br/>
            <i>Exemplos:</i> ‚Äúvalor da fatura atual‚Äù, ‚Äúvalor das √∫ltimas 3 faturas‚Äù, "Comparar fatura atual vs anterior", ‚Äúqual √© o ciclo da fatura?‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>4) Rankings e an√°lises gerenciais</b><br/>
            ‚Ä¢ Rankings por loja/time/categoria/estabelecimento e comparativos por per√≠odo.<br/>
            <i>Exemplos:</i> ‚Äúranking de lojas com maior valor‚Äù, ‚Äúcategorias com maior valor‚Äù, ‚Äúestabelecimentos mais usados‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>5) Estornos</b><br/>
            ‚Ä¢ Exibe tabelas de estornos quando dispon√≠vel no seu perfil.<br/>
            <i>Exemplos:</i> ‚Äútabela de estornos‚Äù, ‚Äútabela de estornos do time‚Äù.
          </li>

                    <li style="margin-top:10px;">
            <b>6) Alertas Programados (e-mail)</b><br/>
            ‚Ä¢ Permite cadastrar alertas recorrentes, com envio autom√°tico por e-mail e anexo (CSV/XLSX), conforme filtros configurados.<br/>
            ‚Ä¢ Existem 2 tipos: <b>Transa√ß√µes</b> (por Lojas/Times/Tags) e <b>Pend√™ncias</b> (por Lojas/Times e Tipos de pend√™ncias).<br/>
            <i>Como acessar:</i> Menu ‚Üí ‚Äú‚è±Ô∏è Alertas Programados‚Äù.<br/>
            <i>Dicas:</i> use ‚ÄúExecutar‚Äù para testar o alerta imediatamente no chat; o envio por e-mail segue a frequ√™ncia/hor√°rio configurados.
          </li>

          <li style="margin-top:10px;">
            <b>7) Poss√≠vel uso irregular</b><br/>
            ‚Ä¢ Apoia investiga√ß√£o e leitura objetiva do que disparou o alerta.<br/>
            <i>Exemplo:</i> ‚Äúposs√≠vel uso irregular‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>8) Cart√£o (bloqueio, perda, suporte e direcionamento)</b><br/>
            ‚Ä¢ Orienta o procedimento e encaminha para o canal correto (ex.: ServiceNow).<br/>
            <i>Exemplos:</i> ‚Äúperdi meu cart√£o‚Äù, ‚Äúcart√£o bloqueado, como resolver?‚Äù, ‚Äúservicenow‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>9) Listagem de Itens Comprados</b><br/>
            ‚Ä¢ Relat√≥rios com an√°lises dos itens adquirido pela lojas (levando em considera√ß√£o o campo descri√ß√£o das transa√ß√µes).<br/>
            <i>Exemplos:</i> ‚ÄúItens comprados no geral‚Äù, ‚ÄúItens comprados para o time xxxxxxxx‚Äù, ‚ÄúItens comprados para a loja xxxx‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>10) Limite dos cart√µes</b><br/>
            ‚Ä¢ Demonstra o saldo dos cart√µes, probabilidade de uso, possibilidade de aumento ou redu√ß√£o de limite.<br/>
            <i>Exemplos:</i> ‚ÄúRela√ß√£o de saldos geral‚Äù, ‚ÄúRela√ß√£o de saldos do time xxxxxxxx‚Äù.
          </li>

          <li style="margin-top:10px;">
            <b>11) Termo de responsabilidade</b><br/>
            ‚Ä¢ Anexar o termo pelo bot√£o de clipe e concluir com nome completo.<br/>
            <i>Exemplo:</i> ‚Äútermo de responsabilidade Clara‚Äù.
          </li>
        </ul>
      </div>

      <div>
        <p class="font-semibold text-slate-800">‚ö†Ô∏è Regras importantes ‚ö†Ô∏è</p>
        <ul style="margin-left:14px; line-height:1.55; margin-top:6px;">
          <li><b>Padroniza√ß√£o:</b> respostas seguem pol√≠tica/processo (n√£o ‚Äúopini√£o do Vektor‚Äù).</li>
          <li><b>Perfil de acesso:</b> algumas vis√µes s√£o restritas ao perfil de Administrador.</li>
          <li><b>Boas pr√°ticas:</b> informe a loja e time para consultas especificas; inclua per√≠odo quando fizer sentido (nesse mes, nessa semana, semana passada, mes passado, nesse trtimestre, periodo de datas etc); sempre use as orienta√ß√µes de texto que aparecem no chat pra completar sua d√∫vida ou solicita√ß√£o.</li>
        </ul>
      </div>

    </div>

    <button type="button"
            onclick="closeAjudaVektorModal()"
            class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<? if ((userRole || "") === "Administrador") { ?>

<!-- Modal: Alertas Recentes -->
<div id="alertasRecentesModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[980px] overflow-hidden border border-slate-200">
    
    <!-- Header -->
    <div class="px-5 py-4 bg-[#005E27] text-white flex items-center justify-between">
      <div>
        <div class="text-base font-extrabold">üìã Ocorr√™ncias</div>
        <div class="text-xs opacity-90">Rastreabilidade de alertas enviados (limite, pend√™ncias, poss√≠veis irregularidades)</div>
      </div>
      <button type="button"
              onclick="closeAlertasRecentesModal()"
              class="bg-white/15 hover:bg-white/25 transition rounded-lg px-3 py-2 text-sm font-semibold">
        Fechar
      </button>
    </div>

    <!-- Body -->
    <div class="p-5">
      <!-- Filtros -->
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="flex-1">
          <label class="text-xs font-semibold text-slate-600">Janela (dias)</label>
          <select id="alertasRecentesDias"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
            <option value="7">√öltimos 7 dias</option>
            <option value="14" selected>√öltimos 14 dias</option>
            <option value="30">√öltimos 30 dias</option>
          </select>
        </div>

        <div class="flex-1">
          <label class="text-xs font-semibold text-slate-600">Tipo</label>
          <select id="alertasRecentesTipo"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
            <option value="" selected>Todos</option>
            <option value="LIMITE">Limite</option>
            <option value="PENDENCIAS">Pend√™ncias</option>
            <option value="USO_IRREGULAR">Poss√≠vel irregularidade</option>
            <option value="ITENS_IRREGULARES">Poss√≠veis itens irregulares</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button type="button"
                  onclick="carregarAlertasRecentes()"
                  class="rounded-lg bg-black text-white text-sm font-semibold px-4 py-2 hover:bg-slate-900 transition">
            Atualizar
          </button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="text-xs font-semibold text-slate-500">Total de alertas</div>
          <div id="kpiAlertasTotal" class="text-2xl font-extrabold text-slate-900 mt-1">‚Äî</div>
        </div>
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="text-xs font-semibold text-slate-500">√öltimo envio</div>
          <div id="kpiAlertasUltimo" class="text-sm font-semibold text-slate-900 mt-2">‚Äî</div>
        </div>
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="text-xs font-semibold text-slate-500">Observa√ß√£o</div>
          <div class="text-sm text-slate-700 mt-2">
            Este painel mostra apenas alertas que foram <b>efetivamente enviados</b> por e-mail.
          </div>
        </div>
      </div>

      <!-- Conte√∫do -->
      <div class="mt-4">
        <div id="alertasRecentesLoading" class="hidden text-sm text-slate-700">
          Carregando alertas...
        </div>

        <div id="alertasRecentesEmpty" class="hidden text-sm text-slate-700 rounded-xl border border-slate-200 p-4">
          Nenhum alerta encontrado na janela selecionada.
        </div>

        <div class="mt-2 overflow-x-auto overflow-y-auto max-h-[45vh] rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Data/Hora</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Tipo</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Loja</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Time</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Detalhe</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Origem</th>
            </tr>
          </thead>
          <tbody id="alertasRecentesTbody"></tbody>
        </table>
      </div>
      </div>
    </div>

  </div>
</div>

<? } ?>

</div> <!-- fecha .chat-wrapper -->
</div>   <!-- fecha coluna direita -->
</div>     <!-- fecha layout com menu + chat -->
</div>

<?!= include('politica_dados'); ?>

<script>

  // ===============================
// MODO MANUTEN√á√ÉO (MANUAL)
// ===============================
// ATIVE/DESATIVE (false ou true)
const VEKTOR_MANUTENCAO_ATIVA = false; // <--------------------- ALTERAR PARA MANUTEN√á√ÉO SEMPRE AQUI//

// ===============================
// LOGIN GATE (ESCONDE APP AT√â VALIDAR)
// ===============================
(function () {

    // ===============================
  // VEKTOR - SESSAO (LOCAL, 3H)
  // ===============================
  const VEKTOR_SESSION_KEY = "vektor_session_token_v1";

  function saveSessionToken_(token, ttlSeconds) {
    try {
      const exp = Date.now() + (Number(ttlSeconds || 0) * 1000);
      localStorage.setItem(
        VEKTOR_SESSION_KEY,
        JSON.stringify({ token: token, exp: exp })
      );
    } catch (_) {}
  }

  function getSessionToken_() {
    try {
      const raw = localStorage.getItem(VEKTOR_SESSION_KEY);
      if (!raw) return null;

      const obj = JSON.parse(raw);
      if (!obj || !obj.token || !obj.exp) return null;
      if (Date.now() > Number(obj.exp)) return null;

      return obj.token;
    } catch (_) {
      return null;
    }
  }

  function clearSessionToken_() {
    try {
      localStorage.removeItem(VEKTOR_SESSION_KEY);
    } catch (_) {}
  }

  let vektorLogoutTimer_ = null;

function scheduleAutoLogout_() {
  try {
    if (vektorLogoutTimer_) {
      clearTimeout(vektorLogoutTimer_);
      vektorLogoutTimer_ = null;
    }

    const raw = localStorage.getItem(VEKTOR_SESSION_KEY);
    if (!raw) return;

    const obj = JSON.parse(raw);
    if (!obj || !obj.exp) return;

    const ms = Math.max(0, Number(obj.exp) - Date.now());

    // agenda o logout autom√°tico exatamente no vencimento
    vektorLogoutTimer_ = setTimeout(function () {
      clearSessionToken_();
      hideApp_();
      openModal_();
      setError_("Sess√£o expirada. Fa√ßa login novamente.");
    }, ms);
  } catch (_) {}
}

  function byId(id) { return document.getElementById(id); }

  function hideApp_() {
    var root = byId("vektorAppRoot");
    if (root) root.classList.add("hidden");
    document.body.style.overflow = "hidden";
  }

  function showApp_() {
    var root = byId("vektorAppRoot");
    if (root) root.classList.remove("hidden");
    document.body.style.overflow = "";
  }

  function showMaintenance_() {
  // esconde app e modal
  hideApp_();
  closeModal_();

  // mostra overlay de manuten√ß√£o
  var o = document.getElementById("vektorMaintenanceOverlay");
  if (o) {
    o.classList.remove("hidden");
    o.style.display = "block";
  }
}

function hideMaintenance_() {
  var o = document.getElementById("vektorMaintenanceOverlay");
  if (o) {
    o.style.display = "none";
    o.classList.add("hidden");
  }
}

  function openModal_() {
    var m = byId("vektorLoginModal");
    if (!m) return;
    m.classList.remove("hidden");
    m.style.display = "block";
  }

  function closeModal_() {
    var m = byId("vektorLoginModal");
    if (!m) return;
    m.style.display = "none";
    m.classList.add("hidden");
  }

  function setError_(msg) {
    var box = byId("vektorLoginError");
    if (!box) return;
    if (!msg) {
      box.textContent = "";
      box.classList.add("hidden");
      return;
    }
    box.textContent = String(msg);
    box.classList.remove("hidden");
  }

  function setLoading_(on) {
    var btn = byId("vektorLoginBtn");
    if (!btn) return;
    btn.disabled = !!on;
    btn.textContent = on ? "Validando..." : "Entrar";
  }

  function attempt_() {
  setError_("");
  var email = (byId("vektorLoginEmail") && byId("vektorLoginEmail").value ? byId("vektorLoginEmail").value : "").trim();

  if (!email) {
    setError_("Informe seu e-mail corporativo.");
    return;
  }

  if (typeof google === "undefined" || !google.script || !google.script.run) {
    setError_("google.script.run indispon√≠vel. Abra o Vektor via WebApp publicado.");
    return;
  }

  setLoading_(true);

  google.script.run
    .withSuccessHandler(function (res) {
      setLoading_(false);

      if (res && res.ok) {
        if (res.token && res.ttlSeconds) {
          saveSessionToken_(res.token, res.ttlSeconds);
          scheduleAutoLogout_();
        }
        closeModal_();
        showApp_();
        return;
      }

      hideApp_();
      openModal_();
      setError_(res && res.error ? res.error : "Acesso negado.");
    })
    .withFailureHandler(function (err) {
      setLoading_(false);
      hideApp_();
      openModal_();
      setError_("Erro na valida√ß√£o: " + (err && err.message ? err.message : err));
    })
    .validarLoginVektor(email);
}

let __vektorLoginHandlersBound = false;

function bindLoginHandlers_() {
  if (__vektorLoginHandlersBound) return;
  __vektorLoginHandlersBound = true;

  byId("vektorLoginBtn")?.addEventListener("click", attempt_);

  byId("vektorLoginGoogleBtn")?.addEventListener("click", function () {
    try {
      const emailGoogle = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
      if (!emailGoogle) {
        setError_("N√£o foi poss√≠vel capturar seu e-mail do Google. Digite manualmente.");
        return;
      }
      const inp = byId("vektorLoginEmail");
      if (inp) inp.value = emailGoogle;
      attempt_();
    } catch (e) {
      setError_("Falha ao aplicar Login com Google.");
    }
  });

  byId("vektorLoginEmail")?.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      attempt_();
    }
  });
}

document.addEventListener("DOMContentLoaded", function () {
  bindLoginHandlers_(); // ‚úÖ garante listeners sempre

    // =========================
  // SIDEBAR COLLAPSE (Menu recolh√≠vel)
  // =========================
  (function initSidebarCollapse_(){
    const shell = document.getElementById("vektorShell");
    const btn = document.getElementById("vektorSidebarToggleBtn");
    if (!shell || !btn) return;

    const KEY = "VEKTOR_SIDEBAR_COLLAPSED";

    function apply_(collapsed){
      shell.classList.toggle("sidebar-collapsed", !!collapsed);
      const icon = document.getElementById("vektorSidebarToggleIcon");
        if (icon) {
          icon.textContent = collapsed ? "‚´∏" : "‚´∑";
        }
    }

    // aplica estado salvo
    let saved = null;
    try { saved = localStorage.getItem(KEY); } catch(e) {}
    apply_(saved === "1");

    // click toggle
    btn.addEventListener("click", function(){
      const isCollapsed = shell.classList.contains("sidebar-collapsed");
      const next = !isCollapsed;
      apply_(next);
      try { localStorage.setItem(KEY, next ? "1" : "0"); } catch(e) {}
    });
  })();

    // ‚úÖ Logout (volta para tela de login)
      byId("vektorLogoutBtn")?.addEventListener("click", function () {
        try {
          const token = getSessionToken_(); // pode ser null

          // 1) invalida local
          clearSessionToken_();

          // 2) opcional: invalida token no servidor (se voc√™ implementar no Code.gs)
          if (token && typeof google !== "undefined" && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function () {})
              .withFailureHandler(function () {})
              .encerrarSessaoVektor(token);
          }

          // 3) volta para login
          hideApp_();
          openModal_();
          setError_("Voc√™ saiu. Fa√ßa login novamente.");
        } catch (_) {
          try {
            clearSessionToken_();
            hideApp_();
            openModal_();
          } catch (_) {}
        }
      });

  // Manuten√ß√£o tem prioridade: mostra tela e sai
  if (typeof VEKTOR_MANUTENCAO_ATIVA !== "undefined" && VEKTOR_MANUTENCAO_ATIVA) {
    showMaintenance_();
    return;
  } else {
    hideMaintenance_();
  }

      hideApp_();

      scheduleAutoLogout_();

  const token = getSessionToken_();

  if (token && typeof google !== "undefined" && google.script && google.script.run) {
    // tenta validar sess√£o silenciosamente
    google.script.run
      .withSuccessHandler(function (res) {
        if (res && res.ok) {
          // sess√£o v√°lida: libera sem modal
          showApp_();
          closeModal_();
          scheduleAutoLogout_();
          return;
        }

        // sess√£o inv√°lida
        clearSessionToken_();
        openModal_();
      })
      .withFailureHandler(function () {
        clearSessionToken_();
        openModal_();
      })
      .validarSessaoVektor(token);

    return; // IMPORTANT√çSSIMO: n√£o abrir modal agora
  }

  // sem token: exige login
  openModal_();

    byId("vektorLoginBtn")?.addEventListener("click", attempt_);

    // Bot√£o "Login com Google" -> preenche com e-mail do Google Workspace (do template)
    byId("vektorLoginGoogleBtn")?.addEventListener("click", function () {
      try {
        const emailGoogle = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
        if (!emailGoogle) {
          setError_("N√£o foi poss√≠vel capturar seu e-mail do Google. Digite manualmente.");
          return;
        }
        const inp = byId("vektorLoginEmail");
        if (inp) inp.value = emailGoogle;

        // opcional: j√° dispara o login automaticamente
        attempt_();
      } catch (e) {
        setError_("Falha ao aplicar Login com Google.");
      }
    });

    byId("vektorLoginEmail")?.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        attempt_();
      }
    });

    setTimeout(function(){ try { byId("vektorLoginEmail")?.focus(); } catch(_){} }, 50);
  });
})();

// Mensagem manual (edite data/hora aqui)
const VEKTOR_MSG_MANUTENCAO_HTML = `
  <div class="bot-bubble px-4 py-3 max-w-[80%] text-slate-700">
    <p class="font-semibold text-slate-800 text-base">
      Em manuten√ß√£o preventiva, previs√£o de t√©rmino √†s <b>22:30</b> do dia <b>10/01/2026</b>.
    </p>
  </div>
`;

function vektorAplicarManutencao_() {
  // 1) substitui conte√∫do do chat
  const chat = document.getElementById("chatWindow");
  if (chat) {
    chat.innerHTML = `
      <div class="flex items-start gap-3">
        <img src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
             alt="Vektor"
             class="h-16 w-auto object-contain flex-shrink-0" />
        ${VEKTOR_MSG_MANUTENCAO_HTML}
      </div>
    `;
  }

  // 2) bloqueia input e envio
  const input = document.getElementById("userInput");
  if (input) {
    input.value = "";
    input.disabled = true;
    input.placeholder = "Indispon√≠vel (manuten√ß√£o).";
  }

  const btn = document.getElementById("sendBtn");
  if (btn) btn.disabled = true;

  // 3) trava submit do form
  const form = document.getElementById("chatForm");
  if (form) {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      return false;
    }, { capture: true });
  }
}

// ‚úÖ aplica manuten√ß√£o SOMENTE quando estiver true
if (VEKTOR_MANUTENCAO_ATIVA) {
  vektorAplicarManutencao_();
  setTimeout(vektorAplicarManutencao_, 100); // garante que ningu√©m reescreva depois
}

    // Estado global para o upload do Termo de Responsabilidade
  window.vektorTermoPending = null;         // guarda o arquivo em mem√≥ria at√© receber o nome
  window.vektorTermoAguardandoNome = false; // indica se o pr√≥ximo texto √© o nome completo


  // Fecha o modal do v√≠deo de apresenta√ß√£o
function closeVektorModal() {
  var modal = document.getElementById("vektorModal");
  if (modal) {
    modal.style.display = "none";
  }
}

function openAlertasRecentesModal() {
  const modal = document.getElementById("alertasRecentesModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
  carregarAlertasRecentes();
}

function closeAlertasRecentesModal() {
  const modal = document.getElementById("alertasRecentesModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function openRadarAnaliseModal() {
  const modal = document.getElementById("radarAnaliseModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeRadarAnaliseModal() {
  const modal = document.getElementById("radarAnaliseModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function openEnvPendAnaliseModal() {
  const modal = document.getElementById("envPendAnaliseModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeEnvPendAnaliseModal() {
  const modal = document.getElementById("envPendAnaliseModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function openMyAlTutorialModal() {
  const modal = document.getElementById("myAlTutorialModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeMyAlTutorialModal() {
  const modal = document.getElementById("myAlTutorialModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function closeStatusVektorModal() {
  const modal = document.getElementById("statusVektorModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function carregarAlertasRecentes() {
  const loading = document.getElementById("alertasRecentesLoading");
  const empty = document.getElementById("alertasRecentesEmpty");
  const tbody = document.getElementById("alertasRecentesTbody");

  const kpiTotal = document.getElementById("kpiAlertasTotal");
  const kpiUltimo = document.getElementById("kpiAlertasUltimo");

  const diasEl = document.getElementById("alertasRecentesDias");
  const tipoEl = document.getElementById("alertasRecentesTipo");

  const dias = Number(diasEl ? diasEl.value : 14) || 14;
  const tipo = (tipoEl ? tipoEl.value : "").trim();

    // Normaliza tipos do log (ex.: PENDENCIAS_LOJA -> PENDENCIAS)
  const normTipo = (t) => {
  const x = String(t || "").toUpperCase().trim();
    if (x.startsWith("PENDENCIAS")) return "PENDENCIAS";
    if (x.startsWith("LIMITE")) return "LIMITE";
    if (x.startsWith("USO_IRREGULAR")) return "USO_IRREGULAR";
    if (x.startsWith("ITENS_IRREGULARES")) return "ITENS_IRREGULARES";
    return x; // fallback
  };

  // Reset UI
  if (loading) loading.classList.remove("hidden");
  if (empty) empty.classList.add("hidden");
  if (tbody) tbody.innerHTML = "";
  if (kpiTotal) kpiTotal.textContent = "‚Äî";
  if (kpiUltimo) kpiUltimo.textContent = "‚Äî";

  // Prote√ß√£o: google.script.run precisa existir
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    if (loading) loading.classList.add("hidden");
    if (empty) {
      empty.classList.remove("hidden");
      empty.textContent = "google.script.run n√£o dispon√≠vel. Abra pela URL do WebApp do Apps Script.";
    }
    return;
  }

  // Prote√ß√£o: DOM precisa existir
  if (!tbody) {
    if (loading) loading.classList.add("hidden");
    console.error("alertasRecentesTbody n√£o encontrado no DOM.");
    return;
  }

      const fmtTs = (ts) => {
      try {
        if (!ts) return "";

        // 1) Se j√° veio como Date (√†s vezes o Apps Script manda assim)
        if (ts instanceof Date) return ts.toLocaleString("pt-BR");

        const s = String(ts).trim();

        // 2) Se veio em formato BR: "dd/MM/yyyy HH:mm:ss" (ou sem segundos)
        const mBR = s.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
        if (mBR) {
          const dd = Number(mBR[1]);
          const mm = Number(mBR[2]);
          const yyyy = Number(mBR[3]);
          const HH = Number(mBR[4] || 0);
          const MI = Number(mBR[5] || 0);
          const SS = Number(mBR[6] || 0);

          const d = new Date(yyyy, mm - 1, dd, HH, MI, SS);
          return d.toLocaleString("pt-BR");
        }

        // 3) ISO (ex.: 2026-01-12T22:19:21.000Z) ou "yyyy-MM-dd HH:mm:ss"
        const d2 = new Date(s.replace(" ", "T"));
        return isNaN(d2.getTime()) ? s : d2.toLocaleString("pt-BR");
      } catch (e) {
        return String(ts || "");
      }
    };

  const badge = (t) => {
    const x = String(t || "").toUpperCase();
    if (x === "LIMITE") return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800'>Limite</span>";
    if (x.startsWith("PENDENCIAS")) return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800'>Pend√™ncias</span>";
    if (x.startsWith("USO_IRREGULAR")) return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-violet-100 text-violet-800'>Poss√≠vel irregularidade</span>";
    return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-800'>" + (t || "Outro") + "</span>";
  };

  google.script.run
    .withSuccessHandler(function (res) {
      try {
        if (loading) loading.classList.add("hidden");

        // Debug: te mostra no console o que voltou do backend
        console.log("[AlertasRecentes] res:", res);

        if (!res || !res.ok) {
          if (empty) {
            empty.classList.remove("hidden");
            empty.textContent =
          "Falha ao carregar alertas. " +
          (res && res.error ? res.error : "Sem mensagem de erro.") +
          " | payload=" + JSON.stringify(res);
          }
          return;
        }

        let rows = Array.isArray(res.rows) ? res.rows : [];
        if (tipo) {
        const tipoFiltro = String(tipo || "").toUpperCase().trim();
        rows = rows.filter(r => normTipo(r.tipo) === tipoFiltro);
      }

        if (!rows.length) {
          if (empty) empty.classList.remove("hidden");
          if (kpiTotal) kpiTotal.textContent = "0";
          if (kpiUltimo) kpiUltimo.textContent = "‚Äî";
          return;
        }

        if (kpiTotal) kpiTotal.textContent = String(rows.length);
        if (kpiUltimo) kpiUltimo.textContent = fmtTs(rows[0].timestamp || "‚Äî");

        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50";
          tr.innerHTML = `
            <td class="px-3 py-2 border-b text-xs text-slate-700 whitespace-nowrap">${fmtTs(r.timestamp || "")}</td>
            <td class="px-3 py-2 border-b">${badge(r.tipo)}</td>
            <td class="px-3 py-2 border-b text-slate-700 whitespace-nowrap">${(r.loja && String(r.loja).trim()) ? r.loja : "Consolidado"}</td>
            <td class="px-3 py-2 border-b text-slate-700 whitespace-nowrap">${(r.time && String(r.time).trim()) ? r.time : "Consolidado"}</td>
            <td class="px-3 py-2 border-b text-slate-700">${r.detalhe || ""}</td>
            <td class="px-3 py-2 border-b text-xs text-slate-500 whitespace-nowrap">${r.origem || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        // Se der erro aqui, antes ficava ‚Äúmudo‚Äù. Agora voc√™ vai ver.
        if (loading) loading.classList.add("hidden");
        if (empty) {
          empty.classList.remove("hidden");
          empty.textContent = "Erro ao renderizar alertas: " + (e && e.message ? e.message : e);
        }
        console.error("Erro ao renderizar Alertas Recentes:", e);
      }
    })
    .withFailureHandler(function (err) {
      if (loading) loading.classList.add("hidden");
      if (empty) {
        empty.classList.remove("hidden");
        empty.textContent = "Erro ao carregar alertas: " + (err && err.message ? err.message : err);
      }
      console.error("[AlertasRecentes] failure:", err);
    })
    .getAlertasRecentes(dias, 200);
}

function openAjudaVektorModal() {
  var modal = document.getElementById("ajudaVektorModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeAjudaVektorModal() {
  var modal = document.getElementById("ajudaVektorModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

document.addEventListener("click", function (e) {
  var modal = document.getElementById("ajudaVektorModal");
  if (!modal || modal.classList.contains("hidden")) return;

  // clicou no fundo escuro (overlay) -> fecha
  if (e.target === modal) closeAjudaVektorModal();
});

function openStatusVektorModal() {
  const modal = document.getElementById("statusVektorModal");
  if (modal) modal.style.display = "flex";

  // Helper seguro: s√≥ escreve se o elemento existir
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = (value == null || value === "") ? "‚Äî" : String(value);
  };

  // Status Geral (sempre vis√≠vel)
  setText("status-geral", "Em opera√ß√£o");

  // Manuten√ß√£o (somente admin, se existir no DOM)
  if (typeof VEKTOR_MANUTENCAO_ATIVA !== "undefined") {
    setText("status-manutencao", VEKTOR_MANUTENCAO_ATIVA ? "Em manuten√ß√£o" : "Em opera√ß√£o");
  } else {
    // se a constante n√£o existir, n√£o quebra
    setText("status-manutencao", "Em opera√ß√£o");
  }

  // Prote√ß√£o: se abriu fora do WebApp
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    setText("status-geral", "google.script.run indispon√≠vel (abra via WebApp).");
    return;
  }

  google.script.run
    .withSuccessHandler(function (data) {
      // Base (sempre vis√≠vel)
      setText("status-baseclara", data && (data.baseClara || data.baseclara));

      // Status Geral (sempre vis√≠vel)
      const geral = data && (data.geral || data.statusGeral);
      setText("status-geral", geral || "Em opera√ß√£o");

      // A partir daqui: campos admin-only (s√≥ preenche se existirem)
      setText("status-jobs", data && data.jobs);

      setText("status-ativos-hoje", data && (data.usuariosAtivosHoje ?? data.ativosHoje));

      // Servi√ßos Google (Apps Script / E-mail)
      const googleStatus = data && (data.google ?? data.googleStatus ?? data.servicosGoogle);
      setText("status-google", googleStatus || "Indispon√≠vel");

      // BigQuery
      const bigQueryStatus = data && (data.bigquery ?? data.bigQuery ?? data.bigQueryStatus);
      setText("status-bigquery", bigQueryStatus || "Indispon√≠vel");

    })
    .withFailureHandler(function (err) {
      const msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
      setText("status-geral", "Erro ao buscar status: " + msg);
    })
    .vektorStatusSistema();
}

// ===============================
// VIEW CONTROL (Chat <-> Radar)
// ===============================
window.vektorShowChatView = function () {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  // ‚úÖ Envio de Pend√™ncias
  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");

  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  // fecha outras views
  [
    radarView,
    feedbackView,
    myAlertsView,
    fluxView,
    envioPendView,
    cicloResumoView,
    homeView
  ].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.classList.remove("is-open");
    v.style.display = "none";
  });

  // fecha modal envio pend√™ncias (se estiver aberto)
  if (envPendModal) {
    envPendModal.classList.add("hidden");
    envPendModal.style.display = "none";
  }

  // ‚úÖ abre chat de verdade
  if (chatView) {
    chatView.classList.remove("hidden");     // <-- ESSE era o bug
    chatView.classList.add("is-open");
    chatView.style.display = "flex";
  }

  // ‚úÖ abrir modal "Como usar o Vektor?" apenas 1x por dia (por navegador)
  try {
    const now = new Date();
    const yyyy = String(now.getFullYear());
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const hojeKey = `${yyyy}-${mm}-${dd}`;

    const LS_KEY = "VEKTOR_CHAT_HELP_LAST_SHOWN_DAY";
    const last = localStorage.getItem(LS_KEY) || "";

    if (last !== hojeKey) {
      localStorage.setItem(LS_KEY, hojeKey);

      setTimeout(function () {
        if (typeof openAjudaVektorModal === "function") openAjudaVektorModal();
      }, 80);
    }
  } catch (e) {}

  const input = document.getElementById("userInput");
  if (input && !input.disabled) setTimeout(() => input.focus(), 50);
};

function vektorShowRadarView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  // fecha TODAS
  [chatView, feedbackView, myAlertsView, fluxView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (envPendModal) { envPendModal.classList.add("hidden"); envPendModal.style.display = "none"; }
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  // abre Radar
  if (radarView) {
    radarView.classList.remove("hidden");
    radarView.style.display = "block";
    radarView.classList.add("is-open");
  }
}

function vektorShowFeedbackView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  // fecha as demais p√°ginas
  if (chatView) chatView.classList.add("hidden");
  if (radarView) radarView.classList.add("hidden");
  if (myAlertsView) myAlertsView.classList.add("hidden");
  if (fluxView) fluxView.classList.add("hidden");

  // abre feedback
  if (feedbackView) feedbackView.classList.remove("hidden");

  // opcional: garante estado do radar
  if (radarView) radarView.classList.remove("is-open");
}

function vektorShowFluxogramaView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  [chatView, radarView, feedbackView, myAlertsView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (envPendModal) { envPendModal.classList.add("hidden"); envPendModal.style.display = "none"; }
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (fluxView) {
    fluxView.classList.remove("hidden");
    fluxView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
}

// ===============================
// ENVIO DE PEND√äNCIAS (view + modal + fluxo)
// ===============================
function vektorShowEnvioPendenciasView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  [chatView, radarView, feedbackView, myAlertsView, fluxView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (envioPendView) {
    envioPendView.classList.remove("hidden");
    envioPendView.style.display = "block";
  }

  // fecha modal (n√£o abre sozinho)
  if (envPendModal) {
    envPendModal.classList.add("hidden");
    envPendModal.style.display = "none";
  }

  if (radarView) radarView.classList.remove("is-open");
}

window.vektorOpenEnvioPendencias = function () {
  vektorShowEnvioPendenciasView_();
};

window.vektorOpenResumoCiclo = function () {
  window.vektorShowResumoCicloView_();
  window.vektorLoadResumoCiclo(false);
};

// ===============================
// RESUMO DO CICLO (FRONT)
// - agora: guarda dataset, cria/binda filtros (time/loja), aplica filtros,
//   e renderiza a TABELA com TODAS as linhas filtradas (n√£o top 10)
// ===============================
window.vektorLoadResumoCiclo = function (force) {
  const loading = document.getElementById("cicloResumoLoading");
  const content = document.getElementById("cicloResumoContent");
  const tbody = document.getElementById("cicloResumo_tbody");

setResumoCicloBusy_(true, "Carregando resumo do ciclo‚Ä¶");

  if (tbody) tbody.innerHTML = "";

  const fmtBRL = (n) => {
    try { return (Number(n || 0)).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }
    catch (e) { return String(n || 0); }
  };

  function setResumoCicloBusy_(isBusy, msg){
  const loading = document.getElementById("cicloResumoLoading");
  const content = document.getElementById("cicloResumoContent");

  const ov = document.getElementById("cicloResumo_overlay"); // <<< precisa existir no HTML
  const ovTitle = document.getElementById("cicloResumo_overlayTitle");
  const ovSub = document.getElementById("cicloResumo_overlaySub");

  // overlay (trava tela)
  if (ov) ov.style.display = isBusy ? "block" : "none";
  if (ovTitle) ovTitle.textContent = msg || (isBusy ? "Carregando‚Ä¶" : "");
  if (ovSub) ovSub.textContent = isBusy ? "Aguarde um instante." : "";

  // mensagem / loading (texto ‚ÄúCarregando resumo do ciclo‚Ä¶‚Äù)
  if (loading) {
    loading.textContent = msg || (isBusy ? "Carregando resumo do ciclo‚Ä¶ aguarde." : "");
    loading.style.display = isBusy ? "block" : "none";
  }

  if (content) content.style.opacity = isBusy ? "0.55" : "1";

  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");
  const btnLimpar = document.getElementById("cicloResumo_btnLimpar");
  const btnAtualizar = document.getElementById("cicloResumo_btnAtualizar");
  const btnAI = document.getElementById("cicloResumo_aiBtn");
  const btnCsv = document.getElementById("cicloResumo_btnCsv");

  [dtIniEl, dtFimEl, selTime, selLoja, btnLimpar, btnAtualizar, btnAI, btnCsv].forEach(el => {
    if (!el) return;
    el.disabled = !!isBusy;
    el.style.pointerEvents = isBusy ? "none" : "auto";
    el.style.opacity = isBusy ? "0.65" : "1";
  });
}

  function applyFiltros_(){
    const res = window.__cicloResumoData || {};
    const txAll = Array.isArray(res.tx) ? res.tx : [];

    const selTime = document.getElementById("cicloResumo_selTime");
    const selLoja = document.getElementById("cicloResumo_selLoja");
    const dtIniEl = document.getElementById("cicloResumo_dtIni");
    const dtFimEl = document.getElementById("cicloResumo_dtFim");

    const timeSel = (selTime && typeof selTime.value === "string") ? selTime.value : "";
    const lojaSel = (selLoja && typeof selLoja.value === "string") ? selLoja.value : "";

    const dtIni = (dtIniEl && dtIniEl.value) ? dtIniEl.value : "";
    const dtFim = (dtFimEl && dtFimEl.value) ? dtFimEl.value : "";

    // 1) filtro por datas (ISO yyyy-mm-dd)
    let tx = txAll.filter(r => {
      const d = String(r.dataISO || r.dataIso || "");
      if (dtIni && d < dtIni) return false;
      if (dtFim && d > dtFim) return false;
      return true;
    });

    // 2) repopula TIME com base no recorte de data
    const times = Array.from(new Set(tx.map(r => String(r.time || "N/D"))))
      .filter(Boolean)
      .sort((a,b)=>a.localeCompare(b, "pt-BR"));

    if (selTime) {
      const cur = timeSel;
      selTime.innerHTML = "<option value=''>Todos</option>" +
        times.map(t => `<option value="${String(t).replace(/"/g,"&quot;")}">${t}</option>`).join("");
      selTime.value = (cur && times.includes(cur)) ? cur : "";
    }

    // aplica TIME
    const timeNow = selTime ? (selTime.value || "") : "";
    if (timeNow) tx = tx.filter(r => String(r.time || "") === timeNow);

    // 3) repopula LOJA com base no recorte (data + time)
    const lojas = Array.from(new Set(tx.map(r => String(r.loja || ""))))
      .filter(Boolean)
      .sort((a,b)=>Number(a)-Number(b));

    if (selLoja) {
      const curL = lojaSel;
      selLoja.innerHTML = "<option value=''>Todas</option>" +
        lojas.map(l => `<option value="${l}">${l}</option>`).join("");
      selLoja.value = (curL && lojas.includes(curL)) ? curL : "";
    }

    // aplica LOJA
    const lojaNow = selLoja ? (selLoja.value || "") : "";
    if (lojaNow) tx = tx.filter(r => String(r.loja || "") === lojaNow);

    // ‚úÖ fonte √∫nica do recorte atual (IA usa isso)
      window.__cicloResumoTxFiltered = tx;

    // 4) recalcula cards (consistente com filtros)
    const lojasSet = {};
    let totalPend = 0;
    let totalValor = 0;

    const aggTime = {};
    const aggLoja = {};

    tx.forEach(r => {
      const loja = String(r.loja || "");
      const time = String(r.time || "N/D");
      const pend = Number(r.pendCount || 0);
      const val  = Number(r.valor || 0);

      if (loja) lojasSet[loja] = true;
      totalPend += pend;
      totalValor += val;

      aggTime[time] = aggTime[time] || { k: time, pend: 0 };
      aggTime[time].pend += pend;

      aggLoja[loja] = aggLoja[loja] || { k: loja, pend: 0 };
      aggLoja[loja].pend += pend;
    });

    function pickTop(obj){
      let best = null;
      Object.keys(obj).forEach(k=>{
        if (!best || obj[k].pend > best.pend) best = obj[k];
      });
      return best;
    }

    const topT = pickTop(aggTime);
    const topL = pickTop(aggLoja);

    const elTotLojas = document.getElementById("cicloResumo_totalLojas");
    const elTotPend  = document.getElementById("cicloResumo_totalPend");
    const elTotValor = document.getElementById("cicloResumo_totalValor");
    const elTopTime  = document.getElementById("cicloResumo_topTime");
    const elTopTimeSub = document.getElementById("cicloResumo_topTimeSub");
    const elTopLoja  = document.getElementById("cicloResumo_topLoja");
    const elTopLojaSub = document.getElementById("cicloResumo_topLojaSub");

    if (elTotLojas) elTotLojas.textContent = String(Object.keys(lojasSet).length);
    if (elTotPend)  elTotPend.textContent  = String(totalPend);
    if (elTotValor) elTotValor.textContent = fmtBRL(totalValor);

    if (elTopTime) elTopTime.textContent = topT ? topT.k : "‚Äî";
    if (elTopTimeSub) elTopTimeSub.textContent = topT ? `${topT.pend} pend√™ncias` : "‚Äî";

    if (elTopLoja) elTopLoja.textContent = topL ? topL.k : "‚Äî";
    if (elTopLojaSub) elTopLojaSub.textContent = topL ? `${topL.pend} pend√™ncias` : "‚Äî";

    // 5) ordena√ß√£o
    window.__cicloResumoSort = window.__cicloResumoSort || { col: "valor", dir: "desc" };
    const sort = window.__cicloResumoSort;

    function cmp(a,b){
      const dir = (sort.dir === "asc") ? 1 : -1;
      const col = sort.col || "valor";

      const va = a[col];
      const vb = b[col];

      if (col === "valor" || col === "pendCount") return (Number(va||0) - Number(vb||0)) * dir;
      if (col === "loja") return (Number(va||0) - Number(vb||0)) * dir;

      // dataISO √© yyyy-mm-dd: comparar string funciona
      return String(va||"").localeCompare(String(vb||""), "pt-BR") * dir;
    }

    tx.sort(cmp);

    window.__cicloResumoTxExport = tx.slice();

    // 6) render tabela (detalhada)
    if (!tbody) return;

    if (!tx.length) {
      tbody.innerHTML = "<tr><td colspan='7' style='padding:10px;'>Sem transa√ß√µes pendentes no recorte.</td></tr>";
      return;
    }

    tbody.innerHTML = tx.map(r => `
      <tr class="cicloResumoRow">
        <td>${r.loja || "‚Äî"}</td>
        <td>${r.time || "N/D"}</td>
        <td style="white-space:nowrap;">${r.dataBR || "‚Äî"}</td>
        <td style="max-width:420px;">${(r.estabelecimento || "‚Äî")}</td>
        <td style="text-align:right; white-space:nowrap;">${r.valorBRL || fmtBRL(r.valor)}</td>
        <td style="max-width:260px;">${(r.categoria || "‚Äî")}</td>
        <td style="max-width:320px;">${(r.pendencias || "‚Äî")}</td>
      </tr>
    `).join("");
  }

  // exp√µe limpar filtros (se voc√™ tiver bot√£o de limpar)
  window.vektorResumoCicloLimparFiltros = function () {
    const selTime = document.getElementById("cicloResumo_selTime");
    const selLoja = document.getElementById("cicloResumo_selLoja");
    const dtIniEl = document.getElementById("cicloResumo_dtIni");
    const dtFimEl = document.getElementById("cicloResumo_dtFim");

    if (selTime) selTime.value = "";
    if (selLoja) selLoja.value = "";
    // datas: mant√©m como est√£o (ou zera se voc√™ quiser)
    applyFiltros_();
  };

  function exportCsv_(rows){
  rows = Array.isArray(rows) ? rows : [];
  if (!rows.length) {
    alert("Sem dados para exportar no filtro atual.");
    return;
  }

  const header = ["Loja", "Time", "Data da transa√ß√£o", "Estabelecimento", "Valor", "Categoria", "Pend√™ncias"];

  const esc = (v) => {
    const s = String(v ?? "");
    if (/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };

  const lines = [];
  lines.push(header.join(";"));

  rows.forEach(r => {
    lines.push([
      esc(r.loja || "‚Äî"),
      esc(r.time || "N/D"),
      esc(r.dataBR || r.dataTxt || "‚Äî"),
      esc(r.estabelecimento || "‚Äî"),
      esc(r.valorBRL || (typeof r.valor === "number" ? r.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}) : (r.valor || ""))),
      esc(r.categoria || "‚Äî"),
      esc(r.pendencias || "‚Äî")
    ].join(";"));
  });

  const csv = "\uFEFF" + lines.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const dtIni = dtIniEl && dtIniEl.value ? dtIniEl.value : "";
  const dtFim = dtFimEl && dtFimEl.value ? dtFimEl.value : "";

  const fileName = `resumo_ciclo_pendencias_${dtIni || "ini"}_${dtFim || "fim"}.csv`;

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 0);
}

setResumoCicloBusy_(true, "Carregando resumo do ciclo‚Ä¶");

  google.script.run
    .withSuccessHandler(function (res) {
      setResumoCicloBusy_(false);

      if (!res || !res.ok) {
        if (content) content.style.display = "block";
        if (tbody) tbody.innerHTML = "<tr><td colspan='7' style='padding:10px;color:#111;'>Falha ao carregar resumo.</td></tr>";
        return;
      }

      if (content) content.style.display = "block";

            // ‚úÖ NORMALIZA tx (back devolve dataIso/dataTxt/valorTxt e flags; front usa dataISO/dataBR/valorBRL/pendCount)
      try {
        if (res && Array.isArray(res.tx)) {
          res.tx = res.tx.map(r => {
            const pendNF = Number(r.pendNF || 0);
            const pendEtiqueta = Number(r.pendEtiqueta || 0);
            const pendDesc = Number(r.pendDesc || 0);

            return {
              ...r,
              // datas
              dataISO: r.dataISO || r.dataIso || "",
              dataBR:  r.dataBR  || r.dataTxt || "",
              // valor
              valorBRL: r.valorBRL || r.valorTxt || "",
              // contagem de pend√™ncias
              pendCount: (r.pendCount != null) ? Number(r.pendCount || 0) : (pendNF + pendEtiqueta + pendDesc),
              // string pend√™ncias (garante)
              pendencias: r.pendencias || "",
            };
          });
        }
      } catch(_) {}

      // ‚úÖ guarda dataset inteiro para filtros
      window.__cicloResumoData = res;

      // ‚úÖ bind bot√£o CSV (1x)
        try {
          const btnCsv = document.getElementById("cicloResumo_btnCsv");
          if (btnCsv && !btnCsv.__bindCsv) {
            btnCsv.__bindCsv = true;
            btnCsv.addEventListener("click", function(){
              const rows = Array.isArray(window.__cicloResumoTxExport) ? window.__cicloResumoTxExport : [];
              exportCsv_(rows);
            });
          }
        } catch(_) {}

      // cabe√ßalho (per√≠odo)
      const sub = document.getElementById("cicloResumoSubTitle");
      if (sub && res.periodo && res.periodo.inicio && res.periodo.fim) {
        sub.textContent = `Consolidado das pend√™ncias no ciclo atual (${res.periodo.inicio} ‚Üí ${res.periodo.fim})`;
      }

      // =========================================================
      // 3) DATE RANGE (dtIni/dtFim) ‚Äî BLOCO COMPLETO (min/max + bind)
      // (cole aqui mesmo: depois do subt√≠tulo e antes do bind dos filtros)
      // =========================================================
      try {
        const dtIniEl = document.getElementById("cicloResumo_dtIni");
        const dtFimEl = document.getElementById("cicloResumo_dtFim");

        if (dtIniEl && dtFimEl && res && res.periodo && res.periodo.inicio && res.periodo.fim) {
          function br2iso(br){
            const m = String(br||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (!m) return "";
            return `${m[3]}-${m[2]}-${m[1]}`;
          }
          const min = br2iso(res.periodo.inicio);
          const max = br2iso(res.periodo.fim);

          if (min) { dtIniEl.min = min; dtFimEl.min = min; }
          if (max) { dtIniEl.max = max; dtFimEl.max = max; }

          if (!dtIniEl.value && min) dtIniEl.value = min;
          if (!dtFimEl.value && max) dtFimEl.value = max;

          if (!dtIniEl.__bindResumo) {
            dtIniEl.__bindResumo = true;
            dtIniEl.addEventListener("change", applyFiltros_);
          }
          if (!dtFimEl.__bindResumo) {
            dtFimEl.__bindResumo = true;
            dtFimEl.addEventListener("change", applyFiltros_);
          }
        }
      } catch(_) {}

      // ‚úÖ bind dos filtros (uma vez s√≥)
      try {
        const selTime = document.getElementById("cicloResumo_selTime");
        const selLoja = document.getElementById("cicloResumo_selLoja");

        if (selTime && !selTime.__bindResumo) {
          selTime.__bindResumo = true;
          selTime.addEventListener("change", function () {
            if (selLoja) selLoja.value = "";
            applyFiltros_();
          });
        }

        if (selLoja && !selLoja.__bindResumo) {
          selLoja.__bindResumo = true;
          selLoja.addEventListener("change", function () {
            applyFiltros_();
          });
        }
      } catch (e) {}

      // =========================================================
      // 4.2) SORT NO THEAD ‚Äî BLOCO COMPLETO (bind 1x)
      // (cole aqui: depois do bind dos filtros e antes do applyFiltros_())
      // =========================================================
      try {
        const thead = document.querySelector("#cicloResumoTable thead");
        if (thead && !thead.__bindSortResumo) {
          thead.__bindSortResumo = true;
          thead.addEventListener("click", function(ev){
            const th = ev.target && ev.target.closest ? ev.target.closest("th[data-sort]") : null;
            if (!th) return;

            const col = th.getAttribute("data-sort") || "";
            if (!col) return;

            window.__cicloResumoSort = window.__cicloResumoSort || { col: "valor", dir: "desc" };

            if (window.__cicloResumoSort.col === col) {
              window.__cicloResumoSort.dir = (window.__cicloResumoSort.dir === "desc") ? "asc" : "desc";
            } else {
              window.__cicloResumoSort.col = col;
              window.__cicloResumoSort.dir = "desc";
            }

            applyFiltros_();
          });
        }
      } catch(_) {}

      // ‚úÖ render inicial
      applyFiltros_();
    })
    .withFailureHandler(function (err) {
      setResumoCicloBusy_(false);
      if (loading) loading.style.display = "none";
      if (content) content.style.display = "block";
      if (tbody) tbody.innerHTML = "<tr><td colspan='7' style='padding:10px;color:#111;'>Erro no backend.</td></tr>";
    })
    .getResumoCicloPendencias();
};

function vektorResumoCicloBuildAI_(data, opts){
  opts = opts || {};
  const periodoTxt = opts.periodoTxt || "";
  const filtroTxt  = opts.filtroTxt  || "";

  const tx = (data && Array.isArray(data.tx)) ? data.tx : [];
  const totalTx = tx.length;

  if (!totalTx){
    return `
      <div style="padding:14px 16px;">
        <div style="font-weight:1000; font-size:15px; color:#0f172a;">Leitura do cen√°rio</div>
        <div style="margin-top:6px; font-size:13px; color:#334155; line-height:1.5;">
          No recorte atual (${periodoTxt}${filtroTxt ? " ‚Ä¢ " + filtroTxt : ""}), n√£o existem transa√ß√µes pendentes.
          Se voc√™ esperava ver casos aqui, o problema provavelmente est√° na carga/consulta do backend (dados n√£o chegando no resumo).
        </div>
      </div>
    `;
  }

  // helpers
  const asNum = (v) => (typeof v === "number" && isFinite(v)) ? v : 0;
  const pct = (a, b) => b ? Math.round((a / b) * 100) : 0;

  // total valor pendente (se existir)
  let totalValor = 0;
  for (const r of tx) totalValor += asNum(r.valor);

  // concentra√ß√£o por time / loja
  const byTime = {};
  const byLoja = {};
  const byCatCompra = {}; // categoria da compra
  let nf = 0, etiq = 0, desc = 0;

  // ‚úÖ NOVO: datas com mais pend√™ncias
  const byData = {}; // "dd/MM/yyyy" -> totalPendenciasNoDia

  const getPendCount = (r) => {
    // preferir pendCount se existir; sen√£o soma flags
    if (r && r.pendCount != null && isFinite(Number(r.pendCount))) return Number(r.pendCount) || 0;
    const a = Number(r.pendNF || 0) + Number(r.pendEtiqueta || 0) + Number(r.pendDesc || 0);
    // fallback extra (caso algum nome antigo apare√ßa)
    const b = Number(r.pendDescricao || 0);
    return a + b;
  };

  for (const r of tx){
    const time = (r.time || "Sem time").trim();
    const loja = (r.loja || r.lojaNum || "Sem loja").toString().trim();
    const cat  = (r.categoria || r.categoriaCompra || "Sem categoria").trim();

    byTime[time] = (byTime[time] || 0) + 1;
    byLoja[loja] = (byLoja[loja] || 0) + 1;
    byCatCompra[cat] = (byCatCompra[cat] || 0) + 1;
    
    const dataKey = String((r.dataBR || r.dataTxt || "")).trim() || "Sem data";
    byData[dataKey] = (byData[dataKey] || 0) + getPendCount(r);

    if (r.pendNF) nf++;
    if (r.pendEtiqueta) etiq++;
    if (r.pendDesc) desc++;
  }

  const topN = (obj, n) =>
    Object.entries(obj)
      .sort((a,b) => b[1] - a[1])
      .slice(0, n);

  const topTimes = topN(byTime, 3);
  const topLojas = topN(byLoja, 3);
  const topCats  = topN(byCatCompra, 4);

  const topTime = topTimes[0] ? { k: topTimes[0][0], v: topTimes[0][1] } : null;
  const topLoja = topLojas[0] ? { k: topLojas[0][0], v: topLojas[0][1] } : null;

  // ‚Äúnatureza‚Äù do problema (tipos de pend√™ncia)
  // OBS: uma tx pode contar em mais de um tipo
  const domTipo = (() => {
    const arr = [
      ["Nota fiscal/Recibo", nf],
      ["Etiqueta", etiq],
      ["Descri√ß√£o", desc],
    ].sort((a,b)=>b[1]-a[1]);
    return arr[0];
  })();

  const fmtMoney = (v) => {
    try { return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" }); }
    catch(_){ return "R$ " + (Math.round(v*100)/100).toFixed(2).replace(".",","); }
  };

  // Heur√≠stica de ‚Äúconcentra√ß√£o‚Äù (pra texto ficar √∫til)
  const concTime = topTime ? pct(topTime.v, totalTx) : 0;
  const concLoja = topLoja ? pct(topLoja.v, totalTx) : 0;

  const concMsg = (() => {
    if (concTime >= 35) return "H√° uma concentra√ß√£o relevante em um √∫nico time, o que sugere falha local de disciplina/processo.";
    if (concLoja >= 25) return "H√° uma concentra√ß√£o relevante em uma loja espec√≠fica, sugerindo gargalo operacional (rotina/treinamento/gest√£o).";
    return "As pend√™ncias est√£o relativamente distribu√≠das, o que sugere um tema mais sist√™mico (processo/treinamento geral).";
  })();

  // monta texto explicativo
  const topTimesTxt = topTimes.map(([k,v]) => `‚Ä¢ ${k}: ${v} (${pct(v,totalTx)}%)`).join("<br/>");
  const topLojasTxt = topLojas.map(([k,v]) => `‚Ä¢ ${k}: ${v} (${pct(v,totalTx)}%)`).join("<br/>");
  const topCatsTxt  = topCats.map(([k,v]) => `‚Ä¢ ${k}: ${v} (${pct(v,totalTx)}%)`).join("<br/>");

  const topDatas = Object.entries(byData)
  .filter(([k,v]) => k && k !== "Sem data" && Number(v) > 0)
  .sort((a,b) => (Number(b[1]) - Number(a[1])))
  .slice(0, 6);

  const topDatasTxt = topDatas
  .map(([k,v]) => `‚Ä¢ ${k}: <b>${v}</b>`)
  .join("<br/>");

  return `
    <div style="padding:14px 16px;">
      <div style="font-weight:1000; font-size:15px; color:#0f172a;">Leitura do cen√°rio</div>
      <div style="margin-top:6px; font-size:13px; color:#334155; line-height:1.55;">
        No recorte atual (${periodoTxt}${filtroTxt ? " ‚Ä¢ " + filtroTxt : ""}), existem
        <b>${totalTx}</b> transa√ß√µes com pend√™ncia, somando <b>${fmtMoney(totalValor)}</b> em valor associado.
        ${topTime ? `O principal foco √© o time <b>${topTime.k}</b> (${topTime.v}, ${concTime}%).` : ""}
        ${topLoja ? `A loja mais cr√≠tica √© <b>${topLoja.k}</b> (${topLoja.v}, ${concLoja}%).` : ""}
      </div>

      <div style="margin-top:10px; font-size:13px; color:#334155; line-height:1.55;">
        <b>Interpreta√ß√£o:</b> ${concMsg}
      </div>

      <div style="margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Onde est√° concentrando</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            <div style="font-weight:900; color:#0f172a;">Top times</div>
            ${topTimesTxt || "‚Äî"}
            <div style="margin-top:10px; font-weight:900; color:#0f172a;">Top lojas</div>
            ${topLojasTxt || "‚Äî"}
          </div>
        </div>

        <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Natureza do problema</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            <div>‚Ä¢ Nota fiscal/Recibo: <b>${nf}</b></div>
            <div>‚Ä¢ Etiqueta: <b>${etiq}</b></div>
            <div>‚Ä¢ Descri√ß√£o: <b>${desc}</b></div>
            <div style="margin-top:8px;">
              <b>Ponto dominante:</b> ${domTipo[0]} (${domTipo[1]} ocorr√™ncias).
              <span style="opacity:0.9;">(uma mesma transa√ß√£o pode ter mais de um tipo de pend√™ncia)</span>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Categorias de compra mais envolvidas</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            ${topCatsTxt || "Sem dados de categoria no recorte."}
          </div>
        </div>

        <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Datas com mais pend√™ncias</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            ${topDatasTxt || "Sem dados de data no recorte."}
          </div>
        </div>
      </div>

      <div style="margin-top:12px; background:rgba(181,255,32,0.12); border:1px solid rgba(181,255,32,0.45); border-radius:14px; padding:12px;">
        <div style="font-weight:1000; color:#0f172a;">A√ß√µes recomendadas (objetivas)</div>
        <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.55;">
          1) Priorize o time/loja l√≠der do ranking (ataca onde d√≥i mais).<br/>
          2) Se o dominante for <b>${domTipo[0]}</b>, padronize a rotina (checklist + cobran√ßa di√°ria) e valide se o problema √© captura ou anexa√ß√£o.<br/>
          3) Use o detalhamento por categoria de compra para focar em fornecedores/rotas que geram mais pend√™ncia (ex.: combust√≠vel, manuten√ß√£o, alimenta√ß√£o).<br/>
          4) Se a concentra√ß√£o estiver alta, trate como falha local; se estiver distribu√≠da, trate como ajuste de processo/treinamento em rede.
        </div>
      </div>
    </div>
  `;
}

function vektorResumoCicloOpenAI_(){
  const bg = document.getElementById("cicloResumoAI");
  const body = document.getElementById("cicloResumoAIBody");
  if (!bg || !body) return;

  // usa SEMPRE o recorte j√° filtrado pela tela (applyFiltros_/Apply_)
  const tx = Array.isArray(window.__cicloResumoTxFiltered) ? window.__cicloResumoTxFiltered : [];

  // texto do per√≠odo (se inputs existirem)
  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const dtIni = dtIniEl && dtIniEl.value ? dtIniEl.value : "";
  const dtFim = dtFimEl && dtFimEl.value ? dtFimEl.value : "";

  const periodoTxt = (dtIni && dtFim)
    ? `${dtIni.split("-").reverse().join("/") } ‚Üí ${dtFim.split("-").reverse().join("/")}`
    : "";

  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");
  const filtroTxt = [
    selTime && selTime.value ? `Time: ${selTime.value}` : "Time: Todos",
    selLoja && selLoja.value ? `Loja: ${selLoja.value}` : ""
  ].filter(Boolean).join(" ‚Ä¢ ");

  body.innerHTML = vektorResumoCicloBuildAI_({ tx }, { periodoTxt, filtroTxt });

  bg.style.display = "block";
}

function vektorResumoCicloCloseAI_(){
  const bg = document.getElementById("cicloResumoAI");
  if (bg) bg.style.display = "none";
}

// bind 1x
try{
  const btn = document.getElementById("cicloResumo_aiBtn");
  const close = document.getElementById("cicloResumoAIClose");
  const bg = document.getElementById("cicloResumoAI");

  if (btn && !btn.__bindAI){
    btn.__bindAI = true;
    btn.addEventListener("click", vektorResumoCicloOpenAI_);
  }
  if (close && !close.__bindAI){
    close.__bindAI = true;
    close.addEventListener("click", vektorResumoCicloCloseAI_);
  }
  if (bg && !bg.__bindAI){
    bg.__bindAI = true;
    bg.addEventListener("mousedown", function(ev){
      if (ev.target === bg) vektorResumoCicloCloseAI_();
    });
    document.addEventListener("keydown", function(ev){
      if (ev.key === "Escape") vektorResumoCicloCloseAI_();
    });
  }
} catch(_){}


// estado local da p√°gina
window.__envPend = {
  periodo: { iniIso: "", fimIso: "" },
  rows: [],        // preview detalhado
  selected: {},    // txKey -> true/false
  resumo: null
};

window.vektorEnvioPendenciasAbrirModal = function () {
  const m = document.getElementById("envPendModal");
  if (!m) return;

  // ‚úÖ desfaz o "display:none" que a view aplica
  m.classList.remove("hidden");
  m.style.display = "block";
};

window.vektorEnvioPendenciasFecharModal = function () {
  const m = document.getElementById("envPendModal");
  if (!m) return;

  m.classList.add("hidden");
  m.style.display = "none";
};

window.vektorEnvPendSelectAll = function (on) {
  (window.__envPend.rows || []).forEach(r => {
    if (r.jaEnviado) return; // n√£o deixa marcar linhas j√° enviadas
    window.__envPend.selected[r.txKey] = !!on;
  });
  window.__renderEnvPendTbody();
};

window.vektorEnvPendExportCsv = function () {
  try {
    var rows = (window.__envPend && Array.isArray(window.__envPend.rows)) ? window.__envPend.rows : [];

    // CSV pt-BR: separador ;
    function esc(v) {
      var s = (v === null || v === undefined) ? "" : String(v);
      s = s.replace(/"/g, '""');
      return '"' + s + '"';
    }

    var header = ["Loja", "Data Transa√ß√£o", "Estabelecimento", "Valor", "Cart√£o", "Pend√™ncias", "J√° enviado?"];
    var lines = [];
    lines.push(header.map(esc).join(";"));

    rows.forEach(function (r) {
      lines.push([
        r.lojaKey || "",
        r.dataTransBR || "",
        r.estabelecimento || "",
        r.valorOriginalTxt || "",
        r.cartao || "",
        r.pendenciasTxt || "",
        (r.jaEnviado ? "SIM" : "N√ÉO")
      ].map(esc).join(";"));
    });

    var csv = lines.join("\n");

    // nome do arquivo com per√≠odo (quando existir)
    var ini = (window.__envPend && window.__envPend.periodo && window.__envPend.periodo.iniIso) ? String(window.__envPend.periodo.iniIso).slice(0, 10) : "ini";
    var fim = (window.__envPend && window.__envPend.periodo && window.__envPend.periodo.fimIso) ? String(window.__envPend.periodo.fimIso).slice(0, 10) : "fim";
    var filename = "Vektor_Pendencias_" + ini + "_" + fim + ".csv";

    var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    var url = URL.createObjectURL(blob);

    var a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    setTimeout(function () {
      try { URL.revokeObjectURL(url); } catch (_) {}
      try { document.body.removeChild(a); } catch (_) {}
    }, 0);

  } catch (e) {
    console.error("Falha ao exportar CSV (Envio de Pend√™ncias):", e);
    if (window.vektorEnvPendToast_) {
      window.vektorEnvPendToast_("Falha ao exportar CSV.", "error");
    }
  }
};

window.__renderEnvPendTbody = function () {
  const tb = document.getElementById("envPend_tbody");
  if (!tb) return;
  const rows = window.__envPend.rows || [];
  tb.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.style.borderBottom = "1px solid rgba(148,163,184,0.15)";

    const checked = !!window.__envPend.selected[r.txKey];
    const disabled = !!r.jaEnviado;

    tr.innerHTML =
      `<td style="padding:8px;">
        <input type="checkbox" ${checked ? "checked" : ""} ${disabled ? "disabled" : ""}
          onchange="window.__envPend.selected['${r.txKey}']=this.checked" />
      </td>
      <td style="padding:8px; white-space:nowrap;">${r.lojaKey || ""}</td>
      <td style="padding:8px; white-space:nowrap;">${r.dataTransBR || ""}</td>
      <td style="padding:8px;">${(r.estabelecimento || "").replace(/</g,"&lt;")}</td>
      <td style="padding:8px; white-space:nowrap;">${r.valorOriginalTxt || ""}</td>
      <td style="padding:8px; white-space:nowrap;">${r.cartao || ""}</td>
      <td style="padding:8px;"><b>${r.pendenciasTxt || ""}</b></td>
      <td style="padding:8px; white-space:nowrap; color:${r.jaEnviado ? "rgba(34,197,94,0.95)" : "rgba(226,232,240,0.7)"};">
        ${r.jaEnviado ? "SIM" : "N√ÉO"}
      </td>`;

    tb.appendChild(tr);
  });
};

window.vektorGlobalLoadingShow_ = function(titulo, subtitulo) {
  const ov = document.getElementById("envPend_overlay");

  // ‚úÖ IDs corretos do overlay existente (os mesmos do Envio de Pend√™ncias)
  const t = document.getElementById("envPend_overlayTitle") || document.getElementById("envPend_overlay_title");
  const s = document.getElementById("envPend_overlaySub")   || document.getElementById("envPend_overlay_sub");

  if (t) t.textContent = titulo || "Carregando‚Ä¶";
  if (s) s.textContent = subtitulo || "Aguarde.";

  // ‚úÖ o overlay do HTML foi criado com display:block (n√£o flex)
  if (ov) ov.style.display = "block";
};

window.vektorGlobalLoadingHide_ = function() {
  const ov = document.getElementById("envPend_overlay");
  if (ov) ov.style.display = "none";
};

window.vektorEnvPendOverlayShow_ = function(title, sub){
  const ov = document.getElementById("envPend_overlay");
  const t  = document.getElementById("envPend_overlayTitle");
  const s  = document.getElementById("envPend_overlaySub");
  if (t) t.textContent = String(title || "Carregando‚Ä¶");
  if (s) s.textContent = String(sub || "Aguarde um instante.");
  if (ov) ov.style.display = "block";
};

window.vektorEnvPendOverlayHide_ = function(){
  const ov = document.getElementById("envPend_overlay");
  if (ov) ov.style.display = "none";
};

window.vektorEnvPendLojasPopupClose_ = function(){
  const pop = document.getElementById("envPendLojasPopup");
  if (pop) pop.style.display = "none";

  // destr√≥i chart anterior (evita ‚Äúduplicar‚Äù canvas / memory leak)
  try {
    if (window.__envPend && window.__envPend.__lojasChart) {
      window.__envPend.__lojasChart.destroy();
      window.__envPend.__lojasChart = null;
    }
  } catch(_) {}
};

window.vektorEnvPendRenderLojasChart_ = function () {
  const canvas = document.getElementById("envPendLojasChart");
  if (!canvas) return;

  const resumo = (window.__envPend && window.__envPend.resumo) ? window.__envPend.resumo : {};
  const arr = Array.isArray(resumo.lojasValor) ? resumo.lojasValor : [];

  // ‚úÖ filtro por Time (usa arr com {lojaKey, valor, time})
  const sel = document.getElementById("envPendLojasTimeFilter");

  // popula op√ß√µes 1x (ou quando mudar o conjunto)
  try {
    if (sel && !sel.__filled) {
      const times = Array.from(
        new Set(arr.map(x => String(x.time || "‚Äî").trim()).filter(Boolean))
      ).sort((a, b) => a.localeCompare(b));

      // mant√©m primeira op√ß√£o "Todos" e repopula
      sel.innerHTML =
        "<option value=''>Todos</option>" +
        times.map(t => `<option value="${t.replace(/"/g, "&quot;")}">${t}</option>`).join("");

      sel.__filled = true;

      // onchange -> redesenha
      sel.onchange = function () {
        window.vektorEnvPendRenderLojasChart_();
      };
    }
  } catch (_) {}

  const timeSel = (sel && typeof sel.value === "string") ? sel.value : "";
  const arrFiltrado = timeSel ? arr.filter(x => String(x.time || "‚Äî").trim() === timeSel) : arr;

  // labels e valores
  const labels = arrFiltrado.map(x => String(x.lojaKey || ""));
  const values = arrFiltrado.map(x => Number(x.valor || 0));
  const maxV = values.reduce((m, v) => Math.max(m, Number(v) || 0), 0);
  const suggestedMaxX = maxV ? (maxV * 1.12) : 0; // 12% de folga pro r√≥tulo caber

  // altura din√¢mica (para permitir MUITAS lojas com scroll)
  const rowH = 22; // ‚Äúgrossura‚Äù por barra
  const topPad = 14;
  const minH = 260;
  const desiredH = topPad + labels.length * rowH;
  canvas.height = Math.max(minH, desiredH);

  // formata BRL
  const fmtBRL = (n) => (Number(n) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  // destroy antigo
  try {
    if (window.__envPend && window.__envPend.__lojasChart) {
      window.__envPend.__lojasChart.destroy();
      window.__envPend.__lojasChart = null;
    }
  } catch (_) {}

  const ctx = canvas.getContext("2d");

  // Chart.js + DataLabels
  try {
    if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
      Chart.register(ChartDataLabels);
    }
  } catch (_) {}

  window.__envPend.__lojasChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Valor pendente (R$)",
        data: values,
        backgroundColor: "#005E27",
        borderRadius: 10,
        categoryPercentage: 0.75,
        barPercentage: 0.85
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y",

      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              return " " + fmtBRL(context.parsed.x);
            }
          }
        },
        datalabels: {
          color: "#0f172a",
          anchor: "end",
          align: "right",
          clamp: true,
          clip: false,
          formatter: function (v) { return fmtBRL(v); },
          font: { weight: "700", size: 11 }
        }
      }, // ‚úÖ v√≠rgula correta aqui (fecha plugins)

      layout: { padding: { right: 120, left: 10, top: 10, bottom: 10 } },

      scales: {
        x: {
          suggestedMax: suggestedMaxX,
          ticks: {
            callback: function (v) { return fmtBRL(v); }
          }
        },
        y: {
          ticks: { autoSkip: false }
        }
      }
    }
  });
};

window.vektorEnvPendLojasPopupOpen_ = function(){
  const pop = document.getElementById("envPendLojasPopup");
  if (!pop) return;

  const sub = document.getElementById("envPendLojasPopupSub");
  const periodo = (window.__envPend && window.__envPend.resumo && window.__envPend.resumo.periodo) ? window.__envPend.resumo.periodo : null;
  if (sub) {
    sub.textContent = periodo ? (`Per√≠odo: ${periodo.inicio || ""} ‚Üí ${periodo.fim || ""}`) : "";
  }

  pop.style.display = "block";
    // ‚úÖ reset do filtro a cada abertura (evita ficar ‚Äúpreso‚Äù em times antigos)
  const sel = document.getElementById("envPendLojasTimeFilter");
  if (sel) {
    sel.__filled = false; // for√ßa repopular
    sel.value = "";
  }
  window.vektorEnvPendRenderLojasChart_();
};

// fecha clicando no ‚Äúfundo‚Äù escuro
document.addEventListener("click", function(ev){
  const pop = document.getElementById("envPendLojasPopup");
  if (!pop || pop.style.display !== "block") return;
  if (ev.target === pop) window.vektorEnvPendLojasPopupClose_();
});

// fecha com ESC
document.addEventListener("keydown", function(ev){
  if (ev.key === "Escape") {
    window.vektorEnvPendLojasPopupClose_();
  }
});

window.vektorEnvioPendenciasPreview = function () {
  try {
    const ini = document.getElementById("envPend_ini")?.value || "";
    const fim = document.getElementById("envPend_fim")?.value || "";
    const st = document.getElementById("envPend_statusText");
    const resumoEl = document.getElementById("envPend_resumo");
    const falhasEl = document.getElementById("envPend_falhas");

    if (falhasEl) falhasEl.innerHTML = "";
    if (!ini || !fim) {
      if (st) st.textContent = "Informe data inicial e final.";
      return;
    }

    // ‚úÖ envie "YYYY-MM-DD" puro (sem ISO/UTC)
    const iniIso = String(ini || "").trim();
    const fimIso = String(fim || "").trim();
    window.__envPend.periodo = { iniIso, fimIso };


    window.vektorEnvPendOverlayShow_("Gerando pr√©via, aguarde‚Ä¶", "Consultando Transa√ß√µes e preparando os dados.");

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          if (st) st.textContent = "Falha ao gerar pr√©via.";

          const errTxt =
            (res && (res.error || res.erro || res.message)) ?
              String(res.error || res.erro || res.message) :
              ("Erro desconhecido. Resposta do backend: " + JSON.stringify(res || {}, null, 2));

          if (resumoEl) resumoEl.textContent = errTxt;
          const bx = document.getElementById("envPend_statusCards");
            if (bx) bx.innerHTML = "";

            window.vektorEnvPendOverlayHide_();

          return;
        }

        window.__envPend.rows = res.rows || [];
        window.__envPend.resumo = res.resumo || null;

        // default: marca tudo que N√ÉO foi enviado ainda
        window.__envPend.selected = {};
        window.__envPend.rows.forEach(r => {
          if (!r.jaEnviado) window.__envPend.selected[r.txKey] = true;
        });

        // resumo
        const R = res.resumo || {};
        const money = (Number(R.totalValor || 0)).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const pct = (x) => ((x || 0) * 100).toFixed(1).replace(".", ",") + "%";

        if (resumoEl) {
          const itens = [
            { key: "NF/Recibo", v: R.pendRecibo || 0, p: R.pctRecibo || 0 },
            { key: "Etiqueta", v: R.pendEtiqueta || 0, p: R.pctEtiqueta || 0 },
            { key: "Descri√ß√£o", v: R.pendDescricao || 0, p: R.pctDescricao || 0 },
            { key: "NF divergente", v: R.pendDivergNF || 0, p: R.pctDivergNF || 0 },
          ];

          const sumTipos = itens.reduce((a, x) => a + (Number(x.v) || 0), 0) || 1;

          function donutSegs() {
            const r = 54;
            const c = 2 * Math.PI * r;
            let acc = 0;

            return itens.map((it, idx) => {
              const frac = (Number(it.v) || 0) / sumTipos;
              const len = c * frac;
              const dash = `${len} ${c - len}`;
              const offset = -acc;
              acc += len;

              const cor = ["#60a5fa", "#34d399", "#fbbf24", "#f87171"][idx] || "#94a3b8";

              return `
                <circle cx="64" cy="64" r="${r}"
                  fill="transparent"
                  stroke="${cor}"
                  stroke-width="14"
                  stroke-linecap="round"
                  stroke-dasharray="${dash}"
                  stroke-dashoffset="${offset}"
                />`;
            }).join("");
          }

          function bars() {
            return itens.map((it, idx) => {
              const cor = ["#60a5fa", "#34d399", "#fbbf24", "#f87171"][idx] || "#94a3b8";
              const w = Math.min(100, Math.max(0, (Number(it.p) || 0) * 100));
              return `
                <div style="margin-top:10px;">
                  <div style="display:flex; justify-content:space-between; gap:12px; font-size:12px; color:rgba(226,232,240,0.88);">
                    <div style="font-weight:900;">${it.key}</div>
                    <div style="font-weight:900;">${it.v} (${pct(it.p)})</div>
                  </div>
                  <div style="margin-top:6px; height:10px; background:rgba(148,163,184,0.14); border-radius:999px; overflow:hidden;">
                    <div style="height:100%; width:${w}%; background:${cor}; border-radius:999px;"></div>
                  </div>
                </div>`;
            }).join("");
          }

          // ‚úÖ adicionamos um container do gr√°fico de linha logo abaixo
          resumoEl.innerHTML = `
            <div style="display:grid; grid-template-columns: 1.1fr 1fr; gap:14px; align-items:stretch;">

              <!-- Coluna esquerda: KPIs -->
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Transa√ß√µes eleg√≠veis (Com pend√™ncias)</div>
                  <div style="color:#fff; font-size:26px; font-weight:1000; margin-top:6px;">${R.totalTransacoes || 0}</div>
                  <div id="envPend_sp_tx" style="margin-top:10px; height:26px;"></div>
                </div>

                <div id="envPend_card_lojas" style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Lojas</div>
                  <div style="color:#fff; font-size:26px; font-weight:1000; margin-top:6px;">${R.totalLojas || 0}</div>
                  <div id="envPend_sp_lojas" style="margin-top:10px; height:26px;"></div>
                </div>

                <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Valor total (Eleg√≠veis)</div>
                  <div style="color:#fff; font-size:20px; font-weight:1000; margin-top:6px;">${money}</div>
                  <div id="envPend_sp_valor" style="margin-top:10px; height:26px;"></div>
                </div>

                <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">J√° enviadas (bloqueadas)</div>
                  <div style="color:#fff; font-size:26px; font-weight:1000; margin-top:6px;">${R.totalJaEnviadas || 0}</div>
                  <div id="envPend_sp_enviadas" style="margin-top:10px; height:26px;"></div>
                </div>
              </div>

              <!-- Coluna direita: donut + barras -->
              <div id="envPend_card_dist"
                title="Passe o mouse para ver distribui√ß√£o por loja"
                style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px; display:flex; gap:14px; align-items:center;">
                <div style="width:160px; min-width:160px; display:flex; align-items:center; justify-content:center;">
                  <svg width="128" height="128" viewBox="0 0 128 128">
                    <circle cx="64" cy="64" r="54" fill="transparent" stroke="rgba(148,163,184,0.12)" stroke-width="14" />
                    ${donutSegs()}
                  </svg>
                </div>
                <div style="flex:1;">
                  <div style="color:#fff; font-weight:1000; margin-bottom:4px;">Distribui√ß√£o de pend√™ncias</div>
                  <div style="color:rgba(226,232,240,0.7); font-size:12px;">Percentuais por tipo (observa√ß√£o: uma transa√ß√£o pode ter m√∫ltiplas pend√™ncias).</div>
                  ${bars()}
                </div>
              </div>

            </div>

            <!-- ‚úÖ Gr√°fico de linha: pend√™ncias por data -->
            <div style="margin-top:14px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
              <div style="color:#fff; font-weight:1000; margin-bottom:4px;">Evolu√ß√£o de pend√™ncias no per√≠odo</div>
              <div style="color:rgba(226,232,240,0.7); font-size:12px; margin-bottom:10px;">
                Quantidade total de transa√ß√µes pendentes por data
              </div>

              <svg id="envPend_svgLine" width="100%" height="220" viewBox="0 0 800 220" preserveAspectRatio="none"></svg>

            </div>
          `;

            // === bind popup do gr√°fico no card "Lojas" ===
            try {
              const cardLojas = document.getElementById("envPend_card_lojas");
              if (cardLojas && !cardLojas.__bindGrafico) {
                cardLojas.__bindGrafico = true;
                cardLojas.style.cursor = "pointer";
                cardLojas.title = "Clique para visualizar detalhamento";

                cardLojas.onclick = function () {
                  window.vektorEnvPendLojasPopupOpen_();
                };

              }
            } catch (e) {
              console.error("Erro bind card lojas:", e);
            }

            // === bind hover no donut "Distribui√ß√£o de pend√™ncias" (abre overlay stacked) ===
              try {
                const dist = document.getElementById("envPend_card_dist");
                const overlay = document.getElementById("envPend_distOverlay");
                const overlayBg = document.getElementById("envPend_distOverlayBg");
                const overlayClose = document.getElementById("envPend_distOverlayClose");

                function pctTxt(x){ return ((Number(x)||0)*100).toFixed(1).replace(".", ",") + "%"; }

                function renderDistOverlay_() {
                  const body = document.getElementById("envPend_distOverlayBody");
                  if (!body) return;

                  const arr = window.__envPend?.resumo?.lojasPendStack;
                  if (!Array.isArray(arr) || !arr.length) {
                    body.innerHTML = `<div style="color:#64748b;font-size:12px;">Sem dados por loja.</div>`;
                    return;
                  }

                  const top = arr.slice(0, 60); // evita overlay infinito (scroll j√° existe)
                  body.innerHTML = top.map(it => {
                    const r = Math.max(0, Math.min(100, (it.pctRecibo||0)*100));
                    const e = Math.max(0, Math.min(100, (it.pctEtiqueta||0)*100));
                    const d = Math.max(0, Math.min(100, (it.pctDescricao||0)*100));
                    const n = Math.max(0, Math.min(100, (it.pctDivergNF||0)*100));

                    return `
                      <div style="padding:10px 10px; border:1px solid rgba(15,23,42,0.08); border-radius:14px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
                          <div style="font-weight:1000; color:#0f172a;">Loja ${it.lojaKey}</div>
                          <div style="font-size:12px; color:#334155;">(base: ${it.totalFlags||0} flags)</div>
                        </div>

                        <div style="margin-top:8px; height:14px; background:#e2e8f0; border-radius:999px; overflow:hidden; display:flex;">
                          <div style="width:${r}%; background:#005E27;"></div>
                          <div style="width:${e}%; background:#0ea5e9;"></div>
                          <div style="width:${d}%; background:#a855f7;"></div>
                          <div style="width:${n}%; background:#f59e0b;"></div>
                        </div>

                        <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#334155;">
                          <div><b>Recibo:</b> ${pctTxt(it.pctRecibo)}</div>
                          <div><b>Etiqueta:</b> ${pctTxt(it.pctEtiqueta)}</div>
                          <div><b>Descri√ß√£o:</b> ${pctTxt(it.pctDescricao)}</div>
                          <div><b>NF div.:</b> ${pctTxt(it.pctDivergNF)}</div>
                        </div>
                      </div>
                    `;
                  }).join("");
                }

                function openDist_() {
                  if (!overlay) return;
                  renderDistOverlay_();
                  overlay.style.display = "block";
                }
                function closeDist_() {
                  if (!overlay) return;
                  overlay.style.display = "none";
                }

                if (overlayBg) overlayBg.onclick = closeDist_;
                if (overlayClose) overlayClose.onclick = closeDist_;

                if (dist && !dist.__bindHoverDist) {
                    dist.__bindHoverDist = true;
                    dist.style.cursor = "help";

                    let t = null;

                    dist.addEventListener("mouseenter", function () {
                      if (t) clearTimeout(t);

                      // s√≥ abre se o mouse ficar parado por 350ms
                      t = setTimeout(function () {
                        // n√£o abre de novo se j√° est√° aberto
                        if (overlay && overlay.style.display === "block") return;
                        openDist_();
                      }, 2200);
                    });

                    dist.addEventListener("mouseleave", function () {
                      if (t) clearTimeout(t);
                      t = null;
                    });
                  }
              } catch (e) {
                console.error("Erro bind dist donut:", e);
              }

          // ===== mini-sparklines (cards KPI) =====
            (function renderKpiSparklines() {
              const rows = Array.isArray(window.__envPend.rows) ? window.__envPend.rows : [];
              const serie = Array.isArray(res.seriePorData) ? res.seriePorData : [];

              // Se n√£o tiver s√©rie por data, n√£o renderiza
              if (!serie.length) return;

              // lista de datas (dd/MM/yyyy) na ordem do gr√°fico
              const dates = serie.map(p => String(p.data || "").trim()).filter(Boolean);

              // helpers de valor
              const toNum = (v) => {
                const s = String(v || "")
                  .replace(/[R$\s]/g, "")
                  .replace(/\./g, "")
                  .replace(",", ".");
                const n = Number(s);
                return isNaN(n) ? 0 : n;
              };

              // agrega√ß√µes por data
              const mapTx = {};        // data -> total tx (usa seriePorData, mas mantemos por simetria)
              const mapValor = {};     // data -> soma valor
              const mapEnviadas = {};  // data -> count jaEnviado
              const setLojas = {};     // data -> {lojaKey:true}

              dates.forEach(d => {
                mapTx[d] = 0;
                mapValor[d] = 0;
                mapEnviadas[d] = 0;
                setLojas[d] = {};
              });

              // preenche tx a partir da pr√≥pria seriePorData
              serie.forEach(p => {
                const d = String(p.data || "").trim();
                if (!d) return;
                mapTx[d] = Number(p.total) || 0;
              });

              // preenche lojas/valor/enviadas a partir das rows
              rows.forEach(r => {
                const d = String(r.dataTransBR || r.data || "").trim(); // preferencialmente dataTransBR
                if (!d || !(d in setLojas)) return;

                const loja = String(r.lojaKey || "").trim();
                if (loja) setLojas[d][loja] = true;

                mapValor[d] += toNum(r.valorOriginal || r.valorOriginalTxt || 0);

                if (r.jaEnviado) mapEnviadas[d] += 1;
              });

              const seriesTx = dates.map(d => mapTx[d] || 0);
              const seriesLojas = dates.map(d => Object.keys(setLojas[d] || {}).length);
              const seriesValor = dates.map(d => mapValor[d] || 0);
              const seriesEnviadas = dates.map(d => mapEnviadas[d] || 0);

              // render SVG sparkline
              function renderSpark(targetId, values) {
                const box = document.getElementById(targetId);
                if (!box) return;

                const W = 160, H = 26;
                const PAD = 3;

                const maxV = Math.max.apply(null, values.concat([1]));
                const minV = Math.min.apply(null, values.concat([0]));
                const span = Math.max(1e-9, (maxV - minV));

                const xOf = (i) => {
                  if (values.length <= 1) return PAD;
                  return PAD + (i * (W - PAD * 2)) / (values.length - 1);
                };
                const yOf = (v) => {
                  const t = (v - minV) / span;     // 0..1
                  return (H - PAD) - t * (H - PAD * 2);
                };

                let d = "";
                values.forEach((v, i) => {
                  const x = xOf(i);
                  const y = yOf(Number(v) || 0);
                  d += (i === 0 ? "M" : " L") + x + " " + y;
                });

                // marcador no √∫ltimo ponto
                const lastX = xOf(values.length - 1);
                const lastY = yOf(values[values.length - 1] || 0);

                box.innerHTML = `
                <svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
                  <!-- linha base (fundo) -->
                  <path d="${d}" fill="none" stroke="rgba(181,255,32,0.25)" stroke-width="1.8" stroke-linecap="round" />

                  <!-- linha tracejada ‚Äúviva‚Äù (anima dashoffset) -->
                  <path d="${d}" fill="none" stroke="#B5FF20" stroke-width="1.2" stroke-dasharray="4 6" stroke-linecap="round">
                    <animate attributeName="stroke-dashoffset"
                            from="0"
                            to="-20"
                            dur="1.8s"
                            repeatCount="indefinite" />
                  </path>

                  <!-- √∫ltimo ponto com pulso leve -->
                  <circle cx="${lastX}" cy="${lastY}" r="2.8" fill="#B5FF20">
                    <animate attributeName="r"
                            values="2.6;3.2;2.6"
                            dur="1.6s"
                            repeatCount="indefinite" />
                    <animate attributeName="opacity"
                            values="0.85;1;0.85"
                            dur="1.6s"
                            repeatCount="indefinite" />
                  </circle>
                </svg>
              `;
              }

              renderSpark("envPend_sp_tx", seriesTx);
              renderSpark("envPend_sp_lojas", seriesLojas);
              renderSpark("envPend_sp_valor", seriesValor);
              renderSpark("envPend_sp_enviadas", seriesEnviadas);
            })();

          // ===== desenha o gr√°fico de linha (SVG) =====
          (function renderLineChart() {
            const svg = document.getElementById("envPend_svgLine");
            const serie = Array.isArray(res.seriePorData) ? res.seriePorData : [];
            if (!svg || !serie.length) {
              if (svg) svg.innerHTML = `<text x="10" y="20" fill="rgba(226,232,240,0.75)" font-size="12">Sem dados no per√≠odo.</text>`;
              return;
            }

            const W = 800, H = 220;
            const PAD_X = 56, PAD_Y = 26; // PAD_X maior para caber labels do eixo Y

            const maxY = Math.max(...serie.map(p => Number(p.total) || 0), 1);
            const stepX = (W - PAD_X * 2) / Math.max(1, serie.length - 1);

            const yOf = (v) => H - PAD_Y - (v / maxY) * (H - PAD_Y * 2);

            // path da linha
            let dPath = "";
            serie.forEach((p, i) => {
              const x = PAD_X + i * stepX;
              const y = yOf(Number(p.total) || 0);
              dPath += (i === 0 ? "M" : " L") + x + " " + y;
            });

            // ‚úÖ NOVO: √°rea preenchida sob a linha (fecha at√© a base do gr√°fico)
            const baseY = H - PAD_Y; // linha do "ch√£o" do gr√°fico
            const lastX = PAD_X + (serie.length - 1) * stepX;
            const firstX = PAD_X;

            const dArea = dPath + " L " + lastX + " " + baseY + " L " + firstX + " " + baseY + " Z";

            // grid + eixo Y labels
            const ticks = 4;
            const grid = [];
            for (let t = 0; t <= ticks; t++) {
              const frac = t / ticks;
              const y = PAD_Y + frac * (H - PAD_Y * 2);
              const val = Math.round(maxY * (1 - frac));

              grid.push(`<line x1="${PAD_X}" y1="${y}" x2="${W - PAD_X}" y2="${y}" stroke="rgba(148,163,184,0.12)" stroke-width="1" />`);
              grid.push(`
                <text x="${PAD_X - 10}" y="${y}"
                      text-anchor="end"
                      dominant-baseline="middle"
                      font-size="11"
                      fill="rgba(226,232,240,0.55)">${val}</text>
              `);
            }

            svg.innerHTML = `
              ${grid.join("")}

              <!-- ‚úÖ NOVO: √°rea (vermelho claro) sob a linha -->
              <path id="envPend_areaFill"
              d="${dArea}"
              fill="rgba(248,113,113,0.18)"
              stroke="none" />

              <!-- linha base (vai ser animada via getTotalLength) -->
              <path id="envPend_lineBase"
                    d="${dPath}"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="2.0"
                    stroke-linecap="round"
                    stroke-linejoin="round" />

              <!-- highlight ‚Äúvivo‚Äù (anima√ß√£o infinita) -->
              <path id="envPend_lineHighlight"
                    d="${dPath}"
                    fill="none"
                    stroke="rgba(255,255,255,0.45)"
                    stroke-width="3.0"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-dasharray="10 18" />

              ${serie.map((p, i) => {
                const x = PAD_X + i * stepX;
                const y = yOf(Number(p.total) || 0);
                const val = Number(p.total) || 0;
                const labelY = Math.max(PAD_Y + 10, y - 16); // sobe mais pra n√£o encostar no marcador

                // ‚úÖ ordem: C√çRCULO primeiro, TEXTO depois (texto n√£o fica coberto)
                return `
                  <circle cx="${x}" cy="${y}" r="4.2" fill="#ffffff" opacity="0.95" />
                  <text x="${x}" y="${labelY}"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="10"
                        font-weight="800"
                        style="paint-order:stroke; stroke:#0b1220; stroke-width:2px;"
                        fill="#ffffff">${val}</text>

                  <text x="${x}" y="${H - 6}"
                        text-anchor="middle"
                        font-size="10"
                        fill="rgba(226,232,240,0.65)">${p.data}</text>
                `;
              }).join("")}
            `;

            // ‚úÖ anima√ß√µes com velocidade ajust√°vel
            try {
              const base = svg.querySelector("#envPend_lineBase");
              const hi = svg.querySelector("#envPend_lineHighlight");
              if (base && base.getTotalLength) {
                const len = base.getTotalLength();

                // --- velocidade (ajuste aqui) ---
                const DUR_DRAW = "2.2s";     // desenhar linha
                const DUR_RUN  = "3.5s";     // highlight correndo (mais lento = mais premium)

                base.style.strokeDasharray = String(len);
                base.style.strokeDashoffset = String(len);

                base.innerHTML = `
                  <animate attributeName="stroke-dashoffset"
                          from="${len}"
                          to="0"
                          dur="${DUR_DRAW}"
                          fill="freeze" />`;

                if (hi) {
                  hi.style.opacity = "0";
                  hi.innerHTML = `
                    <animate attributeName="opacity" from="0" to="1" dur="0.35s" begin="${DUR_DRAW}" fill="freeze" />
                    <animate attributeName="stroke-dashoffset"
                            from="0" to="-220"
                            dur="${DUR_RUN}"
                            begin="${DUR_DRAW}"
                            repeatCount="indefinite" />
                  `;
                }
              }
            } catch (e) {
              // fallback: sem getTotalLength, ainda renderiza est√°tico
            }
})();
        }

        // ‚úÖ NOVO: cards de status mix do per√≠odo
            (function renderStatusCards() {
              const box = document.getElementById("envPend_statusCards");
              const M = (res && res.statusMix) ? res.statusMix : (res && res.resumo ? res.resumo.statusMix : null);
              if (!box) return;

              if (!M || !M.total) {
                box.innerHTML = "";
                return;
              }

              const pct = (x) => ((x || 0) * 100).toFixed(1).replace(".", ",") + "%";

              box.innerHTML = `
                <div style="min-width:160px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:10px 12px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Aprovadas</div>
                  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
                    <div style="color:#fff; font-size:22px; font-weight:1000;">${M.aprovada}</div>
                    <div style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:900;">${pct(M.pctAprovada)}</div>
                  </div>
                </div>

                <div style="min-width:160px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:10px 12px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Recusadas</div>
                  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
                    <div style="color:#fff; font-size:22px; font-weight:1000;">${M.recusada}</div>
                    <div style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:900;">${pct(M.pctRecusada)}</div>
                  </div>
                </div>

                <div style="min-width:190px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:10px 12px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Necessita aprova√ß√£o</div>
                  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
                    <div style="color:#fff; font-size:22px; font-weight:1000;">${M.necessita}</div>
                    <div style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:900;">${pct(M.pctNecessita)}</div>
                  </div>
                </div>
              `;
              })();

          // ‚úÖ NOVO: overlay de sucesso no centro + fecha automaticamente
            const linhasOk = (window.__envPend.rows || []).length;

            window.vektorEnvPendOverlayShow_(
              `Pr√©via pronta: ${linhasOk} linha(s).`,
              "Voc√™ j√° pode revisar as linhas e enviar."
            );

            setTimeout(function () {
              window.vektorEnvPendOverlayHide_();
            }, 1200);

        window.__renderEnvPendTbody();
        if (st) st.textContent = `Pr√©via pronta: ${window.__envPend.rows.length} linha(s).`;

        if ((window.__envPend.rows || []).length > 0) {
          window.vektorEnvioPendenciasAbrirModal();
        }
      })
      .withFailureHandler(function (err) {
        window.vektorEnvPendOverlayHide_();
        if (st) st.textContent = "Erro ao gerar pr√©via.";
        if (resumoEl) resumoEl.textContent = (err && err.message) ? err.message : String(err || "Erro");
      })
      .previewEnvioPendenciasClaraRecusadasDetalhado(iniIso, fimIso);

  } catch (e) {
    try { window.vektorEnvPendOverlayHide_(); } catch (_) {}
    const st = document.getElementById("envPend_statusText");
    if (st) st.textContent = "Erro inesperado na pr√©via.";
  }
};

window.vektorEnvioPendenciasEnviarSelecionadas = function () {
  const falhasEl = document.getElementById("envPend_falhas");
  const st = document.getElementById("envPend_statusText");
  if (falhasEl) falhasEl.innerHTML = "";

  // ‚úÖ anti-duplo-clique (front)
  if (window.__envPendSendInFlight) return;
  window.__envPendSendInFlight = true;

  // ‚úÖ desabilita bot√£o
  var btn = document.getElementById("envPend_btnEnviarSelecionadas");
  if (btn) {
    btn.disabled = true;
    btn.style.opacity = "0.6";
    btn.style.pointerEvents = "none";
  }

  function releaseUi_() {
    window.__envPendSendInFlight = false;
    if (btn) {
      btn.disabled = false;
      btn.style.opacity = "";
      btn.style.pointerEvents = "";
    }
  }

  try {
    const iniIso = window.__envPend && window.__envPend.periodo ? (window.__envPend.periodo.iniIso || "") : "";
    const fimIso = window.__envPend && window.__envPend.periodo ? (window.__envPend.periodo.fimIso || "") : "";

    if (!iniIso || !fimIso) {
      if (st) st.textContent = "Rode a pr√©via antes de enviar.";
      releaseUi_();
      return;
    }

    const selected = (window.__envPend && window.__envPend.selected) ? window.__envPend.selected : {};
    const keys = Object.keys(selected).filter(k => selected[k]);

    if (!keys.length) {
      if (st) st.textContent = "Nenhuma linha selecionada para enviar.";
      releaseUi_();
      return;
    }

    if (st) st.textContent = "Enviando e-mails‚Ä¶";

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          if (!res || !res.ok) {
            if (st) st.textContent = "Falha no envio.";
            if (falhasEl) falhasEl.innerHTML =
              `<div style="color:rgba(248,113,113,0.95); font-weight:900;">${res && res.error ? res.error : "Erro desconhecido"}</div>`;
            return;
          }

          if (st) st.textContent = `Envio conclu√≠do: e-mails=${res.emailsEnviados || 0}, transa√ß√µes registradas=${res.txRegistradas || 0}.`;

          const falhas = Array.isArray(res.falhasPorLoja) ? res.falhasPorLoja : [];
          const sucessos = Array.isArray(res.sucessoPorLoja) ? res.sucessoPorLoja : [];

          let html = "";
          if (sucessos.length) {
            html += `<div style="margin-top:8px; color:rgba(34,197,94,0.95); font-weight:900;">Enviados (${sucessos.length} loja(s))</div>`;
            html += "<ul style='margin-left:18px; color:rgba(226,232,240,0.85); font-size:12px;'>";
            sucessos.slice(0, 12).forEach(s => {
              html += `<li>${s.lojaKey}: ${s.qtdTx} transa√ß√£o(√µes)</li>`;
            });
            html += "</ul>";
          }

          if (falhas.length) {
            html += `<div style="margin-top:12px; color:rgba(248,113,113,0.95); font-weight:900;">N√£o enviados (${falhas.length} loja(s))</div>`;
            html += "<ul style='margin-left:18px; color:rgba(226,232,240,0.85); font-size:12px;'>";
            falhas.slice(0, 12).forEach(f => {
              html += `<li>${f.lojaKey}: ${f.error}</li>`;
            });
            html += "</ul>";
          }

          if (falhasEl) falhasEl.innerHTML = html;

          // Atualiza pr√©via para refletir envios
          window.vektorEnvioPendenciasFecharModal();
          window.vektorEnvioPendenciasPreview();

        } finally {
          releaseUi_();
        }
      })
      .withFailureHandler(function (err) {
        try {
          if (st) st.textContent = "Erro no envio.";
          if (falhasEl) falhasEl.innerHTML =
            `<div style="color:rgba(248,113,113,0.95); font-weight:900;">${(err && err.message) ? err.message : String(err || "Erro")}</div>`;
        } finally {
          releaseUi_();
        }
      })
      .dispararEnvioPendenciasClaraRecusadasSelecionadas(iniIso, fimIso, keys);

  } catch (e) {
    // erro s√≠ncrono do JS (antes do google.script.run)
    if (st) st.textContent = "Erro inesperado no envio.";
    if (falhasEl) falhasEl.innerHTML =
      `<div style="color:rgba(248,113,113,0.95); font-weight:900;">${(e && e.message) ? e.message : String(e || "Erro")}</div>`;
    releaseUi_();
  }
};

window.vektorOpenFluxograma = function () {
  vektorShowFluxogramaView_();

  // desenha ap√≥s layout estabilizar
  setTimeout(vektorDrawFluxogramaConnectors_, 50);
  setTimeout(vektorDrawFluxogramaConnectors_, 220);
};

window.addEventListener("resize", function () {
  // s√≥ tenta redesenhar se a view estiver aberta
  const v = document.getElementById("fluxogramaView");
  if (v && !v.classList.contains("hidden")) {
    vektorDrawFluxogramaConnectors_();
  }
});

function vektorDrawFluxogramaConnectors_() {
  try {
    const flow = document.querySelector("#fluxogramaView .flow-container") || null;
    const svg = document.getElementById("fluxoConnectorsSvg");
    if (!svg) return;

    const s1 = document.getElementById("fgStep1");
    const s2 = document.getElementById("fgStep2");
    const s3 = document.getElementById("fgStep3");
    const s4 = document.getElementById("fgStep4");
    const s5 = document.getElementById("fgStep5");
    if (!s1 || !s2 || !s3 || !s4 || !s5) return;

    // o SVG est√° dentro do flow container (position:relative). Precisamos de coordenadas relativas a ele
    const svgRect = svg.getBoundingClientRect();

    const rect = (el) => el.getBoundingClientRect();

    function midY(r) { return r.top + r.height / 2; }

    // ponto de sa√≠da = centro vertical na borda "externa" da caixa
      function outPoint(fromRect, side) {
        const GAP = 8; // << controla o quanto o tra√ßo fica FORA da caixa
        const x = (side === "right") ? (fromRect.right + GAP) : (fromRect.left - GAP);
        const y = midY(fromRect);
        return { x: x - svgRect.left, y: y - svgRect.top };
      }

      // ponto de entrada = centro vertical na borda "interna" da caixa
      function inPoint(toRect, side) {
        const GAP = 8; // mesmo GAP, para n√£o ‚Äúentrar‚Äù na borda
        const x = (side === "left") ? (toRect.left - GAP) : (toRect.right + GAP);
        const y = midY(toRect);
        return { x: x - svgRect.left, y: y - svgRect.top };
      }


    function elbowPath(p1, p2, bendX) {
      // horizontal ‚Üí vertical ‚Üí horizontal
      // p1 -> (bendX, p1.y) -> (bendX, p2.y) -> p2
      return `M ${p1.x} ${p1.y} L ${bendX} ${p1.y} L ${bendX} ${p2.y} L ${p2.x} ${p2.y}`;
    }

    function drawOne(fromEl, toEl, dir, stroke, markerId) {
      const r1 = rect(fromEl);
      const r2 = rect(toEl);

      // dir = "L2R" (step esquerdo para step direito) ou "R2L"
      const p1 = outPoint(r1, dir === "L2R" ? "right" : "left");
      const p2 = inPoint(r2, dir === "L2R" ? "left" : "right");

      // define um bendX mais ou menos no meio, mas preservando ‚Äúreto saindo e entrando‚Äù
      const bendX = (dir === "L2R")
        ? Math.min(p1.x + 180, (p1.x + p2.x) / 2)
        : Math.max(p1.x - 180, (p1.x + p2.x) / 2);

      const d = elbowPath(p1, p2, bendX);

      return `<path d="${d}"
        fill="none"
        stroke="${stroke}"
        stroke-opacity="1"
        stroke-width="2"
        stroke-linecap="square"
        stroke-linejoin="miter"
        marker-end="url(#${markerId})"
        shape-rendering="crispEdges"
      ></path>`;

    }

    // limpa e redesenha
    const paths = [];
    paths.push(drawOne(s1, s2, "L2R", "rgb(181,255,32)", "arrowHeadGreen"));
    paths.push(drawOne(s2, s3, "R2L", "rgb(34,197,94)", "arrowHeadDarkGreen"));
    paths.push(drawOne(s3, s4, "L2R", "rgb(181,255,32)", "arrowHeadGreen"));
    paths.push(drawOne(s4, s5, "R2L", "rgb(34,197,94)", "arrowHeadDarkGreen"));

    // mant√©m defs e injeta paths
    const defs = svg.querySelector("defs")?.outerHTML || "";
    svg.innerHTML = defs + paths.join("");

    // ajusta viewBox para o tamanho atual do SVG
    svg.setAttribute("viewBox", `0 0 ${svgRect.width} ${svgRect.height}`);
  } catch (e) {
    // silencioso
  }
}

// FEEDBACK (tela cheia)
window.vektorOpenFeedback = function () {
  vektorShowFeedbackView_();

  // (opcional) for√ßa recarregar o iframe sempre que abrir
  const fr = document.getElementById("feedbackFrame");
  if (fr && fr.src) {
    fr.src = fr.src; // recarrega mantendo mesma URL
  }
};

// ===============================
// RADAR (tela cheia)
// ===============================
window.vektorOpenRadar = function (modo) {
  // abre Radar e fecha outras views (base)
  vektorShowRadarView_();

  // ‚úÖ garante que Alertas Programados n√£o fique por cima
  const myAlertsView = document.getElementById("myAlertsView");
  if (myAlertsView) myAlertsView.classList.add("hidden");

  const radarView = document.getElementById("radarView");
  if (radarView) radarView.classList.add("is-open");

  setRadarActiveBtn_(modo);

  // ‚úÖ garante que ao abrir o Radar, volta para a vis√£o tradicional
    window.vektorSetRadarViewMode_("RADAR");

  const loading = document.getElementById("radarLoading");
  const heat = document.getElementById("radarHeatmap");
  const rank = document.getElementById("radarRanking");

  if (loading) loading.style.display = "block";
  if (heat) heat.innerHTML = "";
  if (rank) rank.innerHTML = "";

  google.script.run
    .withSuccessHandler(function (res) {
      if (loading) loading.style.display = "none";

      if (!res || !res.ok) {
        const msg = (res && res.restrito)
          ? "Acesso restrito: apenas Administrador."
          : "Falha ao carregar dados do Radar.";
        if (heat) {
          heat.innerHTML = `<div style="color:rgba(226,232,240,0.85); font-weight:700; font-size:13px;">${msg}</div>`;
        }
        return;
      }

      const lojas = Array.isArray(res.lojas) ? res.lojas : [];
      if (!lojas.length) {
        if (heat) {
          heat.innerHTML = `<div style="color:rgba(226,232,240,0.85); font-weight:700; font-size:13px;">Sem dados suficientes no per√≠odo.</div>`;
        }
        return;
      }

      renderRadarHeatmap_(lojas);
      renderRadarRanking_(lojas, res.detalhesPorLoja || {});
      renderRadarInsights_(lojas);

    })
    .withFailureHandler(function (err) {
      if (loading) loading.style.display = "none";
      const msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
      if (heat) {
        heat.innerHTML = `<div style="color:rgba(248,113,113,0.95); font-weight:800; font-size:13px;">Falha: ${msg}</div>`;
      }
    })
    .getRadarIrregularidadeParaChat(modo);
};

// ===============================
// RADAR - ITENS IRREGULARES (view mode)
// ===============================
window.__radarViewMode = "RADAR"; // "RADAR" | "ITENS"

window.vektorSetRadarViewMode_ = function(mode) {
  const m = String(mode || "RADAR").toUpperCase();
  window.__radarViewMode = (m === "ITENS") ? "ITENS" : "RADAR";

  const radarContent = document.getElementById("radarContent");
  const itensView = document.getElementById("radarItensView");
  const btnItens = document.getElementById("radarBtnItens");

    // ‚úÖ bot√µes que s√≥ fazem sentido no RADAR (devem sumir no modo ITENS)
  const btn7d = document.getElementById("radarBtn7d");
  const btnCiclo = document.getElementById("radarBtnCiclo");
  const btnFull = document.getElementById("radarBtnFull");
  const btnComo = document.getElementById("radarBtnComoAnalise");

  const showRadarButtons = (window.__radarViewMode === "RADAR");
  [btn7d, btnCiclo, btnFull, btnComo].forEach(function(b){
    if (!b) return;
    b.style.display = showRadarButtons ? "inline-flex" : "none";
  });

  if (radarContent) radarContent.style.display = (window.__radarViewMode === "RADAR") ? "grid" : "none";
  if (itensView) itensView.style.display = (window.__radarViewMode === "ITENS") ? "block" : "none";

  if (btnItens) {
    btnItens.textContent = (window.__radarViewMode === "ITENS") ? "Radar" : "Itens Irregulares";
    btnItens.style.background = (window.__radarViewMode === "ITENS") ? "rgba(226,232,240,0.90)" : "#fde68a"; // cinza claro
    btnItens.style.color = (window.__radarViewMode === "ITENS") ? "#111827" : "#111827"; // texto preto
    btnItens.style.borderColor = (window.__radarViewMode === "ITENS") ? "rgba(15,23,42,0.25)" : "rgba(0,0,0,0.25)";
    btnItens.style.fontWeight = (window.__radarViewMode === "ITENS") ? "1000" : "1000";
  }
};

window.vektorToggleRadarItensIrregulares = function() {
  const irParaItens = (window.__radarViewMode !== "ITENS");
  window.vektorSetRadarViewMode_(irParaItens ? "ITENS" : "RADAR");

    // ‚úÖ ajusta subt√≠tulo do header conforme a vis√£o
  const sub = document.getElementById("radarSubTitle");
  if (sub) {
    sub.textContent = irParaItens
      ? "Itens irregulares ‚Äî revis√£o de poss√≠veis diverg√™ncias por per√≠odo (selecione um per√≠odo e clique em ‚ÄúAtualizar‚Äù)."
      : "Correla√ß√£o entre m√©tricas + ranking de proximidade por loja";
  }

  // ‚úÖ ao entrar em ITENS: apenas prepara defaults e zera a tela.
// ‚ùå N√ÉO carregar automaticamente.
if (irParaItens) {
  window.vektorInitRadarItensIrregularesDefaults_();

  // limpa KPIs/visuais at√© clicar em "Atualizar"
  const k1 = document.getElementById("itensIrregKpiTotal");
  const k2 = document.getElementById("itensIrregKpiValor");
  const k3 = document.getElementById("itensIrregKpiAlertas");
  const k4 = document.getElementById("itensIrregKpiPctAlertas");
  if (k1) k1.textContent = "‚Äî";
  if (k2) k2.textContent = "‚Äî";
  if (k3) k3.textContent = "‚Äî";
  if (k4) k4.textContent = "‚Äî";

  const a1 = document.getElementById("itensIrregAggLoja");
  const a2 = document.getElementById("itensIrregAggTime");
  const ch = document.getElementById("itensIrregChart");
  if (a1) a1.innerHTML = "";
  if (a2) a2.innerHTML = "";
  if (ch) ch.innerHTML = "";

  window.__itensIrregLastRows = [];
  window.__itensIrregLastRes = null;

  const msg = document.getElementById("itensIrregMsg");
  if (msg) msg.innerHTML = `<div style="color:rgba(226,232,240,0.75); font-weight:900; font-size:12px;">Selecione um per√≠odo e clique em ‚ÄúAtualizar‚Äù.</div>`;
}
};

window.vektorInitRadarItensIrregularesDefaults_ = function() {
  const iniEl = document.getElementById("itensIrregDtIni");
  const fimEl = document.getElementById("itensIrregDtFim");
  if (!iniEl || !fimEl) return;

  // default: √∫ltimos 7 dias
  const hoje = new Date();
  const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  const ini = new Date(fim);
  ini.setDate(fim.getDate() - 6);

  const toISO = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  };

  if (!fimEl.value) fimEl.value = toISO(fim);
  if (!iniEl.value) iniEl.value = toISO(ini);
};

window.vektorLoadRadarItensIrregulares = function() {
  const tbody = document.getElementById("itensIrregTbody");
  const kpiTotal = document.getElementById("itensIrregKpiTotal");
  const kpiValor = document.getElementById("itensIrregKpiValor");
  const kpiAlertas = document.getElementById("itensIrregKpiAlertas");
  const kpiPctAlertas = document.getElementById("itensIrregKpiPctAlertas");

  const aggLoja = document.getElementById("itensIrregAggLoja");
  const aggTime = document.getElementById("itensIrregAggTime");
  const chart = document.getElementById("itensIrregChart");
  const chartLabel = document.getElementById("itensIrregChartLabel");

  const ini = (document.getElementById("itensIrregDtIni") || {}).value || "";
  const fim = (document.getElementById("itensIrregDtFim") || {}).value || "";
  const itemQ = (document.getElementById("itensIrregItemQ") || {}).value || "";
  const conf = (document.getElementById("itensIrregConf") || {}).value || "";
  const groupBy = (document.getElementById("itensIrregGroupBy") || {}).value || "loja";

  if (chartLabel) chartLabel.textContent = (groupBy === "time") ? "Time" : "Loja";

  const fmtBRL = (v) => {
    const n = Number(v || 0);
    return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  };

  const badge = (c) => {
    const x = String(c || "").toUpperCase();
    let bg = "rgba(255,255,255,0.06)", bd = "rgba(148,163,184,0.25)", tx = "rgba(226,232,240,0.95)";
    if (x === "OK") { bg = "rgba(34,197,94,0.18)"; bd = "rgba(34,197,94,0.35)"; tx = "#bbf7d0"; }
    if (x === "REVISAR") { bg = "rgba(245,158,11,0.18)"; bd = "rgba(245,158,11,0.35)"; tx = "#fde68a"; }
    if (x === "ALERTA") { bg = "rgba(248,113,113,0.18)"; bd = "rgba(248,113,113,0.35)"; tx = "#fecaca"; }
    return `<span style="display:inline-flex; align-items:center; height:22px; padding:0 10px; border-radius:999px;
      border:1px solid ${bd}; background:${bg}; color:${tx}; font-weight:1000; font-size:11px;">${x || "‚Äî"}</span>`;
  };

  if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(226,232,240,0.75); font-weight:900; font-size:12px;">Carregando‚Ä¶</td></tr>`;
  if (aggLoja) aggLoja.innerHTML = "";
  if (aggTime) aggTime.innerHTML = "";
  if (chart) chart.innerHTML = "";

  if (kpiTotal) kpiTotal.textContent = "‚Äî";
  if (kpiValor) kpiValor.textContent = "‚Äî";
  if (kpiAlertas) kpiAlertas.textContent = "‚Äî";
  if (kpiPctAlertas) kpiPctAlertas.textContent = "‚Äî";

  google.script.run
    .withSuccessHandler(function(res) {
      window.vektorGlobalLoadingHide_();
      if (!res || !res.ok) {
        const msg = (res && res.error) ? res.error : "Falha ao carregar itens irregulares.";
        if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(248,113,113,0.95); font-weight:1000; font-size:12px;">${msg}</td></tr>`;
        return;
      }

      // KPIs
      if (kpiTotal) kpiTotal.textContent = String(res.kpis && res.kpis.totalItens != null ? res.kpis.totalItens : "0");
      if (kpiValor) kpiValor.textContent = fmtBRL(res.kpis ? res.kpis.totalValor : 0);
      if (kpiAlertas) kpiAlertas.textContent = String(res.kpis && res.kpis.alertaQtd != null ? res.kpis.alertaQtd : "0");
      if (kpiPctAlertas) kpiPctAlertas.textContent = (res.kpis && res.kpis.alertaPctValorTxt) ? res.kpis.alertaPctValorTxt : "‚Äî";

      // Aggs
      const renderAgg = (el, arr) => {
        if (!el) return;
        if (!Array.isArray(arr) || !arr.length) {
          el.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;
          return;
        }
        let h = `<div style="display:flex; flex-direction:column; gap:8px;">`;
        arr.slice(0, 12).forEach(x => {
          const nome = x.key || "‚Äî";
          const v = fmtBRL(x.valor || 0);
          const pct = x.pctTxt || "‚Äî";
          h += `
            <div style="display:flex; justify-content:space-between; gap:10px; padding:10px; border-radius:12px;
            border:1px solid rgba(181,255,32,0.28);
            background:rgba(181,255,32,0.06);
            box-shadow:0 8px 18px rgba(0,0,0,0.22);">
              <div style="color:#fff; font-weight:1000; font-size:12px;">${nome}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <div style="color:rgba(226,232,240,0.8); font-weight:900; font-size:12px;">${pct}</div>
                <div style="color:#fff; font-weight:1000; font-size:12px;">${v}</div>
              </div>
            </div>`;
        });
        h += `</div>`;
        el.innerHTML = h;
      };

      renderAgg(aggLoja, res.aggLoja);
      renderAgg(aggTime, res.aggTime);

      // Gr√°fico ALERTA (din√¢mico por Loja/Time)
        const serie = (groupBy === "time") ? (res.alertaByTime || []) : (res.alertaByLoja || []);
        if (chart) {
          if (!Array.isArray(serie) || !serie.length) {
            chart.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem ALERTA no per√≠odo.</div>`;
          } else {
            const top = serie.slice(0, 12);
            const max = Math.max.apply(null, top.map(x => Number(x.qtd || 0)));
            let h = `<div style="display:flex; flex-direction:column; gap:8px;">`;
            top.forEach(x => {
              const nome = x.key || "‚Äî";
              const qtd = Number(x.qtd || 0);
              const w = (max > 0 ? Math.round((qtd / max) * 100) : 0);
              h += `
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="width:140px; color:#fff; font-weight:1000; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${nome}</div>
                  <div style="flex:1; height:10px; border-radius:999px; background:rgba(148,163,184,0.16); overflow:hidden;">
                    <div style="height:10px; width:${w}%; background:#B5FF20;"></div>
                  </div>
                  <div style="width:32px; text-align:right; color:rgba(226,232,240,0.92); font-weight:1000; font-size:12px;">${qtd}</div>
                </div>`;
            });
            h += `</div>`;
            chart.innerHTML = h;
          }
        }

      // Table
      const rows = Array.isArray(res.rows) ? res.rows : [];

       // ‚úÖ EMPTY STATE: evita "tela em branco" quando n√£o h√° linhas + mostra debug do backend
        if (!rows.length) {
          const dbg = res && res.debug ? res.debug : null;

          const dbgTxt = dbg ? `
            <div style="margin-top:8px; padding:10px; border-radius:10px; background:rgba(15,23,42,0.55);
                        border:1px solid rgba(148,163,184,0.18); color:rgba(226,232,240,0.92); font-size:12px;">
              <div style="font-weight:1000; margin-bottom:6px;">Debug (backend)</div>
              <div><b>dtIniRaw:</b> ${dbg.dtIniRaw || "‚Äî"}</div>
              <div><b>dtFimRaw:</b> ${dbg.dtFimRaw || "‚Äî"}</div>
              <div><b>dtIniParsed:</b> ${dbg.dtIniParsed || "‚Äî"}</div>
              <div><b>dtFimParsed:</b> ${dbg.dtFimParsed || "‚Äî"}</div>
              <div><b>totalMotor (antes de filtros):</b> ${Number(dbg.totalMotor || 0)}</div>
              <div><b>totalAposFiltros:</b> ${Number(dbg.totalAposFiltros || 0)}</div>
            </div>
          ` : "";

          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="padding:12px; color:rgba(226,232,240,0.85); font-weight:900; font-size:12px;">
                  Sem itens no per√≠odo/filtros selecionados.
                  ${dbgTxt}
                </td>
              </tr>`;
          }

          window.__itensIrregLastRows = [];

          if (aggLoja) aggLoja.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;
          if (aggTime) aggTime.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;
          if (chart) chart.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;

          return;
        }

            if (!rows.length) {
        const dbg = (res && res.debug) ? res.debug : null;
        const dbgTxt = dbg ? `
          <div style="margin-top:10px; padding:10px; border:1px dashed rgba(148,163,184,0.35); border-radius:10px; background:rgba(2,6,23,0.35);">
            <div style="font-weight:1000; font-size:12px; color:rgba(226,232,240,0.92);">Diagn√≥stico (debug)</div>
            <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.78); line-height:1.35;">
              dtIniIso: <b>${String(dbg.dtIniIsoRecebido || "")}</b><br/>
              dtFimIso: <b>${String(dbg.dtFimIsoRecebido || "")}</b><br/>
              janela: <b>${String(dbg.dIniBR || "")}</b> ‚Üí <b>${String(dbg.dFimBR || "")}</b><br/>
              totalMotor: <b>${Number(dbg.totalMotor || 0)}</b><br/>
              resumoMotor: <b>${dbg.resumoMotor ? JSON.stringify(dbg.resumoMotor) : "‚Äî"}</b>
            </div>
          </div>
        ` : "";

        if (tbody) {
          tbody.innerHTML =
            `<tr><td colspan="7" style="padding:12px; color:rgba(226,232,240,0.78); font-weight:900; font-size:12px;">
              Sem registros no per√≠odo.
              ${dbgTxt}
            </td></tr>`;
        }
        window.__itensIrregLastRows = [];
        return;
      }

      // cache para export CSV
      window.__itensIrregLastRows = rows;

      // se modal estiver aberto, atualiza o tbody na hora
      const modal = document.getElementById("itensIrregDetalhamentoModal");
      if (modal && modal.style.display === "block") {
        window.vektorRenderItensIrregDetalhamentoFromCache_();
      }

    })
    .withFailureHandler(function(err) {
      window.vektorGlobalLoadingHide_();
      const msg = (err && err.message) ? err.message : String(err || "Erro");
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(248,113,113,0.95); font-weight:1000; font-size:12px;">Falha: ${msg}</td></tr>`;
    })
    .getItensIrregularesRadarVisao({
        dtIniIso: ini,
        dtFimIso: fim,
        itemContains: itemQ,
        conformidade: conf,
        groupBy: groupBy,
        limit: 2500
        });

        window.vektorGlobalLoadingShow_(
  "Carregando Itens Irregulares‚Ä¶",
  "Buscando e agregando dados. Isso pode levar alguns segundos."
);

};

// =====================================================
// MODAL ‚Äî Detalhamento Itens Irregulares (Radar)
// =====================================================
window.vektorOpenItensIrregDetalhamentoModal = function () {
  const m = document.getElementById("itensIrregDetalhamentoModal");
  if (!m) return;

  const rows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];

  // abre modal
  m.style.display = "block";

  // se ainda n√£o carregou nada, s√≥ mostra aviso
  if (!rows.length) {
    const tbody = document.getElementById("itensIrregTbody");
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="padding:12px; color:rgba(226,232,240,0.80); font-weight:900; font-size:12px;">
            Sem dados para detalhar. Selecione o per√≠odo e clique em <b>Atualizar</b> primeiro.
          </td>
        </tr>`;
    }
    return;
  }

  // popula filtros e renderiza (local, sem backend)
  if (typeof window.vektorItensIrregDetBuildFilters_ === "function") {
    window.vektorItensIrregDetBuildFilters_();
  }
  if (typeof window.vektorRenderItensIrregDetalhamentoFromCache_ === "function") {
    window.vektorRenderItensIrregDetalhamentoFromCache_();
  }
};

window.vektorCloseItensIrregDetalhamentoModal = function () {
  const m = document.getElementById("itensIrregDetalhamentoModal");
  if (!m) return;
  m.style.display = "none";
};

// ‚úÖ alias (caso alguma parte antiga chame o nome ‚Äúsem Detalhamento‚Äù)
window.vektorOpenItensIrregDetalhamentoModal = window.vektorOpenItensIrregDetalhamentoModal;
window.vektorCloseItensIrregDetalhamentoModal = window.vektorCloseItensIrregDetalhamentoModal;

window.vektorItensIrregDetBuildFilters_ = function () {
  const rows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selLoja = document.getElementById("itensIrregDetFiltroLoja");
  const selTime = document.getElementById("itensIrregDetFiltroTime");
  if (!selLoja || !selTime) return;

  const curLoja = String(selLoja.value || "").trim();
  const curTime = String(selTime.value || "").trim();

  const norm = (x) => String(x || "").trim();
  const uniq = (arr) => Array.from(new Set(arr)).filter(Boolean).sort((a, b) => String(a).localeCompare(String(b), "pt-BR"));

  // 1) calcula lojas poss√≠veis respeitando o TIME selecionado
  const lojasPossiveis = uniq(
    rows
      .filter(r => !curTime || norm(r.time) === curTime)
      .map(r => norm(r.loja))
      .filter(x => x && x !== "‚Äî")
  );

  // 2) calcula times poss√≠veis respeitando a LOJA selecionada
  const timesPossiveis = uniq(
    rows
      .filter(r => !curLoja || norm(r.loja) === curLoja)
      .map(r => norm(r.time))
      .filter(x => x && x !== "‚Äî")
  );

  // helper para montar options
  const esc = (s) => String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");

  // atualiza select Loja
  selLoja.innerHTML =
    `<option value="">Todas</option>` +
    lojasPossiveis.map(x => `<option value="${esc(x)}">${esc(x)}</option>`).join("");

  // atualiza select Time
  selTime.innerHTML =
    `<option value="">Todos</option>` +
    timesPossiveis.map(x => `<option value="${esc(x)}">${esc(x)}</option>`).join("");

    // ‚úÖ cascata: ao mudar um, refaz op√ß√µes do outro e re-renderiza a tabela
    selLoja.onchange = function () {
      window.vektorItensIrregDetBuildFilters_();             // refaz op√ß√µes respeitando a Loja
      window.vektorRenderItensIrregDetalhamentoFromCache_(); // re-renderiza tabela
    };

    selTime.onchange = function () {
      window.vektorItensIrregDetBuildFilters_();             // refaz op√ß√µes respeitando o Time
      window.vektorRenderItensIrregDetalhamentoFromCache_(); // re-renderiza tabela
    };

  // 3) tenta manter sele√ß√£o atual, mas se n√£o existir mais, zera
  if (curLoja && lojasPossiveis.indexOf(curLoja) === -1) selLoja.value = "";
  else selLoja.value = curLoja;

  if (curTime && timesPossiveis.indexOf(curTime) === -1) selTime.value = "";
  else selTime.value = curTime;
};

window.vektorClearItensIrregDetFilters_ = function() {
  const selLoja = document.getElementById("itensIrregDetFiltroLoja");
  const selTime = document.getElementById("itensIrregDetFiltroTime");
  if (selLoja) selLoja.value = "";
  if (selTime) selTime.value = "";
  window.vektorItensIrregDetBuildFilters_();
  window.vektorRenderItensIrregDetalhamentoFromCache_();
};

window.vektorRenderItensIrregDetalhamentoFromCache_ = function () {
  const tbody = document.getElementById("itensIrregDetTbody");
  if (!tbody) return;

  const baseRowsRaw = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];

  // ‚úÖ cria √≠ndice est√°vel p/ checkbox (n√£o quebra com filtros)
  const baseRows = baseRowsRaw.map((r, i) => Object.assign({}, r, { __baseIdx: i }));

  // ‚úÖ l√™ filtros do modal
  const selLojaEl = document.getElementById("itensIrregDetFiltroLoja");
  const selTimeEl = document.getElementById("itensIrregDetFiltroTime");
  const selLoja = selLojaEl ? String(selLojaEl.value || "").trim() : "";
  const selTime = selTimeEl ? String(selTimeEl.value || "").trim() : "";

  // ‚úÖ aplica filtros (local, sem backend)
  let rows = baseRows.slice();
  if (selLoja) rows = rows.filter(r => String(r.loja || "").trim() === selLoja);
  if (selTime) rows = rows.filter(r => String(r.time || "").trim() === selTime);

  const fmtBRL = (v) =>
    Number(v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  // ‚úÖ badge igual ao do sistema (ALERTA/OK/REVISAR)
  const badge = (c) => {
    const x = String(c || "").toUpperCase();
    let bg = "rgba(255,255,255,0.06)", bd = "rgba(148,163,184,0.25)", tx = "rgba(226,232,240,0.95)";
    if (x === "OK") { bg = "rgba(34,197,94,0.18)"; bd = "rgba(34,197,94,0.35)"; tx = "#14532d"; }
    if (x === "REVISAR") { bg = "rgba(245,158,11,0.20)"; bd = "rgba(245,158,11,0.40)"; tx = "#713f12"; }
    if (x === "ALERTA") { bg = "rgba(248,113,113,0.20)"; bd = "rgba(248,113,113,0.40)"; tx = "#7f1d1d"; }
    return `<span style="display:inline-flex; align-items:center; height:22px; padding:0 10px; border-radius:999px;
      border:1px solid ${bd}; background:${bg}; color:${tx}; font-weight:1000; font-size:11px;">${x || "‚Äî"}</span>`;
  };

  if (!rows.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="padding:12px; color:rgba(15,23,42,0.75); font-weight:900; font-size:12px;">
          Sem itens para os filtros selecionados.
        </td>
      </tr>`;
    return;
  }

  const grid = "1px solid rgba(2,6,23,0.22)";
  const tdBase = `padding:10px; border-bottom:${grid}; border-right:${grid};
                  color:rgba(15,23,42,0.92); font-weight:900; font-size:12px;`;

  tbody.innerHTML = rows.map((r, idx) => {
    const bg = (idx % 2 === 0) ? "rgba(226,232,240,0.92)" : "rgba(226,232,240,0.82)";
    const td = (extra) => `${tdBase} background:${bg}; ${extra || ""}`;

    // ‚úÖ checkbox dentro da 1¬™ coluna (Data), sem criar coluna nova
    const checked = (window.__itensIrregDetSel && window.__itensIrregDetSel[r.__baseIdx]) ? "checked" : "";

    return `
      <tr>
        <td style="${td()}">
          <input type="checkbox"
            class="itensIrregDetChk"
            data-base-idx="${r.__baseIdx}"
            ${checked}
            style="width:14px; height:14px; margin-right:10px; vertical-align:middle; cursor:pointer;" />
          <span style="vertical-align:middle;">${r.dataTxt || "‚Äî"}</span>
        </td>

        <td style="${td("text-align:right; font-weight:1000;")}">${fmtBRL(r.valor)}</td>
        <td style="${td("font-weight:1000;")}">${r.loja || "‚Äî"}</td>
        <td style="${td("font-weight:900;")}">${r.time || "‚Äî"}</td>
        <td style="${td("font-weight:900;")}">${r.item || "‚Äî"}</td>
        <td style="${td("font-weight:1000;")}">${badge(r.conformidade || r.status || "")}</td>
        <td style="${td("border-right:none; font-weight:900; color:rgba(15,23,42,0.82);")}">${r.motivo || "‚Äî"}</td>
      </tr>
    `;
  }).join("");

  // ‚úÖ persiste sele√ß√£o ao clicar
  tbody.querySelectorAll('input.itensIrregDetChk').forEach(chk => {
    chk.onchange = function () {
      const bi = Number(this.getAttribute("data-base-idx"));
      window.__itensIrregDetSel = window.__itensIrregDetSel || {};
      if (this.checked) window.__itensIrregDetSel[bi] = true;
      else delete window.__itensIrregDetSel[bi];
    };
  });
};

window.vektorItensIrregDetSelectAll_ = function () {
  const baseRows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  if (!baseRows.length) return;

  window.__itensIrregDetSel = {};

  for (let i = 0; i < baseRows.length; i++) {
    window.__itensIrregDetSel[i] = true;
  }

  // Atualiza visualmente os checkboxes vis√≠veis
  document.querySelectorAll("#itensIrregDetTbody input.itensIrregDetChk").forEach(chk => {
    chk.checked = true;
  });
};

window.vektorItensIrregDetDeselectAll_ = function () {
  window.__itensIrregDetSel = {};

  // Atualiza visualmente os checkboxes vis√≠veis
  document.querySelectorAll("#itensIrregDetTbody input.itensIrregDetChk").forEach(chk => {
    chk.checked = false;
  });
};

window.vektorEnviarNotificacaoItensIrregularesSelecionados_ = function () {
  const baseRows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selMap = window.__itensIrregDetSel || {};

  const idxs = Object.keys(selMap).map(n => Number(n)).filter(n => Number.isFinite(n));
  if (!idxs.length) {
    alert("Selecione pelo menos 1 linha (checkbox) para enviar.");
    return;
  }

  const selected = idxs
    .map(i => baseRows[i])
    .filter(Boolean)
    .map(r => ({
      dataTxt: r.dataTxt || "",
      valor: r.valor || 0,
      loja: r.loja || "",
      time: r.time || "",
      item: r.item || "",
      conformidade: (r.conformidade || r.status || ""),
      motivo: r.motivo || ""
    }));

  // loading padr√£o do Vektor (j√° existe no seu projeto)
  try {
    window.vektorGlobalLoadingShow_(
      "Enviando Notifica√ß√µes‚Ä¶",
      "Aguarde: estamos enviando os e-mails para lojas e regionais."
    );
  } catch (e) {}

  google.script.run
    .withSuccessHandler(function (res) {
      try { window.vektorGlobalLoadingHide_(); } catch (e) {}

      if (!res || !res.ok) {
        alert((res && res.error) ? res.error : "Falha ao enviar e-mails.");
        return;
      }

      // ‚úÖ limpa sele√ß√£o ap√≥s sucesso (evita reenvio acidental / ‚Äúspam‚Äù)
      window.__itensIrregDetSel = {};
      // re-render para desmarcar visualmente
      try { window.vektorRenderItensIrregDetalhamentoFromCache_(); } catch (e) {}

      alert("Emails enviados com sucesso.");
    })
    .withFailureHandler(function (err) {
      try { window.vektorGlobalLoadingHide_(); } catch (e) {}
      const msg = (err && err.message) ? err.message : String(err || "Erro");
      alert("Falha ao enviar e-mails: " + msg);
    })
    .dispararNotificacaoItensIrregularesSelecionados(selected);
};

window.vektorClosePreviewItensIrregDet_ = function () {
  const m = document.getElementById("itensIrregPreviewModal");
  if (m) m.style.display = "none";
};

window.vektorOpenPreviewItensIrregDet_ = function () {
  const m = document.getElementById("itensIrregPreviewModal");
  const body = document.getElementById("itensIrregPreviewBody");
  if (!m || !body) return;

  const baseRows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selMap = window.__itensIrregDetSel || {};
  const idxs = Object.keys(selMap).map(n => Number(n)).filter(n => Number.isFinite(n));

  if (!idxs.length) {
    body.innerHTML = `<div style="font-weight:900; color:rgba(226,232,240,0.92);">
      Nenhuma linha selecionada. Marque os checkboxes na tabela para ver a pr√©via.
    </div>`;
    m.style.display = "block";
    return;
  }

  const selected = idxs.map(i => baseRows[i]).filter(Boolean);

  const sumBRL = (n) => {
    try { return Number(n || 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" }); }
    catch(e){ return String(n || 0); }
  };

  function addAgg(map, key, valor) {
    key = String(key || "‚Äî").trim() || "‚Äî";
    if (!map[key]) map[key] = { key, qtd: 0, total: 0 };
    map[key].qtd += 1;
    map[key].total += Number(valor || 0);
  }

  const byTime = {};
  const byLoja = {};

  selected.forEach(r => {
    addAgg(byTime, r.time, r.valor);
    addAgg(byLoja, r.loja, r.valor);
  });

  const arrTime = Object.values(byTime).sort((a,b) => b.total - a.total);
  const arrLoja = Object.values(byLoja).sort((a,b) => b.total - a.total);

  const mkTable = (title, arr) => {
    const rows = arr.map(x => `
      <tr>
        <td style="padding:10px; border-top:1px solid rgba(148,163,184,0.18); font-weight:900;">${x.key}</td>
        <td style="padding:10px; border-top:1px solid rgba(148,163,184,0.18); text-align:right; font-weight:1000;">${x.qtd}</td>
        <td style="padding:10px; border-top:1px solid rgba(148,163,184,0.18); text-align:right; font-weight:1000;">${sumBRL(x.total)}</td>
      </tr>
    `).join("");

    return `
      <div style="margin-top:12px; font-weight:1000; color:#fff;">${title}</div>
      <div style="margin-top:8px; border:1px solid rgba(148,163,184,0.18); border-radius:12px; overflow:hidden;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:rgba(255,255,255,0.06);">
              <th style="text-align:left; padding:10px; font-size:12px; color:rgba(226,232,240,0.85);">Grupo</th>
              <th style="text-align:right; padding:10px; font-size:12px; color:rgba(226,232,240,0.85);">Qtde</th>
              <th style="text-align:right; padding:10px; font-size:12px; color:rgba(226,232,240,0.85);">Total</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  };

  const totalSel = selected.length;
  const totalValor = selected.reduce((acc, r) => acc + Number(r.valor || 0), 0);

  body.innerHTML = `
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <div style="padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.18);
                  background:rgba(255,255,255,0.04);">
        <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Linhas selecionadas</div>
        <div style="font-size:18px; color:#fff; font-weight:1000;">${totalSel}</div>
      </div>

      <div style="padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.18);
                  background:rgba(255,255,255,0.04);">
        <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Valor total selecionado</div>
        <div style="font-size:18px; color:#fff; font-weight:1000;">${sumBRL(totalValor)}</div>
      </div>
    </div>

    ${mkTable("Resumo por Time", arrTime)}
    ${mkTable("Resumo por Loja", arrLoja)}
  `;

  m.style.display = "block";
};

window.vektorExportRadarItensIrregularesCSV = function() {
  const rows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  if (!rows.length) {
    alert("Sem dados para exportar.");
    return;
  }

  const esc = (s) => `"${String(s || "").replace(/"/g, '""')}"`;
  const header = ["Data", "Valor (R$)", "Loja", "Time", "Item Comprado", "Conformidade", "Motivo"];
  const csv = [header.map(esc).join(",")].concat(rows.map(r => {
    return [
      r.dataTxt || "",
      (Number(r.valor || 0)).toFixed(2).replace(".", ","),
      r.loja || "",
      r.time || "",
      r.item || "",
      r.conformidade || "",
      r.motivo || ""
    ].map(esc).join(",");
  })).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "itens_irregulares.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
};

window.vektorRenderItensIrregDetalhamentoModal_ = function() {
  const tbody = document.getElementById("itensIrregDetTbody");
  if (!tbody) return;

  const base = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selLoja = (document.getElementById("itensIrregDetFilterLoja") || {}).value || "";
  const selTime = (document.getElementById("itensIrregDetFilterTime") || {}).value || "";

  let rows = base.slice();
  if (selLoja) rows = rows.filter(r => String(r.loja || "").trim() === selLoja);
  if (selTime) rows = rows.filter(r => String(r.time || "").trim() === selTime);

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(226,232,240,0.75); font-weight:900; font-size:12px;">Sem itens para os filtros selecionados.</td></tr>`;
    return;
  }

  const fmtBRL = (v) => Number(v||0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });

  tbody.innerHTML = rows.map(r => {
    const conf = String(r.conformidade || "");
    const confBg =
      (conf.toUpperCase() === "ALERTA") ? "rgba(239,68,68,0.20)" :
      (conf.toUpperCase() === "REVISAR") ? "rgba(251,191,36,0.18)" :
      "rgba(34,197,94,0.16)";

    return `
      <tr style="border-bottom:1px solid rgba(148,163,184,0.10);">
        <td style="padding:10px; color:rgba(226,232,240,0.90); font-size:12px; font-weight:800;">${r.dataTxt || ""}</td>
        <td style="padding:10px; color:#fff; font-size:12px; font-weight:900; text-align:right;">${fmtBRL(r.valor)}</td>
        <td style="padding:10px; color:#fff; font-size:12px; font-weight:900;">${r.loja || "‚Äî"}</td>
        <td style="padding:10px; color:rgba(226,232,240,0.92); font-size:12px; font-weight:800;">${r.time || "‚Äî"}</td>
        <td style="padding:10px; color:rgba(226,232,240,0.92); font-size:12px; font-weight:800;">${(r.item || "")}</td>
        <td style="padding:10px; color:#fff; font-size:12px; font-weight:1000; background:${confBg}; border-radius:8px;">${conf}</td>
        <td style="padding:10px; color:rgba(226,232,240,0.86); font-size:12px; font-weight:800;">${(r.motivo || "")}</td>
      </tr>
    `;
  }).join("");
};

// ===============================
// HELPERS (Radar / Itens Irregulares)
// ===============================
function vektorIsoDateToBR_(iso) {
  // iso esperado: "yyyy-mm-dd" (input type="date")
  if (!iso || typeof iso !== "string") return "";
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return "";
  return `${m[3]}/${m[2]}/${m[1]}`; // dd/MM/yyyy
}

function setRadarActiveBtn_(modo) {
  const map = {
    "7d": "radarBtn7d",
    "ciclo": "radarBtnCiclo",
    "full": "radarBtnFull"
  };

  // reseta todos
  ["radarBtn7d", "radarBtnCiclo", "radarBtnFull"].forEach(id => {
    const b = document.getElementById(id);
    if (!b) return;
    b.style.background = "rgba(255,255,255,0.06)";
    b.style.color = "#ffffff";
  });

  // aplica ativo
  const activeId = map[String(modo || "7d").toLowerCase()] || "radarBtn7d";
  const a = document.getElementById(activeId);
  if (a) {
    a.style.background = "#16a34a";   // verde
    a.style.color = "#04110a";        // texto escuro
  }
}

function renderRadarHeatmap_(lojas) {
  const heat = document.getElementById("radarHeatmap");
  if (!heat) return;

  const metrics = [
    { key: "casos", label: "CASOS" },
    { key: "avgScore", label: "AVG" },
    { key: "maxScore", label: "MAX" },
    { key: "pendRate", label: "PEND" },
    { key: "avgQtdDia", label: "QTD/D" },
    { key: "maxValor", label: "VALOR" }
  ];

  const series = {};
  metrics.forEach(m => { series[m.key] = lojas.map(x => Number(x[m.key] || 0)); });

  const corr = (a, b) => {
    const n = Math.min(a.length, b.length);
    if (n < 3) return 0;
    let sa = 0, sb = 0;
    for (let i = 0; i < n; i++) { sa += a[i]; sb += b[i]; }
    const ma = sa / n, mb = sb / n;

    let num = 0, da = 0, db = 0;
    for (let i = 0; i < n; i++) {
      const xa = a[i] - ma;
      const xb = b[i] - mb;
      num += xa * xb;
      da += xa * xa;
      db += xb * xb;
    }
    const den = Math.sqrt(da * db);
    return den ? (num / den) : 0;
  };

  // Cores fortes e ‚Äúrealistas‚Äù: azul forte <-> cinza escuro <-> vermelho forte
  const colorFor = (v) => {
    v = Math.max(-1, Math.min(1, v));
    if (v >= 0) {
      const t = v;
      return `rgba(239,68,68,${0.22 + 0.78 * t})`; // vermelho forte
    } else {
      const t = Math.abs(v);
      return `rgba(59,130,246,${0.22 + 0.78 * t})`; // azul forte
    }
  };

  // Grid compacto, sem ‚Äúburacos‚Äù grandes
  const n = metrics.length;
  let html = `
    <div style="display:grid; grid-template-columns: 70px repeat(${n}, 56px); gap:2px; align-items:center;">
      <div></div>
      ${metrics.map(m => `<div style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900; text-align:center;">${m.label}</div>`).join("")}
  `;

  for (let i = 0; i < n; i++) {
    html += `<div style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900; padding-left:2px;">${metrics[i].label}</div>`;
    for (let j = 0; j < n; j++) {
      if (j <= i) {
        // triangular (meia matriz), mas sem espa√ßamento absurdo
        html += `<div style="width:56px; height:44px; background:rgba(2,6,23,0.35); border:1px solid rgba(148,163,184,0.10); border-radius:8px;"></div>`;
      } else {
        const v = corr(series[metrics[i].key], series[metrics[j].key]);
        const txt = (Math.round(v * 100) / 100).toFixed(2);
        html += `
          <div style="width:56px; height:44px; border-radius:8px; background:${colorFor(v)};
                      border:1px solid rgba(15,23,42,0.25); display:flex; align-items:center; justify-content:center;">
            <div style="font-size:12px; font-weight:1000; color:rgba(255,255,255,0.95);
            text-shadow:0 2px 6px rgba(0,0,0,0.85);">${txt}</div>
          </div>`;
      }
    }
  }

  html += `</div>`;
  heat.innerHTML = html;
}

function radarCorr_(a, b) {
  const n = Math.min(a.length, b.length);
  if (n < 3) return 0;

  let sa = 0, sb = 0;
  for (let i = 0; i < n; i++) { sa += a[i]; sb += b[i]; }
  const ma = sa / n, mb = sb / n;

  let num = 0, da = 0, db = 0;
  for (let i = 0; i < n; i++) {
    const xa = a[i] - ma;
    const xb = b[i] - mb;
    num += xa * xb;
    da += xa * xa;
    db += xb * xb;
  }
  const den = Math.sqrt(da * db);
  return den ? (num / den) : 0;
}

function radarStrengthLabel_(vAbs) {
  if (vAbs < 0.20) return "irrelevante";
  if (vAbs < 0.40) return "fraca";
  if (vAbs < 0.60) return "moderada";
  if (vAbs < 0.80) return "forte";
  return "muito forte";
}

function renderRadarInsights_(lojas) {
  const el = document.getElementById("radarInsights");
  if (!el) return;

  const nLojas = Array.isArray(lojas) ? lojas.length : 0;
  if (nLojas < 3) {
    el.innerHTML =
      "<div style='font-weight:900;color:#fff;margin-bottom:6px;'>Leitura autom√°tica do Radar</div>" +
      "<div style='opacity:0.85;'>Amostra pequena (" + nLojas + " lojas). A correla√ß√£o pode ficar inst√°vel; use como sinal.</div>";
    return;
  }

  const metrics = [
    { key: "casos", label: "CASOS" },
    { key: "avgScore", label: "AVG" },
    { key: "maxScore", label: "MAX" },
    { key: "pendRate", label: "PEND" },
    { key: "avgQtdDia", label: "QTD/D" },
    { key: "maxValor", label: "VALOR" }
  ];

  const series = {};
  metrics.forEach(m => { series[m.key] = lojas.map(x => Number(x[m.key] || 0)); });

  let bestPos = { v: -999, a: null, b: null };
  let bestNeg = { v:  999, a: null, b: null };
  let absSum = 0, absCount = 0;

  for (let i = 0; i < metrics.length; i++) {
    for (let j = i + 1; j < metrics.length; j++) {
      const a = metrics[i], b = metrics[j];
      const v = radarCorr_(series[a.key], series[b.key]);
      const av = Math.abs(v);
      absSum += av; absCount++;
      if (v > bestPos.v) bestPos = { v, a, b };
      if (v < bestNeg.v) bestNeg = { v, a, b };
    }
  }

  const avgAbs = absCount ? (absSum / absCount) : 0;
  const trend =
    (avgAbs < 0.20) ? "As m√©tricas est√£o pouco acopladas entre si (correla√ß√µes em geral fracas)." :
    (avgAbs < 0.40) ? "H√° sinais de rela√ß√£o entre m√©tricas, mas ainda majoritariamente fracos/moderados." :
    "As m√©tricas est√£o bem conectadas (correla√ß√µes moderadas/fortes dominantes).";

  const fmt = (v) => (Math.round(v * 100) / 100).toFixed(2);

  const posAbs = Math.abs(bestPos.v);
  const negAbs = Math.abs(bestNeg.v);

    el.innerHTML =
    "<div style='font-weight:900;color:#fff;margin-bottom:6px;'>Leitura autom√°tica do Radar</div>" +
    "<div style='opacity:0.85; margin:-2px 0 8px 0; line-height:1.35;'>" +
        "Base da an√°lise: <b>" + nLojas + "</b> loja(s)" +
      "</div>" +

    "<div style='opacity:0.9; line-height:1.45; margin-bottom:6px;'>" +
      "Este quadro mostra <b>como as m√©tricas se comportaram juntas</b> no per√≠odo. " +
      "Use como <b>triagem operacional</b>: ele sugere onde vale olhar primeiro ‚Äî n√£o conclui irregularidade." +
    "</div>" +

    "<div style='opacity:0.9; line-height:1.45; margin-bottom:6px;'>" +
      "<b>Como ler:</b> <b>positivo</b> = tendem a subir juntas ¬∑ <b>negativo</b> = quando uma sobe, a outra tende a cair. " +
      "Quanto mais forte a correla√ß√£o, mais consistente o padr√£o no per√≠odo." +
    "</div>" +

    "<div style='opacity:0.9;'>" + trend + "</div>" +

    "<div style='margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;'>" +

      "<div style='padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.18);background:rgba(239,68,68,0.10);'>" +
        "<div style='font-weight:900;color:#fff;margin-bottom:4px;'>Mais alinhadas (positivo)</div>" +
        "<div style='opacity:0.9; line-height:1.35;'><b>" + bestPos.a.label + "</b> √ó <b>" + bestPos.b.label + "</b> = <b>" + fmt(bestPos.v) + "</b> (" + radarStrengthLabel_(posAbs) + ")</div>" +
        "<div style='margin-top:6px; font-size:11px; opacity:0.85; line-height:1.35;'>" +
          "Lojas onde <b>" + bestPos.a.label + "</b> sobe tendem a vir com <b>" + bestPos.b.label + "</b> mais alto no per√≠odo. " +
          "Priorize estas lojas no ranking √† direita e valide no detalhe se necess√°rio." +
        "</div>" +
      "</div>" +

      "<div style='padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.18);background:rgba(59,130,246,0.12);'>" +
        "<div style='font-weight:900;color:#fff;margin-bottom:4px;'>Mais inversas (negativo)</div>" +
        "<div style='opacity:0.9; line-height:1.35;'><b>" + bestNeg.a.label + "</b> √ó <b>" + bestNeg.b.label + "</b> = <b>" + fmt(bestNeg.v) + "</b> (" + radarStrengthLabel_(negAbs) + ")</div>" +
        "<div style='margin-top:6px; font-size:11px; opacity:0.85; line-height:1.35;'>" +
          "Quando <b>" + bestNeg.a.label + "</b> aumenta, <b>" + bestNeg.b.label + "</b> tende a cair no per√≠odo. " +
          "Use isso para entender <b>o que est√° puxando o risco</b> (volume, valor, pend√™ncia, frequ√™ncia)." +
        "</div>" +
      "</div>" +

    "</div>" +

    "<div style='margin-top:10px;font-size:12px;opacity:0.85; line-height:1.35;'>" +
      "<b>Nota:</b> correla√ß√£o indica associa√ß√£o (n√£o causalidade). " +
      "A√ß√£o recomendada: selecione a loja em <b>Lojas mais pr√≥ximas</b> e, se precisar confirmar, use o chat <b>‚ÄúPoss√≠vel uso irregular‚Äù</b> para ver transa√ß√µes e regras." +
    "</div>";

}

function renderRadarRanking_(lojas, detalhesPorLoja) {
  const rank = document.getElementById("radarRanking");
  if (!rank) return;

  lojas = Array.isArray(lojas) ? lojas : [];
  detalhesPorLoja = (detalhesPorLoja && typeof detalhesPorLoja === "object") ? detalhesPorLoja : {};

  const esc = (s) => String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");

  if (!lojas.length) {
    rank.innerHTML = `<div style="opacity:0.85; color:rgba(226,232,240,0.85); font-size:12px;">Sem dados suficientes no per√≠odo.</div>`;
    return;
  }

  const norm01 = (arr, v) => {
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    if (!isFinite(min) || !isFinite(max) || max === min) return 0;
    return (v - min) / (max - min);
  };

  const arrMax = lojas.map(x => Number(x.maxScore || 0));
  const arrCasos = lojas.map(x => Number(x.casos || 0));
  const arrPend = lojas.map(x => Number(x.pendRate || 0));

  // tooltip: tabela (1 linha)
  const buildTooltipTable = (row) => {
    if (!row) {
      return "<div style='font-size:12px;opacity:0.9;'>Sem detalhe transacional dispon√≠vel para esta loja no per√≠odo.</div>";
    }

    const th = "padding:6px 8px;font-size:11px;text-align:left;border-bottom:1px solid rgba(226,232,240,0.12);white-space:nowrap;";
    const td = "padding:6px 8px;font-size:11px;border-bottom:1px solid rgba(226,232,240,0.08);white-space:nowrap;";

    // IMPORTANTE: container rol√°vel √© S√ì aqui (classe do Passo 1)
    return (
      "<div style='font-size:12px;font-weight:900;margin-bottom:6px;'>Detalhe (mesma linha do Poss√≠vel uso irregular)</div>" +
      "<div class='vektor-radar-tip-scroll'>" +
        "<table style='border-collapse:collapse; width:max-content; min-width:980px;'>" +
          "<thead>" +
            "<tr style='background:rgba(255,255,255,0.06);'>" +
              "<th style='" + th + "'>Loja</th>" +
              "<th style='" + th + "'>Time</th>" +
              "<th style='" + th + "'>Data</th>" +
              "<th style='" + th + "'>Cart√£o</th>" +
              "<th style='" + th + "'>Estabelecimento</th>" +
              "<th style='" + th + "'>Qtd (dia)</th>" +
              "<th style='" + th + "'>Soma suma (dia)</th>".replace("S", "So") + // evita autocorre√ß√£o estranha ao colar (mant√©m "Soma")
              "<th style='" + th + "'>Maior valor</th>" +
              "<th style='" + th + "'>Pend√™ncias</th>" +
              "<th style='" + th + "'>Score</th>" +
              "<th style='" + th + "'>Regras</th>" +
            "</tr>" +
          "</thead>" +
          "<tbody>" +
            "<tr>" +
              "<td style='" + td + "'>" + esc(row.loja) + "</td>" +
              "<td style='" + td + "'>" + esc(row.time) + "</td>" +
              "<td style='" + td + "'>" + esc(row.data) + "</td>" +
              "<td style='" + td + "'>" + esc(row.cartao) + "</td>" +
              "<td style='" + td + "'>" + esc(row.estabelecimento) + "</td>" +
              "<td style='" + td + "'>" + esc(row.qtdDia) + "</td>" +
              "<td style='" + td + "'>" + esc(row.somaDia) + "</td>" +
              "<td style='" + td + "'>" + esc(row.valor) + "</td>" +
              "<td style='" + td + "'>" + esc(row.pendenciasTxt) + "</td>" +
              "<td style='" + td + "'>" + esc(row.score) + "</td>" +
              "<td style='" + td + "; white-space:normal; min-width:240px;'>" + esc(row.regrasTxt) + "</td>" +
            "</tr>" +
          "</tbody>" +
        "</table>" +
      "</div>"
    );
  };

  const ranked = lojas.map(l => {
    const s1 = norm01(arrMax, Number(l.maxScore || 0));
    const s2 = norm01(arrCasos, Number(l.casos || 0));
    const s3 = norm01(arrPend, Number(l.pendRate || 0));
    const risco = (0.55*s1 + 0.30*s2 + 0.15*s3);
    return { ...l, risco: Number((risco * 100).toFixed(1)), _s1: s1, _s2: s2, _s3: s3 };
  }).sort((a,b) => b.risco - a.risco);

  rank.innerHTML = ranked.slice(0, 18).map((r, idx) => {
    const w = Math.max(2, Math.min(100, r.risco));
    const detalhe = detalhesPorLoja[String(r.loja)] || null;

    return `
      <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(148,163,184,0.18); border-radius:12px; padding:10px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:baseline;">
          <div style="color:#fff; font-weight:950; font-size:12px;">
            ${idx+1}. Loja ${esc(r.loja)} <span style="color:rgba(226,232,240,0.7); font-weight:800;">(${esc(r.time || "N/D")})</span>
          </div>

          <div style="color:#fff; font-weight:1000; font-size:12px; display:flex; align-items:center; gap:6px;">
            ${esc(r.risco)}

            <span class="vektor-btn-wrapper" style="display:inline-flex; align-items:center;">
              <span style="font-size:12px; font-weight:900; color:#93c5fd; cursor:help;">‚ìò</span>
              <span class="vektor-tooltip-base" style="white-space:normal; max-width:280px; line-height:1.35; background:rgba(15,23,42,0.95); border:1px solid rgba(148,163,184,0.25);">
                <b>Score composto (0‚Äì100)</b><br/>
                risco = (0.55¬∑MAX + 0.30¬∑CASOS + 0.15¬∑PEND)¬∑100<br/><br/>
                <b>Normalizados (0‚Äì1):</b><br/>
                MAX: ${(r._s1).toFixed(2)} ¬∑ CASOS: ${(r._s2).toFixed(2)} ¬∑ PEND: ${(r._s3).toFixed(2)}<br/><br/>
                <b>Valores:</b><br/>
                maxScore=${esc(r.maxScore)} ¬∑ casos=${esc(r.casos)} ¬∑ pendRate=${(Number(r.pendRate||0)*100).toFixed(1)}%
              </span>
            </span>
          </div>
        </div>

        <!-- Tooltip NA BARRA (tabela rol√°vel, n√£o some ao rolar) -->
        <span class="vektor-btn-wrapper vektor-radar-tip" style="display:block; margin-top:8px;">
          <div style="height:10px; border-radius:999px; background:rgba(148,163,184,0.18); overflow:hidden;">
            <div style="height:10px; width:${w}%; background:linear-gradient(90deg, rgba(239,68,68,0.85), rgba(234,179,8,0.75));"></div>
          </div>

          <span class="vektor-tooltip-base vektor-radar-tip">
            ${buildTooltipTable(detalhe)}
          </span>
        </span>

        <div style="margin-top:8px; color:rgba(226,232,240,0.85); font-size:11px;">
          casos: <b>${esc(r.casos)}</b> ¬∑ maxScore: <b>${esc(r.maxScore)}</b> ¬∑ pend: <b>${(Number(r.pendRate||0)*100).toFixed(1)}%</b>
        </div>
      </div>
    `;
  }).join("");
}

// ===============================
// MEUS ALERTAS (Transa√ß√µes por Etiqueta)
// ===============================

function vektorShowMyAlertsView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  [chatView, radarView, feedbackView, fluxView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (envPendModal) { envPendModal.classList.add("hidden"); envPendModal.style.display = "none"; }
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (myAlertsView) {
    myAlertsView.classList.remove("hidden");
    myAlertsView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
}

window.vektorOpenMyAlerts = function () {
  vektorShowMyAlertsView_();

  // ‚úÖ mostra filtros admin (e-mail + √°rea) ‚Äî REGRA √öNICA (robusta)
  try {
    const roleTxt = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "") : "");
    console.log("ROLE FRONT:", roleTxt);
    const isAdmin = (roleTxt.trim().toLowerCase() === "administrador");
    const box = document.getElementById("myAl_adminFilterBox");
    if (box) box.style.display = isAdmin ? "block" : "none";
  } catch (_) {}

  window.vektorMyAlertsInit_();
};

window.vektorMyAlertsInit_ = function () {
  // 1) carrega times/lojas
  if (typeof google === "undefined" || !google.script || !google.script.run) return;

  google.script.run
    .withSuccessHandler(function (res) {
      // ‚úÖ N√ÉO falhar silencioso
      if (!res || !res.ok) {
        const msg = "Falha ao carregar Times/Lojas: " + (res && res.error ? res.error : "sem permiss√£o ou erro desconhecido");
        if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
        return;
      }

      window.__myAl_lojasPorTime = res.lojasPorTime || {};

      // popula times
      const teamSel = document.getElementById("myAl_team");
      if (teamSel) {
        teamSel.innerHTML =
          "<option value='__ALL__'>Todos os times</option>" +
          "<option value='' disabled>Selecione‚Ä¶</option>";

        (res.times || []).forEach(t => {
          const op = document.createElement("option");
          op.value = t;
          op.textContent = t;
          teamSel.appendChild(op);
        });

        teamSel.onchange = function () {
          const val = String(teamSel.value || "").trim();
          const box = document.getElementById("myAl_storesBox");

          if (val === "__ALL__") {
            // ‚úÖ Todos os times => todas as lojas (n√£o precisa selecionar nada)
            if (box) {
              box.innerHTML =
                "<div style='opacity:0.95; font-size:12px; font-weight:900; color:#B5FF20;'>Aplicado para todas as lojas</div>" +
                "<div style='opacity:0.75; font-size:11px; margin-top:4px; color:#E2E8F0;'>Selecione um time espec√≠fico para escolher lojas.</div>";

              // efeito visual de desativado
              box.style.pointerEvents = "none";
              box.style.opacity = "0.75";
            }
            return;
          }

          // ‚úÖ Time espec√≠fico => habilita e renderiza lojas
          if (box) {
            box.style.pointerEvents = "auto";
            box.style.opacity = "1";
          }
          window.vektorMyAlertsRenderStores_(window.__myAl_lojasPorTime || {}, val);
        };
      }

      // default: limpa lojas
      window.vektorMyAlertsRenderStores_(window.__myAl_lojasPorTime || {}, "");
    })
    .withFailureHandler(function (err) {
      const msg = "Erro ao carregar Times/Lojas: " + (err && err.message ? err.message : err);
      if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
    })
    .getTimesELojasParaAlertasVektor(); // Code.gs

  // 1.1) carrega etiquetas
  google.script.run
    .withSuccessHandler(function (res2) {
      // ‚úÖ N√ÉO falhar silencioso
      if (!res2 || !res2.ok) {
        const msg = "Falha ao carregar Etiquetas: " + (res2 && res2.error ? res2.error : "sem permiss√£o ou erro desconhecido");
        if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
        return;
      }

      const sel = document.getElementById("myAl_label");
      if (!sel) return;

      sel.innerHTML = "";

      // op√ß√£o "todas"
      const opAll = document.createElement("option");
      opAll.value = "__ALL__";
      opAll.textContent = "Todas";
      sel.appendChild(opAll);

      (res2.etiquetas || []).forEach(function (t) {
        const op = document.createElement("option");
        op.value = t;
        op.textContent = t;
        sel.appendChild(op);
      });

      // ‚úÖ UX: se selecionar "Todas", seleciona visualmente tudo
      sel.onchange = function () {
        const pickedAll = Array.from(sel.selectedOptions || []).some(op => op.value === "__ALL__");
        if (!pickedAll) return;
        Array.from(sel.options || []).forEach(op => { op.selected = true; });
      };
    })
    .withFailureHandler(function (err) {
      const msg = "Erro ao carregar Etiquetas: " + (err && err.message ? err.message : err);
      if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
    })
    .getEtiquetasDisponiveisVektor();

      // =========================
  // Tipo de alerta (Transa√ß√µes vs Pend√™ncias)
  // =========================
  try {
    const typeSel = document.getElementById("myAl_alertType");
    const subtitle = document.getElementById("myAl_subtitle");
    const hint = document.getElementById("myAl_createHint");
    const labelWrap = document.getElementById("myAl_labelWrap");

    const applyType = () => {
      const t = String(typeSel?.value || "TRANSACOES").trim();

      if (t === "PENDENCIAS") {
        if (subtitle) subtitle.textContent = "Alertas de Pend√™ncias por Lojas e Times (com hist√≥rico e execu√ß√£o programada), disparado sempre em dias √∫teis.";
        if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Valor, Estabelecimento, Titular, Pend√™ncias).";
        if (labelWrap) labelWrap.style.display = "none";
      } else {
        if (subtitle) subtitle.textContent = "Alertas de Transa√ß√µes por Lojas, Times e Tags (com hist√≥rico e execu√ß√£o programada), disparado sempre em dias √∫teis.";
        if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Estabelecimento, Valor, Etiqueta, Descri√ß√£o).";
        if (labelWrap) labelWrap.style.display = "block";
      }
    };

    if (typeSel) {
      typeSel.onchange = function () {
        // ao trocar tipo, limpa edi√ß√£o (evita editar pend√™ncias como transa√ß√µes)
        window.__myAl_editingAlertId = "";
        const btn = document.getElementById("myAl_saveBtn");
        if (btn) btn.textContent = "Criar alerta";
        applyType();
      };
    }

    applyType();
  } catch (_) {}

  // ‚úÖ Filtros Admin: popular "√Årea" + atualizar lista ao mudar filtros
  try {
    const roleTxt = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "") : "");
    const isAdmin = (roleTxt.trim().toLowerCase() === "administrador");

    const emailInp = document.getElementById("myAl_adminEmail");
    const roleSel  = document.getElementById("myAl_adminRole");

    if (emailInp) emailInp.oninput = function () { window.vektorMyAlertsRefresh(); };
    if (roleSel)  roleSel.onchange = function () { window.vektorMyAlertsRefresh(); };

    // popula as √°reas s√≥ para Admin
    if (isAdmin && roleSel && typeof google !== "undefined" && google.script && google.script.run) {
      roleSel.innerHTML = "<option value=''>Todas as √°reas</option>";

      google.script.run
        .withSuccessHandler(function (r) {
          if (!r || !r.ok) return;
          (r.roles || []).forEach(function (name) {
            const op = document.createElement("option");
            op.value = name;
            op.textContent = name;
            roleSel.appendChild(op);
          });
        })
        .withFailureHandler(function (err) {
          const msg = "Erro ao carregar √Åreas (Admin): " + (err && err.message ? err.message : err);
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
        })
        .getRolesParaFiltroAlertasVektor();
    }
  } catch (_) {}

  // 2) carrega lista
  window.vektorMyAlertsRefresh();
};

window.vektorMyAlertsRenderStores_ = function (map, time) {
  const box = document.getElementById("myAl_storesBox");
  if (!box) return;

  const lojas = (time && map && map[time]) ? map[time] : [];
  if (!time) {
    box.innerHTML = "<div style='opacity:0.8; font-size:12px;'>Selecione um time para listar as lojas.</div>";
    return;
  }
  if (!lojas.length) {
    box.innerHTML = "<div style='opacity:0.8; font-size:12px;'>Nenhuma loja encontrada para esse time.</div>";
    return;
  }

  box.innerHTML = "";

// ‚úÖ Selecionar todas
const wrapAll = document.createElement("label");
wrapAll.style.display = "flex";
wrapAll.style.alignItems = "center";
wrapAll.style.gap = "8px";
wrapAll.style.fontSize = "12px";
wrapAll.style.marginBottom = "10px";
wrapAll.style.fontWeight = "900";
wrapAll.innerHTML =
  "<input type='checkbox' id='myAl_store_all' />" +
  "<span style='opacity:0.95;'>Selecionar todas</span>";
box.appendChild(wrapAll);

const cbAll = wrapAll.querySelector("#myAl_store_all");
if (cbAll) {
  cbAll.addEventListener("change", function () {
    const on = !!cbAll.checked;
    box.querySelectorAll("input[type='checkbox'][data-loja]").forEach(cb => {
      cb.checked = on;
    });
  });
}

// ‚úÖ lista de lojas
lojas.forEach(function (l) {
  const id = "myAl_store_" + String(l).replace(/\W+/g, "_");
  const row = document.createElement("label");
  row.style.display = "flex";
  row.style.alignItems = "center";
  row.style.gap = "8px";
  row.style.fontSize = "12px";
  row.style.marginBottom = "6px";
  row.innerHTML =
    "<input type='checkbox' id='" + id + "' data-loja='" + String(l) + "' />" +
    "<span style='opacity:0.95;'>" + String(l) + "</span>";
  box.appendChild(row);
});

// Se desmarcar qualquer uma, desmarca ‚Äútodas‚Äù
box.querySelectorAll("input[type='checkbox'][data-loja]").forEach(cb => {
  cb.addEventListener("change", function(){
    if (!cb.checked && cbAll) cbAll.checked = false;
  });
});
  
};

window.vektorMyAlertsCreate = function () {
  const status = document.getElementById("myAl_createStatus");
  const setStatus = (t) => { if (status) status.textContent = String(t || ""); };

  try {
    const email = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
    const role  = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "").trim() : "");

    const freq = (document.getElementById("myAl_freq")?.value || "DAILY").trim();

    // Janela: se vazio -> 30
    const winRaw = String(document.getElementById("myAl_windowDays")?.value || "").trim();
    const windowDays = Number(winRaw || 30) || 30;

    // Time / Grupo
    const time = (document.getElementById("myAl_team")?.value || "").trim();

    // Hor√°rio (HH:mm)
    const sendAt = String(document.getElementById("myAl_sendAt")?.value || "").trim();

    // Tipo de alerta
    const alertType = String(document.getElementById("myAl_alertType")?.value || "TRANSACOES").trim();

    // Etiquetas
    const etiquetas = [];
    const labelEl = document.getElementById("myAl_label");
    if (labelEl) {
      if (labelEl.tagName === "SELECT" && labelEl.multiple) {
        Array.from(labelEl.selectedOptions || []).forEach(op => {
          const v = String(op.value || "").trim();
          if (v) etiquetas.push(v);
        });
      } else {
        const v = String(labelEl.value || "").trim();
        if (v) etiquetas.push(v);
      }
    }

    const isAll = etiquetas.includes("__ALL__");
    const etiquetasFinal = isAll ? [] : etiquetas.filter(x => x && x !== "__ALL__");

    // ‚úÖ regra: Pend√™ncias n√£o usa etiquetas
    const etiquetasFinalEff = (alertType === "PENDENCIAS") ? [] : etiquetasFinal;

    // Lojas
    const storesBox = document.getElementById("myAl_storesBox");
    const lojas = [];
    if (storesBox) {
      storesBox.querySelectorAll("input[type='checkbox'][data-loja]").forEach(cb => {
        if (cb.checked) lojas.push(cb.getAttribute("data-loja"));
      });
    }

    // Valida√ß√µes
    if (!email) { setStatus("N√£o foi poss√≠vel identificar seu e-mail."); return; }
    if (!time) { setStatus("Selecione um time."); return; }

    if (time !== "__ALL__" && !lojas.length) {
      setStatus("Selecione ao menos 1 loja.");
      return;
    }

    if (windowDays < 1 || windowDays > 365) {
      setStatus("Janela de an√°lise deve estar entre 1 e 365 dias.");
      return;
    }

    if (sendAt && !/^\d{2}:\d{2}$/.test(sendAt)) {
      setStatus("Hor√°rio inv√°lido. Use HH:mm (ex.: 08:30).");
      return;
    }

    const editingId = window.__myAl_editingAlertId ? String(window.__myAl_editingAlertId) : "";

    // Overlay
    if (window.vektorMyAlertsShowLoading_) {
      window.vektorMyAlertsShowLoading_(
        editingId ? "Salvando edi√ß√£o..." : "Criando alerta...",
        "Aguarde."
      );
    }

    // Payload
    const payload = {
      email: email,
      role: role,

      // ‚úÖ novo
      alertType: alertType,

      freq: freq,
      windowDays: windowDays,
      time: time,
      sendAt: sendAt,
      lojas: lojas,

      // ‚úÖ transa√ß√µes usam etiquetas; pend√™ncias sempre vazio
      etiquetas: etiquetasFinalEff,
      etiqueta: (etiquetasFinalEff[0] || "")
    };

    // ‚úÖ handlers ligados √† chamada real
    const runner = google.script.run
      .withSuccessHandler(function (res) {
        if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();

        if (!res || !res.ok) {
          const msg = "Falha: " + (res && res.error ? res.error : "erro desconhecido");
          setStatus(msg);
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
          return;
        }

        if (editingId) {
          setStatus("Alerta atualizado com sucesso. ID mantido: " + editingId);
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Alerta atualizado com sucesso!", "success");
          window.__myAl_editingAlertId = "";
          const btn = document.getElementById("myAl_saveBtn");
          if (btn) btn.textContent = "Criar alerta";
          const cancelBtn = document.getElementById("myAl_cancelEditBtn");
          if (cancelBtn) cancelBtn.style.display = "none";
        } else {
          setStatus("Alerta criado com sucesso. ID: " + (res.alertId || "‚Äî"));
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Alerta criado com sucesso!", "success");
        }

        window.vektorMyAlertsRefresh();
      })
      .withFailureHandler(function (err) {
        if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();
        const msg = "Erro: " + (err && err.message ? err.message : err);
        setStatus(msg);
        if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
      });

    // chamada REAL
    if (editingId) {
      payload.alertId = editingId;
      runner.atualizarAlertaEtiquetaVektor(payload);
    } else {
      runner.criarAlertaEtiquetaVektor(payload);
    }

  } catch (e) {
    if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();
    setStatus("Erro inesperado ao salvar alerta.");
    if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Erro inesperado ao salvar alerta.", "error");
  }
};

window.vektorMyAlertsShowLoading_ = function(title, sub){
  const ov = document.getElementById("myAl_overlay");
  const t  = document.getElementById("myAl_overlayTitle");
  const s  = document.getElementById("myAl_overlaySub");
  if (t) t.textContent = String(title || "Carregando‚Ä¶");
  if (s) s.textContent = String(sub || "Aguarde um instante.");
  if (ov) ov.style.display = "block";
};

window.vektorMyAlertsHideLoading_ = function(){
  const ov = document.getElementById("myAl_overlay");
  if (ov) ov.style.display = "none";
};

window.vektorMyAlertsToast_ = function(msg, kind){
  const box = document.getElementById("myAl_toast");
  const el  = document.getElementById("myAl_toastMsg");
  if (el) el.textContent = String(msg || "");

  if (box) {
    // ‚úÖ centraliza no meio da tela do myAlertsView
    box.style.left = "50%";
    box.style.top = "50%";
    box.style.right = "auto";
    box.style.bottom = "auto";
    box.style.transform = "translate(-50%, -50%)";
    box.style.minWidth = "320px";
    box.style.textAlign = "center";

    box.style.borderColor = (kind === "error") ? "rgba(248,113,113,0.55)" : "rgba(34,197,94,0.45)";
    box.style.display = "block";
    setTimeout(()=>{ box.style.display = "none"; }, 2600);
  }
};

window.vektorMyAlertsDelete = function(alertId) {
  if (!alertId) return;

  const ok = confirm("Deseja excluir este alerta? Essa a√ß√£o n√£o poder√° ser desfeita.");
  if (!ok) return;

  const email = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
  const role  = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "").trim() : "");

  window.vektorMyAlertsShowLoading_("Excluindo alerta...");

  google.script.run
    .withSuccessHandler(function(res){
      window.vektorMyAlertsHideLoading_();
      if (!res || !res.ok) {
        window.vektorMyAlertsToast_("Falha ao excluir: " + (res && res.error ? res.error : "erro desconhecido"), "error");
        return;
      }
      window.vektorMyAlertsToast_("Alerta exclu√≠do com sucesso.", "success");
      window.vektorMyAlertsRefresh();
    })
    .withFailureHandler(function(err){
      window.vektorMyAlertsHideLoading_();
      window.vektorMyAlertsToast_("Erro ao excluir: " + (err && err.message ? err.message : err), "error");
    })
    .excluirAlertaVektor({ alertId: alertId, email: email, role: role });
};

window.vektorMyAlertsCancelEdit_ = function () {
  try {
    window.__myAl_editingAlertId = "";

    const btn = document.getElementById("myAl_saveBtn");
    if (btn) btn.textContent = "Criar alerta";

    const cancelBtn = document.getElementById("myAl_cancelEditBtn");
    if (cancelBtn) cancelBtn.style.display = "none";

    const st = document.getElementById("myAl_createStatus");
    if (st) st.textContent = "Edi√ß√£o cancelada.";
  } catch (_) {}
};

window.vektorMyAlertsStartEdit_ = function (a) {
  if (!a || !a.alertId) return;

  window.__myAl_editingAlertId = String(a.alertId);

  // muda texto do bot√£o
  const btn = document.getElementById("myAl_saveBtn");
  if (btn) btn.textContent = "Salvar edi√ß√£o";

  // ‚úÖ mostra bot√£o "Cancelar edi√ß√£o"
  const cancelBtn = document.getElementById("myAl_cancelEditBtn");
  if (cancelBtn) cancelBtn.style.display = "inline-flex";

  // status
  const st = document.getElementById("myAl_createStatus");
  if (st) st.textContent = "Editando alerta " + a.alertId + " (n√£o ser√° gerado novo ID).";

  // ‚úÖ tipo de alerta + UI (subt√≠tulo/hint/etiquetas)
  const typeSel = document.getElementById("myAl_alertType");
  const labelWrap = document.getElementById("myAl_labelWrap");
  const subtitle = document.getElementById("myAl_subtitle");
  const hint = document.getElementById("myAl_createHint");

  const t = String(a.alertType || "TRANSACOES").trim();
  if (typeSel) typeSel.value = t;

  if (t === "PENDENCIAS") {
    if (labelWrap) labelWrap.style.display = "none";
    if (subtitle) subtitle.textContent = "Alertas de Pend√™ncias por Lojas e Times (com hist√≥rico e execu√ß√£o programada), disparado sempre em dias √∫teis.";
    if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Valor, Estabelecimento, Titular, Pend√™ncias).";
  } else {
    if (labelWrap) labelWrap.style.display = "block";
    if (subtitle) subtitle.textContent = "Alertas de Transa√ß√µes por Lojas, Times e Tags (com hist√≥rico e execu√ß√£o programada), disparado sempre em dias √∫teis.";
    if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Estabelecimento, Valor, Etiqueta, Descri√ß√£o).";
  }

  // freq
  const freqEl = document.getElementById("myAl_freq");
  if (freqEl && a.freq) freqEl.value = a.freq;

  // janela
  const winEl = document.getElementById("myAl_windowDays");
  if (winEl) winEl.value = String(a.windowDays || 30);

  // hora
  const sendAtEl = document.getElementById("myAl_sendAt");
  if (sendAtEl) sendAtEl.value = String(a.sendAt || "").trim();

  // time (isso re-renderiza lojas)
  const teamSel = document.getElementById("myAl_team");
  if (teamSel) {
    teamSel.value = String(a.time || "").trim();
    if (typeof teamSel.onchange === "function") teamSel.onchange();
  }

  // etiquetas (multi) ‚Äî ‚úÖ s√≥ para Transa√ß√µes
  if (t !== "PENDENCIAS") {
    const labelEl = document.getElementById("myAl_label");
    if (labelEl && labelEl.tagName === "SELECT") {
      const raw = String(a.etiqueta || "").trim(); // "A | B | C" ou ""
      const tags = raw
        ? raw.split("|").map(s => String(s || "").trim()).filter(Boolean)
        : [];

      // limpa sele√ß√£o
      Array.from(labelEl.options || []).forEach(op => { op.selected = false; });

      if (!tags.length) {
        // ‚Äútodas‚Äù
        Array.from(labelEl.options || []).forEach(op => { op.selected = true; });
      } else {
        const set = {};
        tags.forEach(tg => { set[tg] = true; });
        Array.from(labelEl.options || []).forEach(op => {
          if (set[String(op.value || "").trim()]) op.selected = true;
        });
      }
    }
  }

  // lojas: precisa do DOM j√° renderizado
  const lojasCsv = String(a.lojasCsv || "");
  const lojas = lojasCsv ? lojasCsv.split(",").map(s => s.trim()).filter(Boolean) : [];

  if (String(a.time || "").trim() !== "__ALL__") {
    const box = document.getElementById("myAl_storesBox");
    if (box) {
      // marca checkboxes ap√≥s render
      box.querySelectorAll("input[type='checkbox'][data-loja]").forEach(cb => {
        const l = cb.getAttribute("data-loja");
        cb.checked = (lojas.indexOf(l) >= 0);
      });
    }
  }

  // opcional: levar o usu√°rio para o topo do formul√°rio
  try { document.getElementById("myAlertsView")?.scrollTo?.(0, 0); } catch (_) {}
};

window.vektorMyAlertsRefresh = function () {
  const list = document.getElementById("myAl_list");
  if (list) {
    list.innerHTML = "<div style='color:rgba(226,232,240,0.85); font-size:12px;'>Carregando‚Ä¶</div>";
  }

  const email = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
  const role  = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "").trim() : "");

  // filtros admin
  const adminEmailEl = document.getElementById("myAl_adminEmail");
  const adminRoleEl  = document.getElementById("myAl_adminRole");

  const adminFilterEmail = (role === "Administrador" && adminEmailEl) ? String(adminEmailEl.value || "").trim() : "";
  const adminFilterRole  = (role === "Administrador" && adminRoleEl)  ? String(adminRoleEl.value  || "").trim() : "";

  if (typeof google === "undefined" || !google.script || !google.script.run) {
    if (list) list.innerHTML = "<div style='color:rgba(248,113,113,0.95); font-weight:800; font-size:12px;'>google.script.run indispon√≠vel.</div>";
    return;
  }

  google.script.run
    .withSuccessHandler(function (res) {
      if (!list) return;

      if (!res || !res.ok) {
        const msg = (res && res.error) ? String(res.error) : "Falha ao carregar alertas.";
        list.innerHTML = "<div style='color:rgba(248,113,113,0.95); font-weight:800; font-size:12px;'>" + msg + "</div>";
        return;
      }

      const rows = Array.isArray(res.alertas) ? res.alertas : [];
      if (!rows.length) {
        list.innerHTML = "<div style='color:rgba(226,232,240,0.85); font-size:12px;'>Nenhum alerta cadastrado.</div>";
        return;
      }

      list.innerHTML = "";

      rows.forEach(a => {
        const card = document.createElement("div");
        card.style.border = "1px solid rgba(148,163,184,0.18)";
        card.style.background = "rgba(255,255,255,0.03)";
        card.style.borderRadius = "12px";
        card.style.padding = "10px";
        card.style.color = "rgba(226,232,240,0.92)";
        card.style.fontSize = "12px";

        const timeLabel =
          (String(a.time || "").trim() === "__ALL__") ? "Todos" : (a.time || "‚Äî");

        const lojasLabel =
          (String(a.time || "").trim() === "__ALL__") ? "Todos" : String(a.lojasCount || 0);

        const etiquetaLabel =
          (a.etiquetaLabel != null && String(a.etiquetaLabel).trim() !== "")
            ? String(a.etiquetaLabel)
            : ((a.etiqueta && String(a.etiqueta).trim()) ? String(a.etiqueta).trim() : "Todas");

            const horaLabel = (a.sendAt && String(a.sendAt).trim())
          ? String(a.sendAt).trim()
          : "Imediato";

            const t = String(a.alertType || "TRANSACOES").trim();
            const tipoLbl = (a.alertTypeLabel || (t === "PENDENCIAS" ? "Pend√™ncias" : "Transa√ß√µes"));

            const head =
              "<div style='display:flex; justify-content:space-between; gap:10px; align-items:flex-start;'>" +
                "<div>" +
                  "<div style='font-weight:900; color:#fff; font-size:13px;'>" +
                    "ID: " + (a.alertId || "‚Äî") +
                    " &nbsp; <span style='opacity:0.85; font-weight:900;'>TIPO ALERTA:</span> " + tipoLbl +
                  "</div>" +
                  "<div style='opacity:0.85; margin-top:2px;'>" +
                    (t === "PENDENCIAS" ? "" : ("<b>Etiqueta:</b> " + etiquetaLabel + " &nbsp; ")) +
                    "<b>Time:</b> " + timeLabel +
                    " &nbsp; <b>Lojas:</b> " + lojasLabel +
                    " &nbsp; <b>Freq:</b> " + (a.freqLabel || a.freq || "‚Äî") +
                  "</div>" +

            "<div style='opacity:0.75; margin-top:2px;'>" +
              "<b>Dono:</b> " + (a.ownerEmail || "‚Äî") +
              " &nbsp; <b>Hora:</b> " + horaLabel +
              " &nbsp; <b>√öltima execu√ß√£o:</b> " + (a.lastRunAt || "‚Äî") +
            "</div>" +
            "</div>" +

            "<div style='display:flex; gap:8px; align-items:flex-start;'>" +

            // Executar (fica sozinho)
            "<button type='button' data-id='" + a.alertId + "' class='myAl_runBtn' " +
              "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:#16a34a; color:#04110a; font-weight:900; font-size:12px;'>" +
              "Executar</button>" +

            // Coluna da direita
            "<div style='display:flex; flex-direction:column; gap:6px;'>" +

              "<button type='button' data-id='" + a.alertId + "' class='myAl_toggleBtn' " +
                "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;'>" +
                (a.isActive ? "Desativar" : "Ativar") +
              "</button>" +

              // ‚úÖ Novo bot√£o Editar (abaixo do Desativar)
              "<button type='button' data-id='" + a.alertId + "' class='myAl_editBtn' " +
                "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(59,130,246,0.22); color:#fff; font-weight:900; font-size:12px;'>" +
                "Editar</button>" +

              "<button type='button' data-id='" + a.alertId + "' class='myAl_delBtn' " +
                "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(239,68,68,0.22); color:#fff; font-weight:900; font-size:12px;'>Excluir</button>" +

            "</div>" +
          "</div>"

        card.innerHTML = head;
        list.appendChild(card);
      });

      // bind bot√µes (n√£o deixe erro aqui derrubar o painel)
      list.querySelectorAll(".myAl_runBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          if (window.vektorMyAlertsShowLoading_) window.vektorMyAlertsShowLoading_("Executando alerta...", "Aguarde.");

          google.script.run
            .withSuccessHandler(function (r2) {
              if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();

              if (r2 && r2.ok) {
                const html = window.vektorRenderTabelaTransacoesEtiquetaAlert_(r2);
                if (html) renderBotMessage("HTML:" + html);
                if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Sucesso na execu√ß√£o!", "success");
                window.vektorMyAlertsRefresh();
              } else {
                const msg = "Falha na execu√ß√£o: " + (r2 && r2.error ? r2.error : "erro desconhecido");
                if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
              }
            })
            .withFailureHandler(function (err) {
              if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();
              const msg = "Erro na execu√ß√£o: " + (err && err.message ? err.message : err);
              if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
            })
            .executarAlertaEtiquetaVektor({ alertId: alertId, preview: true });
        };
      });

      list.querySelectorAll(".myAl_toggleBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          google.script.run
            .withSuccessHandler(function () { window.vektorMyAlertsRefresh(); })
            .withFailureHandler(function (err) {
              const msg = "Falha ao alterar status: " + (err && err.message ? err.message : err);
              if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
            })
            .toggleAlertaEtiquetaVektor({ alertId: alertId });
        };
      });

            list.querySelectorAll(".myAl_editBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          // acha o objeto do alerta pelo id dentro de "rows"
          const a = rows.find(x => String(x.alertId) === String(alertId));
          if (!a) {
            if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("N√£o foi poss√≠vel localizar os dados do alerta para editar.", "error");
            return;
          }

          window.vektorMyAlertsStartEdit_(a);
        };
      });

      list.querySelectorAll(".myAl_delBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          if (!confirm("Deseja excluir este alerta? Essa a√ß√£o n√£o pode ser desfeita.")) return;

          google.script.run
            .withSuccessHandler(function () { window.vektorMyAlertsRefresh(); })
            .withFailureHandler(function (err) {
              const msg = "Falha ao excluir: " + (err && err.message ? err.message : err);
              if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
            })
            .excluirAlertaVektor({ alertId: alertId }); // ‚úÖ nome correto
        };
      });
    })
    .withFailureHandler(function (err) {
      if (!list) return;
      const msg = "Falha ao carregar alertas: " + (err && err.message ? err.message : err);
      list.innerHTML = "<div style='color:rgba(248,113,113,0.95); font-weight:800; font-size:12px;'>" + msg + "</div>";
    })
    .listarAlertasUsuarioVektor({
      email: email,
      role: role,
      adminFilterEmail: adminFilterEmail,
      adminFilterRole: adminFilterRole
    });
};

// ================================
// VIEW: Valores Contabilizados
// ================================
window.__myAl_valores_last = { ok:false, rows:[], categorias:[], total:0 };


function openMyAlValoresContabilizadosView() {
  // 1) header texts
  const title = document.getElementById("myAl_title");
  const sub   = document.getElementById("myAl_subtitle");
  if (title) title.textContent = "Valores Contabilizados";
  if (sub)   sub.textContent   = "Consolida√ß√£o hist√≥rica de valores por etiqueta (BaseClara) + funil por categoria.";

    // 2) header: trocar bot√µes (canto direito) para o modo "Valores"
  const btns = document.getElementById("myAl_headerBtns");
  const type = document.getElementById("myAl_typeWrap");

  // guarda o HTML original (uma vez) para poder voltar depois
  if (btns && !window.__myAl_headerBtns_defaultHTML) {
    window.__myAl_headerBtns_defaultHTML = btns.innerHTML;
  }

  // mostra headerBtns e injeta os 3 bot√µes aqui (em vez de ficar dentro da view)
  if (btns) {
    btns.style.display = "flex";
    btns.innerHTML = `
      <button type="button"
        onclick="openMyAlDefinicaoAlertasView()"
        style="height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(148,163,184,0.22);background:rgba(255,255,255,0.06);color:#fff;font-weight:900;font-size:12px;display:inline-flex;align-items:center;gap:8px;">
        ‚Üê Defini√ß√£o de Alertas
      </button>

      <button type="button"
        onclick="myAlValoresLoadData_()"
        style="height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(148,163,184,0.22);background:rgba(255,255,255,0.06);color:#fff;font-weight:900;font-size:12px;display:inline-flex;align-items:center;gap:8px;">
        Aplicar
      </button>

      <button type="button"
        onclick="myAlValoresDownloadCsv()"
        style="height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.25);background:#B5FF20;color:#000;font-weight:900;font-size:12px;display:inline-flex;align-items:center;gap:8px;">
        ‚¨á Download
      </button>
    `;
  }

  // some com o seletor "Tipo de alerta" nesse modo
  if (type) type.style.display = "none";

  // 3) swap body
  const defV = document.getElementById("myAl_defView");
  const valV = document.getElementById("myAl_valoresView");

  if (defV) defV.style.display = "none";
  if (valV) valV.style.display = "block";

  // 4) init filters + load
  myAlValoresInitOnce_();
}

function myAlValoresLoadData_() {
  try {
    myAlValLoading_(true);

    const time = document.getElementById("myAl_val_time")?.value || "__ALL__";
    const loja = document.getElementById("myAl_val_loja")?.value || "__ALL__";
    const dtIni = document.getElementById("myAl_val_dtIni")?.value || "";
    const dtFim = document.getElementById("myAl_val_dtFim")?.value || "";

    google.script.run
      .withSuccessHandler(function(resp) {
        try {
          // normaliza resposta
          const res = (resp && typeof resp === "object") ? resp : { ok:false, rows:[], categorias:[], total:0 };

          // guarda cache global (se voc√™ estiver usando)
          window.__myAl_valores_last = res;

          // ‚úÖ renderiza tabela + funil
          if (typeof myAlValoresRenderTable_ === "function") myAlValoresRenderTable_(res);
          if (typeof myAlValoresRenderFunil_ === "function") myAlValoresRenderFunil_(res);

        } finally {
          myAlValLoading_(false);
        }
      })
      .withFailureHandler(function(err) {
        myAlValLoading_(false);
        alert("Erro ao carregar Valores Contabilizados: " + (err && err.message ? err.message : err));
      })
      .getValoresContabilizadosEtiquetas({ time: time, loja: loja, dataInicioIso: dtIni, dataFimIso: dtFim })

  } catch (e) {
    myAlValLoading_(false);
    alert("Erro inesperado: " + (e && e.message ? e.message : e));
  }
}

function myAlValLoading_(on) {
  const el = document.getElementById("myAl_valLoading");
  if (el) el.style.display = on ? "block" : "none";
}

function openMyAlDefinicaoAlertasView() {
  const title = document.getElementById("myAl_title");
  const sub   = document.getElementById("myAl_subtitle");
  if (title) title.textContent = "Defini√ß√£o de Alertas";
  if (sub)   sub.textContent   = "Alertas de Transa√ß√µes por Lojas, Times e Tags (com hist√≥rico e execu√ß√£o programada), disparado sempre em dias √∫teis.";

  const btns = document.getElementById("myAl_headerBtns");
  const type = document.getElementById("myAl_typeWrap");
  if (btns) btns.style.display = "flex";
  if (type) type.style.display = "flex";

    // restaura os bot√µes originais do header (Valores Contabilizados + Tutorial)
  if (btns && window.__myAl_headerBtns_defaultHTML) {
    btns.innerHTML = window.__myAl_headerBtns_defaultHTML;
  }

  const defV = document.getElementById("myAl_defView");
  const valV = document.getElementById("myAl_valoresView");
  if (valV) valV.style.display = "none";
  if (defV) defV.style.display = "block";
}

let __myAl_valores_inited = false;

function myAlValoresInitOnce_(){
  if (__myAl_valores_inited) return;
  __myAl_valores_inited = true;

  const selTime = document.getElementById("myAl_val_time");
  const selLoja = document.getElementById("myAl_val_loja");
  const dtIniEl = document.getElementById("myAl_val_dtIni");
  const dtFimEl = document.getElementById("myAl_val_dtFim");

  // =========================
  // helpers UI
  // =========================
  function setSelectLoading_(sel, label){
    if (!sel) return;
    sel.innerHTML = `<option value="__ALL__">${label}</option>`;
  }

  // ‚úÖ N√ÉO MEXE no innerHTML do myAl_funilWrap (n√£o destr√≥i o canvas)
  function renderNeedPeriod_(){
    const tbody = document.getElementById("myAl_valoresTbody");
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
        Defina <b>Per√≠odo (In√≠cio)</b> e <b>Per√≠odo (Fim)</b> para carregar.
      </td></tr>`;
    }

    const hint = document.getElementById("myAl_catHint");
    if (hint) {
      hint.innerHTML = `<span style="color:rgba(226,232,240,0.75);">
        Defina o per√≠odo para exibir o gr√°fico.
      </span>`;
    }

    const canvas = document.getElementById("myAl_catChart");
    if (canvas) {
      canvas.style.display = "none";
      try {
        const ctx0 = canvas.getContext("2d");
        ctx0 && ctx0.clearRect(0,0,canvas.width,canvas.height);
      } catch(_) {}
    }

    // mata inst√¢ncia anterior do chart pra parar qualquer "vida pr√≥pria"
    try {
      if (window.__myAl_catChartInst) {
        window.__myAl_catChartInst.destroy();
        window.__myAl_catChartInst = null;
      }
    } catch(_) {}

    const meta = document.getElementById("myAl_valoresMeta");
    if (meta) meta.textContent = "";
  }

  function canLoad_(){
    const a = dtIniEl ? String(dtIniEl.value || "").trim() : "";
    const b = dtFimEl ? String(dtFimEl.value || "").trim() : "";
    return !!(a && b);
  }

  function tryLoad_(){
    if (!canLoad_()) {
      renderNeedPeriod_();
      return;
    }
    // debounce simples
    if (window.__myAl_valores_tryload_tmr) clearTimeout(window.__myAl_valores_tryload_tmr);
    window.__myAl_valores_tryload_tmr = setTimeout(function(){
      myAlValoresLoad_();
    }, 150);
  }

  // =========================
  // Map (Time -> Lojas)
  // =========================
  let map = (window.__myAl_lojasPorTime && typeof window.__myAl_lojasPorTime === "object")
    ? window.__myAl_lojasPorTime
    : {};

  function normLojas_(arr){
    return (arr || []).map(it => {
      if (typeof it === "string") return { lojaKey: it, lojaNome: it };
      return {
        lojaKey: (it && (it.lojaKey || it.key || it.codigo || "")) || "",
        lojaNome: (it && (it.lojaNome || it.nome || it.label || it.lojaKey || "")) || ""
      };
    });
  }

  function fillTimes_(){
    if (!selTime) return;
    const times = Object.keys(map).sort((a,b)=>String(a).localeCompare(String(b), "pt-BR"));
    selTime.innerHTML =
      `<option value="__ALL__">Todos</option>` +
      times.map(t => `<option value="${escAttr_(t)}">${escHtml_(t)}</option>`).join("");
  }

  function fillLojas_(){
    if (!selLoja) return;

    const t = selTime ? (selTime.value || "__ALL__") : "__ALL__";
    let lojas = [];

    if (t === "__ALL__"){
      Object.keys(map).forEach(k => (map[k] || []).forEach(x => lojas.push(x)));
    } else {
      lojas = Array.isArray(map[t]) ? map[t] : [];
    }

    lojas = normLojas_(lojas);
    lojas.sort((a,b)=>String(a.lojaNome||"").localeCompare(String(b.lojaNome||""), "pt-BR"));

    selLoja.innerHTML =
      `<option value="__ALL__">Todas</option>` +
      lojas.map(x => `<option value="${escAttr_(x.lojaKey || "")}">${escHtml_(x.lojaNome || x.lojaKey || "")}</option>`).join("");
  }

  // =========================
  // ‚úÖ Se map vazio, carrega DIRETO do backend (mesma fonte da tela principal)
  // getTimesELojasParaAlertasVektor() existe no Code.gs
  // =========================
  if (!map || Object.keys(map).length === 0) {
    setSelectLoading_(selTime, "Carregando times‚Ä¶");
    setSelectLoading_(selLoja, "Carregando lojas‚Ä¶");

    if (typeof google !== "undefined" && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) {
            setSelectLoading_(selTime, "Sem times (falha ao carregar)");
            setSelectLoading_(selLoja, "Sem lojas (falha ao carregar)");
            renderNeedPeriod_();
            return;
          }

          // backend retorna { times, lojasPorTime }, onde lojasPorTime pode ser array de strings
          const lp = res.lojasPorTime || {};
          const fixed = {};

          Object.keys(lp).forEach(function(t){
            fixed[t] = (lp[t] || []).map(function(l){
              // mant√©m compat com o resto do front
              return { lojaKey: String(l||""), lojaNome: String(l||"") };
            });
          });

          window.__myAl_lojasPorTime = fixed;
          map = fixed;

          fillTimes_();
          fillLojas_();

          // n√£o carrega automaticamente sem per√≠odo; mas se j√° estiver preenchido, carrega.
          tryLoad_();
        })
        .withFailureHandler(function(err){
          setSelectLoading_(selTime, "Sem times (erro)");
          setSelectLoading_(selLoja, "Sem lojas (erro)");
          renderNeedPeriod_();
        })
        .getTimesELojasParaAlertasVektor();
    } else {
      setSelectLoading_(selTime, "Sem times (google.script.run indispon√≠vel)");
      setSelectLoading_(selLoja, "Sem lojas (google.script.run indispon√≠vel)");
      renderNeedPeriod_();
    }
  } else {
    fillTimes_();
    fillLojas_();
  }

  // =========================
  // binds
  // =========================
  selTime && selTime.addEventListener("change", function(){
    fillLojas_();
    tryLoad_();
  });

  selLoja && selLoja.addEventListener("change", function(){
    tryLoad_();
  });

  dtIniEl && dtIniEl.addEventListener("change", function(){
    tryLoad_();
  });

  dtFimEl && dtFimEl.addEventListener("change", function(){
    tryLoad_();
  });

  // ‚úÖ IMPORTANTE: n√£o carregar ao abrir
  renderNeedPeriod_();
}

function myAlValoresOnPeriodChange_(){
  // ids: ajuste para os ids reais dos seus inputs
  const iniEl = document.getElementById("myAl_val_dtIni");
  const fimEl = document.getElementById("myAl_val_dtFim");
  if (!iniEl || !fimEl) return;

  const dtIni = String(iniEl.value || "").trim();
  const dtFim = String(fimEl.value || "").trim();

  // S√≥ carrega quando os DOIS estiverem preenchidos
  if (!dtIni || !dtFim) return;

  // (Opcional) evita disparar v√°rias vezes seguidas
  if (window.__myAl_valores_period_tmr) clearTimeout(window.__myAl_valores_period_tmr);
  window.__myAl_valores_period_tmr = setTimeout(function(){
    myAlValoresLoad_();
  }, 200);
}

function myAlValoresClearFilters() {
  const selTime = document.getElementById("myAl_val_time");
  const selLoja = document.getElementById("myAl_val_loja");
  const dtIni   = document.getElementById("myAl_val_dtIni");
  const dtFim   = document.getElementById("myAl_val_dtFim");

  // volta para "Todos/Todas" (se voc√™ usar "__ALL__" nos options)
  if (selTime) selTime.value = "__ALL__";
  if (selLoja) selLoja.value = "__ALL__";

  // limpa per√≠odo
  if (dtIni) dtIni.value = "";
  if (dtFim) dtFim.value = "";

  // limpa filtro de categoria do gr√°fico/tabela
  window.__myAl_valores_filterCategoria = "";

  // ‚ùå n√£o chama load ao limpar: s√≥ mostra placeholder
  const tbody = document.getElementById("myAl_valoresTbody");
  if (tbody) {
    tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
      Defina <b>Per√≠odo (In√≠cio)</b> e <b>Per√≠odo (Fim)</b> para carregar.
    </td></tr>`;
  }

  const hint = document.getElementById("myAl_catHint");
  if (hint) hint.innerHTML = `Defina o per√≠odo para exibir o gr√°fico.`;

  const canvas = document.getElementById("myAl_catChart");
  if (canvas) canvas.style.display = "none";

  try {
    if (window.__myAl_catChartInst) {
      window.__myAl_catChartInst.destroy();
      window.__myAl_catChartInst = null;
    }
  } catch (_) {}

  const meta = document.getElementById("myAl_valoresMeta");
  if (meta) meta.textContent = "";
}

function myAlValoresLoad_() {
  const time = document.getElementById("myAl_val_time")?.value || "";
  const loja = document.getElementById("myAl_val_loja")?.value || "";
  const dtIni = document.getElementById("myAl_val_dtIni")?.value || "";
  const dtFim = document.getElementById("myAl_val_dtFim")?.value || "";

    // ‚úÖ n√£o chama backend sem per√≠odo completo
  if (!String(dtIni || "").trim() || !String(dtFim || "").trim()) {
    myAlValLoading_(false);
    // reaproveita o placeholder ‚Äúdefina per√≠odo‚Äù
    if (typeof myAlValoresInitOnce_ === "function") {
      // chama s√≥ para renderNeedPeriod_ (j√° existe dentro do init),
      // mas se quiser mais direto, mantenha o placeholder da tabela/hint aqui.
    }
    const tbody = document.getElementById("myAl_valoresTbody");
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
        Defina <b>Per√≠odo (In√≠cio)</b> e <b>Per√≠odo (Fim)</b> para carregar.
      </td></tr>`;
    }
    const hint = document.getElementById("myAl_catHint");
    if (hint) hint.innerHTML = `Defina o per√≠odo para exibir o gr√°fico.`;
    const canvas = document.getElementById("myAl_catChart");
    if (canvas) canvas.style.display = "none";
    return;
  }

  // (opcional) mostrar overlay do pr√≥prio MyAlerts se existir
  try { window.vektorMyAlertsShowLoading_ && window.vektorMyAlertsShowLoading_("Carregando valores contabilizados..."); } catch(_) {}

  google.script.run
    .withSuccessHandler(function(res){
      try { window.vektorMyAlertsHideLoading_ && window.vektorMyAlertsHideLoading_(); } catch(_) {}

      if (!res || !res.ok) {
        const tb = document.getElementById("myAl_valoresTbody");
        if (tb) tb.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">Falha ao carregar: ${escHtml_(res && res.error ? res.error : "erro desconhecido")}</td></tr>`;
        return;
      }

      window.__myAl_valores_last = res;

      myAlValoresRenderTable_(res);
      myAlValoresRenderCategoriasBar_(res);

    })
    .withFailureHandler(function(err){
      try { window.vektorMyAlertsHideLoading_ && window.vektorMyAlertsHideLoading_(); } catch(_) {}

      const tb = document.getElementById("myAl_valoresTbody");
      if (tb) tb.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">Erro: ${escHtml_(err && err.message ? err.message : String(err))}</td></tr>`;
    })
    .getValoresContabilizadosEtiquetas({
      time: String(time || ""),
      loja: String(loja || ""),
      dataInicioIso: dtIni ? (dtIni + "T00:00:00") : "",
      dataFimIso:    dtFim ? (dtFim + "T23:59:59") : ""
    });
}

function myAlValoresRenderTable_(res) {
  const tbody = document.getElementById("myAl_valoresTbody");
  const meta  = document.getElementById("myAl_valoresMeta");
  if (!tbody) return;

  const rows = Array.isArray(res.rows) ? res.rows : [];
  const total = Number(res.total || 0) || 0;

  if (meta) meta.textContent = `Total: ${fmtBRL_(total)} | Linhas: ${rows.length}`;

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px; color:#000; background:#fff;">Sem dados para os filtros.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const etiqueta  = r.etiqueta || "";
    const conta     = r.conta || "";
    const categoria = r.categoria || ""; // <- vem do backend (vou ajustar no Code.gs)
    return `
      <tr data-conta="${escAttr_(conta)}" data-etiqueta="${escAttr_(etiqueta)}" data-categoria="${escAttr_(categoria)}"
          style="background:#fff; color:#000;">
        <td style="border:1px solid #000; padding:8px; text-align:left; color:#000; background:#fff;">${escHtml_(etiqueta)}</td>
        <td style="border:1px solid #000; padding:8px; text-align:left; color:#000; background:#fff;">${escHtml_(conta)}</td>
        <td style="border:1px solid #000; padding:8px; text-align:right; color:#000; background:#fff;">${fmtBRL_(r.valor || 0)}</td>
        <td style="border:1px solid #000; padding:8px; text-align:right; color:#000; background:#fff;">${fmtPct_(r.pct || 0)}</td>
      </tr>
    `;
  }).join("");

  // aplica filtro de categoria se j√° houver
  myAlValoresApplyCategoriaFilter_();
}

// aplica filtro local na tabela (n√£o chama backend)
function myAlValoresApplyCategoriaFilter_(){
  const cat = (window.__myAl_valores_filterCategoria || "").trim();
  const tbody = document.getElementById("myAl_valoresTbody");
  if (!tbody) return;

  Array.from(tbody.querySelectorAll("tr[data-categoria]")).forEach(tr=>{
    const c = (tr.getAttribute("data-categoria") || "").trim();
    tr.style.display = (!cat || c === cat) ? "" : "none";
  });
}

let __myAl_catChartInst = null;

function myAlValoresRenderCategoriasBar_(res){
  const canvas = document.getElementById("myAl_catChart");
  const hint   = document.getElementById("myAl_catHint");
  if (!canvas) return;

  canvas.style.display = "block";

  const cats  = Array.isArray(res && res.categorias) ? res.categorias : [];
  const total = Number((res && res.total) || 0) || 0;

  // limpa chart anterior
  try {
    if (__myAl_catChartInst) {
      __myAl_catChartInst.destroy();
      __myAl_catChartInst = null;
    }
  } catch(_) {}

  if (!cats.length) {
    if (hint) hint.textContent = "Sem dados para o gr√°fico.";
    const ctx0 = canvas.getContext("2d");
    ctx0 && ctx0.clearRect(0,0,canvas.width,canvas.height);
    return;
  }

  const labels = cats.map(x => String(x.categoria || ""));
  const values = cats.map(x => Number(x.valor || 0) || 0);

  // hint de filtro atual
  const sel = window.__myAl_valores_filterCategoria ? String(window.__myAl_valores_filterCategoria) : "";
  if (hint) {
    hint.innerHTML = sel
      ? `Filtro ativo: <b>${escHtml_(sel)}</b> (clique novamente na barra para limpar)`
      : `Clique em uma categoria para filtrar a tabela.`;
  }

  const ctx = canvas.getContext("2d");

  // Chart.js + DataLabels (igual voc√™ j√° faz em outros gr√°ficos)
  try {
    if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
      Chart.register(ChartDataLabels);
    }
  } catch (_) {}

  __myAl_catChartInst = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Valor",
        data: values,

        // ‚úÖ CORES PEDIDAS
        backgroundColor: "#005E27", // verde escuro
        borderColor: "#B5FF20",     // verde claro
        borderWidth: 2,

        maxBarThickness: 18,
        categoryPercentage: 0.75,
        barPercentage: 0.75
      }]
    },
    options: {
      // ‚úÖ barras horizontais (deitadas)
      indexAxis: "y",

      responsive: true,
      maintainAspectRatio: false,

      // ‚úÖ reduz ‚Äúresize thrash‚Äù em layouts com container problem√°tico
      resizeDelay: 150,

      // ‚úÖ mata anima√ß√µes/reflows ‚Äúfantasmas‚Äù
      animation: false,

      layout: {
        padding: { top: 12, right: 70, bottom: 6, left: 0 }
      },

      onClick: function(evt, elements){
        if (!elements || !elements.length) return;

        const idx = elements[0].index;
        const cat = labels[idx] || "";

        // toggle: se clicar na mesma, limpa
        const cur = window.__myAl_valores_filterCategoria ? String(window.__myAl_valores_filterCategoria) : "";
        window.__myAl_valores_filterCategoria = (cur === cat ? "" : cat);

        // aplica filtro na tabela + re-render hint
        myAlValoresApplyCategoriaFilter_();
        myAlValoresRenderCategoriasBar_(window.__myAl_valores_last || res);
      },

      plugins: {
        legend: { display: false },

        tooltip: {
          callbacks: {
            label: function(tctx){
              const v = Number(tctx.raw || 0) || 0;
              const pct = total > 0 ? (v / total) : 0;
              return `${fmtBRL_(v)} (${fmtPct_(pct)})`;
            }
          }
        },

        // ‚úÖ r√≥tulos (valor + %), brancos
        datalabels: {
          color: "#ffffff",
          anchor: "end",
          align: "right",
          offset: 6,
          clamp: true,
          clip: false,
          formatter: function(value){
            const v = Number(value || 0) || 0;
            const pct = total > 0 ? (v / total) : 0;
            const brl0 = new Intl.NumberFormat("pt-BR", {
              style: "currency",
              currency: "BRL",
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(v);

            return `${brl0}\n${fmtPct_(pct)}`;
          },
          font: { weight: "700", size: 11 }
        }
      },

      scales: {
        // ‚úÖ eixo X √© o valor (BRL) no gr√°fico horizontal
        x: {
          ticks: {
            color: "rgba(255,255,255,0.85)",
            callback: function(v){ return fmtBRL_(v); }
          },
          grid: { color: "rgba(148,163,184,0.18)" }
        },

        // ‚úÖ eixo Y s√£o as categorias (n√£o formatar como dinheiro)
        y: {
          ticks: {
            color: "rgba(255,255,255,0.85)",
            autoSkip: false
          },
          grid: { color: "rgba(148,163,184,0.12)" }
        }
      }
    }
  });
}

function myAlValoresDownloadCsv() {
  const res = window.__myAl_valores_last;
  if (!res || !res.ok) {
    try { window.vektorMyAlertsToast_ && window.vektorMyAlertsToast_("N√£o h√° dados para download.", "error"); } catch(_) {}
    return;
  }

  const rows = Array.isArray(res.rows) ? res.rows : [];
  const header = ["Etiquetas","Conta Cont√°bil","Valor","% Valor"];
  const lines = [header.join(";")];

  rows.forEach(r => {
    lines.push([
      String(r.etiqueta || ""),
      String(r.conta || ""),
      String(Number(r.valor||0) || 0).replace(".", ","),
      String((Number(r.pct||0)*100).toFixed(2)).replace(".", ",") + "%"
    ].map(csvEsc_).join(";"));
  });

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "Vektor_Valores_Contabilizados.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ===== helpers locais (n√£o conflitar com os seus) =====
function escHtml_(s){ return String(s==null?"":s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escAttr_(s){ return String(s==null?"":s).replace(/"/g,'&quot;'); }
function escSvg_(s){ return String(s==null?"":s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function fmtBRL_(n){ try { return (Number(n||0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); } catch(_) { return String(n||0); } }
function fmtPct_(p){ const v = Number(p||0); return (v*100).toFixed(1).replace(".",",") + "%"; }
function csvEsc_(s){ s = String(s==null?"":s); if (/[;\n"]/.test(s)) s = '"' + s.replace(/"/g,'""') + '"'; return s; }

let __myAl_barTimer = null;


// ‚úÖ 4 ‚Äî vektorShowResumoCicloView_ (corrigir: tamb√©m setar display="none" nas outras views)
window.vektorShowResumoCicloView_ = function () {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");
  const envView = document.getElementById("envioPendView");
  const cicloView = document.getElementById("cicloResumoView");

  // ‚úÖ fecha outras views (hidden + display none)
  if (chatView) { chatView.classList.add("hidden"); chatView.style.display = "none"; }
  if (radarView) { radarView.classList.add("hidden"); radarView.style.display = "none"; }
  if (feedbackView) { feedbackView.classList.add("hidden"); feedbackView.style.display = "none"; }
  if (myAlertsView) { myAlertsView.classList.add("hidden"); myAlertsView.style.display = "none"; }
  if (fluxView) { fluxView.classList.add("hidden"); fluxView.style.display = "none"; }
  if (envView) { envView.classList.add("hidden"); envView.style.display = "none"; }

  // ‚úÖ abre resumo do ciclo
  if (cicloView) {
    cicloView.classList.remove("hidden");
    cicloView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
};

function vektorResumoCicloNorm_(s){
  return String(s || "").trim().toLowerCase();
}

function vektorResumoCicloGetRows_(res){
  // 1) compat: se vier rows pronto, usa
  if (res && Array.isArray(res.rows) && res.rows.length) {
    return res.rows.map(r => ({
      loja: String(r.loja || ""),
      time: String(r.time || "N/D"),
      qtde: Number(r.qtde || 0),
      txCount: Number((r.txCount != null ? r.txCount : r.qtdeTransacoes) || 0),
      valor: Number(r.valor || 0)
    }));
  }

  // 2) BaseClara-only: agrega a partir de tx
  const tx = (res && Array.isArray(res.tx)) ? res.tx : [];
  const byLoja = {}; // loja -> agg

  tx.forEach(t => {
    const loja = String(t.loja || "");
    if (!loja) return;
    const time = String(t.time || "N/D");
    const valor = Number(t.valor || 0);
    const pend = Number((t.pendNF||0) + (t.pendEtiqueta||0) + (t.pendDesc||0));

    if (!byLoja[loja]) byLoja[loja] = { loja, time, qtde:0, txCount:0, valor:0 };
    byLoja[loja].qtde += pend;      // ‚ÄúQtde de pend√™ncias‚Äù = soma de pend√™ncias nas transa√ß√µes
    byLoja[loja].txCount += 1;      // n¬∫ de transa√ß√µes pendentes
    byLoja[loja].valor += valor;    // valor pendente somado
    // se time variar (n√£o deveria), mant√©m o √∫ltimo
    byLoja[loja].time = time;
  });

  return Object.keys(byLoja).map(k => byLoja[k]);
}

function vektorResumoCicloBuildOptions_(selectEl, values, allLabel){
  if (!selectEl) return;
  const vAtual = selectEl.value || "";
  selectEl.innerHTML = `<option value="">${allLabel}</option>` + values
    .map(v => `<option value="${String(v).replace(/"/g,'&quot;')}">${v}</option>`)
    .join("");
  // tenta manter sele√ß√£o se ainda existir
  if (vAtual && values.includes(vAtual)) selectEl.value = vAtual;
}

function vektorResumoCicloApply_(){
  const res = window.__cicloResumoData;
  if (!res || !res.ok) return;

  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");

  const time = (selTime && selTime.value) ? selTime.value : "";
  const loja = (selLoja && selLoja.value) ? selLoja.value : "";

  // recorte detalhado (BaseClara) para tabela + IA
  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const dtIni = dtIniEl && dtIniEl.value ? String(dtIniEl.value) : "";
  const dtFim = dtFimEl && dtFimEl.value ? String(dtFimEl.value) : "";

  let tx = (res && Array.isArray(res.tx)) ? res.tx.slice() : [];

  // compat: data pode vir como dataIso (backend) ou dataISO (front antigo)
  tx = tx.map(t => {
    const dataISO = t.dataISO || t.dataIso || "";
    return Object.assign({}, t, { dataISO });
  });

  // filtra por per√≠odo (se informado) ‚Äî ‚úÖ mais r√≠gido
  tx = tx.filter(t => {
    const d = String(t.dataISO || "");
    if ((dtIni || dtFim) && !d) return false; // se tem filtro e a tx n√£o tem data, descarta
    if (dtIni && d < dtIni) return false;
    if (dtFim && d > dtFim) return false;
    return true;
  });

  if (time) tx = tx.filter(t => String(t.time || "N/D") === String(time));
  if (loja) tx = tx.filter(t => String(t.loja || "") === String(loja));

  // fonte √∫nica do recorte atual (IA usa isso)
  window.__cicloResumoTxFiltered = tx;

  const allRows = vektorResumoCicloGetRows_(res);

  // op√ß√µes de TIME (sempre a partir do dataset total)
  const times = Array.from(new Set(allRows.map(r => r.time))).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  vektorResumoCicloBuildOptions_(selTime, times, "Todos");

  // op√ß√µes de LOJA dependem do time selecionado
  const rowsByTime = time ? allRows.filter(r => r.time === time) : allRows;
  const lojas = Array.from(new Set(rowsByTime.map(r => r.loja))).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  vektorResumoCicloBuildOptions_(selLoja, lojas, "Todas");

  // aplica filtros finais (time + loja)
  let filtered = rowsByTime;
  if (loja) filtered = filtered.filter(r => r.loja === loja);

  // ‚úÖ FALLBACK: se backend n√£o mandou tx detalhado, mas existe pend√™ncia agregada
  // Evita a IA mentir "n√£o existem transa√ß√µes pendentes" quando a p√°gina tem dados.
  if ((!window.__cicloResumoTxFiltered || window.__cicloResumoTxFiltered.length === 0) && filtered && filtered.length) {
    const temPendAgregada = filtered.some(r => Number(r.qtde || 0) > 0);
    if (temPendAgregada) {
      window.__cicloResumoTxFiltered = filtered.map(r => ({
        loja: r.loja,
        time: r.time,
        dataISO: "",           // n√£o existe no agregado
        estabelecimento: "",
        valor: Number(r.valor || 0),
        categoria: "",
        pendTotal: Number(r.qtde || 0),
        txCount: Number(r.txCount || 0),
        _agregado: true
      }));
    }
  }

  // recalcula cards + top
  const totalLojas = new Set(filtered.map(r => r.loja)).size;
  const totalPend = filtered.reduce((acc,r)=>acc + (Number(r.qtde)||0), 0);
  const totalValor = filtered.reduce((acc,r)=>acc + (Number(r.valor)||0), 0);

  const elL = document.getElementById("cicloResumo_totalLojas");
  const elP = document.getElementById("cicloResumo_totalPend");
  const elV = document.getElementById("cicloResumo_totalValor");

  const fmtBRL = (v) => {
    try { return Number(v||0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" }); }
    catch(e){ return String(v||0); }
  };

  if (elL) elL.textContent = String(totalLojas || 0);
  if (elP) elP.textContent = String(totalPend || 0);
  if (elV) elV.textContent = fmtBRL(totalValor || 0);

  // top 10 por valor
  const top = filtered.slice().sort((a,b)=> (b.valor||0)-(a.valor||0)).slice(0,10);

  const tbody = document.getElementById("cicloResumo_tbody");
  if (tbody) {
    if (!top.length) {
      tbody.innerHTML = `<tr><td colspan="5" style="padding:10px;color:#0f172a;font-weight:900;">Nenhum resultado para o filtro.</td></tr>`;
    } else {
      tbody.innerHTML = top.map(r => `
        <tr>
          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);white-space:nowrap;">${r.loja}</td>
          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);white-space:nowrap;">${r.time}</td>

          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);text-align:right;white-space:nowrap;">
            ${Number(r.qtde||0)}
          </td>

          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);text-align:right;white-space:nowrap;">
            ${Number(r.txCount||0)}
          </td>

          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);text-align:right;white-space:nowrap;">
            ${fmtBRL(r.valor)}
          </td>
        </tr>
      `).join("");
    }
  }
}

window.vektorResumoCicloLimparFiltros = function(){
  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");
  if (selTime) selTime.value = "";
  if (selLoja) selLoja.value = "";
  vektorResumoCicloApply_();
};

// Render ‚Äúbonito‚Äù do alerta no chat (reaproveita o padr√£o da sua tabela j√° existente)
window.vektorRenderTabelaTransacoesEtiquetaAlert_ = function (resp) {
  const rows = Array.isArray(resp.rows) ? resp.rows : [];
  const periodo = resp.periodo ? (resp.periodo.inicio + " a " + resp.periodo.fim) : "‚Äî";

  const esc = (s) => String(s ?? "").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));
  const fmt = (v) => (typeof v === "number" ? v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}) : String(v||""));

  // ==========================
  // NOVO: Pend√™ncias
  // ==========================
  if (String(resp.alertType || "") === "PENDENCIAS") {
    const tituloP = "üîî Visual de Pend√™ncias Via Alerta do Vektor ‚Äî " + (resp.alertId || "‚Äî");
    const subtP = "<div style='margin-top:4px; font-size:12px; color:#64748B; text-align:center;'>" +
      "<b>Per√≠odo:</b> " + esc(periodo) +
      " &nbsp; <b>Linhas:</b> " + rows.length +
    "</div>";

    if (!rows.length) {
      return "<div class='text-sm text-slate-700'><p style='text-align:center;font-weight:bold;'>" + tituloP + "</p>" + subtP +
        "<p style='margin-top:8px; text-align:center;'>Nenhuma pend√™ncia encontrada para o filtro.</p></div>";
    }

    let h = "";
    h += "<div class='text-sm text-slate-700'>";
    h += "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + tituloP + "</p>";
    h += subtP;
    h += "<div style='overflow:auto;border:1px solid rgba(0,0,0,0.12);border-radius:10px;margin-top:10px;'>";
    h += "<table style='border-collapse:collapse;width:100%;font-size:12px;'>";
    h += "<thead><tr style='background:#B5FF20;'>";
    ["Loja","Time","Data da Transa√ß√£o","Valor (R$)","Estabelecimento","Titular","Pend√™ncias"].forEach(t => {
      h += "<th style='background:#B5FF20;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;position:sticky;top:0;z-index:10;'>" + esc(t) + "</th>";
    });
    h += "</tr></thead><tbody>";

    rows.slice(0, 60).forEach(r => {
      h += "<tr>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.loja) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.time) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.data) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;white-space:nowrap;'>" + esc(fmt(r.valor)) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:260px;'>" + esc(r.estabelecimento) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.titular) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:240px;'>" + esc(r.pendencias) + "</td>";
      h += "</tr>";
    });

    h += "</tbody></table></div></div>";
    return h;
  }

  // ==========================
  // Original: Transa√ß√µes
  // ==========================
  const titulo = "üîî Visual de Transa√ß√µes Via Alerta do Vektor ‚Äî " + (resp.alertId || "‚Äî");
  const subt = "<div style='margin-top:4px; font-size:12px; color:#64748B; text-align:center;'>" +
    "<b>Per√≠odo:</b> " + esc(periodo) +
    " &nbsp; <b>Etiqueta:</b> " + esc(resp.etiqueta || "‚Äî") +
    " &nbsp; <b>Linhas:</b> " + rows.length +
  "</div>";

  if (!rows.length) {
    return "<div class='text-sm text-slate-700'><p style='text-align:center;font-weight:bold;'>" + titulo + "</p>" + subt +
      "<p style='margin-top:8px; text-align:center;'>Nenhuma transa√ß√£o encontrada para o filtro.</p></div>";
  }

  let h = "";
  h += "<div class='text-sm text-slate-700'>";
  h += "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>";
  h += subt;
  h += "<div style='overflow:auto;border:1px solid rgba(0,0,0,0.12);border-radius:10px;margin-top:10px;'>";
  h += "<table style='border-collapse:collapse;width:100%;font-size:12px;'>";
  h += "<thead><tr style='background:#B5FF20;'>";
  ["Loja","Time","Data","Estabelecimento","Valor","Etiqueta inserida","Item comprado (descri√ß√£o)"].forEach(t => {
    h += "<th style='background:#B5FF20;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;position:sticky;top:0;z-index:10;'>" + esc(t) + "</th>";
  });
  h += "</tr></thead><tbody>";

  rows.slice(0, 60).forEach(r => {
    h += "<tr>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.loja) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.time) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.data) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:260px;'>" + esc(r.estabelecimento) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;white-space:nowrap;'>" + esc(fmt(r.valor)) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:240px;'>" + esc(r.etiqueta) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:360px;'>" + esc(r.descricao) + "</td>";
    h += "</tr>";
  });

  h += "</tbody></table></div></div>";
  return h;
};

function closeStatusVektorModal() {
  document.getElementById("statusVektorModal").style.display = "none";
}

let __vektorJaSugeriuLooker = false;
let __vektorJaSugeriuPoliticaRestricoes = false;
let __vektorJaSugeriuPoliticaUso = false;
let __vektorJaSugeriuJustificativas = false;


// Registro do plugin de r√≥tulos do Chart.js (se estiver carregado)
if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
  Chart.register(ChartDataLabels);
}

// ===== DADOS DO USU√ÅRIO (globais, vindos do Apps Script) =====

// Nome vindo do template Apps Script (Code.gs ‚Üí tmpl.userName)
const USER_NAME_RAW = <?= JSON.stringify(userName || "") ?>;
const displayName = (USER_NAME_RAW || "")
  .replace(/^"+|"+$/g, "")
  .trim();
const USER_ROLE_RAW  = <?= JSON.stringify(userRole  || "") ?>;

// E-mail vindo do Apps Script (Code.gs ‚Üí template.userEmail)
const USER_EMAIL_RAW = <?= JSON.stringify(userEmail || "") ?>;
const USER_EMAIL_REPLACED = (USER_EMAIL_RAW || "")
  .replace(/^"+|"+$/g, "")
  .trim();
const USER_ROLE_CLEAN     = (USER_ROLE_RAW  || "").replace(/^"+|"+$/g, "").trim();
const USER_ROLE_REPLACED = USER_ROLE_CLEAN;

// ================== M√âTRICAS VEKTOR ‚Üí GOOGLE SHEETS ==================

function vektorRegistrarMetrica(
  intencao,
  msgOriginal,
  norm,
  resultado,
  topicoExtra,
  funcaoOrigem
) {
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    console.warn("google.script.run n√£o dispon√≠vel");
    return;
  }

  const payload = {
    intencao: intencao || "",
    topico: topicoExtra || "",
    mensagemOriginal: msgOriginal || "",
    norm: norm || "",
    resultado: resultado || "",
    usuarioNome: displayName || "",
    usuarioEmail: USER_EMAIL_REPLACED || "",
    loja: (window.VEKTOR_LOJA || ""),
    funcaoOrigem: funcaoOrigem || "desconhecida"
  };

  google.script.run
    .withFailureHandler(err => console.error("Falha m√©trica:", err))
    .registrarMetricaVektor(payload);
}

document.addEventListener("DOMContentLoaded", () => {

  if (VEKTOR_MANUTENCAO_ATIVA) return;

    let grupoNome = "";
    let grupo = "";

    const ROBOT_IMG_URL = "https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png";

    // >>> NOVO: preencher barra de usu√°rio
    const topUserEl = document.getElementById("vektor-user-info");
    const topClockEl = document.getElementById("vektor-clock");
    const topBuEl = document.getElementById("vektor-bu");

    const nomeParaMostrar = displayName || USER_EMAIL_REPLACED || "Usu√°rio";
    const roleParaMostrar = USER_ROLE_CLEAN || "Acesso padr√£o";

    if (topUserEl) {
      topUserEl.textContent = `Login: ${nomeParaMostrar} (${roleParaMostrar})`;
    }

          if (topBuEl) {
        try {
          // n√£o deixa ReferenceError/qualquer erro aqui derrubar o DOMContentLoaded
          var em = "";
          if (typeof USER_EMAIL_REPLACED !== "undefined" && USER_EMAIL_REPLACED != null) {
            em = "" + USER_EMAIL_REPLACED;
          }

          em = em.toLowerCase();
          em = em.replace(/^\s+|\s+$/g, "");

          if (!em) {
            topBuEl.textContent = "BU: ‚Äî";
          } else if (em.indexOf("@gruposbf.com.br") !== -1 || em.indexOf("@centauro.com.br") !== -1) {
            topBuEl.textContent = "BU: Centauro";
          } else {
            topBuEl.textContent = "BU: Nike";
          }
        } catch (e) {
          // fallback silencioso: n√£o quebra a tela
          topBuEl.textContent = "BU: ‚Äî";
        }
      }

    function atualizarRelogio() {
      const agora = new Date();
      const data = agora.toLocaleDateString("pt-BR", {
        weekday: "short",
        day:    "2-digit",
        month:  "2-digit",
        year:   "numeric"
      });
      const hora = agora.toLocaleTimeString("pt-BR", {
        hour:   "2-digit",
        minute: "2-digit",
        hour12: false
      });

      if (topClockEl) {
        topClockEl.textContent = `${data} ¬∑ ${hora}`;
      }
    };

    atualizarRelogio();               // primeira atualiza√ß√£o
    setInterval(atualizarRelogio, 1000);  // atualiza todo segundo

    // ============================
// BANNER DE FERIADOS (TOPBAR)
// ============================
(function vektorAtualizarBannerFeriadosTopo() {
  try {
    var banner = document.getElementById("vektor-holiday-banner");
    if (!banner) return;

    // Hoje sem hor√°rio (evita bug de fuso)
    var hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    function dateOnly(y, m, d) {
      var dt = new Date(y, m, d);
      dt.setHours(0, 0, 0, 0);
      return dt;
    }

    function diffDias(a, b) {
      // b - a em dias
      var ms = b.getTime() - a.getTime();
      return Math.floor(ms / 86400000);
    }

    var ano = hoje.getFullYear();

    // Regras pedidas:
    // - Natal: exibir a partir de 3 dias antes (22/12 -> 25/12)
    // - Ano Novo: voc√™ quer come√ßar dia 28/12, ent√£o offset = 4 (pra 01/01)
    var candidatos = [
                  {
              nome: "Natal",
              cor: "#B91C1C",
              data: dateOnly(ano, 11, 25),
              startOffsetDias: 3,
              endOffsetDias: 0,
              html: function (diasPara) {
                // Dia 25 exatamente
                if (diasPara === 0) {
                  return "üéÑ Feliz Natal! Que o dia seja leve, alegre e cheio de boas energias!";
                }
                // Dias anteriores (22, 23, 24)
                return "üéÑ Natal chegando! Desejamos um tempo de paz e alegria!";
              }
            },
      {
        nome: "Ano Novo",
        cor: "#D4AF37",
        data: dateOnly(ano + 1, 0, 1), // Jan = 0 (pr√≥ximo ano)
        startOffsetDias: 4,
        endOffsetDias: 0,
        html: "‚ú® Ano Novo chegando! Boa virada."
      }
    ];

    var msgHtml = "";
    for (var i = 0; i < candidatos.length; i++) {
      var h = candidatos[i];
      var delta = diffDias(hoje, h.data); // dias at√© o feriado

      if (delta <= h.startOffsetDias && delta >= h.endOffsetDias) {
        msgHtml = "<span style='color:" + h.cor + ";'>" +
          (typeof h.html === "function" ? h.html(delta) : h.html) +
          "</span>";
        break;
      }
    }

    if (msgHtml) {
      banner.innerHTML = msgHtml;
      banner.style.display = "block";
    } else {
      banner.innerHTML = "";
      banner.style.display = "none";
    }
  } catch (e) {
    console.warn("Falha ao montar banner de feriados na topbar:", e);
  }
})();

// SAUDA√á√ÉO MSG INICIAL //
  function getSaudacaoPorHorario_() {
    const hora = new Date().getHours();

    if (hora >= 5 && hora < 12) return "bom dia";
    if (hora >= 12 && hora < 18) return "boa tarde";
    return "boa noite";
  }

  function renderSaudacaoVektor_() {
  const el = document.getElementById("vektorGreeting");
  if (!el) return;

  const saudacao = getSaudacaoPorHorario_();

  const nome = (typeof FIRST_NAME !== "undefined" && FIRST_NAME)
    ? FIRST_NAME
    : (typeof displayName !== "undefined" ? displayName : "");

  const prefixo = nome
    ? `Ol√° ${nome}, ${saudacao}!`
    : `Ol√°, ${saudacao}!`;

  el.innerHTML =
    `${prefixo} Esse √© o <b>Vektor</b>, <b>Plataforma de Governan√ßa Financeira do Cart√£o Clara</b>.`;
}

  // Executa assim que o DOM estiver pronto
  document.addEventListener("DOMContentLoaded", renderSaudacaoVektor_);

  renderSaudacaoVektor_();
    
// üîπ Mensagem inicial: CTA para abrir o guia "Como usar o Vektor"
renderBotMessage(
  "HTML:" +
  "<div class='text-sm text-slate-700' style='margin-top:8px'>" +
    "<div style='margin-bottom:8px; font-weight:800; color:#0f172a;'>Quer ver o guia r√°pido do Vektor?</div>" +
    "<button type='button' onclick='openAjudaVektorModal()' " +
      "style='width:100%; display:flex; align-items:center; justify-content:center; gap:8px;" +
      "padding:10px 12px; border-radius:12px; border:1px solid rgba(181,255,32,0.9);" +
      "background:#0b1220; color:#fff; font-weight:900; cursor:pointer;'>" +
      "Como usar o Vektor ‚ùì" +
    "</button>" +
    "<div style='margin-top:8px; font-size:12px; color:#475569;'>Clique para abrir exemplos e procedimentos.</div>" +
  "</div>"
);

// üîî Sauda√ßao em outra mensagem, depois da mensagem inicial
// ‚úÖ S√≥ para N√ÉO Administrador
setTimeout(() => {

    // Se for ADM, N√ÉO mostra essa sauda√ß√£o (ADM j√° tem o fluxo do informativo + pergunta inicial)
    if (USER_ROLE_CLEAN === "Administrador") return;

    if (displayName) {
        // Vers√£o com nome
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'><b>" +
            displayName +
            "</b>, como posso te ajudar hoje?</p>"
        );
    } else {
        // Vers√£o sem nome (fallback)
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Como posso te ajudar hoje?</p>"
        );
    }
}, 2000);

setTimeout(function () {
  try {
    // ‚úÖ Agora N√ÉO mostra demiss√µes no carregamento
    window.vektorPerguntarInformacoesIniciais();
  } catch (e) {
    console.error("Erro ao disparar pergunta de info iniciais:", e);
  }
}, 2500);

      // Vari√°veis vindas do Apps Script (template do doGet)
      const USER_EMAIL_REPLACED = "<?= userEmail ?>";
      const USER_ROLE_REPLACED  = "<?= userRole ?>";

    /* ========= ESTADOS ========= */
    let estadoPendencias = "nenhum"; // "nenhum" | "aguardando_loja" | "aguardando_confirmacao_email" | "aguardando_email"
    let lojaPendenciasAtual = "";
    let ultimaPendenciaResumo = null; // { loja, data }
    let fluxoNovoCartao = null; // null | "aguardando_tipo_via"
    let ultimaIntencao = null;
    let origemPendenciasBloqueio = false;
    let pendenciasTimeoutId = null; // üÜï timeout pra mensagem de outro assunto

    /* ========= ELEMENTOS UI ========= */
    const chatWindow = document.getElementById("chatWindow");
    const chatForm   = document.getElementById("chatForm");
    const userInput  = document.getElementById("userInput");
    const attachBtn = document.getElementById("attachBtn");
    const fileInputTermo = document.getElementById("fileTermo");

        // ===== Upload do Termo de Responsabilidade =====
    if (attachBtn && fileInputTermo) {

        // Garante que o input aceite apenas os formatos liberados
        fileInputTermo.accept = ".pdf,.jpg,.jpeg,.png,.heic,.HEIC";

        // Ao clicar no bot√£o üìé, abre o seletor de arquivos
        attachBtn.addEventListener("click", () => {
            fileInputTermo.click();
        });

        // Quando o usu√°rio escolhe o arquivo
        fileInputTermo.addEventListener("change", function () {
            const file = this.files && this.files[0];
            if (!file) return;

            // Valida tipo permitido
            const mime = file.type || "";

            // Aceita qualquer varia√ß√£o de JPEG e PNG, al√©m de PDF e HEIC
            const isPdf  = mime === "application/pdf";
            const isPng  = mime === "image/png";
            const isHeic = mime.includes("heic") || mime.includes("heif");

            // Alguns navegadores enviam JPEG como image/jpg, image/pjpeg, image/jfif, etc.
            const isJpeg = mime.includes("jpeg") || mime.includes("jpg") || mime.includes("pjpeg") || mime.includes("jfif");

            // Verifica√ß√£o final
            if (!(isPdf || isPng || isHeic || isJpeg)) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-red-700'>S√≥ √© permitido enviar o <b>Termo de Responsabilidade</b> nos formatos PDF, JPG, JPEG, PNG ou HEIC.</p>"
                );
                this.value = "";
                return;
            }

            const reader = new FileReader();
    reader.onload = function (e) {
        const dataUrl = e.target.result || "";
        const base64  = dataUrl.split(",")[1];

        // Guarda temporariamente o arquivo do termo
        window.vektorTermoPending = {
            base64:           base64,
            mimeType:         mime,
            fileNameOriginal: file.name,
            usuarioEmail:     USER_EMAIL_REPLACED || ""
        };
        window.vektorTermoAguardandoNome = true;

        // 1) Pr√©-visualiza√ß√£o (quando for imagem)
        if (mime.startsWith("image/")) {
            renderBotMessage(
                "HTML:" +
                "<div class='text-sm text-slate-700'>" +
                  "<p>Pr√©-visualiza√ß√£o do Termo anexado:</p>" +
                  "<img src='" + dataUrl + "' " +
                        "alt='Pr√©-visualiza√ß√£o do Termo' " +
                        "class='mt-2 max-h-64 rounded border border-slate-200' />" +
                "</div>"
            );
        } else {
            // PDF ou outro formato suportado sem preview direto
            renderBotMessage(
                "HTML:" +
                "<div class='text-sm text-slate-700'>" +
                  "<p>Arquivo PDF do Termo foi anexado (pr√©-visualiza√ß√£o n√£o dispon√≠vel aqui no chat).</p>" +
                "</div>"
            );
        }

        // 2) Mensagem pedindo o nome completo (em outra bolha)
        setTimeout(function () {
            renderBotMessage(
                "HTML:" +
                "<p class='text-sm text-slate-700'>" +
                "Para concluir o registro, por favor informe seu <b>nome completo</b>." +
                "</p>"
            );
        }, 150);
    };

    reader.readAsDataURL(file);

            // limpa o input para permitir novo upload depois
            this.value = "";
        });
    }

    // =========================
// AUTOCOMPLETE VEKTOR
// =========================

// 1) Lista de inten√ß√µes (VOC√ä J√Å TEM ‚Äî basta mover pra c√°)
const VEKTOR_INTENTS = [
  "Consultar pend√™ncias de uma loja",
  "Gerente est√° de f√©rias",
  "Gerente foi demitido",
  "Sangria",
  "Gerente foi desligado",
  "Gerente mudou de loja",
  "Troca de gerente entre lojas",
  "Servicenow",
  "Como abrir chamado no servicenow?",  
  "Lojas com mais pend√™ncias do time",
  "Pend√™ncias do time",
  "Pend√™ncias da loja",
  "Time com mais pend√™ncias",
  "V√≠deo de justificativas",
  "Como justificar uma transa√ß√£o",
  "Loja com maior valor de transa√ß√µes neste m√™s",
  "Loja com mais transa√ß√µes neste m√™s",
  "Treinamento Clara",
  "Termo de responsabilidade Clara",
  "Maiores transa√ß√µes do time",
  "Maiores transa√ß√µes da loja",
  "Maiores transa√ß√µes",
  "Valor da fatura atual",
  "Valor da fatura do m√™s passado",
  "Valor das √∫ltimas 3 faturas",
  "Valor das √∫ltimas 6 faturas",
  "Valor de todas as faturas",
  "Qual √© o ciclo da fatura da Clara?",
  "Qual etiqueta usar para compra de",
  "Listagem de etiquetas cadastradas na Clara",
  "Ranking de lojas com mais transa√ß√µes",
  "Ranking de lojas com maior valor",
  "Ranking de times com mais transa√ß√µes",
  "Ranking de times com maior valor",
  "Top 3 lojas de um time",
  "Top 5 lojas do per√≠odo",
  "Resumo da loja xxxx neste m√™s",
  "Resumo de uma loja na √∫ltima semana",
  "Transa√ß√µes de uma loja no per√≠odo",
  "Quais lojas fazem parte de um time?",
  "Resumo de um time neste m√™s",
  "Resumo de um time no per√≠odo",
  "Time com maior valor de transa√ß√µes",
  "Time com maior n√∫mero de transa√ß√µes",
  "Categorias com maior valor de transa√ß√µes",
  "Estabelecimentos mais usados",
  "O que posso comprar com o cart√£o Clara?",
  "Tipos de compra permitidos",
  "Tipos de compra proibidos",
  "Regras da Pol√≠tica de Uso dos Cart√µes Clara",
  "Quando o cart√£o √© bloqueado?",
  "Lojas ofensoras",
  "Frequ√™ncia de uso Clara para o time",
  "Frequ√™ncia de uso Clara para a loja",
  "Perdi meu cart√£o Clara, o que fazer?",
  "Comparar fatura atual vs anterior",
  "Cart√£o Clara bloqueado, como resolver?",
  "Como desbloquear o cart√£o Clara?",
  "Meu cart√£o n√£o passou, o que pode ser?",
  "Abrir relat√≥rio gerencial da Clara",
  "Como aumento o limite do cart√£o?",
  "Itens comprados para o time",
  "Itens comprados para a loja",
  "Itens comprados no geral",
  "Rela√ß√£o de saldos geral",
  "Rela√ß√£o de saldos do time",
  "Tabela de estornos",
  "Tabela de estornos do time",
  "Como usar bem o limite do cart√£o Clara?",
  "Gastos por etiquetas",
  "Quero gr√°ficos das transa√ß√µes",
  "O que o Vektor pode fazer?",
  "Como anexar nota fiscal na Clara?",
  "Poss√≠vel uso irregular",
  "Emiss√£o de 1¬™ via",
  "Emiss√£o de 2¬™ via",
  "Novo cart√£o Clara",
  "Como justificar compras na Clara?"
];

// 2) Normaliza√ß√£o
function vektorNormAutocomplete(str) {
  if (!str) return "";
  return str
    .toString()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// 3) Campos HTML
const vektorInput = document.getElementById("userInput");
const vektorBox   = document.getElementById("vektor-autocomplete-box");

// Estado atual do autocomplete
let vektorCurrentSuggestions = [];
let vektorSelectedIndex = -1;

// Atualiza visualmente qual item est√° selecionado
function vektorHighlightSelected() {
  const items = vektorBox.querySelectorAll(".vektor-autocomplete-item");
  items.forEach((el, idx) => {
    if (idx === vektorSelectedIndex) {
      el.classList.add("is-active");
      // Garante que o item vis√≠vel seja mostrado
      el.scrollIntoView({ block: "nearest" });
    } else {
      el.classList.remove("is-active");
    }
  });
}

function vektorApplySuggestion(textoSugestao) {
  const sugestao = textoSugestao || "";
  const atual = vektorInput.value || "";

  // Normaliza a sugest√£o pra comparar com a lista de times
  const normSug = vektorNormAutocomplete(sugestao);

  // √â um TIME se a sugest√£o bater exatamente com algum VEKTOR_TIMES normalizado
  const isTime = VEKTOR_TIMES.some(
    (t) => vektorNormAutocomplete(t) === normSug
  );

  // √â uma LOJA se vier no formato "0001 - NOME" (√© assim que voc√™ monta l√° embaixo)
  const isLoja = /^\d{3,4}\s*-/.test(sugestao);

  // Para time/loja: N√ÉO apagar tudo, s√≥ trocar a √∫ltima palavra digitada
  if (isTime || isLoja) {
    // remove espa√ßos do fim
    const base = atual.replace(/\s+$/g, "");
    const m = base.match(/^(.*\s)(\S+)$/); // tudo antes + √∫ltima palavra

    if (m) {
      const antes = m[1];   // frase antes da √∫ltima palavra
      vektorInput.value = antes + sugestao; // substitui s√≥ a √∫ltima palavra
    } else {
      // se s√≥ tinha uma palavra no campo, a√≠ n√£o tem muito o que fazer
      vektorInput.value = sugestao;
    }
  } else {
    // Sugest√µes gen√©ricas (intents): mant√©m comportamento antigo
    vektorInput.value = sugestao;
  }

  vektorInput.focus();
}

// 4) Carregar lista de LOJAS vinda do back-end
window.__VEKTOR_LOJAS = [];
google.script.run.withSuccessHandler(function(lista){
    if (Array.isArray(lista)) window.__VEKTOR_LOJAS = lista;
}).getListaLojas();

// 5) Lista de times reais (voc√™ ajusta aqui)
const VEKTOR_TIMES = [
  "√Åguias de Elite",
  "√Åguias do Cerrado",
  "Guardi√µes da Fronteira",
  "Esquadr√£o 40 graus",
  "Esquadr√£o Valente",
  "Falc√µes SP",
  "Flechas do Norte",
  "Furac√£o Sul I",
  "Ultra High",
  "F√∫ria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Canga√ßo",
  "Legi√£o de Elite",
  "Sulcesso"
];

// 6) Renderizar sugest√µes

function vektorRenderSugestoes(lista) {
  if (!lista.length) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  vektorCurrentSuggestions = lista.slice(0, 8);
  vektorSelectedIndex = -1;

  vektorBox.innerHTML = vektorCurrentSuggestions
    .map((s, idx) => 
      `<div class="vektor-autocomplete-item" data-index="${idx}">${s}</div>`
    )
    .join("");

  vektorBox.style.display = "block";
}

// 7) L√≥gica do autocomplete
vektorInput.addEventListener("input", function () {
  const raw = vektorInput.value || "";

  // Se o campo est√° vazio, limpa e sai
  if (!raw.trim()) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  // texto inteiro normalizado (para intents)
  const norm = vektorNormAutocomplete(raw);

  // Usa o texto SEM os espa√ßos finais para pegar a √∫ltima palavra completa
  const base = raw.replace(/\s+$/g, ""); // remove espa√ßos do fim
  const lastMatch = base.match(/(\S+)$/);
  const lastRaw   = lastMatch ? lastMatch[1] : "";
  const lastNorm  = vektorNormAutocomplete(lastRaw);

  // se a √∫ltima palavra completa tem menos de 2 caracteres, n√£o sugere nada
  if (!lastNorm || lastNorm.length < 2) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  let suggestions = [];

  // a) frases do VEKTOR_INTENTS -> usa a frase inteira normalizada
  if (norm.length >= 2) {
    suggestions.push(
      ...VEKTOR_INTENTS.filter(x => vektorNormAutocomplete(x).includes(norm))
    );
  }

  // b) autocomplete de LOJAS -> usa s√≥ os d√≠gitos da √∫ltima palavra
  if (window.__VEKTOR_LOJAS && window.__VEKTOR_LOJAS.length) {
    const digits = (lastRaw || "").replace(/\D/g, "");
    if (digits && digits.length <= 4) {
      const padded = ("0000" + digits).slice(-4);

      window.__VEKTOR_LOJAS.forEach((l) => {
        const cod = String(l.codigo || "").padStart(4, "0");

        if (cod.startsWith(padded)) {
          const nomeFinal = l.nome || l.nomeLojaTxt || "";
          let label = cod;

          if (nomeFinal) {
            label += " - " + nomeFinal;
          }

          suggestions.push(label);
        }
      });
    }
  }

  // c) autocomplete de TIMES -> compara contra a √∫ltima palavra completa
  if (lastNorm.length >= 2) {
    suggestions.push(
      ...VEKTOR_TIMES.filter(t => vektorNormAutocomplete(t).includes(lastNorm))
    );
  }

  // remover duplicados
  suggestions = [...new Set(suggestions)];

  vektorRenderSugestoes(suggestions);
});

// clique do mouse
vektorBox.addEventListener("mousedown", (e)=>{
  const item = e.target.closest(".vektor-autocomplete-item");
  if (!item) return;

  const idx = item.dataset.index ? parseInt(item.dataset.index, 10) : -1;
  const textoSugestao =
    (idx >= 0 && vektorCurrentSuggestions[idx])
      ? vektorCurrentSuggestions[idx]
      : item.innerText;

  vektorApplySuggestion(textoSugestao);

  vektorBox.style.display = "none";
  vektorSelectedIndex = -1;
  vektorCurrentSuggestions = [];
});

    const sendBtn    = document.getElementById("sendBtn");

    /* ========= FUN√á√ïES DE UI ========= */
    function scrollToBottom() {
  requestAnimationFrame(() => {
    const w = document.getElementById("chatWindow");
    if (!w) return;
    w.scrollTop = w.scrollHeight;
    setTimeout(() => { w.scrollTop = w.scrollHeight; }, 150);
  });
}

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start justify-end gap-3";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

        // Converte texto tipo "R$ 340.800,00" ou "59,1 mil" em n√∫mero
    function vektorParseNumero(texto) {
      if (!texto) return NaN;

      let t = String(texto).toLowerCase();

      // trata "mil" (ex.: "340,8 mil")
      let multiplicador = 1;
      if (t.includes(" mil")) {
        multiplicador = 1000;
      }
      t = t.replace(/mil/gi, "");

      // remove tudo que n√£o for n√∫mero, v√≠rgula, ponto ou sinal
      t = t.replace(/[^\d,.\-]/g, "");

      // remove pontos de milhar e troca v√≠rgula por ponto
      t = t.replace(/\./g, "").replace(",", ".");

      const n = parseFloat(t);
      if (isNaN(n)) return NaN;
      return n * multiplicador;
    }


        function iniciarTimeoutPendencias() {
        // limpa qualquer timeout pendente
        if (pendenciasTimeoutId) {
            clearTimeout(pendenciasTimeoutId);
            pendenciasTimeoutId = null;
        }

    const mensagensOutroAssunto = [
  "Quer falar sobre outro assunto? Se sim, pode mandar bala!",
  "Quer aproveitar e falar de outro tema?",
  "Quer conversar sobre outra coisa?",
  "Planeta Terra chamando! Tem algu√©m ai? üôÑ",
  "Me diz se quer mudar de assunto? üòâ",  
  "Tem outro assunto que quer tratar?",
  "Posso te ajudar com mais alguma coisa?",
  "Quer mudar de assunto? Manda ver!",
  "Se quiser falar de outro tema, √© s√≥ digitar üëá",
  "Posso te ajudar em outro ponto se quiser...",
  "Quer conversar sobre outra coisa agora?"
];

// üïí dispara o lembrete depois de 10s sem resposta
pendenciasTimeoutId = setTimeout(() => {
  // escolhe uma frase aleat√≥ria do array
  const fraseAleatoria = mensagensOutroAssunto[
    Math.floor(Math.random() * mensagensOutroAssunto.length)
  ];

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">${fraseAleatoria}</p>`
  );
}, 10000);

    }


        // üëá Cole AQUI, logo abaixo de scrollToBottom()

      // Adiciona indicador de "digitando..."
      function showTypingIndicator() {
        const chatWindow = document.getElementById('chatWindow');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex items-start gap-3 mt-3';
        typingDiv.innerHTML = `
          <div class="bot-bubble px-4 py-3 max-w-[80%]">
            <div class="typing-indicator flex gap-1">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

  // ---- DEBUG TURBINADO: mostra erros e rejei√ß√µes dentro do chat ----
(function instalarErroNoChat() {
  if (window.__erroNoChatInstalado) return;
  window.__erroNoChatInstalado = true;

  // Fun√ß√£o auxiliar pra mostrar a mensagem no chat
  function mostrarErro(titulo, msg, linha, arquivo) {
    try {
      renderBotMessage(
        "HTML:<div style='font-family:Arial,sans-serif;font-size:12px;color:#B00020;background:#FFECEC;padding:8px;border:1px solid #B00020;border-radius:6px'>" +
          "<b>" + titulo + ":</b> " + msg +
          (linha ? "<br/><small>(" + (arquivo || "inline") + ":" + linha + ")</small>" : "") +
        "</div>"
      );
    } catch (_) {
      console.error("Erro ao mostrar debug no chat:", msg);
    }
  }

  // 1Ô∏è‚É£ Erros comuns de execu√ß√£o
  window.addEventListener("error", function (e) {
    const msg = e.message || String(e);
    mostrarErro("Erro de script", msg, e.lineno, e.filename);
  });

  // 2Ô∏è‚É£ Promises rejeitadas (async/await sem catch)
  window.addEventListener("unhandledrejection", function (e) {
    const msg = e.reason && e.reason.message ? e.reason.message : String(e.reason);
    mostrarErro("Promise rejeitada", msg);
  });

  // 3Ô∏è‚É£ Aviso de que o script carregou e debug est√° ativo
  window.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Debug do chat ativado!");
  });

  // 4Ô∏è‚É£ Falhas no carregamento de scripts externos
  window.addEventListener("error", function (e) {
    if (e.target && e.target.tagName === "SCRIPT") {
      mostrarErro("Falha ao carregar script", e.target.src || "(inline script)");
    }
  }, true);
})();



  function hideTypingIndicator() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) typingDiv.remove();
  }

  function vektorStripHtml(html) {
  if (!html) return "";
  // remove prefixo "HTML:" se existir
  if (typeof html === "string" && html.startsWith("HTML:")) {
    html = html.substring(5);
  }
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  const text = tmp.textContent || tmp.innerText || "";
  return text.replace(/\s+/g, " ").trim();
}

function vektorResumoTexto(texto, maxLen) {
  maxLen = maxLen || 200;
  if (!texto) return "";
  if (texto.length <= maxLen) return texto;
  return texto.substring(0, maxLen) + " ...";
}

function vektorDetectarFuncaoOrigem() {
  let origem = "renderBotMessage";
  try {
    // Em muitos navegadores, em modo n√£o-estrito, caller funciona
    const caller = renderBotMessage.caller;
    if (caller && caller.name) {
      origem = caller.name;
    }
  } catch (e) {
    // Se der erro por restri√ß√£o de caller, mant√©m o fallback
    console.warn("N√£o foi poss√≠vel detectar caller da renderBotMessage:", e);
  }
  return origem;
}

  async function renderBotMessage(text) {
  if (!text) return;

  // üëá Mostra o indicador de "digitando..."
  showTypingIndicator();

  // Aguarda 1 segundo (simulando digita√ß√£o)
  await new Promise(r => setTimeout(r, 800));

  // Remove o indicador
  hideTypingIndicator();

  // --- Parte original do seu c√≥digo ---
  const wrapper = document.createElement("div");
  wrapper.className = "flex items-start gap-3";

  const avatar = document.createElement("img");
  avatar.src = ROBOT_IMG_URL;
  avatar.alt = "Assistente Clara (rob√¥)";
  avatar.className = "h-16 w-auto object-contain flex-shrink-0";

  const bubble = document.createElement("div");
  const baseBubbleClasses =
    "bot-bubble px-4 py-3 text-sm whitespace-pre-line text-slate-700";
  bubble.className = baseBubbleClasses;

  // Conte√∫do: HTML ou texto puro
  if (typeof text === "string" && text.startsWith("HTML:")) {
    bubble.innerHTML = text.replace(/^HTML:/, "").trim();
  } else {
    bubble.innerText = text;
  }

  // Se a resposta cont√©m <iframe> (ex.: relat√≥rio gerencial),
  // a bolha ocupa a largura total do chat; caso contr√°rio, 80%.
  if (bubble.querySelector("iframe")) {
    bubble.className = baseBubbleClasses + " w-full";
  } else {
    bubble.className = baseBubbleClasses + " max-w-[80%]";
  }

  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);
  chatWindow.appendChild(wrapper);

  scrollToBottom();

  // ============================================================
  // üîπ LOG CENTRALIZADO DE SA√çDA DO BOT ‚Üí GOOGLE SHEETS
  // ============================================================
  try {
    const textoLimpo = vektorStripHtml(text);
    const resumo = vektorResumoTexto(textoLimpo, 250);

    let intencaoSaida = "bot_generico";
    if (typeof ultimaIntencao !== "undefined" && ultimaIntencao) {
      intencaoSaida = ultimaIntencao;
    }

    // üîπ AGORA A ORIGEM √â DETECTADA AUTOMATICAMENTE
    const origemSaida = vektorDetectarFuncaoOrigem();

    vektorRegistrarMetrica(
      intencaoSaida,         // intencao
      "[BOT] " + resumo,     // mensagemOriginal
      "",                    // norm
      "bot_msg",             // resultado
      "SaidaBot",            // topico
      origemSaida            // funcaoOrigem (ex.: vektorBlocoRaciocinioPolitica)
    );

    if (typeof ultimaIntencao !== "undefined") {
      ultimaIntencao = null;
    }
    // n√£o precisa mais de ultimaFuncaoOrigem, ent√£o nada pra resetar aqui

  } catch (e) {
    console.error("Erro ao registrar m√©trica de sa√≠da do bot:", e);
  }
}

window.renderBotMessage = renderBotMessage;

// ---- RELAT√ìRIO GERENCIAL LOOKER STUDIO EMBUTIDO NO CHAT (sem abrir nova aba)
window.vektorAbrirRelatorioGerencialNoChat = function () {
  try {
    // Mesmo comportamento do comando "abrir relat√≥rio gerencial..."
    renderBotMessage("HTML:" + htmlRelatorioGerencial);

    if (typeof scrollToBottom === "function") {
      setTimeout(scrollToBottom, 50);
    }
  } catch (e) {
    console.warn("Falha ao abrir relat√≥rio gerencial no chat:", e);
    renderBotMessage("N√£o consegui abrir o relat√≥rio gerencial no chat.");
  }
};

          // ========= EXPORTA√á√ÉO DE TABELA PARA CSV =========

  // Usado pelo bot√£o "‚¨á Exportar CSV" dentro das respostas com tabela.
  // IMPORTANTE: precisa estar dentro do document.addEventListener("DOMContentLoaded", ...)
  // e exposto em window para o onclick funcionar.
  window.exportTableToCSV = function(btn, defaultFileName) {
    try {
      // 1. Encontrar o container da mensagem do bot onde o bot√£o est√°
      var container = btn.closest(".bot-bubble");
      if (!container) {
        container = btn.closest("div");
      }

      if (!container) {
        alert("N√£o consegui localizar a tabela para exportar.");
        return;
      }

      // 2. Achar a tabela dentro dessa resposta
      var table = container.querySelector("table");
      if (!table) {
        alert("N√£o encontrei nenhuma tabela nessa resposta para exportar.");
        return;
      }

      // 3. Montar o CSV linha a linha
      var linhas = table.querySelectorAll("tr");
      var csvLinhas = [];

      for (var i = 0; i < linhas.length; i++) {
        var cols = linhas[i].querySelectorAll("th,td");
        var linhaCampos = [];
        for (var j = 0; j < cols.length; j++) {
          var texto = (cols[j].innerText || "").replace(/\s+/g, " ").trim();

          // Escapa aspas duplas
          texto = texto.replace(/"/g, '""');

          // Se tiver ;, quebra de linha ou aspas, envolve em aspas
          if (/[;"\n]/.test(texto)) {
            texto = '"' + texto + '"';
          }

          linhaCampos.push(texto);
        }

        // Usando ; como separador (mais comum no Excel PT-BR)
        csvLinhas.push(linhaCampos.join(";"));
      }

      var csv = csvLinhas.join("\n");

      // 4. Criar o arquivo e disparar o download
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var agora = new Date();
      var stamp = agora.toISOString().slice(0,19).replace(/[:T\-]/g,"");

      a.href = url;
      a.download = (defaultFileName || "exportacao") + "_" + stamp + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Erro ao exportar CSV:", e);
      alert("N√£o consegui gerar o CSV desta tabela.");
    }
  };


  function vektorFiltrarRelacaoSaldos(wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = document.getElementById("filtroRelacaoSaldosLoja");
    var selAcao = document.getElementById("filtroRelacaoSaldosAcao");

    var lojaVal = selLoja ? (selLoja.value || "") : "";
    var acaoVal = selAcao ? (selAcao.value || "") : "";

    var tbody = wrap.querySelector("tbody");
    if (!tbody) return;

    var trs = tbody.querySelectorAll("tr");
    trs.forEach(function(tr){
      var alias = tr.getAttribute("data-alias") || "";
      var acao  = tr.getAttribute("data-acao")  || "";

      var okLoja = !lojaVal || alias === lojaVal;
      var okAcao = !acaoVal || acao === acaoVal;

      tr.style.display = (okLoja && okAcao) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar rela√ß√£o de saldos:", e);
  }
}

// 1) FUN√á√ÉO DE FILTRAR (obrigat√≥ria)
window.vektorFiltrarRelacaoSaldos = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = document.getElementById("filtroRelacaoSaldosLoja");
    var selAcao = document.getElementById("filtroRelacaoSaldosAcao");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var acaoVal = selAcao ? (selAcao.value || "").trim() : ""; // "Aumentar" | "Manter" | "Reduzir"

    // Normaliza a sele√ß√£o de a√ß√£o para compara√ß√£o (base)
    var acaoValNorm = "";
    if (acaoVal) {
      var a = acaoVal.toLowerCase();
      if (a.indexOf("aumentar") === 0) acaoValNorm = "aumentar";
      else if (a.indexOf("reduzir") === 0) acaoValNorm = "reduzir";
      else if (a.indexOf("manter") === 0) acaoValNorm = "manter";
      else acaoValNorm = a; // fallback
    }

    var tbody = wrap.querySelector("tbody");
    if (!tbody) return;

    var trs = tbody.querySelectorAll("tr");
    trs.forEach(function (tr) {
      var alias = (tr.getAttribute("data-alias") || "").trim();

      // Pode vir "Aumentar (+R$...)" etc. Vamos pegar s√≥ a base.
      var acaoRaw = (tr.getAttribute("data-acao") || "").trim();
      var acaoNorm = "";
      if (acaoRaw) {
        var x = acaoRaw.toLowerCase();
        if (x.indexOf("aumentar") === 0) acaoNorm = "aumentar";
        else if (x.indexOf("reduzir") === 0) acaoNorm = "reduzir";
        else if (x.indexOf("manter") === 0) acaoNorm = "manter";
        else acaoNorm = x; // fallback
      }

      var okLoja = !lojaVal || alias === lojaVal;
      var okAcao = !acaoValNorm || acaoNorm === acaoValNorm;

      tr.style.display = (okLoja && okAcao) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar rela√ß√£o de saldos:", e);
  }
};

// 2) FUN√á√ÉO DE LIMPAR (mant√©m a sua, s√≥ garantindo window.)
window.vektorLimparFiltroRelacaoSaldos = function (wrapId) {
  try {
    var selLoja = document.getElementById("filtroRelacaoSaldosLoja");
    var selAcao = document.getElementById("filtroRelacaoSaldosAcao");
    if (selLoja) selLoja.value = "";
    if (selAcao) selAcao.value = "";

    window.vektorFiltrarRelacaoSaldos(wrapId);
  } catch (e) {
    console.error("Erro ao limpar filtro rela√ß√£o de saldos:", e);
  }
};

window.filtrarLojasOfensoras = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = document.getElementById("filtroOfensorLoja");
    var selTime = document.getElementById("filtroOfensorTime");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var timeVal = selTime ? (selTime.value || "").trim() : "";

    var tbody = wrap.querySelector("tbody");
    if (!tbody) return;

    var trs = tbody.querySelectorAll("tr");
    trs.forEach(function (tr) {
      var loja = (tr.getAttribute("data-loja") || "").trim();
      var time = (tr.getAttribute("data-time") || "").trim();

      var okLoja = !lojaVal || loja === lojaVal;
      var okTime = !timeVal || time === timeVal;

      tr.style.display = (okLoja && okTime) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar lojas ofensoras:", e);
  }
};

window.vektorAplicarFiltrosItensComprados = function (wrapId) {
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  const selStatus = wrap.querySelector('select[data-filtro="status"]');
  const chkReinc = wrap.querySelector('input[data-filtro="reinc"]');

  // ‚úÖ agora ser√£o MULTI (no item C), mas j√° deixo compat√≠vel:
  const selTime = wrap.querySelector('select[data-filtro="time"]');
  const selLoja = wrap.querySelector('select[data-filtro="loja"]');

  const statusFiltro = selStatus ? selStatus.value : "";
  const somenteReinc = !!(chkReinc && chkReinc.checked);

  const timesSel = selTime ? Array.from(selTime.selectedOptions).map(o => o.value).filter(Boolean) : [];
  const lojasSel = selLoja ? Array.from(selLoja.selectedOptions).map(o => o.value).filter(Boolean) : [];

  const trs = Array.from(wrap.querySelectorAll("tbody tr[data-status]"));

  // 1) aplica filtro nas linhas
  trs.forEach(tr => {
    const st = (tr.getAttribute("data-status") || "").toUpperCase();
    const reinc = tr.getAttribute("data-reinc") === "1";
    const t = (tr.getAttribute("data-time") || "");
    const l = (tr.getAttribute("data-loja") || "");

    let ok = true;

    if (statusFiltro && st !== statusFiltro) ok = false;
    if (somenteReinc && !reinc) ok = false;

    if (timesSel.length && !timesSel.includes(t)) ok = false;
    if (lojasSel.length && !lojasSel.includes(l)) ok = false;

    tr.style.display = ok ? "" : "none";
  });

  // 2) recalcula op√ß√µes dispon√≠veis (cascata)
  // base: linhas VIS√çVEIS ap√≥s filtros (exceto o pr√≥prio filtro do select que vamos recalcular)
  const visibleTrs = trs.filter(tr => tr.style.display !== "none");

  // Times dispon√≠veis com base nas lojas selecionadas (ou nas linhas vis√≠veis)
  if (selTime) {
    const setTimes = new Set();
    visibleTrs.forEach(tr => {
      const t = (tr.getAttribute("data-time") || "");
      if (t) setTimes.add(t);
    });

    // Rebuild options mantendo sele√ß√£o v√°lida
    const prev = new Set(timesSel);
    const opts = ["<option value=''>Todos</option>"]
      .concat(Array.from(setTimes).sort().map(t => {
        const sel = prev.has(t) ? " selected" : "";
        return `<option value="${t.replace(/"/g,'&quot;')}"${sel}>${t}</option>`;
      }));
    selTime.innerHTML = opts.join("");
  }

  if (selLoja) {
    const setLojas = new Set();
    visibleTrs.forEach(tr => {
      const l = (tr.getAttribute("data-loja") || "");
      if (l) setLojas.add(l);
    });

    const prev = new Set(lojasSel);
    const opts = ["<option value=''>Todas</option>"]
      .concat(Array.from(setLojas).sort().map(l => {
        const sel = prev.has(l) ? " selected" : "";
        return `<option value="${l.replace(/"/g,'&quot;')}"${sel}>${l}</option>`;
      }));
    selLoja.innerHTML = opts.join("");
  }
};

window.vektorLimparFiltrosItensComprados = function (wrapId) {
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  const selStatus = wrap.querySelector('select[data-filtro="status"]');
  const chkReinc  = wrap.querySelector('input[data-filtro="reinc"]');
  const selTime   = wrap.querySelector('select[data-filtro="time"]');
  const selLoja   = wrap.querySelector('select[data-filtro="loja"]');

  if (selStatus) selStatus.value = "";
  if (chkReinc) chkReinc.checked = false;

  // limpa multi-sele√ß√£o (se existir)
  if (selTime) Array.from(selTime.options).forEach(o => o.selected = false);
  if (selLoja) Array.from(selLoja.options).forEach(o => o.selected = false);

  window.vektorAplicarFiltrosItensComprados(wrapId);
};

// ========= DRILL-DOWN: EXPANDIR LINHA DA TABELA (com dropdown + mesmo per√≠odo) ========= //

window.vektorExpandirLinha = function (tr, base) {
  try {
    if (!tr || !tr.cells || !tr.cells.length) return;

    // Nome da linha (Time / Loja / Categoria / Estabelecimento)
    const chave = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    if (!chave) return;

    // Encontra o <select> relacionado ao drilldown
    const container = tr.closest("div");
    const select = container
      ? container.querySelector(".vektor-drill-select[data-base='" + base + "']")
      : null;

    const alvo = select ? select.value : null; // loja / categoria / estabelecimento / time

    // Per√≠odo da pergunta original (cache)
    const periodo = window.__vektorUltimoPeriodo || null;
    const dataInicioStr =
      periodo && periodo.dataInicio ? periodo.dataInicio.toISOString() : "";
    const dataFimStr =
      periodo && periodo.dataFim ? periodo.dataFim.toISOString() : "";

    let periodoTxt = "";
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      const di = periodo.dataInicio;
      const df = periodo.dataFim;
      periodoTxt =
        di.toLocaleDateString("pt-BR") + " a " + df.toLocaleDateString("pt-BR");
    }

    const tipo = "valor"; // padr√£o do drilldown

    // ================== BASE = TIME ==================
    if (base === "time") {
      // ‚ñº TIME ‚Üí LOJAS (padr√£o)
      if (alvo === "loja" || !alvo) {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>lojas</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            // topN null + forGroup=true => todas as lojas do time
            renderResumoTransacoesSemana(res, { topN: null, forGroup: true });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar por lojas.</p>"
            );
          })
          .getResumoTransacoesPorGrupo(chave, dataInicioStr, dataFimStr, tipo);
      }

      // ‚ñº TIME ‚Üí CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> do time <b>" + chave + "</b> " +
            (periodoTxt ? "no per√≠odo <b>" + periodoTxt + "</b>" : "") +
            "‚Ä¶</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias do time.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaTime(
            dataInicioStr,
            dataFimStr,
            tipo,   // "valor" ou "quantidade"
            chave   // nome do time
          );
      }

      // ‚ñº TIME ‚Üí ESTABELECIMENTOS
      else if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>estabelecimentos</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            chave, // grupo = time
            ""     // loja vazia
          );
      }

      return;
    }

    // ================== BASE = LOJA ==================
    if (base === "loja") {
      // ‚ñº LOJA ‚Üí ESTABELECIMENTOS
      if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando a loja <b>${chave}</b> por <b>estabelecimentos</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            "",
            chave // loja
          );
      }

      // ‚ñº LOJA ‚Üí CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> da loja <b>" + chave + "</b> " +
            (periodoTxt ? "no per√≠odo <b>" + periodoTxt + "</b>" : "") +
            "‚Ä¶</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias da loja.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaLoja(
            dataInicioStr,
            dataFimStr,
            tipo,     // "valor" ou "quantidade"
            chave     // c√≥digo/nome da loja
          );
      }

      return;
    }
  } catch (e) {
    console.error("Erro no vektorExpandirLinha:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Tive um problema ao tentar detalhar essa linha.</p>"
    );
  }
};

window.vektorDrillTransacoesCategoria = function (nomeCategoria) {
  try {
    if (!nomeCategoria) return;

    // Usa o √∫ltimo per√≠odo entendido pelo Vektor
    var periodo = window.__vektorUltimoPeriodo || null;
    var dataInicioStr = "";
    var dataFimStr    = "";

    if (periodo && periodo.dataInicio && periodo.dataFim) {
      dataInicioStr = periodo.dataInicio.toISOString();
      dataFimStr    = periodo.dataFim.toISOString();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a categoria <b>" + nomeCategoria + "</b> " +
        "pelas transa√ß√µes individuais no mesmo per√≠odo da consulta‚Ä¶</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          var html = vektorRenderTransacoesPorCategoria(res, nomeCategoria);
          if (html) {
            renderBotMessage("HTML:" + html);
          } else {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>" +
                "N√£o encontrei transa√ß√µes para essa categoria neste per√≠odo." +
              "</p>"
            );
          }
        } catch (e) {
          console.error("Erro ao renderizar transa√ß√µes por categoria:", e);
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "Falha ao detalhar as transa√ß√µes dessa categoria." +
            "</p>"
          );
        }
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script getTransacoesPorCategoria:", err);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "N√£o consegui consultar as transa√ß√µes dessa categoria agora." +
          "</p>"
        );
      })
      .getTransacoesPorCategoria(
        dataInicioStr,
        dataFimStr,
        nomeCategoria
      );

  } catch (e) {
    console.error("Erro geral em vektorDrillTransacoesCategoria:", e);
  }
};

window.vektorDrillTransacoesEstabelecimento = function (nomeEstab) {
  try {
    // Pega per√≠odo do cache global (mesma l√≥gica que voc√™ j√° usa em categorias)
    let dataInicioIso = "";
    let dataFimIso = "";

    if (window.__vektorUltimoPeriodo && window.__vektorUltimoPeriodo.dataInicio && window.__vektorUltimoPeriodo.dataFim) {
      dataInicioIso = window.__vektorUltimoPeriodo.dataInicio.toISOString();
      dataFimIso    = window.__vektorUltimoPeriodo.dataFim.toISOString();
    } else if (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio && window.__vektorUltimoPeriodoIso.fim) {
      dataInicioIso = window.__vektorUltimoPeriodoIso.inicio;
      dataFimIso    = window.__vektorUltimoPeriodoIso.fim;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Buscando transa√ß√µes do estabelecimento <b>" +
        nomeEstab +
      "</b> por loja no mesmo per√≠odo...</p>"
    );

    google.script.run
      .withSuccessHandler(function(res) {
        renderTransacoesEstabelecimentoPorLoja(res);
      })
      .withFailureHandler(function(err) {
        console.error("Erro ao buscar transa√ß√µes por estabelecimento:", err);
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o consegui carregar as transa√ß√µes desse estabelecimento agora.</p>");
      })
      .getTransacoesIndividuaisPorEstabelecimento(dataInicioIso, dataFimIso, nomeEstab);

  } catch (e) {
    console.error("Falha em vektorDrillTransacoesEstabelecimento:", e);
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao tentar expandir o estabelecimento.</p>");
  }
}

function renderTransacoesEstabelecimentoPorLoja(res) {
  if (!res || !res.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes para esse estabelecimento no per√≠odo.</p>"
    );
    return;
  }

  const linhas = res.linhas || [];
  if (!linhas.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes para esse estabelecimento no per√≠odo.</p>"
    );
    return;
  }

  // per√≠odo
  let periodoHtml = "";
  try {
    const di = res.dataInicioIso ? new Date(res.dataInicioIso) : null;
    const df = res.dataFimIso ? new Date(res.dataFimIso) : null;
    if (di && df && !isNaN(di.getTime()) && !isNaN(df.getTime())) {
      periodoHtml =
        "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
          "Per√≠odo da consulta: de " + di.toLocaleDateString("pt-BR") +
          " a " + df.toLocaleDateString("pt-BR") + "." +
        "</p>";
    }
  } catch (e) {}

  // monta tabela
  let html = [];
  html.push("<div class='text-sm text-slate-700'>");
  html.push("<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>Transa√ß√µes por loja ‚Äì " + (res.estabelecimento || "") + "</p>");
  html.push(periodoHtml);

  html.push("<div style='overflow-x:auto;'>");
  html.push("<table style='border-collapse:collapse;width:100%;font-size:12px;text-align:center;border:1px solid #000;'>");

  // ‚úÖ Valor (R$) movido para a √öLTIMA coluna
  html.push(
    "<thead><tr style='background:#06167d;color:#fff;'>" +
      "<th style='border:1px solid #000;padding:4px;'>Loja</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Estabelecimento</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Data</th>" +

      "<th style='border:1px solid #000;padding:4px;'>Titular</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Grupos</th>" +

      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Recibo</th>" +
      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Etiquetas</th>" +
      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Descri√ß√£o</th>" +

      "<th style='border:1px solid #000;padding:4px;'>Valor (R$)</th>" +
    "</tr></thead><tbody>"
  );

  let soma = 0;
  for (let i = 0; i < linhas.length; i++) {
    const l = linhas[i] || {};
    const valor = Number(l.valor || 0);
    soma += valor;

    // ‚úÖ Valor movido para o √öLTIMO <td>
    html.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.loja || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.estabelecimento || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.data || "") + "</td>" +

        "<td style='border:1px solid #000;padding:4px;'>" + (l.titular || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.grupos || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.recibo || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.etiquetas || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.descricao || "") + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
          valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
      "</tr>"
    );
  }

  // total (colspan continua correto: 8)
  html.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;padding:4px;' colspan='8'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
        soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  html.push("</tbody></table></div>");

  // bot√£o CSV abaixo (igual padr√£o)
  html.push(
    "<div style='margin-top:8px;text-align:right;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'transacoes_estabelecimento_por_loja')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "‚¨á Exportar CSV" +
      "</button>" +
    "</div>"
  );

  html.push("</div>");

  renderBotMessage("HTML:" + html.join(""));
}

    /* ========= NORMALIZA√á√ÉO ========= */
    function normalize(str) {
        return (str || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    // ================= VEKTOR ‚Äì bloco de racioc√≠nio da pol√≠tica =================

function vektorBlocoRaciocinioPolitica(explicacao, risco, referencia) {
  explicacao = explicacao || "Essa decis√£o segue as regras da pol√≠tica de uso dos cart√µes Clara.";
  risco = risco || "";

  // Garante refer√™ncia com fallback seguro
  if (typeof POLITICA_CARTOES_CLARA_LINK !== "undefined") {
    referencia = referencia || POLITICA_CARTOES_CLARA_LINK;
  } else {
    referencia = referencia || "#";
  }

  // Monta o ‚Äúcart√£o‚Äù de racioc√≠nio
  var html =
    "<div style='margin-top:6px;padding:8px;border-radius:6px;border:1px dashed #cbd5e1;background:#f8fafc;'>" +
      "<p style='font-size:14px;color:#0f172a;'><b>Segue minha an√°lise para o seu questionamento:</b></p><br>";

  // Aqui a explica√ß√£o j√° pode ser HTML completo (ex.: o bloco da categoria)
  html += explicacao;

  if (risco) {
    html +=
      "<p style='font-size:12px;color:#b91c1c;margin-top:4px;'><b>Risco:</b> " + risco + "</p>";
  }

  html +=
      "<p style='font-size:11px;color:#64748b;margin-top:6px;'>" +
        "Para detalhes completos, consulte a Pol√≠tica de Uso dos Cart√µes Clara: " +
        "<a href='" + referencia + "' target='_blank' style='color:#005E27;font-weight:600;'>abrir pol√≠tica</a>." +
      "</p>" +
    "</div>";

  // ‚ö†Ô∏è IMPORTANTE: prefixo "HTML:" para o renderBotMessage usar innerHTML
  return "HTML:" + html;
}

    // =============== MOTOR DE POL√çTICA POR CATEGORIA (SEM MCC AINDA) ===============

    // Encontra uma categoria de pol√≠tica a partir do nome
    function classificarCategoriaPolitica(nomeCategoria) {
      if (!nomeCategoria) return null;

      const normCat = normalize(nomeCategoria);
      if (!Array.isArray(POLITICA_CATEGORIA)) return null;

      // Busca por match exato no nome normalizado
      for (const regra of POLITICA_CATEGORIA) {
        if (!regra || !regra.categoria) continue;
        const normRegra = normalize(regra.categoria);
        if (normRegra === normCat) {
          return regra;
        }
      }

      return null;
    }

    // Avalia se uma categoria √© permitida / condicional / proibida
    function avaliarCategoriaPolitica(categoriaPolitica) {
      const regra = classificarCategoriaPolitica(categoriaPolitica);

      if (!regra) {
        return {
          decisao: "indefinido",
          idRegra: null,
          motivoTecnico: "Nenhuma regra espec√≠fica encontrada para essa categoria na matriz POLITICA_CATEGORIA.",
          mensagemUsuario:
            "Essa categoria n√£o est√° mapeada automaticamente no Vektor. Consulte a pol√≠tica oficial ou abra chamado no financeiro para an√°lise."
        };
      }

      if (regra.status === "permitido") {
        return {
          decisao: "permitido",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como liberada na pol√≠tica (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria de compra √© permitida pela pol√≠tica de uso dos cart√µes Clara, desde que o gasto seja necess√°rio para a opera√ß√£o da loja."
        };
      }

      if (regra.status === "condicional") {
        return {
          decisao: "condicional",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como sujeita √† an√°lise/libera√ß√£o pr√©via do financeiro (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria exige an√°lise e libera√ß√£o pr√©via do financeiro. Abra chamado no ServiceNow explicando a necessidade antes de concluir a compra."
        };
      }

      if (regra.status === "proibido") {
        return {
          decisao: "proibido",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como proibida na pol√≠tica (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria √© proibida pela pol√≠tica de uso dos cart√µes Clara. N√£o use o cart√£o Clara para esse tipo de despesa."
        };
      }

      // fallback defensivo
      return {
        decisao: "indefinido",
        idRegra: regra.idRegra,
        motivoTecnico: "Status de regra n√£o reconhecido: " + regra.status,
        mensagemUsuario:
          "N√£o consegui classificar essa categoria automaticamente. Consulte o financeiro ou a pol√≠tica oficial."
      };
    }

    // ===== TIMES OFICIAIS (para identificar "time X" / "grupo X") =====
const TIMES_OFICIAIS = [
  "√Åguias de Elite",
  "√Åguias do Cerrado",
  "Guardi√µes da Fronteira",
  "Esquadr√£o 40 Graus",
  "Esquadr√£o Valente",
  "Falc√µes SP",
  "Flechas do Norte",
  "Furac√£o Sul I",
  "Ultra High",
  "F√∫ria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Canga√ßo",
  "Legi√£o de Elite",
  "SULcesso"
];

// Usa a mesma normalize() do chat pra comparar mensagem x times
function encontrarTimeNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal);

  let melhorNome = null;
  let melhorScore = 0;

  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // separa em palavras e tira preposi√ß√µes/coisas fracas
    const tokens = nomeNorm
      .split(" ")
      .filter(t => {
          if (!t) return false;
          if (["do","da","de","dos","das","sp","sul"].includes(t)) return false;
          if (t.length < 3) return false; // elimina "i", "ii", etc.
          return true;
        });


    let score = 0;

    // se o nome completo aparecer, j√° d√° um boost forte
    if (texto.includes(nomeNorm)) {
      score += 100;
    }

    // +10 pra cada palavra relevante encontrada
    tokens.forEach(tok => {
      if (texto.includes(tok)) score += 10;
    });

    if (score > melhorScore) {
      melhorScore = score;
      melhorNome = nome;
    }
  });

  // se nada bateu, volta null
  return melhorNome;
}

function encontrarListaTimesNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");
  const encontrados = [];

  // Helper: escape para regex
  const _escRe_ = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

  // Helper: match por palavra inteira (evita "i" bater em "time", por exemplo)
  const _hasWord_ = (txt, w) => {
    if (!w) return false;
    return new RegExp("\\b" + _escRe_(w) + "\\b", "i").test(txt);
  };

  // Stopwords e tokens problem√°ticos
  const _stop = new Set([
    "do","da","de","dos","das","sp","sul",
    // romanos/curtos que geram falso positivo
    "i","ii","iii","iv","v","vi","vii","viii","ix","x"
  ]);

  // Percorre todos os times oficiais
  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // Tokens relevantes: remove stopwords e ignora tokens muito curtos (<=2)
    let tokens = nomeNorm
      .split(" ")
      .map(t => t.trim())
      .filter(t => t && !_stop.has(t) && t.length >= 3);

    // Se o usu√°rio digitou o nome completo do time
    const nomeCompletoNoTexto = texto.includes(nomeNorm);

    let score = 0;
    tokens.forEach((tk) => {
      if (_hasWord_(texto, tk)) score += 1;
    });

    // Regras de decis√£o:
    // - Nome completo no texto ‚Üí inclui
    // - 2+ tokens relevantes ‚Üí exige pelo menos 2 matches
    // - 1 token relevante ‚Üí exige match por palavra inteira
    const ok =
      nomeCompletoNoTexto ||
      (tokens.length >= 2 ? score >= 2 : score >= 1);

    if (ok) {
      encontrados.push(nome);
    }
  });

  return encontrados;
}

    /* ========= DADOS / TABELAS ========= */

    const etiquetasOficiais = [
  {
    nome: "MARKETING_PUBLICIDADE E PROPAGANDA",
    palavrasChave: [
      "marketing", "publicidade", "propaganda", "anuncio", "an√∫ncio", "facebook", "instagram", "insta", "face",
      "m√≠dia", "midia", "brinde", "campanha", "banner promocional", "campanhas", "banner", "baner",
      "impulsionamento", "divulga√ß√£o", "panfleto", "adesivo promocional", "social media", "instagram ads", "facebook ads", "promo√ß√£o local", "google ads", "tiktok ads", "youtube ads", "seo", "sem", "email marketing", "e-mail marketing", "inbound marketing", "outbound marketing", "influencer", "influenciadores", "parceria paga", "patrocinado", "stories", "feed", "design gr√°fico", "agencia de publicidade", "ag√™ncia de publicidade", "criacao de conteudo", "cria√ß√£o de conte√∫do", "material promocional", "folder", "cartaz", "outdoor", "tv paga", "revista", "jornal", "marketing digital", "alcance", "engajamento", "convers√£o", "leads", "pixel", "remarketing", "assessoria de imprensa", "rela√ß√µes p√∫blicas", "relacoes publicas", "assessoria"
    ],
    descricao:
      "A√ß√µes promocionais, compra de brindes, banners, impulsionamento de redes sociais, contrata√ß√£o de m√≠dia local.",
    observacaoUso: "Somente campanhas aprovadas pelo regional ou diretoria."
  },
  {
    nome: "TAXAS E EMOLUMENTOS",
    palavrasChave: [
      "taxa", "taxas", "emolumento", "emolumentos", "cartorio", "cart√≥rio",
      "certidao", "certid√£o", "registro", "segunda via documento", "aluguel",
      "documenta√ß√£o oficial", "taxa de servi√ßo", "honorarios", "honor√°rios"
    ],
    descricao:
      "Custos com registros, certid√µes, taxas cartoriais ou administrativas necess√°rias √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA",
    palavrasChave: [
      "detergente", "sabao", "sab√£o", "desinfetante", "alcool", "√°lcool", "pano", "rodo", "vassoura", "esponja", "papel toalha", "limpeza loja", "produto de limpeza", "desengordurante", "multiuso", "saco de lixo", "lixeira", "balde", "mop", "lustra moveis", "lustra m√≥veis", "cera", "removedor", "amaciante", "√°gua sanit√°ria", "agua sanitaria", "limpa vidros", "rasteio", "escova", "flanela", "aspirador", "sapon√°ceo", "sabonete", "dispenser", "tapete sanitizante", "sanitizante", "cloro", "alvejante", "luva", "mascara", "m√°scara", "limpeza do banheiro", "papel higi√™nico", "papel higienico", "aromatizador", "odorizador", "refil", "material de higiene", "higiene"
    ],
    descricao:
      "Materiais de limpeza e higiene da loja: detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE INFORM√ÅTICA",
    palavrasChave: [
      "mouse", "teclado", "teclado pdv", "cabo usb", "pendrive", "pen drive", "roteador", "hub usb", "fonte", "adaptador", "cabo rede", "cart√£o memoria", "cartao memoria", "extensor usb", "carregador", "suporte notebook", "monitor", "impressora", "cartucho", "toner", "cabo hdmi", "ssd", "hd", "memoria ram", "mem√≥ria ram", "headset", "scanner", "leitor de c√≥digo", "leitor de codigo", "mousepad", "modem", "placa de video", "placa de rede", "pilhas", "bateria", "no break", "nobreak", "filtro de linha", "perif√©rico", "periferico", "fone de ouvido", "fones", "fone"
    ],
    descricao:
      "Itens de inform√°tica de baixo valor: mouse, teclado, cabos, pendrives, fontes, roteadores, hubs USB, cart√µes de mem√≥ria.",
    observacaoUso: "N√£o cobre monitores, TVs ou equipamentos patrimoniais."
  },
  {
    nome: "MATERIAL DE ESCRIT√ìRIO",
    palavrasChave: [
      "caneta", "papel", "pasta", "bloco", "caderno", "etiqueta adesiva", "grampeador", "clips", "clipes", "organizador", "post-it", "marcador", "l√°pis", "lapis", "borracha", "corretivo", "tesoura", "r√©gua", "regua", "perfurador", "furador de papel", "cola", "fita adesiva", "fita durex", "envelope", "arquivo", "caixa arquivo", "separador de p√°gina", "separador de pagina",
      "carimbo", "tinta carimbo", "calculadora", "agenda", "calend√°rio", "calendario", "prancheta", "suporte de caneta", "porta-treco", "cartucho de tinta", "toner", "porta revista", "revisteiro", "apontador", "dicion√°rio", "dicionario", "impressos", "sulfite", "folha de sulfite", "folha A4", "folhas", "escada", "escadas"
    ],
    descricao:
      "Canetas, blocos, pap√©is, pastas, grampeadores, clipes, etiquetas adesivas, organizadores de mesa etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE COPA E COZINHA",
    palavrasChave: [
      "copo", "copos", "talher", "talheres", "garrafa termica", "garrafa t√©rmica",
      "pano prato", "pano de prato", "filtro de cafe", "filtro de caf√©",
      "pote", "potes", "pote plastico", "pote pl√°stico", "descartavel", 
    ],
    descricao:
      "Copos, talheres, filtros de caf√©, panos de prato, potes pl√°sticos, garrafas t√©rmicas.",
    observacaoUso: "N√£o cobre eletrodom√©sticos como cafeteiras ou micro-ondas."
  },
  {
    nome: "MATERIAL DE COPA E COZINHA OPERA√á√ïES",
    palavrasChave: ["cozinha loja", "utensilios loja", "material copa opera√ß√µes", "kit acrilico"],
    descricao: "Itens de copa/cozinha utilizados especificamente em opera√ß√µes.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA OPERA√á√ïES",
    palavrasChave: ["limpeza opera√ß√µes", "produto limpeza operacional"],
    descricao: "Materiais de limpeza voltados √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS OPERA√á√ïES",
    palavrasChave: ["banner", "adesivo", "flyer", "folder", "grafica", "impressao", "impress√£o", "impress√µes"],
    descricao: "Materiais gr√°ficos operacionais, banners e impress√µes.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO CIVIL",
    palavrasChave: [
      "parede", "porta", "vidro", "prateleira", "fechadura", "reparo loja",
      "conserto parede", "ajuste estrutura", "obra pequena"
    ],
    descricao:
      "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa).",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO ELETRICO",
    palavrasChave: [
      "tomada", "disjuntor", "interruptor", "reator", "soquete", "extensao",
      "fia√ß√£o", "fiacao", "el√©trico", "eletrico", "luz", "l√¢mpada", "lampada"
    ],
    descricao:
      "Troca de tomadas, disjuntores, interruptores, l√¢mpadas e pequenos reparos el√©tricos.",
    observacaoUso: "Apenas servi√ßos simples, sem necessidade de t√©cnico especializado."
  },
  {
    nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
    palavrasChave: [
      "conserto impressora", "ajuste maquina estampar", "reparo computador",
      "ferramenta manual", "manutencao equipamentos", "reparo t√©cnico"
    ],
    descricao:
      "Reparo de impressora, m√°quina de estampar e computador fora de garantia.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
    palavrasChave: [
      "ar condicionado", "ar-condicionado", "limpeza filtro", "carga gas",
      "controle remoto ar", "manuten√ß√£o ar", "reparo ar", "split"
    ],
    descricao:
      "Limpeza, carga de g√°s e pequenos ajustes em ar-condicionado.",
    observacaoUso: "N√£o cobre compra de novo aparelho."
  },
  {
    nome: "TRANSPORTE SERVICOS EMERGENCIAS",
    palavrasChave: [
      "motoboy", "moto boy", "entrega urgente", "frete", "documento matriz",
      "lalamove", "entrega loja", "envio urgente", "courier"
    ],
    descricao:
      "Frete emergencial local, motoboy ou entrega urgente entre lojas e matriz.",
    observacaoUso: "N√£o inclui transporte pessoal via aplicativos."
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
    palavrasChave: [
      "banner", "adesivo", "flyer", "folder", "encadernacao", "grafica", "impressao",
      "material visual", "cartaz", "copiadora"
    ],
    descricao:
      "Impress√µes, banners, adesivos, folders, encaderna√ß√µes e materiais visuais.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS DE LIMPEZA",
    palavrasChave: [
      "limpeza loja", "faxina", "servi√ßo limpeza", "limpeza extra", "empresa limpeza"
    ],
    descricao:
      "Contrata√ß√£o de servi√ßos de limpeza eventuais para manuten√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "CORREIOS_SEDEX/AR/POSTAGEM",
    palavrasChave: [
      "sedex", "correio", "postagem"
    ],
    descricao: "Envio de documentos f√≠sicos via Sedex, AR, ou devolu√ß√µes pequenas.",
    observacaoUso: ""
  },
  {
    nome: "LANCHES DE REFEI√á√ïES",
    palavrasChave: [
      "lanche", "coffee break", "caf√©", "bolo", "salgado", "biscoito", "refrigerante", "suco", "premia√ß√£o", "treinamento", "a√ß√£o interna", "almoco", "almo√ßo", "jantar", "pizza", "comida", "refeicao", "refei√ß√£o", "confraterniza√ß√£o", "confraternizacao", "evento interno", "kit lanche", "break", "doces", "chocolates", "frutas", "p√£o", "pao", "torta", "sandu√≠che", "sanduiche", "kit caf√©", "bebidas", "snacks", "celebracao", "celebra√ß√£o", "coquetel", "buffet", "catering", "alimentos",
  "compra de comida", "alimentacao", "alimenta√ß√£o", "workshop", "curso", "reuniao", "reuni√£o"
    ],
    descricao:
      "Lanches ou coffee break para treinamento interno, a√ß√£o aprovada ou premia√ß√£o.",
    observacaoUso: "N√£o cobre refei√ß√µes pessoais."
  },
  {
    nome: "AGUA POT√ÅVEL",
    palavrasChave: [
      "agua", "√°gua", "gal√£o", "galao", "garrafa agua", "garrafa de agua", "comprar agua", "comprar √°gua", "suprimento de √°gua", "reposi√ß√£o de √°gua", "barril de √°gua", "barril de agua", "√°gua mineral", "agua mineral", "bombona", "garraf√£o", "garrafao",
  "fornecedor de √°gua"
    ],
    descricao:
      "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe.",
    observacaoUso: ""
  },
  {
    nome: "BOBINA ECF",
    palavrasChave: [
      "bobina", "ecf", "cupom fiscal", "bobina impressora", "bobina pdv"
    ],
    descricao:
      "Bobinas para ECF / impressoras fiscais / PDV n√£o centralizados.",
    observacaoUso: ""
  },
  {
    nome: "CHAVEIRO EMERGENCIAL",
    palavrasChave: [
      "chaveiro", "abrir cofre", "abrir estoque", "trocar segredo", "sem chave", "cofre", "problema cofre", "problema fechadura", "fechadura", "perdi a chave", "esqueci a chave", "chave quebrada", "troca de chave", "fazer chave", "duplicata de chave", "copia de chave", "c√≥pia de chave", "abrir porta", "porta travada", "porta emperrada", "trancar", "trocar segredo",
      "segredo cofre", "abertura de cofre", "trocar fechadura", "concerto fechadura", "conserto fechadura", "consertar fechadura", "emerg√™ncia fechadura", "servi√ßo chaveiro", "mestre chaveiro", "tranca", "chaves", "cilindro", "miolo da chave", "reparar cofre", "reparo fechadura", "instalar fechadura"
    ],
    descricao:
      "Servi√ßo emergencial de chaveiro para abertura de cofres, vitrines e estoques.",
    observacaoUso: "Somente em emerg√™ncias operacionais."
  },
  {
    nome: "MANUTEN√á√ÉO MAQ ESTAMPAR",
    palavrasChave: [
      "estampar", "maquina estampar", "m√°quina estampar", "reparo estampar"
    ],
    descricao:
      "Reparos simples ou ajustes t√©cnicos em m√°quinas de estampar, sem controle patrimonial.",
    observacaoUso: ""
  }
];


    const perguntasGeraisEtiqueta = [
        "qual etiqueta devo usar","qual etiqueta usar","qual etiqueta eu uso",
        "que etiqueta devo usar","que etiqueta usar","que etiqueta eu uso",
        "me fala as etiquetas","me diz as etiquetas","me mostra as etiquetas",
        "me envia as etiquetas","me passa as etiquetas",
        "todas as etiquetas","lista de etiquetas","listagem de etiquetas",
        "quais etiquetas existem","quais etiquetas tem","quais sao as etiquetas",
        "quais s√£o as etiquetas","quais etiquetas posso usar",
        "quais etiquetas devo usar","quais etiquetas usar",
        "categorias de gasto","categorias de despesas","categoria de despesa",
        "categoria de gasto","categoria clara","etiqueta clara", "etiqueta", "etiquetas", "categoria"
    ].map(normalize);

    const frasesPolitica = [
        "me envia a politica","me envia a pol√≠tica","me manda a politica","me manda a pol√≠tica",
        "pol√≠tica de uso","politica de uso do cartao","pol√≠tica de uso do cart√£o", "politica", "pol√≠tica",
        "politica do cartao","pol√≠tica do cart√£o","politica do cartao clara","pol√≠tica do cart√£o clara",
        "pdf da politica","pdf da pol√≠tica","manual da politica","manual da pol√≠tica",
        "politica clara","pol√≠tica clara","politica de uso dos cartoes","pol√≠tica de uso dos cart√µes"
    ].map(normalize);

    const frasesTermo = [
        "termo de responsabilidade",
        "termo responsabilidade",
        "termo de responsabilidade do cartao",
        "termo de responsabilidade do cart√£o",
        "termo do cartao",
        "termo do cart√£o",
        "termo de uso do cartao",
        "termo de uso do cart√£o",
        "termo",
        "termo clara",
        "termo do cartao clara",
        "termo do cart√£o clara",
        "termo de aceite",
        "termo de aceite do cartao",
        "termo de aceite do cart√£o",
        "assinar termo do cartao",
        "assinar termo da clara",
        "termo de responsabilidade clara"
    ].map(normalize);

    const saudacoes = [
        "oi","ol√°","ola","opa","eai","e a√≠","iae","oi vektor","ola vektor","ol√° vektor", "bom dia","boa tarde","boa noite", "bom dia!", "boa tarde!", "boa noite!",
        "salve","fala","fala vektor","e a√≠ vektor","eai vektor","opa vektor", "tudo bem","td bem","tdb","como vai","como vc ta","como voce ta", "beleza","tranquilo","tudo certo", "como vai vc", "como vai voc√™", "como t√°", "como ta", "eae", "i ae"
    ].map(normalize);

    const frasesEncerramento = [
        "ok","okay","okey","certo","blz","beleza","ok valeu", "entendi","entendido","tudo certo","td certo","tds certo", "√© nois q t√°", "√© n√≥is", "tmj", "tamo junto", "gratidao", "t√° bom","ta bom","t√° √≥timo","ta otimo","t√° otimo", "muito obrigado", "muito obrigada", "gratid√£o", "show","show de bola","valeu","vlw","obrigado","obrigada", "grato", "grata", "agradessido", "agradecida", "agradecido","agradessida","tranquilo","de boa","suave", "thanks", "tks", "pode deixar","certinho","maravilha","perfeito","j√≥ia","joia", "joinha", "tmj cachorro", "supimpa", "excelente", "fantastico", "fant√°stico", "saquei"
    ].map(normalize);

    const termosPendencias = [
        "pendencia clara","pend√™ncias clara","pendencias clara",
        "bloqueio por pendencia","bloqueio por pend√™ncia",
        "pendencia do cartao","pend√™ncia do cart√£o",
        "loja bloqueada clara","cart√£o bloqueado por pendencia",
        "cobran√ßa clara","transa√ß√µes pendentes clara",
        "pendencia","pend√™ncia","pendencias","pend√™ncias"
    ].map(normalize);

    const palavrasMudancaAssunto = [
        "cartao","cart√£o","etiqueta","categoria","politica","pol√≠tica","sangria",
        "bloqueio","novo","pendencia","pend√™ncia","comprar","limite","uber",
        "agua","√°gua","lanche","fraude","contestacao","contesta√ß√£o","prestacao","presta√ß√£o"
    ].map(normalize);


    const gatilhosNovoCartao = [
        "quero solicitar um cartao",
        "quero solicitar um cart√£o",
        "novo cartao",
        "novo cart√£o",
        "cartao novo",
        "cart√£o novo",
        "quero solicitar cartao clara",
        "quero solicitar cart√£o clara",
        "quero pedir um cartao",
        "quero pedir um cart√£o",
        "quero pedir cartao clara",
        "quero pedir cart√£o clara",
        "quero cartao clara",
        "quero cart√£o clara",
        "preciso de um cartao",
        "preciso de um cart√£o",
        "preciso de cartao clara",
        "preciso de cart√£o clara",
        "nao tenho cartao clara ainda",
        "n√£o tenho cartao clara ainda",
        "nao tenho cart√£o clara ainda",
        "ainda nao tenho cartao clara",
        "ainda n√£o tenho cart√£o clara",
        "como pedir cartao",
        "como pedir cart√£o",
        "como solicitar cartao",
        "como solicitar cart√£o",
        "como conseguir um cartao clara",
        "como conseguir um cart√£o clara",
        "fui promovido e nao tenho cartao",
        "fui promovido e n√£o tenho cart√£o",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e n√£o tenho cart√£o",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e n√£o tenho cart√£o",
        "primeira via do cartao",
        "primeira via do cart√£o",
        "1a via do cartao",
        "1¬™ via do cartao",
        "1a via do cart√£o",
        "1¬™ via do cart√£o",
        "preciso solicitar um cartao",
        "preciso solicitar um cart√£o",
        "gostaria de solicitar um cartao",
        "gostaria de solicitar um cart√£o",
        "quero novo cartao",
        "quero novo cart√£o",
        "preciso novo cartao",
        "preciso novo cart√£o",
        "nao tenho cartao",
        "n√£o tenho cart√£o",
        "nunca tive cartao",
        "nunca tive cart√£o"
    ].map(normalize);

    const termosPrimeiraViaDireta = [
        "primeira via",
        "1 via",
        "1a via",
        "1¬™ via",
        "primeiro cartao",
        "primeiro cart√£o",
        "meu primeiro cartao",
        "meu primeiro cart√£o",
        "nunca tive cartao clara",
        "nunca tive cart√£o clara",
        "quero minha primeira via",
        "quero 1 via",
        "pedir primeira via",
        "solicitar primeira via"
    ].map(normalize);

    const gatilhosSegundaViaDireta = [
        "segunda via",
        "2 via",
        "2a via",
        "2¬™ via",
        "segunda via",
        "segunda bia",
        "segundavia",
        "segunda vias",
        "segundas via",
        "segundas vias",
        "reemitir cartao",
        "reemitir cart√£o",
        "reemissao cartao",
        "reemissao de cartao",
        "reemissao de cartao",
        "reemiss√£o cart√£o",
        "reemitir meu cartao",
        "reemitir meu cart√£o",
        "perdi o cartao",
        "perdi o cart√£o",
        "perdi meu cartao",
        "perdi meu cart√£o",
        "perdi o meu cart√£o",
        "perdi o meu cartao",
        "eu perdi o cart√£o",
        "eu perdi o cartao",
        "percas de cartao",
        "perca de cart√£o",
        "perca de cartao",
        "perda de cartao",
        "perda de cart√£o",
        "solicitar segunda via",
        "solicitar 2via",
        "solicitar 2 via",
        "solicita√ß√£o de segunda via",
        "solicita√ß√£o de 2 via",
        "roubaram meu cartao",
        "roubaram meu cart√£o",
        "me roubaram",
        "mi roubaram",
        "fui roubado",
        "cartao furtado",
        "furto",
        "cart√£o furtado",
        "roubo",
        "roubo de cart√£o",
        "perda de cart√£o",
        "perca de cart√£o",
        "cartao quebrado",
        "cart√£o quebrado",
        "cartao danificado",
        "cart√£o danificado"
    ].map(normalize);

    const perguntasGeraisOquePosso = [
        "o que posso comprar",
        "oq comprar com o cart√£o da Clara",
        "o que pode comprar",
        "o que pode comprar com o cart√£o",
        "o que pode comprar com o cartao",
        "oque comprar",
        "o que comprar",
        "posso comprar o que",
        "o que posso usar",
        "quais compras",
        "o que √© permitido",
        "o que nao posso",
        "o que n√£o posso",
        "o que nao posso comprar",
        "o que n√£o posso comprar",
        "o que nao comprar",
        "o que n√£o comprar"
    ].map(normalize);

    /* ========= INTEN√á√ÉO ========= */

    function detectarIntencaoPergunta(msgNorm) {
        // garante que msgNorm √© sempre string e cria um alias "norm"
      msgNorm = msgNorm || "";
      const norm = msgNorm;

      // RESPOSTAS SOBRE O QUE O VEKTOR FAZ
if (
    msgNorm.includes("o que voce faz") ||
    msgNorm.includes("o que voce pode fazer") ||
    msgNorm.includes("o que o vektor pode fazer") ||
    msgNorm.includes("pra que serve") ||
    msgNorm.includes("qual sua fun√ß√£o") ||
    msgNorm.includes("quem √© voc√™") ||
    msgNorm.includes("quem e voce") ||
    msgNorm.includes("qual o seu nome") ||
    msgNorm.includes("me explique o que faz") ||
    msgNorm.includes("sobre o que voce fala") ||
    msgNorm.includes("sobre o que voc√™ fala")
) {
    return "sobreBot";
}

  const foraEscopoPadroes = [
    "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
    "presidente","futebol","time joga","campeonato","xing","vai tomar",
    "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
    "piada","xingar","palavr√£o","palavrao"
  ];
  for (const termo of foraEscopoPadroes) {
    if (msgNorm.includes(normalize(termo))) {
      return "foraEscopo";
    }
  }

  if (
    msgNorm.includes("etiqueta") ||
    msgNorm.includes("etiquetas") ||
    msgNorm.includes("qual etiqueta") ||
    msgNorm.includes("que etiqueta")
  ) {
    return "etiqueta";
  }

    // üîπ Perguntas sobre "quais chamados / procedimentos existem no ServiceNow para a Clara"
  const falaServiceNow =
    msgNorm.includes("servicenow") ||
    msgNorm.includes("service now");

  const falaChamado =
    msgNorm.includes("chamado") ||
    msgNorm.includes("chamados") ||
    msgNorm.includes("ticket") ||
    msgNorm.includes("solicitacao") ||
    msgNorm.includes("solicita√ß√£o") ||
    msgNorm.includes("solicitacoes") ||
    msgNorm.includes("solicita√ß√µes") ||
    msgNorm.includes("procedimento") ||
    msgNorm.includes("procedimentos");

    const falaClara =
    msgNorm.includes("clara") ||
    msgNorm.includes("cartao") ||
    msgNorm.includes("cart√£o") ||
    msgNorm.includes("fatura") ||
    msgNorm.includes("cartoes") ||
    msgNorm.includes("cart√µes");

  if (
    (falaServiceNow && falaChamado && falaClara) ||
    // NOVO IF (Condi√ß√£o OU): Service Now E Chamado
    (falaServiceNow && falaChamado) ||
    

    // alguns atalhos mais diretos, caso a pessoa n√£o escreva "clara"
    msgNorm.includes("procedimentos servicenow") ||
    msgNorm.includes("tipos de chamado da clara") ||
    msgNorm.includes("tipos de chamado clara") ||
    msgNorm.includes("chamados da clara no servicenow")
  ) {
    return "procedimentosServiceNow";
  }

    // se falar de ServiceNow + (chamado OU Clara), j√° manda pra procedimentosServiceNow
  if (falaServiceNow && (falaChamado || falaClara)) {
    return "procedimentosServiceNow";
  }

  // tamb√©m aceita frases mais simples tipo "como abrir chamado no servicenow"
  if (falaServiceNow && norm.includes("abrir") && norm.includes("chamado")) {
    return "procedimentosServiceNow";
  }

  // fallback suave: se a pessoa s√≥ digita "servicenow" ou algo muito curto com o nome,
// tamb√©m manda para os procedimentos do ServiceNow.
if (falaServiceNow && !falaChamado) {
  return "procedimentosServiceNow";
}

 // 4) Troca / afastamento / demiss√£o de gerente, uso de cart√£o de outra loja
  const falaTrocaGerente =
    norm.includes("mudar de loja") ||
    norm.includes("mudanca de loja") ||
    norm.includes("mudan√ßa de loja") ||
    norm.includes("troca de loja") ||
    norm.includes("trocar de loja") ||
    norm.includes("vou mudar de loja") ||
    norm.includes("fui transferido") ||
    norm.includes("fui transferida") ||
    norm.includes("transferido de loja") ||
    norm.includes("transferida de loja") ||
    norm.includes("transferencia de loja") ||
    norm.includes("transfer√™ncia de loja") ||
    norm.includes("mudei de loja") ||          // <<< ESSA AQUI ESTAVA FALTANDO PRA SUA FRASE
    norm.includes("mudei de unidade") ||
    norm.includes("trocar de unidade") ||
    norm.includes("troquei de loja") ||
    norm.includes("sou de outra loja") ||
    norm.includes("sou de outra unidade") ||

    norm.includes("gerente desligado") ||
    norm.includes("sem gerente") ||
    norm.includes("gerente saiu") ||
    norm.includes("gerente saiu da loja") ||
    norm.includes("gerente demitido") ||
    norm.includes("gerente demitida") ||
    norm.includes("gerente foi desligado") ||
    norm.includes("gerente foi desligada") ||
    norm.includes("minha loja esta sem gerente") ||
    norm.includes("minha loja est√° sem gerente") ||

    norm.includes("gerente afastado") ||
    norm.includes("gerente afastada") ||
    norm.includes("afastamento do gerente") ||
    norm.includes("gerente de ferias") ||
    norm.includes("gerente de f√©rias") ||
    norm.includes("gestor de ferias") ||
    norm.includes("gestor de f√©rias") ||

    norm.includes("gerente novo") ||
    norm.includes("novo gerente") ||
    norm.includes("novo gerente da loja") ||
    norm.includes("troca de gerente") ||
    norm.includes("troca do gerente") ||

    norm.includes("cartao de outra loja") ||
    norm.includes("cart√£o de outra loja") ||
    norm.includes("usar cartao de outra loja") ||
    norm.includes("usar cart√£o de outra loja") ||
    norm.includes("colocar cartao de outra loja") ||
    norm.includes("habilitar cartao de outra loja") ||
    norm.includes("como uso o cartao em outra loja") ||
    norm.includes("cartao nao funciona em outra loja") ||
    norm.includes("cart√£o n√£o funciona em outra loja");

  if (falaTrocaGerente) {
    return "trocaGerente";
  }


  if (
    msgNorm.includes("aumentar limite") ||
    msgNorm.includes("aumento de limite") ||
    msgNorm.includes("limite maior") ||
    msgNorm.includes("limite do cartao") ||
    msgNorm.includes("limite do cart√£o") ||
    msgNorm.includes("limite nao basta") ||
    msgNorm.includes("limite n√£o basta") ||
    msgNorm.includes("limite acabou") ||
    msgNorm.includes("limite estourou") ||
    msgNorm.includes("quero mais limite") ||
    msgNorm.includes("preciso de mais limite") ||
    msgNorm.includes("como aumentar meu limite") ||
    msgNorm.includes("solicitar aumento de limite") ||
    msgNorm.includes("limite baixo") ||
    msgNorm.includes("qual o limite do cartao") ||
    msgNorm.includes("qual o limite do cart√£o") ||
    msgNorm.includes("meu limite") ||
    msgNorm.includes("consultar limite") ||
    msgNorm.includes("ver limite") ||
    msgNorm.includes("quanto tenho de limite") ||
    msgNorm.includes("limite disponivel") ||
    msgNorm.includes("limite dispon√≠vel") ||
    msgNorm.includes("baixar limite") ||
    msgNorm.includes("diminuir limite") ||
    msgNorm.includes("limite de credito") ||
    msgNorm.includes("limite de cr√©dito") ||
    msgNorm.includes("limite total") ||
    msgNorm.includes("limite nao liberado") ||
    msgNorm.includes("limite n√£o liberado") ||
    msgNorm.includes("limite acabou de novo") ||
    msgNorm.includes("por que meu limite nao aumenta") ||
    msgNorm.includes("por que meu limite n√£o aumenta") ||
    msgNorm.includes("limite esgotado") ||
    msgNorm.includes("gastei o limite todo") ||
    msgNorm.includes("aumento de credito") ||
    msgNorm.includes("aumento de cr√©dito") ||
    msgNorm.includes("ajustar limite") ||
    msgNorm.includes("liberar mais limite") ||
    msgNorm.includes("limite")
  ) {
    return "limite";
  }

  // üîπ Transa√ß√£o negada / categoria bloqueada para compra
  if (
    msgNorm.includes("transacao negada") ||
    msgNorm.includes("transa√ß√£o negada") ||
    msgNorm.includes("transacao recusada") ||
    msgNorm.includes("transa√ß√£o recusada") ||
    msgNorm.includes("compra negada") ||
    msgNorm.includes("compra recusada") ||
    msgNorm.includes("compra foi recusada") ||
    msgNorm.includes("compra rejeitada") ||
    msgNorm.includes("compra nao passou") ||
    msgNorm.includes("compra n√£o passou") ||
    msgNorm.includes("compra nao autorizada") ||
    msgNorm.includes("compra n√£o autorizada") ||
    msgNorm.includes("transacao nao autorizada") ||
    msgNorm.includes("transa√ß√£o n√£o autorizada") ||
    msgNorm.includes("transacao bloqueada") ||
    msgNorm.includes("transa√ß√£o bloqueada") ||
    msgNorm.includes("cartao nao passou") ||
    msgNorm.includes("cart√£o n√£o passou") ||
    msgNorm.includes("cartao recusado") ||
    msgNorm.includes("cart√£o recusado") ||
    msgNorm.includes("cartao negado") ||
    msgNorm.includes("cart√£o negado") ||
    msgNorm.includes("cartao nao autorizou") ||
    msgNorm.includes("cart√£o n√£o autorizou") ||
    msgNorm.includes("cartao travou na maquininha") ||
    msgNorm.includes("cartao travou na m√°quina") ||
    msgNorm.includes("cartao travou") ||
    msgNorm.includes("cart√£o travou") ||
    msgNorm.includes("nao passou o cartao") ||
    msgNorm.includes("n√£o passou o cart√£o") ||
    msgNorm.includes("nao autorizou a compra") ||
    msgNorm.includes("n√£o autorizou a compra") ||
    msgNorm.includes("recusou a compra") ||
    msgNorm.includes("recusou o pagamento") ||
    msgNorm.includes("falha na compra") ||
    msgNorm.includes("falha de pagamento") ||
    msgNorm.includes("erro na compra") ||
    msgNorm.includes("erro de pagamento") ||
    msgNorm.includes("erro no cartao") ||
    msgNorm.includes("erro no cart√£o") ||
    msgNorm.includes("compra deu erro") ||
    msgNorm.includes("pagamento negado") ||
    msgNorm.includes("pagamento recusado") ||
    msgNorm.includes("pagamento bloqueado") ||
    msgNorm.includes("categoria bloqueada") ||
    msgNorm.includes("categoria bloqueado") ||
    msgNorm.includes("categoria nao liberada") ||
    msgNorm.includes("tentando usar o cart√£o") ||
    msgNorm.includes("tentando usar o cartao") ||
    msgNorm.includes("categoria n√£o liberada") ||
    msgNorm.includes("liberar categoria") ||
    msgNorm.includes("liberacao de categoria") ||
    msgNorm.includes("tentei passar o cart√£o e deu erro") ||
    msgNorm.includes("tentar passar o cart√£o") ||
    msgNorm.includes("tentar passar o cartao") ||
    msgNorm.includes("tentar usar o cartao") ||
    msgNorm.includes("tentar usar o cart√£o") ||
    msgNorm.includes("tentei passar o cartao e deu erro") ||
    msgNorm.includes("a compra foi recusada na maquininha") ||
    msgNorm.includes("n√£o consegui usar o cart√£o") ||
    msgNorm.includes("n√£o consegui usar o cartao") ||
    msgNorm.includes("nao consegui usar o cartao") ||
    msgNorm.includes("libera√ß√£o de categoria") ||
    msgNorm.includes("mcc bloqueado") ||
    msgNorm.includes("codigo bloqueado") ||
    msgNorm.includes("c√≥digo bloqueado") ||
    msgNorm.includes("nao liberou") ||
    msgNorm.includes("n√£o liberou") ||
    msgNorm.includes("nao conseguiu passar") ||
    msgNorm.includes("n√£o conseguiu passar") ||
    msgNorm.includes("nao consegui usar") ||
    msgNorm.includes("n√£o consegui usar") ||
    msgNorm.includes("tentei usar e nao foi") ||
    msgNorm.includes("tentei usar e n√£o foi") ||
    msgNorm.includes("tentei comprar e deu erro") ||
    msgNorm.includes("tentou passar e nao foi") ||
    msgNorm.includes("tentou passar e n√£o foi") ||
    msgNorm.includes("nao aceitou") ||
    msgNorm.includes("n√£o aceitou") ||
    msgNorm.includes("nao deu certo a compra") ||
    msgNorm.includes("n√£o deu certo a compra") ||
    msgNorm.includes("bloqueou a compra") ||
    msgNorm.includes("bloqueou a transacao") ||
    msgNorm.includes("bloqueou a transa√ß√£o") ||
    msgNorm.includes("compra nao permitida") ||
    msgNorm.includes("compra n√£o permitida") ||
    msgNorm.includes("transacao nao permitida") ||
    msgNorm.includes("transa√ß√£o n√£o permitida")
  ) {
    return "transacaoNegadaCategoria";
  }

  if (
    msgNorm.includes("bloqueou") ||
    msgNorm.includes("bloqueado") ||
    msgNorm.includes("desbloquear") ||
    msgNorm.includes("cartao travou") ||
    msgNorm.includes("cart√£o travou") ||
    msgNorm.includes("travou o cartao") ||
    msgNorm.includes("travou o cart√£o") ||
    msgNorm.includes("bloquear cartao") ||
    msgNorm.includes("bloquear cart√£o") ||
    msgNorm.includes("queria bloquear") ||
    msgNorm.includes("quero bloquear") ||
    msgNorm.includes("como bloquear") ||
    msgNorm.includes("cartao bloqueado") ||
    msgNorm.includes("cart√£o bloqueado") ||
    msgNorm.includes("meu cartao nao funciona") ||
    msgNorm.includes("meu cart√£o n√£o funciona") ||
    msgNorm.includes("meu cart√£o t√° bloqueado") ||
    msgNorm.includes("pq meu cart√£o t√° bloqueadp") ||
    msgNorm.includes("pq meu cart√£o t√° bloqueado") ||
    msgNorm.includes("meu cartao ta bloqueado") ||
    msgNorm.includes("nao consigo usar o cartao") ||
    msgNorm.includes("n√£o consigo usar o cart√£o") ||
    msgNorm.includes("problema no cartao") ||
    msgNorm.includes("problema no cart√£o") ||
    msgNorm.includes("suspender cartao") ||
    msgNorm.includes("suspender cart√£o") ||
    msgNorm.includes("suspender o uso") ||
    msgNorm.includes("o cartao parou") ||
    msgNorm.includes("o cart√£o parou") ||
    msgNorm.includes("ativar cartao") ||
    msgNorm.includes("ativar cart√£o") ||
    msgNorm.includes("reativar cartao") ||
    msgNorm.includes("reativar cart√£o") ||
    msgNorm.includes("travamento") ||
    msgNorm.includes("por que nao funciona") ||
    msgNorm.includes("por que n√£o funciona") ||
    msgNorm.includes("desliguei o cartao") ||
    msgNorm.includes("desliguei o cart√£o") ||
    msgNorm.includes("bloqueio preventivo")
  ) {
    return "bloqueio";
  }

  // -------------------------------------------------------------
// RESPOSTAS DE JUSTIFICATIVAS / NOTAS / PERDA DE COMPROVANTE
// -------------------------------------------------------------
if (
  msgNorm.includes("como justificar") ||
  msgNorm.includes("v√≠deo de justificativa") ||
  msgNorm.includes("video de justificativa") ||
  msgNorm.includes("v√≠deo de justificativas") ||
  msgNorm.includes("video de justificativas") ||
  msgNorm.includes("como justificar essa compra") ||
  msgNorm.includes("como envio comprovante?") ||
  msgNorm.includes("justificar compra") ||
  msgNorm.includes("prestar contas") ||
  msgNorm.includes("prestacao de contas") ||
  msgNorm.includes("presta√ß√£o de contas") ||
  msgNorm.includes("colocar nota") ||
  msgNorm.includes("inserir nota") ||
  msgNorm.includes("anexar nota") ||
  msgNorm.includes("descricao na clara") ||
  msgNorm.includes("como inserir nota") ||
  msgNorm.includes("nota fiscal") ||
  msgNorm.includes("como lan√ßar despesas na clara?") ||
  msgNorm.includes("nota da compra") ||
  msgNorm.includes("escrever justificativa") ||
  msgNorm.includes("como colocar justificativa") ||
  msgNorm.includes("comprovante") ||
  msgNorm.includes("comprovantes") ||
  msgNorm.includes("comprovante de compra") ||
  msgNorm.includes("comprovacao de despesa") ||
  msgNorm.includes("comprova√ß√£o de despesa") ||
  msgNorm.includes("registro de despesa") ||
  msgNorm.includes("lan√ßar despesa") ||
  msgNorm.includes("lancamento de despesa") ||
  msgNorm.includes("lan√ßamento de despesa") ||
  msgNorm.includes("reembolso sem nota") ||
  msgNorm.includes("perdi a nota") ||        // << IMPORTANTE
  msgNorm.includes("despesa sem comprovante") ||
  msgNorm.includes("colocar comprovante") ||
  msgNorm.includes("como declarar") ||
  msgNorm.includes("declarar despesa") ||
  msgNorm.includes("como finalizar prestacao") ||
  msgNorm.includes("como finalizar presta√ß√£o") ||
  msgNorm.includes("relatorio de despesa") ||
  msgNorm.includes("relat√≥rio de despesa") ||
  msgNorm.includes("enviar nota") ||
  msgNorm.includes("falta a nota") ||
  msgNorm.includes("despesa sem nota") ||
  msgNorm.includes("finalizar contas") ||
  msgNorm.includes("minhas prestacoes") ||
  msgNorm.includes("minhas presta√ß√µes") ||
  msgNorm.includes("descri√ß√£o na clara")
) {

  // 1. Mensagem bem espec√≠fica caso tenha perdido a nota
  if (
    msgNorm.includes("perdi a nota") ||
    msgNorm.includes("falta a nota") ||
    msgNorm.includes("despesa sem nota") ||
    msgNorm.includes("despesa sem comprovante")
  ) {
    renderBotMessage("HTML:" +
      `<p class="text-sm text-slate-700">
        Quando a loja perde a nota fiscal, deve abrir uma <b>ocorr√™ncia formal de extravio</b> e anexar esse documento no app da Clara, como justificativa da transa√ß√£o. O financeiro ir√° avaliar o caso. Ocorr√™ncias recorrentes podem gerar recusa definitiva.
      </p>`
    );
  } else {
    // 2. Mensagem geral de justificativa
    renderBotMessage("HTML:" +
      `<p class="text-sm text-slate-700">
        Para justificar uma compra no app da Clara, basta abrir a transa√ß√£o, escrever a descri√ß√£o e anexar o comprovante ou nota fiscal correspondente.
      </p>`
    );
  }

  // 3. Enviar automaticamente o v√≠deo de justificativas
  const videoHtml = [
  "<div style='margin-top:8px; text-align:center;'>",
  "  <p class='text-sm text-slate-700' style='text-align:center;'>",
  "    Assista ao v√≠deo abaixo, explicando sobre o procedimento de justificativas no app da Clara.",
  "    Clique nos 3 pontos do lado direito inferior e escolha ",
  "    <b style='color:#005E27;'>Picture-in-picture</b> ",
  "    para ver em um formato melhor:",
  "  </p>",
  "  <div style='width:100%; display:flex; justify-content:center; margin-top:12px;'>",
  "    <video controls style='width:100%; max-width:480px; border-radius:8px; object-fit:contain;'>",
  "      <source src='https://raw.githubusercontent.com/rslisboa/cartoesclara/4fad8ce4eda430baf37ecccd7d480a77f759af27/Video%20Clara%20(4).mp4' type='video/mp4'>",
  "      Seu navegador n√£o suporta v√≠deo HTML5.",
  "    </video>",
  "  </div>",
  "</div>"
].join("");

  renderBotMessage("HTML:" + videoHtml);
  return null;
}

  if (
    msgNorm.includes("lanche") ||
    msgNorm.includes("lanche pro time") ||
    msgNorm.includes("lanche para o time") ||
    msgNorm.includes("cafe pro time") ||
    msgNorm.includes("caf√© pro time") ||
    msgNorm.includes("coffee break") ||
    msgNorm.includes("agua") ||
    msgNorm.includes("√°gua") ||
    msgNorm.includes("gal√£o") ||
    msgNorm.includes("galao") ||
    msgNorm.includes("premiacao") ||
    msgNorm.includes("premia√ß√£o")
  ) {
    return "alimentoTime";
  }

  if (
    msgNorm.includes("uber") ||
    msgNorm.includes("iber") ||
    msgNorm.includes(" 99") ||
    msgNorm.includes("taxi") ||
    msgNorm.includes("t√°xi") ||
    msgNorm.includes("tax√≠") ||
    msgNorm.includes("cabify") ||
    msgNorm.includes("transporte") ||
    msgNorm.includes("aplicativo de transporte") ||
    msgNorm.includes("motorista de aplicativo") ||
    msgNorm.includes("carro por app") ||
    msgNorm.includes("carona") ||
    msgNorm.includes("como chamar um carro") ||
    msgNorm.includes("como pedir um carro") ||
    msgNorm.includes("uber black") ||
    msgNorm.includes("uber x") ||
    msgNorm.includes("99 pop") ||
    msgNorm.includes("99taxi") ||
    msgNorm.includes("uber drive") ||
    msgNorm.includes("uber motorista") ||
    msgNorm.includes("uber pass") ||
    msgNorm.includes("uber eats") ||
    msgNorm.includes("servi√ßo de transporte") ||
    msgNorm.includes("qual app de carro") ||
    msgNorm.includes("motorista particular") ||
    msgNorm.includes("drive") ||
    msgNorm.includes("drivi") ||
    msgNorm.includes("indriver") ||
    msgNorm.includes("in driver") ||
    msgNorm.includes("waze carpool") ||
    msgNorm.includes("waze car pool") ||
    msgNorm.includes("taxi particular") ||
    msgNorm.includes("taxi 99") ||
    msgNorm.includes("app de taxi") ||
    msgNorm.includes("app de t√°xi") ||
    msgNorm.includes("app de transporte")
  ) {
    return "transportePessoal";
  }

  const temGerenteOuGestor =
  msgNorm.includes("gerente") ||
  msgNorm.includes("gerentes") ||
  msgNorm.includes("gestor") ||
  msgNorm.includes("gestora");

const temFerias =
  msgNorm.includes("ferias"); // j√° est√° normalizado sem acento

const temAfastamento =
  msgNorm.includes("afastado")  ||
  msgNorm.includes("afastada")  ||
  msgNorm.includes("afastados") ||
  msgNorm.includes("afastadas") ||
  msgNorm.includes("afastamento");

const temDesligamento =
  msgNorm.includes("desligado")  ||
  msgNorm.includes("desligada")  ||
  msgNorm.includes("demitido")   ||
  msgNorm.includes("demitida")   ||
  msgNorm.includes("demissao")   ||
  msgNorm.includes("demiss√£o");

if (
  // seus casos antigos de troca de loja, cart√£o de outra loja, etc...
  msgNorm.includes("mudar de loja") ||
  msgNorm.includes("troca de loja") ||
  // ... (mantenha o que j√° tem aqui)

  // gerente de f√©rias / gestor de f√©rias
  (temGerenteOuGestor && temFerias) ||

  // gerente afastado / afastamento do gerente
  (temGerenteOuGestor && temAfastamento) ||

  // gerente foi desligado / demitido
  (temGerenteOuGestor && temDesligamento)
) {
  return "trocaGerente";
}

  if (
    msgNorm.includes("sangria") ||
    msgNorm.includes("sangrias") ||
    msgNorm.includes("fazer sangria") ||
    msgNorm.includes("puxar dinheiro do caixa") ||
    msgNorm.includes("retirar dinheiro do caixa") ||
    msgNorm.includes("tirar dinheiro do caixa") ||
    msgNorm.includes("retirada de dinheiro do caixa") ||
    msgNorm.includes("movimentacao de dinheiro no caixa") ||
    msgNorm.includes("movimenta√ß√£o de dinheiro no caixa") ||
    msgNorm.includes("fechar o caixa") ||
    msgNorm.includes("como fechar o caixa") ||
    msgNorm.includes("retirar valor do caixa") ||
    msgNorm.includes("como fazer sangria") ||
    msgNorm.includes("registrar saida de dinheiro") ||
    msgNorm.includes("registrar sa√≠da de dinheiro") ||
    msgNorm.includes("saida de dinheiro do caixa") ||
    msgNorm.includes("sa√≠da de dinheiro do caixa") ||
    msgNorm.includes("suprimento") ||
    msgNorm.includes("suprimentos") ||
    msgNorm.includes("fazer suprimento") ||
    msgNorm.includes("colocar dinheiro no caixa") ||
    msgNorm.includes("registro de suprimento") ||
    msgNorm.includes("registro de retirada") ||
    msgNorm.includes("registrando sangria") ||
    msgNorm.includes("registro de sangria") ||
    msgNorm.includes("tirar troco do caixa") ||
    msgNorm.includes("depositar dinheiro no caixa") ||
    msgNorm.includes("deposito no caixa") ||
    msgNorm.includes("dep√≥sito no caixa") ||
    msgNorm.includes("remocao de dinheiro") ||
    msgNorm.includes("remo√ß√£o de dinheiro") ||
    msgNorm.includes("retirar excesso") ||
    msgNorm.includes("dinheiro a mais no caixa") ||
    msgNorm.includes("ajuste de caixa") ||
    msgNorm.includes("retirar dinheiro do caixa")
  ) {
    return "sangria";
  }

  if (
    msgNorm.includes("nao reconheco") ||
    msgNorm.includes("n√£o reconhe√ßo") ||
    msgNorm.includes("fraude") ||
    msgNorm.includes("compra indevida") ||
    msgNorm.includes("contestar compra") ||
    msgNorm.includes("contestacao") ||
    msgNorm.includes("compra que nao fiz") ||
    msgNorm.includes("compra que n√£o fiz") ||
    msgNorm.includes("nao fiz essa compra") ||
    msgNorm.includes("n√£o fiz essa compra") ||
    msgNorm.includes("compra desconhecida") ||
    msgNorm.includes("uso indevido") ||
    msgNorm.includes("estorno") ||
    msgNorm.includes("quero estornar") ||
    msgNorm.includes("quero cancelar compra") ||
    msgNorm.includes("cancelar compra indevida") ||
    msgNorm.includes("compra suspeita") ||
    msgNorm.includes("transacao nao reconhecida") ||
    msgNorm.includes("transa√ß√£o n√£o reconhecida") ||
    msgNorm.includes("cartao clonado") ||
    msgNorm.includes("clonaram meu cartao") ||
    msgNorm.includes("clonaram meu cart√£o") ||
    msgNorm.includes("roubaram meu cartao") ||
    msgNorm.includes("roubaram meu cart√£o") ||
    msgNorm.includes("uso nao autorizado") ||
    msgNorm.includes("uso n√£o autorizado") ||
    msgNorm.includes("quero o dinheiro de volta") ||
    msgNorm.includes("reembolso") ||
    msgNorm.includes("solicitar estorno") ||
    msgNorm.includes("transacao suspeita") ||
    msgNorm.includes("tentativa de fraude") ||
    msgNorm.includes("estorno da compra") ||
    msgNorm.includes("cai em golpe") ||
    msgNorm.includes("golpe no cartao") ||
    msgNorm.includes("golpe no cart√£o") ||
    msgNorm.includes("fui roubado") ||
    msgNorm.includes("contesta√ß√£o")
  ) {
    return "fraudeContestacao";
  }

  // aqui voc√™ PODE manter um √∫nico bloco de cartaoGeral (n√£o dois)

  if (
    msgNorm.includes("posso comprar") ||
    msgNorm.includes("posso usar") ||
    msgNorm.includes("pode usar") ||
    msgNorm.includes("pode pagar") ||
    msgNorm.includes("pode gastar") ||
    msgNorm.includes("pode comprar") ||
    msgNorm.includes("o que pode comprar") ||
    msgNorm.includes("oq eu posso comprar com o cart√£o") ||
    msgNorm.includes("oq pode comprar") ||
    msgNorm.includes("pode no cartao") ||
    msgNorm.includes("pode no cart√£o") ||
    msgNorm.includes("pode colocar no cartao") ||
    msgNorm.includes("pode colocar no cart√£o") ||
    msgNorm.includes("posso usar o cartao para") ||
    msgNorm.includes("posso usar o cart√£o para") ||
    msgNorm.includes("para que posso usar") ||
    msgNorm.includes("o que da pra pagar") ||
    msgNorm.includes("oq da pra pagar") ||
    msgNorm.includes("o que da para pagar") ||
    msgNorm.includes("posso pagar") ||
    msgNorm.includes("oq pagar") ||
    msgNorm.includes("pagar com o cartao") ||
    msgNorm.includes("pagar com o cart√£o") ||
    msgNorm.includes("oque posso pagar") ||
    msgNorm.includes("o q posso pagar") ||
    msgNorm.includes("oq eu posso pagar") ||
    msgNorm.includes("eu posso pagar") ||
    msgNorm.includes("posso passar o cartao") ||
    msgNorm.includes("posso passar o cart√£o") ||
    msgNorm.includes("oq eu gasto") ||
    msgNorm.includes("o que posso gastar") ||
    msgNorm.includes("posso usar cartao") ||
    msgNorm.includes("posso usar cart√£o") ||
    msgNorm.includes("o que posso fazer") ||
    msgNorm.includes("oq da pra fazer") ||
    msgNorm.includes("posso adquirir") ||
    msgNorm.includes("que da pra adquirir") ||
    msgNorm.includes("para que serve o cartao") ||
    msgNorm.includes("para que serve o cart√£o") ||
    msgNorm.includes("em que posso usar") ||
    msgNorm.includes("em que eu posso usar") ||
    msgNorm.includes("oq pode pagar") ||
    msgNorm.includes("pode ser pago") ||
    (typeof perguntasGeraisOquePosso !== "undefined" &&
     perguntasGeraisOquePosso.some(f => msgNorm.includes(f)))
  ) {
    return "podeNaoPode";
  }

  // Conversa geral sobre cart√£o Clara
  if (
    msgNorm.includes("cartao clara") ||
    msgNorm.includes("cart√£o clara") ||
    (msgNorm.includes("cartao") && msgNorm.includes("clara")) ||
    (msgNorm.includes("cart√£o") && msgNorm.includes("clara")) ||
    msgNorm.includes("cartao das lojas") ||
    msgNorm.includes("cart√£o das lojas") ||
    msgNorm.includes("cartao nas lojas") ||
    msgNorm.includes("cart√£o nas lojas") ||
    msgNorm.includes("falar sobre o cartao") ||
    msgNorm.includes("falar sobre o cart√£o") ||
    msgNorm.includes("informacoes sobre o cartao") ||
    msgNorm.includes("informa√ß√µes sobre o cart√£o") ||
    msgNorm.includes("duvida sobre o cartao") ||
    msgNorm.includes("d√∫vida sobre o cart√£o") ||
    msgNorm.includes("tudo sobre a clara") ||
    msgNorm.includes("como funciona a clara") ||
    msgNorm.includes("o que √© a clara") ||
    msgNorm.includes("o que e a clara") ||
    msgNorm.includes("o q e a clara") ||
    msgNorm.includes("cartao corporativo") ||
    msgNorm.includes("cart√£o corporativo") ||
    msgNorm.includes("cartao de credito corporativo") ||
    msgNorm.includes("cart√£o de cr√©dito corporativo") ||
    msgNorm.includes("duvida clara") ||
    msgNorm.includes("d√∫vida clara")
  ) {
    return "cartaoGeral";
  }

  return "generica";
}

// Bloco HTML para o relat√≥rio gerencial da Clara (Looker Studio)
const htmlRelatorioGerencial = [
  "<div class='w-full'>",
  "  <div class='w-full mt-1'>",
  "    <iframe",
  "      src='https://lookerstudio.google.com/embed/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF'",
  "      width='100%'",
  "      height='6630'",
  "      frameborder='0'",
  "      style='border:0;border-radius:0.75rem;'",
  "      allowfullscreen",
  "      sandbox='allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox'>",
  "    </iframe>",
  "  </div>",
  "</div>"
].join("");

function respProcedimentosServiceNow() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Principais procedimentos de Cart√£o Clara no ServiceNow (Anexo II da Pol√≠tica)</b></p>' +

      '<p class="mt-2">' +
        'O Anexo II da pol√≠tica organiza os principais fluxos de chamado no <b>ServiceNow</b> para temas de cart√£o Clara.' +
        ' De forma resumida, os tipos mais importantes s√£o:' +
      '</p>' +

      '<ul class="list-disc ml-4 mt-2 space-y-1">' +
        '<li>' +
          '<b>Fraude / contesta√ß√£o de transa√ß√£o</b><br>' +
          'Usado quando h√° suspeita de fraude ou lan√ßamento indevido pelo estabelecimento.' +
          ' Normalmente exige anexar boletim de ocorr√™ncia ou evid√™ncias e detalhar data, valor e loja.' +
        '</li>' +

        '<li>' +
          '<b>Desbloqueio de cart√£o ap√≥s atraso de comprovantes</b><br>' +
          'Quando o cart√£o foi bloqueado porque a loja deixou de anexar nota/comprovante dentro do prazo.' +
          ' O chamado √© usado para comprovar que as pend√™ncias foram regularizadas e solicitar o desbloqueio.' +
        '</li>' +

        '<li>' +
          '<b>Ajuste excepcional de limite</b><br>' +
          'Para situa√ß√µes pontuais em que o limite padr√£o do cart√£o n√£o cobre uma demanda espec√≠fica' +
          ' (ex.: obra emergencial autorizada, a√ß√£o oficial maior). Sempre exige justificativa e aprova√ß√£o.' +
        '</li>' +

        '<li>' +
        '<b>Troca de Gerente (mudan√ßa entre lojas)</b><br>' +
        'Chamado usado quando um gerente que possui cart√£o Clara √© transferido de uma loja para outra.' +
        ' √â obrigat√≥rio informar a BU (ex.: Centauro, Fisia), a loja de origem, a loja de destino e a data efetiva da troca,' +
        ' para que o cart√£o fique vinculado corretamente √† nova unidade.' +
        ' O cart√£o f√≠sico deve acompanhar o gerente na mudan√ßa e continua sendo utilizado na nova loja ap√≥s o ajuste cadastral.' +
        ' Esse fluxo tamb√©m √© o caminho para formalizar trocas definitivas de respons√°vel, em conjunto com as orienta√ß√µes de afastamento/demiss√£o de gerente na pol√≠tica.' +
      '</li>' +

        '<li>' +
          '<b>Inser√ß√£o ou ajuste de etiqueta</b><br>' +
          'Chamado para incluir nova etiqueta na Clara ou ajustar etiqueta existente,' +
          ' quando um tipo de gasto recorrente n√£o se encaixa bem nas op√ß√µes atuais.' +
        '</li>' +

        '<li>' +
          '<b>Gasto indevido (pessoal) / ressarcimento</b><br>' +
          'Quando o cart√£o foi usado para despesa pessoal ou fora da pol√≠tica.' +
          ' O chamado registra o caso, a forma de ressarcimento e o acompanhamento pelo Financeiro.' +
        '</li>' +
      '</ul>' +

      '<p class="mt-3">' +
        'Eu n√£o abro o chamado por voc√™, mas te ajudo a escolher <b>qual tipo de solicita√ß√£o</b> faz sentido' +
        ' e a chegar com o texto certo no ServiceNow.' +
      '</p>' +

      '<p class="mt-2"><a href="https://sn.gruposbf.com.br/sp?id=sc_cat_item&sys_id=97ee1f9f8714e910d26c63d30cbb35f9" target="_blank" class="text-blue-600 underline">Clique aqui e acesse o ServiceNow para abertura de chamados.</a></p>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Estrutura baseada no Anexo II ‚Äì Solicita√ß√µes no ServiceNow da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.' +
        ' Sempre siga os caminhos e nomes exatos de categoria que estiverem atualizados no cat√°logo do ServiceNow.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}


    /* ========= ETIQUETA POR MENSAGEM ========= */

    function acharEtiquetaPorMensagem(msgNorm) {
        const stopTerms = [
            "etiqueta","qual etiqueta","que etiqueta","categoria","qual categoria",
            "classificacao","classifica√ß√£o","tag","pode usar","posso usar",
            "posso comprar","pode comprar","cartao","cart√£o","cartao clara",
            "cart√£o clara","clara","limite","ajuda","duvida","d√∫vida"
        ].map(normalize);

        const palavras = msgNorm.split(/\s+/);

        let melhorMatch = null;
        let melhorForca = 0;

        for (const et of etiquetasOficiais) {
            let forcaAtual = 0;

            for (const termoOriginal of et.palavrasChave) {
                const termoNorm = normalize(termoOriginal);
                if (stopTerms.includes(termoNorm)) continue;

                if (palavras.includes(termoNorm)) {
                    forcaAtual += 2;
                }
                if (msgNorm.includes(termoNorm)) {
                    forcaAtual += 1;
                }
            }

            if (forcaAtual > melhorForca) {
                melhorForca = forcaAtual;
                melhorMatch = et;
            }
        }

        if (melhorForca === 0) return null;
        return melhorMatch;
    }

                /* ========= AVALIA√á√ÉO DE COMPRA ========= */

    const gruposProibidos = {
        eletrodomesticos: [
            "geladeira", "microondas", "micro-ondas", "friogrifico", "freezer", "frigobar", "Geladeira",
            "Refrigerador", "Fog√£o", "Cooktop", "Forno", "M√°quina de Lavar Lou√ßas", "Coifa", "Depurador",
            "Purificador de √Ågua", "M√°quina de Lavar Roupas", "Secadora de Roupas", "Centr√≠fuga", "secadora",
            "secadora de lou√ßas", "lavadora", "lava-roupas", "lava e seca", "lava-lou√ßas", "exaustor", "purificador",
            "bebedouro", "forno-microondas"
        ].map(normalize),

        eletroportateis: [
            "Liquidificador", "Batedeira", "Processador de Alimentos", "Mixer", "Air Fryer", "airfryer", "airfrier",
            "Panela El√©trica", "M√°quina de P√£o", "M√°quina de Waffle", "Cafeteira", "Chaleira", "Extrator de Suco",
            "Torradeira", "Sanduicheira", "Pipoqueira El√©trica", "Abridor de Lata El√©trico", "Abridor de Vinho El√©trico",
            "ferro", "ferro de passar", "Ferro de Passar Roupa", "M√°quina de Costura", "Aspirador de P√≥",
            "Lavadora de Jato de √Ågua", "Limpadora a Vapor", "Secador de Cabelo", "Chapinha", "Prancha",
            "Barbeador El√©trico", "barbeador", "Escova de Dente El√©trica", "escova de dente", "vaporizador"
        ].map(normalize),

        climatizacao: [
            "compressor", "ventilador", "ar condicionado", "ar-condicionado", "Ventilador", "Aquecedor El√©trico",
            "Desumidificador", "compressor de ar", "aquecedor", "climatizador"
        ].map(normalize),

        moveisUtensiliosCasa: [
            "mesa", "cadeira", "sof√°", "poltrona", "arm√°rio", "c√¥moda", "estante", "tapete", "persiana", "lustre",
            "aquario", "aquarios", "churraqueira", "carv√£o", "churrasco", "cadeira de balan√ßo", "carrinho de beb√™"
        ].map(normalize),

        eletronicos: [
            "tv", "controle de tv", "controle remoto", "televisao", "televis√£o", "home theater", "hometheater", "som ambiente", "caixa de som grande", "caixa de som", "soundbar", "Celulares", "celular", "Smartphones", "Tablets", "Computadores", "computador", "notebook", "Monitores", "Impressoras", "Scanners", "Roteadores", "Modems", "HD", "SSD", "Calculadoras",
            "Televisores", "calculadora", "Aparelhos de Som", "Caixas de Som", "Fones de Ouvido", "Reprodutores de M√≠dia",
            "dvd", "C√¢meras Fotogr√°ficas Digitais", "C√¢meras de V√≠deo", "C√¢meras de Seguran√ßa", "C√¢meras de Monitoramento",
            "Smartwatches", "Pulseiras Fitness", "Controles Remotos", "Carregadores Port√°teis", "Power Bank", "powerbank",
            "power bank", "Lanterna El√©trica", "lanterna", "rel√≥gio", "relogios", "rel√≥gios", "projetor", "telao",
            "tel√£o", "tela gigante", "drone", "GoPro", "c√¢mera de a√ß√£o", "gimbal", "tablet", "smartwatch",
            "oculos", "√≥culos", "gps"
        ].map(normalize),

        games: [
            "ps5", "xbox", "x-box", "PS5", "ps4", "playstation", "video game", "videogame", "jogos de videogame",
            "jogo de video game", "jogos de video game", "Consoles de Videogame", "game pass", "ps plus",
            "xbox live", "recarga de jogo", "moeda de jogo", "skin de jogo", "pacote de expans√£o", "jogo digital",
            "joguinho", "e-sports", "jogos online", "software de entretenimento", "ingresso virtual"
        ].map(normalize),

        veiculos: [
            "avi√£o", "caminh√£o", "carro", "veiculo", "ve√≠culo", "moto", "ferrari", "lamborghini", "bicicleta", "lancha",
            "iate", "jet ski", "barco", "trem", "√¥nibus", "trator", "m√°quina agr√≠cola", "patinete el√©trico", "patinete",
            "hoverboard", "caminhonete", "aviao", "avi√µes"
        ].map(normalize),

        instrumentosMusicais: [
            "viol√£o", "violao", "viol√µes", "guitarra", "baixo", "violino", "viola", "violoncelo", "contrabaixo", "harpa",
            "bandolim", "cavaquinho", "ukulele", "banjo", "cravo", "piano", "teclado", "sintetizador", "√≥rg√£o",
            "flauta", "flautim", "clarinete", "saxofone", "obo√©", "fagote", "trompete", "trombone", "tuba", "trompa",
            "harm√¥nica", "gaita", "acorde√£o", "escaleta", "bateria", "tambor", "caixa", "surdo", "pandeiro", "tri√¢ngulo",
            "prato", "chimbal", "bumbo", "t√≠mpano", "xilofone", "marimba", "vibrafone", "glockenspiel", "sinos",
            "caxixi", "agog√¥", "reco-reco", "cu√≠ca", "berimbau", "atabaque", "conga", "bong√¥", "maraca", "castanhola",
            "tamborim", "adufe", "tarol", "repique", "tam-tam", "djembe", "rabeca", "ala√∫de", "balalaica",
            "sitar", "koto", "shamisen", "didgeridoo", "ocarina", "euf√¥nio", "sousafone", "celesta", "theremin", "sampler",
            "sequenciador", "messing", "harpsichord", "clavic√≥rdio", "dulcimer", "rabeca chuleira", "gaita de fole",
            "violino popular", "xilarm√≥nico", "bombardino", "violone", "fliscorne", "clarim", "daxofone", "estradiv√°rio",
            "figle", "museta", "oficleide", "takuapu", "matraca", "c√≠mbalo", "gongo", "prato de bateria", "guitar"
        ].map(normalize),

        ferramentas: [
            "furadeira", "parafusadeira", "serra el√©trica", "compressor de ar"
        ].map(normalize),

        animais: [
            "animais", "vaca", "mam√≠fero", "mam√≠feros", "ave", "aves", "p√°ssaro", "p√°ssaros", "inseto", "insetos", "peixe",
            "peixes", "r√©ptil", "r√©pteis", "anf√≠bio", "anf√≠bios", "vertebrado", "vertebrados", "invertebrado", "invertebrados",
            "felino", "felinos", "can√≠deo", "can√≠deos", "roedor", "roedores", "primata", "primatas", "cerval", "cervais",
            "equino", "equinos", "bovino", "bovinos", "su√≠no", "su√≠nos", "ovino", "ovinos", "caprino", "caprinos", "c√£o",
            "cachorro", "gato", "le√£o", "tigre", "on√ßa", "lobo", "raposa", "urso", "elefante", "rinoceronte", "hipop√≥tamo",
            "girafa", "zebra", "macaco", "chimpanz√©", "gorila", "orangotango", "morcego", "coelho", "lebre", "esquilo",
            "rato", "camundongo", "capivara", "porco-espinho", "tatu", "tamandu√°", "pregui√ßa", "baleia", "golfinho",
            "tubar√£o", "peixe-boi", "foca", "le√£o-marinho", "sapo", "r√£", "perereca", "cobra-cega", "salamandra",
            "crocodilo", "jacar√©", "tartaruga", "c√°gado", "jabuti", "lagarto", "camale√£o", "cobra", "serpente",
            "papagaio", "arara", "tucano", "coruja", "√°guia", "falc√£o", "pardal", "can√°rio", "pintassilgo", "beija-flor",
            "gaivota", "pinguim", "avestruz", "ema", "pato", "ganso", "cisne", "galinha", "peru", "codorna", "mosquito",
            "mosca", "formiga", "abelha", "vespa", "borboleta", "mariposa", "besouro", "joaninha", "lib√©lula", "gafanhoto",
            "barata", "aranha", "escorpi√£o", "carrapato", "siri", "caranguejo", "lagosta", "camar√£o", "polvo", "lula",
            "estrela-do-mar", "ouri√ßo-do-mar", "√°gua-viva", "medusa", "coral", "an√™mona", "esponja-do-mar", "caracol",
            "lesma", "ostra", "mexilh√£o", "verme", "minhoca", "sanguessuga", "centopeia", "lacraia", "peixe-palha√ßo",
            "dourado", "salm√£o", "til√°pia", "bacalhau", "sardinha", "atum", "enguia", "arraia", "cavalo-marinho",
            "sapo-boi", "r√£-touro", "hiena", "chacal", "p√≠ton", "jib√≥ia", "iguana", "gecko", "periquito", "andorinha",
            "grilo", "pulga", "√°caro", "cachorros", "gatos", "c√£es", "ra√ß√£o", "ra√ß√µes"
        ].map(normalize),

        armasGuerra: [
            "tanque", "tanque de guerra", "guerra", "metranca", "metralhadora", "bomba", "C4", "nuclear", "fuzil",
            "fuzil de assalto", "fuzil semiautom√°tico", "fuzil de precis√£o", "rifle", "carabina", "submetralhadora",
            "metralhadora pesada", "metralhadora leve", "pistola", "rev√≥lver", "espingarda", "muni√ß√£o", "muni√ß√µes",
            "cartucho", "bala", "proj√©til", "granada", "morteiro", "m√≠ssil", "m√≠sseis", "bazuca", "lan√ßa-foguetes",
            "canh√£o", "obuseiro", "torpedo", "mina terrestre", "arma qu√≠mica", "arma biol√≥gica", "arma nuclear",
            "faca t√°tica", "baioneta", "faca de combate", "machado t√°tico", "silenciador", "supressor",
            "colete bal√≠stico", "colete a prova de balas", "capacete militar", "capacete t√°tico", "m√°scara de g√°s",
            "g√°s lacrimog√™neo", "c√¢mera de vis√£o noturna", "√≥culos t√°tico", "luva t√°tica", "botas militares",
            "coturno", "farda", "uniforme camuflado", "roupa t√°tica", "coldre", "porta carregador", "bolso modular",
            "cinto t√°tico", "joelheira t√°tica", "cotoveleira t√°tica", "placa bal√≠stica", "placas bal√≠sticas", "bandoleira",
            "blindado", "carro de combate", "ve√≠culo blindado", "lan√ßa m√≠sseis", "porta-avi√µes", "navio de guerra",
            "submarino", "drone militar", "ve√≠culo a√©reo n√£o tripulado", "aeronave de ca√ßa", "jato de ca√ßa",
            "bombardeiro", "avi√£o militar", "helic√≥ptero militar", "caminh√£o militar", "jeep militar", "helicopero",
            "mochila militar", "mochila t√°tica", "kit primeiros socorros t√°tico", "kit sobreviv√™ncia", "cantil",
            "cantil militar", "saco de dormir militar", "bin√≥culo", "tel√™metro", "b√∫ssola", "gps t√°tico",
            "lanterna t√°tica", "apito t√°tico", "marmita militar", "pazinha de trincheira", "B2", "bunker", "missel",
            "armas"
        ].map(normalize),

        bensServicosAbstratos: [
            "diamante", "ouro", "prata", "joia", "bracelete", "colar", "quadro", "escultura", "pintura", "a√ß√µes",
            "criptomoeda", "t√≠tulos", "bonds", "consulta m√©dica", "terapia", "psic√≥logo", "exames", "tratamentos",
            "cirurgia", "plano de sa√∫de", "curso", "faculdade", "mentoria", "aluguel", "imposto", "multa", "reforma",
            "manuten√ß√£o", "limpeza", "seguro", "doa√ß√£o", "gorjeta", "champanhe", "champagne", "viagem", "piscina",
            "piso", "porcelanato", "tijolo", "bloco", "universo", "planeta", "sol", "furacao", "aeroporto", "lua",
            "parque de divers√£o", "cinema", "parque", "ingresso", "ingressos", "teatro", "museu", "exposi√ß√£o",
            "espet√°culo", "circense", "√≥pera", "concerto", "bal√©", "excurs√£o", "tour guiado", "passeio", "visita guiada",
            "galeria de arte", "livro", "livros", "revista", "revistas", "e-book", "cd", "dvd", "vinil", "curso de arte",
            "curso de m√∫sica", "curso de dan√ßa", "assinatura", "streaming", "streaming de v√≠deo", "streaming de √°udio",
            "netflix", "spotify", "disney+", "globoplay", "prime video", "youtube premium", "youtube", "deezer", "tidal",
            "hbo max", "telecine play", "bilhete de trem", "bilhete de √¥nibus", "passagem a√©rea", "hotel", "aula de teatro",
            "aluguel de carro", "praia", "camping", "pesca", "ca√ßa", "boliche", "patina√ß√£o", "escalada", "kart",
            "paintball", "tirolesa", "rapel", "trilha", "academia", "yoga", "pilates", "crossfit", "luta", "massagem",
            "spa", "sauna", "day spa", "clube de campo", "mensalidade clube", "rod√≠zio", "buffet", "restaurante",
            "bar", "cafeteria", "fast food", "pacote de viagem", "lazer", "entretenimento", "recrea√ß√£o", "hobbies",
            "compra com milhas", "cart√£o presente", "gift card", "cr√©dito em plataforma", "recarga de celular",
            "compra de pontos", "programa de pontos", "sorteio", "rifa", "pr√©dio", "casa", "apartamento",
            "previd√™ncia privada", "previd√™ncia", "plano de previd√™ncia", "cdi", "cdb", "certificado de dep√≥sito banc√°rio",
            "lci", "lca", "letra de cr√©dito imobili√°rio", "letra de cr√©dito do agroneg√≥cio", "t√≠tulos de renda fixa",
            "fundos de investimento", "cotas de fundos", "lci 180 dias", "investimento via cart√£o", "aporte via cart√£o",
            "cashback investimento", "milhas para investimento", "compra de milhas", "criptomoedas",
            "token de investimento", "nucoin", "cashback", "cash back", "bitcoin", "milhas", "brinquedo", "brinquedos",
            "veneno", "mata inseto", "isca", "iscas", "cobasi", "arvore", "flores", "planta"
        ].map(normalize),

        restritos: [
            "drogas", "produtos falsificados", "material pornogr√°fico", "porno", "pornografia", "esp√©cies amea√ßadas",
            "rem√©dios controlados", "produtos de tabaco", "cigarro", "charuto", "muni√ß√£o", "prostituta", "puta",
            "programa", "night", "sexo", "transar", "camisinha", "vibrador", "KY", "chupeta"
        ].map(normalize),

        inteligenciaArtificial: [
            "ChatGPT", "GPT-3", "GPT-4", "GPT-4o", "GPT", "Gemini", "Google Gemini", "Gemini Pro", "Gemini Ultra",
            "Microsoft Copilot", "Copilot", "Claude", "Claude 3", "Claude 3 Opus", "Claude 3 Sonnet", "Claude 3 Haiku",
            "Llama", "Llama 2", "Llama 3", "Mistral", "Grok", "AlphaGo", "IBM Watson", "Watson", "TensorFlow", "PyTorch",
            "Keras", "Azure AI", "Azure Machine Learning", "Google Cloud AI", "Vertex AI", "Amazon SageMaker", "DALL-E",
            "DALL-E 2", "DALL-E 3", "Midjourney", "Stable Diffusion", "Stable Diffusion XL", "SDXL", "Code Llama", "Whisper",
            "Jasper", "Jasper AI", "Copy AI", "Beautiful AI", "Grammarly", "Synthesia", "Picsart AI", "Otter AI",
            "Tesla Autopilot", "ClickUp Brain", "H2O.ai", "Scikit-learn", "OpenAI Gym", "Tabnine", "GitHub Copilot",
            "Perplexity", "Duck AI", "Siri", "Alexa", "Meta AI", "NotebookLM", "WordAI", "DeepBrain AI", "Salesforce Einstein",
            "Fireflies", "Pictory", "Speechify", "Poised", "You.com", "Andi", "Chatfuel", "Dialogflow", "Cursor",
            "Mya Systems", "Olivia by Paradox", "SeekOut", "SAP S/4HANA AI", "Breeze by HubSpot", "sap", "github", "excel",
            "word", "text-pad", "textpad"
        ].map(normalize),

        utensiliosCozinha: [
            "garfo", "faca", "colher", "colher de sopa", "colher de ch√°", "colher de sobremesa", "faca de serra",
            "faca de p√£o", "faca de carne", "esp√°tula", "concha", "escumadeira", "fouet", "batedor de ovos",
            "abridor de lata", "abridor de garrafa", "saca-rolhas", "ralador", "descascador", "peneira",
            "espremedor de alho", "cortador de pizza", "tesoura de cozinha", "pegador de macarr√£o",
            "pegador de salada", "t√°bua de corte", "pirex", "travessa", "assadeira", "forma de bolo",
            "frigideira", "panela", "ca√ßarola", "leiteira", "cuscuzeiro", "chaleira", "bule", "x√≠cara",
            "copo", "ta√ßa", "prato", "pires", "saladeira", "tigela", "bowl"
        ].map(normalize)

    };

    const mensagensBrincadeiraPorGrupo = {
        eletrodomesticos: "Interior de loja n√£o √© cozinha planejada, n√©? üòÖ",
        eletroportateis: "Vai montar uma cozinha gourmet a√≠ na loja? üòÇ",
        climatizacao: "Climatizar a loja √© importante, mas isso entra como patrim√¥nio, n√£o no cart√£o da Clara üòâ",
        moveisUtensiliosCasa: "Parece mais compra de mob√≠lia do que despesa do dia a dia da loja üò¨",
        eletronicos: "Isso a√≠ t√° com mais cara de patrim√¥nio do que de gasto operacional‚Ä¶ üì∫",
        games: "Montar lan house com cart√£o da loja n√£o vai rolar, hein üéÆüòÑ",
        veiculos: "Cart√£o Clara n√£o √© financiamento de concession√°ria e nem tem limite infinito, hein! üöóüí≥",
        instrumentosMusicais: "Vai montar uma banda a√≠ na loja? üé∏üòÑ",
        ferramentas: "Vai montar uma oficina? üò•",
        animais: "Nossa, n√£o sabia que voc√™ tava montando um zool√≥gico na loja ü§£",
        armasGuerra: "Calma l√°, Rambo‚Ä¶ o cart√£o √© pra opera√ß√£o da loja, n√£o pra guerra ‚öîÔ∏èüòÇ",
        bensServicosAbstratos: "Isso tem bem mais cara de investimento/lazer/servi√ßo pessoal do que despesa da loja. T√° estressado e quer relaxar, n√©? üòÖ",
        restritos: "Esse tipo de item √© proibido de qualquer jeito, dentro ou fora da pol√≠tica da Clara üò∂‚Äçüå´Ô∏è",
        inteligenciaArtificial: "Nem as IAs escapam da pol√≠tica do cart√£o corporativo, viu? ü§ñüö´",
        utensiliosCozinha: "MasterChef que habita em voc√™ n√£o √© o mesmo que habita na Clara üßëüèº‚Äçüç≥"
    };

      function avaliarCompraEspecifica(msgNorm) {
    if (!msgNorm) {
        return { pode: null, resposta: "" };
    }

    const baseMsg = `Esse tipo de item <b>N√ÉO</b> pode ser comprado/utilizado com o cart√£o.<br>
        Ele deve seguir o processo de requisi√ß√£o junto √† √°rea de Compras (se for relevante e apto de acordo com o neg√≥cio e estiver dentro da pol√≠tica da √°rea), com aprova√ß√£o formal, n√£o o cart√£o da loja.`;

    // 0) S√ì entro nessa fun√ß√£o se a frase tiver cara de COMPRA / USO DO CART√ÉO
    const falaDeCompraOuUso =
        msgNorm.includes("comprar") ||
        msgNorm.includes("comprei") ||
        msgNorm.includes("comprou") ||
        msgNorm.includes("compra ") ||
        msgNorm.includes("vou comprar") ||
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("pagar") ||
        msgNorm.includes("paguei") ||
        msgNorm.includes("pagou") ||
        msgNorm.includes("passei no cartao") ||
        msgNorm.includes("passei no cart√£o") ||
        msgNorm.includes("passar no cartao") ||
        msgNorm.includes("passar no cart√£o") ||
        msgNorm.includes("usei o cartao") ||
        msgNorm.includes("usei o cart√£o") ||
        msgNorm.includes("usar o cartao") ||
        msgNorm.includes("usar o cart√£o") ||
        msgNorm.includes("cartao clara") ||
        msgNorm.includes("cart√£o clara");

    // Se n√£o tem nenhum verbo de compra/uso, N√ÉO for√ßo uma decis√£o aqui
    if (!falaDeCompraOuUso) {
        return { pode: null, resposta: "" };
    }

    // 1) Checa os GRUPOS de proibidos primeiro
    for (const [grupo, palavras] of Object.entries(gruposProibidos)) {
        for (const palavra of palavras) {
            const regex = new RegExp(`\\b${palavra}\\b`, "i");
            if (regex.test(msgNorm)) {
                const intro = mensagensBrincadeiraPorGrupo[grupo] || "‚õî N√£o pode usar o cart√£o Clara pra isso.";
                const respostaFinal = `${intro}<br><br>${baseMsg}`;

                return {
                    pode: false,
                    resposta: respostaFinal
                };
            }
        }
    }

    // 2) Casos espec√≠ficos de PROIBIDOS (alimenta√ß√£o pessoal, √°lcool, transporte pessoal)
    const pessoalAlim = [
        "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
        "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
        "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
        "paguei minha comida","paguei minha janta",
        "meu almo√ßo","meu almoco","meu jantar","minha janta",
        "meu lanche","minha comida","almoco pessoal","almo√ßo pessoal",
        "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
        "almocei com o cartao","almocei com o cart√£o",
        "jantei com o cartao","jantei com o cart√£o",
        "comi com o cartao","comi com o cart√£o"
    ].map(normalize);

    for (const termo of pessoalAlim) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja. Se j√° foi pago com o cart√£o, precisa sinalizar como "Despesa Pessoal ‚Äì Uso Indevido", enccaminhar chamado via Servicenow: <b>Contas a Receber > Cart√£o Clara > Gasto Indevido (pessoal)</b>. O financeiro ir√° informar como proceder com o ressarcimento do valor.`
            };
        }
    }

    const alcool = [
        "cerveja","vodka", "gin", "tequila", "rum", "saque", "espumante", "conhaque", "51", "sidra", "brandy",
        "hidromel", "absinto", "champagne", "menta", "bitter", "vermute", "prosecco", "vinho do porto",
        "xerez", "marsala", "grappa", "pisco", "mezcal", "calvados", "amaretto", "ouzo", "j√§germeister",
        "soju", "arac", "baijiu", "vinho","whisky","whiskey","cacha√ßa", "licor", "cachaca","Skol", "Brahma",
        "Heineken", "Corona Extra", "Budweiser", "Bud Light", "Stella Artois", "stella", "itaipava",
        "devassa", "Guinness", "Smirnoff", "Absolut", "C√Æroc", "Grey Goose", "Belvedere",
        "Tito's Handmade Vodka", "Skyy", "Orloff", "Johnnie Walker", "Jack Daniel's", "Jameson",
        "Chivas Regal", "Jim Beam", "Ballantine's", "Grant's", "Macallan", "Glenfiddich", "Bulleit",
        "Baileys", "Licor 43", "Amarula", "Campari", "Aperol", "blue label", "gold label","black label",
        "green label"
    ].map(normalize);

    for (const termo of alcool) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Bebida alco√≥lica n√£o √© permitida no cart√£o Clara. Isso n√£o √© considerado despesa operacional autorizada.`
            };
        }
    }

    const transportePessoal = ["uber"," 99","taxi","t√°xi","tax√≠","cabify"].map(normalize);
    for (const termo of transportePessoal) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Uber / 99 / t√°xi para deslocamento pessoal n√£o pode no cart√£o Clara. N√£o √© gasto operacional direto da loja.`
            };
        }
    }

        // 2c) Estacionamento (n√£o autorizado no cart√£o Clara)
    const estacionamento = [
        "estacionamento",
        "pagar estacionamento",
        "paguei estacionamento",
        "ticket de estacionamento",
        "tiket de estacionamento",
        "ticket do estacionamento",
        "tal√£o de estacionamento",
        "talonario de estacionamento",
        "estacionamento do shopping",
        "estacionei o carro",
        "pagar o parking",
        "ticket parking"
    ].map(normalize);

    for (const termo of estacionamento) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Gasto com <b>estacionamento</b> n√£o √© permitido no cart√£o Clara.<br>
                Esse tipo de despesa n√£o √© tratado como gasto operacional direto da loja e n√£o deve ser pago com o cart√£o corporativo.<br>
                Se o cart√£o j√° foi utilizado para estacionamento, trate o valor como <b>uso indevido</b> e siga as orienta√ß√µes de ressarcimento com o time de Contas a Receber / Financeiro.`
            };
        }
    }

    // 3) Casos espec√≠ficos PERMITIDOS (lanche time, perif√©ricos, servi√ßos emergenciais)
    const palavrasTime = [
        "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
        "lanche time","lanche pro time","lanche para o time",
        "treinamento","premiacao","premia√ß√£o","acao oficial","a√ß√£o oficial",
        "acao vm","a√ß√£o vm","acao regional","a√ß√£o regional",
        "agua pra equipe","√°gua pra equipe","gal√£o de agua","galao de agua","gal√£o de √°gua",
        "salgadinho pra treinamento","bolo pra treinamento",
        "suco pra treinamento","suco para treinamento","lanche treinamento"
    ].map(normalize);

    for (const termo of palavrasTime) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "LANCHES DE REFEI√á√ïES / AGUA POT√ÅVEL",
                    desc: "Coffee break autorizado, √°gua/lanche para equipe em treinamento interno aprovado, a√ß√£o oficial da loja (VM, regional, diretoria) ou premia√ß√£o operacional.",
                    exemploDescricao: "Coffee break treinamento VM loja 1234"
                },
                resposta: `Pode usar o cart√£o Clara se for a√ß√£o autorizada (treinamento interno, VM, regional, diretoria, premia√ß√£o operacional). Precisa lan√ßar na Clara em at√© 48h com nota fiscal, etiqueta correta e descri√ß√£o objetiva.`
            };
        }
    }

    const perifOperacional = [
        "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
        "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa",
        "bobina ecf","bobina fiscal"
    ].map(normalize);

    for (const termo of perifOperacional) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "MATERIAL DE INFORM√ÅTICA",
                    desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                    exemploDescricao: "Teclado PDV loja 1234"
                },
                resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) √© considerado suprimento operacional de baixo valor para a loja e pode ser pago no cart√£o Clara, desde que classificado corretamente e lan√ßado em at√© 48h.`
            };
        }
    }

    const servicoEmerg = [
        "chaveiro","abrir cofre","abrir estoque","perdi a chave",
        "motoboy","sedex","correios","envio de documento","postar documento",
        "mandar documento","enviar documento"
    ].map(normalize);

    for (const termo of servicoEmerg) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "TRANSPORTE SERVI√áOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                    desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                    exemploDescricao: "Motoboy urgente documenta√ß√£o loja 1234"
                },
                resposta: `Servi√ßos emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cart√£o Clara, desde que sejam necessidade imediata da opera√ß√£o e sejam justificados na Clara dentro de 48h.`
            };
        }
    }

    // 4) Se n√£o casou em nada, deixa para a resposta gen√©rica / pol√≠tica
    return { pode: null, resposta: "" };
}

    /* ========= RESPOSTAS ========= */


    function respostaForaEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
    }

    function respEtiquetaDireta(et) {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Etiqueta identificada: ${et.nome}</b></p>
    <p class="mt-2">${et.descricao || "Essa etiqueta √© usada para classificar despesas relacionadas a este tipo de gasto na opera√ß√£o da loja."}</p>

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p>Se voc√™ identificar que essa etiqueta n√£o representa corretamente o tipo de compra ou est√° gerando confus√£o recorrente no uso, a orienta√ß√£o √© solicitar ajuste formal.</p>
        <p class="mt-2">Abra um chamado no ServiceNow do tipo <b>Inser√ß√£o ou ajuste de etiqueta ‚Äì Cart√£o Clara</b>, explicando o problema encontrado, como a etiqueta √© usada hoje e qual seria o cen√°rio ideal.</p>
        <p class="mt-2">Evite adaptar etiquetas por conveni√™ncia, pois isso afeta indicadores financeiros, auditorias e controles internos.</p>
        <p class="mt-3 text-xs text-slate-500">Orienta√ß√£o alinhada ao Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.</p>
      </div>
    </details>
  </div>`;
}

    function respLimite() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Limite do cart√£o Clara nas lojas</b></p>
    <p class="mt-2">O limite do cart√£o Clara √© definido para cobrir os gastos previstos do ciclo de fatura (de 06 at√© 05 do m√™s seguinte), considerando o padr√£o de despesas operacionais da loja.</p>
    <p class="mt-2">O limite √© reestabelecido por completo sempre no dia 06 de cada m√™s.</p>
    <p class="mt-2">Para visualizar o limite, ali na parte do menu de <b>A√ßoes</b>, arraste pro lado e vai em <b>Ajustar limite</b>. L√° vai aparecer de forma mais simples o valor atual do limite, de forma integral.</p>
    <p class="mt-2">Planeje as compras para n√£o estourar o limite logo no in√≠cio do ciclo, priorize gastos essenciais e evite despesas de alto valor.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p><b>Ajuste excepcional de limite:</b></p>
        <p>Quando o limite que foi estabelecido n√£o √© suficiente para uma situa√ß√£o pontual (como algo emergencial ou a√ß√£o oficial maior j√° autorizada), n√£o √© para ‚Äúfor√ßar‚Äù o uso do cart√£o a qualquer custo.</p>
        <p class="mt-2">Nesses casos, alinhe previamente com a regional ou √°rea respons√°vel, organize a justificativa e ent√£o abra chamado no ServiceNow do tipo <b>Ajuste excepcional de limite ‚Äì Cart√£o Clara</b>, informando loja, BU, limite atual, limite solicitado, per√≠odo e motivo detalhado.</p>
        <p class="mt-2">Pedidos sem justificativa aderente √† pol√≠tica ou sem alinhamento com a lideran√ßa podem ser negados, mesmo que existam demandas locais.</p>
        <p class="mt-3 text-xs text-slate-500">Orienta√ß√£o alinhada √† Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. Limite n√£o √© ferramenta para cobrir qualquer gasto, mas sim o que √© essencial para a opera√ß√£o dentro da pol√≠tica.</p>
      </div>
    </details>
  </div>`;
}

    function respBloqueio() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Bloqueio de cart√£o Clara (preventivo ou por pend√™ncias)</b></p>
    <p class="mt-2">O cart√£o Clara pode ser bloqueado preventivamente principalmente por pend√™ncias de comprovantes (nota, etiqueta ou descri√ß√£o fora do prazo) ou por uso fora da pol√≠tica que exige an√°lise do Financeiro.</p>
    <p class="mt-2">Antes de qualquer coisa, entre na Clara e verifique se existem transa√ß√µes pendentes ou compras fora do padr√£o que possam ter motivado o bloqueio.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p><b>Passos b√°sicos quando o cart√£o est√° bloqueado:</b></p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Regularize todas as transa√ß√µes pendentes na Clara com nota, comprovante, etiqueta correta e descri√ß√£o clara;</li>
          <li>Cheque se n√£o h√° compras claramente fora da pol√≠tica que precisem ser corrigidas ou ressarcidas;</li>
          <li>Evite tentar insistir em novas compras enquanto o motivo do bloqueio n√£o estiver claro.</li>
        </ul>
        <p class="mt-3"><b>Quando o bloqueio estiver ligado √† presta√ß√£o de contas ou pend√™ncias j√° regularizadas:</b></p>
        <p>Se voc√™ j√° resolveu todas as pend√™ncias na Clara e o cart√£o continua bloqueado, a orienta√ß√£o √© abrir chamado no ServiceNow do tipo <b>Desbloqueio de cart√£o Clara por pend√™ncias / bloqueio preventivo</b>.</p>
        <p class="mt-2">No chamado, informe loja, BU, c√≥digo do cart√£o e nome do respons√°vel, al√©m de quais pend√™ncias foram regularizadas (faturas e per√≠odo) e, se solicitado, anexos ou prints que comprovem a regulariza√ß√£o.</p>
        <p class="mt-3 text-xs text-slate-500">Fluxo alinhado √† Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara e aos procedimentos de bloqueio/desbloqueio via ServiceNow. Em situa√ß√µes fora do padr√£o, consulte o Financeiro antes de tentar liberar novas compras.</p>
      </div>
    </details>
  </div>`;
}

                // üîπ NOVA RESPOSTA ‚Äì transa√ß√£o negada / categoria bloqueada
                function respTransacaoNegadaCategoria() {
                    return `HTML:<div class="text-sm text-slate-700">
            <p>Algumas compras podem ser <b>negadas</b> mesmo com limite dispon√≠vel e cart√£o ativo (<i>√â importante que voc√™ verifique que seu cart√£o n√£o est√° bloqueado</i>), porque a <b>categoria do estabelecimento</b> (MCC) est√° bloqueada pela pol√≠tica de uso dos cart√µes Clara.

            <p class="mt-2">Nesses casos, siga estes passos:
            <ol class="list-decimal ml-4 mt-1">
            <li>Verifique no app/plataforma da Clara o motivo da recusa e a categoria da compra (MCC);</li>
            <li>Se a despesa for necess√°ria para a opera√ß√£o da loja, abra um chamado no <b>ServiceNow</b> em:<br/>
            <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Libera√ß√£o de Categoria para Compra</b>;</li>
            <li>Explique o contexto da compra, qual tipo de servi√ßo/produto precisa ser liberado e se a libera√ß√£o √© pontual ou recorrente.</li>
            <li>Depois da libera√ß√£o pelo Financeiro no ServiceNow, voc√™ pode tentar a compra novamente com o cart√£o Clara.</li>
            </div>`;
                }

              function respPoliticaOficial() {
        return `HTML:<div class="text-sm text-slate-700">
          <p>Este documento cont√©m as diretrizes e padr√µes oficiais de refer√™ncia da Companhia. Ele deve ser consultado e seguido como a fonte de autoridade final para todos os assuntos que lhe s√£o pertinentes.
          <a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
          <strong>Pol√≠tica de Uso dos Cart√µes Clara (documento oficial).</strong>
          </a>
          <p>O n√£o cumprimento das disposi√ß√µes aqui estabelecidas sujeitar√° o infrator √†s medidas disciplinares e legais cab√≠veis.</p>
          </div>`;
              }

    function respCatalogoEtiquetas() {
  // Monta lista de etiquetas oficiais da pol√≠tica (etiquetasOficiais vem do politica_dados)
  let listaEtiquetasHtml = "";

  if (Array.isArray(etiquetasOficiais) && etiquetasOficiais.length) {
    listaEtiquetasHtml =
      `<div class="mt-3">
        <p class="mt-2"><b>Etiquetas oficiais dispon√≠veis hoje na Clara</b></p>
        <ul class="list-disc ml-4 mt-1 space-y-1">
          ${
            etiquetasOficiais
              .map(function (et) {
                const nome = et.nome || "";
                const desc = et.descricao || "";
                const obs  = et.observacaoUso || "";

                let li = `<li><b>${nome}</b>`;
                if (desc) {
                  li += ` ‚Äì ${desc}`;
                }
                if (obs) {
                  li += ` <span class="text-xs text-slate-500">(${obs})</span>`;
                }
                li += `</li>`;
                return li;
              })
              .join("")
          }
        </ul>
        <p class="mt-2 text-xs text-slate-500">
          Lista baseada no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara e alinhada ao cat√°logo oficial de etiquetas.
      </div>`;
  }

  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Etiquetas na Clara</b></p>
    <p class="mt-2">
      As etiquetas servem para classificar corretamente cada gasto feito com o cart√£o Clara e facilitar o controle financeiro e a presta√ß√£o de contas.
    <p class="mt-2">
      Sempre escolha a etiqueta que mais represente o tipo real de despesa, evitando classificar tudo em categorias gen√©ricas.

    ${listaEtiquetasHtml}

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica
      </summary>
      <div class="mt-2">
        <p>
          Se n√£o existir uma etiqueta adequada para o tipo de gasto recorrente da sua loja, n√£o improvise usando algo que n√£o represente a realidade da compra. Nesse caso, a orienta√ß√£o √© abrir chamado no ServiceNow do tipo <b>Inser√ß√£o ou ajuste de etiqueta ‚Äì Cart√£o Clara</b>, informando loja, BU,
          tipo de despesa, justificativa e exemplos de uso.

          O Financeiro avaliar√° a solicita√ß√£o e, se aprovado, criar√° ou ajustar√° a etiqueta no cat√°logo oficial da Clara.
        <p class="mt-3 text-xs text-slate-500">
          Fluxo baseado no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. A escolha correta de etiquetas impacta diretamente indicadores e controles da companhia.
        </p>
      </div>
    </details>
  </div>`;
}

    function respPrestacaoContas() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Presta√ß√£o de contas na Clara (notas, comprovantes e justificativas)</b></p>
    <p class="mt-2">Toda compra feita com o cart√£o Clara precisa de <b>nota ou comprovante anexado</b>, <b>etiqueta correta</b> e <b>descri√ß√£o</b> dentro do prazo de 48 horas ap√≥s a compra, sen√£o vira pend√™ncia de presta√ß√£o de contas.</p>
    <p class="mt-2">Pend√™ncias em aberto podem levar a bloqueio preventivo do cart√£o at√© que a loja regularize as informa√ß√µes.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p><b>Quando faltar nota, tiver erro de comprovante ou um caso at√≠pico:</b></p>
        <p>Se a nota foi perdida, o fornecedor n√£o emitiu NF corretamente, ou existe alguma irregularidade que voc√™ n√£o consegue resolver apenas pela Clara, registre o m√°ximo poss√≠vel na descri√ß√£o e organize as evid√™ncias que tiver (pedido, or√ßamento, recibos, prints etc.).</p>
        <p class="mt-2">Nesses casos, a orienta√ß√£o √© abrir um chamado no ServiceNow de <b>Apoio √† presta√ß√£o de contas / regulariza√ß√£o de comprovantes ‚Äì Cart√£o Clara</b>.</p>
        <p class="mt-2">No chamado, informe loja, BU, dados da transa√ß√£o (data, valor, estabelecimento), print da tela da Clara se poss√≠vel e explique o que aconteceu (perda de nota, NF em CPF, NF recusada, erro do fornecedor etc.), al√©m da solu√ß√£o proposta.</p>
        <p class="mt-3 text-xs text-slate-500">Fluxo baseado no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. Pend√™ncias n√£o tratadas podem manter o cart√£o bloqueado ou gerar apontamentos para a loja.</p>
      </div>
    </details>
  </div>`;
}

    function respAlimentoTime() {
        return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respTransportePessoal() {
        return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja. O procedimento correto √© solicitar via aplicativo com a conta corporativa da empresa.<br/><br/>
Se j√° usou de forma pessoal (pagando do pr√≥prio bolso) e quer o reembolso:<br/>
‚Ä¢ Solicite o reembolso atrav√©s da plataforma Vexpenses (√© necess√°rio autoriza√ß√£o do seu gestor).<br/>
</p>`;
    }

function respTrocaGerente() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Quando o gerente √© afastado ou desligado, o que fazer com o cart√£o Clara?</b></p>' +

      '<p class="mt-2">' +
        'A pol√≠tica traz dois cen√°rios principais para lojas f√≠sicas:' +
      '</p>' +

      '<ol class="list-decimal ml-5 mt-2 space-y-2">' +
        '<li>' +
          '<b>Gerente em f√©rias ou afastamento tempor√°rio (licen√ßa, atestado etc.)</b><br>' +
          '<ul class="list-disc ml-4 mt-1">' +
            '<li>O cart√£o da loja continua sendo o <b>cart√£o da pr√≥pria loja</b>, n√£o de outra.</li>' +
            '<li>Durante o afastamento, um <b>l√≠der / supervisor</b> indicado pela regional assume a guarda e o uso operacional do cart√£o.</li>' +
            '<li>A loja n√£o deve usar o cart√£o de outra unidade s√≥ porque o gerente est√° afastado.</li>' +
          '</ul>' +
        '</li>' +

        '<li>' +
          '<b>Gerente desligado e ainda n√£o h√° novo gerente nomeado</b><br>' +
          '<ul class="list-disc ml-4 mt-1">' +
            '<li>O cart√£o do gerente desligado deve ser <b>bloqueado</b> e recolhido.</li>' +
            '<li>Em casos espec√≠ficos, a pol√≠tica permite uso <b>tempor√°rio</b> do cart√£o de outra loja, sempre com valida√ß√£o do Financeiro.</li>' +
            '<li>Quando isso acontecer, a <b>descri√ß√£o da transa√ß√£o</b> deve deixar claro qual loja est√° sendo atendida, por exemplo:<br>' +
              '<span class="italic">"Uso tempor√°rio do cart√£o da loja 0123 para despesas operacionais da loja 0456 ‚Äì gerente em transi√ß√£o"</span>.' +
            '</li>' +
            '<li>O respons√°vel pela presta√ß√£o de contas passa a ser o <b>gerente tempor√°rio / respons√°vel indicado</b> pela regional.</li>' +
          '</ul>' +
        '</li>' +
      '</ol>' +

      '<p class="mt-3">' +
        'Em qualquer cen√°rio de afastamento ou demiss√£o, a orienta√ß√£o √© sempre:' +
      '</p>' +
      '<ul class="list-disc ml-4 mt-1">' +
        '<li>Garantir que o cart√£o do gerente desligado seja recolhido e bloqueado;</li>' +
        '<li>Registrar na descri√ß√£o das compras qualquer uso tempor√°rio de cart√£o de outra loja;</li>' +
        '<li>Em caso de <b>f√©rias do gerente ou afastamento</b>, a loja deve abrir chamado no ServiceNow informando o per√≠odo e quem ficar√° respons√°vel pela guarda do cart√£o, para que o Financeiro acompanhe e, quando necess√°rio, fa√ßa o tratamento dos comprovantes em nome do respons√°vel tempor√°rio, caminho para abertura do chamado: <b>Contas a Receber > Cart√£o Clara > Solicita√ß√£o para anexar comprovantes</b>.</li>' +
        '<li><b>Importante:</b> O financeiro deve autorizar esse fluxo por email antes da loja encaminhar chamado.</li>' +
      '</ul>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Resumo baseado no item 8.4 e no Anexo II da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara.' +
        ' Em caso de d√∫vida ou situa√ß√µes n√£o previstas, valide com o Financeiro.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

function respTrocaGerenteMudancaLojas() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Troca de gerente entre lojas com Cart√£o Clara</b></p>' +

      '<p class="mt-2">' +
        'Quando um gerente que possui um <b>cart√£o Clara</b> √© transferido de uma loja para outra, ' +
        'n√£o √© apenas uma aus√™ncia tempor√°ria: √© uma <b>mudan√ßa de unidade</b> que precisa ser refletida no cadastro do cart√£o.' +
      '</p>' +

      '<p class="mt-2">' +
        'Nesses casos, a orienta√ß√£o √© abrir no ServiceNow o tipo de chamado <b>"Troca de Gerente (mudan√ßa entre lojas)"</b>, ' +
        'informando obrigatoriamente:' +
      '</p>' +

      '<ul class="list-disc ml-4 mt-1">' +
        '<li><b>BU</b> (ex.: Centauro, Fisia);</li>' +
        '<li><b>Loja de origem</b> do gerente;</li>' +
        '<li><b>Loja de destino</b> para onde ele est√° sendo transferido;</li>' +
        '<li><b>Data efetiva da troca</b>, para ajustar o v√≠nculo do cart√£o no sistema.</li>' +
      '</ul>' +

      '<p class="mt-2">' +
        'O <b>cart√£o f√≠sico</b> deve acompanhar o gerente na mudan√ßa e passar a ser usado na nova loja, ' +
        'sempre ap√≥s o ajuste cadastral. O ponto cr√≠tico √© garantir que, no sistema, o cart√£o fique ' +
        'vinculado √† unidade correta, evitando despesas ‚Äúaparecendo‚Äù na loja errada.' +
      '</p>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Fluxo alinhado ao Anexo II (ServiceNow) e √†s regras de responsabilidade do portador na Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. ' +
        'Em caso de exce√ß√µes, valide com o Financeiro.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

    function respCartaoGeral() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Sobre o cart√£o Clara nas lojas:</b>

<p class="mt-1">
O cart√£o Clara √© o meio oficial para pagar <b>despesas operacionais da loja</b>, em substitui√ß√£o ao antigo processo de sangrias, como:
<ul class="list-disc ml-4 mt-1">
  <li>materiais de limpeza e pequenos reparos;</li>
  <li>materiais de escrit√≥rio e inform√°tica de baixo valor;</li>
  <li>√°gua / coffee break para treinamentos internos e a√ß√µes autorizadas;</li>
  <li>servi√ßos emergenciais (motoboy, chaveiro, correios em situa√ß√µes operacionais).

<p class="mt-2">
Sempre precisa:
<ul class="list-disc ml-4 mt-1">
  <li>nota fiscal ou recibo;</li>
  <li>etiqueta correta na Clara;</li>
  <li>descri√ß√£o objetiva do gasto;</li>
  <li>lan√ßar tudo em at√© <b>48h</b> no app/web da Clara.


<p class="mt-2">
N√£o pode usar o cart√£o para:

<ul class="list-disc ml-4 mt-1">
  <li>gasto pessoal (roupa, almo√ßo/jantar pessoal, compras para uso pr√≥prio);</li>
  <li>bebida alco√≥lica;</li>
  <li>Uber / 99 / t√°xi para deslocamento pessoal;</li>
  <li>itens patrimoniais / infraestrutura (TV, geladeira, micro-ondas, mesa, cadeira etc.).

<p class="mt-2">
Se quiser, posso te explicar um caso espec√≠fico. Por exemplo:
<br/>‚Ä¢ "Posso comprar teclado?"<br/>
‚Ä¢ "Pode lanche pra equipe?"<br/>
‚Ä¢ "O que n√£o pode no cart√£o?"
</p>
</div>`;
}

    function respSangria() {
  return `HTML:
<div class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© <b>DESCONTINUADO</b>

  <p>Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo deve ser pago com o <b>cart√£o Clara</b>, com justificativa na plataforma.

  <p>Se a loja pensou em fazer sangria porque <b>n√£o conseguiu usar o cart√£o Clara</b> (categoria bloqueada na maquininha / MCC bloqueado), o fluxo correto √© <b>abrir chamado no ServiceNow para tratar a categoria</b>, e n√£o tirar dinheiro do caixa.

  <p>No ServiceNow, utilize o caminho: <b>Contas a Receber > Cart√£o Clara > Libera√ß√£o de categoria</b>, informando:

  <ul class="list-disc ml-4">
    <li><b>BU</b> e <b>loja</b>;</li>
    <li>Se tentou utilizar o cart√£o no estabelecimento;</li>
    <li><b>Data e valor</b> onde da transa√ß√£o (se j√° efetuada);</li>
    <li><b>Categoria desejada</b>.

  <p>O Financeiro avalia a solicita√ß√£o e ajusta as permiss√µes de categoria. A sangria em dinheiro continua sendo exce√ß√£o extrema.
</div>`;
}

    function respFraudeContestacao() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Suspeita de fraude ou transa√ß√£o n√£o reconhecida no cart√£o Clara</b></p>
    <p class="mt-2">Se aparecer uma compra que voc√™ realmente n√£o reconhece na Clara, primeiro confira se n√£o foi uma compra leg√≠tima feita por outro respons√°vel, se n√£o √© uma assinatura recorrente ou algo ligado √† opera√ß√£o da loja.</p>
    <p class="mt-2">Se mesmo assim continuar parecendo fraude ou uso indevido, √© caso de tratar como contesta√ß√£o formal.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p>Quando a transa√ß√£o for suspeita de fraude ou n√£o reconhecida mesmo ap√≥s confer√™ncia interna, siga estes passos:</p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Bloqueie o cart√£o na Clara, se ainda houver risco de novas cobran√ßas;</li>
          <li>Levante todas as informa√ß√µes da transa√ß√£o: data, valor, estabelecimento e descri√ß√£o;</li>
          <li>Se houver ind√≠cio de golpe ou roubo, registre um Boletim de Ocorr√™ncia, quando aplic√°vel.</li>
        </ul>
        <p class="mt-3"><b>Formaliza√ß√£o no ServiceNow:</b></p>
        <p>Abra um chamado de <b>Fraude / Contesta√ß√£o de transa√ß√£o ‚Äì Cart√£o Clara</b> no ServiceNow, informando loja, BU (Centauro / Fisia) e c√≥digo da unidade, al√©m dos dados completos da transa√ß√£o (data, valor, estabelecimento) e um resumo do ocorrido.</p>
        <p class="mt-2">Anexe prints da Clara, boletim de ocorr√™ncia (se houver) e qualquer evid√™ncia que ajude o Financeiro a tratar a contesta√ß√£o com o emissor.</p>
        <p class="mt-3 text-xs text-slate-500">Resumo alinhado ao Anexo II (Fraude / Contesta√ß√£o) da Pol√≠tica de Utiliza√ß√£o dos Cart√µes Clara. Acompanhe o retorno pelo pr√≥prio ServiceNow e pelos canais oficiais do Financeiro.</p>
      </div>
    </details>
  </div>`;
}

    function respTermoResponsabilidade() {
  return "HTML:" +
  "<div class='text-sm text-slate-700'>" +
    "<p>" +
      "O <b>Termo de Responsabilidade de uso do cart√£o da Clara</b> deve ser preenchido para que a loja possa utilizar o cart√£o. " +
      "Esse termo traz tamb√©m o aceite para a Pol√≠tica de uso do cart√£o. " +
      "Preencha " +
      "<a href='https://docs.google.com/forms/d/e/1FAIpQLSdnQWYFWp-udS9V039avJlXb4x1VnlDC6us5dSCrLkgngAxpg/viewform' " +
         "target='_blank' rel='noopener noreferrer' class='service-link' style='display:inline;'><b>este formul√°rio</b></a>. " +
      "Ap√≥s preencher, voc√™ receber√° o termo anexado ao e-mail, onde deve <b>imprimir, assinar e nos enviar</b>. " +
      "Depois disso, o uso do cart√£o estar√° liberado." +
    "</p>" +
  "</div>";
}

    function respNovoCartaoPrimeiraVia() {
  return `HTML:<div class="text-sm text-slate-700">
<p>Primeira via de cart√£o Clara (novo gerente)</p>
<p class="mt-1">A emiss√£o da primeira via do cart√£o Clara deve ser realizada exclusivamente por meio de chamado no ServiceNow, no caminho:<br><b>Contas a Receber - Cart√£o Clara - Emiss√£o de 1¬™ Via de Cart√£o Clara ‚Äì Novo Gerente</b></p>
<p class="mt-1">No chamado, √© obrigat√≥rio o preenchimento das seguintes informa√ß√µes:</p>
<ul class="list-disc ml-5 mt-1">
<li>Nome do gerente;</li>
<li>E-mail do gerente;</li>
<li>Endere√ßo completo da loja com CEP;</li>
<li>Termo de Responsabilidade assinado.</li>
</ul>
<p class="mt-1">O prazo de entrega do cart√£o √© de at√© <b>7 dias √∫teis</b>.</p>
</div>`;
}

function respNovoCartaoSegundaVia() {
  return `HTML:<div class="text-sm text-slate-700">
<p>Segunda via de cart√£o Clara</p>
<p class="mt-1">A solicita√ß√£o da segunda via do cart√£o Clara deve ser feita por meio de chamado no ServiceNow, no caminho:<br><b>Contas a Receber - Cart√£o Clara - Emiss√£o de 2¬™ Via de Cart√£o Clara</b></p>
<p class="mt-1">No chamado, √© necess√°rio informar:</p>
<ul class="list-disc ml-5 mt-1">
<li>Motivo da emiss√£o da 2¬™ via;</li>
<li>Endere√ßo completo da loja com CEP.</li>
</ul>
<p class="mt-1">O cart√£o anterior ser√° <b>automaticamente cancelado</b>.</p>
<p class="mt-1">O prazo para entrega √© de at√© <b>7 dias √∫teis</b>.</p>
</div>`;
}

      function respGenerica(msgNorm) {
    msgNorm = msgNorm || "";

    // Mensagens claramente relacionadas a justificativa / nota / comprovante / v√≠deo de justificativa
    const ehJustificativa =
        msgNorm.includes("justific") ||
        msgNorm.includes("nota fiscal") ||
        msgNorm.includes("nota da compra") ||
        msgNorm.includes("perdi a nota") ||
        msgNorm.includes("falta a nota") ||
        msgNorm.includes("despesa sem nota") ||
        msgNorm.includes("despesa sem comprovante") ||
        msgNorm.includes("comprovante") ||
        msgNorm.includes("comprovantes") ||
        msgNorm.includes("video de justificativa") ||
        msgNorm.includes("v√≠deo de justificativa") ||
        msgNorm.includes("video de justificativas") ||
        msgNorm.includes("v√≠deo de justificativas");

    const avaliacao = avaliarCompraEspecifica(msgNorm);

    // 1) Se a avalia√ß√£o espec√≠fica decidiu claramente que N√ÉO pode
    if (avaliacao && avaliacao.pode === false && avaliacao.resposta) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
    }

    // 2) Se a avalia√ß√£o espec√≠fica decidiu claramente que PODE e tem etiqueta
    if (avaliacao && avaliacao.pode === true && avaliacao.etiquetaValida) {
        const et = avaliacao.etiquetaValida;
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
</div>`;
    }

    // 3) Perguntas amplas do tipo "O que posso comprar com o cart√£o?"
    if (perguntasGeraisOquePosso && perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ O que pode no cart√£o Clara</b> - Exemplos de materiais:</p>
<ul class="list-disc ml-4 mt-1">
<li>Materiais de escrit√≥rio: canetas, blocos, pastas, papel, clips, organizadores, grampeadores;</li>
<li>Servi√ßos gr√°ficos e de comunica√ß√£o visual: impress√£o de banners, adesivos promocionais, folders e plotagens autorizadas pela √°rea de VM;</li>
<li>Compra de √°gua mineral ou gal√µes para abastecimento da equipe (etiqueta ‚Äú√ÅGUA POT√ÅVEL‚Äù);</li>
<li>Suprimentos de inform√°tica (mouse, teclado, cabos, bobina fiscal etc.);</li>
<li>Lanches, coffee breaks ou premia√ß√µes para equipe somente quando vinculados a treinamentos internos, a√ß√µes oficiais ou campanhas aprovadas (etiqueta ‚ÄúLANCHES DE REFEI√á√ïES‚Äù);</li>
<li>Servi√ßos emergenciais (motoboy urgente, chaveiro, Sedex de documento);</li>
<li>Compra de bobinas fiscais ou suprimentos obrigat√≥rios do PDV;</li>
<li>Pequenas manuten√ß√µes (el√©trica, civil, ar-condicionado, equipamentos).</li>
</ul>
<p class="mt-2"><b>‚ùå O que n√£o pode</b> - Exemplos de itens n√£o permitidos:</p>
<ul class="list-disc ml-4">
<li>Itens patrimoniais ou de infraestrutura: TV, micro-ondas, geladeira, freezer, mesa, cadeira, arm√°rio, ventilador, cafeteira el√©trica, computador, impressora, celular, tablets, ou qualquer bem dur√°vel;</li>
<li>Bebidas alco√≥licas (cerveja, vinho, whisky, vodka, gin, tequila, entre outras);</li>
<li>Transporte pessoal: Uber, 99, t√°xi, aplicativos de carona ou combust√≠vel para ve√≠culo particular;</li>
<li>Despesas pessoais: almo√ßo, jantar, lanche, coffee break pessoal, delivery, supermercado para consumo pr√≥prio;</li>
<li>Equipamentos e mobili√°rios que exigem tombamento patrimonial (mesmo que de baixo valor);</li>
<li>Manuten√ß√µes estruturais de grande porte (obras, pintura geral, reformas, trocas de piso, el√©trica complexa, etc.);</li>
<li>Servi√ßos ou produtos sem nota fiscal (inclusive compras em marketplaces sem NF emitida no CNPJ da loja);</li>
<li>Gastos fora da opera√ß√£o da loja ou que n√£o tenham rela√ß√£o com a atividade comercial;</li>
</ul>
</div>`;
    }

    // 4) Se a mensagem N√ÉO tem cara de assunto da Clara/cart√£o, devolve FORA DE ESCOPO
    const falaMundoClara =
        msgNorm.includes("clara") ||
        msgNorm.includes("cartao") || msgNorm.includes("cart√£o") ||
        msgNorm.includes("fatura") ||
        msgNorm.includes("pendencia") || msgNorm.includes("pend√™ncia") ||
        msgNorm.includes("nota fiscal") || msgNorm.includes("nf ") || msgNorm.startsWith("nf") ||
        msgNorm.includes("etiqueta") ||
        msgNorm.includes("limite") ||
        msgNorm.includes("transacao") || msgNorm.includes("transa√ß√£o") ||
        msgNorm.includes("compra") || msgNorm.includes("comprar") || msgNorm.includes("paguei");

    if (!falaMundoClara) {
        // Se √© claramente uma d√∫vida de justificativa / nota / comprovante / v√≠deo de justificativa,
        // n√£o manda resposta fora de escopo (deixa o fluxo de justificativa/v√≠deo responder sozinho).
        if (ehJustificativa) {
            return "";
        }

        // Caso contr√°rio, segue a l√≥gica normal de fora de escopo
        return respostaForaEscopo(msgNorm);
    }

    // 5) Se √© claramente justificativa / nota / comprovante / v√≠deo de justificativa,
    // n√£o manda o texto gen√©rico de pol√≠tica (outro fluxo j√° respondeu).
    if (ehJustificativa) {
        return "";
    }

    // 5) Fallback gen√©rico (quando √© assunto Clara, mas n√£o bateu em nada acima)
    return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cart√£o Clara, o gasto precisa ser <b>necess√°rio pra opera√ß√£o da loja</b> (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal, √°gua/coffee break autorizado pra treinamento interno ou a√ß√£o oficial).</p>
<p class="mt-2">O que <b>n√£o pode</b> no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (refei√ß√£o pessoal, compra pra uso pr√≥prio etc.);<br/>
‚Ä¢ bebida alco√≥lica em geral;<br/>
‚Ä¢ transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira, entre outros).</p><br/>
Caso entenda que a compra √© essencial para o dia a dia da loja, fale com o financeiro, caso seja verificado que o item √© essencial eles podem abrir uma exce√ß√£o para a compra.
</div>`;
}

    /* ========= FUN√á√ïES DE PEND√äNCIAS (BACKEND) ========= */

    function consultarPendenciasNoServidor(loja) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (!res || !res.ok) {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  N√£o consegui consultar as pend√™ncias da loja <b>${loja}</b>.<br/>
                  Detalhe: ${erro}
                  </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // üÜï loja n√£o existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  A numera√ß√£o informada n√£o existe, pe√ßo que verifique o n¬∫ correto da loja.
                  </p>`
                    );
                    // continua aguardando n√∫mero da loja
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // dispara o timer de 10s
                    return;
                }

                // loja existe, mas N√ÉO tem pend√™ncias na CLARA_PEND
                if (!res.rows || res.rows.length === 0) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                N√£o encontrei pend√™ncias para a loja <b>${loja}</b> na √∫ltima data de cobran√ßa.
                </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // ‚úÖ loja v√°lida + tem pend√™ncias ‚Üí continua igual
                ultimaPendenciaResumo = { loja: res.loja, data: res.ultimaData };
                lojaPendenciasAtual = res.loja;

                let tabela = `
                <div class="text-sm text-slate-700">
                <p>Encontrei abaixo as √∫ltimas pend√™ncias Clara da loja <b>${res.loja}</b> (data de cobran√ßa <b>${res.ultimaData}</b>). Caso a pend√™ncia j√° tenha sido regularizada e o seu cart√£o ainda esteja bloqueado, solicite o desbloqueio atrav√©s de abertura de chamado no ServiceNow, caminho: <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Desbloqueio</b>.</p>
                <div class="mt-2 overflow-x-auto">
                <table class="min-w-full text-xs border border-slate-200">
                <thead class="bg-slate-100">
                <tr>`;

                const header = res.header || [];
                header.forEach(h => {
                    tabela += `<th class="border px-2 py-1">${h}</th>`;
                });
                tabela += `</tr></thead><tbody>`;

                res.rows.forEach(linha => {
                    tabela += `<tr>`;
                    linha.forEach(col => {
                        tabela += `<td class="border px-2 py-1">${col !== null && col !== undefined ? col : ""}</td>`;
                    });
                    tabela += `</tr>`;
                });

                tabela += `</tbody></table></div></div>`;

                renderBotMessage("HTML:" + tabela);

                estadoPendencias = "aguardando_confirmacao_email";

                renderBotMessage(
                  'HTML:' +
                  '<div class="text-sm text-slate-700 mt-2">' +
                    '<p>Quer que eu envie esse resumo por e-mail tamb√©m?</p>' +
                    '<div class="mt-2 flex gap-2">' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'Sim' +
                      '</button>' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'n√£o\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'N√£o' +
                      '</button>' +
                    '</div>' +
                  '</div>'
                );
                
            })
            .withFailureHandler(function(err) {
                console.error("Erro getPendenciasPorLoja:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pend√™ncias dessa loja. Tente novamente mais tarde.</p>'
                );
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
            })
            .getPendenciasPorLoja(loja);
    }

                function consultarPendenciasBloqueio(loja) {
        google.script.run
            .withSuccessHandler(res => {
                // erro gen√©rico
                if (!res || !res.ok) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // üÜï loja n√£o existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    A numera√ß√£o informada n√£o existe, pe√ßo que verifique o n¬∫ correto da loja.
                    </p>`
                    );
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // timer de 10s
                    return;
                }

                // se chegou aqui, loja √© v√°lida ‚Üí precisa ter html
                if (!res.html) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // mostra o HTML (tabela ou "N√£o encontrei pend√™ncias")
                renderBotMessage("HTML:" + res.html);

                // üü° CASO 1: loja v√°lida mas sem pend√™ncias
                if (res.html.includes("N√£o encontrei pend√™ncias")) {
                    estadoPendencias = "nenhum";

                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700 mt-2">
                  Acredito que, caso realmente o cart√£o esteja bloqueado, possa ser por algum outro motivo. Verifique com o time do Financeiro o que pode ter ocorrido, ok?
                  </p>`
                    );
                    return;
                }

                   // üü¢ CASO 2: loja v√°lida + tem pend√™ncias ‚Üí pergunta se quer e-mail
                    estadoPendencias = "aguardando_confirmacao_email";

                    renderBotMessage(
                      'HTML:' +
                      '<div class="text-sm text-slate-700 mt-2">' +
                        '<p>Quer que eu envie esse resumo por e-mail tamb√©m?</p>' +
                        '<div class="mt-2 flex gap-2">' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'Sim' +
                          '</button>' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'n√£o\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'N√£o' +
                          '</button>' +
                        '</div>' +
                      '</div>'
                    );
            })
            .withFailureHandler(err => {
                estadoPendencias = "nenhum";
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
            Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
            </p>`
                );
            })
            .getPendenciasParaBloqueio(loja);
    }


    function chamarEnvioPendenciasPorEmail(loja, email) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Enviei o resumo das pend√™ncias da loja <b>${res.loja || loja}</b> para o e-mail <b>${email}</b> (data de cobran√ßa: <b>${res.data || (ultimaPendenciaResumo && ultimaPendenciaResumo.data) || ""}</b>). N√£o se esque√ßa de regularizar as justificativas na plataforma da Clara e posteriormente encaminhar chamado para que o cart√£o seja desbloqueado (caso esteja bloqueado).</p>`
                    );
                } else {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Tentei enviar o e-mail de pend√™ncias, mas deu problema: ${erro}.</p>`
                    );
                }
            })
            .withFailureHandler(function(err) {
                console.error("Erro enviarPendenciasPorEmail:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail de pend√™ncias. Tente novamente mais tarde.</p>'
                );
            })
            .enviarPendenciasPorEmail(loja, email);
    }

    /* ========= MOTOR DA POL√çTICA ========= */

 function gerarRespostaPolitica(msgUsuario) {
        const norm = normalize(msgUsuario);
        const intencao = detectarIntencaoPergunta(norm);

        // 0) Frases de compra/uso em primeira pessoa (mais espec√≠ficas que categoria gen√©rica)
    const fraseCompraPrimeiraPessoa =
      norm.includes("paguei ") ||
      norm.includes("paguei meu") ||
      norm.includes("paguei minha") ||
      norm.includes("usei o cartao") ||
      norm.includes("usei o cart√£o") ||
      norm.includes("vou comprar") ||
      norm.includes("vou compra") ||
      norm.includes("posso usar o cartao") ||
      norm.includes("posso usar o cart√£o") ||
      norm.includes("usei o cartao clara") ||
      norm.includes("usei o cart√£o clara");

    if (fraseCompraPrimeiraPessoa) {
      // usa a l√≥gica j√° existente de casos espec√≠ficos (proibidos/permitidos)
      return respGenerica(norm);
    }

// 1) Primeiro tenta responder usando o motor de categorias da pol√≠tica,
//    EXCETO quando a pergunta √© claramente sobre ETIQUETA
let resultadoCategoria = null;

if (intencao !== "etiqueta") {
  resultadoCategoria = tentarResponderPorCategoriaPolitica(msgUsuario, norm);
}

if (resultadoCategoria) {
  return vektorBlocoRaciocinioPolitica(
    resultadoCategoria.mensagemUsuario,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

  // 2) Se n√£o bateu em uma categoria espec√≠fica, tenta ver se √© pedido de RESUMO de categorias
  if (typeof tentarResponderResumoCategoriasPolitica === "function") {
    const resultadoResumo = tentarResponderResumoCategoriasPolitica(norm);
    if (resultadoResumo) {
      return vektorBlocoRaciocinioPolitica(
        resultadoResumo.mensagemUsuario,
        "",
        typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
          ? POLITICA_CARTOES_CLARA_LINK
          : ""
      );
    }
  }

        // gasto pessoal alimenta√ß√£o
        const padroesGastoPessoalAlimentacao = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","meu lanche com o cartao","meu lanche com o cart√£o",
            "minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));
        if (isGastoPessoalAlimentacao) {
  ultimaIntencao = "gasto_pessoal_alimentacao";
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Gasto pessoal com alimenta√ß√£o n√£o √© permitido no cart√£o Clara</b></p>
    <p class="mt-2">Refei√ß√µes pessoais como almo√ßo, jantar, lanches ou consumo individual n√£o podem ser pagos com o cart√£o corporativo, pois n√£o s√£o despesas operacionais da loja.</p>
    <p class="mt-2">Se a compra j√° foi realizada, ela deve ser tratada como uso indevido.

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orienta√ß√£o completa no ServiceNow / pol√≠tica</summary>
      <div class="mt-2">
        <p>Quando houver uso do cart√£o Clara para gasto pessoal, a loja deve:</p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Classificar a compra na Clara como <b>Despesa pessoal ‚Äì Uso indevido</b>;</li>
          <li>Providenciar o ressarcimento do valor √† empresa dentro do prazo definido;</li>
          <li>Formalizar o caso no ServiceNow, se orientado pelo Financeiro.</li>
        </ul>
        <p class="mt-2">O chamado a ser utilizado √© <b>Gasto indevido (pessoal) / Ressarcimento ‚Äì Cart√£o Clara</b>, com descri√ß√£o do ocorrido, valor, data e loja.</p>
        <p class="mt-3 text-xs text-slate-500">Uso indevido pode gerar bloqueio preventivo do cart√£o e impactos administrativos para a loja.</p>
      </div>
    </details>
  </div>`;
}

        let resposta;

        switch (intencao) {
            case "foraEscopo":
                ultimaIntencao = "foraEscopo";
                resposta = respostaForaEscopo();
                break;


             // üîπ NOVO: transa√ß√£o negada / categoria bloqueada
            case "transacaoNegadaCategoria":
                ultimaIntencao = "transacaoNegadaCategoria";
                resposta = respTransacaoNegadaCategoria();
                break;   


            case "etiqueta": {
                ultimaIntencao = "etiqueta";
                const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));
                const et = acharEtiquetaPorMensagem(norm);

                if (!et && isPerguntaGeral) {
                    resposta = respCatalogoEtiquetas();
                } else if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
              N√£o consegui identificar uma etiqueta espec√≠fica s√≥ com esse texto.<br/>
              Se o gasto for operacional e n√£o existir etiqueta adequada na lista da Clara, abra chamado no
              <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
              <strong>ServiceNow</strong>
              </a>
              solicitando cria√ß√£o ou ajuste de etiqueta.
              </p>`;
                }
                break;
            }


            case "sobreBot":
            resposta = `HTML:<div class="text-sm text-slate-700">
          <p>Sou o <b>Vektor</b> ü§ñ ‚Äî Agente do <b>Grupo SBF</b> especializado no <b>cart√£o Clara</b>.

          <p class="mt-2">Posso te ajudar com v√°rias coisas, por exemplo:
          <ul class="list-disc ml-5 mt-1">
          <li>Explicar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>;</li>
          <li>Orientar sobre <b>o que pode e o que n√£o pode ser comprado</b>;</li>
          <li>Indicar a <b>etiqueta correta</b> pra cada tipo de gasto (ex.: √°gua, lanche, inform√°tica, manuten√ß√£o...);</li>
          <li>Guiar sobre <b>bloqueio e desbloqueio</b> do cart√£o;</li>
          <li>Consultar <b>pend√™ncias da loja</b> e at√© <b>enviar o resumo por e-mail</b>;</li>
          <li>Consultar <b>transa√ß√µes efetuadas</b> e tamb√©m comparar com outras lojas ou times</b>;</li>
          <li>Mostrar <b>como solicitar novo cart√£o</b> (primeira ou segunda via);</li>
          <li>Explicar sobre o <b>Termo de Responsabilidade</b> e onde preencher;</li>
          <li>Responder d√∫vidas sobre <b>sangria, limite, reembolsos e presta√ß√£o de contas</b>;</li>
          <li>E, claro, te direcionar para os canais certos como <b>Financeiro</b> ou <b>ServiceNow</b> quando for preciso.

          <p class="mt-3">Basta me perguntar de forma natural, tipo:</p>
          <p>‚Ä¢ ‚ÄúQual etiqueta usar para lanche de treinamento?‚Äù<br/>
          ‚Ä¢ ‚ÄúPosso comprar mouse no cart√£o Clara?‚Äù<br/>
          ‚Ä¢ ‚ÄúQuais lojas/times com maior valor/quantidade de transa√ß√µes?‚Äù<br/>
          ‚Ä¢ ‚ÄúTimes X, Y ou Z no periodo XXXXX‚Äù<br/>
          ‚Ä¢ ‚ÄúPend√™ncias da loja 1234?‚Äù</p>

          <p class="mt-3 italic text-slate-500">Estou aqui pra facilitar o dia a dia das lojas no uso do cart√£o Clara. üíú</p>
          </div>`;
            break;

            case "limite":
                ultimaIntencao = "limite";
                resposta = respLimite();
                break;

                    case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
            resposta = respCartaoGeral();
            break;

    
            case "bloqueio": {
                  ultimaIntencao = "bloqueio";

                  // 1) Envia a mensagem principal de bloqueio (j√° aparece com os 3 pontinhos)
                  renderBotMessage(respBloqueio());

                  // 2) Prepara o estado para o fluxo de pend√™ncias ligadas a bloqueio
                  origemPendenciasBloqueio = true;
                  estadoPendencias = "aguardando_loja";
                  lojaPendenciasAtual = "";
                  ultimaPendenciaResumo = null;

                  // 3) Agenda a PR√ìXIMA mensagem, com delay, tamb√©m usando renderBotMessage
                  //    ‚Üí assim aparece de novo o "digitando..." antes dela
                  setTimeout(() => {
                      renderBotMessage(`HTML:<p class="text-sm text-slate-700">
              Caso realmente seu cart√£o esteja bloqueado, devido a situa√ß√µes ligadas a pend√™ncias de justificativas de transa√ß√µes na Clara, posso te mostrar as pend√™ncias mais recentes do cart√£o da sua loja, da√≠ voc√™ j√° corre l√° no app da Clara pra regularizar üòâ .<br/><br/>
              üó£Ô∏è Me informa o n√∫mero da loja, por favor.
              </p>`);
                  }, 1000); // 1000 ms = 1 segundo depois da primeira mensagem

                  // 4) N√£o devolve texto pro fluxo principal, porque a segunda mensagem
                  //    j√° vai ser enviada pelo setTimeout
                  return null;
              }

            case "prestacao":
                ultimaIntencao = "prestacao";
                resposta = respPrestacaoContas();
                break;

            case "alimentoTime":
                ultimaIntencao = "alimentoTime";
                resposta = respAlimentoTime();
                break;

            case "transportePessoal":
                ultimaIntencao = "transportePessoal";
                resposta = respTransportePessoal();
                break;

            case "trocaGerente":
    ultimaIntencao = "trocaGerente";

    // norm j√° foi calculado no come√ßo de gerarRespostaPolitica
    const falaMudancaEntreLojas =
      norm.includes("mudar de loja") ||
      norm.includes("mudei de loja") ||
      norm.includes("mudanca de loja") ||
      norm.includes("mudan√ßa de loja") ||
      norm.includes("troca de loja") ||
      norm.includes("trocar de loja") ||
      norm.includes("vou mudar de loja") ||
      norm.includes("fui transferido") ||
      norm.includes("fui transferida") ||
      norm.includes("transferido de loja") ||
      norm.includes("transferida de loja") ||
      norm.includes("transferencia de loja") ||
      norm.includes("transfer√™ncia de loja") ||
      norm.includes("mudei de unidade") ||
      norm.includes("trocar de unidade") ||
      norm.includes("troquei de loja") ||
      norm.includes("sou de outra loja") ||
      norm.includes("sou de outra unidade") ||
      norm.includes("troca de gerente");

    if (falaMudancaEntreLojas) {
        resposta = respTrocaGerenteMudancaLojas();
    } else {
        // f√©rias, afastamento, desligado, sem gerente etc.
        resposta = respTrocaGerente();
    }
    break;

            case "procedimentosServiceNow":
                ultimaIntencao = "procedimentosServiceNow";
                resposta = respProcedimentosServiceNow();
                break;


            case "sangria":
                ultimaIntencao = "sangria";
                resposta = respSangria();
                break;

            case "fraudeContestacao":
                ultimaIntencao = "fraudeContestacao";
                resposta = respFraudeContestacao();
                break;

                case "podeNaoPode":
                case "generica":
                default:
                    ultimaIntencao = "generica";

                    // antes do gen√©rico
                    if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) {
                      // deixa o bloco singular tratar; n√£o cai no gen√©rico
                      return;
                    } else {
                      resposta = respGenerica(norm);
                    }
                    break;
                        }

        return resposta;
    }

    // ====== MINI BOT DO MANUAL CLARA ======

    
const MANUAL_CLARA_LINK = "https://drive.google.com/file/d/1TYJ7x5Uxb5C47pNpUDWIzxXZb9lJfm8I/view?usp=sharing";
const POLITICA_CARTOES_CLARA_LINK = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";
const LOOKER_RELATORIO_URL = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

window.vektorManualClaraSecao = function (secaoId) {
  let html = "";

  if (secaoId === "primeiro_acesso") {
    html =
      "<p><b>01 Primeiro acesso:</b></p><br>" +
      "<p>1Ô∏è‚É£ Verifique se voc√™ recebeu o e-mail da Clara com o assunto <b>‚ÄúJunte-se √† Clara‚Äù</b> (olhe tamb√©m no SPAM).</p>" +
      "<p>2Ô∏è‚É£ Siga o link do e-mail para criar sua senha.</p>" +
      "<p>3Ô∏è‚É£ Ative a autentica√ß√£o em 2 etapas com um app como o <b>Google Authenticator</b> e escaneie o QR Code ao fazer o primeiro login no site da Clara.</p>" +
      "<p>4Ô∏è‚É£ Depois disso, sempre que entrar no site ser√° pedido o c√≥digo de 6 d√≠gitos gerado pelo app de autentica√ß√£o.</p>";
  }

  else if (secaoId === "recebi_cartao") {
    html =
      "<p><b>02 Recebi o cart√£o, e agora?</b></p><br>" +
      "<p>1Ô∏è‚É£ Baixe o app <b>Clara Card</b> (iOS ou Android).</p>" +
      "<p>2Ô∏è‚É£ Fa√ßa login com o mesmo e-mail/senha que voc√™ usa na plataforma Clara.</p>" +
      "<p>3Ô∏è‚É£ V√° em <b>Cart√µes</b>, selecione o cart√£o recebido e clique em <b>Ativar</b>.</p>" +
      "<p>4Ô∏è‚É£ Informe os <b>4 √∫ltimos d√≠gitos</b> do cart√£o e conclua a ativa√ß√£o.</p>" +
      "<p>Depois disso o cart√£o j√° fica pronto para uso.</p>";
  }

  else if (secaoId === "esqueci_senha") {
    html =
      "<p><b>03 Esqueci a senha do cart√£o / acesso:</b></p><br>" +
      "<p>üîê <b>Senha do cart√£o</b>: voc√™ v√™ apenas pelo aplicativo da Clara, em <b>Cart√µes &gt; Ver senha</b>. A senha √© gerada automaticamente e n√£o √© alter√°vel.</p><br>" +
      "<p>üîë <b>Senha de login</b>: se esqueceu, use a op√ß√£o de <b>redefinir senha</b> na tela de login da Clara. Um link ser√° enviado para seu e-mail para criar uma nova senha.</p>" +
      "<p>Se voc√™ perdeu acesso ao app de autentica√ß√£o (2 etapas), pe√ßa para algu√©m com acesso administrativo redefinir sua autentica√ß√£o.</p>";
  }

  else if (secaoId === "qual_meu_acesso") {
    html =
      "<p><b>04 Qual o meu acesso?</b></p><br>" +
      "<p>1Ô∏è‚É£ Entre na plataforma Clara pelo computador.</p>" +
      "<p>2Ô∏è‚É£ Clique em <b>Meu Perfil</b>, no canto superior direito.</p>" +
      "<p>3Ô∏è‚É£ Na √°rea de <b>A√ß√µes do usu√°rio</b> aparece o seu tipo de acesso:</p>" +
      "<ul>" +
        "<li>‚Ä¢ <b>Administrador (Owner)</b>: acesso total, v√™ saldo global, faturas, relat√≥rios completos.</li>" +
        "<li>‚Ä¢ <b>Gerente (Manager)</b>: gerencia usu√°rios/cart√µes do seu grupo e v√™ saldo global.</li>" +
        "<li>‚Ä¢ <b>Colaborador (Employee)</b>: v√™ somente seus cart√µes, transa√ß√µes e pode anexar notas.</li>" +
        "<li>‚Ä¢ <b>Contador (Accountant)</b>: acesso a todas as faturas, boletos, relat√≥rios e transa√ß√µes.</li>" +
      "</ul>";
  }

  else if (secaoId === "anexar_comprovante") {
    html =
      "<p><b>05 Como anexar comprovante?</b></p><br>" +
      "<p><b>Pelo app (celular):</b></p>" +
      "<ol>" +
        "<li>1. Abra o app da Clara e fa√ßa login.</li>" +
        "<li>2. V√° em <b>Transa√ß√µes</b> e selecione a compra.</li>" +
        "<li>3. Toque em <b>Anexar</b> e tire foto ou escolha o arquivo (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um <b>coment√°rio</b> explicando a despesa.</li><br>" +
      "</ol>" +
      "<p><b>Pelo computador:</b></p>" +
      "<ol>" +
        "<li>1. Acesse a plataforma Clara e v√° em <b>Transa√ß√µes</b>.</li>" +
        "<li>2. Clique na transa√ß√£o desejada.</li>" +
        "<li>3. Em <b>Selecionar arquivos</b>, envie o comprovante (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um coment√°rio explicando a despesa.</li>" +
      "</ol>";
  }

  else if (secaoId === "duvidas") {
    html =
      "<p><b>06 D√∫vidas:</b></p><br>" +
      "<p>Alguns pontos importantes:</p>" +
      "<ul>" +
        "<li>‚Ä¢ <b>Autentica√ß√£o em 2 etapas</b>: sempre use o c√≥digo de 6 d√≠gitos do app de autentica√ß√£o ao entrar no site.</li>" +
        "<li>‚Ä¢ <b>Problema de login</b>: verifique e-mail min√∫sculo, senha correta ou use ‚ÄúContinuar com Google‚Äù se j√° usou antes.</li>" +
        "<li>‚Ä¢ <b>Perdi o celular ou cart√£o</b>: pe√ßa para algu√©m com acesso administrativo bloquear/cancelar o cart√£o e criar outro.</li>" +
        "<li>‚Ä¢ <b>Cancelamento/estorno</b>: tente primeiro com o estabelecimento; se n√£o resolver, conteste a transa√ß√£o via app/plataforma da Clara.</li>" +
      "</ul>" +
      "<p>Canais de suporte Clara: telefone 0800, e-mail, chat na Central de Ajuda (conforme manual).</p>";
  }

  if (!html) return;

  // Rodap√© padr√£o com link para o manual completo
  html +=
    "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
      "Caso queira mais detalhes, acesse o manual completo: " +
      "<a href='" + MANUAL_CLARA_LINK + "' target='_blank' style='color:#005E27;font-weight:bold;'>Manual do Usu√°rio Clara</a>." +
    "</p>";

  // üëâ REGISTRA o t√≥pico no hist√≥rico
  try {
    registrarTopicoManualClara(secaoId);
  } catch (e) {
    console.warn("N√£o consegui registrar hist√≥rico do manual:", e);
  }

  // Envia a resposta principal
  renderBotMessage("HTML:<div class='text-sm text-slate-700'>" + html + "</div>");
  scrollToBottom && scrollToBottom();

  // üëâ Mostra um resumo do que o usu√°rio j√° acessou (se tiver mais de 1 item)
  //vektorMostrarHistoricoManualSeExistir();

    // üëâ Sugest√£o autom√°tica baseada no t√≥pico aberto
  if (typeof window.vektorSugerirTopicoRelacionadoManual === "function") {
    window.vektorSugerirTopicoRelacionadoManual(secaoId);
  }
};

// Mapeia o ID t√©cnico para um t√≠tulo amig√°vel
function mapSecaoManualParaTitulo(secaoId) {
  switch (secaoId) {
    case "primeiro_acesso":
      return "01 Primeiro acesso";
    case "recebi_cartao":
      return "02 Recebi o cart√£o, e agora?";
    case "esqueci_senha":
      return "03 Esqueci a senha do cart√£o / acesso";
    case "qual_meu_acesso":
      return "04 Qual o meu acesso?";
    case "anexar_comprovante":
      return "05 Como anexar comprovante?";
    case "duvidas":
      return "06 D√∫vidas";
    default:
      return null;
  }
}

// Salva o hist√≥rico no localStorage (m√°x. 20 registros)
function registrarTopicoManualClara(secaoId) {
  try {
    const titulo = mapSecaoManualParaTitulo(secaoId);
    if (!titulo) return;

    const STORAGE_KEY = "vektor_manual_clara_historico";

    let historico = [];
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) historico = parsed;
      } catch (e) {
        console.warn("Hist√≥rico do manual Clara estava corrompido, reiniciando.");
      }
    }

    historico.push({
      secao: secaoId,
      titulo: titulo,
      dataIso: new Date().toISOString()
    });

    // limita a 20 entradas mais recentes
    if (historico.length > 20) {
      historico = historico.slice(historico.length - 20);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(historico));
  } catch (e) {
    console.warn("Erro ao salvar hist√≥rico do manual Clara:", e);
  }
}

// L√™ o hist√≥rico e devolve ordenado do mais recente para o mais antigo
function obterHistoricoManualClara() {
  const STORAGE_KEY = "vektor_manual_clara_historico";
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];

    // ordena do mais recente para o mais antigo
    return parsed
      .filter(item => item && item.titulo && item.dataIso)
      .sort((a, b) => (a.dataIso || "").localeCompare(b.dataIso || ""));
  } catch (e) {
    console.warn("Erro ao ler hist√≥rico do manual Clara:", e);
    return [];
  }
}

// Mostra uma mensagem "Voc√™ j√° acessou recentemente..." no chat
function vektorMostrarHistoricoManualSeExistir() {
  try {
    const historico = obterHistoricoManualClara();
    if (!historico || historico.length <= 1) {
      // se s√≥ tem 0 ou 1 item, n√£o faz sentido falar em "recentemente"
      return;
    }

    // pega no m√°ximo 5 mais recentes (sem duplicar t√≠tulos)
    const vistos = [];
    const titulosJaUsados = new Set();

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || !item.titulo) continue;
      if (titulosJaUsados.has(item.titulo)) continue;

      titulosJaUsados.add(item.titulo);
      vistos.push(item.titulo);

      if (vistos.length >= 5) break;
    }

    if (!vistos.length) return;

    const listaHtml = vistos
      .map(t => "<li>‚Ä¢ " + t + "</li>")
      .join("");

    const html =
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Voc√™ j√° acessou recentemente:</b></p>" +
        "<ul style='margin-top:4px;margin-left:16px;'>" +
          listaHtml +
        "</ul>" +
        "<p style='margin-top:6px;font-size:12px;color:#64748b;'>" +
          "Voc√™ pode clicar novamente nos bot√µes do Manual da Clara para reabrir qualquer um desses t√≥picos." +
        "</p>" +
      "</div>";

    renderBotMessage("HTML:" + html);
    if (typeof scrollToBottom === "function") {
      scrollToBottom();
    }
  } catch (e) {
    console.warn("Erro ao mostrar hist√≥rico do manual Clara:", e);
  }
}

// ---------------------------------------------------------------------
// SUGEST√ïES GERAIS DO VEKTOR (fora do Manual da Clara)
// ---------------------------------------------------------------------

function vektorSugerirTopicosGerais(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);
    const blocos = [];

    // 1) D√∫vidas de PERMISS√ÉO DE COMPRA ‚Üí sugerir Pol√≠tica de Uso (apenas 1 vez por sess√£o)
    if (
      !__vektorJaSugeriuPoliticaRestricoes &&
      (
        norm.includes("pode comprar") ||
        norm.includes("posso comprar") ||
        norm.includes("pode usar") ||
        norm.includes("posso usar") ||
        norm.includes("pode pagar") ||
        norm.includes("posso pagar") ||
        norm.includes("permitido") ||
        norm.includes("permitida") ||
        norm.includes("proibido") ||
        norm.includes("proibida")
      ) &&
      typeof POLITICA_CARTOES_CLARA_LINK === "string"
    ) {
      __vektorJaSugeriuPoliticaRestricoes = true;

      blocos.push(
        "<div style='margin-top:6px;'>" +
          "<p><b>Dica:</b> sempre que tiver d√∫vida se uma compra √© permitida ou n√£o, voc√™ pode consultar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>, <b>Item 7 - Restri√ß√µes de Uso</b>.</p>" +
          "<button type='button' " +
            "onclick=\"window.open('" + POLITICA_CARTOES_CLARA_LINK + "','_blank')\" " +
            "style='margin-top:6px;background:#06167d;color:#fff;border:none;" +
                   "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir Pol√≠tica de Uso dos Cart√µes Clara" +
          "</button>" +
        "</div>"
      );
    }

    // 2) Pedidos de RELAT√ìRIO / RANKING / DASHBOARD ‚Üí sugerir Looker Studio (apenas 1 vez)
    if (
      !__vektorJaSugeriuLooker &&
      (
        norm.includes("top") ||
        norm.includes("mais comprou") ||
        norm.includes("mais gastos") ||
        norm.includes("mais gastou") ||
        norm.includes("mais compras") ||
        norm.includes("maior valor") ||
        norm.includes("mais transa√ß√µes") ||
        norm.includes("mais transacoes")
      )
    ) {
      blocos.push(
        "<div style='margin-top:10px;'>" +
          "<p>Se quiser uma vis√£o completa (gr√°ficos, filtros e detalhamentos), posso abrir o <b>relat√≥rio gerencial</b> aqui no chat:</p>" +
          "<button type='button' " +
            "onclick=\"window.vektorAbrirRelatorioGerencialNoChat()\" " +
            "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
                  "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir relat√≥rio gerencial no chat" +
          "</button>" +
        "</div>"
      );

      __vektorJaSugeriuLooker = true;
    }

    // 3) PEND√äNCIAS / JUSTIFICATIVAS ‚Üí refor√ßar pol√≠tica e fluxo (apenas 1 vez por sess√£o)
    if (
      !__vektorJaSugeriuJustificativas &&
      (
        norm.includes("pendencia") ||
        norm.includes("pend√™ncia") ||
        norm.includes("pendencias") ||
        norm.includes("pend√™ncias") ||
        norm.includes("justificativa") ||
        norm.includes("justificativas") ||
        norm.includes("justificar") ||
        norm.includes("justificativas completas") ||
        norm.includes("ver justificativas completas") ||
        norm.includes("justificativas de uma loja") ||
        norm.includes("justificativas de um time")
      )
    ) {
      __vektorJaSugeriuJustificativas = true;

      blocos.push(
  "<div style='margin-top:10px;'>" +
    "<p>Al√©m de anexar os comprovantes, existe uma pol√≠tica espec√≠fica de prazos e regras para justificativas.</p>" +
    "<p style='margin-top:4px;'>Em caso de d√∫vida, consulte a <b><a href='" +
      (typeof POLITICA_CARTOES_CLARA_LINK !== 'undefined'
        ? POLITICA_CARTOES_CLARA_LINK
        : '#') +
      "' target='_blank' style='color:#005E27; text-decoration:underline;'>Pol√≠tica de Uso dos Cart√µes Clara</a></b> ou acione o time de Conta a Receber.</p>" +
  "</div>"
);
    }

    // Se nada acionou, n√£o sugere nada
    if (!blocos.length) return;

    const html =
      "HTML:<div class='text-sm text-slate-700 mt-2'>" +
        blocos.join("<hr style='margin:8px 0;border:none;border-top:1px solid #e2e8f0;'/>") +
      "</div>";

    // üîÅ Aguarda para dar tempo da resposta "normal" aparecer antes
    setTimeout(function () {
      renderBotMessage(html);
      if (typeof scrollToBottom === "function") {
        scrollToBottom();
      }
    }, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir t√≥picos gerais:", e);
  }

  // Sugest√£o quando o usu√°rio fala de ciclo de fatura
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("per√≠odo da fatura")
  ) {
    vektorMostrarSugestao(
      "Quer ver a tabela completa das faturas?",
      "Quero ver a tabela de faturas da Clara"
    );
  }
}

// ---------------------------------------------------------------------
// SUGEST√ïES AUTOM√ÅTICAS DO MANUAL DA CLARA A PARTIR DE OUTROS ASSUNTOS
// ---------------------------------------------------------------------

const VEKTOR_TEMPO_SUGESTAO_MIN = 5000; // Depois que j√° sugeriu...
const VEKTOR_SUGESTAO_DELAY_MS = 15000;   // Primeira vez que sugeriu

// Verifica se o usu√°rio j√° abriu um t√≥pico do manual h√° pouco tempo
function usuarioViuTopicoManualRecentemente(secaoId, minutosJanela) {
  try {
    minutosJanela = minutosJanela || 10; // padr√£o = 10 minutos
    const historico = obterHistoricoManualClara();
    if (!historico || !historico.length) return false;

    const agora = Date.now();
    const limiteMs = minutosJanela * 60 * 1000;

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || item.secao !== secaoId || !item.dataIso) continue;

      const t = Date.parse(item.dataIso);
      if (!isNaN(t) && (agora - t) <= limiteMs) {
        return true; // j√° viu recentemente
      }
    }
  } catch (e) {
    console.warn("Erro ao checar hist√≥rico recente do manual:", e);
  }
  return false;
}

// L√™ a pergunta do usu√°rio e, se fizer sentido, sugere um t√≥pico do Manual da Clara

function vektorSugerirManualAPartirDaPergunta(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);

    // Se o usu√°rio j√° pediu o manual explicitamente, n√£o sugerimos aqui
    if (
      norm.includes("manual clara") ||
      norm.includes("manual da clara") ||
      norm.includes("treinamento clara") ||
      norm.includes("treinamento da clara")
    ) {
      return;
    }

    let sugestao = null;

    // 1) Comprovante / nota / justificativa ‚Üí sugerir "Como anexar comprovante"
if (
  norm.includes("comprovante") ||
  norm.includes("nota fiscal") ||
  norm.includes(" nf ") ||
  norm.includes(" xml") ||
  norm.includes("justificativa") ||
  norm.includes("justificar") ||
  norm.includes("pendencia") ||
  norm.includes("pendencias") ||
  norm.includes("pend√™ncias") ||
  norm.includes("pend√™ncia")
) {
  // ‚ùó S√≥ sugere uma vez por sess√£o
  if (vektorSugestaoJaMostrada("manual_anexar_comprovante")) {
    return; // j√° sugeriu antes nesta sess√£o, n√£o repete
  }

  vektorMarcarSugestaoMostrada("manual_anexar_comprovante");

  sugestao = {
    secaoId: "anexar_comprovante",
    tituloBotao: "Ver como anexar comprovante",
    textoIntro:
      "Percebi que voc√™ est√° falando de nota fiscal, comprovante ou pend√™ncia. Quer abrir o trecho do Manual da Clara sobre isso?"
  };
}

    // 2) Problemas de login / primeiro acesso
    else if (
      norm.includes("primeiro acesso") ||
      norm.includes("primeiro login") ||
      norm.includes("junte-se a clara") ||
      norm.includes("junte se a clara") ||
      norm.includes("nao consigo acessar") ||
      norm.includes("n√£o consigo acessar") ||
      norm.includes("erro de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("primeiro_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "primeiro_acesso",
          tituloBotao: "Ver instru√ß√µes de primeiro acesso",
          textoIntro:
            "Se for sua primeira vez usando a Clara ou estiver com dificuldade de acesso, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 3) Esqueci a senha / senha do cart√£o
    else if (
      norm.includes("esqueci a senha") ||
      norm.includes("esqueci minha senha") ||
      norm.includes("senha do cartao") ||
      norm.includes("senha do cart√£o") ||
      norm.includes("senha de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("esqueci_senha", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "esqueci_senha",
          tituloBotao: "Ver como recuperar/consultar senha",
          textoIntro:
            "Voc√™ comentou sobre senha. Posso abrir a parte do Manual da Clara que fala sobre isso:"
        };
      }
    }

    // 4) Tipo de acesso / perfil
    else if (
      norm.includes("meu acesso") ||
      norm.includes("tipo de acesso") ||
      norm.includes("owner") ||
      norm.includes("manager") ||
      norm.includes("employee") ||
      norm.includes("contador")
    ) {
      if (!usuarioViuTopicoManualRecentemente("qual_meu_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "qual_meu_acesso",
          tituloBotao: "Ver tipos de acesso na Clara",
          textoIntro:
            "Se a d√∫vida √© sobre qual √© o seu tipo de acesso na Clara, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 5) D√∫vidas gerais, suporte, estorno, cart√£o perdido, etc.
    else if (
      norm.includes("duvida") ||
      norm.includes("d√∫vida") ||
      norm.includes("ajuda") ||
      norm.includes("suporte") ||
      norm.includes("telefone") ||
      norm.includes("0800") ||
      norm.includes("estorno") ||
      norm.includes("contestacao") ||
      norm.includes("contesta√ß√£o") ||
      norm.includes("perdi o cartao") ||
      norm.includes("perdi o cart√£o") ||
      norm.includes("cartao perdido") ||
      norm.includes("cart√£o perdido") ||
      norm.includes("cartao roubado") ||
      norm.includes("cart√£o roubado") ||
      norm.includes("bloquear cartao") ||
      norm.includes("bloquear cart√£o")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver d√∫vidas e canais de suporte",
          textoIntro:
            "Como voc√™ mencionou d√∫vidas, suporte, estorno ou perda/bloqueio de cart√£o, posso te mostrar o trecho do Manual da Clara com os principais contatos e orienta√ß√µes:"
        };
      }
    }

    // 6) Limite / aumento de limite / limite estourado
    else if (
      norm.includes("limite") ||
      norm.includes("aumentar limite") ||
      norm.includes("aumento de limite") ||
      norm.includes("ajustar limite") ||
      norm.includes("cart√£o sem limite limite") ||
      norm.includes("estourou o limite") ||
      norm.includes("limite estourado")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orienta√ß√µes gerais e canais de suporte",
          textoIntro:
            "Voc√™ falou sobre limite de cart√£o. Posso abrir a parte do Manual do usu√°rio da Clara com orienta√ß√µes gerais e canais de suporte para esse tipo de d√∫vida:"
        };
      }
    }

    // 7) Bloqueio por pend√™ncia / cart√£o recusado
    else if (
      norm.includes("cartao bloqueado") ||
      norm.includes("cart√£o bloqueado") ||
      norm.includes("cartao recusado") ||
      norm.includes("cart√£o recusado") ||
      norm.includes("nao aprovou") ||
      norm.includes("n√£o aprovou") ||
      norm.includes("recusou a compra") ||
      norm.includes("compra recusada")
    ) {
      if (!usuarioViuTopicoManualRecentemente("anexar_comprovante", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "anexar_comprovante",
          tituloBotao: "Ver como regularizar usando comprovantes",
          textoIntro:
            "Quando h√° bloqueios e recusas, muitas vezes o problema est√° em pend√™ncias de comprovantes. Quer ver o trecho do Manual que explica como anexar comprovantes e regularizar?"
        };
      }
    }

    // 8) Fraude / transa√ß√£o desconhecida / contesta√ß√£o
    else if (
      norm.includes("fraude") ||
      norm.includes("transacao desconhecida") ||
      norm.includes("transa√ß√£o desconhecida") ||
      norm.includes("lancamento indevido") ||
      norm.includes("lan√ßamento indevido") ||
      norm.includes("compra indevida")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orienta√ß√µes de contesta√ß√£o/estorno",
          textoIntro:
            "Voc√™ comentou sobre transa√ß√£o desconhecida ou poss√≠vel fraude. Posso abrir a parte do Manual do usu√°rio da Clara que fala sobre contesta√ß√£o e estorno:"
        };
      }
    }

    // Se nenhuma sugest√£o foi montada, sai
    if (!sugestao) return;

    const html =
  "HTML:<div class='text-sm text-slate-700 mt-2'>" +
    "<p>" + sugestao.textoIntro + "</p>" +
    "<button type='button' " +
      "onclick=\"vektorManualClaraSecao('" + sugestao.secaoId + "')\" " +
      "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
             "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
      sugestao.tituloBotao +
    "</button>" +
  "</div>";

// üîÅ Aguarda para dar tempo da resposta principal aparecer antes
setTimeout(function () {
  renderBotMessage(html);
  if (typeof scrollToBottom === "function") {
    scrollToBottom();
  }
}, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir t√≥pico do Manual da Clara:", e);
  }
}


// ========= SUGEST√ÉO AUTOM√ÅTICA DE T√ìPICOS RELACIONADOS ========= //

window.vektorSugerirTopicoRelacionadoManual = function (secaoId) {
  // Por enquanto vamos tratar apenas o caso "anexar_comprovante"
  if (secaoId !== "anexar_comprovante") return;

  // üîπ N√ÉO repetir essa sugest√£o v√°rias vezes na mesma sess√£o
  if (vektorSugestaoJaMostrada("politica_justificativas")) {
    return;
  }
  vektorMarcarSugestaoMostrada("politica_justificativas");

  const html =
    "HTML:<div class='text-sm text-slate-700 mt-2'>" +
      "<p><b>Sugest√£o:</b> Quer ver tamb√©m como funciona a <b>pol√≠tica de justificativas</b>?</p>" +
      "<div style='margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;'>" +
        "<button onclick=\"vektorAbrirPoliticaJustificativas()\" " +
                "class='px-3 py-2 rounded-md bg-[#005E27] text-white text-sm font-semibold'>" +
          "Ver pol√≠tica de justificativas" +
        "</button>" +
        "<button onclick=\"vektorIgnorarSugestaoPolitica()\" " +
                "class='px-3 py-2 rounded-md border text-sm'>" +
          "Agora n√£o" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
}

// Quando o usu√°rio clicar em "Ver pol√≠tica de justificativas"
window.vektorAbrirPoliticaJustificativas = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p><b>Pol√≠tica de justificativas (resumo):</b></p>" +
      "<ul style='margin-top:4px;margin-left:16px;'>" +
        "<li>‚Ä¢ Cada transa√ß√£o deve ter justificativa e comprovante anexado dentro de, no m√°ximo, 48 horas ap√≥s a cpmpra.</li><br>" +
        "<li>‚Ä¢ <b>Para justificar</b>: Inserir nota fiscal ou recibo da compra, informar a etiqueta do tipo de gasto e inserir no campo Descri√ß√£o o item adquirido.</li><br>" +
        "<li>‚Ä¢ Despesas sem justificativas ou com documentos inconsistentes podem ser questionadas pelo time Financeiro.</li><br>" +
        "<li>‚Ä¢ Em casos recorrentes, a empresa pode adotar medidas adicionais, como o bloqueio preventivo do cart√£o.</li>" +
      "</ul>" +
   // üîΩ AQUI ENTRA O LINK NO RODAP√â
      "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
        "Consulte a Pol√≠tica de Uso dos Cart√µes Clara: " +
        "<a href='" + POLITICA_CARTOES_CLARA_LINK + "' target='_blank' " +
        "style='color:#005E27;font-weight:bold;'>clique aqui para abrir</a>." +
      "</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// Caso ele clique em "Agora n√£o"
window.vektorIgnorarSugestaoPolitica = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p>Beleza. Se quiser ver a pol√≠tica de justificativas depois, √© s√≥ me pedir üòâ</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// ================= VEKTOR_STATE ‚Äì mem√≥ria leve da conversa =================
window.VEKTOR_STATE = {
  ultimaIntencao: null,         // ex: "ranking_lojas", "resumo_times", "fatura_times"
  ultimoPeriodo: null,          // { dataInicioIso, dataFimIso }
  ultimoGrupo: null,            // nome do time / grupo
  ultimaLoja: null,             // c√≥digo da loja
  ultimaAcaoExplicavel: null,   // meta da √∫ltima tabela gerada
  sugestoesMostradas: []        // controle de sugest√µes proativas para n√£o repetir
};

function vektorRegistrarContexto(evento) {
  try {
    if (!evento || typeof evento !== "object") return;

    window.VEKTOR_STATE = window.VEKTOR_STATE || {};
    Object.assign(window.VEKTOR_STATE, evento);
  } catch (e) {
    console.warn("Erro ao registrar contexto:", e);
  }
}

function vektorObterContexto() {
  return window.VEKTOR_STATE || {};
}

function vektorExplicarUltimaTabela() {
  const st = vektorObterContexto();
  const info = st.ultimaAcaoExplicavel;

  if (!info || !info.tipo) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Ainda n√£o tenho uma tabela recente para explicar. Tente pedir um ranking ou um resumo primeiro.</p>"
    );
    return;
  }

  let html = "HTML:<div class='text-sm text-slate-700'>";

  if (info.tipo === "tabela_ranking_lojas") {
    const m = info.meta || {};
    html +=
      "<p><b>Como essa tabela foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>‚Ä¢ Foram consideradas todas as transa√ß√µes da BaseClara no per√≠odo filtrado.</li>" +
        "<li>‚Ä¢ Agrupei os valores por <b>loja</b> e somei " +
          (m.criterio === "quantidade"
            ? "a quantidade de transa√ß√µes"
            : "o valor total em R$.") +
        "</li>" +
        (m.grupo
          ? "<li>‚Ä¢ Limitei somente √†s lojas do time <b>" + m.grupo + "</b>.</li>"
          : "") +
        (m.topN
          ? "<li>‚Ä¢ Mostrei apenas o <b>top " + m.topN + "</b> lojas, em ordem decrescente.</li>"
          : "<li>‚Ä¢ Listei todas as lojas com movimenta√ß√£o nesse per√≠odo.</li>") +
      "</ul>";
  } else if (info.tipo === "tabela_times") {
    const m = info.meta || {};
    html +=
      "<p><b>Como essa tabela de times foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>‚Ä¢ Usei as transa√ß√µes da BaseClara no per√≠odo selecionado.</li>" +
        "<li>‚Ä¢ Agrupei pelo campo <b>Grupo / Time</b> da planilha.</li>" +
        "<li>‚Ä¢ Para cada time, calculei quantidade de transa√ß√µes e valor total em R$.</li>" +
        "<li>‚Ä¢ Tamb√©m calculei o percentual de participa√ß√£o de cada time, em rela√ß√£o ao total do per√≠odo.</li>" +
      "</ul>";
  } else if (info.tipo === "tabela_times_fatura") {
    const m = info.meta || {};
    html +=
      "<p><b>Como a tabela de times dessa fatura foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>‚Ä¢ Primeiro filtrei as transa√ß√µes que pertencem ao <b>extrato</b> '" +
          (m.extrato || "") + "'.</li>" +
        "<li>‚Ä¢ Em seguida agrupei por <b>time</b>, somando o valor em R$ de cada um.</li>" +
        "<li>‚Ä¢ O per√≠odo usado √© o mesmo do ciclo de fatura mostrado na tabela anterior.</li>" +
      "</ul>";
  } else {
    html +=
      "<p>Ainda n√£o tenho uma explica√ß√£o espec√≠fica para esse tipo de tabela (" +
      info.tipo +
      "), mas posso te ajudar a interpretar os n√∫meros se voc√™ quiser.</p>";
  }

  html += "</div>";

  renderBotMessage(html);
}

function vektorSugestaoJaMostrada(id) {
  const st = vektorObterContexto();
  const lista = Array.isArray(st.sugestoesMostradas) ? st.sugestoesMostradas : [];
  return lista.indexOf(id) >= 0;
}

function vektorMarcarSugestaoMostrada(id) {
  if (!id) return;
  const st = vektorObterContexto();
  if (!Array.isArray(st.sugestoesMostradas)) {
    st.sugestoesMostradas = [];
  }
  if (st.sugestoesMostradas.indexOf(id) < 0) {
    st.sugestoesMostradas.push(id);
  }
}

var criterio = "quantidade";

// ========= MOTOR DE INTEN√á√ïES POR REGRAS =========

// Cada regra tem:
// - id: identificador da inten√ß√£o
// - minScore: pontua√ß√£o m√≠nima para considerar a regra "ganhadora"
// - score(norm, msgOriginal): fun√ß√£o que calcula um score com base no texto normalizado
// - run(msgOriginal, norm): fun√ß√£o que retorna o "resultado" da inten√ß√£o
const INTENT_RULES = [
  {
    id: "ACAO_LISTAR_ETIQUETAS_CLARA",
    minScore: 3,
      score: function (norm, msgOriginal) {
    if (!norm) return 0;
    let s = 0;

    const temEtiqueta =
      norm.includes("etiqueta") || norm.includes("etiquetas");

    if (!temEtiqueta) {
      // Se nem fala em etiqueta, essa inten√ß√£o n√£o faz sentido
      return 0;
    }

    // 1) Base: mencionou etiqueta ‚Üí 1 ponto (mas isso sozinho n√£o dispara a tabela)
    s += 1;

    // 2) Sinais de "vis√£o em tabela / lista consolidada"
    const falaTabela =
      norm.includes("tabela de etiquetas") ||
      norm.includes("tabela com as etiquetas") ||
      norm.includes("tabela das etiquetas") ||
      norm.includes("tabela") && temEtiqueta; // ex: "tabela por etiqueta"

    const falaLista =
      norm.includes("lista de etiquetas") ||
      norm.includes("listagem de etiquetas") ||
      norm.includes("listagem das etiquetas") ||
      norm.includes("ver todas as etiquetas") ||
      norm.includes("todas as etiquetas");

    if (falaTabela) s += 2;
    if (falaLista) s += 2;

    // 3) Sinais de an√°lise de gasto/percentual/valor
    const falaGasto =
      norm.includes("gasto por etiqueta") ||
      norm.includes("gastos por etiqueta") ||
      norm.includes("gastos por etiquetas") ||
      norm.includes("despesa por etiqueta") ||
      norm.includes("despesas por etiqueta") ||
      norm.includes("resumo por etiqueta") ||
      norm.includes("resumo de etiquetas") ||
      norm.includes("consolidado por etiqueta");

    const falaPercentual =
      norm.includes("percentual por etiqueta") ||
      norm.includes("porcentagem por etiqueta") ||
      norm.includes("percentual de uso das etiquetas") ||
      norm.includes("porcentagem de uso das etiquetas");

    const falaValor =
      norm.includes("valor por etiqueta") ||
      norm.includes("valores por etiqueta") ||
      norm.includes("quanto foi gasto em cada etiqueta");

    if (falaGasto) s += 2;
    if (falaPercentual) s += 2;
    if (falaValor) s += 2;

    // 4) Frases ‚Äúpedindo vis√£o gerencial‚Äù
    const falaVisao =
      norm.includes("visao por etiqueta") ||
      norm.includes("vis√£o por etiqueta") ||
      norm.includes("relatorio por etiqueta") ||
      norm.includes("relat√≥rio por etiqueta") ||
      norm.includes("ranking de etiquetas");

    if (falaVisao) s += 2;

    return s;
  },
  run: function (msgOriginal, norm) {
  // Se a frase pede vis√£o de gasto/valor/percentual/relat√≥rio, √© "Gastos por etiquetas"
  const falaGasto =
    norm.includes("gasto por etiqueta") ||
    norm.includes("gastos por etiqueta") ||
    norm.includes("gastos por etiquetas") ||
    norm.includes("despesa por etiqueta") ||
    norm.includes("despesas por etiqueta") ||
    norm.includes("resumo por etiqueta") ||
    norm.includes("resumo de etiquetas") ||
    norm.includes("consolidado por etiqueta");

  const falaPercentual =
    norm.includes("percentual por etiqueta") ||
    norm.includes("porcentagem por etiqueta") ||
    norm.includes("percentual de uso das etiquetas") ||
    norm.includes("porcentagem de uso das etiquetas");

  const falaValor =
    norm.includes("valor por etiqueta") ||
    norm.includes("valores por etiqueta") ||
    norm.includes("quanto foi gasto em cada etiqueta");

  const falaVisao =
    norm.includes("visao por etiqueta") ||
    norm.includes("vis√£o por etiqueta") ||
    norm.includes("relatorio por etiqueta") ||
    norm.includes("relat√≥rio por etiqueta") ||
    norm.includes("ranking de etiquetas");

  if (falaGasto || falaPercentual || falaValor || falaVisao) {
    return "ACAO_GASTOS_ETIQUETAS_CLARA";
  }

  // Caso contr√°rio, √© a listagem explicativa/cat√°logo
  return "ACAO_LISTAR_ETIQUETAS_CLARA";
}
  }

  ,{
  id: "INTENT_LISTA_DEMISSOES",
  minScore: 2,
  score: function (norm, msgOriginal) {
    // aceita varia√ß√µes simples
    const falaDemissoes =
      norm.includes("lista de demissoes") ||
      norm.includes("lista de demiss√µes");

    // for√ßa ser bem intencional: "lista" + "demiss√µes"
    const falaLista =
      norm.includes("lista") || norm.includes("listagem");

    return (falaDemissoes && falaLista) ? 3 : 0;
  },
  run: function (msgOriginal, norm) {
    return "ACAO_LISTA_DEMISSOES";
  }
}

,{ id: "INTENT_FREQUENCIA_USO_CLARA",
  minScore: 2,
  score: function (norm, msgOriginal) {
    let s = 0;

    // gatilho principal
    const falaFreq =
      norm.includes("frequencia de uso") ||
      norm.includes("frequ√™ncia de uso");

    const falaClara = norm.includes("clara");

    if (falaFreq) s += 3;
    if (falaClara) s += 1;

    // refor√ßos: "para o time" / "para a loja"
    if (norm.includes("para o time") || norm.includes("time ")) s += 1;
    if (norm.includes("para a loja") || norm.includes("loja ")) s += 1;

    return s;
  },
  run: function (msgOriginal, norm) {
    return "ACAO_FREQUENCIA_USO_CLARA";
  }
}

];

  // ‚ûú Futuro: aqui voc√™ adiciona novas regras:
  // {
  //   id: "INTENT_FATURA_ATUAL",
  //   minScore: 2,
  //   score: function (norm, msgOriginal) { ... },
  //   run: function (msgOriginal, norm) { ... }
  // }
// ];

// Fun√ß√£o que escolhe a melhor regra com base em score
function aplicarRegraDeIntencao(msgOriginal) {
  const norm = normalize(msgOriginal || "");
  if (!INTENT_RULES || !INTENT_RULES.length) return null;

  let melhorRegra = null;
  let melhorScore = 0;

  for (const regra of INTENT_RULES) {
    try {
      const s = typeof regra.score === "function"
        ? Number(regra.score(norm, msgOriginal) || 0)
        : 0;

      if (s > melhorScore) {
        melhorScore = s;
        melhorRegra = regra;
      }
    } catch (e) {
      console.warn("Erro ao calcular score de inten√ß√£o:", regra && regra.id, e);
    }
  }

  if (!melhorRegra) return null;

  const min = typeof melhorRegra.minScore === "number" ? melhorRegra.minScore : 1;
  if (melhorScore < min) {
    // Nenhuma regra atingiu o limiar m√≠nimo
    return null;
  }

  // Executa a a√ß√£o da regra encontrada
  if (typeof melhorRegra.run === "function") {
    return melhorRegra.run(msgOriginal, norm);
  }

  return null;
}

// Fallback: quando nada casa, perguntar em vez de chutar resposta
function gerarPerguntaDeClarificacao(norm) {
  norm = norm || "";

  // Se a mensagem √© claramente sobre justificativa / nota / comprovante,
  // N√ÉO gera pergunta de clarifica√ß√£o (o fluxo de justificativa j√° responde).
  const ehJustificativa =
    norm.includes("justific") ||          // justificativa / justificar
    norm.includes("nota fiscal") ||
    norm.includes("nota da compra") ||
    norm.includes("perdi a nota") ||
    norm.includes("falta a nota") ||
    norm.includes("despesa sem nota") ||
    norm.includes("despesa sem comprovante") ||
    norm.includes("comprovante") ||
    norm.includes("comprovantes");

  if (ehJustificativa) {
    return ""; // devolve vazio para n√£o mostrar nada
  }

  const temasProvaveis = [];

  // Sinais de tema ‚Üí s√≥ pra deixar a pergunta mais ‚Äúesperta‚Äù
  if (norm.includes("pendenc")) {
    temasProvaveis.push("pend√™ncias da Clara");
  }
  if (norm.includes("justific")) {
    temasProvaveis.push("justificativas das transa√ß√µes");
  }
  if (norm.includes("fatura")) {
    temasProvaveis.push("faturas / ciclo de fatura");
  }
  if (norm.includes("bloqueio") || norm.includes("bloqueado")) {
    temasProvaveis.push("bloqueio ou desbloqueio do cart√£o");
  }
  if (norm.includes("limite")) {
    temasProvaveis.push("limite do cart√£o Clara");
  }
  if (
    norm.includes("nota fiscal") ||
    norm.includes("nf ") ||
    norm.includes("nf/") ||
    norm.includes("recibo")
  ) {
    temasProvaveis.push("nota fiscal / recibo / comprovantes");
  }

  // Se n√£o achou nenhum ‚Äúcheiro‚Äù‚Ä¶
  if (!temasProvaveis.length) {

    // üîπ 1) Primeiro: checa se √© caso de SANGRIA
    const falaSangria =
      norm.includes("sangria") ||
      norm.includes("sangrias") ||
      norm.includes("fazer sangria") ||
      norm.includes("como fazer sangria") ||
      norm.includes("puxar dinheiro do caixa") ||
      norm.includes("retirar dinheiro do caixa") ||
      norm.includes("tirar dinheiro do caixa") ||
      norm.includes("retirada de dinheiro do caixa") ||
      norm.includes("movimentacao de dinheiro no caixa") ||
      norm.includes("movimenta√ß√£o de dinheiro no caixa") ||
      norm.includes("saida de dinheiro do caixa") ||
      norm.includes("sa√≠da de dinheiro do caixa") ||
      norm.includes("suprimento") ||
      norm.includes("suprimentos") ||
      norm.includes("fazer suprimento") ||
      norm.includes("registro de sangria") ||
      norm.includes("registrando sangria");

    if (falaSangria) {
      // üî∏ IMPORTANTE:
      // retorna string vazia ‚Üí N√ÉO gera pergunta de clarifica√ß√£o.
      // Isso deixa o fluxo seguir at√© o motor da pol√≠tica
      // (detectarIntencaoPergunta -> "sangria" -> respSangria).
      return "";
    }

    // üîπ 2) Se n√£o √© sangria, usa a frase padr√£o de ‚Äún√£o entendi‚Äù
    const variacoes = [
      "N√£o tenho certeza se entendi sua pergunta. Voc√™ est√° falando de pend√™ncias, faturas, regras de uso do cart√£o ou outro assunto?",
      "Fiquei em d√∫vida sobre o que voc√™ quis dizer. √â algo sobre pend√™ncias, faturas ou regras de uso do cart√£o?",
      "Talvez eu esteja interpretando errado. Seu assunto √© pend√™ncias, faturas, pol√≠tica de uso do cart√£o ou outra coisa?",
      "Preciso de mais contexto. Sua d√∫vida envolve pend√™ncias, faturas, regras do cart√£o Clara ou √© outro tema?",
      "N√£o consegui identificar o assunto. Voc√™ queria saber sobre faturas, pend√™ncias, pol√≠tica de compras ou algo diferente?",
      "N√£o entendi completamente sua pergunta. Est√° relacionada a pend√™ncias, faturas, cart√£o Clara ou outro tema?"
    ];

    const frase = variacoes[Math.floor(Math.random() * variacoes.length)];

    return (
      "HTML:" +
      "<p class='text-sm text-slate-700'>" +
      frase +
      "</p>"
    );
  }

  // Se achou alguns temas, monta a frase usando eles
  const listaTemas = temasProvaveis
    .map(function (t) { return "<b>" + t + "</b>"; })
    .join(", ");

  return (
    "HTML:" +
    "<p class='text-sm text-slate-700'>" +
    "N√£o tenho certeza se entendi completamente. " +
    "Estou entendendo que pode ser algo relacionado a " + listaTemas + ". " +
    "Voc√™ consegue detalhar um pouco melhor o que precisa?" +
    "</p>"
  );
}

// Tenta entender respostas curtas depois da pergunta de clarifica√ß√£o

function tentarInterpretarRespostaClarificacao(norm) {
  let t = (norm || "").trim().toLowerCase();
  if (!t) return null;

  // normaliza acentos
  t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  const palavras = t.split(/\s+/).filter(Boolean);

  // 1) S√≥ trata respostas MUITO curtas (no m√°x. 3 palavras).
  // Se a pessoa escreveu uma frase mesmo ("valor das ultimas 3 faturas"),
  // N√ÉO √© clarifica√ß√£o, √© uma pergunta nova ‚Üí n√£o mexe.
  if (palavras.length > 3) {
    return null;
  }

  // 2) Se tem n√∫mero, "ultimas", "todas", "valor", "periodo", etc,
  // n√£o √© clarifica√ß√£o simples. Deixa passar sem reescrever.
  const temNumero = /\d/.test(t);
  const temDetalhe =
    t.includes("ultima") ||
    t.includes("ultimas") ||
    t.includes("todas") ||
    t.includes("valor") ||
    t.includes("periodo") ||
    t.includes("periodo") ||
    t.includes("historico") ||
    t.includes("quantidade");

  if (temNumero || temDetalhe) {
    return null;
  }

  // 3) Agora sim, mapeia respostas bem curtas
  // Ex.: "pendencias", "pend√™ncia clara"
  if (t.includes("pendenc")) {
    return "Quero consultar as pend√™ncias Clara da minha loja";
  }

  // Ex.: "fatura", "faturas"
  if (t.includes("fatura")) {
    return "Quero ver as faturas da Clara";
  }

  // Ex.: "regras", "politica", "uso do cartao"
  if (
    t.includes("regra") ||
    t.includes("regras") ||
    t.includes("politica") ||
    t.includes("politicas") ||
    t.includes("politica de uso") ||
    t.includes("uso do cartao") ||
    t.includes("uso do cart√£o")
  ) {
    return "Quero tirar d√∫vidas sobre a pol√≠tica de uso do cart√£o Clara";
  }

  // Se n√£o encaixar em nada, n√£o for√ßa interpreta√ß√£o
  return null;
}

// üß† Engine simples de insights em cima de faturas
function analisarFaturas(faturas) {
  try {
    if (!Array.isArray(faturas) || faturas.length === 0) {
      return "";
    }

    // Normaliza estrutura e garante que temos valor num√©rico e um r√≥tulo
    const lista = faturas
      .map(function (f, idx) {
        // tenta achar um campo de valor num√©rico entre algumas possibilidades
        const valorRaw =
          f.valorFatura ??
          f.valor_fatura ??
          f.valor_total ??
          f.valor ??
          f.total ??
          0;

        const valor = Number(valorRaw) || 0;

        // tenta achar um r√≥tulo amig√°vel
        const rotulo =
          f.rotulo ||
          f.label ||
          f.referencia ||
          f.mesReferencia ||
          f.mes ||
          f.periodo ||
          f.descricao ||
          ("Fatura " + (idx + 1));

        // tenta achar algo que represente "ordem temporal"
        const chaveOrdenacao =
          f.dataReferencia ||
          f.data_fatura ||
          f.dataVencimento ||
          f.data_vencimento ||
          f.mesReferencia ||
          f.periodo ||
          rotulo;

        return {
          original: f,
          valor: valor,
          rotulo: String(rotulo),
          chave: String(chaveOrdenacao)
        };
      })
      .filter(function (f) {
        return f.valor > 0;
      });

    if (lista.length === 0) {
      return "";
    }

    // Ordena por chave (como proxy de tempo)
    lista.sort(function (a, b) {
      if (a.chave < b.chave) return -1;
      if (a.chave > b.chave) return 1;
      return 0;
    });

    const total = lista.reduce(function (acc, f) {
      return acc + f.valor;
    }, 0);

    const media = total / lista.length;

    // maior e menor fatura
    var maior = lista[0];
    var menor = lista[0];

    for (var i = 1; i < lista.length; i++) {
      if (lista[i].valor > maior.valor) maior = lista[i];
      if (lista[i].valor < menor.valor) menor = lista[i];
    }

    // varia√ß√£o da √∫ltima em rela√ß√£o √† anterior, se houver pelo menos 2
    var variacaoTexto = "";
    if (lista.length >= 2) {
      const penultima = lista[lista.length - 2];
      const ultima = lista[lista.length - 1];

      if (penultima.valor > 0) {
        const dif = ultima.valor - penultima.valor;
        const perc = (dif / penultima.valor) * 100;

        if (Math.abs(perc) >= 3) { // ignora varia√ß√£o muito pequena
          const direcao = perc > 0 ? "aumento" : "queda";
          variacaoTexto =
            "A fatura mais recente (" +
            ultima.rotulo +
            ") teve um " +
            direcao +
            " de aproximadamente " +
            perc.toFixed(1).replace(".", ",") +
            "% em rela√ß√£o √† anterior (" +
            penultima.rotulo +
            ").";
        } else {
          variacaoTexto =
            "A fatura mais recente (" +
            ultima.rotulo +
            ") ficou em linha com a anterior (" +
            penultima.rotulo +
            "), sem varia√ß√£o relevante de valor.";
        }
      }
    }

    // texto de resumo
    var html =
      "<div class='mt-3 p-3 rounded-lg border border-slate-200 bg-slate-50 text-xs text-slate-700'>" +
      "<p class='font-semibold mb-1'>Observa√ß√µes autom√°ticas sobre essas faturas:</p>" +
      "<ul class='list-disc ml-4 space-y-1'>" +
      "<li>Foram consideradas <b>" + lista.length + "</b> faturas, com valor m√©dio de aproximadamente <b>R$ " +
      media.toFixed(2).replace(".", ",") +
      "</b>.</li>" +
      "<li>A fatura de <b>" + maior.rotulo + "</b> foi a de <b>maior valor</b> no conjunto exibido.</li>" +
      "<li>A fatura de <b>" + menor.rotulo + "</b> foi a de <b>menor valor</b>.</li>";

    if (variacaoTexto) {
      html += "<li>" + variacaoTexto + "</li>";
    }

    html +=
      "</ul>" +
      "<p class='mt-2 text-[11px] text-slate-500'>" +
      "Essas observa√ß√µes s√£o um resumo autom√°tico em cima das faturas mostradas na tabela, " +
      "para te ajudar a identificar rapidamente extremos e tend√™ncias.</p>" +
      "</div>";

    return html;
  } catch (e) {
    // se der qualquer problema, n√£o quebra o chat; s√≥ n√£o mostra insight
    console.error("Erro em analisarFaturas:", e);
    return "";
  }
}

// üîé Tenta extrair um array de linhas padr√£o (categoria/estabelecimento) do resultado do Apps Script
function vektorExtrairListaResumoChave(res) {
  if (!res) return [];

  // Se j√° vier um array direto
  if (Array.isArray(res)) return res;

  // Tenta achar propriedades comuns
  const possiveis = [
    "dados",
    "itens",
    "linhas",
    "registros",
    "categorias",
    "estabelecimentos",
    "lista"
  ];

  for (const nome of possiveis) {
    if (Array.isArray(res[nome])) {
      return res[nome];
    }
  }

  return [];
}

// üí° Gera insights autom√°ticos para categoria/estabelecimento (m√©dia por transa√ß√£o)
function gerarInsightsResumoChaveCategoriaEstab(res, opcoes) {
  try {
    const tipoChave = (opcoes && opcoes.tipoChave) || "";
    // S√≥ faz sentido para Categoria ou Estabelecimento
    if (tipoChave !== "Categoria" && tipoChave !== "Estabelecimento") {
      return "";
    }

    const listaBruta = vektorExtrairListaResumoChave(res);
    if (!Array.isArray(listaBruta) || listaBruta.length < 2) {
      return "";
    }

    // Normaliza: tenta achar chave (nome), valor total e quantidade
    const itens = listaBruta
      .map(function (item, idx) {
        const nome =
          item.chave ||
          item.nome ||
          item.descricao ||
          item.descricaoChave ||
          item.categoria ||
          item.estabelecimento ||
          ("Item " + (idx + 1));

        const valorRaw =
          item.valorTotal ||
          item.totalValor ||
          item.valor_total ||
          item.valor ||
          item.total ||
          0;

        const qtdRaw =
          item.qtdTransacoes ||
          item.qtd_transacoes ||
          item.quantidade ||
          item.qtd ||
          item.numTransacoes ||
          0;

        const valor = Number(valorRaw) || 0;
        const qtd = Number(qtdRaw) || 0;

        // Se n√£o tiver quantidade, n√£o d√° pra falar de "m√©dia por transa√ß√£o"
        if (valor <= 0 || qtd <= 0) {
          return null;
        }

        return {
          nome: String(nome),
          valor: valor,
          qtd: qtd,
          media: valor / qtd
        };
      })
      .filter(function (x) {
        return x !== null;
      });

    if (itens.length < 2) {
      return "";
    }

    // Acha maior e menor m√©dia
    let maior = itens[0];
    let menor = itens[0];

    for (let i = 1; i < itens.length; i++) {
      const it = itens[i];
      if (it.media > maior.media) maior = it;
      if (it.media < menor.media) menor = it;
    }

    const labelColecao =
      tipoChave === "Categoria" ? "categorias" : "estabelecimentos";
    const labelSingular =
      tipoChave === "Categoria" ? "categoria" : "estabelecimento";

    const mediaMaior = maior.media.toFixed(2).replace(".", ",");
    const mediaMenor = menor.media.toFixed(2).replace(".", ",");

    let html =
      "<div class='mt-3 p-3 rounded-lg border border-slate-200 bg-slate-50 text-xs text-slate-700'>" +
      "<p class='font-semibold mb-1'>Insights autom√°ticos sobre os " + labelColecao + ":</p>" +
      "<ul class='list-disc ml-4 space-y-1'>" +
      "<li>O " + labelSingular + " <b>" + maior.nome + "</b> apresenta a <b>maior m√©dia de valor por transa√ß√£o</b> no per√≠odo, em torno de <b>R$ " + mediaMaior + "</b>.</li>" +
      "<li>O " + labelSingular + " <b>" + menor.nome + "</b> apresenta a <b>menor m√©dia de valor por transa√ß√£o</b> no per√≠odo, em torno de <b>R$ " + mediaMenor + "</b>.</li>" +
      "</ul>" +
      "<p class='mt-2 text-[11px] text-slate-500'>" +
      "Essa m√©dia √© calculada dividindo o valor total gasto pela quantidade de transa√ß√µes de cada " + labelSingular +
      " no per√≠odo consultado.</p>" +
      "</div>";

    return html;
  } catch (e) {
    console.error("Erro em gerarInsightsResumoChaveCategoriaEstab:", e);
    return "";
  }
}



    /* ========= GERADOR FINAL ========= */

function gerarRespostaDoBot(msgUsuario, vindoDaClarificacao = false) {
  const norm = normalize(msgUsuario || "");

  // üîπ LOG GLOBAL: tudo que o usu√°rio digita
  vektorRegistrarMetrica(
    "user_raw",           // intencao
    msgUsuario,           // mensagem original
    norm,                 // norm
    "entrada",            // resultado
    "RawMessageUsuario",  // t√≥pico
    "gerarRespostaDoBot"  // fun√ß√£o de origem
  );

  // üîπ 0.5: se a frase parece ser s√≥ uma resposta curta √† clarifica√ß√£o,
  // reinterpreta UMA √öNICA VEZ como uma pergunta completa que o motor j√° entende
  if (!vindoDaClarificacao) {
    const reescrita = tentarInterpretarRespostaClarificacao(norm);
    if (reescrita) {
      // chama de novo o gerador, marcando que j√° viemos da clarifica√ß√£o
      return gerarRespostaDoBot(reescrita, true);
    }
  }

    // üîπ 1¬™ camada: motor de inten√ß√µes por regras
  const resultadoIntencao = aplicarRegraDeIntencao(msgUsuario);

  // Se alguma regra reconheceu a inten√ß√£o e retornou algo, usamos isso.
  // Exemplos de retorno:
  // - "ACAO_LISTAR_ETIQUETAS_CLARA" (token para a√ß√£o externa)
  // - "HTML:..." (resposta pronta)
  // - texto simples
  if (resultadoIntencao !== null && resultadoIntencao !== undefined) {
    return resultadoIntencao;
  }

  // üîπ 2¬™ camada: fallback para os gatilhos antigos baseados em includes
    // Gatilho: usu√°rio quer entender a √∫ltima tabela
  if (
          norm.includes("explica essa tabela") ||
          norm.includes("explica essa fatura") ||
          norm.includes("como voce calculou") ||
          norm.includes("como vc calculou") ||
          norm.includes("como foi calculado") ||
          norm.includes("como foi gerado") ||
          norm.includes("de onde veio essa tabela")
  ) {
    vektorExplicarUltimaTabela();
    return null; // mant√©m padr√£o: fun√ß√£o j√° renderiza no chat
  }

  // Treinamento Clara - apresenta√ß√£o em Slides
if (
  norm.includes("treinamento clara") ||
  norm.includes("treinamento do cartao clara") ||
  norm.includes("treinamento do cart√£o clara") ||
  norm.includes("treinamento sobre uso do cartao") ||
  norm.includes("treinamento sobre uso do cart√£o")
) {
  const htmlTreinamento = `HTML:
<div class="text-sm text-slate-700">

  <h2 style="font-size: 1.1rem; font-weight: 700; text-align: center; margin-top: -8px; margin-bottom: 8px;">
    Treinamento oficial sobre o uso do cart√£o Clara
  </h2>

  <p class="mb-2" style="text-align:center; margin-top: -4px;">
    Use esta apresenta√ß√£o para refor√ßar boas pr√°ticas com o time da loja:

  <div style="position:relative;padding-bottom:62%;height:0;overflow:hidden;max-width:100%;
              border-radius:8px;border:1px solid #ddd;">
    <iframe
      src="https://docs.google.com/presentation/d/e/2PACX-1vRTlL30pbq4rkyBlo0cLHgE3Tqeg_bLaWlIBY20tSzEdIS5QlIuWRjIv4A1j_Lfnb9_gaZ6woWJ7SDh/pubembed?start=false&loop=false&delayms=3000"
      frameborder="0"
      style="position:absolute;top:0;left:0;width:100%;height:100%;"
      allowfullscreen="true"
      mozallowfullscreen="true"
      webkitallowfullscreen="true">
    </iframe>
  </div>

  <p class="mt-2 text-xs text-slate-500" style="text-align:center;">
    Se preferir, abra em tela cheia pelo bot√£o dispon√≠vel na apresenta√ß√£o.
  </p>

</div>`;

  return htmlTreinamento;
}

// ======================================================================
// RELAT√ìRIO GERENCIAL ‚Äì incorpora Looker e manda link em mensagem separada
// ======================================================================
if (
  norm.includes("abrir relatorio gerencial") ||
  norm.includes("abrir relat√≥rio gerencial") ||
  norm.includes("relatorio gerencial da clara") ||
  norm.includes("relat√≥rio gerencial da clara") ||
  norm.includes("relatorio gerencial") ||
  norm.includes("relat√≥rio gerencial")
) {
  // 1) Envia o relat√≥rio incorporado (iframe)
  renderBotMessage("HTML:" + htmlRelatorioGerencial);

  return;
}

    // Uso respons√°vel do limite do cart√£o Clara
  if (
    norm.includes("usar bem o limite") ||
    (norm.includes("limite") && norm.includes("usar")) ||
    norm.includes("uso do limite do cartao") ||
    norm.includes("uso do limite do cart√£o")
  ) {
    return "HTML:<div class='text-sm text-slate-700'>"
      + "<p class='mb-2'>"
      + "O limite do cart√£o Clara foi definido para cobrir, com seguran√ßa, os gastos previstos do ciclo de fatura "
      + "(de <b>06</b> at√© <b>05</b> do m√™s seguinte). Para usar bem esse limite, sem precisar aumentar durante o m√™s, "
      + "considere estas pr√°ticas:"
      + "</p>"
      + "<ul class='list-disc ml-4 space-y-1'>"
      + "<li><b>Planeje o m√™s pelo ciclo da fatura:</b> some os gastos previstos entre os dias 06 e 05 e verifique se cabem no limite dispon√≠vel.</li>"
      + "<li><b>Priorize despesas operacionais essenciais:</b> use o cart√£o principalmente para despesas previstas na pol√≠tica (ex.: material de escrit√≥rio, manuten√ß√£o, marketing autorizado, etc.).</li>"
      + "<li><b>Evite concentrar grandes compras no in√≠cio do ciclo:</b> isso pode travar o limite e impedir compras importantes mais para o fim do m√™s.</li>"
      + "<li><b>Prefira compras √† vista ou com poucos parcelamentos:</b> parcelamentos longos consomem o limite pelos pr√≥ximos ciclos e reduzem a flexibilidade da loja.</li>"
      + "<li><b>Acompanhe o uso do limite ao longo do m√™s:</b> consulte o extrato da Clara e os relat√≥rios do Vektor para ver quanto j√° foi utilizado e o que ainda est√° dispon√≠vel.</li>"
      + "<li><b>Reserve uma margem para imprevistos:</b> evite usar 100% do limite com despesas previs√≠veis; mantenha uma folga para emerg√™ncias dentro da pol√≠tica.</li>"
      + "<li><b>Evite compras fora da pol√≠tica:</b> gastos n√£o permitidos podem ser bloqueados ou precisar de reembolso, al√©m de consumir o limite de forma indevida.</li>"
      + "</ul>"
      + "<p class='mt-2'>"
      + "Se mesmo seguindo essas orienta√ß√µes o limite estiver sempre no m√°ximo, vale revisar o planejamento de gastos da loja "
      + "e, se for o caso, discutir um ajuste de limite com o time respons√°vel, com base em dados de uso recorrente."
      + "</p>"
      + "</div>";
  }

  // INTEN√á√ÉO: listar etiquetas da Clara (BaseClara, coluna T)
  if (
    norm.includes("listagem de etiquetas") ||
    norm.includes("lista de etiquetas") ||
    norm.includes("etiquetas disponiveis") ||
    norm.includes("etiquetas dispon√≠veis") ||
    norm.includes("etiquetas da clara") ||
    norm.includes("etiquetas na clara")
  ) {
    return "ACAO_LISTAR_ETIQUETAS_CLARA";
  }

  // üÜï Resposta espec√≠fica para o ciclo da fatura da Clara
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("per√≠odo da fatura")
  ) {
    return "HTML:<p class='text-sm text-slate-700'>" +
      "O <b>ciclo da fatura da Clara</b> funciona assim:<br><br>" +
      "‚Ä¢ As compras realizadas entre <b>o dia 6</b> de cada m√™s e <b>o dia 5</b> do m√™s seguinte s√£o " +
      "agrupadas na mesma fatura.<br>" +
      "‚Ä¢ Tudo o que for gasto dentro desse intervalo entra para pagamento nessa fatura do per√≠odo.<br><br>" +
      "Em resumo: o ciclo vai sempre de <b>06</b> a <b>05</b>, e todas as compras feitas nesse per√≠odo " +
      "entram juntas na mesma fatura.</p>";
  }

  // === Gatilho para o MINI MANUAL DA CLARA ===
  if (
    norm.includes("manual clara") ||
    norm.includes("manual da clara") ||
    (norm.includes("manual") && norm.includes("clara")) ||
    norm.includes("treinamento clara") ||
    norm.includes("treinamento do cartao clara") ||
    norm.includes("treinamento do cart√£o clara")
  ) {

    
    const htmlPartes = [];

    htmlPartes.push(
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Posso te ajudar a tirar d√∫vidas sobre o uso do cart√£o da Clara.</b> Escolha um dos t√≥picos abaixo üëá</p>" +
        "<div class='mt-3 flex flex-col gap-2'>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('primeiro_acesso')\">" +
        "01 Primeiro acesso" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('recebi_cartao')\">" +
        "02 Recebi o cart√£o, e agora?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('esqueci_senha')\">" +
        "03 Esqueci a senha do cart√£o" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('qual_meu_acesso')\">" +
        "04 Qual o meu acesso?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('anexar_comprovante')\">" +
        "05 Como anexar comprovante?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('duvidas')\">" +
        "06 D√∫vidas" +
      "</button>"
    );

    htmlPartes.push("</div></div>");

    const htmlFinal = htmlPartes.join("");
    return "HTML:" + htmlFinal;
  }

  // üÜï TODAS AS LOJAS DO TIME XXXXX
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasDoTime = detectarListarTodasLojasDoTime(msgUsuario, norm);
  
  if (detTodasLojasDoTime) {
    const grupo = detTodasLojasDoTime.grupo;
    const p = detTodasLojasDoTime.periodo;
    const tipo = detTodasLojasDoTime.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Montando a <b>rela√ß√£o de todas as lojas do time " + grupo + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todas as lojas do time
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: true,   // j√° faz tabela de lojas por time
          groupName: grupo
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
          "Tive um problema ao consultar os dados para listar as lojas do time " + grupo + ".</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        grupo,          // time solicitado
        dataInicioStr,
        dataFimStr,
        tipo
      );

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    return null;
  }
}

  // üÜï LOJAS / LOJA COM MAIS PEND√äNCIAS (por time)
  if (
    (norm.includes("loja com mais pendenc") ||
     norm.includes("lojas com mais pendenc"))
  ) {
    // Per√≠odo (reaproveita o mesmo engine)
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // Tenta extrair o time da pr√≥pria frase
    const grupo = extrairGrupo(msgUsuario, norm);

    if (!grupo) {
      return "HTML:<p class='text-sm text-slate-700'>" +
        "Para eu listar as <b>lojas com mais pend√™ncias</b>, preciso saber de <b>qual time</b>." +
        "<br>Exemplo de pergunta completa: " +
        "<i>Lojas com mais pend√™ncias do time XYZ neste m√™s / na √∫ltima semana, nessa semana etc</i>." +
        "</p>";
    }

    vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso);
    return null;
  }

    // TODAS AS PEND√äNCIAS DO TIME XXXXX  ‚Üí consolida√ß√£o por loja daquele time
  
    if (
  (
    norm.includes("todas as pendenc") && norm.includes("do time")
  ) ||
  (
    norm.includes("pendenc") && norm.includes("do time")
  )
) {
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    const grupo = extrairGrupo(msgUsuario, norm);

    if (!grupo) {
      return "HTML:<p class='text-sm text-slate-700'>" +
        "Para listar <b>todas as pend√™ncias de um time</b>, preciso que voc√™ informe o nome completo do time na frase." +
        "<br>Exemplo: <i>Todas as pend√™ncias do time Lobos SP neste m√™s</i>." +
        "</p>";
    }

    vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso);
    return null;
  }

  // TODAS AS PEND√äNCIAS POR TIME  ‚Üí consolida√ß√£o por time (todas as equipes)
  if (
    (norm.includes("todas as pendenc") && norm.includes("por time")) ||
    norm.includes("time com mais pendenc")
  ) {
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    vektorMostrarPendenciasPorTimeTodos(dataInicioIso, dataFimIso);
    return null;
  }

  // Gatilho pend√™ncias (quando n√£o h√° fluxo pend√™ncias em aberto)

    if (estadoPendencias === "nenhum" &&
    termosPendencias.some(t => norm.includes(t))) {

    // tenta extrair n√∫mero de loja j√° presente na mensagem (2 a 6 d√≠gitos)
    const matchLoja = msgUsuario.match(/\b(\d{2,6})\b/);

    if (matchLoja) {
        const lojaBruta = matchLoja[1];
        const lojaNormalizada = lojaBruta.replace(/\D/g, "");

        lojaPendenciasAtual = lojaNormalizada;
        ultimaPendenciaResumo = null;
        estadoPendencias = "aguardando_confirmacao_email";

        // üÜï busca nome da loja antes de responder
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}${nomeLojaTxt}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );

            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .withFailureHandler((err) => {
            // fallback se der erro no BigQuery
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );
            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .obterNomeLojaBigQuery(lojaNormalizada);

        return null; // n√£o retorna outro texto (renderBotMessage j√° enviou)
    }

    // caso n√£o tenha n√∫mero na frase, segue fluxo normal pedindo a loja
    estadoPendencias = "aguardando_loja";
    lojaPendenciasAtual = "";
    ultimaPendenciaResumo = null;

    return `HTML:<p class="text-sm text-slate-700">
    Consigo consultar as pend√™ncias de justificativas Clara da sua loja. Me informe o c√≥digo da loja (somente n√∫meros), por exemplo: <b>0123</b>.
    </p>`;
}

// ===== NOVA A√á√ÉO: Maiores transa√ß√µes individuais (loja / time) =====
var detTopTrans = detectarMaioresTransacoesIndividuais(msgUsuario, norm);
if (detTopTrans) {
  var grupo = detTopTrans.grupo || "";
  var loja  = detTopTrans.loja  || "";
  var periodo = detTopTrans.periodo || null;
  var topN = detTopTrans.topN;

  if (!topN || topN <= 0) {
    topN = 10; // default se o usu√°rio n√£o falar Top
  }

  var dataInicioIso = "";
  var dataFimIso = "";

  if (periodo && periodo.dataInicio && periodo.dataFim) {
    try {
      dataInicioIso = periodo.dataInicio.toISOString();
      dataFimIso    = periodo.dataFim.toISOString();
    } catch (e) {
      console.warn("N√£o consegui converter per√≠odo para ISO em maiores transa√ß√µes:", e);
    }
  }

  // feedback r√°pido no chat
  var textoLoading = "Vou buscar as <b>maiores transa√ß√µes individuais</b> ";
  if (loja)  textoLoading += "da loja <b>" + loja + "</b> ";
  if (grupo) textoLoading += "do time <b>" + grupo + "</b> ";
  if (periodo) {
    textoLoading += "no per√≠odo informado...";
  } else {
    textoLoading += "nos √∫ltimos 30 dias...";
  }

  renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + textoLoading + "</p>");

  try {
    google.script.run
      .withSuccessHandler(function (res) {
        renderMaioresTransacoesIndividuais(res);
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script maiores transa√ß√µes:", err);
        renderBotMessage("N√£o consegui consultar as maiores transa√ß√µes individuais agora.");
      })
      .getMaioresTransacoesIndividuais(
        grupo,
        loja,
        dataInicioIso,
        dataFimIso,
        topN
      );
  } catch (e) {
    console.error("Falha geral ao chamar getMaioresTransacoesIndividuais:", e);
    renderBotMessage("Ocorreu um erro ao buscar as maiores transa√ß√µes individuais.");
  }

  // registra inten√ß√£o para m√©tricas
  try { ultimaIntencao = "maiores_transacoes_individuais"; } catch (e) {}

  return; // importante para n√£o cair no fluxo gen√©rico
}

  // üÜï TIMES ESPEC√çFICOS (ex.: "times √Åguias do Cerrado e Lobos SP no per√≠odo ...")

  const detTimesEspec = detectarTimesEspecificosLista(msgUsuario, norm);
  if (detTimesEspec && detTimesEspec.times && detTimesEspec.times.length > 1) {
    const listaTimes = detTimesEspec.times;
    const p          = detTimesEspec.periodo;
    const tipo       = detTimesEspec.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï Guarda per√≠odo em formato ISO para os insights (times/lojas)
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou comparar apenas os times <b>" + listaTimes.join(", ") + "</b> " +
        "por " + (tipo === "valor" ? "<b>valor total</b>" : "<b>quantidade de transa√ß√µes</b>") +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesPorTime(res, {
          topN: null,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados para esses times.</p>"
        );
      })
      .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

    return null;
  }


// >>> RANKING DE TIMES (top N)
const detRankTimes = detectarRankingTimes(msgUsuario, norm);
if (detRankTimes) {
  const p    = detRankTimes.periodo;
  const tipo = detRankTimes.tipo || "valor";      // "valor" ou "quantidade"
  const topN = detRankTimes.topN ?? 10;           // padr√£o: 10
  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

   // üÜï Guarda per√≠odo em ISO para os insights de maior transa√ß√£o
  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioStr || "",
    fim:    dataFimStr    || ""
  };

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de times</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesPorTime(res, { topN: topN });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // igual ao seu bloco de "detTimes", encerra aqui
}


function detectarConsultasTimes(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);

  // plural por quantidade (listar TODOS)
  if (t.includes("times com maior numero de transacoes") || t.includes("times com mais transacoes") ||
      t.includes("times com mais transacao") || t.includes("times com maior quantidade de transacoes")) {
    return { periodo, tipo: "quantidade", topN: null, modo: "plural" };
  }

  // plural por valor (listar TODOS)
  if (t.includes("quais times mais gastaram") || t.includes("times com maior valor de transacoes") ||
      t.includes("times que mais gastaram")) {
    return { periodo, tipo: "valor", topN: null, modo: "plural" };
  }

  // singular -> top 1 por valor
  if (t.includes("qual time mais gastou") || t.includes("time com maior valor de transacoes")) {
    return { periodo, tipo: "valor", topN: 1, modo: "singular" };
  }

  return null;
}

// =========== DETECTOR: "TIMES X E Y NO PER√çODO" =========== //

function detectarTimesEspecificosLista(msgOriginal, norm) {
  const t = norm || "";

  // se falar de LOJA(S), essa fun√ß√£o N√ÉO deve tratar
  if (!t.includes("time") || t.includes("loja") || t.includes("lojas")) {
    return null;
  }

  const lista = (typeof encontrarListaTimesNaMensagem === "function"
    ? (encontrarListaTimesNaMensagem(msgOriginal) || [])
    : []);

  if (!lista.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: lista,
    periodo,
    tipo
  };
}

if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detRankLoja = detectarRankingLojas(msgUsuario, norm);
if (detRankLoja) {
  const periodo = detRankLoja.periodo;
  const tipo    = detRankLoja.tipo || "valor";
  const grupo   = detRankLoja.grupo || "";
  const topNReq = detRankLoja.topN; // pode ser null

  // üìå Regra de TOP:
  // - Se o usu√°rio falar "top X" ‚Üí usa X
  // - Se N√ÉO falar top e N√ÉO tiver time ‚Üí padr√£o = 10
  // - Se N√ÉO falar top e TIVER time ‚Üí deixa null pra listar todas as lojas do time
  const topNFinal = (topNReq != null)
    ? topNReq
    : (grupo ? null : 10);

  // Aviso: ranking geral de lojas (sem time) e sem "top" informado => mostraremos 10
  if (!grupo && topNReq == null) {
    renderBotMessage(
      "HTML:<p class='text-xs text-slate-600 italic'>Obs.: Como o n√∫mero de lojas √© grande, mostrarei as <b>10 primeiras</b> por padr√£o. Voc√™ pode pedir, por exemplo, <b>top 20 lojas</b>.</p>"
    );
  }

  vektorRegistrarContexto({
  ultimaIntencao: "ranking_lojas",
  ultimoPeriodo: periodo || null,
  ultimoGrupo: grupo || null,
  ultimaLoja: null,
  ultimaAcaoExplicavel: {
    tipo: "tabela_ranking_lojas",
    meta: {
      criterio: criterio,
      grupo: grupo || null,
      topN: topNFinal || null
    }
  }
});

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de lojas</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    (periodo ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, {
        topN: topNFinal,        // respeita TOP pedido (ou 10 / null)
        forGroup: !!grupo       // true se estiver filtrando por time
      });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// 2) LOJAS (plural) sem top/ranking  -> lista TODAS do time
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detLojasPlural = detectarLojasMaisTransacoesPlural(msgUsuario, norm);
if (detLojasPlural) {
  const periodo = detLojasPlural.periodo;
  const tipo    = detLojasPlural.tipo || "valor";
  const grupo   = detLojasPlural.grupo || ""; // se vier time, listaremos TODAS as lojas do time
  const topN    = null; // for√ßa 'todas'

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou listar <b>todas as lojas</b> " +
    (grupo ? "do time <b>" + grupo + "</b> " : "") +
    "ordenadas por " + (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
  const n = (topN == null && !grupo) ? 10 : topN; // 10 s√≥ no geral; por time voc√™ decide
  renderResumoTransacoesSemana(res, { topN: n, forGroup: true });
})
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja por time).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// === NOVO: CONSULTAS POR CATEGORIA (BaseClara) ===
const detCategorias = detectarPerguntaCategorias(msgUsuario, norm);
if (detCategorias) {

  // ‚úÖ Per√≠odo padr√£o quando usu√°rio n√£o informar
  // Sugest√£o: √∫ltimos 30 dias (consistente com "informa√ß√µes iniciais")
  let periodo = detCategorias.periodo;
  if (!periodo || !periodo.dataInicio || !periodo.dataFim) {
    const fim = new Date();
    const ini = new Date();
    ini.setDate(fim.getDate() - 30);
    periodo = { dataInicio: ini, dataFim: fim };
  }

  const tipo = detCategorias.tipo || "valor";
  const topN = detCategorias.topN;

  const dataInicioStr = periodo.dataInicio.toISOString();
  const dataFimStr    = periodo.dataFim.toISOString();

  // (opcional, mas recomendado) salva o per√≠odo como ‚Äú√∫ltimo per√≠odo‚Äù
  // para drilldowns e para renderResumoPorChaveGenerico conseguir usar fallback tamb√©m
  window.__vektorUltimoPeriodo = { dataInicio: periodo.dataInicio, dataFim: periodo.dataFim };

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por categoria</b> " +
    (tipo === "valor" ? "considerando <b>valor</b>" : "por <b>quantidade de transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : " em toda a base") +
    "‚Ä¶</p>"
  );

  google.script.run
        .withSuccessHandler(function (res) {
      // 1) Monta a tabela normal (como j√° fazia)
      renderResumoPorChaveGenerico(res, {
        tipoChave: "Categoria",
        titulo: (tipo === "valor"
          ? "Categorias com maior valor de transa√ß√µes"
          : "Categorias com maior quantidade de transa√ß√µes"),
        topN: topN
      });

      // 2) Se estiver olhando para VALOR, gera insight de m√©dia por transa√ß√£o
      if (tipo === "valor") {
        const htmlInsights = gerarInsightsResumoChaveCategoriaEstab(res, {
          tipoChave: "Categoria"
        });
        if (htmlInsights) {
          renderBotMessage("HTML:" + htmlInsights);
        }
      }
    })

    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por categoria.</p>");
    })
    .getResumoTransacoesPorCategoria(
      dataInicioStr,
      dataFimStr,
      tipo
    );

  return null;
}

// === NOVO: CONSULTAS POR ESTABELECIMENTO / LOCAL (BaseClara) ===
const detEstab = detectarPerguntaEstabelecimentos(msgUsuario, norm);
if (detEstab) {
  const periodo = detEstab.periodo;
  const tipo    = detEstab.tipo || "valor";
  const topN    = detEstab.topN;
  const grupo   = detEstab.grupo || "";
  const loja    = detEstab.loja  || "";

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  let contexto = "";
  if (grupo) contexto += " para o time <b>" + grupo + "</b>";
  if (loja)  contexto += (contexto ? " e " : " para ") + "a loja <b>" + loja + "</b>";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por estabelecimento</b>" +
    contexto +
    (tipo === "valor" ? " com foco em <b>valor</b>" : " por <b>quantidade de transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : " em toda a base") +
    "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // Monta o t√≠tulo com destaque e indica√ß√£o de Top N
      const tituloBase = (tipo === "valor"
        ? "<b>Locais com maior valor de gastos</b> - Top 10"
        : "<b>Locais com maior quantidade de transa√ß√µes</b>");

      const sufixoTop = (typeof topN === "number" && topN > 0)
        ? (" - Top " + topN)
        : "";

      renderResumoPorChaveGenerico(res, {
        tipoChave: "Estabelecimento",
        titulo: tituloBase + sufixoTop,
        topN: topN
      });

      // 2) Se estiver olhando para VALOR, gera insight de m√©dia por transa√ß√£o
      if (tipo === "valor") {
        const htmlInsights = gerarInsightsResumoChaveCategoriaEstab(res, {
          tipoChave: "Estabelecimento"
        });
        if (htmlInsights) {
          renderBotMessage("HTML:" + htmlInsights);
        }
      }
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por estabelecimento.</p>");
    })
    .getResumoTransacoesPorEstabelecimento(
      dataInicioStr,
      dataFimStr,
      tipo,
      grupo,
      loja
    );

  return null;
}

// >>> TIME CAMPE√ÉO (singular): "qual time gastou mais ...", "time com mais transa√ß√µes ..."
const detTimeCampeao = detectarPerguntaTimeMaisTransacoes(msgUsuario, norm);
if (detTimeCampeao) {
  const p    = detTimeCampeao.periodo;
  const tipo = detTimeCampeao.tipo || "valor"; // "valor" ou "quantidade"

  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Buscando o <b>time campe√£o</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // singular ‚Üí sempre Top 1
      renderResumoTransacoesPorTime(res, { topN: 1 });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // encerra aqui
}

  // üÜï TODOS OS TIMES NO PER√çODO / RELA√á√ÉO DE TIMES
  const detTodosTimes = detectarTodosTimesPeriodo(msgUsuario, norm);
  if (detTodosTimes) {
    const p    = detTodosTimes.periodo;
    const tipo = detTodosTimes.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio)
      ? p.dataInicio.toISOString()
      : "";
    const dataFimStr = (p && p.dataFim)
      ? p.dataFim.toISOString()
      : "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todos os times</b> com gasto " +
        (tipo === "valor" ? "por <b>valor total</b>" : "por <b>n√∫mero de transa√ß√µes</b>") +
        (p ? " no per√≠odo solicitado" : "") +
        ". A tabela vai mostrar para cada time o <b>valor total</b> e a <b>quantidade</b> de transa√ß√µes." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (todos os times).</p>"
        );
      })
      .getResumoTransacoesPorTime(
        dataInicioStr,
        dataFimStr,
        tipo
      );

    return null;
  }

    // >>> BLOCO: perguntas de FATURA (Extrato da conta / BaseClara)

  const detFatura = detectarPerguntaFaturaClara(msgUsuario, norm);
  if (detFatura) {

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou consultar o <b>valor das faturas</b> da Clara " +
        "de acordo com o per√≠odo solicitado...</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.faturas) || !res.faturas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar " +
            "informa√ß√µes de fatura na BaseClara.</p>"
          );
          return;
        }

        var todas = res.faturas || [];

              // ================== INTERPRETA√á√ÉO LOCAL DA PERGUNTA ==================
        let perguntaBruta = (msgUsuario || "").toLowerCase();

        // remove acentos: "√∫ltimas" -> "ultimas", "m√™s" -> "mes"
        let perguntaNorm = perguntaBruta
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

        let modoLocal = "atual";   // padr√£o
        let qtdLocal  = null;      // quantidade de faturas quando for "ultimas N"

        const temPluralFaturas   = perguntaNorm.includes("faturas");
        const temExplicitoAtual  = perguntaNorm.includes("fatura atual") ||
                                   perguntaNorm.includes("deste mes") ||
                                   perguntaNorm.includes("desse mes");
        const temExplicitoAnterior = perguntaNorm.includes("anterior") ||
                                     perguntaNorm.includes("mes passado");
        const temExplicitoTodas  = perguntaNorm.includes("todas");
        const temExplicitoUltimas = perguntaNorm.includes("ultimas") ||
                                    perguntaNorm.includes("ultimos");

        // 1) TODAS AS FATURAS (frase expl√≠cita)
        if (temExplicitoTodas && temPluralFaturas) {
          modoLocal = "todas";
        }

        // 2) √öLTIMAS N FATURAS (explicitamente com n√∫mero)
        // exemplos:
        // "ultimas 6 faturas", "ultimas 3 faturas da clara",
        // "6 ultimas faturas", "3 ultimas faturas da clara"
        let m =
          perguntaNorm.match(/ultimas?\s+(\d{1,2})\s*faturas?/) ||
          perguntaNorm.match(/(\d{1,2})\s+ultimas?\s*faturas?/);

        if (m && m[1]) {
          modoLocal = "ultimas";
          qtdLocal  = parseInt(m[1], 10);
        }

        // 2.b) "ultimas faturas" sem n√∫mero ‚Üí usa um padr√£o (ex.: 6)
        if (!qtdLocal && temExplicitoUltimas && temPluralFaturas) {
          modoLocal = "ultimas";
          qtdLocal  = 6;
        }

        // 3) FATURA ANTERIOR
        if (temExplicitoAnterior) {
          modoLocal = "anterior";
          qtdLocal  = null;
        }

        // 4) FATURA ATUAL (refor√ßo expl√≠cito)
        if (temExplicitoAtual) {
          modoLocal = "atual";
          qtdLocal  = null;
        }

        // 5) FALLBACK INTELIGENTE:
        // Se ainda est√° em "atual", mas o usu√°rio falou em "faturas" (plural)
        // sem dizer "atual", "anterior", "todas" ou "ultimas",
        // vamos assumir que ele quer ver mais de uma: ex.: √∫ltimas 6.
        if (
          modoLocal === "atual" &&
          temPluralFaturas &&
          !temExplicitoAtual &&
          !temExplicitoAnterior &&
          !temExplicitoTodas &&
          !temExplicitoUltimas
        ) {
          modoLocal = "ultimas";
          qtdLocal  = 6; // aqui voc√™ define o padr√£o que quiser
        }

        // 6) Seguran√ßa extra: se por qualquer motivo o modoLocal estiver "atual"
        //    mas temos qtdLocal > 1, tratamos como "ultimas".
        if (modoLocal === "atual" && typeof qtdLocal === "number" && qtdLocal > 1) {
          modoLocal = "ultimas";
        }

        // ================== APLICA O FILTRO ==================
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          modoLocal,
          qtdLocal
        );

        // ================== APLICA O FILTRO ==================
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          modoLocal,
          qtdLocal
        );

        // DEBUG pra gente ver exatamente o que est√° acontecendo
        console.log("perguntaNorm =", perguntaNorm);
        console.log("modoLocal =", modoLocal, "qtdLocal =", qtdLocal);
        console.log("total faturas retornadas =", todas.length);
        console.log("selecionadas pelo filtro =", selecionadas.length);

        if (!selecionadas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o encontrei faturas para " +
            "o crit√©rio informado.</p>"
          );
          return;
        }

        // ================== MONTA T√çTULO ==================
        var titulo = "RESUMO DE FATURAS CLARA";

        if (modoLocal === "atual") {
          titulo = "VALOR DA FATURA ATUAL";
        } else if (modoLocal === "anterior") {
          titulo = "VALOR DA FATURA DO M√äS PASSADO";
        } else if (modoLocal === "ultimas") {
          var n = qtdLocal || 2;
          var usado = Math.min(n, selecionadas.length);
          titulo = "VALOR DAS √öLTIMAS " + usado + " FATURAS";
        } else if (modoLocal === "todas") {
          titulo = "VALOR DE TODAS AS FATURAS";
        }

        var html = vektorMontarTabelaFaturas_(titulo, selecionadas);
        renderBotMessage("HTML:" + html);

        // üß† Engine de insights autom√°ticos em cima das faturas exibidas
        var htmlInsights = analisarFaturas(selecionadas);
        if (htmlInsights && typeof htmlInsights === "string") {
          renderBotMessage("HTML:" + htmlInsights);
        }

        // üÜï Se for fatura ATUAL, envia lembrete de fechamento e pagamento
        if (modoLocal === "atual") {
          const diasFechamento = vektorDiasAteFechamentoFaturaAtual();

          let msgFechamento;
          if (diasFechamento === 0) {
            msgFechamento =
              "Hoje √© o <b>dia de fechamento</b> da fatura atual. " +
              "O pagamento da fatura √© programado sempre para o dia <b>12</b> de cada m√™s.";
          } else if (diasFechamento === 1) {
            msgFechamento =
              "Falta <b>1 dia</b> para o fechamento da fatura atual. " +
              "O pagamento da fatura √© programado sempre para o dia <b>12</b> de cada m√™s.";
          } else {
            msgFechamento =
              "Faltam <b>" + diasFechamento + " dias</b> para o fechamento da fatura atual. " +
              "O pagamento da fatura √© programado sempre para o dia <b>12</b> de cada m√™s.";
          }

          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700 mt-2'>" +
              msgFechamento +
            "</p>"
          );

          // ‚úÖ NOVO: insights de pend√™ncias do ciclo atual (in√≠cio do ciclo -> agora)
google.script.run
  .withSuccessHandler(function(resP) {
    try {
      if (!resP || !resP.ok) {
        // se n√£o tiver dados, n√£o quebra o fluxo da fatura
        return;
      }

      const t = resP.totais || {};
      const periodo = resP.periodo || {};
      const top = Array.isArray(resP.topLojas) ? resP.topLojas : [];

      const lojasInfo = resP.lojas || {};
      const totalLojas = Number(lojasInfo.total) || 0;
      const lojasPend = Number(lojasInfo.comPendencia) || 0;

      const pctLojas = totalLojas
  ? (100 * lojasPend / totalLojas).toFixed(1).replace(".", ",") + "%"
  : "0%";

      const pct = (n, d) => {
        const nn = Number(n) || 0;
        const dd = Number(d) || 0;
        if (!dd) return "0%";
        return (100 * nn / dd).toFixed(1).replace(".", ",") + "%";
      };

      // totalPendTrans = total de transa√ß√µes com pelo menos 1 pend√™ncia
      const base = Number(t.totalPendTrans) || 0;

      // Aten√ß√£o: uma transa√ß√£o pode contar em mais de 1 tipo
      const pEtiq = pct(t.pendEtiqueta, base);
      const pDesc = pct(t.pendDescricao, base);
      const pRec  = pct(t.pendRecibo, base);

      let textoTop = "";
      if (top.length) {
        textoTop = "<ul class='list-disc ml-5 mt-1 space-y-1'>";
        top.slice(0,3).forEach(function(x){
          const loja = x.loja || "‚Äî";
          const time = x.time || "‚Äî";
          const qtd  = Number(x.totalPendencias || 0).toLocaleString("pt-BR");
          const val  = Number(x.valorPendente || 0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
          textoTop += "<li><b>Loja " + loja + "</b> (" + time + "): <b>" + qtd + "</b> pend√™ncias, <b>" + val + "</b> pendente</li>";
        });
        textoTop += "</ul>";
      }

      const iniTxt = periodo.inicio || "";
      const fimTxt = periodo.fim || "";

      const html =
      "HTML:<div class='text-sm text-slate-700 mt-2'>" +
        "<p><b>Leitura r√°pida das pend√™ncias no ciclo atual</b> (" + iniTxt + " ‚Üí " + fimTxt + "):</p>" +
        "<p class='mt-1'>At√© agora, encontrei <b>" + base.toLocaleString("pt-BR") + "</b> transa√ß√µes com algum tipo de pend√™ncia. " +
        "Esses casos est√£o distribu√≠dos em <b>" + lojasPend + "</b> lojas, " +
        "o que representa <b>" + pctLojas + "</b> de todas as lojas ativas no ciclo atual.</p><br>" +

        "<p>Quando eu separo por natureza do problema:</p>" +
        "<ul class='list-disc ml-5 mt-1 space-y-1'>" +
          "<li><b>Nota fiscal/Recibo</b>: " + Number(t.pendRecibo||0).toLocaleString("pt-BR") + " (" + pRec + ")</li>" +
          "<li><b>Etiqueta</b>: " + Number(t.pendEtiqueta||0).toLocaleString("pt-BR") + " (" + pEtiq + ")</li>" +
          "<li><b>Descri√ß√£o</b>: " + Number(t.pendDescricao||0).toLocaleString("pt-BR") + " (" + pDesc + ")</li>" +
        "</ul>" +

        "<p class='mt-2 text-xs text-slate-500'>Obs.: uma mesma transa√ß√£o pode aparecer em mais de um tipo (ex.: sem etiqueta e sem descri√ß√£o).</p>" +

        (textoTop
          ? ("<p class='mt-2'><b>Top 3 lojas ofensoras no ciclo:</b></p>" + textoTop)
          : ""
        ) +

        // üîΩ NOVO: bot√µes de download e email
        "<div style='margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;'>" +

          "<button type='button' " +
            "onclick='window.vektorBaixarLojasComPendenciasCicloAtual(event)' " +
            "style='background:#0F172A;color:#fff;border:none;padding:8px 12px;" +
                  "border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
            "Baixar lojas com pend√™ncias" +
          "</button>" +

          "<button type='button' " +
            "onclick='window.vektorEnviarLojasComPendenciasCicloAtualEmail(event)' " +
            "style='background:#005E27;color:#fff;border:none;padding:8px 12px;" +
                  "border-radius:10px;font-size:12px;font-weight:900;cursor:pointer;'>" +
            "Enviar listagem por e-mail" +
          "</button>" +
        "</div>" +
              "</div>";

      renderBotMessage(html);

    } catch (e) {
      console.error("Falha ao montar insights pend√™ncias ciclo:", e);
    }
  })
  .withFailureHandler(function(err) {
    console.error("Falha ao consultar pend√™ncias ciclo:", err);
  })
  .getPendenciasResumoCicloAtual();  // Code.gs

        }

        let __vektorChartFaturas = null;
      })
      .withFailureHandler(function (err) {
  const msg = (err && err.message) ? err.message : String(err || "");
  // Se for permiss√£o, mostra mensagem curta e correta
  if (msg.toLowerCase().includes("n√£o dispon√≠vel para o seu perfil")) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o dispon√≠vel para o seu perfil.</p>"
    );
    return;
  }

  // Caso contr√°rio, mostra o erro real (pra debug) ou uma mensagem mais √∫til
  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Erro ao consultar faturas: " +
    (msg ? msg : "erro desconhecido") +
    "</p>"
  );
})
      .getResumoFaturasClara();

    return;
  }

  // >>> NOVO BLOCO: perguntas de relat√≥rio (planilha Captura_Clara / BaseClara)

    const det = detectarPerguntaLojaMaisTransacoes(msgUsuario, norm);
    if (det) {
          const grupoNome = det.grupo || "";      // pode vir vazio (sem time)
          const periodo   = det.periodo;
          const tipo      = det.tipo || "quantidade"; // "quantidade" ou "valor"

  const grupoTxt = grupoNome
    ? ` do time <b>${grupoNome}</b>`
    : "";

  const criterioTxt = tipo === "valor"
    ? "maior <b>valor</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes";

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">
      Beleza! Vou consultar qual loja tem ${criterioTxt}${grupoTxt}${
        periodo ? " no per√≠odo solicitado" : ""
      } e j√° te trago um resumo. ‚è≥
    </p>`
  );

  // Converte datas (se existirem) para string ISO pra mandar pro Apps Script
  const dataInicioStr = (periodo && periodo.dataInicio)
    ? periodo.dataInicio.toISOString()
    : "";
  const dataFimStr = (periodo && periodo.dataFim)
    ? periodo.dataFim.toISOString()
    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, { topN: 1, forGroup: !!grupoNome });
    })
    .withFailureHandler(function () {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha. Tente novamente em alguns instantes.</p>"
      );
    })
    // üëá agora tamb√©m envia o tipo ("quantidade" ou "valor")
    .getResumoTransacoesPorGrupo(grupoNome, dataInicioStr, dataFimStr, tipo);

  // resposta vem ass√≠ncrona (via renderBotMessage no callback), ent√£o aqui n√£o devolve nada
  return null;
}

  // üÜï LOJAS ESPEC√çFICAS (ex.: "lojas XXXX e XXXX no per√≠odo ...")
  const detLojasEspec = detectarLojasEspecificasLista(msgUsuario, norm);
  if (detLojasEspec && detLojasEspec.codigosLojas.length > 0) {
    const p     = detLojasEspec.periodo;
    const tipo  = detLojasEspec.tipo || "valor";
    const lojas = detLojasEspec.codigosLojas;

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma tabela apenas com as <b>lojas " + lojas.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarLojasCodigos: lojas
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados para essas lojas espec√≠ficas.</p>"
        );
      })
      // grupo vazio => todas as lojas; vamos filtrar no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }

  // üÜï TODAS AS LOJAS NO PER√çODO (sem time)
  if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasPeriodo = detectarListarTodasLojasGeral(msgUsuario, norm);
  if (detTodasLojasPeriodo) {
    const periodo = detTodasLojasPeriodo.periodo;
    const tipo    = detTodasLojasPeriodo.tipo || "valor";

    const dataInicioStr = (periodo && periodo.dataInicio)
      ? periodo.dataInicio.toISOString()
      : "";
    const dataFimStr = (periodo && periodo.dataFim)
      ? periodo.dataFim.toISOString()
      : "";

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma <b>rela√ß√£o de todas as lojas</b> com gastos " +
        (periodo ? "no per√≠odo solicitado" : "no per√≠odo completo dispon√≠vel") +
        ", mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => listar TODAS as lojas
        renderResumoTransacoesSemana(res, { topN: null, forGroup: false });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha para listar todas as lojas.</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        "",              // sem time (todas as lojas)
        dataInicioStr,
        dataFimStr,
        tipo             // "valor" (padr√£o) ou "quantidade"
      );

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    // resposta vem via callback, ent√£o encerra aqui
    return null;
  }}

//üÜï TODAS AS LOJAS DE V√ÅRIOS TIMES
  const detLojasTimesMulti = detectarTodasLojasDosTimes(msgUsuario, norm);
  if (detLojasTimesMulti && detLojasTimesMulti.times.length > 0) {
    const listaTimes = detLojasTimesMulti.times;
    const p          = detLojasTimesMulti.periodo;
    const tipo       = detLojasTimesMulti.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

        // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todas as lojas</b> dos times <b>" + listaTimes.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados das lojas desses times.</p>"
        );
      })
      // grupo vazio => todas as lojas; filtro por time ser√° feito no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }



// <<< FIM DO BLOCO NOVO


        // 1) Termo de responsabilidade
        if (frasesTermo.some(f => norm.includes(f))) {
            // Mensagem principal (j√° existente)
            const msgPrincipal = respTermoResponsabilidade();

            // Segunda mensagem, separada, explicando que pode enviar pelo chat
            setTimeout(function () {
                try {
                    renderBotMessage(
                        "HTML:" +
                        "<div class='text-sm text-slate-700'>" +
                          "<p>" +
                            "Se voc√™ j√° tem o termo impresso e assinado, tamb√©m pode me enviar diretamente por aqui. " +
                            "Basta anexar o documento assinado." +
                          "</p>" +
                        "</div>"
                    );
                } catch (e) {
                    console.warn('Erro ao enviar mensagem complementar do termo:', e);
                }
            }, 2000); // pequeno atraso s√≥ para aparecer como outra bolha

            // Retorna a mensagem padr√£o para ser exibida normalmente
            return msgPrincipal;
        }

        // 2) Sauda√ß√µes
        for (const saud of saudacoes) {
            if (norm === saud || norm.startsWith(saud + " ") || norm.includes(" " + saud + " ")) {
                const respostasSaudacao = [
                    "Ol√°! üòÑ",
                    "Oi! üëã",
                    "Opa, tudo bem por a√≠? üòé",
                    "Fala a√≠! üëã",
                    "E a√≠, tudo certo? üôå",
                    "Bom te ver por aqui! üòÅ"
                ];
                const complementosAjuda = [
                    "Como posso te ajudar hoje?",
                    "Quer saber algo sobre o cart√£o Clara?",
                    "O que voc√™ quer saber?",
                    "Posso te explicar algo sobre o uso dos cart√µes?",
                    "Quer que eu te ajude com alguma d√∫vida?",
                    "Como posso te orientar?",
                    "Qual a sua d√∫vida?"
                ];
                const r1 = respostasSaudacao[Math.floor(Math.random() * respostasSaudacao.length)];
                const r2 = complementosAjuda[Math.floor(Math.random() * complementosAjuda.length)];
                return `HTML:<p class="text-sm text-slate-700">${r1} ${r2}</p>`;
            }
        }

        // 3) Encerramento / agradecimento
        for (const frase of frasesEncerramento) {
            if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
                const respostasEncerramento = [
                    "Que bom que consegui ajudar! ü§ó Pode me chamar sempre que precisar.",
                    "Show! Fico feliz em ajudar üòÑ",
                    "Perfeito üëå qualquer d√∫vida, √© s√≥ chamar de novo!",
                    "Valeu! At√© a pr√≥xima üöÄ",
                    "Beleza üòé t√¥ por aqui se precisar de novo.",
                    "Feito! Agora vou tirar um cochilo de 5 segundos. Me chama de novo, t√°?", 
                    "Resolvido! Fui nessa, mas t√¥ s√≥ a um clique de dist√¢ncia, viu?", 
                    "Show de bola! Se quebrar o meu sistema, n√£o fui eu, foi a formata√ß√£o anterior! üòâ", 
                    "Acabou o recreio! Brincadeiras √† parte, qualquer coisa, √© s√≥ dar um 'tapa' no chat.", 
                    "Tudo pronto. Vou ali beber uma √°gua e j√° volto. Se precisar, s√≥ assobiar!", 
                    "√â isso! Miss√£o dada √© (finalmente) miss√£o cumprida. Fui! üëã", 
                    "Perfeito! Agora vai l√° dominar o mundo (ou s√≥ terminar seu caf√© mesmo).", 
                    "Ufa! Deu tudo certo. Deixa um biscoito pra mim na pr√≥xima vez, valeu?", 
                    "Despedida de campe√£o! Se a d√∫vida voltar, √© porque sentiu minha falta. Pode chamar!", 
                    "Zerou! At√© o pr√≥ximo 'bug' ou a pr√≥xima ideia genial. üöÄ", 
                    "A gente se fala! N√£o faz besteira enquanto eu estiver fora, hein?", 
                    "OK, estou me desligando (s√≥ um pouquinho). Te vejo na pr√≥xima aventura!", 
                    "Quebrando a internet em 3, 2, 1... Brincadeira! Tchau, tchau!", 
                    "Terminamos com chave de ouro e um 'high five' virtual! ‚úã", 
                    "Resolvi essa parada! Agora, vai curtir a vida. Me chama se tiver t√©dio.", 
                    "Fechou o caix√£o! Quer dizer... fechou o chat. üòâ At√© a pr√≥xima!", 
                    "T√° tranquilo, t√° favor√°vel. Qualquer deslize tecnol√≥gico, me avisa!", 
                    "Deu bom! Vou mandar um emoji de comemora√ß√£o aqui: üéâ. Fui!", 
                    "Desaparecendo em 5 segundos. Se precisar de m√°gica, j√° sabe quem chamar.", 
                    "Essa foi r√°pida, hein? Valeu pela companhia. Tamo junto!", 
                    "Encerrando as atividades por hoje. Beijos de luz (e de c√≥digo)! ‚ú®", 
                    "Olha eu indo! Se sobrar um tempinho, manda um meme pra mim. Fui!", 
                    "Sou seu, mas n√£o sou seu (s√≥ at√© voc√™ precisar de mim de novo). Tchau!", 
                    "Gostei da conversa. Se tiver mais perguntas loucas, sou todo ouvidos!", 
                    "Miss√£o conclu√≠da. Agora, a pr√≥xima rodada √© por sua conta! (Brincadeira!).", 
                    "Finalizamos! Mando um abra√ßo de bytes e um at√© breve.", 
                    "Tudo nos conformes. Pode sair correndo e contar a novidade! üòâ", 
                    "Pronto para a aposentadoria (de 5 minutos). Bora na pr√≥xima!", 
                    "E o Oscar de melhor encerramento vai para... mim! Tchau! üòÇ"
                ];
                const r = respostasEncerramento[Math.floor(Math.random() * respostasEncerramento.length)];
                return `HTML:<p class="text-sm text-slate-700">${r}</p>`;
            }
        }

        // 4) Pol√≠tica (PDF oficial)
        if (frasesPolitica.some(f => norm.includes(f))) 
        
        {
              // ‚úÖ Primeiro: tenta responder RESUMO de categorias
  if (typeof tentarResponderResumoCategoriasPolitica === "function") {
    const resultadoResumo = tentarResponderResumoCategoriasPolitica(norm);
    if (resultadoResumo) {
      return vektorBlocoRaciocinioPolitica(
        resultadoResumo.mensagemUsuario,
        "",
        typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
          ? POLITICA_CARTOES_CLARA_LINK
          : ""
      );
    }
  }

  // ‚úÖ Se n√£o for sobre categorias, mant√©m a pol√≠tica oficial gen√©rica
  return respPoliticaOficial();
        }


              // 5) Fluxo pend√™ncias - aguardando c√≥digo da loja
        if (estadoPendencias === "aguardando_loja") {
    const textoOriginal = msgUsuario.trim();
    const soDigitos = textoOriginal.replace(/\D/g, "");

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // usu√°rio mudou de assunto
    if (mudouDeAssunto && !soDigitos) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        origemPendenciasBloqueio = false;
        return `HTML:<div class="text-sm text-slate-700">
        <p>Beleza üëç Vamos mudar de assunto ent√£o.</p>
        <p class="mt-1">Se quiser ver as pend√™ncias da loja depois, √© s√≥ dizer: <b>"consultar pend√™ncias Clara"</b>.</p>
        </div>`;
    }

    // usu√°rio digitou um c√≥digo de loja
    if (soDigitos && soDigitos.length >= 2 && soDigitos.length <= 4) {
        lojaPendenciasAtual = soDigitos;

        // üîπ CASO ESPECIAL: fluxo veio do bloqueio de cart√£o
        if (origemPendenciasBloqueio) {
            origemPendenciasBloqueio = false; // consumiu a flag

            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
                Beleza! Vou consultar as √∫ltimas pend√™ncias relacionadas ao cart√£o da loja <b>${soDigitos}</b>, que podem ter ocasionado o bloqueio. ‚è≥
                </p>`
            );

            consultarPendenciasBloqueio(soDigitos);
            return null;
        }

        // üîπ CASO NORMAL: fluxo padr√£o de pend√™ncias Clara
        estadoPendencias = "nenhum";

        // üÜï busca nome da loja no servidor antes de mostrar a mensagem
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}${nomeLojaTxt}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );

            consultarPendenciasNoServidor(soDigitos);
          })
          .withFailureHandler((err) => {
            // fallback se der erro na consulta do nome
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );
            consultarPendenciasNoServidor(soDigitos);
          })
          .obterNomeLojaBigQuery(soDigitos);

        return null;
    }

            // se chegou aqui, n√£o mudou de assunto e n√£o mandou c√≥digo de loja v√°lido
        // N√ÉO repetir frases infinitamente ‚Äî apenas n√£o responde e mant√©m o fluxo aguardando.
        return "";
}

        // 6) Fluxo pend√™ncias - aguardando confirma√ß√£o de envio por e-mail
if (estadoPendencias === "aguardando_confirmacao_email") {
    const ehSim = (
        norm === "sim" ||
        norm.startsWith("sim ") ||
        norm.includes(" sim") ||
        norm.includes("pode enviar") ||
        norm.includes("pode mandar") ||
        norm.includes("manda") ||
        norm.includes("envia") ||
        norm.includes("pode sim")
    );

    const ehNao = (
        norm === "nao" || norm === "n√£o" ||
        norm.startsWith("nao ") || norm.startsWith("n√£o ") ||
        norm.includes("nao precisa") || norm.includes("n√£o precisa") ||
        norm.includes("sem email") || norm.includes("sem e-mail") ||
        norm.includes("nao manda") || norm.includes("n√£o manda")
    );

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // Usu√°rio mudou de assunto no meio
    if (!ehSim && !ehNao && mudouDeAssunto) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<div class="text-sm text-slate-700">
<p>Tranquilo, vamos falar de outro assunto ent√£o. üòâ</p>
<p class="mt-1">Se depois voc√™ quiser receber o resumo por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
    }

    // Usu√°rio disse que N√ÉO quer e-mail
    if (ehNao) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<p class="text-sm text-slate-700">
Fechado, n√£o vou enviar por e-mail. Se quiser depois, √© s√≥ pedir de novo. üëç
</p>`;
    }

    // Usu√°rio disse que SIM quer e-mail
    if (ehSim) {
        const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
        const emailSessao = (USER_EMAIL_REPLACED || "").trim();

        if (!loja) {
            // Por seguran√ßa: se por algum motivo a loja sumiu da mem√≥ria
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";
            return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
        }

        // ‚úÖ Se temos e-mail do usu√°rio logado, j√° envia direto
        if (emailSessao) {
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";

            // avisa no chat
            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${emailSessao}</b>.
</p>`
            );

            // chama o Apps Script pra mandar o e-mail
            chamarEnvioPendenciasPorEmail(loja, emailSessao);

            // j√° usamos renderBotMessage, ent√£o aqui n√£o precisa retornar outro texto
            return null;
        }

        // ‚ùå Se N√ÉO temos e-mail na sess√£o, volta para o fluxo antigo (pede e-mail)
        estadoPendencias = "aguardando_email";
        return `HTML:<p class="text-sm text-slate-700">
Perfeito! Me informa o seu e-mail corporativo (ex.: <b>nome.sobrenome@xxxxx.com.br</b>) para eu enviar o resumo.
</p>`;
    }

    // Se n√£o entendeu nem sim nem n√£o
    return `HTML:<p class="text-sm text-slate-700">
S√≥ pra eu entender: voc√™ quer que eu envie por e-mail tamb√©m?<br/>
Responda apenas <b>"sim"</b> ou <b>"n√£o"</b>. üôÇ
</p>`;
}

        // 7) Fluxo pend√™ncias - aguardando e-mail
        if (estadoPendencias === "aguardando_email") {
            const textoOriginal = msgUsuario.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailRegex.test(textoOriginal)) {
                const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
                if (!loja) {
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
                }

                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${textoOriginal}</b>.
</p>`
                );
                chamarEnvioPendenciasPorEmail(loja, textoOriginal);
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return null;
            }

            const pareceOutroAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (pareceOutroAssunto) {
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return `HTML:<div class="text-sm text-slate-700">
<p>Beleza, vamos mudar de assunto ent√£o üòâ</p>
<p class="mt-1">Se depois voc√™ quiser voltar a ver as pend√™ncias da loja ou receber por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
            }

            return `HTML:<p class="text-sm text-slate-700">
Esse e-mail parece inv√°lido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.<br/><br/>
Se preferir mudar de assunto, pode me perguntar outra coisa diretamente (ex.: "sangria", "novo cart√£o", "limite", "etiqueta", etc.).
</p>`;
        }

        // 8) Fluxo novo cart√£o ‚Äì aguardando se √© 1¬™ ou 2¬™ via
        if (fluxoNovoCartao === "aguardando_tipo_via") {
            const ehPrimeira = (
                norm.includes("primeira via") ||
                norm.includes("1 via") ||
                norm.includes("1a via") ||
                norm.includes("1¬™ via") ||
                norm.includes("primeiro cartao") ||
                norm.includes("primeiro cart√£o") ||
                norm.includes("cartao novo") ||
                norm.includes("cart√£o novo") ||
                norm.includes("meu primeiro cartao") ||
                norm.includes("meu primeiro cart√£o") ||
                norm.includes("nunca tive cartao") ||
                norm.includes("nunca tive cart√£o") ||
                norm.includes("nao tenho cartao") ||
                norm.includes("n√£o tenho cart√£o")
            );

            const ehSegunda = (
                norm.includes("segunda via") ||
                norm.includes("2 via") ||
                norm.includes("2a via") ||
                norm.includes("2¬™ via") ||
                norm.includes("segundo cartao") ||
                norm.includes("segundo cart√£o") ||
                norm.includes("perdi o cartao") ||
                norm.includes("perdi meu cartao") ||
                norm.includes("perdi o cart√£o") ||
                norm.includes("roubaram meu cartao") ||
                norm.includes("roubaram meu cart√£o") ||
                norm.includes("roubo de cart√£o") ||
                norm.includes("perda de cart√£o") ||
                norm.includes("perca de cart√£o") ||
                norm.includes("cartao quebrado") ||
                norm.includes("cart√£o quebrado") ||
                norm.includes("cartao danificado") ||
                norm.includes("cart√£o danificado")
            );

            const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (!ehPrimeira && !ehSegunda && mudouDeAssunto) {
                fluxoNovoCartao = null;
                return `HTML:<p class="text-sm text-slate-700">
Sem problemas, vamos falar de outro assunto ent√£o. üòâ
</p>`;
            }

            if (ehPrimeira) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_primeira";
                return respNovoCartaoPrimeiraVia();
            }

            if (ehSegunda) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_segunda";
                return respNovoCartaoSegundaVia();
            }

            return `HTML:<p class="text-sm text-slate-700">
            N√£o entendi se voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido).<br/><br/>
            Me responde assim, por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }


        // 10) Gatilhos direto ‚Äì primeira via
        if (termosPrimeiraViaDireta.some(t => norm.includes(t))) {
            fluxoNovoCartao = null;
            return respNovoCartaoPrimeiraVia();
        }

        // 11) Gatilhos direto ‚Äì segunda via
        if (gatilhosSegundaViaDireta.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = null;
            return respNovoCartaoSegundaVia();
        }

                // 12) Gatilho ‚Äì quero pedir um cart√£o (abre fluxo pra perguntar primeira/segunda via)
        if (gatilhosNovoCartao.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = "aguardando_tipo_via";
            return `HTML:<p class="text-sm text-slate-700">
            S√≥ pra eu te orientar certinho: voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido)?<br/><br/>
            Responda por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }

        // 13) Demais casos:
//    Se a frase n√£o fala claramente de cart√£o/fatura/pend√™ncias,
//    em vez de chutar uma resposta de pol√≠tica, faz uma pergunta de clarifica√ß√£o.
const falaDeCartaoOuFatura =

  norm.includes("clara") ||
  norm.includes("cartao") ||
  norm.includes("cart√£o") ||
  norm.includes("fatura") ||
  norm.includes("pendencia") ||
  norm.includes("pend√™ncia") ||
  norm.includes("limite") ||
  norm.includes("estacionamento") ||
  norm.includes("posso comprar") ||
  norm.includes("pode comprar") ||
  // üîπ perguntas sobre ETIQUETA tamb√©m s√£o assunto da Clara
  norm.includes("etiqueta") ||
  norm.includes("etiquetas") ||
  // üîπ tudo que menciona gerente/gestor √© claramente assunto de Clara
  norm.includes("gerente") ||
  norm.includes("gerentes") ||
  norm.includes("gestor") ||
  norm.includes("gestora") ||

  // üîπ men√ß√£o direta a loja/unidade (no contexto desse bot faz sentido tratar como Clara)
  norm.includes("loja")     ||
  norm.includes("unidade")  ||

  // üîπ tudo que menciona ServiceNow/procedimento de chamado
  norm.includes("servicenow") ||
  norm.includes("service now") ||
  norm.includes("chamado") ||
  norm.includes("chamados") ||
  norm.includes("ticket") ||
  norm.includes("solicitacao") ||
  norm.includes("solicita√ß√£o") ||
  norm.includes("procedimento") ||
  norm.includes("procedimentos");

// üëá Frases gen√©ricas de compra/uso em primeira pessoa
const falaDeCompraOuUso =
  norm.includes("comprar") ||
  norm.includes("comprei") ||
  norm.includes("preciso comprar") ||
  norm.includes("quero comprar");

// üëá Frases claramente sobre o pr√≥prio Vektor
const falaSobreBot =
  norm.includes("o que voce faz") ||
  norm.includes("o que vc faz") ||
  norm.includes("o que voc√™ faz") ||
  norm.includes("o que o vektor pode fazer") ||
  norm.includes("quem e voce") ||
  norm.includes("quem √© voc√™") ||
  norm.includes("qual o seu nome") ||
  norm.includes("pra que voce serve") ||
  norm.includes("pra que vc serve");

// üëá S√≥ pergunta ‚Äúsobre o que voc√™ fala?‚Äù se N√ÉO for nada disso
if (!falaDeCartaoOuFatura && !falaDeCompraOuUso && !falaSobreBot) {
  const perguntaClara = gerarPerguntaDeClarificacao(norm);
  if (perguntaClara) {
    return perguntaClara;
  }
}

// 14) Ainda assim sobrou ‚Üí motor da pol√≠tica
return gerarRespostaPolitica(msgUsuario);

}

    // ========= INTERVALOS DE DATA PARA PERGUNTAS DE RELAT√ìRIO ========= //

   function extrairIntervaloDatas(msgOriginal) {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const meses = {
        janeiro: 0, fevereiro: 1, marco: 2, mar√ßo: 2, abril: 3, maio: 4, junho: 5,
        julho: 6, agosto: 7, setembro: 8, outubro: 9, novembro: 10, dezembro: 11
    };

    // const norm = (msgOriginal || "").toLowerCase();
    const norm = normalize(msgOriginal || "");
    let m; // <<< ADICIONE ESTA LINHA AQUI

    // 0) Hoje / Ontem
    if (norm.includes("ontem")) {
        const d = new Date(hoje);
        d.setDate(hoje.getDate() - 1);
        return { tipo: "ontem", dataInicio: d, dataFim: d };
    }
    if (norm.includes("hoje")) {
        const d = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        return { tipo: "hoje", dataInicio: d, dataFim: d };
    }

    // 0b-a) Esta semana / nessa semana / nesta semana
    if (
        norm.includes("essa semana") ||
        norm.includes("nesta semana") ||
        norm.includes("nessa semana")
    ) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);

        // volta at√© segunda-feira da semana atual
        const diaSemana = fim.getDay();       // 0=Dom, 1=Seg, ..., 6=Sab
        const diff = (diaSemana === 0 ? 6 : diaSemana - 1); // volta at√© segunda

        ini.setDate(fim.getDate() - diff);

        return { tipo: "semana_atual", dataInicio: ini, dataFim: fim };
    }

    // 0b) √öltima semana
    if (norm.includes("ultima semana") || norm.includes("√∫ltima semana")) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);
        ini.setDate(hoje.getDate() - 7);
        return { tipo: "ultima_semana", dataInicio: ini, dataFim: fim };
    }

    // 0c) √öltimo m√™s  (sin√¥nimo de "m√™s passado")
    if (norm.includes("ultimo mes") || norm.includes("√∫ltimo mes") || norm.includes("√∫ltimo m√™s")) {
        let mes = hoje.getMonth() - 1;
        let ano = anoAtual;
        if (mes < 0) {
            mes += 12;
            ano = anoAtual - 1;
        }
        const ini = new Date(ano, mes, 1);
        const fim = new Date(ano, mes + 1, 0);
        return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
    }

    // "√∫ltimo trimestre" / "trimestre passado"
if (norm.includes("ultimo trimestre") || norm.includes("trimestre passado")) {
  const mesAtual = hoje.getMonth();         // 0..11
  const trimestreAtual = Math.floor(mesAtual / 3); // 0..3
  let ano = anoAtual;
  let trimestreAnterior = trimestreAtual - 1;
  if (trimestreAnterior < 0) {
    trimestreAnterior = 3;
    ano = anoAtual - 1;
  }
  const inicioMes = trimestreAnterior * 3; // 0,3,6,9
  const ini = new Date(ano, inicioMes, 1);
  const fim = new Date(ano, inicioMes + 3, 0); // √∫ltimo dia do trimestre
  return { tipo: "trimestre_passado", dataInicio: ini, dataFim: fim };
}

// "neste trimestre" / "este trimestre"
if (norm.includes("neste trimestre") || norm.includes("este trimestre")) {
  const mesAtual = hoje.getMonth();
  const trimestreAtual = Math.floor(mesAtual / 3);
  const inicioMes = trimestreAtual * 3;
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "trimestre_atual", dataInicio: ini, dataFim: fim };
}

// "neste semestre" / "este semestre"
if (norm.includes("nesse semestre") || norm.includes("este semestre") || norm.includes("neste semestre")) {
  const mesAtual = hoje.getMonth();        // 0..11
  const semestreAtual = Math.floor(mesAtual / 6); // 0 ou 1
  const inicioMes = semestreAtual * 6;     // 0 ou 6
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "semestre_atual", dataInicio: ini, dataFim: fim };
}

// 0) Intervalo num√©rico: aceita com/sem "de" e com/sem ano
// Ex.: "de 01/11/2025 a 15/11/2025", "01/11/2025 a 15/11/2025",
//      "de 01/11 a 15/11", "01/11 a 15/11"
m = norm.match(/(?:de\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?\s+a\s+(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
if (m) {
    const d1 = Number(m[1]);
    const m1 = Number(m[2]) - 1;
    const y1 = m[3] ? Number(m[3]) : anoAtual;

    const d2 = Number(m[4]);
    const m2 = Number(m[5]) - 1;
    const y2 = m[6] ? Number(m[6]) : anoAtual;

    const ini = new Date(y1, m1, d1);
    const fim = new Date(y2, m2, d2, 23, 59, 59);

    return { tipo: "intervalo_numerico", dataInicio: ini, dataFim: fim };
}

    // 0d) Esse m√™s / neste m√™s
    if (
        norm.includes("esse mes") || 
        norm.includes("esse m√™s") ||
        norm.includes("neste mes") || 
        norm.includes("neste m√™s") ||
        norm.includes("nesse m√™s") ||
        norm.includes("nesse mes") ||
        norm.includes("este mes") || 
        norm.includes("este m√™s")
    ) {
        const ini = new Date(anoAtual, hoje.getMonth(), 1);
        const fim = hoje;
        return { tipo: "mes_atual", dataInicio: ini, dataFim: fim };
    }

    // 1) De tal dia a tal dia (ex.: "de 5 a 12 de novembro")
    m = norm.match(/de\s+(\d{1,2})\s+a\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
        const diaIni = Number(m[1]);
        const diaFim = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, diaIni);
            const fim = new Date(anoAtual, mes, diaFim);
            return { tipo: "intervalo", dataInicio: ini, dataFim: fim };
        }
    }

    // 2b) "entre 1 e 15 de novembro"
    m = norm.match(/entre\s+(\d{1,2})\s+e\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
      const dia1 = Number(m[1]);
      const dia2 = Number(m[2]);

      const mesStr = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const mes = meses[mesStr];
      if (mes !== undefined) {
        const ano = anoAtual;
        const ini = new Date(ano, mes, dia1);
        const fim = new Date(ano, mes, dia2, 23, 59, 59);
        return { tipo: "intervalo_mes_texto", dataInicio: ini, dataFim: fim };
      }
    }


      // 2) Dia espec√≠fico num√©rico
    // Aceita: "no dia 10/11/2025", "dia 10/11", "10/11/2025", "10/11"
    m = norm.match(/(?:no\s+dia\s+|dia\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
    if (m) {
        const dia = Number(m[1]);
        const mes = Number(m[2]) - 1;
        const ano = m[3] ? Number(m[3]) : anoAtual;
        const d = new Date(ano, mes, dia);

        return { tipo: "dia", dataInicio: d, dataFim: d };
    }

    // 2b) "em 5 de outubro"
    m = norm.match(/(em|no)\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
        const dia = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const d = new Date(anoAtual, mes, dia);
            return { tipo: "dia", dataInicio: d, dataFim: d };
        }
    }

    // 3a) "no m√™s de setembro"
    m = norm.match(/(em|no)\s+mes\s+de\s+([a-z√ß]+)/);
    if (m) {
        const chaveMes2 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes2)
            ? meses[chaveMes2]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 3b) "em outubro"
    m = norm.match(/(em|no)\s+([a-z√ß]+)/);
    if (m) {
        const chaveMes3 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (Object.prototype.hasOwnProperty.call(meses, chaveMes3)) {
            const mes = meses[chaveMes3];
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 4) "m√™s passado"
if (norm.includes("mes passado")) {   // depois do normalize, "m√™s" j√° virou "mes"
    let mes = hoje.getMonth() - 1;
    let ano = anoAtual;
    if (mes < 0) {
        mes += 12;
        ano = anoAtual - 1;
    }
    const ini = new Date(ano, mes, 1);
    const fim = new Date(ano, mes + 1, 0);
    return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
}

// 5) "√∫ltimos X meses"
m = norm.match(/ultimos?\s+(\d{1,2})\s+mes(es)?/);
if (m) {
    const qtdMeses = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setMonth(hoje.getMonth() - qtdMeses);
    return { tipo: "ultimos_meses", dataInicio: ini, dataFim: fim };
}

// 6) "√∫ltimos 15 dias", etc.
m = norm.match(/ultimos?\s+(\d{1,3})\s+dias?/);
if (m) {
    const qtd = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setDate(hoje.getDate() - qtd);
    return { tipo: "ultimos_dias", dataInicio: ini, dataFim: fim };
}

  // 7) "2 ultimas semanas" ou "ultimas 2 semanas"
m = norm.match(/(\d{1,2})\s+ultimas?\s+semanas?/);
if (!m) {
  m = norm.match(/ultimas?\s+(\d{1,2})\s+semanas?/);
}
if (m) {
  const qtdSemanas = Number(m[1]);
  const dias = qtdSemanas * 7;
  const fim = hoje;
  const ini = new Date(hoje);
  ini.setDate(hoje.getDate() - dias);
  return { tipo: "ultimas_semanas", dataInicio: ini, dataFim: fim };
}

    return null;
}

// Formata "2025-04-10T..." -> "abr/25"
function vektorFormatarMesAnoCurto(isoStr) {
  if (!isoStr) return "";
  var d = new Date(isoStr);
  if (isNaN(d.getTime())) return "";

  var meses = ["jan", "fev", "mar", "abr", "mai", "jun",
               "jul", "ago", "set", "out", "nov", "dez"];
  var mes = meses[d.getMonth()];
  var ano = d.getFullYear().toString().slice(-2);

  return mes + "/" + ano;
}

// Monta a frase "Trazendo dados de abr/25 √† nov/25."
function vektorFraseResumoPeriodo(dataInicioIso, dataFimIso) {
  if (!dataInicioIso || !dataFimIso) return "";

  var ini = vektorFormatarMesAnoCurto(dataInicioIso);
  var fim = vektorFormatarMesAnoCurto(dataFimIso);
  if (!ini || !fim) return "";

  if (ini === fim) {
    return "Trazendo dados de " + ini + ".";
  }
  return "Trazendo dados de " + ini + " √† " + fim + ".";
}

// ===== Cache de per√≠odo para drill-down: "mesmo per√≠odo da pergunta anterior" =====
(function () {
  // Guarda refer√™ncia da fun√ß√£o original
  const _extrairOriginal = extrairIntervaloDatas;

  // Cache global do √∫ltimo per√≠odo entendido
  window.__vektorUltimoPeriodo = null;

  // Sobrescreve a fun√ß√£o usada no restante do c√≥digo
  extrairIntervaloDatas = function (msgOriginal) {
    try {
      const st = vektorObterContexto();
      // 1) Se a mensagem falar "mesmo per√≠odo da pergunta anterior"
      //    e j√° tivermos um per√≠odo salvo, devolve direto o cache
      if (msgOriginal && typeof msgOriginal === "string") {
        const norm = normalize(msgOriginal);
        if (
        norm.includes("mesmo periodo da pergunta anterior") &&
        st.ultimoPeriodo &&
        st.ultimoPeriodo.dataInicio &&
        st.ultimoPeriodo.dataFim
      ) {
        return st.ultimoPeriodo;
        }
      }

      // 2) Caso contr√°rio, usa a fun√ß√£o original
      const periodo = _extrairOriginal(msgOriginal);

        // 3) Se achou per√≠odo, salva tanto em __vektorUltimoPeriodo quanto no VEKTOR_STATE
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      window.__vektorUltimoPeriodo = periodo;
      vektorRegistrarContexto({
        ultimoPeriodo: periodo
      });
    }

      return periodo;
    } catch (e) {
      console.error("Erro no wrapper de extrairIntervaloDatas:", e);
      // fallback: chama fun√ß√£o original
      return _extrairOriginal(msgOriginal);
    }
  };
})();

// ========= RESUMO LOJA x TIME (GR√ÅFICO) ========= //

function renderResumoTransacoesSemana(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar informa√ß√µes de transa√ß√µes para esse filtro. Verifique se o time e o per√≠odo est√£o corretos.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto do crit√©rio (valor x quantidade)
  var criterioTxt = (resumo.tipo === "valor"
    ? "maior <b>valor</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes");

  var grupoHtml = resumo.grupoNome
    ? " no time <b>" + resumo.grupoNome + "</b>"
    : "";

  // Filtros recebidos
  var temFiltroLojas = opts && Array.isArray(opts.filtrarLojasCodigos) && opts.filtrarLojasCodigos.length > 0;
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  var fraseResumo;
  if (temFiltroLojas) {
    // Ex.: "lojas 316 e 39 neste m√™s"
    fraseResumo = "Comparando as lojas <b>" +
      opts.filtrarLojasCodigos.join(", ") +
      "</b> no per√≠odo selecionado" + grupoHtml + ".";
  } else if (temFiltroTimes) {
    // Ex.: "todas as lojas dos times Falc√µes e Lobos"
    fraseResumo = "Mostrando lojas dos times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b> no per√≠odo selecionado" + grupoHtml + ".";
  } else {
    // Comportamento padr√£o (sem filtro espec√≠fico)
    fraseResumo = resumo.top
      ? "A loja <b>" + resumo.top.loja + "</b> foi a que teve " + criterioTxt + " no per√≠odo selecionado" + grupoHtml + "."
      : "N√£o encontrei transa√ß√µes" + grupoHtml + " no per√≠odo selecionado.";
  }

  // Base de lojas
  var all = Array.isArray(resumo.lojas) ? resumo.lojas : [];

     // Aplica filtros de LOJAS (aceita ‚Äú0034 - MORUMBI‚Ä¶‚Äù, ‚Äú0034‚Äù, ‚Äú34‚Äù etc.)
  if (temFiltroLojas) {
    var codSet = {};

    // Normaliza os c√≥digos pedidos pelo usu√°rio (remove tudo que n√£o for d√≠gito e zeros √† esquerda)
    opts.filtrarLojasCodigos.forEach(function (c) {
      var digits = String(c || "").replace(/\D/g, "");  // s√≥ d√≠gitos
      if (!digits) return;
      var norm = digits.replace(/^0+/, "") || digits;   // tira zeros √† esquerda (0176 -> 176)
      codSet[norm] = true;
    });

    all = all.filter(function (linha) {
      // Vamos testar v√°rios campos poss√≠veis da linha
      var campos = [
        linha.loja,
        linha.Loja,
        linha.LojaNum,
        linha.codigoLoja,
        linha.CodigoLoja
      ];

      for (var i = 0; i < campos.length; i++) {
        var v = campos[i];
        if (v === undefined || v === null) continue;

        // pode vir "0176", "176" ou "0176 - PLAZA NITEROI-RJ"
        var digitsLinha = String(v).replace(/\D/g, "");
        if (!digitsLinha) continue;

        var normLinha = digitsLinha.replace(/^0+/, "") || digitsLinha;

        if (codSet[normLinha]) {
          return true; // bateu em algum campo -> mant√©m a linha
        }
      }

      // nenhum campo da linha bateu com os c√≥digos desejados
      return false;
    });
  }

  // Aplica filtros de TIMES
  if (temFiltroTimes) {
    var timesSet = {};
    opts.filtrarTimesNomes.forEach(function (nome) {
      timesSet[String(nome).toLowerCase()] = true;
    });

    all = all.filter(function (linha) {
      var g = String(linha.grupo || linha.Grupo || "").toLowerCase();
      return !!timesSet[g];
    });
  }

  // Decide quantas linhas exibir
  var linhas;
  if (opts && (opts.topN === null)) {
    // topN: null => listar TODAS
    linhas = all;
  } else if (typeof opts.topN === "number") {
    // top N expl√≠cito
    linhas = all.slice(0, Math.max(0, opts.topN));
  } else if (opts && opts.forGroup) {
    // Sem topN + filtrando por time => todas as lojas desse(s) time(s)
    linhas = all;
  } else {
    // Ranking geral sem topN => todas (comportamento antigo)
    linhas = all;
  }

  // Guarda lista de lojas exibidas na √∫ltima tabela (para outras fun√ß√µes usarem)
  try {
    window.__vektorUltimasLojasTabela = (linhas || [])
      .map(function (l) {
        return (l.loja || "").toString().trim();
      })
      .filter(Boolean);
  } catch (e) {
    console.warn("Falha ao registrar lista de lojas da tabela:", e);
  }

  // Somat√≥rios
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // Monta tabela
  var linhasTabela = [];
  if (linhas.length) {

    // Dropdown de drilldown
    linhasTabela.push(
      "<div style='margin-top:8px;margin-bottom:10px;font-size:12px;margin-bottom:4px;color:#334155;display:flex;align-items:center;gap:6px;'>" +
        "<span>Expandir a tabela por:</span>" +
        "<select class='vektor-drill-select' data-base='loja' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Loja</th>" +
        "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    for (var j = 0; j < linhas.length; j++) {
      var l = linhas[j];
      var qtd = Number(l.total) || 0;
      var val = Number(l.valorTotal) || 0;
      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

      var hint = "Clique para detalhar pelo filtro escolhido " + l.loja;

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'loja')\" " +
          "style='cursor:pointer;' " +
          "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + l.loja + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

  // üÜï Insights autom√°ticos sobre as LOJAS (T√ìPICO 3)
  var insightsLojasHtml = vektorGerarInsightsRankingLojas(linhas || []);

  // Bot√µes (CSV + Pend√™ncias + Justificativas)
  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +

        // Exportar CSV
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_lojas')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +

        // Verificar pend√™ncias
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarPendenciasLojas(this)\" " +
            "style='background:#B91C1C;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "‚ö† Verificar pend√™ncias" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(185,28,28,0.92);'>" +
            "Lista todas as pend√™ncias das lojas dessa tabela no per√≠odo informado" +
          "</span>" +
        "</span>" +

        // Verificar justificativas
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarJustificativasLojas(this)\" " +
            "style='background:#0F172A;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "‚úî Verificar justificativas" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(15,23,42,0.92);'>" +
            "Lista todas as transa√ß√µes com justificativas feitas de forma correta" +
          "</span>" +
        "</span>" +

      "</div>";
  }

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      tabelaHtml,
      insightsLojasHtml || "",
      botoesHtml,
    "</div>"
  ].join("");

  // T√ìPICO 2 ‚Äì mem√≥ria de contexto (corrigido para ranking_lojas)
  try {
    vektorRegistrarContexto({
      ultimaIntencao: "ranking_lojas",
      ultimoPeriodo: {
        dataInicioIso: typeof dataInicioIso !== "undefined" ? dataInicioIso : "",
        dataFimIso: typeof dataFimIso !== "undefined" ? dataFimIso : ""
      },
      ultimoGrupo: resumo && resumo.grupoNome ? resumo.grupoNome : null,
      ultimaAcaoExplicavel: {
        tipo: "tabela_ranking_lojas",
        meta: {
          tipoResumo: resumo ? resumo.tipo : null,
          grupo: resumo ? resumo.grupoNome : null
        }
      }
    });
  } catch (e) {
    console.warn("Falha ao registrar contexto de ranking_lojas:", e);
  }

  renderBotMessage("HTML:" + html);
}

function vektorParseMesesBack(textoNorm) {
  // defaults
  if (!textoNorm) return 1;

  // √∫ltimos 3 meses / ultimos 2 meses
  let m = textoNorm.match(/ultim[oa]s?\s+(\d+)\s+mes/);
  if (m) return Math.max(1, Math.min(24, parseInt(m[1], 10)));

  // √∫ltimo semestre
  if (textoNorm.includes("ultimo semestre") || textoNorm.includes("√∫ltimo semestre")) return 6;

  // √∫ltimo ano
  if (textoNorm.includes("ultimo ano") || textoNorm.includes("√∫ltimo ano")) return 12;

  // m√™s corrente
  if (textoNorm.includes("mes corrente") || textoNorm.includes("m√™s corrente")) return 1;

  return 1;
}

function vektorRenderTabelaFrequenciaUso(resp) {
  if (!resp || !resp.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o consegui montar a tabela de frequ√™ncia agora.</p>");
    return;
  }

  const rows = Array.isArray(resp.rows) ? resp.rows : [];
  if (!rows.length) {
    const aviso = resp.aviso ? ` (${resp.aviso})` : "";
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes para esse filtro no per√≠odo analisado" + aviso + ".</p>");
    return;
  }

  const periodoTxt = resp.periodo ? `${resp.periodo.inicio} a ${resp.periodo.fim}` : "‚Äî";

  // Tooltips (title no TH)
  const th = (label, tip) =>
    `<th title="${tip}" class="border px-2 py-1 text-center"
        style="background:#B5FF20;color:#000;white-space:nowrap;">${label}</th>`;

  const insightLinha = resp.insight ? resp.insight : "";
  const leituraAuto =
    "Leitura autom√°tica: lojas com mais <b>Freq. Dias</b> tendem a ter maior recorr√™ncia; valide tamb√©m <b>Top Valor</b> e <b>√öltima Data</b>.";

  const limiteTxt = Array.isArray(resp.insightLimite) && resp.insightLimite.length
    ? `<div style="margin-top:6px;"><b>Ajuste de limite:</b><br>${resp.insightLimite.join("<br>")}`
    : "";

  const atencaoTxt = Array.isArray(resp.insightAtencao) && resp.insightAtencao.length
      ? `<div style="margin-top:6px;">
          <b>Aten√ß√£o:</b>
          <div style="font-size:13px;color:#475569;margin:2px 0 6px 0;">
            Lojas abaixo apresentam <b>padr√µes de uso at√≠picos ou inst√°veis</b> no per√≠odo analisado. Os motivos est√£o descritos individualmente para apoiar an√°lise e acompanhamento.
          </div>
          ${resp.insightAtencao.join("<br>")}
        </div>`
      : "";


  
  const observacaoHistorico =
  "Observa√ß√£o: as m√©tricas hist√≥ricas consideram o <b>hist√≥rico completo da loja</b>, classificada pelo <b>time atual</b>.";

  const insightBox =
        `<div style="margin-top:6px;padding:8px;border:1px solid #E2E8F0;border-radius:6px;background:#F8FAFC;color:#000;font-size:13px;line-height:1.35;">
          ${insightLinha ? `<div><b>Insight:</b> ${insightLinha}</div>` : ""}
          ${limiteTxt}
          ${atencaoTxt}
          <div style="margin-top:4px;">${leituraAuto}</div>
          <div style="margin-top:6px;font-style:italic;color:#475569;">
          ${observacaoHistorico}
        </div>`;

  let html =
    `<div class="text-sm" style="color:#000;margin:0;padding:0;">
       <div style="margin:0 0 6px 0;padding:0;">
         Per√≠odo analisado: <b>${periodoTxt}</b>.

       <div style="margin:0 0 8px 0;padding:0;font-size:13px;line-height:1.4;color:#334155;">
         A an√°lise considera <b>dias distintos com uso</b> do cart√£o no per√≠odo informado, avaliando frequ√™ncia, regularidade e impacto financeiro.

         Priorize as colunas <b>Freq. Dias</b>, <b>Padr√£o de uso</b> e <b>Top Valor</b>. Passe o mouse sobre os t√≠tulos da tabela para ver a descri√ß√£o de cada m√©trica.

       <div class="overflow-x-auto" style="margin:0;padding:0;">
         <table class="min-w-full text-xs border border-slate-200" style="border-collapse:collapse;margin:0;">
           <thead>
             <tr>
               ${th("Loja","C√≥digo identificador da loja (4 d√≠gitos). Todas as m√©tricas da linha referem-se exclusivamente a esta loja.")}
               ${th("Freq. Uso Sem.","Indica com que frequ√™ncia a loja utilizou o cart√£o na semana corrente (Seg‚ÄìDom), considerando dias distintos com transa√ß√£o.")}
               ${th("Freq. Uso Per.","Frequ√™ncia m√©dia de uso da loja dentro do per√≠odo analisado (ex.: m√™s corrente, √∫ltimos 3 meses), baseada em dias distintos com transa√ß√£o.")}
               ${th("Freq. Uso Total","Frequ√™ncia m√©dia hist√≥rica de uso da loja desde a primeira at√© a √∫ltima transa√ß√£o registrada, considerando dias distintos.")}
               ${th("Freq. Dias","Quantidade de dias distintos em que a loja utilizou o cart√£o dentro do per√≠odo analisado. Quanto maior, mais recorrente √© o uso.")}
               ${th("Intervalo M√©dio","N√∫mero m√©dio de dias que a loja ficou sem usar o cart√£o entre uma data de uso e outra, ao longo do hist√≥rico. Valores menores indicam uso mais frequente.")}
               ${th("Padr√£o de uso","Classifica√ß√£o autom√°tica da loja com base na quantidade de dias de uso no per√≠odo analisado: di√°rio, frequente, moderado ou espor√°dico.")}
               ${th("Freq. x Valor","Leitura combinada entre frequ√™ncia de uso e impacto financeiro. Ajuda a identificar lojas com alto valor e baixa frequ√™ncia ou vice-versa.")}
               ${th("Top Valor","Maior valor individual de transa√ß√£o realizado pela loja dentro do per√≠odo analisado.")}
               ${th("√öltima Data","Data mais recente em que a loja utilizou o cart√£o dentro do per√≠odo analisado.")}
               ${th("Consist√™ncia","Avalia se o padr√£o de uso da loja vem se mantendo est√°vel, aumentando ou diminuindo ao longo dos √∫ltimos meses.")}
             </tr>
           </thead>
           <tbody>`;

  rows.forEach(r => {
    const top = (Number(r.topValor) || 0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    const intervalo = (r.intervaloMedio === null || r.intervaloMedio === undefined)
      ? "‚Äî"
      : (Math.round(r.intervaloMedio * 10) / 10).toString().replace(".", ",") + " d";

    html +=
      `<tr>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.loja || ""}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqUsoSem || "‚Äî"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqUsoMes || "‚Äî"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqUsoTotal || "‚Äî"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqDias ?? 0}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${intervalo}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.padrao || "‚Äî"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqXValor || "‚Äî"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${top}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.ultimaDataTrans || "‚Äî"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.consistencia || "‚Äî"}</td>
       </tr>`;
  });

  html +=
        `</tbody>
         </table>
       </div>

       ${insightBox}

       <div style="margin-top:6px;display:flex;justify-content:flex-end;">
         <button type="button"
           onclick="exportTableToCSV(this, 'frequencia_uso_clara')"
           style="
             display:inline-flex;
             align-items:center;
             gap:6px;
             width:auto;
             height:auto;
             min-width:unset;
             min-height:unset;
             padding:8px 12px;
             line-height:1;
             white-space:nowrap;
             background:#005E27;
             color:#fff;
             border:none;
             border-radius:6px;
             font-size:12px;
             font-weight:600;
             cursor:pointer;">
           ‚¨á Exportar CSV
         </button>
       </div>
     </div>`;

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaListaItensComprados(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Erro ao buscar itens.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  if (!rows.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei itens para <b>" +
      (res.tipoFiltro || "") + ": " + (res.valorFiltro || "") +
      "</b> no per√≠odo <b>" + res.periodo.inicio + "</b> a <b>" + res.periodo.fim + "</b>.</p>"
    );
    return;
  }

  // Insights r√°pidos
  const total = (res.resumo && res.resumo.total) || rows.length;
  const alertas = (res.resumo && res.resumo.alertas) || 0;
  const revisar = (res.resumo && res.resumo.revisar) || 0;

  const insightsHtml = `
        <div class="text-sm text-slate-700" style="margin:0; padding:0; white-space:nowrap;">
          <b>Resumo:</b> ${total} itens&nbsp; |&nbsp;
          <b>ALERTA:</b> ${alertas}&nbsp; |&nbsp;
          <b>REVISAR:</b> ${revisar}
        </div>
        <div class="text-xs text-slate-500" style="margin:0; padding:0;">
          Observa√ß√£o: a classifica√ß√£o √© heur√≠stica baseada em descri√ß√£o livre; use como triagem e valide comprovantes/etiquetas.
        </div>
      `;
          // Tabela
            let thead = `
  <thead>
    <tr>
      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Data
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Valor (R$)
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Lojas
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Item Comprado
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Conformidade
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Motivo
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Reincid√™ncia
      </th>
    </tr>
  </thead>
`;

  let tbody = rows.map(r => {
  const v = (Number(r.valor) || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const statusKey = (r.status || r.conformidade || "").toString().trim().toUpperCase() || "REVISAR";
  const reincTxt = (r.reincidencia || "").toString().trim();
  const reincFlag = reincTxt ? "1" : "0";

   const badge =
    statusKey === "ALERTA" ? "<span class='px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-700'>ALERTA</span>" :
    statusKey === "OK"     ? "<span class='px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700'>OK</span>" :
                             "<span class='px-2 py-1 rounded text-xs font-semibold bg-yellow-100 text-yellow-700'>REVISAR</span>";

  return `
    <tr class="border-t border-slate-200"
        data-status="${statusKey}"
        data-reinc="${reincFlag}"
        data-time="${((r.time || '').toString().trim()).replace(/"/g,'&quot;')}"
        data-loja="${((r.loja || '').toString().trim()).replace(/"/g,'&quot;')}">

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        ${r.data || ""}
      </td>

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        R$ ${v}
      </td>

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        ${(r.loja || "").replace(/</g,"&lt;")}
      </td>

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        ${(r.item || "").replace(/</g,"&lt;")}
      </td>

      <td class="px-3 py-2 text-sm border-r border-slate-400" style="white-space:nowrap;">
        ${badge}
      </td>

      <td class="px-3 py-2 text-sm text-slate-700 border-r border-slate-400" style="white-space:nowrap;">
        ${(r.motivo || "").replace(/</g,"&lt;")}
      </td>

      <td class="px-3 py-2 text-sm text-slate-700" style="white-space:nowrap;">
        ${reincTxt.replace(/</g,"&lt;")}
      </td>
    </tr>
  `;
}).join("");

        const tableWrapId = "itensWrap_" + Date.now();

        const isGeral = (res.tipoFiltro || "").toString().toLowerCase() === "geral";

            let opcoesTime = "";
            let opcoesLoja = "";

            if (isGeral) {
              const times = Array.from(
                new Set(
                  rows
                    .map(r => (r.time || "").toString().trim())
                    .filter(Boolean)
                )
              ).sort();

              const lojas = Array.from(
                new Set(
                  rows
                    .map(r => (r.loja || "").toString().trim())
                    .filter(Boolean)
                )
              ).sort();

              opcoesTime = times
                .map(t => `<option value="${t.replace(/"/g,'&quot;')}">${t}</option>`)
                .join("");

              opcoesLoja = lojas
                .map(l => `<option value="${l.replace(/"/g,'&quot;')}">${l}</option>`)
                .join("");
            }


          const filtrosHtml = `
            <div style="margin:0;padding:0;width:100%;display:flex;align-items:center;gap:12px;flex-wrap:wrap;line-height:1;">

              <div class="text-sm text-slate-700 font-semibold" style="white-space:nowrap;">Filtros:</div>

              <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                <span class="text-sm text-slate-700">Conformidade</span>
                <select data-filtro="status"
                  onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                  style="height:32px;padding:0 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;line-height:32px;background:#fff;color:#334155;">
                  <option value="">Todos</option>
                  <option value="OK">OK</option>
                  <option value="REVISAR">REVISAR</option>
                  <option value="ALERTA">ALERTA</option>
                </select>
              </div>

              ${isGeral ? `
                <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                  <span class="text-sm text-slate-700">Time</span>
                  <select multiple size="1" data-filtro="time"
                    onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                    style="min-height:32px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;background:#fff;color:#334155;max-width:240px;">
                    <option value="">Todos</option>
                    ${opcoesTime}
                  </select>
                </div>

                <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                <span class="text-sm text-slate-700">Loja</span>
                <select multiple size="1" data-filtro="loja"
                  onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                  style="min-height:32px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;background:#fff;color:#334155;min-width:260px;max-width:420px;">
                  <option value="">Todas</option>
                  ${opcoesLoja}
                </select>
              </div>

              ` : ""}

              <label style="display:flex;align-items:center;gap:8px;margin:0;padding:0;white-space:nowrap;">
                <input type="checkbox" data-filtro="reinc"
                  onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                  style="width:16px;height:16px;margin:0;" />
                <span class="text-sm text-slate-700">Somente com reincid√™ncia</span>
              </label>

              <button type="button"
                onclick="window.vektorLimparFiltrosItensComprados('${tableWrapId}')"
                style="height:32px;padding:0 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:13px;font-weight:700;line-height:32px;background:#fff;color:#334155;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;">
                Limpar
              </button>

            </div>
          `;

        const tabelaHtml = `
  <div id="${tableWrapId}" style="max-width:100%; width:100%; min-width:0; margin:0; padding:0; line-height:1.2; overflow:hidden;">
  <div style="margin:0; padding:0; display:flex; flex-direction:column; gap:4px;">

    <!-- T√≠tulo/Per√≠odo -->
    <div style="margin:0; padding:0;" class="text-sm text-slate-700">
    <b>Lista de itens comprados</b> ‚Äî ${res.tipoFiltro}: <b>${res.valorFiltro}</b> ‚Äî per√≠odo <b>${res.periodo.inicio}</b> a <b>${res.periodo.fim}</b>
    </div>

    <!-- Insights (se existir vari√°vel insightsHtml) -->
    <div style="margin:0; padding:0; line-height:1.2;">
      ${typeof insightsHtml !== "undefined" ? insightsHtml : ""}
    </div>

    <!-- ‚úÖ Filtros (abaixo do insight principal e acima da tabela) -->
    ${filtrosHtml}

    <!-- Tabela -->
        <div class="mt-1"
        style="max-width:100%; min-width:0; max-height:420px; overflow:auto; position:relative;">
      <table class="border border-slate-200 rounded-lg"
       style="border-collapse:separate; border-spacing:0; table-layout:auto; width:max-content;">
        ${thead}
        <tbody>${tbody}</tbody>
      </table>
    </div>


    <!-- Bot√£o CSV -->
    <div class="mt-1" style="width:100%; display:flex; justify-content:flex-end;">
      <button type="button"
        onclick="exportTableToCSV(this, 'lista_itens_comprados.csv')"
        style="all:unset; cursor:pointer; background:#005E27; color:#fff; padding:10px 16px; border-radius:10px; font-weight:700; display:inline-flex; align-items:center; white-space:nowrap;">
        Exportar CSV
      </button>
    </div>
  </div>

    </div>  <!-- fecha a div flex column -->
    </div>     <!-- fecha a div id="${tableWrapId}" -->
`;

  renderBotMessage("HTML:" + tabelaHtml);
}

function vektorRenderTabelaRelacaoSaldos(res, tipo) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Erro ao buscar saldos.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  const totals = res.totals || {};
  const h = (res.highlights || {});

  // ID √∫nico por inst√¢ncia (evita conflito se o usu√°rio pedir ‚Äúsaldo geral‚Äù 2x no chat)
  const wrapId = "vektor-saldos-" + Date.now() + "-" + Math.floor(Math.random() * 1e6);

  if (!rows.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Sem dados para o per√≠odo <b>" + (periodo.inicio || "") + "</b> a <b>" + (periodo.fim || "") + "</b>.</p>"
    );
    return;
  }

  function money(n) {
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  // =======================
  // FILTROS (APENAS SALDO GERAL)
  // =======================
  var filtrosHtml = "";
  var wrapIdRelacaoSaldos = "relacaoSaldosWrap_" + (tipo || "geral"); // mant√©m como voc√™ j√° tinha
  + "_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);

  if ((tipo || "").toLowerCase() === "geral") {
    // pega lojas/aliases (BaseClara col H) a partir do retorno
    var aliases = (rows || [])
      .map(function(x){ return (x && x.nomeCartao) ? String(x.nomeCartao).trim() : ""; })
      .filter(function(x){ return !!x; });

    // √∫nicos
    var seen = {};
    var aliasesUnicos = [];
    aliases.forEach(function(a){
      if (!seen[a]) { seen[a] = true; aliasesUnicos.push(a); }
    });

    // ordena (opcional, melhora uso)
    aliasesUnicos.sort(function(a,b){ return a.localeCompare(b); });

    var optionsLojas = ["<option value=''>Todas as lojas</option>"]
      .concat(aliasesUnicos.map(function(a){
        return "<option value='" + a.replace(/'/g,"&#39;") + "'>" + a + "</option>";
      }))
      .join("");

    filtrosHtml =
      "<span style='display:inline-flex;align-items:center;gap:8px;margin-left:14px;'>" +
        "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Lojas:</b></label>" +
        "<select id='filtroRelacaoSaldosLoja' " +
                "onchange=\"vektorFiltrarRelacaoSaldos('" + wrapIdRelacaoSaldos + "')\" " +
                "style='font-size:12px;border:1px solid #CBD5E1;border-radius:6px;padding:4px 8px;background:#fff;'>" +
          optionsLojas +
        "</select>" +

        "<label style='font-size:13px;color:#334155;white-space:nowrap;margin-left:8px;'><b>A√ß√£o:</b></label>" +
        "<select id='filtroRelacaoSaldosAcao' " +
                "onchange=\"vektorFiltrarRelacaoSaldos('" + wrapIdRelacaoSaldos + "')\" " +
                "style='font-size:12px;border:1px solid #CBD5E1;border-radius:6px;padding:4px 8px;background:#fff;'>" +
          "<option value=''>Todas</option>" +
          "<option value='Aumentar'>Aumentar</option>" +
          "<option value='Manter'>Manter</option>" +
          "<option value='Reduzir'>Reduzir</option>" +
        "</select>" +

        "<button type='button' " +
                "onclick=\"vektorLimparFiltroRelacaoSaldos('" + wrapIdRelacaoSaldos + "')\" " +
                "style='margin-left:8px;background:#0F172A;color:#fff;border:none;padding:5px 10px;border-radius:6px;font-size:12px;cursor:pointer;'>" +
          "Limpar" +
        "</button>" +
      "</span>";
  }

  // Insights (1 linha por item, sem espa√ßamento)
  let insights = "";

  // Per√≠odo + filtros na MESMA linha (somente geral ter√° filtros; time fica vazio)
  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Per√≠odo:</b> "
    + (periodo.inicio || "") + " a " + (periodo.fim || "")
    + (filtrosHtml || "")
    + "</p>";
  insights += "<div style='height:8px;'></div>";

  if (h.menorSaldo) {
    const lojaTxt = h.menorSaldo.loja ? ("Loja " + h.menorSaldo.loja) : "Loja (N/D)";
    insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Menor saldo:</b> "
      + lojaTxt + " ‚Äî " + money(h.menorSaldo.saldo) + "</p>";
  }
  insights += "<div style='height:8px;'></div>";

  if (h.maiorSaldo) {
    const lojaTxt = h.maiorSaldo.loja ? ("Loja " + h.maiorSaldo.loja) : "Loja (N/D)";
    insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Maior saldo:</b> "
      + lojaTxt + " ‚Äî " + money(h.maiorSaldo.saldo) + "</p>";
  }
  insights += "<div style='height:8px;'></div>";

  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'>"
    + "<b>Proje√ß√£o de gasto:</b> estimativa do valor que a loja tende a gastar at√© o fim do ciclo de faturamento (06‚Üí05), "
    + "calculada pela m√©dia dos √∫ltimos 3 ciclos completos. "
    + "Na aus√™ncia de hist√≥rico suficiente, utiliza 2 ciclos ou, em √∫ltimo caso, os √∫ltimos 30 dias."
    + "</p>";
  insights += "<div style='height:8px;'></div>";

  // Cabe√ßalho din√¢mico
  const showLoja = false;
  const showTime = (tipo === "geral"); // conforme voc√™ pediu: time/loja sem coluna Time

  let th = "";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Nome do cart√£o</th>";
  if (showTime) th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Time</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Tipo</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Titular</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Limite</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Valor Utilizado</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#FFF3B0;color:#000;position:sticky;top:0;z-index:3;'>‚ÑπÔ∏è Proje√ß√£o Gasto</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#FFF3B0;color:#000;position:sticky;top:0;z-index:3;'>% da Proje√ß√£o</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Ritmo de Consumo</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Limite Recomendado</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>A√ß√£o</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Saldo</th>";

  // Linhas
  let trs = "";
  rows.forEach(function(r) {
    var aliasCartao = (r.nomeCartao || "").toString();     // vem da BaseClara (Alias do Cart√£o)

    var acaoLinhaRaw = (r.acao || "").toString(); // pode vir "Aumentar (+R$...)" etc.
    var acaoBase = "";

    var acaoUp = acaoLinhaRaw.trim().toLowerCase();
    if (acaoUp.indexOf("aumentar") === 0) acaoBase = "Aumentar";
    else if (acaoUp.indexOf("reduzir") === 0) acaoBase = "Reduzir";
    else if (acaoUp.indexOf("manter") === 0) acaoBase = "Manter";
    // se vier vazio ou outro texto, acaoBase fica "" (n√£o filtra por a√ß√£o)

    // ‚úÖ NOVO: tooltip na linha inteira
    // ‚úÖ NOVO: mant√©m data-alias / data-acao como j√° existia
    trs += "<tr " +
             "title='Dica: clique no Nome do cart√£o para ver as transa√ß√µes do per√≠odo aberto (06 ‚Üí hoje).' " +
             "data-alias='" + aliasCartao.replace(/'/g, "&#39;") +
             "' data-acao='" + acaoBase.replace(/'/g, "&#39;") + "'>";

    // ‚úÖ NOVO: transforma Nome do cart√£o em link clic√°vel (sem mudar a coluna nem o texto)
    // - passa o aliasCartao para window.vektorAbrirTransacoesPeriodoLoja(alias)
    // - mant√©m o conte√∫do exatamente no mesmo lugar
    var aliasArg = aliasCartao
      .replace(/\\/g, "\\\\")
      .replace(/'/g, "\\'")
      .replace(/</g, "&lt;");

    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;'>" +
             "<a href='javascript:void(0)' " +
                "title='Clique para ver as transa√ß√µes do per√≠odo aberto (06 ‚Üí hoje)' " +
                "onclick=\"window.vektorAbrirTransacoesPeriodoLoja && window.vektorAbrirTransacoesPeriodoLoja('" + aliasArg + "')\" " +
                "style='color:#005E27;font-weight:700;text-decoration:underline;cursor:pointer;'>" +
               (r.nomeCartao || "") +
             "</a>" +
           "</td>";

    if (showTime) {
      trs += "<td style='border:1px solid #000;padding:6px;'>" + (r.time || "") + "</td>";
    }

    trs += "<td style='border:1px solid #000;padding:6px;'>" + (r.tipo || "") + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + (r.titular || "") + "</td>";

    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.limite) + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.utilizado) + "</td>";

    // ‚ÑπÔ∏è Proje√ß√£o Gasto
    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.projecao) + "</td>";

    // % da Proje√ß√£o
    var pctProj = (r.projecao && r.projecao > 0)
      ? ((r.utilizado / r.projecao) * 100).toFixed(1) + "%"
      : "‚Äî";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + pctProj + "</td>";

    // Ritmo de consumo (com √≠cone)
    var ritmoTxt = r.ritmo || "‚Äî";
    var ritmoIcon = "";

    if (ritmoTxt === "Alto") {
      ritmoIcon = "üö® ";
    } else if (ritmoTxt === "M√©dio") {
      ritmoIcon = "‚ö†Ô∏è ";
    } else if (ritmoTxt === "Baixo") {
      ritmoIcon = "‚¨áÔ∏è ";
    }

    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;'>" 
      + ritmoIcon + ritmoTxt 
      + "</td>";

    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;'>" + money(r.limiteRecomendado) + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;font-weight:700;'>" + (r.acao || "") + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.saldo) + "</td>";

    trs += "</tr>";
  });

  const table =
    "<div id='" + wrapIdRelacaoSaldos + "' style='max-width:100%; overflow:auto; max-height:420px;'>" +
      insights +
      "<table style='min-width:1300px; width:100%; border-collapse:collapse;'>" +
        "<thead><tr style='background:#0b2a5b;color:#fff;'>" + th + "</tr></thead>" +
        "<tbody>" + trs + "</tbody>" +
      "</table>" +
      "<div style='text-align:right; margin-top:6px;'>" +
        "<button type='button' onclick=\"exportTableToCSV(this, 'relacao_saldos')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage("HTML:" + table);
}

// Clique no link da Rela√ß√£o de Saldos -> puxa e renderiza transa√ß√µes do per√≠odo aberto
window.vektorAbrirTransacoesPeriodoLoja = function(aliasLoja) {
  try {
    aliasLoja = (aliasLoja || "").toString().trim();
    if (!aliasLoja) return;

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700' style='margin:0;'>Consultando transa√ß√µes de <b>" +
      aliasLoja.replace(/</g,"&lt;") +
      "</b> no per√≠odo aberto (06 ‚Üí hoje)‚Ä¶</p>"
    );

    google.script.run
      .withSuccessHandler(function(res){
        vektorRenderTabelaTransacoesLojaPeriodo(res);
      })
      .withFailureHandler(function(err){
        renderBotMessage("HTML:<p class='text-sm text-red-700'>Falha ao consultar transa√ß√µes: " + (err && err.message ? err.message : err) + "</p>");
      })
      .getTransacoesLojaPeriodoAberto(aliasLoja);
  } catch (e) {
    console.error(e);
  }
};

function vektorRenderTabelaTransacoesLojaPeriodo(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o foi poss√≠vel montar a tabela.</p>");
    return;
  }

  const rows = res.rows || [];
  const meta = res.meta || {};
  const wrapId = "vektor-trans-loja-" + Date.now() + "-" + Math.floor(Math.random()*1e6);

  const titulo =
    `<div class="text-sm text-slate-800" style="margin:0;padding:0;line-height:1.2;">
      <b>Transa√ß√µes da Loja ${String(meta.alias||"").replace(/</g,"&lt;")}</b> no per√≠odo: <b>${String(meta.inicio||"")}</b> at√© <b>${String(meta.fim||"")}</b>.
    </div>`;

  if (!rows.length) {
    renderBotMessage("HTML:" + titulo + "<div class='text-sm text-slate-700' style='margin:4px 0 0 0;'>Sem transa√ß√µes no per√≠odo.</div>");
    return;
  }

  const thead = `
    <thead>
      <tr>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Data</th>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Valor (R$)</th>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Loja</th>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Item Comprado</th>
      </tr>
    </thead>
  `;

  const tbody = rows.map(function(r){
    const v = (Number(r.valor)||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
    return `
      <tr style="border:1px solid #000;">
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;">${(r.data||"")}</td>
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;">R$ ${v}</td>
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;">${String(r.loja||"").replace(/</g,"&lt;")}</td>
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;max-width:520px;overflow:hidden;text-overflow:ellipsis;">
          ${String(r.item||"").replace(/</g,"&lt;")}
        </td>
      </tr>
    `;
  }).join("");

  const html = `
    <div id="${wrapId}" style="width:100%;margin:0;padding:0;line-height:1.2;">
      ${titulo}
      <div style="height:6px;"></div>
      <div style="width:100%;max-height:420px;overflow:auto;border:1px solid #000;border-radius:10px;background:#fff;">
        <table style="width:max-content;border-collapse:collapse;">
          ${thead}
          <tbody>${tbody}</tbody>
        </table>
      </div>
      <div style="margin-top:8px;display:flex;justify-content:flex-end;">
        <button type="button"
          onclick="exportTableToCSV(this, 'transacoes_loja_periodo')"
          style="height:32px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#005E27;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">
          ‚¨á Exportar CSV
        </button>
      </div>
    </div>
  `;

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaEstornos(res, tipo) {
  if (!res || !res.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        (res && res.error ? res.error : "Erro ao buscar estornos.") +
      "</p>"
    );
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  const h = res.highlights || {};

  const wrapId = "vektor-estornos-" + Date.now() + "-" + Math.floor(Math.random() * 1e6);

  if (!rows.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Sem estornos no per√≠odo <b>" +
        (periodo.inicio || "") +
      "</b> a <b>" +
        (periodo.fim || "") +
      "</b>.</p>"
    );
    return;
  }

  function money(n) {
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  const dataset = rows.map(r => ({
    loja: (r.loja || "").toString(),
    time: (r.time || "").toString(),
    data: (r.dataTransacao || "").toString(),
    periodoFatura: (r.periodoFatura || "").toString(),
    valor: r.valorEstorno,
    estabelecimento: (r.estabelecimento || "").toString(),
    titular: (r.titular || "").toString(),
    categoria: (r.categoria || "").toString(),
  }));

  // dataset global por wrapId (pra filtros funcionarem sem nova chamada no GAS)
  window.__VEKTOR_ESTORNOS = window.__VEKTOR_ESTORNOS || {};
  window.__VEKTOR_ESTORNOS[wrapId] = dataset;

  function uniq(arr) {
    const s = {};
    const out = [];
    arr.forEach(x => {
      const k = (x || "").trim();
      if (!k) return;
      if (!s[k]) { s[k] = true; out.push(k); }
    });
    out.sort((a,b)=>a.localeCompare(b));
    return out;
  }

  const timesUnicos = uniq(dataset.map(x => x.time));
  const lojasUnicas = uniq(dataset.map(x => x.loja));

  const showTimeFilter = (String(tipo || "").toLowerCase() !== "time");

  const txt =
  "<div style='margin:0;padding:0;white-space:normal;line-height:18px;'>" +
    "<div class='text-sm text-slate-700' style='margin:0;padding:0;line-height:18px;'>" +
      "<b>Tabela de estornos:</b> Use como auditoria operacional sobre os estornos ocorridos e tamb√©m para valida√ß√£o de justificativas/comprovantes." +
    "</div>" +

        "<div style='height:6px;'></div>" +  // ‚úÖ 1 linha

    "<div class='text-sm text-slate-700' style='margin:6px 0 0 0;padding:0;line-height:18px;'>" +
      "<b>Per√≠odo de an√°lise:</b> " + esc(periodo.inicio || "‚Äî") + " a " + esc(periodo.fim || "‚Äî") +
    "</div>" +

    "<div style='height:6px;'></div>" +  // ‚úÖ 1 linha

    "<div class='text-sm text-slate-700' style='margin:6px 0 0 0;padding:0;line-height:18px;white-space:nowrap;'>" +
      "<b>Total de estornos:</b> " + dataset.length +
      "&nbsp;|&nbsp;<b>Loja maior %:</b> " + (h.lojaMaiorPct ? (esc(h.lojaMaiorPct.loja) + " (" + esc(h.lojaMaiorPct.pct || "0%") + ")") : "‚Äî") +
      "&nbsp;|&nbsp;<b>Maior estorno:</b> " + (h.maiorEstorno ? (esc(money(h.maiorEstorno.valor)) + " em " + esc(h.maiorEstorno.data || "‚Äî")) : "‚Äî") +
    "</div>" +
  "</div>";

  const filtrosHtml = `
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 6px 0;padding:0;line-height:18px;">
      ${showTimeFilter ? `
        <span style="display:inline-flex;align-items:center;gap:8px;">
          <label style="font-size:13px;color:#334155;white-space:nowrap;"><b>Time:</b></label>
          <select id="${wrapId}-time"
                  onchange="window.vektorAplicarFiltrosEstornos('${wrapId}', ${showTimeFilter ? "true" : "false"})"
                  style="font-size:12px;border:1px solid #CBD5E1;border-radius:8px;padding:4px 8px;background:#fff;height:32px;">
            <option value="">Todos os times</option>
            ${timesUnicos.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("")}
          </select>
        </span>
      ` : ""}

      <span style="display:inline-flex;align-items:center;gap:8px;">
        <label style="font-size:13px;color:#334155;white-space:nowrap;"><b>Loja:</b></label>
        <select id="${wrapId}-loja"
                onchange="window.vektorAplicarFiltrosEstornos('${wrapId}', ${showTimeFilter ? "true" : "false"})"
                style="font-size:12px;border:1px solid #CBD5E1;border-radius:8px;padding:4px 8px;background:#fff;height:32px;">
          <option value="">Todas as lojas</option>
          ${lojasUnicas.map(l => `<option value="${esc(l)}">${esc(l)}</option>`).join("")}
        </select>
      </span>
      <button type="button"
        onclick="window.vektorLimparFiltrosEstornos('${wrapId}', ${showTimeFilter ? "true" : "false"})"
        style="
          height:32px;
          min-width:110px;
          padding:0;
          border:1px solid #CBD5E1;
          border-radius:8px;
          background:#fff;
          font-size:12px;
          font-weight:600;
          cursor:pointer;
          display:inline-flex;
          align-items:center;
          justify-content:center;
          line-height:1;
          box-sizing:border-box;
        ">
        Limpar filtros
      </button>
    </div>
  `;

  const thead = `
  <thead>
    <tr>
      ${["Loja","Time","Data da Transa√ß√£o","Per√≠odo da fatura","Valor Estorno","Estabelecimento","Titular","Categoria"].map(t => `
        <th
          style="
            white-space:nowrap;
            position:sticky;
            top:0;
            z-index:3;
            background:#FFEB3B;  /* ‚úÖ amarelo verdadeiro */
            color:#000;
            border:1px solid rgba(0,0,0,.25);
            padding:8px 12px;
            text-align:left;
            font-size:13px;
            font-weight:700;
          "
        >${t}</th>
      `).join("")}
    </tr>
  </thead>
`;

  function rowHtml(r) {
    const b = "border:1px solid rgba(0,0,0,.20);";
    return `
      <tr>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.loja)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.time)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.data)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.periodoFatura)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(money(r.valor))}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.estabelecimento)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.titular)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.categoria)}</td>
      </tr>
    `;
  }

  const html = `
    <div id="${wrapId}" style="width:100%;">
      ${txt}
      ${filtrosHtml}

      <div style="width:100%; max-height:420px; overflow:auto; position:relative; border:1px solid rgba(0,0,0,.15); border-radius:10px; background:#fff;">
        <table style="width:100%; border-collapse:collapse;">
          ${thead}
          <tbody id="${wrapId}-tbody">
            ${dataset.map(rowHtml).join("")}
          </tbody>
        </table>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <button type="button"
          onclick="exportTableToCSV(this, 'estornos_clara')"
          style="height:32px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#005E27;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">
          ‚¨á Exportar CSV
        </button>
      </div>
    </div>
  `;

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaUsoIrregular(res) {
  if (!res || !res.ok) {
    if (res && res.restrito) {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Esse comando √© restrito a Administradores.</p>");
      return;
    }
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o consegui montar o relat√≥rio de uso irregular.</p>");
    return;
  }

  const dataset = Array.isArray(res.rows) ? res.rows : [];
  if (!dataset.length) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Nenhum caso atingiu o gatilho conservador (2+ crit√©rios fortes) no ciclo atual.</p>");
    return;
  }

  const wrapId = "vektor-uso-irregular-" + Date.now();
  window.__VEKTOR_USO_IRREGULAR = window.__VEKTOR_USO_IRREGULAR || {};
  window.__VEKTOR_USO_IRREGULAR[wrapId] = dataset;

  const times = Array.from(new Set(dataset.map(r => (r.time || "").trim()).filter(Boolean))).sort();
  const lojas = Array.from(new Set(dataset.map(r => (r.loja || "").trim()).filter(Boolean))).sort();

  const filtrosHtml = `
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin:0;padding:0;line-height:1;">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:12px;color:#334155;font-weight:700;">Time</label>
        <select id="${wrapId}-time" onchange="window.vektorAplicarFiltrosUsoIrregular('${wrapId}')" style="height:34px;border:1px solid rgba(0,0,0,.2);border-radius:8px;padding:0 10px;font-size:12px;min-width:220px;">
          <option value="">Todos</option>
          ${times.map(t => `<option value="${t}">${t}</option>`).join("")}
        </select>
      </div>

      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:12px;color:#334155;font-weight:700;">Loja</label>
        <select id="${wrapId}-loja" onchange="window.vektorAplicarFiltrosUsoIrregular('${wrapId}')" style="height:34px;border:1px solid rgba(0,0,0,.2);border-radius:8px;padding:0 10px;font-size:12px;min-width:140px;">
          <option value="">Todas</option>
          ${lojas.map(l => `<option value="${l}">${l}</option>`).join("")}
        </select>
      </div>

      <button type="button"
        onclick="window.vektorLimparFiltrosUsoIrregular('${wrapId}')"
        style="height:34px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#0f172a;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;">
        Limpar
      </button>
    </div>
  `;

  const thead = `
    <thead>
      <tr>
        ${["Loja","Time","Data","Cart√£o","Estabelecimento","Qtd (dia)","Soma (dia)","Maior valor","Pend√™ncias","Score","Regras"]
          .map(t => `<th style="
            position:sticky;top:0;z-index:2;
            background:#B91C1C;color:#ffffff;
            border:1px solid #000;
            text-align:left;font-size:13px;font-weight:800;
            padding:8px 12px;white-space:nowrap;
          ">${t}</th>`).join("")}
      </tr>
    </thead>
  `;

  function esc(x){
    return String(x===null||x===undefined?"":x)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function rowHtml(r) {
    const b = "border:1px solid rgba(0,0,0,0.65);";
    return `
      <tr data-loja="${esc(r.loja)}" data-time="${esc(r.time)}">
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.loja)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.time)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.data)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.cartao)}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.estabelecimento)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.qtdDia)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.somaDia)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.valor)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.pendenciasTxt)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;font-weight:800;">${esc(r.score)}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.regrasTxt)}</td>
      </tr>
    `;
  }

      const html = `
      <div id="${wrapId}" style="width:100%; margin:0; padding:0;">

        <div style="margin:0; padding:0; display:flex; flex-direction:column; gap:0;">
        
        <!-- Linha 1: texto -->
        <div class="text-sm text-slate-700"
            style="margin:0;padding:0;line-height:1.2;white-space:nowrap;">
          <b>Poss√≠vel uso irregular</b> (modelo conservador: 2+ crit√©rios fortes). Per√≠odo:
          <b>${esc((res.meta && res.meta.periodo) || "")}</b>.
          <br><br> 

        <!-- Linha 3: filtros -->
        ${filtrosHtml} <br>


    <div style="width:100%; max-height:420px; overflow:auto; position:relative; border:1px solid rgba(0,0,0,0.2); border-radius:10px; background:#fff; margin-top:4px;">
      <table style="width:100%; border-collapse:collapse;">
        ${thead}
        <tbody id="${wrapId}-tbody">
          ${dataset.map(rowHtml).join("")}
        </tbody>
      </table>
    </div>

    <div style="margin-top:4px; display:flex; justify-content:flex-end;">
      <button type="button"
        onclick="exportTableToCSV(this, 'uso_irregular_clara')"
        style="height:32px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#005E27;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">
        ‚¨á Exportar CSV
      </button>
    </div>
  </div>
`;

  renderBotMessage("HTML:" + html);

try {
  var rows = dataset || [];
  var periodoTxt = (res && res.meta && res.meta.periodo) ? res.meta.periodo : "";

  // loja principal = maior score; desempate por maior valor (string dinheiro n√£o √© ideal, mas serve)
  var top = rows.slice().sort(function(a,b){
    if ((b.score||0) !== (a.score||0)) return (b.score||0) - (a.score||0);
    return String(b.valor||"").localeCompare(String(a.valor||""));
  })[0];

  var lojasUnicas = Array.from(new Set(rows.map(r => (r.loja||"").trim()).filter(Boolean)));
  var totalCasos = rows.length;

  var texto =
    "<div class='text-sm text-slate-700' style='margin-top:4px;'>" +
      "<p style='margin:0;'><b>Leitura do cen√°rio:</b> encontrei <b>" + totalCasos + "</b> caso(s) em <b>" + lojasUnicas.length + "</b> loja(s)" +
      (periodoTxt ? " no per√≠odo <b>" + periodoTxt + "</b>" : "") + ".</p>" +
      (top ? (
        "<p style='margin:4px 0 0 0;'>" +
          "A principal prioridade de verifica√ß√£o √© a loja <b>" + (top.loja||"") + "</b>" +
          " (titular: <b>" + (top.titular||"‚Äî") + "</b>), porque teve o maior <b>score (" + (top.score||0) + ")</b> e combinou regras: " +
          "<b>" + (top.regrasTxt||"") + "</b>." +
        "</p>"
      ) : "") +
      "<p style='margin:4px 0 0 0;'>" +
        "<b>Como interpretar o score:</b> ele √© uma soma ponderada de sinais conservadores; " +
        "quanto maior, mais crit√©rios simult√¢neos apareceram (ex.: fracionamento + pend√™ncia + valor alto). " +
        "Use como <b>triagem</b> e confirme em comprovantes/etiquetas/descri√ß√£o." +
      "</p>" +
    "</div>";

  renderBotMessage("HTML:" + texto);
} catch(e) {
  console.warn("Falha ao gerar explica√ß√£o do cen√°rio:", e);
}

}

window.vektorAplicarFiltrosUsoIrregular = function(wrapId) {
  try {
    var data = (window.__VEKTOR_USO_IRREGULAR && window.__VEKTOR_USO_IRREGULAR[wrapId]) ? window.__VEKTOR_USO_IRREGULAR[wrapId] : [];
    var selTime = document.getElementById(wrapId + "-time");
    var selLoja = document.getElementById(wrapId + "-loja");

    var timeVal = selTime ? (selTime.value || "").trim() : "";
    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";

    // 1) FILTRA LINHAS (AND)
    var tbody = document.getElementById(wrapId + "-tbody");
    if (tbody) {
      var trs = tbody.querySelectorAll("tr[data-loja][data-time]");
      trs.forEach(function(tr){
        var t = (tr.getAttribute("data-time") || "").trim();
        var l = (tr.getAttribute("data-loja") || "").trim();

        var okT = !timeVal || t === timeVal;
        var okL = !lojaVal || l === lojaVal;

        tr.style.display = (okT && okL) ? "" : "none";
      });
    }

    // 2) RECONSTR√ìI AS OP√á√ïES DO OUTRO SELECT
    // - lojas v√°lidas dependem do time selecionado
    // - times v√°lidos dependem da loja selecionada
    var lojasValidas = {};
    var timesValidos = {};

    data.forEach(function(r){
      var t = (r.time || "").trim();
      var l = (r.loja || "").trim();

      // aplica ‚Äúo outro filtro‚Äù para gerar op√ß√µes dependentes
      if (!timeVal || t === timeVal) lojasValidas[l] = true;
      if (!lojaVal || l === lojaVal) timesValidos[t] = true;
    });

    function rebuildSelect(selectEl, placeholder, mapValidos, currentVal) {
      if (!selectEl) return;
      var arr = Object.keys(mapValidos).filter(Boolean).sort(function(a,b){ return a.localeCompare(b); });

      var html = "<option value=''>" + placeholder + "</option>";
      arr.forEach(function(v){
        var sel = (currentVal && v === currentVal) ? " selected" : "";
        html += "<option value=\"" + v.replace(/"/g,'&quot;') + "\"" + sel + ">" + v + "</option>";
      });
      selectEl.innerHTML = html;

      // se o valor atual n√£o existe mais, limpa
      if (currentVal && arr.indexOf(currentVal) === -1) {
        selectEl.value = "";
      }
    }

    rebuildSelect(selLoja, "Todas", lojasValidas, lojaVal);
    rebuildSelect(selTime, "Todos", timesValidos, timeVal);

  } catch (e) {
    console.error("Erro em vektorAplicarFiltrosUsoIrregular:", e);
  }
};

window.vektorLimparFiltrosUsoIrregular = function(wrapId) {
  var selTime = document.getElementById(wrapId + "-time");
  var selLoja = document.getElementById(wrapId + "-loja");
  if (selTime) selTime.value = "";
  if (selLoja) selLoja.value = "";
  window.vektorAplicarFiltrosUsoIrregular(wrapId);
};

window.vektorExecutarUsoIrregular = function (modo) {
  try {
    renderBotMessage(
  "HTML:<p class='text-sm text-slate-600'>Processando analise (" + String(modo || "") + ")...</p>"
);

    google.script.run
      .withSuccessHandler(function(res){
        try {
          vektorRenderTabelaUsoIrregular(res); // mant√©m sua renderiza√ß√£o atual
        } catch (e) {
          console.error("Erro ao renderizar uso irregular:", e);
          renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Erro ao renderizar tabela:</b> " + (e && e.message ? e.message : e) + "</p>");
        }
      })
      .withFailureHandler(function(err){
        renderBotMessage("HTML:<p class='text-sm text-red-700'>Falha ao consultar BaseClara: " + (err && err.message ? err.message : err) + "</p>");
      })
      .getPossivelUsoIrregularParaChat(modo);  // <- AGORA com par√¢metro
  } catch (e) {
    console.error(e);
  }
};

window.vektorAplicarFiltrosEstornos = function(wrapId, hasTime) {
  const data = (window.__VEKTOR_ESTORNOS && window.__VEKTOR_ESTORNOS[wrapId]) ? window.__VEKTOR_ESTORNOS[wrapId] : [];

  const timeSel = document.getElementById(wrapId + "-time");
  const lojaSel = document.getElementById(wrapId + "-loja");

  const time = (hasTime && timeSel) ? (timeSel.value || "") : "";
  const loja = lojaSel ? (lojaSel.value || "") : "";

  // quando muda TIME, recalcula lista de lojas poss√≠veis
  if (hasTime && timeSel && lojaSel) {
    const lojasPossiveis = {};
    data.forEach(r => {
      if (time && r.time !== time) return;
      if (r.loja) lojasPossiveis[r.loja] = true;
    });

    const lojaAtual = lojaSel.value || "";
    const opts = ["<option value=''>Todas as lojas</option>"]
      .concat(Object.keys(lojasPossiveis).sort().map(l => `<option value="${String(l).replace(/"/g,"&quot;")}">${l}</option>`));
    lojaSel.innerHTML = opts.join("");

    if (lojaAtual && !lojasPossiveis[lojaAtual]) lojaSel.value = "";
    else lojaSel.value = lojaAtual;
  }

  const lojaFinal = lojaSel ? (lojaSel.value || "") : "";

  const filtrado = data.filter(r => {
    if (hasTime && time && r.time !== time) return false;
    if (lojaFinal && r.loja !== lojaFinal) return false;
    return true;
  });

  // render tbody
  const tbody = document.getElementById(wrapId + "-tbody");
  if (!tbody) return;

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }
  function money(n) {
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  tbody.innerHTML = filtrado.map(r => {
    const b = "border:1px solid rgba(0,0,0,.20);";
    return `
      <tr>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.loja)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.time)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.data)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.periodoFatura)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(money(r.valor))}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.estabelecimento)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.titular)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.categoria)}</td>
      </tr>
    `;
  }).join("");
};

window.vektorLimparFiltrosEstornos = function(wrapId, hasTime) {
  const timeSel = document.getElementById(wrapId + "-time");
  const lojaSel = document.getElementById(wrapId + "-loja");

  if (hasTime && timeSel) timeSel.value = "";
  if (lojaSel) lojaSel.value = "";

  window.vektorAplicarFiltrosEstornos(wrapId, hasTime);
};

function renderTabelaLojasOfensoras(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Falha ao consultar lojas ofensoras.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  const meta = res.meta || {};

  if (!rows.length) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Sem dados de lojas ofensoras no per√≠odo analisado.</p>");
    return;
  }

  const wrapId = "wrapLojasOfensoras_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);

  // IDs √∫nicos por inst√¢ncia (para n√£o quebrar quando o usu√°rio pedir 2x no chat)
  const selLojaId = "filtroOfensorLoja_" + wrapId;
  const selTimeId = "filtroOfensorTime_" + wrapId;
  const selClasseId = "filtroOfensorClasse_" + wrapId;

  // op√ß√µes (valores ‚Äúnorm‚Äù para filtrar sem dor)
  const lojas = Array.from(new Set(rows.map(r => (r.loja || "").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const times = Array.from(new Set(rows.map(r => (r.time || "N/D").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  const classes = Array.from(new Set(rows.map(r => (r.classificacao || "‚Äî").toString().trim()).filter(Boolean)))
  .sort((a,b)=>a.localeCompare(b));

const optsClasses = ["<option value=''>Todas as classifica√ß√µes</option>"]
  .concat(classes.map(c => "<option value='" + c.replace(/'/g,"&#39;") + "'>" + c + "</option>"))
  .join("");


  const optsLojas = ["<option value=''>Todas as lojas</option>"]
    .concat(lojas.map(l => "<option value='" + l.replace(/'/g,"&#39;") + "'>" + l + "</option>"))
    .join("");

  const optsTimes = ["<option value=''>Todos os times</option>"]
    .concat(times.map(t => "<option value='" + t.replace(/'/g,"&#39;") + "'>" + t + "</option>"))
    .join("");

  // cabe√ßalho sticky (z-index alto)
  const thBase = "border:1px solid #000;padding:8px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:5;white-space:nowrap;";

  const TH_METRIC = "background:#ddf032;color:#080707;";

  function money(n){
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  function num(n){ return (Number(n)||0).toLocaleString("pt-BR"); }

  // ===== INSIGHTS (topo como saldo)
  let insights = "";
  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Per√≠odo:</b> " +
    (periodo.inicio || "") + " a " + (periodo.fim || "") +
    "</p>";
  insights += "<div style='height:8px;'></div>";

  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'>" +
  "<b>Lojas ofensoras:</b> Ranking das lojas com maior volume e recorr√™ncia de pend√™ncias de justificativas do cart√£o (Clara). " +
  "As m√©tricas representam pend√™ncias no per√≠odo selecionado: " +
  "<b>Qtde</b> = total de pend√™ncias; <b>Valor</b> = soma do valor associado √†s pend√™ncias; " +
  "<b>Dias c/ pend√™ncia</b> = quantidade de dias distintos de transa√ß√£o com pend√™ncia; " +
  "<b>Etiqueta/NF/Descri√ß√£o</b> = contagem por tipo de falha; " +
  "<b># Snapshots</b> = em quantas coletas diferentes a loja apareceu com pend√™ncia; " +
  "<b>Œî 14d</b> = varia√ß√£o do total de pend√™ncias nas √∫ltimas 2 semanas vs. 2 semanas anteriores; " +
  "<b>Score</b> = √≠ndice composto para prioriza√ß√£o; <b>Classifica√ß√£o</b> = faixa do score." +
"</p>";
  insights += "<div style='height:10px;'></div>";

  // ===== FILTROS (com bot√£o limpar)

  const filtrosHtml =
  "<div style='display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;'>" +

    // ===== Grupo Loja
    "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
      "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Loja:</b></label>" +
      "<select id='" + selLojaId + "' " +
              "onchange=\"window.vektorFiltrarLojasOfensoras('" + wrapId + "')\" " +
              "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
        optsLojas +
      "</select>" +
    "</div>" +

    // ===== Grupo Time
    "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
      "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Time:</b></label>" +
      "<select id='" + selTimeId + "' " +
              "onchange=\"window.vektorFiltrarLojasOfensoras('" + wrapId + "')\" " +
              "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
        optsTimes +
      "</select>" +
    "</div>" +

    // ===== Grupo Classifica√ß√£o  ‚úÖ (label + select juntos)
    "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
      "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Classifica√ß√£o:</b></label>" +
      "<select id='" + selClasseId + "' " +
              "onchange=\"window.vektorFiltrarLojasOfensoras('" + wrapId + "')\" " +
              "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
        optsClasses +
      "</select>" +
    "</div>" +

    // ===== Bot√£o Limpar
    "<button type='button' " +
            "onclick=\"window.vektorLimparFiltrosLojasOfensoras('" + wrapId + "')\" " +
            "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
      "Limpar" +
    "</button>" +

  "</div>";

  // ===== LINHAS (j√° com data-loja/data-time para filtro)
  let trs = "";
  rows.forEach(function(r){
    const loja = (r.loja || "").toString().trim();
    const time = (r.time || "N/D").toString().trim();

    // m√©tricas (se o backend ainda n√£o mandar alguma, mostramos 0/‚Äî sem quebrar layout)
    const qtde = Number(r.qtde) || 0;
    const valor = Number(r.valor) || 0;
    const diasCom = Number(r.diasComPendencia) || 0;

    const pendEtiqueta = Number(r.pendEtiqueta) || 0;
    const pendNF = Number(r.pendNF) || 0;
    const pendDesc = Number(r.pendDesc) || 0;

    const snapDias = (r.diasSnapshot != null) ? Number(r.diasSnapshot) : null;   // opcional
    const snaps = (r.qtdeSnapshots != null) ? Number(r.qtdeSnapshots) : null;   // opcional
    const delta14 = (r.delta14 != null) ? Number(r.delta14) : 0;               // opcional
    const delta14Pct = (r.delta14Pct != null && r.delta14Pct !== "") ? Number(r.delta14Pct) : null;
    const score = (r.score != null) ? Number(r.score) : null;                  // opcional
    const classe = (r.classificacao || "‚Äî").toString();                        // opcional

    const deltaAbsTxt = (delta14 > 0 ? "+" : "") + num(delta14);
    const deltaPctTxt = (delta14Pct == null)
    ? (delta14 > 0 ? "novo" : "‚Äî")   // se ant14=0 e ult14>0 => novo
    : ((delta14Pct > 0 ? "+" : "") + delta14Pct.toFixed(0) + "%");

    const variacaoTxt = (delta14 == null ? "‚Äî" : (deltaAbsTxt + " (" + deltaPctTxt + ")"));

    const pctTxt = (delta14Pct == null)
    ? (delta14 > 0 ? "novo" : "‚Äî")
    : ((delta14Pct > 0 ? "+" : "") + delta14Pct.toFixed(0) + "%");



  trs += "<tr data-loja='" + loja.replace(/'/g,"&#39;") + "' data-time='" + time.replace(/'/g,"&#39;") + "' data-classe='" + classe.replace(/'/g,"&#39;") + "'>" +
      "<td style='border:1px solid #000;padding:8px;white-space:nowrap;'>" + loja + "</td>" +
      "<td style='border:1px solid #000;padding:8px;white-space:nowrap;'>" + time + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(qtde) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;white-space:nowrap;'>" + money(valor) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(diasCom) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(pendEtiqueta) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(pendNF) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(pendDesc) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + (snaps == null ? "‚Äî" : num(snaps)) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;white-space:nowrap;'>" + variacaoTxt + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;white-space:nowrap;'>" + pctTxt + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + (score == null ? "‚Äî" : score.toFixed(1)) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;font-weight:800;white-space:nowrap;'>" + classe + "</td>" +

    "</tr>";
  });

  const table =
    "<div id='" + wrapId + "' style='max-width:100%; overflow:auto; max-height:520px; padding:10px; border:1px solid #e5e7eb; border-radius:14px; background:#fff;'>" +
      insights +
      filtrosHtml +
      "<table style='min-width:1550px; width:100%; border-collapse:collapse;'>" +
        "<thead><tr>" +
          "<th style='" + thBase + "'>Loja</th>" +
          "<th style='" + thBase + "'>Time</th>" +
          "<th style='" + thBase + "'>Qtde</th>" +
          "<th style='" + thBase + "'>Valor (R$)</th>" +
          "<th style='" + thBase + "'>Dias c/ pend√™ncia</th>" +
          "<th style='" + thBase + "'>Etiqueta</th>" +
          "<th style='" + thBase + "'>NF/Recibo</th>" +
          "<th style='" + thBase + "'>Descri√ß√£o</th>" +

          // HEADERS AMARELO ESCURO (4 COLUNAS)
          "<th style='" + thBase + ";" + TH_METRIC + "'># Snapshots</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>Varia√ß√£o - Œî 14d</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>% Var Œî 14d</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>Score</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>Classifica√ß√£o</th>" +
        "</tr></thead>" +
        "<tbody>" + trs + "</tbody>" +
      "</table>" +
      "<div style='text-align:right; margin-top:8px;'>" +
        "<button type='button' onclick=\"exportTableToCSV(this, 'lojas_ofensoras')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage("HTML:" + table);
}

function renderTabelaComparativoFaturas(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Falha ao consultar comparativo de faturas.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  if (!rows.length) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Sem dados para comparar fatura atual vs anterior.</p>");
    return;
  }

  const wrapId = "wrapComparativoFaturas_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
  const selLojaId = "filtroCompFatLoja_" + wrapId;
  const selTimeId = "filtroCompFatTime_" + wrapId;

  // op√ß√µes
  const lojas = Array.from(new Set(rows.map(r => (r.loja || "").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const times = Array.from(new Set(rows.map(r => (r.time || "N/D").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  const optsLojas = ["<option value=''>Todas as lojas</option>"]
    .concat(lojas.map(l => "<option value='" + l.replace(/'/g,"&#39;") + "'>" + l + "</option>"))
    .join("");

  const optsTimes = ["<option value=''>Todos os times</option>"]
    .concat(times.map(t => "<option value='" + t.replace(/'/g,"&#39;") + "'>" + t + "</option>"))
    .join("");

  // estilos
  const TH_BASE = "padding:8px;position:sticky;top:0;z-index:5;white-space:nowrap;background:#4F46E5;color:#000;border:3px double #fff;";
  const TD_BASE = "padding:8px;white-space:nowrap;border:1px solid #000;";

  const TH_CALC =
    "padding:8px;position:sticky;top:0;z-index:6;white-space:nowrap;" +
    "background:#005E27;color:#fff;border:3px double #fff;";

  function money(n){
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }

  // ===== SUMMARY (backend)
  const s = res.summary || {};
  const totalPrev0 = Number(s.totalPrev) || 0;
  const totalCur0  = Number(s.totalCur) || 0;
  const totalDelta0 = totalCur0 - totalPrev0;
  const totalVar0 = (totalPrev0 > 0)
    ? (((totalDelta0/totalPrev0*100) > 0 ? "+" : "") + (totalDelta0/totalPrev0*100).toFixed(1) + "%")
    : (totalCur0 > 0 ? "In√≠cio no per√≠odo" : "‚Äî");

  // ===== INSIGHTS (topo)
  const ant = periodo.anterior || {};
  const atu = periodo.atual || {};

  let insights = "";
  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Per√≠odo anterior:</b> " + (ant.inicio||"") + " a " + (ant.fim||"") +
    " ‚Äî <b>Valor comparado:</b> <span id='cmpPrevTotal_" + wrapId + "'>" + money(totalPrev0) + "</span>" +
  "</p>";

  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Per√≠odo atual:</b> " + (atu.inicio||"") + " a " + (atu.fim||"") +
    " ‚Äî <b>Valor atual comparado:</b> <span id='cmpCurTotal_" + wrapId + "'>" + money(totalCur0) + "</span>" +
  "</p> <br>";

  const meta = res.meta || {};
  const ultData = (meta.ultimaDataConsiderada || "").toString().trim();

if (ultData) {
  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Nota:</b> O comparativo considera as transa√ß√µes da fatura atual registradas at√© <b>" + ultData + "</b>." +
  "</p>";
}

  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Varia√ß√£o total no per√≠odo analisado:</b> " +
    "<span id='cmpDelta_" + wrapId + "'><b>" + (totalDelta0 >= 0 ? "+" : "") + money(totalDelta0) + "</b></span> " +
    "(<span id='cmpVarPct_" + wrapId + "'>" + totalVar0 + "</span>)" +
  "</p>";

  insights += "<div style='height:8px;'></div>";

  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "A varia√ß√£o √© calculada comparando o total do per√≠odo da fatura atual vs o mesmo per√≠odo da fatura anterior. " +
    "Quando o per√≠odo anterior √© zero e houve gasto no atual, a varia√ß√£o aparece como <b>In√≠cio no per√≠odo</b> (percentual indefinido)." +
  "</p>";
  insights += "<div style='height:10px;'></div>";

  // ===== FILTROS
  const filtrosHtml =
    "<div style='display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;'>" +

      "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
        "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Loja:</b></label>" +
        "<select id='" + selLojaId + "' onchange=\"window.vektorFiltrarComparativoFaturas('" + wrapId + "')\" " +
          "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
          optsLojas +
        "</select>" +
      "</div>" +

      "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
        "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Time:</b></label>" +
        "<select id='" + selTimeId + "' onchange=\"window.vektorFiltrarComparativoFaturas('" + wrapId + "')\" " +
          "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
          optsTimes +
        "</select>" +
      "</div>" +

      "<button type='button' onclick=\"window.vektorLimparFiltrosComparativoFaturas('" + wrapId + "')\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Limpar" +
      "</button>" +
    "</div>";

  // ===== LINHAS
  let trs = "";
  rows.forEach(function(r){
    const loja = (r.loja || "").toString().trim();
    const time = (r.time || "N/D").toString().trim();

    const vPrev = Number(r.valorAnterior) || 0;
    const vCur  = Number(r.valorAtual) || 0;
    const dVal  = Number(r.deltaValor) || 0;
    const varTxt= (r.variacaoPctTxt != null ? String(r.variacaoPctTxt) : "‚Äî");

    const cat = (r.categoriaDriver || "‚Äî").toString();
    const picoDia = (r.picoDia || "‚Äî").toString();
    const picoV = Number(r.picoValor) || 0;
    const fator = (r.fatorVariacao || "‚Äî").toString();

    trs += "<tr data-loja='" + loja.replace(/'/g,"&#39;") + "' " +
                "data-time='" + time.replace(/'/g,"&#39;") + "' " +
                "data-prev='" + String(vPrev) + "' " +
                "data-cur='" + String(vCur) + "'>" +
      "<td style='" + TD_BASE + "'>" + loja + "</td>" +
      "<td style='" + TD_BASE + "'>" + time + "</td>" +

      "<td style='" + TD_BASE + "text-align:right;'>" + money(vPrev) + "</td>" +
      "<td style='" + TD_BASE + "text-align:right;'>" + money(vCur) + "</td>" +
      "<td style='" + TD_BASE + "text-align:right;'>" + (dVal >= 0 ? "+" : "") + money(dVal) + "</td>" +
      "<td style='" + TD_BASE + "text-align:center;'>" + varTxt + "</td>" +

      "<td style='" + TD_BASE + "'>" + cat + "</td>" +
      "<td style='" + TD_BASE + "text-align:center;'>" + picoDia + "</td>" +
      "<td style='" + TD_BASE + "text-align:right;'>" + money(picoV) + "</td>" +
      "<td style='" + TD_BASE + "white-space:normal; min-width:420px;'>" + fator.replace(/</g,"&lt;").replace(/>/g,"&gt;") + "</td>" +
    "</tr>";
  });

  const table =
    "<div id='" + wrapId + "' style='max-width:100%; overflow:auto; max-height:520px; padding:10px; border:1px solid #e5e7eb; border-radius:14px; background:#fff;'>" +
      insights +
      filtrosHtml +
      "<table style='min-width:1850px; width:100%; border-collapse:collapse;'>" +
        "<thead><tr>" +
          "<th style='" + TH_BASE + "'>Loja</th>" +
          "<th style='" + TH_BASE + "'>Time</th>" +
          "<th style='" + TH_CALC + "'>Valor Per. Anterior</th>" +
          "<th style='" + TH_CALC + "'>Valor Per. Atual</th>" +
          "<th style='" + TH_CALC + "'>Œî Valor (R$)</th>" +
          "<th style='" + TH_CALC + "'>Varia√ß√£o (%)</th>" +
          "<th style='" + TH_BASE + "'>Categoria driver</th>" +
          "<th style='" + TH_BASE + "'>Pico (dia)</th>" +
          "<th style='" + TH_BASE + "'>Valor pico</th>" +
          "<th style='" + TH_BASE + "'>Fator Varia√ß√£o</th>" +
        "</tr></thead>" +
        "<tbody>" + trs + "</tbody>" +
      "</table>" +
      "<div style='text-align:right; margin-top:8px;'>" +
        "<button type='button' onclick=\"exportTableToCSV(this, 'comparativo_faturas')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage("HTML:" + table);

  // ===== 2¬™ mensagem: narrativa (usa summary do backend)
  try {
    const topCats = (s.topCats || []).slice(0,3);
    const topLojas = (s.topLojas || []).slice(0,3);

    const direcao = totalDelta0 > 0 ? "aumento" : (totalDelta0 < 0 ? "redu√ß√£o" : "estabilidade");
    const verbo = totalDelta0 > 0 ? "subiu" : (totalDelta0 < 0 ? "caiu" : "se manteve");

    let texto = "";
    texto += "<p class='text-base text-slate-700' style='margin:0;'><b>Leitura do per√≠odo:</b></p><br>";
    texto += "<p class='text-sm text-slate-700' style='margin:0;'>" +
      "No recorte analisado, a fatura <b>" + verbo + "</b> de <b>" + money(totalPrev0) + "</b> para <b>" + money(totalCur0) + "</b>, " +
      "uma varia√ß√£o de <b>" + (totalDelta0 >= 0 ? "+" : "") + money(totalDelta0) + "</b> (" + totalVar0 + ")." +
      "</p>";

    const topDias = (s.topDias || []).slice(0,5);
    if (topDias.length) {
      const partesD = topDias.map(d => {
        const delta = Number(d.delta) || 0;
        return "<b>" + (d.dia || "‚Äî") + "</b>: " + (delta>=0?"+":"") + money(delta);
      });

      texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
        "Os dias que mais impactaram a varia√ß√£o (comparando o mesmo dia do ciclo anterior) foram: " +
        partesD.join(", ") + "." +
      "</p>";
    }

    if (topCats.length) {
      const partes = topCats.map(c => {
        const d = Number(c.delta) || 0;
        return "<b>" + (c.categoria || "‚Äî") + "</b> (" + (d>=0?"+":"") + money(d) + ")";
      });
      texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
        "O " + direcao + " foi explicado principalmente por " + partes.join(", ") + "." +
        "</p>";
    }

    if (topLojas.length) {
      const partesL = topLojas.map(r => {
        const d = Number(r.deltaValor) || 0;
        return "Loja <b>" + (r.loja || "") + "</b> (" + (r.time || "N/D") + ") <b>" + (d>=0?"+":"") + money(d) + "</b>";
      });
      texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
        "As maiores contribui√ß√µes vieram de: " + partesL.join("; ") + "." +
        "</p>";
    }

    texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
      "Para detalhar por loja/time, aplique os filtros e leia o campo <b>Fator Varia√ß√£o</b>, que aponta a categoria driver, poss√≠vel estabelecimento relevante e o dia de pico." +
      "</p>";

     // ===== Sazonalidade (se o backend mandou)
      const sazTxt = (s.sazonalidadeTexto || "").toString().trim();
      if (sazTxt) {
        texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
          sazTxt.replace(/</g,"&lt;").replace(/>/g,"&gt;") +
        "</p>";
      }

    renderBotMessage("HTML:" + texto);
  } catch (e) {
    console.error("Erro ao renderizar resumo comparativo:", e);
  }
}

window.vektorFiltrarLojasOfensoras = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    // ‚úÖ pega os selects desta inst√¢ncia (n√£o do documento inteiro)
    var selLoja = wrap.querySelector("select[id^='filtroOfensorLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroOfensorTime_']");
    var selClasse = wrap.querySelector("select[id^='filtroOfensorClasse_']");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var timeVal = selTime ? (selTime.value || "").trim() : "";
    var classeVal = selClasse ? (selClasse.value || "").trim() : "";

    // ‚úÖ agora tamb√©m exige data-classe nas linhas
    var trs = wrap.querySelectorAll("tbody tr[data-loja][data-time][data-classe]");
    trs.forEach(function (tr) {
      var loja = (tr.getAttribute("data-loja") || "").trim();
      var time = (tr.getAttribute("data-time") || "").trim();
      var classe = (tr.getAttribute("data-classe") || "").trim();

      var okLoja = !lojaVal || loja === lojaVal;
      var okTime = !timeVal || time === timeVal;
      var okClasse = !classeVal || classe === classeVal;

      tr.style.display = (okLoja && okTime && okClasse) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar lojas ofensoras:", e);
  }
};

window.vektorLimparFiltrosLojasOfensoras = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = wrap.querySelector("select[id^='filtroOfensorLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroOfensorTime_']");
    var selClasse = wrap.querySelector("select[id^='filtroOfensorClasse_']");

    if (selLoja) selLoja.value = "";
    if (selTime) selTime.value = "";
    if (selClasse) selClasse.value = "";

    window.vektorFiltrarLojasOfensoras(wrapId);
  } catch (e) {
    console.error("Erro ao limpar filtros lojas ofensoras:", e);
  }
};

window.vektorFiltrarComparativoFaturas = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    // money local (n√£o depende do escopo da renderTabelaComparativoFaturas)
    function moneyLocal_(n){
      var v = Number(n) || 0;
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    var selLoja = wrap.querySelector("select[id^='filtroCompFatLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroCompFatTime_']");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var timeVal = selTime ? (selTime.value || "").trim() : "";

    // 1) filtra linhas
    var trs = wrap.querySelectorAll("tbody tr[data-loja][data-time]");
    trs.forEach(function(tr){
      var loja = (tr.getAttribute("data-loja") || "").trim();
      var time = (tr.getAttribute("data-time") || "").trim();

      var okLoja = !lojaVal || loja === lojaVal;
      var okTime = !timeVal || time === timeVal;

      tr.style.display = (okLoja && okTime) ? "" : "none";
    });

    // 2) calcula valores dispon√≠veis nas linhas VIS√çVEIS
    var lojasVisiveis = new Set();
    var timesVisiveis = new Set();

    trs.forEach(function(tr){
      if (tr.style.display === "none") return;
      lojasVisiveis.add((tr.getAttribute("data-loja") || "").trim());
      timesVisiveis.add((tr.getAttribute("data-time") || "").trim());
    });

    function atualizarSelect(selectEl, placeholder, valuesSet) {
      if (!selectEl) return;
      var atual = (selectEl.value || "").trim();

      var values = Array.from(valuesSet).filter(Boolean).sort(function(a,b){ return a.localeCompare(b); });

      var html = "<option value=''>" + placeholder + "</option>";
      values.forEach(function(v){
        var safe = v.replace(/'/g,"&#39;");
        html += "<option value='" + safe + "'>" + v + "</option>";
      });

      selectEl.innerHTML = html;

      // restaura sele√ß√£o se ainda existir
      var aindaExiste = values.indexOf(atual) >= 0;
      selectEl.value = aindaExiste ? atual : "";
    }

    // 3) sincroniza dropdowns conforme resultado do filtro atual
    atualizarSelect(selLoja, "Todas as lojas", lojasVisiveis);
    atualizarSelect(selTime, "Todos os times", timesVisiveis);

    // 4) Recalcula totais conforme linhas vis√≠veis (depois dos dropdowns estabilizarem)
    // (re-l√™ trs para garantir que est√° consistente)
    trs = wrap.querySelectorAll("tbody tr[data-loja][data-time]");

    var sumPrev = 0;
    var sumCur  = 0;

    trs.forEach(function(tr){
      if (tr.style.display === "none") return;
      sumPrev += Number(tr.getAttribute("data-prev")) || 0;
      sumCur  += Number(tr.getAttribute("data-cur")) || 0;
    });

    var delta = sumCur - sumPrev;

    var varTxt = (sumPrev > 0)
      ? (((delta / sumPrev * 100) > 0 ? "+" : "") + (delta / sumPrev * 100).toFixed(1) + "%")
      : (sumCur > 0 ? "In√≠cio no per√≠odo" : "‚Äî");

    // Atualiza os valores no topo
    var elPrev  = document.getElementById("cmpPrevTotal_" + wrapId);
    var elCur   = document.getElementById("cmpCurTotal_" + wrapId);
    var elDelta = document.getElementById("cmpDelta_" + wrapId);
    var elVar   = document.getElementById("cmpVarPct_" + wrapId);

    if (elPrev)  elPrev.innerHTML  = moneyLocal_(sumPrev);
    if (elCur)   elCur.innerHTML   = moneyLocal_(sumCur);
    if (elDelta) elDelta.innerHTML = "<b>" + (delta >= 0 ? "+" : "") + moneyLocal_(delta) + "</b>";
    if (elVar)   elVar.innerHTML   = varTxt;

  } catch (e) {
    console.error("Erro ao filtrar comparativo faturas:", e);
  }
};

window.vektorLimparFiltrosComparativoFaturas = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = wrap.querySelector("select[id^='filtroCompFatLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroCompFatTime_']");

    if (selLoja) selLoja.value = "";
    if (selTime) selTime.value = "";

    // re-aplica para reconstituir dropdowns completos
    window.vektorFiltrarComparativoFaturas(wrapId);

  } catch (e) {
    console.error("Erro ao limpar filtros comparativo faturas:", e);
  }
};

// ========= Bot√µes "Verificar pend√™ncias / justificativas" (tabelas de LOJAS) ========= //

function vektorMontarTabelaPendJust_(titulo, colunas, linhas) {
    // Se n√£o vier nenhuma linha, mostra mensagem
    if (!linhas || !linhas.length) {
        return "<p class='text-sm text-slate-700'>N√£o encontrei registros para " +
               (titulo || "").toLowerCase() + " nesse per√≠odo/sele√ß√£o.</p>";
    }

    // Identifica se √© tabela de pend√™ncias ou de justificativas pelo t√≠tulo
    var lowerTitulo  = (titulo || "").toLowerCase();
    var isPendencias = lowerTitulo.indexOf("pend") >= 0;

    // Cores
    var headerColor   = isPendencias ? "#B91C1C" : "#0F172A"; // vermelho / azul escuro
    var botaoCsvColor = "#005E27";                            // verde padr√£o Vektor

    // Cabe√ßalhos que SER√ÉO exibidos
    var colunasVisiveis;
    if (isPendencias) {
        // PEND√äNCIAS: Loja | Data | Valor | Pend√™ncias (coluna √∫nica)
        colunasVisiveis = [
            "Loja",
            "Data da Transa√ß√£o",
            "Valor (R$)",
            "Pend√™ncias"
        ];
    } else {
        // JUSTIFICATIVAS: formato original com 3 colunas separadas
        // Loja | Data | Valor | Etiqueta | Descri√ß√£o | Recibo
        colunasVisiveis = [
            "Loja",
            "Data da Transa√ß√£o",
            "Valor (R$)",
            "Etiqueta",
            "Descri√ß√£o",
            "Recibo"
        ];
    }

    var partes = [];

    // Container + tabela
    partes.push(
      "<div class='text-sm text-slate-700' style='max-width:1000px;margin:auto;'>",
        "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>", titulo, "</p>",
        "<div style='overflow-x:auto;'>",
          "<table border='1' cellspacing='0' cellpadding='8' " +
          "style='border-collapse:collapse;width:100%;font-size:13px;border:1px solid #000;'>"
    );

    // ===== Cabe√ßalho =====
    partes.push("<thead><tr style='background:" + headerColor + ";color:#fff;'>");

    colunasVisiveis.forEach(function (col) {

        // Ajuste de larguras APENAS na tabela de JUSTIFICATIVAS
        if (!isPendencias) {

            // Data da Transa√ß√£o ‚Äî largura maior
            if (col === "Data da Transa√ß√£o") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:160px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Etiqueta ‚Äî maior que Data
            if (col === "Etiqueta") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:260px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Descri√ß√£o ‚Äî maior que Etiqueta
            if (col === "Descri√ß√£o") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:300px;'>",
                  col,
                  "</th>"
                );
                return;
            }
        }

        // Default para todas as outras colunas
        partes.push(
          "<th style='border:1px solid #000;padding:6px;text-align:center;'>",
          col,
          "</th>"
        );
    });

    partes.push("</tr></thead><tbody>");

    // IMPORTANTE: backend (Code.gs) monta cada linha como:
    // [0] Loja
    // [1] Data da Transa√ß√£o
    // [2] Valor (R$)
    // [3] Etiqueta
    // [4] Descri√ß√£o
    // [5] Recibo
    linhas.forEach(function (row) {
        var loja      = row[0] != null ? String(row[0]) : "";
        var data      = row[1] != null ? String(row[1]) : "";
        var valorNum  = row[2] != null ? Number(row[2]) || 0 : 0;
        var etiqueta  = row[3] != null ? String(row[3]).trim() : "";
        var descricao = row[4] != null ? String(row[4]).trim() : "";
        var reciboRaw = row[5] != null ? String(row[5]).trim() : "";

        var valorFmt = valorNum.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL"
        });

        // Normaliza recibo para ver se √© "n√£o/nao"
        var reciboNorm = reciboRaw
            ? reciboRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase()
            : "";

        partes.push("<tr>");

        // Loja
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          loja,
          "</td>"
        );

        // Data
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          data,
          "</td>"
        );

        // Valor
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          valorFmt,
          "</td>"
        );

        if (isPendencias) {
            // üî¥ TABELA DE PEND√äNCIAS: coluna √∫nica ‚ÄúPend√™ncias‚Äù

            var pendencias = [];
            if (!etiqueta)  pendencias.push("Etiqueta");
            if (!descricao) pendencias.push("Descri√ß√£o");
            if (reciboNorm === "nao" || reciboNorm === "n√£o") {
                pendencias.push("Nota fiscal/Recibo");
            }

            var pendTexto = pendencias.length ? pendencias.join(", ") : "";

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              pendTexto,
              "</td>"
            );

        } else {
            // üîµ TABELA DE JUSTIFICATIVAS: colunas separadas

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              etiqueta,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              descricao,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              reciboRaw,
              "</td>"
            );
        }

        partes.push("</tr>");
    });

    partes.push("</tbody></table></div>");

    // Bot√£o CSV (igual ao resto do sistema)
    var nomeArquivo = isPendencias ? "pendencias_lojas" : "justificativas_lojas";

    partes.push(
      "<div style='margin-top:10px;text-align:right;'>",
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, '" + nomeArquivo + "')\" " +
          "style='background:" + botaoCsvColor + ";color:#fff;border:none;padding:8px 12px;" +
                 "border-radius:4px;font-size:12px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>",
      "</div>"
    );

    partes.push("</div>");

    return partes.join("");
}

function vektorMontarTabelaFaturas_(titulo, faturas) {
  if (!faturas || !faturas.length) {
    return "<p class='text-sm text-slate-700'>N√£o encontrei faturas na BaseClara.</p>";
  }

  var partes = [];

  partes.push(
    "<div class='text-sm text-slate-700' style='max-width:1000px;margin:12px auto 0;'>",
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>",
      // NOVA linha de orienta√ß√£o
    "<p style='margin-bottom:8px;text-align:center;font-size:13px;color:#000000;'>" +
      "Clique na linha da fatura para verificar o valor detalhado por times." +  
     "</p>" +  
     
     "<p style='margin-bottom:8px;text-align:center;font-size:13px;color:#000000;'>" +
  "E clique em <b>Extrair dados</b> para verificar o relat√≥rio de transa√ß√µes da fatura." +
    "</p>",
      "<div style='overflow-x:auto;'>",
        "<table border='1' cellspacing='0' cellpadding='8' " +
        "style='border-collapse:collapse;width:100%;font-size:13px;border:2px double #000;'>",
          "<thead>",
            "<tr style='background:#0F172A;color:#fff;'>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Fatura (per√≠odo / extrato da conta)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Valor total (R$)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Varia√ß√£o</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Extra√ß√£o</th>",
            "</tr>",
          "</thead>",
          "<tbody>"
  );

  var somaTotal = 0;
  var valorAnterior = null;

  // ‚îÄ Insights: vamos guardar a MAIOR ALTA e a MAIOR QUEDA de uma fatura para a seguinte
  var maiorAumento = null; // { faturaAtual, variacao }
  var maiorQueda   = null; // { faturaAtual, variacao }

  faturas.forEach(function (f, idx) {
    var valor = Number(f.valorTotal) || 0;
    somaTotal += valor;

    var valorFmt = valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

    // Calcula varia√ß√£o em rela√ß√£o √† fatura anterior
    var variacaoTexto = "‚Äî";
    if (valorAnterior !== null && valorAnterior !== 0) {
      var variacao = ((valor - valorAnterior) / valorAnterior) * 100;
      var variacaoFmt = variacao.toFixed(1).replace(".", ",") + "%";

      if (variacao > 0) {
        variacaoTexto = "+" + variacaoFmt;
      } else {
        variacaoTexto = variacaoFmt;
      }

      // Atualiza maior aumento
      if (!maiorAumento || variacao > maiorAumento.variacao) {
        maiorAumento = {
          faturaAtual: f,
          variacao: variacao
        };
      }

      // Atualiza maior queda
      if (!maiorQueda || variacao < maiorQueda.variacao) {
        maiorQueda = {
          faturaAtual: f,
          variacao: variacao
        };
      }
    }

    // üîΩ linha clic√°vel para drilldown por time (usando EXTRATO e per√≠odo)

    // dentro do forEach das faturas, onde voc√™ faz partes.push("<tr ...>", "<td>...</td>", ...)

    partes.push(
  "<tr onclick=\"window.vektorDrillTimesFatura(this)\" " +
      "style='cursor:pointer;' " +
      "data-extrato-fatura='" + (f.extrato || "") + "' " +
      "data-inicio-fatura='" + (f.dataInicioIso || "") + "' " +
      "data-fim-fatura='" + (f.dataFimIso || "") + "'>",

    // TD 1 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      (f.extrato || "") +
    "</td>",

    // TD 2 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      valorFmt +
    "</td>",

    // TD 3 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      variacaoTexto +
    "</td>",

    // TD 4 (SEM tooltip e SEM string quebr√°vel)
"<td style='border:2px double #000;padding:6px;text-align:center;'>" +
  "<a href='#' title='' " +
     "data-extrato=\"" + encodeURIComponent(String(f.extrato || "")) + "\" " +
     "onclick=\"return window.vektorBaixarTransacoesFaturaLink(event, this); return false;\" " +
     "style='color:#005E27;font-weight:700;text-decoration:underline;'>" +
    "Extrair dados" +
  "</a>" +
"</td>",


  "</tr>"
);

    valorAnterior = valor;
  });

  // Linha de TOTAL
  var somaFmt = somaTotal.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });

  partes.push(
  "<tr style='background:#f1f5f9;font-weight:bold;'>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'>TOTAL</td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'>" + somaFmt + "</td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'></td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'></td>", // ‚úÖ nova coluna
  "</tr>",
  "</tbody>",
  "</table>",
  "</div>"
);

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // BLOCO NOVO: coment√°rios autom√°ticos (insights) sobre as faturas
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var comentarios = [];

  // S√≥ faz sentido falar de varia√ß√£o se tiver pelo menos 2 faturas
  if (faturas.length >= 2) {
    if (maiorAumento && maiorAumento.variacao > 0) {
      var pctAlta = Math.abs(maiorAumento.variacao).toFixed(1).replace(".", ",") + "%";
      var extratoAlta = maiorAumento.faturaAtual.extrato || "uma das faturas";

      comentarios.push(
        "A fatura <b>" + extratoAlta +
        "</b> teve o ‚¨ÜÔ∏è <b>maior aumento</b> em rela√ß√£o ao ciclo anterior, em torno de <b>" +
        pctAlta + "</b>."
      );
    }

    if (maiorQueda && maiorQueda.variacao < 0) {
      var pctQueda = Math.abs(maiorQueda.variacao).toFixed(1).replace(".", ",") + "%";
      var extratoQueda = maiorQueda.faturaAtual.extrato || "uma das faturas";

      comentarios.push(
        "A fatura <b>" + extratoQueda +
        "</b> teve a ‚¨áÔ∏è <b>maior redu√ß√£o</b> em rela√ß√£o ao ciclo anterior, cerca de <b>" +
        pctQueda + "</b>."
      );
    }
  }

  if (comentarios.length) {
    partes.push(
      "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
             "background:#F8FAFC;border-radius:4px;padding:6px;" +
             "border:1px solid #E2E8F0;'>",
        "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre as faturas:</b></p>",
        "<ul style='margin:0;padding-left:16px;'>",
          comentarios.map(function (c) {
            return "<li>" + c + "</li>";
          }).join(""),
        "</ul>",
      "</div>"
    );
  }

  // Bot√£o de Exportar CSV (j√° existia)
  partes.push(
    "<div style='margin-top:8px;text-align:right;'>",
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'faturas_clara')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>",
        "‚¨á Exportar CSV",
      "</button>",
    "</div>",

    "</div>"
  );

  return partes.join("");
}

// ===================================================================
// T√ìPICO 3 ‚Äì Insights autom√°ticos: TIMES
// ===================================================================
function vektorGerarInsightsTimes(times) {
  if (!Array.isArray(times) || !times.length) return "";

  // Espera itens do tipo: { time: "√Åguias do Cerrado", valorTotal: 1234.56, total: 10 }
  // Se os nomes de campos forem outros, ajuste aqui.
  var lista = times
    .map(function (t) {
      return {
        nome: t.time || t.grupo || t.nome || "Time sem nome",
        valor: Number(t.valorTotal || t.valor || 0),
        qtd: Number(t.total || t.qtd || 0)
      };
    })
    .filter(function (t) {
      return t.valor > 0 || t.qtd > 0;
    });

  if (!lista.length) return "";

  var totalGeral = 0;
  lista.forEach(function (t) {
    totalGeral += t.valor;
  });
  if (!totalGeral) return "";

  // Ordena por valor desc
  lista.sort(function (a, b) {
    return b.valor - a.valor;
  });

  var top1 = lista[0];
  var top2 = lista[1] || null;
  var top3 = lista[2] || null;

  var comentarios = [];

  // Coment√°rio 1: campe√£o de gastos
  var percTop1 = (top1.valor / totalGeral) * 100;
  comentarios.push(
    "O time <b>" + top1.nome +
    "</b> √© o que mais gastou no per√≠odo, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total."
  );

  // Coment√°rio 2: concentra√ß√£o alta
  if (percTop1 >= 40) {
    comentarios.push(
      "H√° uma <b>forte concentra√ß√£o</b> de gastos no time <b>" +
      top1.nome +
      "</b>. Vale avaliar se esse padr√£o faz sentido para o momento da opera√ß√£o."
    );
  }

  // Coment√°rio 3: top 3
  if (top2 || top3) {
    var nomesTop = [top1.nome];
    if (top2) nomesTop.push(top2.nome);
    if (top3) nomesTop.push(top3.nome);

    comentarios.push(
      "Os principais respons√°veis pelo volume de gastos s√£o: <b>" +
      nomesTop.join("</b>, <b>") +
      "</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre os times:</b></p>" +
      "<ul id='insights-times-ul' style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// T√ìPICO 3 ‚Äì Insights autom√°ticos: LOJAS
// ===================================================================
function vektorGerarInsightsRankingLojas(lojas) {
  if (!Array.isArray(lojas) || !lojas.length) return "";

  // Espera itens do tipo: { loja: "123 - SHOPPING X", valorTotal: 1234.56, total: 10 }
  // Ajuste os nomes dos campos se necess√°rio.
  var lista = lojas
    .map(function (l) {
      return {
        nome: l.loja || l.nome || l.codigo || "Loja sem nome",
        valor: Number(l.valorTotal || l.valor || 0),
        qtd: Number(l.total || l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 || l.qtd > 0;
    });

  if (!lista.length) return "";

  var totalGeral = 0;
  lista.forEach(function (l) {
    totalGeral += l.valor;
  });
  if (!totalGeral) return "";

  // Ordena por valor desc
  lista.sort(function (a, b) {
    return b.valor - a.valor;
  });

  var top1 = lista[0];
  var top2 = lista[1] || null;
  var top3 = lista[2] || null;

  var comentarios = [];

  // Coment√°rio 1: campe√£
  var percTop1 = (top1.valor / totalGeral) * 100;
  comentarios.push(
    "A loja <b>" + top1.nome +
    "</b> concentra o maior volume de gastos no per√≠odo, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total."
  );

  // Coment√°rio 2: concentra√ß√£o alta
  if (percTop1 >= 35) {
    comentarios.push(
      "O n√≠vel de concentra√ß√£o em <b>" + top1.nome +
      "</b> √© elevado. Pode valer a pena revisitar as despesas dessa unidade com mais aten√ß√£o."
    );
  }

  // Coment√°rio 3: top 3 lojas
  if (top2 || top3) {
    var nomesTop = [top1.nome];
    if (top2) nomesTop.push(top2.nome);
    if (top3) nomesTop.push(top3.nome);

    comentarios.push(
      "As lojas que mais impactam o resultado desse per√≠odo s√£o: <b>" +
      nomesTop.join("</b>, <b>") +
      "</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre as lojas:</b></p>" +
      "<ul id='insights-lojas-ul' style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// T√ìPICO 4 ‚Äì Insights autom√°ticos: CATEGORIAS (ticket m√©dio)
// ===================================================================
function vektorGerarInsightsResumoCategorias(itens) {
  if (!Array.isArray(itens) || !itens.length) return "";

  // filtra s√≥ quem tem valor e quantidade
  var lista = itens
    .map(function (l) {
      return {
        nome: l.nome || "Categoria sem nome",
        valor: Number(l.valor || 0),
        qtd: Number(l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 && l.qtd > 0;
    });

  if (lista.length < 2) return "";

  // calcula ticket m√©dio
  lista.forEach(function (l) {
    l.media = l.valor / l.qtd;
  });

  // ordena por m√©dia (maior -> menor)
  lista.sort(function (a, b) {
    return b.media - a.media;
  });

  var top = lista[0];
  var bottom = lista[lista.length - 1];

  var comentarios = [];

  comentarios.push(
    "A categoria com <b>maior ticket m√©dio</b> (valor m√©dio por transa√ß√£o) √© <b>" +
      top.nome +
      "</b>, com cerca de <b>" +
      top.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  comentarios.push(
    "A categoria com <b>menor ticket m√©dio</b> √© <b>" +
      bottom.nome +
      "</b>, com cerca de <b>" +
      bottom.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
      "background:#F8FAFC;border-radius:4px;padding:6px;" +
      "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre as categorias:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// T√ìPICO 5 ‚Äì Insights autom√°ticos: ESTABELECIMENTOS (ticket m√©dio)
// ===================================================================
function vektorGerarInsightsResumoEstabelecimentos(itens) {
  if (!Array.isArray(itens) || !itens.length) return "";

  var lista = itens
    .map(function (l) {
      return {
        nome: l.nome || "Estabelecimento sem nome",
        valor: Number(l.valor || 0),
        qtd: Number(l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 && l.qtd > 0;
    });

  if (lista.length < 2) return "";

  lista.forEach(function (l) {
    l.media = l.valor / l.qtd;
  });

  lista.sort(function (a, b) {
    return b.media - a.media;
  });

  var top = lista[0];
  var bottom = lista[lista.length - 1];

  var comentarios = [];

  comentarios.push(
    "O estabelecimento com <b>maior ticket m√©dio</b> √© <b>" +
      top.nome +
      "</b>, com cerca de <b>" +
      top.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  comentarios.push(
    "O estabelecimento com <b>menor ticket m√©dio</b> √© <b>" +
      bottom.nome +
      "</b>, com cerca de <b>" +
      bottom.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transa√ß√£o."
  );

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
      "background:#F8FAFC;border-radius:4px;padding:6px;" +
      "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre os estabelecimentos:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

function vektorGerarInsightsPendenciasLojas(linhas) {
  if (!Array.isArray(linhas) || !linhas.length) return "";

  // mapeia s√≥ o que precisamos
  var lista = linhas
    .map(function (l) {
      return {
        nome: l.loja || l.nome || "Loja sem nome",
        valorPend: Number(l.valorPendente || 0),
        perc: Number(l.percPendente || 0),
        qtd: Number(l.totalPendencias || 0)
      };
    })
    .filter(function (x) {
      return x.valorPend > 0 || x.qtd > 0;
    });

  if (!lista.length) return "";

  // ordena por valor pendente
  lista.sort(function (a, b) {
    if (b.valorPend !== a.valorPend) return b.valorPend - a.valorPend;
    return b.qtd - a.qtd;
  });

  var totalPend = lista.reduce(function (acc, x) {
    return acc + x.valorPend;
  }, 0);

  var top1 = lista[0];
  var top2 = lista[1] || null;

  var comentarios = [];

  // Loja campe√£ de pend√™ncias
  var percTop1 = totalPend > 0 ? (top1.valorPend / totalPend) * 100 : 0;
  comentarios.push(
    "A loja <b>" + top1.nome +
    "</b> concentra o maior volume de <b>valor pendente</b>, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total em pend√™ncias."
  );

  // Segunda loja (se existir)
  if (top2) {
    var percTop2 = totalPend > 0 ? (top2.valorPend / totalPend) * 100 : 0;
    comentarios.push(
      "Em seguida vem a loja <b>" + top2.nome +
      "</b>, com aproximadamente <b>" +
      percTop2.toFixed(1).replace(".", ",") +
      "%</b> do valor total pendente."
    );
  }

  // Loja com maior % de pend√™ncia sobre o pr√≥prio volume
  var listaComPerc = lista
    .filter(function (x) { return x.perc > 0; })
    .slice()
    .sort(function (a, b) {
      return b.perc - a.perc;
    });

  if (listaComPerc.length) {
    var campeaPerc = listaComPerc[0];
    comentarios.push(
      "A loja <b>" + campeaPerc.nome +
      "</b> apresenta a maior propor√ß√£o de valor pendente em rela√ß√£o ao que transacionou no per√≠odo (" +
      campeaPerc.perc.toFixed(1).replace(".", ",") + "%)."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre pend√™ncias por loja:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// Drilldown: ao clicar numa fatura, detalha por TIME
window.vektorDrillTimesFatura = function (tr) {
  try {
    if (!tr) return;

    var extrato = tr.getAttribute("data-extrato-fatura") || "";
    var dataInicioIso = tr.getAttribute("data-inicio-fatura") || "";
    var dataFimIso = tr.getAttribute("data-fim-fatura") || "";

    extrato = extrato.trim();

    if (!extrato) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o extrato dessa fatura para detalhar por time.</p>"
      );
      return;
    }

    var periodoTexto = "";
    if (dataInicioIso || dataFimIso) {
      var ini = dataInicioIso ? new Date(dataInicioIso).toLocaleDateString("pt-BR") : "";
      var fim = dataFimIso ? new Date(dataFimIso).toLocaleDateString("pt-BR") : "";
      if (ini || fim) {
        periodoTexto = "Per√≠odo: " + ini + (fim ? " at√© " + fim : "");
      }
    }

    // Mensagem de contexto no chat
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a fatura <b>" + extrato +
        "</b> por <b>time</b>, considerando o mesmo ciclo do 'Extrato da conta'." +
        (periodoTexto ? "<br><span class='text-xs text-slate-500'>" + periodoTexto + "</span>" : "") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.times) || !res.times.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes por time para essa fatura.</p>"
          );
          return;
        }

        // Reaproveita o renderizador padr√£o de resumo por time
        renderResumoTransacoesPorTime(res, {
          titulo: "Times dessa fatura",
          periodoTexto: periodoTexto
        });
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao detalhar fatura por time:", err);

              vektorRegistrarContexto({
                  ultimaIntencao: "fatura_times",
                  ultimoPeriodo: {
                    dataInicioIso: dataInicioIso || "",
                    dataFimIso: dataFimIso || ""
                  },
                  ultimaLoja: null,
                  ultimaAcaoExplicavel: {
                    tipo: "tabela_times_fatura",
                    meta: {
                      extrato: extrato,
                      periodoTexto: periodoTexto
                    }
                  }
                });

        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao buscar o detalhamento por time para essa fatura.</p>"
        );
      })
      .getResumoTransacoesPorTimeExtrato(extrato, "valor");  // usa EXTRATO
  } catch (e) {
    console.error("Erro em vektorDrillTimesFatura:", e);
  }
};

window.vektorBaixarTransacoesFaturaLink = function (ev, el) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation(); // ‚úÖ impede disparar o onclick do <tr>
    }

    var extratoEnc = (el && el.getAttribute("data-extrato")) || "";
    var extrato = decodeURIComponent(extratoEnc || "");

    return window.vektorBaixarTransacoesFatura(ev, extrato);
  } catch (e) {
    console.error("Erro em vektorBaixarTransacoesFaturaLink:", e);
    return false;
  }
};

// ===============================
// DOWNLOAD ‚Äî LOJAS COM PEND√äNCIAS (ciclo atual) ‚Äî BaseClara FULL
// ===============================
window.vektorBaixarLojasComPendenciasCicloAtual = function (ev) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Gerando Excel apenas das <b>lojas com pend√™ncias</b> no ciclo atual, aguarde um momento.</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !res.xlsxBase64) {
          var msg = (res && res.error) ? res.error : "N√£o consegui gerar o Excel agora.";
          renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao exportar:</b> " + msg + "</p>");
          console.error("Resposta export XLSX (pend√™ncias ciclo):", res);
          return;
        }

        // base64 -> bytes
        var b64 = res.xlsxBase64;
        var byteChars = atob(b64);
        var byteNumbers = new Array(byteChars.length);
        for (var i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        var byteArray = new Uint8Array(byteNumbers);

        var blob = new Blob([byteArray], {
          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download = res.filename || "vektor_lojas_pendencias_ciclo_atual.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao exportar XLSX (pend√™ncias ciclo):", err);
        var msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>Erro ao gerar o Excel: " + msg + "</p>");
      })
      .exportarLojasComPendenciasCicloAtualXlsx(); // ‚úÖ NOVA fun√ß√£o no Code.gs
    return false;
  } catch (e) {
    console.error("Erro em vektorBaixarLojasComPendenciasCicloAtual:", e);
    return false;
  }
};

// ===============================
// E-MAIL ‚Äî LOJAS COM PEND√äNCIAS (ciclo atual) ‚Äî anexo XLSX
// ===============================
window.vektorEnviarLojasComPendenciasCicloAtualEmail = function (ev) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Enviando a listagem de <b>lojas com pend√™ncias</b> do ciclo atual para o seu e-mail, aguarde um momento.</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          var msg = (res && res.error) ? res.error : "N√£o consegui enviar o e-mail agora.";
          renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao enviar e-mail:</b> " + msg + "</p>");
          console.error("Resposta enviar e-mail (pend√™ncias ciclo):", res);
          return;
        }

        var to = (res && res.to) ? res.to : "seu e-mail";
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'><b>Pronto.</b> Enviei a listagem por e-mail para <b>" + to + "</b>.</p>"
        );
      })
      .withFailureHandler(function (err) {
        var msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'><b>Falha ao enviar e-mail:</b> " + msg + "</p>"
        );
      })
      .enviarLojasComPendenciasCicloAtualEmail(); // Code.gs
  } catch (e) {
    console.error("Erro em vektorEnviarLojasComPendenciasCicloAtualEmail:", e);
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao enviar e-mail agora.</p>");
  }
};

window.vektorBaixarTransacoesFatura = function (ev, extrato) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation(); // ‚úÖ evita disparar o drilldown da <tr>
    }

    extrato = (extrato || "").toString().trim();
    if (!extrato) {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o extrato para exportar.</p>");
      return false;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Gerando arquivo em excel da fatura <b>" + extrato + " "
    );

    google.script.run
      .withSuccessHandler(function (res) {
                if (!res || !res.ok || !res.xlsxBase64) {
                var msg = (res && res.error) ? res.error : "N√£o consegui gerar o Excel dessa fatura.";
                renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao exportar:</b> " + msg + "</p>");
                console.error("Resposta export XLSX:", res);
                return;
              }

        // base64 -> bytes
        var b64 = res.xlsxBase64;
        var byteChars = atob(b64);
        var byteNumbers = new Array(byteChars.length);
        for (var i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        var byteArray = new Uint8Array(byteNumbers);

        var blob = new Blob([byteArray], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download = res.filename || "transacoes_fatura.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao gerar CSV da fatura:", err);
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>Erro ao gerar o CSV dessa fatura.</p>");
      })
      .exportarTransacoesFaturaXlsx(extrato);

    return false;
  } catch (e) {
    console.error("Erro em vektorBaixarTransacoesFatura:", e);
    return false;
  }
};


/**
 * Filtra a lista completa de faturas segundo o modo de pergunta.
 * modo: "atual" | "anterior" | "ultimas" | "todas"
 * qtd: n√∫mero de faturas (quando modo = "ultimas")
 */

function vektorFiltrarFaturasPeloModo_(todas, modo, qtd) {
    if (!Array.isArray(todas) || !todas.length) return [];

        // üîß Ajuste de seguran√ßa:
    // Se o modo veio como "atual" mas temos uma quantidade maior que 1,
    // significa que em algum ponto a interpreta√ß√£o falhou.
    // Nesse caso, tratamos como "√∫ltimas N faturas".
    if (modo === "atual" && typeof qtd === "number" && qtd > 1) {
        modo = "ultimas";
    }

    // ---------------------------------------------------------
    // Fun√ß√£o para converter "06 Nov 2025" ‚Üí Date real
    // ---------------------------------------------------------
    function parseDataExt(dstr) {
        if (!dstr || typeof dstr !== "string") return null;
        // ex.: "06 Nov 2025"
        var m = dstr.trim().split(/\s+/);  // ["06","Nov","2025"]
        if (m.length !== 3) return null;

        var dia = Number(m[0]);
        var mes = m[1].toLowerCase();
        var ano = Number(m[2]);

        var mapaMes = {
            jan:0, feb:1, mar:2, apr:3, apr:3, mai:4, jun:5,
            jul:6, aug:7, set:8, sep:8, oct:9, out:9, nov:10, dec:11, dez:11
        };

        var mm = mapaMes[mes.substring(0,3)];
        if (mm === undefined) return null;

        return new Date(ano, mm, dia);
    }

    // ---------------------------------------------------------
    // Ordenar faturas REALMENTE por data de in√≠cio
    // ---------------------------------------------------------
    var lista = todas.slice().sort(function (a, b) {
        var da = parseDataExt(a.dataInicio);
        var db = parseDataExt(b.dataInicio);
        if (!da || !db) return 0;
        return da - db;
    });

    var agora = new Date();

    // ---------------------------------------------------------
    // Identificar fatura "atual"
    // ---------------------------------------------------------
    var idxAtual = -1;
    for (var i = 0; i < lista.length; i++) {
        var ini = parseDataExt(lista[i].dataInicio);
        var fim = parseDataExt(lista[i].dataFim);
        if (ini && fim && ini <= agora && agora <= fim) {
            idxAtual = i;
            break;
        }
    }

    // fallback
    if (idxAtual === -1) idxAtual = lista.length - 1;

    // ---------------------------------------------------------
    // Modos
    // ---------------------------------------------------------
    if (modo === "todas") {
        return lista;
    }

    if (modo === "ultimas") {
        var n = Number(qtd) || 2;
        if (n >= lista.length) return lista;
        return lista.slice(lista.length - n);
    }

    if (modo === "anterior") {
        if (idxAtual > 0) {
            return [lista[idxAtual - 1]];
        } else {
            return [lista[idxAtual]];
        }
    }

    // padr√£o ‚Üí atual
    return [lista[idxAtual]];
}

function vektorDiasAteFechamentoFaturaAtual() {
  const hoje = new Date();
  const dia = hoje.getDate();

  // fechamento sempre no dia 5
  let ano = hoje.getFullYear();
  let mes = hoje.getMonth(); // 0 = janeiro

  // Se j√° passou do dia 5, o pr√≥ximo fechamento √© no m√™s seguinte
  if (dia > 5) {
    mes += 1;
    if (mes > 11) {
      mes = 0;
      ano += 1;
    }
  }

  const fechamento = new Date(ano, mes, 5);

  const diffMs = fechamento.getTime() - hoje.getTime();
  const dias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  return Math.max(dias, 0); // n√£o deixa negativo
}


function vektorChamarPendJustLojas_(tipo) {
    var periodo  = window.__vektorUltimoPeriodoIso || {};
    var grupo    = window.__vektorUltimoGrupoBaseClara || "";
    var lojas    = window.__vektorUltimasLojasTabela || [];

    var ini = periodo.inicio || "";
    var fim = periodo.fim    || "";

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar as " +
            "pend√™ncias/justificativas na planilha BaseClara.</p>"
          );

          // üÜï Mesmo com erro ‚Üí troca spinner por check
          try {
            var statusId = (tipo === "pendencias")
              ? "vektor-status-pendencias"
              : "vektor-status-justificativas";

            var statusEl = document.getElementById(statusId);
            if (statusEl) {
              statusEl.innerHTML =
                "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
            }
          } catch (e) {}

          return;
        }

        var colunas = res.colunas || [];
        var html = "";

        if (tipo === "pendencias") {
          html = vektorMontarTabelaPendJust_(
            "PEND√äNCIAS DE JUSTIFICATIVAS POR LOJA",
            colunas,
            res.pendencias || []
          );
        } else {
          html = vektorMontarTabelaPendJust_(
            "TRANSA√á√ïES COM JUSTIFICATIVA COMPLETA POR LOJA",
            colunas,
            res.justificadas || []
          );
        }

        // Envia tabela
        renderBotMessage("HTML:" + html);

        // üÜï Troca spinner por check (caso de sucesso)
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
          }
        } catch (e) {}

      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as " +
          "pend√™ncias/justificativas na planilha.</p>"
        );

        // üÜï Mesmo no erro ‚Üí spinner vira check
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
          }
        } catch (e) {}

      })
      .getPendenciasEJustificativasPorLojas(
        grupo,
        ini,
        fim,
        lojas
      );
}

// ‚ö† Bot√£o "Verificar pend√™ncias"
window.vektorVerificarPendenciasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-pendencias' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando pend√™ncias das lojas dessa tabela no per√≠odo informado...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('pendencias');
};

// ‚úî Bot√£o "Verificar justificativas"
window.vektorVerificarJustificativasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-justificativas' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando transa√ß√µes com justificativas feitas de forma correta...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('justificativas');
};

// Bot√£o gen√©rico para expandir a tabela de pend√™ncias consolidadas
window.vektorDrilldownPendenciasDetalhadas = function () {
  try {
    vektorChamarPendJustLojas_('pendencias');
  } catch (e) {
    console.warn("Erro ao abrir drilldown de pend√™ncias:", e);
  }
};




// RESUMO POR TIME INICIO //

function renderResumoTransacoesPorTime(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar informa√ß√µes por <b>time</b> para esse per√≠odo.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto base do crit√©rio (valor x quantidade)
  var criterioTxt = (resumo.criterio === "valor")
    ? "maior <b>valor total</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes";

  // Lista completa de times vinda do back-end
  var all = Array.isArray(resumo.times) ? resumo.times : [];

  // H√° filtro expl√≠cito de times na pergunta? (ex.: "times X e Y")
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  // üîé Filtro opcional por lista de times (nomes)
if (temFiltroTimes) {
  var alvoNorms = opts.filtrarTimesNomes.map(function (n) {
    return normalize(String(n));
  });

  all = all.filter(function (t) {
    var nomeNorm = normalize(String(t.time || ""));

    // Mant√©m o time se QUALQUER alvo ‚Äúbater‚Äù como parte do nome
    return alvoNorms.some(function (alvo) {
      return (
        nomeNorm.indexOf(alvo) >= 0 ||   // ex.: "furacao sul csc" cont√©m "furacao sul"
        alvo.indexOf(nomeNorm) >= 0      // ou o contr√°rio, se o alvo for mais longo
      );
    });
  });
}

  // Quantas linhas exibir (para time: sem top => TODOS)
  var linhas = (typeof opts.topN === "number") ? all.slice(0, opts.topN) : all;

  // Somat√≥rios com base no que ser√° exibido
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // ===== Recalcula o "top time" somente com base nas linhas filtradas =====
  var campoCriterio = (resumo.criterio === "quantidade") ? "total" : "valorTotal";
  var topItem = null;
  var topValor = -Infinity;

  for (var j = 0; j < linhas.length; j++) {
    var item = linhas[j];
    var v = Number(item[campoCriterio]) || 0;
    if (v > topValor) {
      topValor = v;
      topItem = item;
    }
  }

  // Monta a fraseResumo usando APENAS os times considerados na tabela
  var fraseResumo;
  if (!linhas.length || !topItem || topValor <= 0) {
    fraseResumo = temFiltroTimes
      ? "N√£o encontrei transa√ß√µes para os times informados no per√≠odo selecionado."
      : "N√£o encontrei transa√ß√µes no per√≠odo selecionado.";
  } else if (temFiltroTimes) {
    fraseResumo =
      "Entre os times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b>, o <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no per√≠odo selecionado.";
  } else {
    // Comportamento padr√£o quando n√£o h√° filtro de times (ranking geral)
    fraseResumo =
      "O <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no per√≠odo selecionado.";
  }

  // ===== Montagem da tabela (mesmo padr√£o visual das outras) =====
  var linhasTabela = [];
  if (linhas.length) {

    // üîΩ Dropdown de drilldown para a tabela de TIMES
    linhasTabela.push(
      "<div style='margin-top:8px;margin-bottom:10px;font-size:12px;margin-bottom:4px;color:#334155;display:flex;align-items:center;gap:6px;'>" +
        "<span>Expandir a tabela por:</span>" +
        "<select class='vektor-drill-select' data-base='time' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='loja'>Lojas</option>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    // Tabela no padr√£o azul / borda igual √†s demais
    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Time</th>" +
        "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    // Linhas de times
    for (var k = 0; k < linhas.length; k++) {
      var t = linhas[k];
      var qtd = Number(t.total) || 0;
      var val = Number(t.valorTotal) || 0;

      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

      var hint =
        "Clique para detalhar este time pela dimens√£o selecionada (lojas, categorias ou estabelecimentos), " +
        "respeitando o mesmo per√≠odo da pergunta inicial.";

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this, 'time')\" " +
            "style='cursor:pointer;' " +
            "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + (t.time || "") + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

    // üÜï Insights autom√°ticos sobre os times (T√ìPICO 3)
  var insightsTimesHtml = vektorGerarInsightsTimes(linhas || []);


  // üîΩ Bot√£o de exporta√ß√£o em CSV para o resumo por TIME
  var botaoCsv = "";
  if (tabelaHtml) {
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_times')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  // Mantendo o lookerUrl como no seu c√≥digo original (se quiser usar depois)
  var lookerUrl = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      //"<p style='font-size:13px;color:#555;margin:4px 0 8px;'>Clique em uma linha para detalhar (drill-down) no chat.</p>",
      tabelaHtml,
      insightsTimesHtml || "",
      botaoCsv,
    "</div>"
  ].join("");

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaPendenciasPorLoja(resumo, dataInicioIso, dataFimIso) {
  var linhas = (resumo && resumo.linhas) || [];
  var totais = (resumo && resumo.totais) || {};
  var grupo  = resumo && (resumo.grupoOriginal || resumo.grupo) || "";

  // Guarda contexto para o drilldown
  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioIso || "",
    fim:    dataFimIso    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupo || "";
  window.__vektorUltimasLojasTabela = linhas.map(function (l) {
    return (l.loja || "").toString();
  });

  var linhasHtml = [];

    // Frase principal
  var fraseResumo = "Tabela consolidada de pend√™ncias por loja" +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    ".";
  linhasHtml.push("<p>" + fraseResumo + "</p>");

  // Garante per√≠odo: usa par√¢metros se existirem,
  // sen√£o usa o que estiver salvo no contexto global.
  var iniIso = dataInicioIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio) ||
    "";
  var fimIso = dataFimIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.fim) ||
    "";

  var frasePeriodo = vektorFraseResumoPeriodo(iniIso, fimIso);
  if (frasePeriodo) {
    linhasHtml.push(
      "<p style='margin-top:2px;font-size:11px;color:#475569;'>" +
      frasePeriodo +
      "</p>"
    );
  }

  // linha em branco
  linhasHtml.push("<div style='height:8px;'></div>");

  // Bot√£o centralizado de drilldown (usa fluxo padr√£o de pend√™ncias)
  linhasHtml.push(
    "<div style='text-align:center;margin-bottom:8px;'>" +
      "<button type='button' " +
        "onclick=\"vektorVerificarPendenciasLojas()\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;" +
               "border-radius:4px;font-size:12px;cursor:pointer;'>" +
        "üîç Ver detalhamento das transa√ß√µes pendentes" +
      "</button>" +
    "</div>"
  );

  // Espa√ßo entre bot√£o e tabela
  linhasHtml.push("<div style='height:8px;'></div>");

  // Tabela
  linhasHtml.push("<div style='overflow-x:auto;'>");
  linhasHtml.push("<table style='border-collapse:collapse;width:100%;font-size:12px;'>");

  linhasHtml.push(
    "<thead><tr>" +
      // 4 primeiras colunas: verde claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Loja</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Qtd Transa√ß√µes Pendentes</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Valor Total Pendente (R$)</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>% do Valor Pendente</th>" +
      // 3 colunas de tipo de pend√™ncia: vermelho claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Etiqueta</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Descri√ß√£o</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Nota fiscal/Recibo</th>" +
    "</tr></thead><tbody>"
  );

  var totalValPend = 0;
  var totalValTrans = 0;

  linhas.forEach(function (l) {
    var loja          = l.loja || "";
    var qtdPend       = Number(l.totalPendencias || 0);
    var valorPend     = Number(l.valorPendente || 0);
    var percPend      = Number(l.percPendente || 0);
    var pendEtiq      = Number(l.pendEtiqueta || 0);
    var pendDesc      = Number(l.pendDescricao || 0);
    var pendRec       = Number(l.pendRecibo || 0);

    totalValPend  += valorPend;
    totalValTrans += Number(l.valorTransacionado || 0);

    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + loja + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + qtdPend + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          valorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          (percPend > 0 ? percPend.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendEtiq + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendDesc + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendRec + "</td>" +
      "</tr>"
    );
  });

  var totQtdPend   = Number(totais.totalPendencias || 0);
  var totValorPend = Number(totais.valorPendente || 0);
  var totEtiq      = Number(totais.pendEtiqueta || 0);
  var totDesc      = Number(totais.pendDescricao || 0);
  var totRec       = Number(totais.pendRecibo || 0);
  var totValTrans  = Number(totais.valorTransacionado || 0);

  var percGeral = 0;
  if (totValTrans > 0 && totValorPend > 0) {
    percGeral = (totValorPend / totValTrans) * 100;
  }

  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totQtdPend + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        totValorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        (percGeral > 0 ? percGeral.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totEtiq + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totDesc + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totRec + "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  var tabelaHtml = linhasHtml.join("");
  var insightsHtml = vektorGerarInsightsPendenciasLojas(linhas);

  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'pendencias_por_loja')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      tabelaHtml +
      (insightsHtml || "") +
      botoesHtml +
    "</div>";

  return html;
}

// Chamada ao Apps Script
function vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso) {
  // Se n√£o veio per√≠odo expl√≠cito, usamos √∫ltimos 30 dias
  var inicio = dataInicioIso;
  var fim = dataFimIso;

  if (!inicio || !fim) {
    var hoje = new Date();
    var fimDate = hoje;
    var iniDate = new Date();
    iniDate.setDate(hoje.getDate() - 30);

    inicio = iniDate.toISOString();
    fim = fimDate.toISOString();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou montar a tabela de <b>pend√™ncias por loja</b> do time <b>" +
    (grupo || "") + "</b> no per√≠odo informado...</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.ok) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consolidar as pend√™ncias por loja na BaseClara.</p>"
        );
        return;
      }

      var htmlTabela = vektorRenderTabelaPendenciasPorLoja(res, inicio, fim);
      renderBotMessage("HTML:" + htmlTabela);
    })
    .withFailureHandler(function (err) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as pend√™ncias por loja na BaseClara.</p>"
      );
      console.error(err);
    })
    .getResumoPendenciasPorLoja(
      grupo || "",
      inicio || "",
      fim || ""
    );
}

function vektorGerarInsightsPendenciasTimes(linhas) {
  if (!Array.isArray(linhas) || !linhas.length) return "";

  var lista = linhas
    .map(function (t) {
      return {
        nome: t.time || t.grupo || "Time sem nome",
        valorPend: Number(t.valorPendente || 0),
        perc: Number(t.percPendente || 0),
        qtd: Number(t.totalPendencias || 0)
      };
    })
    .filter(function (x) {
      return x.valorPend > 0 || x.qtd > 0;
    });

  if (!lista.length) return "";

  lista.sort(function (a, b) {
    if (b.valorPend !== a.valorPend) return b.valorPend - a.valorPend;
    return b.qtd - a.qtd;
  });

  var totalPend = lista.reduce(function (acc, x) { return acc + x.valorPend; }, 0);

  var top1 = lista[0];
  var top2 = lista[1] || null;

  var comentarios = [];

  var percTop1 = totalPend > 0 ? (top1.valorPend / totalPend) * 100 : 0;
  comentarios.push(
    "O time <b>" + top1.nome +
    "</b> concentra o maior valor em pend√™ncias, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total pendente."
  );

  if (top2) {
    var percTop2 = totalPend > 0 ? (top2.valorPend / totalPend) * 100 : 0;
    comentarios.push(
      "Na sequ√™ncia, o time <b>" + top2.nome +
      "</b> responde por aproximadamente <b>" +
      percTop2.toFixed(1).replace(".", ",") +
      "%</b> do valor pendente."
    );
  }

  var listaComPerc = lista
    .filter(function (x) { return x.perc > 0; })
    .slice()
    .sort(function (a, b) { return b.perc - a.perc; });

  if (listaComPerc.length) {
    var campeaoPerc = listaComPerc[0];
    comentarios.push(
      "O time <b>" + campeaoPerc.nome +
      "</b> tem a maior propor√ß√£o de valor pendente sobre o que transacionou no per√≠odo<b> (" +
      campeaoPerc.perc.toFixed(1).replace(".", ",") + "%)</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights autom√°ticos sobre pend√™ncias por time:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) { return "<li>" + c + "</li>"; }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

function vektorRenderTabelaPendenciasPorTime(resumo, dataInicioIso, dataFimIso) {
  var linhas = (resumo && resumo.linhas) || [];
  var totais = (resumo && resumo.totais) || {};

  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioIso || "",
    fim:    dataFimIso    || ""
  };
  window.__vektorUltimoGrupoBaseClara = "";
  window.__vektorUltimasLojasTabela = [];

  var linhasHtml = [];

  // Frase principal
  linhasHtml.push("<p>Tabela consolidada de pend√™ncias por time.</p>");

  // Per√≠odo: par√¢metros (se existirem) OU contexto global
  var iniIso = dataInicioIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio) ||
    "";
  var fimIso = dataFimIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.fim) ||
    "";

  var frasePeriodo = vektorFraseResumoPeriodo(iniIso, fimIso);
  if (frasePeriodo) {
    linhasHtml.push(
      "<p style='margin-top:2px;font-size:11px;color:#475569;'>" +
      frasePeriodo +
      "</p>"
    );
  }

  linhasHtml.push("<div style='height:8px;'></div>");

  // Bot√£o de drilldown (usa fluxo padr√£o de pend√™ncias)
  linhasHtml.push(
    "<div style='text-align:center;margin-bottom:8px;'>" +
      "<button type='button' " +
        "onclick=\"vektorVerificarPendenciasLojas()\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;" +
               "border-radius:4px;font-size:12px;cursor:pointer;'>" +
        "üîç Ver detalhamento das transa√ß√µes pendentes" +
      "</button>" +
    "</div>"
  );

  linhasHtml.push("<div style='height:8px;'></div>");

  linhasHtml.push("<div style='overflow-x:auto;'>");
  linhasHtml.push("<table style='border-collapse:collapse;width:100%;font-size:12px;'>");

  linhasHtml.push(
    "<thead><tr>" +
      // colunas "gerais" em verde
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Time</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Qtd Transa√ß√µes Pendentes</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Valor Total Pendente (R$)</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>% do Valor Pendente</th>" +
      // colunas de tipos em vermelho claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Etiqueta</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Descri√ß√£o</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pend√™ncias: Nota fiscal/Recibo</th>" +
    "</tr></thead><tbody>"
  );

  linhas.forEach(function (t) {
    var nome         = t.time || t.grupo || "";
    var qtdPend      = Number(t.totalPendencias || 0);
    var valorPend    = Number(t.valorPendente || 0);
    var percPend     = Number(t.percPendente || 0);
    var pendEtiq     = Number(t.pendEtiqueta || 0);
    var pendDesc     = Number(t.pendDescricao || 0);
    var pendRec      = Number(t.pendRecibo || 0);

    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + nome + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + qtdPend + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          valorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          (percPend > 0 ? percPend.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendEtiq + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendDesc + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendRec + "</td>" +
      "</tr>"
    );
  });

  var totQtdPend   = Number(totais.totalPendencias || 0);
  var totValorPend = Number(totais.valorPendente || 0);
  var totEtiq      = Number(totais.pendEtiqueta || 0);
  var totDesc      = Number(totais.pendDescricao || 0);
  var totRec       = Number(totais.pendRecibo || 0);
  var totValTrans  = Number(totais.valorTransacionado || 0);

  var percGeral = 0;
  if (totValTrans > 0 && totValorPend > 0) {
    percGeral = (totValorPend / totValTrans) * 100;
  }

  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totQtdPend + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        totValorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        (percGeral > 0 ? percGeral.toFixed(1).replace(".", ",") + "%" : "‚Äî") +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totEtiq + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totDesc + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totRec + "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  var tabelaHtml = linhasHtml.join("");
  var insightsHtml = vektorGerarInsightsPendenciasTimes(linhas);

  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'pendencias_por_time')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      tabelaHtml +
      (insightsHtml || "") +
      botoesHtml +
    "</div>";

  return html;
}

function vektorMostrarPendenciasPorTimeTodos(dataInicioIso, dataFimIso) {
  var inicio = dataInicioIso;
  var fim = dataFimIso;

  if (!inicio || !fim) {
    var hoje = new Date();
    var fimDate = hoje;
    var iniDate = new Date();
    iniDate.setDate(hoje.getDate() - 30);

    inicio = iniDate.toISOString();
    fim = fimDate.toISOString();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou montar a tabela de <b>pend√™ncias por time</b> para o per√≠odo informado...</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.ok) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consolidar as pend√™ncias por time na BaseClara.</p>"
        );
        return;
      }

      var htmlTabela = vektorRenderTabelaPendenciasPorTime(res, inicio, fim);
      renderBotMessage("HTML:" + htmlTabela);
    })
    .withFailureHandler(function (err) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as pend√™ncias por time na BaseClara.</p>"
      );
      console.error(err);
    })
    .getResumoPendenciasPorTime(
      inicio || "",
      fim || "",
      "" // todos os times
    );
}

// ===== RENDER: Maiores transa√ß√µes individuais (loja / time) =====
function renderMaioresTransacoesIndividuais(res) {
  if (!res || res.ok === false) {
    var msgErro = (res && res.error) ? res.error : "Erro desconhecido ao consultar as maiores transa√ß√µes.";
    renderBotMessage("HTML:<p class='text-sm text-red-700'>" + msgErro + "</p>");
    return;
  }

  var linhas = Array.isArray(res.linhas) ? res.linhas : [];
  var loja   = res.loja  || "";
  var grupo  = res.grupo || "";
  var topN   = res.topN  || null;

  var periodoDescricao   = res.periodoDescricao || "";
  var dataInicioIso      = res.dataInicioIso || "";
  var dataFimIso         = res.dataFimIso    || "";
  var totalSelecionadas  = Number(res.totalSelecionadas || 0);

  // Se n√£o houver linhas
  if (!linhas.length) {
    var msgVazio = "N√£o encontrei transa√ß√µes no per√≠odo selecionado ";
    if (loja)  msgVazio += "para a loja <b>" + loja + "</b> ";
    if (grupo) msgVazio += "do time <b>" + grupo + "</b> ";
    if (periodoDescricao) {
      msgVazio += "(" + periodoDescricao + ").";
    } else {
      msgVazio += ".";
    }
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + msgVazio + "</p>");
    return;
  }

  var titulo = "Maiores transa√ß√µes individuais";
  if (loja)  titulo += " - Loja " + loja;
  if (grupo) titulo += (loja ? " | " : " - ") + "Time " + grupo;
  if (topN) {
    titulo += " (Top " + topN + ")";
  }

  var linhasHtml = [];

  linhasHtml.push("<div class='text-sm text-slate-700'>");
  linhasHtml.push("<p style='margin:0 0 4px 0;'><b>" + titulo + "</b></p>");

  if (periodoDescricao) {
    linhasHtml.push(
      "<p style='margin:0 0 8px 0;font-size:12px;color:#334155;'>" +
        "Per√≠odo da consulta: " + periodoDescricao + "." +
      "</p>"
    );
  } else if (dataInicioIso && dataFimIso) {
    var frasePeriodo = vektorFraseResumoPeriodo(dataInicioIso, dataFimIso);
    if (frasePeriodo) {
      linhasHtml.push(
        "<p style='margin:0 0 8px 0;font-size:12px;color:#334155;'>" +
          "Per√≠odo da consulta: " + frasePeriodo + "." +
        "</p>"
      );
    }
  }

  // Tabela
  linhasHtml.push(
    "<table border='1' cellspacing='0' cellpadding='4' " +
      "style='border-collapse:collapse;width:100%;font-size:12px;text-align:center;border:1px solid #000;'>"
  );

  // Cabe√ßalho
  linhasHtml.push(
    "<thead>" +
      "<tr style='background:#06167d;color:#fff;'>" +
        "<th style='border:1px solid #000;padding:4px;'>Loja</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Estabelecimento</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Data</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Status</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Categoria</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Titular</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Valor (R$)</th>" +
      "</tr>" +
    "</thead><tbody>"
  );

      // Linhas da tabela
    for (var i = 0; i < linhas.length; i++) {
      var l = linhas[i] || {};
      var lojaVal     = l.loja || "";
      var estabVal    = l.estabelecimento || "";
      var dataVal     = l.data || "";
      var statusVal   = l.status || "";
      var categoriaVal= l.categoria || "";
      var titularVal  = l.titular || "";
      var valorVal    = Number(l.valor || 0);

      linhasHtml.push(
        "<tr>" +
          "<td style='border:1px solid #000;padding:4px;'>" + lojaVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + estabVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + dataVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + statusVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + categoriaVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + titularVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" +
            valorVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
        "</tr>"
      );
    }

  // Linha de TOTAL no final da coluna de valor
  linhasHtml.push(
    "<tr style='background:#e5e7eb;font-weight:bold;'>" +
      "<td colspan='6' style='border:1px solid #000;padding:4px;text-align:right;'>Total</td>" +
      "<td style='border:1px solid #000;padding:4px;'>" +
        totalSelecionadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table>");

  // Bot√£o Exportar CSV ABAIXO da tabela
  linhasHtml.push(
    "<div style='margin-top:6px;text-align:right;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'maiores_transacoes_individuais')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "‚¨á Exportar CSV" +
      "</button>" +
    "</div>"
  );

  linhasHtml.push("</div>");

  var html = linhasHtml.join("");

  try { ultimaIntencao = "maiores_transacoes_individuais"; } catch (e) {}

  renderBotMessage("HTML:" + html);
}

function vektorRenderTransacoesPorCategoria(res, nomeCategoria) {
  if (!res || !res.ok) {
    return "<p class='text-sm text-slate-700'>N√£o consegui montar a tabela de transa√ß√µes dessa categoria.</p>";
  }

  var linhas = res.linhas || [];
  var dataInicioIso = res.dataInicioIso || "";
  var dataFimIso    = res.dataFimIso || "";
  var total = Number(res.total || 0);

  // Se n√£o tiver linhas
  if (!linhas.length) {
    return (
      "<p class='text-sm text-slate-700'>" +
        "N√£o encontrei transa√ß√µes para a categoria <b>" + (nomeCategoria || "") +
        "</b> nesse per√≠odo." +
      "</p>"
    );
  }

  // Per√≠odo em dd/MM/yyyy
  var periodoHtml = "";
  try {
    if (dataInicioIso && dataFimIso) {
      var di = new Date(dataInicioIso);
      var df = new Date(dataFimIso);
      var diBr = di.toLocaleDateString("pt-BR");
      var dfBr = df.toLocaleDateString("pt-BR");
      periodoHtml =
        "<p class='text-xs text-slate-500 mt-1'>" +
          "Per√≠odo da consulta: de " + diBr + " a " + dfBr + "." +
        "</p>";
    }
  } catch (e) {
    console.error("Erro ao formatar per√≠odo em vektorRenderTransacoesPorCategoria:", e);
  }

  var linhasHtml = [];

  linhasHtml.push(
    "<p class='mb-1'>Transa√ß√µes da categoria <b>" + (nomeCategoria || "") + "</b>.</p>" +
    periodoHtml
  );

  linhasHtml.push("<div style='overflow-x:auto;margin-top:4px;'>");

  // ‚úÖ Valor (R$) movido para a √öLTIMA coluna
  linhasHtml.push(
    "<table style='border-collapse:collapse;width:100%;font-size:12px;'>" +
      "<thead><tr>" +
        "<th style='border:1px solid #000;padding:4px;text-align:center;background:#E5E7EB;'>Loja</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Transa√ß√£o</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:center;background:#E5E7EB;'>Data</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Titular</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Grupos</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Recibo</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Etiquetas</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Descri√ß√£o</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:right;background:#E5E7EB;'>Valor (R$)</th>" +
      "</tr></thead><tbody>"
  );

  for (var i = 0; i < linhas.length; i++) {
    var l = linhas[i] || {};
    var loja  = l.loja || "";
    var trans = l.transacao || "";
    var data  = l.data || "";
    var val   = Number(l.valor || 0);

    var titular   = l.titular || "";
    var grupos    = l.grupos || "";
    var recibo    = l.recibo || "";
    var etiquetas = l.etiquetas || "";
    var descricao = l.descricao || "";

    // ‚úÖ Valor movido para o √öLTIMO <td>
    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + loja + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + trans + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + data + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + titular + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + grupos + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + recibo + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + etiquetas + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + descricao + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
          val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
      "</tr>"
    );
  }

  // Linha TOTAL (colspan continua correto: 8)
  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td colspan='8' style='border:1px solid #000;padding:4px;text-align:right;'>Total</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
        total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  // Bot√£o de CSV
  linhasHtml.push(
    "<div style='margin-top:8px;display:flex;justify-content:flex-end;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'transacoes_categoria')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "‚¨á Exportar CSV" +
      "</button>" +
    "</div>"
  );

  return "<div class='text-sm text-slate-700'>" + linhasHtml.join("") + "</div>";
}

// üîΩ Drilldown da fatura para TIMES, respeitando o per√≠odo da fatura
window.vektorDetalharFaturaPorTime = function (tr) {
  try {
    if (!tr) return;

    var inicioIso = tr.getAttribute("data-inicio") || "";
    var fimIso    = tr.getAttribute("data-fim") || "";

    // Pega o texto da fatura para mostrar na mensagem
    var extrato = "";
    if (tr.cells && tr.cells.length > 0) {
      extrato = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    }

    // Se n√£o tiver per√≠odo, n√£o faz sentido puxar times
    if (!inicioIso || !fimIso) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>" +
          "N√£o consegui identificar o per√≠odo dessa fatura para detalhar por time. " +
          "Verifique se o campo <b>Extrato da conta</b> est√° no formato esperado na BaseClara." +
        "</p>"
      );
      return;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou detalhar a fatura <b>" + extrato + "</b> " +
        "por <b>time</b>, considerando apenas as transa√ß√µes desse per√≠odo." +
      "</p>"
    );

    // Chama o Apps Script para montar o resumo por time
    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "N√£o consegui montar o resumo por time para esse per√≠odo de fatura." +
            "</p>"
          );
          return;
        }

        // Reutiliza o renderizador geral de times
        // topN: null -> lista todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Tive um problema ao detalhar esta fatura por time." +
          "</p>"
        );
      })
      .getResumoTransacoesPorTime(
        inicioIso, // data in√≠cio da fatura
        fimIso,    // data fim da fatura
        "valor"    // crit√©rio: agrupar por VALOR da fatura
      );

  } catch (e) {
    console.error("Erro em vektorDetalharFaturaPorTime:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Tive um problema ao detalhar esta fatura por time." +
      "</p>"
    );
  }
};

// ========= RENDER GEN√âRICO: CATEGORIAS / ESTABELECIMENTOS ========= //

function renderResumoPorChaveGenerico(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui montar o resumo para esse pedido.</p>"
    );
    return;
  }

  opts = opts || {};
  var tipoChave = opts.tipoChave || "Categoria"; // "Categoria" ou "Estabelecimento"
  var titulo    = opts.titulo || ("Resumo por " + tipoChave.toLowerCase());
  
  // ‚úÖ aceita topN como n√∫mero OU string num√©rica ("10")
var topN = null;
if (opts.topN !== undefined && opts.topN !== null && opts.topN !== "") {
  var n = Number(opts.topN);
  if (!isNaN(n) && n > 0) topN = n;
}

  // ===== Defini√ß√£o da base da tabela (categoria/estabelecimento/loja/time)
  var tipoChaveLower = tipoChave.toLowerCase();
  // ‚úÖ Default Top 10 somente para Estabelecimento quando n√£o vier topN
if (tipoChaveLower === "estabelecimento" && topN === null) {
  topN = 10;
}
  var baseTabela      = "categoria";    // usado no data-base do <select>
  var tipoTabelaExpand = "categoria";   // par√¢metro passado para vektorExpandirLinha
  var hintBase        = "";

  if (tipoChaveLower === "estabelecimento") {
    baseTabela       = "estabelecimento";
    tipoTabelaExpand = "estabelecimento";
    hintBase =
      "Clique para detalhar este estabelecimento pela dimens√£o selecionada (lojas, times ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "categoria") {
    baseTabela       = "categoria";
    tipoTabelaExpand = "categoria";
    hintBase =
      "Clique para detalhar esta categoria pela dimens√£o selecionada (lojas, times ou estabelecimentos), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "loja") {
    baseTabela       = "loja";
    tipoTabelaExpand = "loja";
    hintBase =
      "Clique para detalhar esta loja pela dimens√£o selecionada (times, estabelecimentos ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "time") {
    baseTabela       = "time";
    tipoTabelaExpand = "time";
    hintBase =
      "Clique para detalhar este time pela dimens√£o selecionada (lojas, estabelecimentos ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  }

  // Descobre qual lista veio do backend
  var lista = [];
  if (Array.isArray(resumo.categorias)) {
    lista = resumo.categorias;
  } else if (Array.isArray(resumo.estabelecimentos)) {
    lista = resumo.estabelecimentos;
  } else if (Array.isArray(resumo.linhas)) {
    lista = resumo.linhas;
  }

  if (!lista.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei movimenta√ß√µes para esse filtro.</p>"
    );
    return;
  }

  // Se tiver topN, recorta
  if (topN !== null && lista.length > topN) {
    lista = lista.slice(0, topN);
  }

  // Calcula somat√≥rios para porcentagens
  var totalQtd = 0;
  var totalValor = 0;

  for (var i = 0; i < lista.length; i++) {
    var it = lista[i];
    totalQtd   += Number(it.total || it.qtd || 0);
    totalValor += Number(it.valorTotal || it.valor || 0);
  }

  var linhasTabela = [];

  // üîπ Agora tamb√©m queremos drilldown em ESTABELECIMENTO (clique direto na linha)
  var temDrilldown = true;

  // ===== üîΩ DROPDOWN DE DRILLDOWN (somente se tiver drilldown) =====
  if (temDrilldown && baseTabela !== "categoria" && baseTabela !== "estabelecimento") {
    var opcoes = [];
    // Regra: todas as dimens√µes menos a pr√≥pria baseTabela
    if (baseTabela !== "time")            opcoes.push("<option value='time'>Times</option>");
    if (baseTabela !== "loja")            opcoes.push("<option value='loja'>Lojas</option>");
    if (baseTabela !== "estabelecimento") opcoes.push("<option value='estabelecimento'>Estabelecimentos</option>");
    if (baseTabela !== "categoria")       opcoes.push("<option value='categoria'>Categorias</option>");

    linhasTabela.push(
      "<div style='font-size:11px;margin-bottom:4px;color:#334155'>" +
        "Drilldown desta tabela de " + tipoChave.toLowerCase() + ": " +
        "<select class='vektor-drill-select' data-base='" + baseTabela + "' " +
                "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          opcoes.join("") +
        "</select>" +
      "</div>"
    );
  }

  // ===== TABELA PRINCIPAL =====
  linhasTabela.push(
    "<table border='1' cellspacing='0' cellpadding='6' " +
    "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
    "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
  );

  linhasTabela.push(
    "<tr style='background:#06167d;color:#fff'>" +
      "<th style='border:1px solid #000;'>" + tipoChave + "</th>" +
      "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
      "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
      "<th style='border:1px solid #000;'>Valor (R$)</th>" +
      "<th style='border:1px solid #000;'>% Valor</th>" +
    "</tr>"
  );

  for (var j = 0; j < lista.length; j++) {
  var l = lista[j];
  var nome =
    l.estabelecimento ||
    l.categoria ||
    l.chave ||
    "‚Äî";

  var qtd   = Number(l.total || l.qtd || 0);
  var valor = Number(l.valorTotal || l.valor || 0);

  var pctQtd = totalQtd   > 0 ? ((qtd   / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
  var pctVal = totalValor > 0 ? ((valor / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

  // ========== CATEGORIAS RESTRITAS: fundo vermelho claro ==========
  var estiloLinhaExtra = "";
  if (tipoChaveLower === "categoria") {
    var nomeNorm = (nome || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();

    var categoriasRestritas = [
      "combustiveis",
      "transporte",
      "eletronicos",
      "imoveis",
      "entretenimento",
      "pagamentos do governo",
      "causas sociais",
      "educacao",
      "joias e cassino",
      "joias",
      "cassino",
      "saude",
      "viagem e hospedagem",
      "aluguel de veiculos",
      "assinaturas"
    ];

    if (categoriasRestritas.indexOf(nomeNorm) !== -1) {
      // vermelho claro
      estiloLinhaExtra = "background:#FFB3B3;";
    }
  }

  // ===== LINHA: com ou sem onclick dependendo do drilldown =====
  if (temDrilldown) {
    // Categoria ‚Üí drilldown espec√≠fico para transa√ß√µes (vamos criar j√° j√°)
    if (tipoChaveLower === "categoria" && baseTabela === "categoria") {
      linhasTabela.push(
        "<tr onclick=\"vektorDrillTransacoesCategoria('" + nome.replace(/'/g, "\\'") + "')\" " +
          "style='cursor:pointer;" + estiloLinhaExtra + "' " +
          "title=\"Clique para ver as transa√ß√µes dessa categoria no mesmo per√≠odo.\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    } 
    
    // Estabelecimento ‚Üí drilldown espec√≠fico para transa√ß√µes por loja
else if (tipoChaveLower === "estabelecimento" && baseTabela === "estabelecimento") {
  linhasTabela.push(
    "<tr onclick=\"vektorDrillTransacoesEstabelecimento('" + nome.replace(/'/g, "\\'") + "')\" " +
      "style='cursor:pointer;" + estiloLinhaExtra + "' " +
      "title=\"Clique para ver as transa√ß√µes desse estabelecimento por loja no mesmo per√≠odo.\">" +
      "<td style='border:1px solid #000;'>" + nome + "</td>" +
      "<td style='border:1px solid #000;'>" + qtd + "</td>" +
      "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
      "<td style='border:1px solid #000;'>" +
        valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
    "</tr>"
  );
}
    
    else {
      // Drilldown padr√£o (times, lojas, estabelecimentos, etc.)
      var hint = hintBase;
      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'" + tipoTabelaExpand + "')\" " +
          "style='cursor:pointer;" + estiloLinhaExtra + "' title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }
  } else {
    // Sem drilldown ‚Üí apenas aplica cor quando necess√°rio
    linhasTabela.push(
      "<tr style='" + estiloLinhaExtra + "'>" +
        "<td style='border:1px solid #000;'>" + nome + "</td>" +
        "<td style='border:1px solid #000;'>" + qtd + "</td>" +
        "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
        "<td style='border:1px solid #000;'>" +
          valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
      "</tr>"
    );
  }
}

  // Linha de TOTAL
  linhasTabela.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;'>TOTAL</td>" +
      "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
      "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
      "<td style='border:1px solid #000;'>" +
        totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
    "</tr>"
  );

  linhasTabela.push("</table>");

  // Bot√£o CSV
  var botaoCsv = "";
  if (linhasTabela.length) {
    var slug = tipoChave.toLowerCase();
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'resumo_" + slug + "')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

    // ===== Per√≠odo da consulta (apenas para Categorias) =====
  var periodoHtml = "";
  if (tipoChaveLower === "categoria") {
    var dataInicioIso = "";
    var dataFimIso    = "";

    // 1) Tenta vir do pr√≥prio resumo (caso o backend envie)
    if (resumo.dataInicioIso && resumo.dataFimIso) {
      dataInicioIso = resumo.dataInicioIso;
      dataFimIso    = resumo.dataFimIso;
    }
    // 2) Sen√£o, cai no cache global do per√≠odo
    else if (
      window.__vektorUltimoPeriodo &&
      window.__vektorUltimoPeriodo.dataInicio &&
      window.__vektorUltimoPeriodo.dataFim
    ) {
      dataInicioIso = window.__vektorUltimoPeriodo.dataInicio.toISOString();
      dataFimIso    = window.__vektorUltimoPeriodo.dataFim.toISOString();
    }

    if (dataInicioIso && dataFimIso) {
      try {
        var di = new Date(dataInicioIso);
        var df = new Date(dataFimIso);
        var diBr = di.toLocaleDateString("pt-BR");
        var dfBr = df.toLocaleDateString("pt-BR");

        periodoHtml =
          "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
            "Per√≠odo da consulta: de " + diBr + " a " + dfBr + "." +
          "</p>";
      } catch (e) {
        console.error("N√£o consegui formatar per√≠odo em renderResumoPorChaveGenerico:", e);
      }
    }
  }

      // ===== Per√≠odo da consulta (prioriza o que vem do back-end) =====
  var periodoHtml = "";
  if (tipoChaveLower === "categoria" || tipoChaveLower === "estabelecimento") {
    try {
      var di = null, df = null;

      // 1) Tenta pegar diretamente do objeto resumo retornado pelo Apps Script
      if (resumo && resumo.dataInicioIso && resumo.dataFimIso) {
        di = new Date(resumo.dataInicioIso);
        df = new Date(resumo.dataFimIso);
      }

      // 2) Se n√£o tiver no resumo, usa o cache global do √∫ltimo per√≠odo interpretado
      if (
        (!di || !df || isNaN(di.getTime()) || isNaN(df.getTime())) &&
        window.__vektorUltimoPeriodo &&
        window.__vektorUltimoPeriodo.dataInicio &&
        window.__vektorUltimoPeriodo.dataFim
      ) {
        di = window.__vektorUltimoPeriodo.dataInicio;
        df = window.__vektorUltimoPeriodo.dataFim;
      }

      if (di && df && !isNaN(di.getTime()) && !isNaN(df.getTime())) {
        var diBr = di.toLocaleDateString("pt-BR");
        var dfBr = df.toLocaleDateString("pt-BR");

        periodoHtml =
          "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
            "Per√≠odo da consulta: de " + diBr + " a " + dfBr + "." +
          "</p>";
      }
    } catch (e) {
      console.error("Erro ao montar periodoHtml em renderResumoPorChaveGenerico:", e);
    }
  }

  // Dica de drilldown ‚Äì s√≥ para categorias
    var dicaDrilldown = "";
    if (tipoChaveLower === "categoria") {
      dicaDrilldown =
        (periodoHtml || "") +  // üëà per√≠odo vem logo acima da dica
        "<p style='font-size:12px;color:#64748B;margin-top:2px;'>" +
          "Clique em uma categoria para ver as transa√ß√µes individuais dela no mesmo per√≠odo." +
        "</p>";

      // Como o per√≠odo foi ‚Äúmovido‚Äù para c√°, evita duplicar mais abaixo
      periodoHtml = "";
    }

  // Dica de drilldown ‚Äì para estabelecimentos
if (tipoChaveLower === "estabelecimento") {
  dicaDrilldown =
    "<p style='font-size:12px;color:#64748B;margin-top:2px;'>" +
      "Clique em um estabelecimento para ver as transa√ß√µes individuais por loja no mesmo per√≠odo." +
    "</p>";
}

  // HTML final
  var html =
    "<div class='text-sm text-slate-700'>" +
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>" +
      periodoHtml +
      dicaDrilldown +
      linhasTabela.join("") +
      botaoCsv +
    "</div>";

  renderBotMessage("HTML:" + html);

  // üîé Insights autom√°ticos adicionais para Categoria / Estabelecimento (ticket m√©dio)
  var tipoLower = tipoChaveLower;
  if (tipoLower === "categoria" || tipoLower === "estabelecimento") {
    var listaInsights = lista
      .map(function (l) {
        return {
          nome: l.estabelecimento || l.categoria || l.chave || "‚Äî",
          valor: Number(l.valorTotal || l.valor || 0),
          qtd: Number(l.total || l.qtd || 0)
        };
      })
      .filter(function (l) {
        return l.qtd > 0 && l.valor > 0;
      });

    var insightsHtml = "";
    if (tipoLower === "categoria") {
      insightsHtml = vektorGerarInsightsResumoCategorias(listaInsights);
    } else {
      insightsHtml = vektorGerarInsightsResumoEstabelecimentos(listaInsights);
    }

    if (insightsHtml) {
      renderBotMessage("HTML:" + insightsHtml);
    }
  }

  // üß† NOVO: insights autom√°ticos espec√≠ficos para Categoria / Estabelecimento
  if (
    opts &&
    (opts.tipoChave === "Categoria" || opts.tipoChave === "Estabelecimento")
  ) {
    const htmlInsightsExtra = gerarInsightsResumoChaveCategoriaEstab(resumo, {
      tipoChave: opts.tipoChave
    });

    if (htmlInsightsExtra) {
      renderBotMessage("HTML:" + htmlInsightsExtra);
    }
  }
}

// ================= INFORMA√á√ïES INICIAIS (APENAS ADMIN) ===================

function vektorMostrarPerguntaInfoInicial() {
  try {
    // S√≥ ADM recebe essa pergunta
    if (USER_ROLE_REPLACED !== "Administrador") {
      return;
    }

    const chatWindow = document.getElementById("chatWindow");
    if (!chatWindow) return;

    // Evita duplicar se o usu√°rio recarregar
    if (document.getElementById("vektor-info-inicial-pergunta")) return;

    const div = document.createElement("div");
    div.id = "vektor-info-inicial-pergunta";
    div.className = "flex items-start gap-3 mt-3";

    div.innerHTML = `
      <div class="bot-bubble px-4 py-3 max-w-[80%]">
        <p class="text-sm text-slate-700">
          Voc√™ quer ver as principais informa√ß√µes de utiliza√ß√£o dos cart√µes Clara,
          como <b>maiores transa√ß√µes</b>, <b>times com mais pend√™ncias</b>,
          <b>estabelecimentos</b> e <b>categorias</b> com maior volume de gastos?
        </p>
        <div class="mt-3 flex gap-3">
          <button
            id="btnInfoInicialSim"
            class="px-3 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">
            Sim, mostrar
          </button>
          <button
            id="btnInfoInicialNao"
            class="px-3 py-1 text-xs rounded bg-slate-200 text-slate-700 hover:bg-slate-300">
            N√£o, obrigado
          </button>
        </div>
      </div>
    `;

    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    const btnSim = document.getElementById("btnInfoInicialSim");
    const btnNao = document.getElementById("btnInfoInicialNao");

    if (btnSim) {
      btnSim.addEventListener("click", function () {
        vektorCarregarInformacoesIniciais();
      });
    }
    if (btnNao) {
      btnNao.addEventListener("click", function () {
        const bloco = document.getElementById("vektor-info-inicial-pergunta");
        if (bloco) bloco.remove();
      });
    }
  } catch (e) {
    console.warn("Erro ao montar pergunta de informa√ß√µes iniciais:", e);
  }
}

// Extrai "top N" (ex.: "top 5", "top5"). Se n√£o houver "top", retorna null.
function extrairTopN(texto) {
  if (!texto) return null;
  let m = texto.match(/top\s*(\d{1,2})/);
  if (!m) m = texto.match(/top(\d{1,2})/);
  if (m) {
    const n = Number(m[1]);
    if (!isNaN(n)) return Math.min(Math.max(n, 1), 50); // 1..50
  }
  return null;
}

// Decide crit√©rio: "quantidade" se falar de transa√ß√µes; sen√£o "valor".
function extrairCriterioGeral(texto) {
  if (!texto) return "valor";

  const falaDeTransacoes =
    texto.includes("transacoes") || 
    texto.includes("transacao") ||
    texto.includes("numero de transacoes") || 
    texto.includes("quantidade de transacoes") ||
    texto.includes("mais transacoes") || 
    texto.includes("maior numero de transacoes");

  const falaDeValor =
    texto.includes("valor") || 
    texto.includes("gasto") || 
    texto.includes("gastou") ||
    texto.includes("gastaram") || 
    texto.includes("gastos") || 
    texto.includes("compras") ||
    texto.includes("valor de transacoes");

  if (falaDeTransacoes && !falaDeValor) return "quantidade";
  return "valor";
}

function extrairGrupo(msgOriginal, norm) {
  const textoOriginal = msgOriginal || "";
  const lower = (norm || textoOriginal.toLowerCase());

  // procura a palavra "time "
  let idx = lower.indexOf("time ");
  if (idx === -1) {
    // se quiser, pode tentar "time:" tamb√©m
    idx = lower.indexOf("time:");
  }
  if (idx === -1) {
    return "";
  }

  // pega o que vem depois de "time "
  let parte = textoOriginal.substring(idx + 5); // 5 = len("time ")

  // corta quando come√ßar alguma palavra de per√≠odo
  const marcadores = [
    " no ", " neste ", " nesse ", " nesta ", " nessa ",
    " em ", " no per√≠odo", " no periodo",
    " neste mes", " nesse mes", " neste m√™s", " nesse m√™s",
    " na semana", " nesta semana", " nessa semana"
  ];

  let corte = parte.length;
  const parteLower = parte.toLowerCase();

  marcadores.forEach(m => {
    const j = parteLower.indexOf(m);
    if (j !== -1 && j < corte) {
      corte = j;
    }
  });

  parte = parte.substring(0, corte).trim();

  // remove "do", "da", "de" do come√ßo, se tiver
  parte = parte.replace(/^(do|da|de)\s+/i, "").trim();

  return parte;
}

// FILTRAR POR MAIS DE UMA LOJA

function extrairCodigosLojasDaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");

  // localiza a partir da palavra "loja" ou "lojas"
  let idx = texto.indexOf("lojas");
  if (idx < 0) idx = texto.indexOf("loja");
  if (idx < 0) return [];

  const trecho = texto.slice(idx); // parte da frase a partir de "loja(s)"

  // pega n√∫meros com 2 a 4 d√≠gitos (311, 145, 023, 1020 etc.)
  const encontrados = trecho.match(/\b\d{2,4}\b/g);
  if (!encontrados) return [];

  // normaliza tirando zeros √† esquerda
  return encontrados.map(function (c) {
    return c.replace(/^0+/, "") || c;
  });
}

// ========= DETECTOR: CATEGORIAS ========= //
function detectarPerguntaCategorias(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);
  let topN      = extrairTopN(t);
  let tipo      = extrairCriterioGeral(t);  // "valor" ou "quantidade"

  // Se falar "mais uso", for√ßa tratar como quantidade (uso = n√∫mero de vezes)
  if (t.includes("mais uso")) {
    tipo = "quantidade";
  }

  // se ainda n√£o tiver tipo, assume "valor" como padr√£o
  if (!tipo) {
    tipo = "valor";
  }

  const falaCategoria =
    t.includes("categoria") ||
    t.includes("categorias");

  if (!falaCategoria) return null;

  const falaUso =
    t.includes("mais uso") ||
    t.includes("mais gasto") ||
    t.includes("mais gastos") ||
    t.includes("mais valor") ||      // NOVO
    t.includes("mais valores") ||    // NOVO
    t.includes("mais transacoes") ||
    t.includes("mais transacao") ||
    t.includes("maior valor") ||
    t.includes("maior gasto") ||
    t.includes("maior numero de transacoes") ||
    t.includes("maior quantidade de transacoes");

  if (!falaUso) return null;

  // Se n√£o tiver "top" expl√≠cito mas for "qual categoria ...", trata como top 1
  if (!topN && /\bqual\s+categoria\b/.test(t)) {
    topN = 1;
  }

  return {
    periodo,
    tipo,
    topN
  };
}

// ========= DETECTOR: ESTABELECIMENTOS (TRANSACAO) ========= //

function detectarPerguntaEstabelecimentos(msgOriginal, norm) {
  const t = norm || "";
  const tipo    = extrairCriterioGeral(t);
  let   topN    = extrairTopN(t); // let para conseguirmos ajustar para 1

  // Se n√£o tem ‚Äútop‚Äù mas a pessoa perguntou ‚Äúqual local/estabelecimento‚Äù ‚Üí for√ßa topN = 1
if (!topN) {
  const temQualLocal =
    /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
  const temQualEstab =
    /\bqual\s+estabelecimento\b/.test(t) ||
    /\bqual\s+estabelecimentos\b/.test(t);

  if (temQualLocal || temQualEstab) {
    topN = 1;
  }
}

// ‚úÖ DEFAULT: se ainda n√£o definiu topN, usa Top 10
if (!topN) {
  topN = 10;
}

  // Palavras que DEFINEM claramente a inten√ß√£o de estabelecimento
  const falaLocalBase =
    t.includes("estabelecimento") ||
    t.includes("estabelecimentos") ||
    t.includes("local") ||
    t.includes("locais") ||
    t.includes("fornecedor") ||
    t.includes("fornecedores") ||
    t.includes("mercado") ||
    t.includes("mercados") ||
    t.includes("supermercado") ||
    t.includes("supermercados");

  const falaLugarComCompra =
    (t.includes("lugar") || t.includes("lugares")) &&
    (
      t.includes("cartao") ||
      t.includes("cart√£o") ||
      t.includes("clara") ||
      t.includes("comprar") ||
      t.includes("compra") ||
      t.includes("compras") ||
      t.includes("gastar") ||
      t.includes("gasto") ||
      t.includes("gastos")
    );

  const falaLocal = falaLocalBase || falaLugarComCompra;

  // Palavras que INDICAM time campe√£o ‚Äî e por isso devem bloquear
  const falaTimeCampeao =
    t.includes("time que mais gastou") ||
    t.includes("qual time gastou mais") ||
    t.includes("time com maior valor") ||
    t.includes("maior valor total por time") ||
    t.includes("maior gasto por time");

  // Se n√£o for claramente estabelecimento, ou se cair no caso de time ‚Üí ignora
  if (!falaLocal || falaTimeCampeao) return null;

  // Se n√£o tem ‚Äútop‚Äù mas a pessoa perguntou ‚Äúqual local/estabelecimento‚Äù ‚Üí for√ßa topN = 1
  if (!topN) {
    topN = 10;
    const temQualLocal =
      /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
    const temQualEstab =
      /\bqual\s+estabelecimento\b/.test(t) ||
      /\bqual\s+estabelecimentos\b/.test(t);

    if (temQualLocal || temQualEstab) {
      topN = 1;
    }
  }

   // S√≥ tenta achar time se a frase falar explicitamente de time/grupo/equipe
  let grupo = "";
  const falaDeTime =
    t.includes("time ")   ||
    t.includes("times ")  ||
    t.includes("grupo ")  ||
    t.includes("equipe")  ||
    t.includes("equipes");

  if (falaDeTime) {
    grupo = encontrarTimeNaMensagem(msgOriginal) || "";
  }

  const periodo = extrairIntervaloDatas(msgOriginal);
  const criterio = extrairCriterioGeral(t);

  return {
    grupo,
    periodo,
    criterio
  };
}

// ========= DETECTOR: PERGUNTAS DE FATURA (Extrato da conta) =========

function detectarPerguntaFaturaClara(msgOriginal, norm) {
  const t = norm || "";

  // precisa conter "fatura" ou "faturas"
  if (!t.includes("fatura")) return null;

  let modo = "atual";
  let qtd = null;

  // todas as faturas
  if (t.includes("todas") && t.includes("faturas")) {
    modo = "todas";
  }

  // √∫ltimas N faturas
  if (t.includes("ultimas") || t.includes("ultimos") || t.includes("√∫ltimas")) {
    modo = "ultimas";

    // capturar n√∫mero "6", "3", etc.
    let m1 = t.match(/ultimas?\s+(\d+)/);
    let m2 = t.match(/(\d+)\s+ultimas?/);
    let m3 = t.match(/ultimos?\s+(\d+)/);

    const m = m1 || m2 || m3;
    qtd = m ? parseInt(m[1], 10) : 2;
  }

  // fatura anterior
  if (
    t.includes("anterior") ||
    t.includes("mes passado") ||
    t.includes("m√™s passado")
  ) {
    modo = "anterior";
  }

  // refor√ßo: fatura atual
  if (t.includes("atual") || t.includes("deste mes") || t.includes("desse mes")) {
    modo = "atual";
  }

  return {
    tipo: "fatura",
    modo,
    qtd
  };
}

// ========= DETECTOR: "loja e time com maior n√∫mero/valor de transa√ß√µes..." ========= //

function detectarPerguntaLojaMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // fala claramente de loja
  const falaDeLoja =
    texto.includes("qual loja") ||
    texto.includes("loja com")  ||
    texto.includes("loja que mais")  ||
    texto.includes("loja mais");

  // pedindo topo por QUANTIDADE de transa√ß√µes
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // pedindo topo por VALOR de transa√ß√µes
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastou")                 ||
    texto.includes("loja que mais gastou")        ||
    texto.includes("mais gastos")                 ||
    texto.includes("maior gastos")                 ||
    texto.includes("maior gasto")                 ||
    texto.includes("mais comprou");

  // se n√£o for pergunta de loja + (transa√ß√µes ou valor), ignora
  if (!falaDeLoja || (!falaDeTransacoes && !falaDeValor)) {
    return null;
  }

  // intervalo de datas (ontem, esse m√™s, m√™s passado, "de 1 a 30 de outubro", etc.)
  const periodo = extrairIntervaloDatas(msgOriginal);

  // S√≥ tenta achar time se a frase falar explicitamente de time/grupo/equipe
  const falaDeTime =
    texto.includes("time ")  ||
    texto.includes("times ") ||
    texto.includes("grupo ") ||
    texto.includes("equipe") ||
    texto.includes("equipes");

  // tenta achar um dos TIMES_OFICIAIS no texto APENAS se fez sentido procurar
  const grupoNomeOficial = falaDeTime ? encontrarTimeNaMensagem(msgOriginal) : null;


  // se falou de "valor" (gastou/comprou), √© consulta por valor; sen√£o, por quantidade
  const tipo = falaDeValor ? "valor" : "quantidade";

  return {
    grupo: grupoNomeOficial, // null => todas as lojas, independente de time
    periodo: periodo,
    tipo: tipo
  };

}

// ========= DETECTOR: "ranking geral de times" / "top N times ..." =========

function detectarRankingTimes(msgOriginal, norm) {
  // se for "qual time ..." (singular), deixa o bloco singular tratar
  if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) return null;

  const texto = norm || "";

  // üö´ ESCUDO: se falar de local/estabelecimento, N√ÉO √© pergunta de time
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // se fala explicitamente de loja(s), n√£o √© ranking de times
  if (texto.includes("lojas") || texto.includes("loja")) return null;

  const falaDeTime =
  texto.includes("ranking de times") ||
  texto.includes("ranking geral de times") ||
  // S√≥ trata frases do tipo "top 5 times", n√£o "top 5 transa√ß√µes do time X"
  (texto.includes("top") && texto.includes("times"));

  if (!falaDeTime) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = extrairCriterioGeral(texto);  // "valor" ou "quantidade"
  const topN = extrairTopN(texto);           // n√∫mero de linhas

  return { periodo, tipo, topN };
}

// ========= DETECTOR: "TODOS OS TIMES / RELA√á√ÉO DE TIMES" ========= //

function detectarTodosTimesPeriodo(msgOriginal, norm) {
  const t = norm || "";

  // Frases chave:
  // - "todos os times no per√≠odo ..."
  // - "rela√ß√£o de times no per√≠odo ..."
  const pedeTodosTimes =
    t.includes("todos os times") ||
    t.startsWith("todos os times") ||
    t.startsWith("relacao de times") ||
    t.includes("relacao de times no periodo") ||
    t.includes("rela√ß√£o de times") ||
    t.includes("rela√ß√£o de times no per√≠odo");

  if (!pedeTodosTimes) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  let tipo = extrairCriterioGeral(t); // "valor" ou "quantidade"

  // se n√£o especificar crit√©rio, assume valor
  if (!tipo) {
    tipo = "valor";
  }

  return {
    periodo,
    tipo,
    topN: null // null => queremos TODOS os times
  };
}

// ========= DETECTOR: "ranking/top N de LOJAS" (opcional: do time X) =========

function detectarRankingLojas(msgOriginal, norm) {
  const texto = norm || "";

  // üö´ Se falar de local/estabelecimento, N√ÉO √© ranking de lojas
  if (
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

    // Aceita apenas pedidos CLAROS de ranking de lojas:
  // - "ranking de lojas"
  // - "ranking geral de lojas"
  // - "top 5 lojas", "top 10 lojas", etc.
  const falaRankingLojasDireto =
    texto.includes("ranking de lojas") ||
    texto.includes("ranking geral de lojas");

  const falaTopLojas = /top\s*\d+\s+lojas?/.test(texto); // ex.: "top 5 lojas"

  // Se n√£o falar explicitamente de "ranking de lojas" ou "top X lojas",
  // N√ÉO trata como ranking de lojas.
  if (!falaRankingLojasDireto && !falaTopLojas) return null;


  // Time opcional (usa seu matcher)
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(texto); // "valor" ou "quantidade"
  const topN    = extrairTopN(texto);          // null se n√£o informou

  return { grupo: grupoNomeOficial, periodo, tipo, topN };
}

// ========= DETECTOR: "TODAS AS LOJAS" GERAL (sem time) ========= //

function detectarListarTodasLojasGeral(msgOriginal, norm) {
  const t = norm || "";

  // Aceita pedidos do tipo:
  // - "todas as lojas com gastos no per√≠odo ..."
  // - "todas as lojas com valor no per√≠odo ..."
  // - "rela√ß√£o de lojas no per√≠odo ..."
  const pedeTodas =
    t.includes("listar todas as lojas") ||
    t.startsWith("todas as lojas") ||
    t.includes("todas as lojas com gastos") ||
    t.includes("todas as lojas com gasto") ||
    t.includes("todas as lojas com valor") ||
    t.startsWith("relacao de lojas") ||
    t.includes("relacao de lojas no periodo") ||
    t.includes("rela√ß√£o de lojas") ||
    t.includes("rela√ß√£o de lojas no per√≠odo");

  if (!pedeTodas) return null;

  // crit√©rio: por padr√£o ordena por valor, mas a tabela mostra valor e quantidade
  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = "valor"; // mant√©m padr√£o por valor

  return {
    grupo: "",      // sem time
    periodo,
    tipo,
    topN: null      // null => queremos TODAS as lojas
  };
}

// =========== DETECTOR: "TODAS AS LOJAS DOS TIMES X E Y" =========== //

function detectarTodasLojasDosTimes(msgOriginal, norm) {
  const t = norm || "";

  const falaLojas = t.includes("todas as lojas dos times") ||
                    t.includes("todas as lojas dos time")  ||
                    t.includes("todas as lojas do time")   ||
                    t.includes("lojas do time")   ||
                    t.includes("loja do time")   ||
                    t.includes("todas as lojas do grupo")  ||
                    t.includes("todas as lojas dos grupos");

  if (!falaLojas) return null;

  const listaTimes = encontrarListaTimesNaMensagem(msgOriginal) || [];
  if (!listaTimes.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: listaTimes,
    periodo,
    tipo
  };
}

// =========== DETECTOR: "MAIS DE UMA LOJA NO PER√çODO" =========== //

function detectarLojasEspecificasLista(msgOriginal, norm) {
  const texto = norm || "";

  // ‚ö†Ô∏è Se a frase fala de pend√™ncia, N√ÉO tratar como consulta de transa√ß√µes
  // Isso evita conflitos com o fluxo de pend√™ncias (CLARA_PEND)
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "loja" ou "lojas"
  const mencionaLoja =
    texto.includes("loja ") ||
    texto.includes("lojas ");

  if (!mencionaLoja) return null;

  // extrai c√≥digos num√©ricos de loja
  const codigos = [];
  const regexCodigos = /\b(\d{2,6})\b/g;
  let m;
  while ((m = regexCodigos.exec(msgOriginal)) !== null) {
    const cod = m[1];
    if (!codigos.includes(cod)) {
      codigos.push(cod);
    }
  }

  if (!codigos.length) return null;

  // per√≠odo
  const periodo = extrairIntervaloDatas(msgOriginal);
  // tipo (valor ou quantidade)
  const tipo = extrairCriterioGeral(texto) || "valor";

  return {
    codigosLojas: codigos,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "lojas com maior valor/transa√ß√µes ..." (plural, sem 'top'/'ranking') =========
function detectarLojasMaisTransacoesPlural(msgOriginal, norm) {
  const texto = norm || "";

    // ‚ö†Ô∏è Se falar de pend√™ncia, n√£o √© consulta de ranking/lista de transa√ß√µes
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "lojas " (plural) + crit√©rio
  const mencionaLojasPlural = texto.includes("lojas ");
  if (!mencionaLojasPlural) return null;

  // crit√©rio
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior quantidade de transacoes");

  const falaDeValor =
    texto.includes("maior valor")     ||
    texto.includes("mais gastou")     ||
    texto.includes("mais gasto")      ||
    texto.includes("mais gastos")     ||
    texto.includes("maior gasto")     ||
    texto.includes("maior gastos")     ||
    texto.includes("mais comprou")    ||
    texto.includes("valor de transacoes");

  if (!falaDeTransacoes && !falaDeValor) return null;

  const tipo = falaDeValor ? "valor" : "quantidade";
  const periodo = extrairIntervaloDatas(msgOriginal);
  const grupo = encontrarTimeNaMensagem(msgOriginal) || "";

  // sem 'top' => queremos listar TODAS as lojas do time (se grupo vier),
  // ou o default que voc√™ preferir para "todas as lojas gerais" (vamos deixar limitado se n√£o houver time)
  return { grupo, periodo, tipo, topN: null }; // topN=null => deixe o renderer decidir "listar todas"
}

// =========== DETECTOR: "TODAS AS LOJAS DO TIME XXXXX" =========== //

function detectarListarTodasLojasDoTime(msgOriginal, norm) {
  const t = norm || "";

  // üö´ Se falar em "top", N√ÉO √© "todas as lojas do time",
  // e sim um ranking de lojas. Deixa para detectarRankingLojas tratar.
  if (t.includes("top")) {
    return null;
  }

  // Gatilhos espec√≠ficos para perguntas de "lojas do time"
  const pedeTodas =
    t.includes("todas as lojas do time") ||
    t.includes("todas as loja do time") ||   // tolera sem 's'
    t.includes("lojas do time") ||
    t.includes("loja do time") ||            // tolera sem 's'
    t.includes("lojas da regional") ||
    t.includes("loja da regional") ||
    t.includes("todas as lojas do grupo") ||
    t.includes("todas as loja do grupo") ||  // tolera sem 's'
    t.includes("relacao de lojas do time") ||
    t.includes("rela√ß√£o de lojas do time") ||
    t.includes("relacao de lojas do grupo") ||
    t.includes("rela√ß√£o de lojas do grupo");

  if (!pedeTodas) return null;

  // Usa o parser de times que voc√™ j√° tem
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  if (!grupoNomeOficial) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    grupo: grupoNomeOficial,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "time com maior n√∫mero/valor de transa√ß√µes ..." ========= //
function detectarPerguntaTimeMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // üö´ Se a frase fala de estabelecimento/local, N√ÉO √© pergunta de time campe√£o
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // fala claramente de time (n√£o de loja)
  const falaDeTime =
    texto.includes("qual time") ||
    texto.includes("time com")  ||
    texto.includes("time que mais") ||
    texto.includes("time mais");

  // QUANTIDADE
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // VALOR
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastos")                ||
    texto.includes("mais comprou");

  if (!falaDeTime || (!falaDeTransacoes && !falaDeValor)) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = falaDeValor ? "valor" : "quantidade";

  return { periodo, tipo };
}

// ===== NOVO DETECTOR: Maiores transa√ß√µes individuais (loja / time) =====
function detectarMaioresTransacoesIndividuais(msgOriginal, norm) {
  if (!msgOriginal) return null;
  norm = norm || "";

  // Texto normalizado em min√∫sculas
  var t = norm.toLowerCase();

  // tem palavra "transacao/transa√ß√µes"
  var temTransacao = t.indexOf("transacao") >= 0 || t.indexOf("transacoes") >= 0;
  if (!temTransacao) return null;

  // quer "maiores" OU "top N"
  var temMaior = t.indexOf("maiores transacoes") >= 0 || t.indexOf("maior transacao") >= 0;
  var temTop   = t.indexOf("top") >= 0;
  if (!temMaior && !temTop) return null;

  // Evita pegar perguntas de ranking j√° existentes (ranking de lojas/times)
  if (t.indexOf("ranking de lojas") >= 0 || t.indexOf("ranking de times") >= 0) {
    return null;
  }

  // ------------------------------
  // LOJA: detectada normalmente pelos c√≥digos
  // ------------------------------
  var lojasCodigos = extrairCodigosLojasDaMensagem(msgOriginal) || [];
  var lojaCodigo = lojasCodigos.length ? lojasCodigos[0] : "";

  // ------------------------------
  // TIME: s√≥ detecta se o usu√°rio citar explicitamente "time", "grupo" ou "equipe"
  // ------------------------------
  var mencionaEstruturaTime =
    t.indexOf("time")   >= 0 ||
    t.indexOf("grupo")  >= 0 ||
    t.indexOf("equipe") >= 0;

  var grupoNomeOficial = "";
  if (mencionaEstruturaTime) {
    grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  }

  // per√≠odo (pode ser nulo)
  var periodo = extrairIntervaloDatas(msgOriginal) || null;

  // "top N" se existir
  var topN = extrairTopN(t);

  var grupoFinal = grupoNomeOficial;

  return {
    grupo: grupoFinal,
    loja: lojaCodigo,
    periodo: periodo,
    topN: topN
  };
}

function bindPeriodoEtiquetasOnce_() {
  if (window.__vektorEtiquetasPeriodoBound) return;
  window.__vektorEtiquetasPeriodoBound = true;

  document.addEventListener("click", async function(e) {
    const btn = e.target && e.target.closest && e.target.closest("#vektor-etq-per-aplicar");
    if (!btn) return;

    const iniEl = document.getElementById("vektor-etq-per-ini");
    const fimEl = document.getElementById("vektor-etq-per-fim");
    const ini = iniEl ? String(iniEl.value || "").trim() : "";
    const fim = fimEl ? String(fimEl.value || "").trim() : "";

    if (!ini || !fim) {
      renderBotMessage("HTML:<p class='text-sm text-red-700' style='margin:0'><b>Preencha</b> data inicial e final.</p>");
      return;
    }
    if (ini > fim) {
      renderBotMessage("HTML:<p class='text-sm text-red-700' style='margin:0'><b>Per√≠odo inv√°lido:</b> a data inicial n√£o pode ser maior que a final.</p>");
      return;
    }

    const st = window.__vektorEtiquetasState || {};
    st.periodoIni = ini;
    st.periodoFim = fim;

    // zera filtros do painel (mant√©m coer√™ncia)
    st.mes = "";
    st.time = "";
    st.loja = "";
    st.etiqueta = "";

    window.__vektorEtiquetasState = st;

    // for√ßa a msg √∫nica do pr√≥prio listarGastos... reaparecer quando mudar o per√≠odo
    window.__vektorEtiquetasIntroShown = false;

    // importante: fecha a ‚Äúsess√£o‚Äù do calend√°rio para permitir reabrir depois
    window.__vektorEtiquetasPeriodoOpen = false;

    window.__vektorEtiquetasIntroShown = false;

    await listarGastosPorEtiquetasClara();

  });
}

function abrirPeriodoGastosEtiquetas_() {
  bindPeriodoEtiquetasOnce_();
  // evita abrir 2 vezes
  if (window.__vektorEtiquetasPeriodoOpen) return;
  window.__vektorEtiquetasPeriodoOpen = true;

  // default: √∫ltimos 30 dias
  const hoje = new Date();
  const fim = hoje.toISOString().slice(0, 10);

  const iniDt = new Date(hoje.getTime());
  iniDt.setDate(iniDt.getDate() - 30);
  const ini = iniDt.toISOString().slice(0, 10);

  // se j√° existe per√≠odo salvo, pr√©-preenche
  const st = window.__vektorEtiquetasState || {};
  const vIni = st.periodoIni || ini;
  const vFim = st.periodoFim || fim;

  renderBotMessage(
    "HTML:" +
    "<div class='text-sm text-slate-700' style='margin:0'>" +
      "<p style='margin:0'><b>Selecione o per√≠odo</b> para montar <b>Gastos por etiquetas</b>:</p>" +
      "<div style='display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:10px'>" +
        "<div style='display:flex;flex-direction:column;gap:4px'>" +
          "<label style='font-size:11px;opacity:0.85'>Data inicial</label>" +
          "<input type='date' id='vektor-etq-per-ini' value='" + vIni + "' " +
          "style='border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px' />" +
        "</div>" +
        "<div style='display:flex;flex-direction:column;gap:4px'>" +
          "<label style='font-size:11px;opacity:0.85'>Data final</label>" +
          "<input type='date' id='vektor-etq-per-fim' value='" + vFim + "' " +
          "style='border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px' />" +
        "</div>" +
        "<button type='button' id='vektor-etq-per-aplicar' " +
          "style='background:#005E27;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-size:12px;cursor:pointer'>" +
          "Aplicar per√≠odo" +
        "</button>" +
      "</div>" +
      "<p style='margin:0;margin-top:8px;font-size:12px;opacity:0.9'>Dica: escolha um per√≠odo menor para carregar mais r√°pido.</p>" +
    "</div>"
  );
}

// Lista as etiquetas dispon√≠veis na BaseClara (coluna T) e mostra no chat

async function listarGastosPorEtiquetasClara() {
  // estado global (filtros)
  window.__vektorEtiquetasState = window.__vektorEtiquetasState || { mes:"", time:"", loja:"", etiqueta:"" };

  // id √∫nico do painel (1 inst√¢ncia)
  const panelId = window.__vektorEtiquetasPanelId || ("vektor-etq-panel-" + Date.now());
  window.__vektorEtiquetasPanelId = panelId;

  const st0 = window.__vektorEtiquetasState || {};

if (!st0.periodoIni || !st0.periodoFim) {
  // primeira entrada: pede o per√≠odo no chat
  window.__vektorEtiquetasPeriodoOpen = false;
  abrirPeriodoGastosEtiquetas_();  // renderiza o mini-calend√°rio em nova bolha
  return;
}

  function escHtml_(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function formatBRL(n) {
    n = Number(n || 0); if (!isFinite(n)) n = 0;
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2});
  }
  function formatPct(p) {
    p = Number(p || 0); if (!isFinite(p)) p = 0;
    return p.toLocaleString("pt-BR",{minimumFractionDigits:1,maximumFractionDigits:1}) + " %";
  }

  // 1) garante a bolha UMA vez
// 1) garante a bolha UMA vez (somente o container do painel)
async function ensurePanelBubble_() {
  if (document.getElementById(panelId)) return;
  await renderBotMessage(
    "HTML:<div class='text-sm text-slate-700' style='margin:0'>" +
      "<div id='" + panelId + "'></div>" +
    "</div>"
  );
}

  function buildPainelHtml_(res) {
    const st = window.__vektorEtiquetasState || { mes:"", time:"", loja:"", etiqueta:"" };
    const filtros = res && res.filtros ? res.filtros : {};
    const meses = Array.isArray(filtros.meses) ? filtros.meses : [];
    const times = Array.isArray(filtros.times) ? filtros.times : [];
    const lojas = Array.isArray(filtros.lojas) ? filtros.lojas : [];
    const etiquetas = Array.isArray(filtros.etiquetas) ? filtros.etiquetas : [];

    // aceita backend em res.itens OU res.rows
    const itens = Array.isArray(res.itens) ? res.itens : (Array.isArray(res.rows) ? res.rows : []);

    const somaValores = Number(res.somaValores || 0);

    // heat column (valor)
    let minValor = Infinity, maxValor = -Infinity;
    itens.forEach(it => {
      const v = Number(it.valorTotal || 0);
      if (isFinite(v)) { if (v < minValor) minValor = v; if (v > maxValor) maxValor = v; }
    });
    if (!isFinite(minValor)) minValor = 0;
    if (!isFinite(maxValor)) maxValor = 0;

    const opt = (arr, selected, placeholder) => {
      let out = `<option value="">${escHtml_(placeholder)}</option>`;
      arr.forEach(v => {
        const vv = String(v ?? "");
        const sel = (vv === String(selected ?? "")) ? " selected" : "";
        out += `<option value="${escHtml_(vv)}"${sel}>${escHtml_(vv)}</option>`;
      });
      return out;
    };

    let html = "";
    html += "<div id='vektor-etiquetas-panel' style='position:relative'>";
    // overlay de carregamento (fica oculto; o JS liga/desliga)
    html += "<div id='vektor-etq-loading-overlay' " +
        "style='display:none;position:absolute;inset:0;z-index:50;" +
               "background:rgba(255,255,255,0.78);backdrop-filter:blur(1px);" +
               "align-items:center;justify-content:center'>" +
          "<div style='background:#0f172a;color:#fff;padding:10px 14px;border-radius:10px;" +
                      "font-size:13px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,0.25)'>" +
            "Carregando informa√ß√µes ‚åõ" +
          "</div>" +
        "</div>";
    html +=   "<p style='margin:0'><b>Gastos por etiquetas</b></p>";
    html +=   "<p style='margin:0;margin-top:6px;font-size:12px;opacity:0.9'>Dica: clique em uma etiqueta para abrir as transa√ß√µes detalhadas (respeitando os filtros).</p>";

    // filtros
html += "<div style='margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end'>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:160px'>" +
          "<label style='font-size:11px;opacity:0.85'>M√™s</label>" +
          `<select data-etq="mes" id="vektor-etq-mes" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(meses, st.mes, "Todos") + "</select></div>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:220px'>" +
          "<label style='font-size:11px;opacity:0.85'>Time</label>" +
          `<select data-etq="time" id="vektor-etq-time" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(times, st.time, "Todos") + "</select></div>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:140px'>" +
          "<label style='font-size:11px;opacity:0.85'>Loja</label>" +
          `<select data-etq="loja" id="vektor-etq-loja" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(lojas, st.loja, "Todas") + "</select></div>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:260px;flex:1'>" +
          "<label style='font-size:11px;opacity:0.85'>Etiqueta</label>" +
          `<select data-etq="etiqueta" id="vektor-etq-etiqueta" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(etiquetas, st.etiqueta, "Todas") + "</select></div>";
html +=   "<button type='button' id='vektor-etq-limpar' data-etq-action='limpar' " +
          "style='background:#0f172a;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Limpar</button>";
html +=   "<button type='button' data-etq-action='periodo' " +
          "style='background:#334155;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Alterar per√≠odo</button>";
html += "</div>";

// Modal de per√≠odo (popup) ‚Äî fica sempre no DOM, mas escondido
const stPer = window.__vektorEtiquetasState || {};
const vIni = stPer.periodoIni || "";
const vFim = stPer.periodoFim || "";

html +=
  "<div id='vektor-etq-periodo-modal' style='display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)'>" +
    "<div style='background:#fff;border-radius:14px;width:min(520px,92vw);padding:16px;border:1px solid #e2e8f0;box-shadow:0 25px 60px rgba(0,0,0,0.35)'>" +
      "<div style='display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px'>" +
        "<div style='font-weight:900;color:#0f172a'>Alterar per√≠odo</div>" +
        "<button type='button' data-etq-action='periodo-fechar' style='background:transparent;border:0;font-size:18px;cursor:pointer;line-height:1'>√ó</button>" +
      "</div>" +

      "<div style='display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end'>" +
        "<div style='display:flex;flex-direction:column;gap:4px;min-width:200px;flex:1'>" +
          "<label style='font-size:11px;opacity:0.85'>Data inicial</label>" +
          "<input type='date' id='vektor-etq-per-ini-modal' value='" + escHtml_(vIni) + "' " +
          "style='border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;font-size:12px' />" +
        "</div>" +
        "<div style='display:flex;flex-direction:column;gap:4px;min-width:200px;flex:1'>" +
          "<label style='font-size:11px;opacity:0.85'>Data final</label>" +
          "<input type='date' id='vektor-etq-per-fim-modal' value='" + escHtml_(vFim) + "' " +
          "style='border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;font-size:12px' />" +
        "</div>" +
      "</div>" +

      "<div style='display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap'>" +
        "<button type='button' data-etq-action='periodo-cancelar' style='background:#e2e8f0;color:#0f172a;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Cancelar</button>" +
        "<button type='button' data-etq-action='periodo-aplicar' style='background:#005E27;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Aplicar</button>" +
      "</div>" +

      "<div id='vektor-etq-periodo-erro' style='margin-top:10px;font-size:12px;color:#b91c1c;display:none'></div>" +
    "</div>" +
  "</div>";

    // tabela principal (thead sticky)
    html += "<div style='margin-top:10px'>";
    html +=   "<div style='overflow:auto; max-height:45vh; border:1px solid #cbd5e1; border-radius:10px;'>";
    html +=     "<table id='tabela-etiquetas-clara' style='border-collapse:collapse;width:100%; font-size:12px; border:2px solid #000;'>";
    html +=       "<thead><tr>";
    const th = "background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;";
    html +=         "<th style='"+th+"position:sticky;top:0;z-index:10;text-align:left;'>Etiqueta / Tag</th>";
    html +=         "<th style='"+th+"position:sticky;top:0;z-index:10;text-align:right;'>% de uso (valor)</th>";
    html +=         "<th style='"+th+"position:sticky;top:0;z-index:10;text-align:right;'>Valor total</th>";
    html +=       "</tr></thead><tbody>";

    itens.forEach(it => {
      const etiqueta = String(it.etiqueta || "");
      const perc = formatPct(it.percentual || 0);
      const vNum = Number(it.valorTotal || 0);
      const val = formatBRL(vNum);

      let t = 0;
      if (maxValor > minValor) {
        t = (vNum - minValor) / (maxValor - minValor);
        if (t < 0) t = 0; if (t > 1) t = 1;
      }
      const alpha = 0.12 + (0.55 * t);
      const bgVal = `background: rgba(0,94,39,${alpha.toFixed(3)});`;

      html += "<tr class='vektor-etq-row' data-etiqueta=\"" + escHtml_(etiqueta) + "\" " +
              "title='Clique para abrir as transa√ß√µes desta etiqueta (respeitando os filtros).' style='cursor:pointer;'>" +
              "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;'>" + escHtml_(etiqueta) + "</td>" +
              "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;'>" + escHtml_(perc) + "</td>" +
              "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;" + bgVal + "'>" + escHtml_(val) + "</td>" +
              "</tr>";
    });

    html += "</tbody><tfoot><tr>" +
            "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;font-weight:bold;'>TOTAL</td>" +
            "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>100,0 %</td>" +
            "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>" + escHtml_(formatBRL(somaValores)) + "</td>" +
            "</tr></tfoot></table></div>";

    html += "<div style='text-align:right; margin-top:8px;'>" +
            "<button type='button' onclick=\"exportTableToCSV(this, 'gastos_por_etiquetas')\" " +
            "style='background:#005E27;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Exportar CSV</button></div>";

    html += "<div id='vektor-etq-detalhe' style='margin-top:12px;'></div>";
    html += "</div></div></div>";

    return html;
  }

  function buildDetalheHtml_(etiquetaSel, rows) {
    let h = "";
    h += "<div class='text-sm text-slate-700'>";
    h += "<p style='margin:0'><b>Transa√ß√µes da etiqueta:</b> " + escHtml_(etiquetaSel) + "</p>";
    h += "<div style='margin-top:10px;overflow:auto;max-height:45vh;border:1px solid #cbd5e1;border-radius:10px;'>";
    h += "<table id='tabela-etiquetas-detalhe' style='border-collapse:collapse;width:100%;font-size:12px;border:2px solid #000;'><thead><tr>";
    const th2 = "background:#003366;color:#fff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;position:sticky;top:0;z-index:10;";
    h += "<th style='"+th2+"text-align:left;'>Loja</th>";
    h += "<th style='"+th2+"text-align:left;'>Time</th>";
    h += "<th style='"+th2+"text-align:left;'>Data</th>";
    h += "<th style='"+th2+"text-align:left;'>Estabelecimento</th>";
    h += "<th style='"+th2+"text-align:right;'>Valor</th>";
    h += "<th style='"+th2+"text-align:left;'>Etiqueta inserida</th>";
    h += "<th style='"+th2+"text-align:left;'>Item comprado (descri√ß√£o)</th>";
    h += "</tr></thead><tbody>";

    const td = "border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;vertical-align:top;";
    rows.forEach(r => {
      h += "<tr>";
      h += "<td style='"+td+"white-space:nowrap;'>" + escHtml_(r.loja || "") + "</td>";
      h += "<td style='"+td+"white-space:nowrap;'>" + escHtml_(r.time || "") + "</td>";
      h += "<td style='"+td+"white-space:nowrap;'>" + escHtml_(r.data || "") + "</td>";
      h += "<td style='"+td+"min-width:260px;'>" + escHtml_(r.estabelecimento || "") + "</td>";
      h += "<td style='"+td+"text-align:right;white-space:nowrap;'>" + escHtml_(formatBRL(r.valor || 0)) + "</td>";
      h += "<td style='"+td+"min-width:240px;'>" + escHtml_(r.etiqueta || "") + "</td>";
      h += "<td style='"+td+"min-width:360px;'>" + escHtml_(r.descricao || "") + "</td>";
      h += "</tr>";
    });

    h += "</tbody></table></div>";
    h += "<div style='display:flex;gap:8px;justify-content:flex-end;margin-top:8px;flex-wrap:wrap'>";
    h += "<button type='button' onclick=\"exportTableToCSV(this, 'base_gastos_por_etiquetas')\" style='background:#005E27;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Exportar CSV</button>";
    h += "<button type='button' id='btn-email-etq' data-etq-action='email' style='background:#0f172a;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Enviar por e-mail</button>";

    h += "</div>";
    h += "<div id='vektor-etq-email-status' style='margin-top:8px;font-size:12px;opacity:0.9;'></div>";
    h += "</div>";

    // Modal de envio por e-mail (destinat√°rio)
h +=
  "<div id='vektor-etq-email-modal' style='display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)'>" +
    "<div style='background:#fff;border-radius:14px;width:min(520px,92vw);padding:16px;border:1px solid #e2e8f0;box-shadow:0 25px 60px rgba(0,0,0,0.35)'>" +
      "<div style='display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px'>" +
        "<div style='font-weight:900;color:#0f172a'>Enviar por e-mail</div>" +
        "<button type='button' data-etq-email-action='fechar' style='background:transparent;border:0;font-size:18px;cursor:pointer;line-height:1'>√ó</button>" +
      "</div>" +

      "<div style='display:flex;flex-direction:column;gap:6px'>" +
        "<label style='font-size:11px;opacity:0.85'>Destinat√°rio</label>" +
        "<input type='email' id='vektor-etq-email-to' placeholder='ex: gerente@centauro.com.br' " +
          "style='border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;font-size:12px' />" +
        "<div style='font-size:11px;color:#475569;margin-top:4px'>" +
          "Obs.: seu e-mail ser√° copiado automaticamente (CC), exceto se voc√™ informar o seu pr√≥prio e-mail como destinat√°rio." +
        "</div>" +
      "</div>" +

      "<div style='display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap'>" +
        "<button type='button' data-etq-email-action='cancelar' style='background:#e2e8f0;color:#0f172a;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Cancelar</button>" +

        // ‚úÖ NOVO: usar meu e-mail
        "<button type='button' data-etq-email-action='meuemail' style='background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Usar meu e-mail</button>" +

        "<button type='button' data-etq-email-action='enviar' style='background:#0f172a;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Enviar</button>" +
      "</div>" +

      "<div id='vektor-etq-email-erro' style='margin-top:10px;font-size:12px;color:#b91c1c;display:none'></div>" +
    "</div>" +
  "</div>";

    return h;
  }

  async function loadResumo_() {
  const st = window.__vektorEtiquetasState || {};

  // ‚úÖ Debounce simples (evita martelar o backend em mudan√ßas r√°pidas)
  window.__vektorEtiquetasDebounceId = window.__vektorEtiquetasDebounceId || null;
  if (window.__vektorEtiquetasDebounceId) clearTimeout(window.__vektorEtiquetasDebounceId);

  // ‚úÖ Controle de requisi√ß√£o (evita resposta velha sobrescrever a nova)
  window.__vektorEtiquetasReqSeq = (window.__vektorEtiquetasReqSeq || 0) + 1;
  const reqId = window.__vektorEtiquetasReqSeq;

  const el = document.getElementById(panelId);
  if (el) {
    // feedback imediato (UI responde na hora)
    el.style.opacity = "0.85";
    el.style.pointerEvents = "none";
  }

  // mostra overlay no centro do painel enquanto carrega
  const ov = document.querySelector("#" + panelId + " #vektor-etq-loading-overlay");
  if (ov) ov.style.display = "flex";

  window.__vektorEtiquetasDebounceId = setTimeout(() => {
    google.script.run
      .withSuccessHandler(function(res) {
        // ignora respostas antigas
        if (reqId !== window.__vektorEtiquetasReqSeq) return;

        const el2 = document.getElementById(panelId);
        if (!el2) return;

        if (!res || !res.ok) {
          el2.innerHTML = "<p style='margin:0;color:#b91c1c'><b>Falha ao carregar.</b></p>";
          el2.style.opacity = "1";
          el2.style.pointerEvents = "auto";
          const ov2 = document.querySelector("#" + panelId + " #vektor-etq-loading-overlay");
            if (ov2) ov2.style.display = "none";
          return;
        }

        el2.innerHTML = buildPainelHtml_(res);
        el2.style.opacity = "1";
        el2.style.pointerEvents = "auto";
      })
      .withFailureHandler(function(err) {
        if (reqId !== window.__vektorEtiquetasReqSeq) return;

        const el2 = document.getElementById(panelId);
        if (!el2) return;

        const msg = (err && err.message) ? err.message : String(err || "Erro");
        el2.innerHTML = "<p style='margin:0;color:#b91c1c'><b>Falha:</b> " + escHtml_(msg) + "</p>";
        el2.style.opacity = "1";
        el2.style.pointerEvents = "auto";
        const ov2 = document.querySelector("#" + panelId + " #vektor-etq-loading-overlay");
          if (ov2) ov2.style.display = "none";
      })
      .getGastosPorEtiquetasClara(st);
  }, 180); // 180ms = r√°pido, mas j√° evita ‚Äúspam‚Äù de chamadas
}

  function clearDetalhe_() {
    const det = document.querySelector("#" + panelId + " #vektor-etq-detalhe");
    if (det) det.innerHTML = "";
  }

  // 2) bind √∫nico (delega√ß√£o) ‚Äî n√£o duplica e n√£o perde listeners
  function bindOnce_() {
  if (window.__vektorEtiquetasBound) return;
  window.__vektorEtiquetasBound = true;

  document.addEventListener("change", function(e) {
    const el = e.target;
    if (!el || !el.matches) return;

    if (!el.matches("#vektor-etq-mes, #vektor-etq-time, #vektor-etq-loja, #vektor-etq-etiqueta")) return;

    const st = window.__vektorEtiquetasState || {};
    st.mes = (document.getElementById("vektor-etq-mes") || {}).value || "";
    st.time = (document.getElementById("vektor-etq-time") || {}).value || "";
    st.loja = (document.getElementById("vektor-etq-loja") || {}).value || "";
    st.etiqueta = (document.getElementById("vektor-etq-etiqueta") || {}).value || "";
    window.__vektorEtiquetasState = st;

    clearDetalhe_();
    loadResumo_();
  });

  document.addEventListener("click", function(e) {
    const btnLimpar = e.target && e.target.closest && e.target.closest("[data-etq-action='limpar']");
    const btnPeriodo = e.target && e.target.closest && e.target.closest("[data-etq-action='periodo']");

    if (btnPeriodo) {
  const modal = document.getElementById("vektor-etq-periodo-modal");
  if (!modal) return;

  // pr√©-preenche com o state atual
  const st = window.__vektorEtiquetasState || {};
  const iniEl = document.getElementById("vektor-etq-per-ini-modal");
  const fimEl = document.getElementById("vektor-etq-per-fim-modal");
  if (iniEl) iniEl.value = st.periodoIni || "";
  if (fimEl) fimEl.value = st.periodoFim || "";

  const err = document.getElementById("vektor-etq-periodo-erro");
  if (err) { err.style.display = "none"; err.textContent = ""; }

  modal.style.display = "flex";
  return;
}

const btnFecharPeriodo = e.target && e.target.closest && e.target.closest("[data-etq-action='periodo-fechar'],[data-etq-action='periodo-cancelar']");
if (btnFecharPeriodo) {
  const modal = document.getElementById("vektor-etq-periodo-modal");
  if (modal) modal.style.display = "none";
  return;
}

const btnAplicarPeriodo = e.target && e.target.closest && e.target.closest("[data-etq-action='periodo-aplicar']");
if (btnAplicarPeriodo) {
  const iniEl = document.getElementById("vektor-etq-per-ini-modal");
  const fimEl = document.getElementById("vektor-etq-per-fim-modal");
  const ini = iniEl ? String(iniEl.value || "").trim() : "";
  const fim = fimEl ? String(fimEl.value || "").trim() : "";

  const err = document.getElementById("vektor-etq-periodo-erro");
  function showErr(msg){
    if (!err) return;
    err.style.display = "block";
    err.textContent = msg;
  }

  if (!ini || !fim) { showErr("Preencha data inicial e final."); return; }
  if (ini > fim) { showErr("Per√≠odo inv√°lido: a data inicial n√£o pode ser maior que a final."); return; }

  // Atualiza state e zera filtros do painel
  const st = window.__vektorEtiquetasState || {};
  st.periodoIni = ini;
  st.periodoFim = fim;

  st.mes = "";
  st.time = "";
  st.loja = "";
  st.etiqueta = "";
  window.__vektorEtiquetasState = st;

  // Fecha modal
  const modal = document.getElementById("vektor-etq-periodo-modal");
  if (modal) modal.style.display = "none";

  // IMPORTANTE: n√£o chamar listarGastosPorEtiquetasClara() (isso gera mensagem e re-fluxo).
  clearDetalhe_();
  loadResumo_();
  return;
}

    if (btnLimpar) {
      const st = window.__vektorEtiquetasState || {};
        window.__vektorEtiquetasState = { 
          mes:"", time:"", loja:"", etiqueta:"",
          periodoIni: st.periodoIni || "",
          periodoFim: st.periodoFim || ""
        };
      clearDetalhe_();
      loadResumo_();
      return;
    }

    const tr = e.target && e.target.closest && e.target.closest(".vektor-etq-row");
    if (!tr) return;

    const etiquetaSel = tr.getAttribute("data-etiqueta") || "";
    const st = window.__vektorEtiquetasState || {};
    const payload = { 
          mes: st.mes || "", time: st.time || "", loja: st.loja || "",
          etiqueta: etiquetaSel,
          periodoIni: st.periodoIni || "",
          periodoFim: st.periodoFim || ""
        };

    const wrapId = "vektor-etq-detailwrap-" + Date.now();

    renderBotMessage(
      "HTML:<div class='text-sm text-slate-700' id='" + wrapId + "' style='margin:0'>" +
        "<div style='margin-top:0' id='" + wrapId + "-content'>" +
          "<p style='margin:0'><b>Carregando transa√ß√µes da etiqueta</b> " + escHtml_(etiquetaSel) + "‚Ä¶</p>" +
        "</div>" +
      "</div>"
    );

    google.script.run
      .withSuccessHandler(function(resp) {
        const rows = resp && resp.ok && Array.isArray(resp.rows) ? resp.rows : [];
        const contentEl = document.getElementById(wrapId + "-content");
        if (!contentEl) return;

        if (!rows.length) {
          contentEl.innerHTML = "<p style='margin:0'>Sem transa√ß√µes para os filtros atuais.</p>";
          return;
        }

        contentEl.innerHTML = buildDetalheHtml_(etiquetaSel, rows);

        const btnEmail = document.querySelector("#" + wrapId + " #btn-email-etq");
        if (btnEmail) {
        btnEmail.addEventListener("click", function() {

    const modal = document.querySelector("#" + wrapId + " #vektor-etq-email-modal");
    if (!modal) return;

    const toEl   = document.querySelector("#" + wrapId + " #vektor-etq-email-to");
    const errEl  = document.querySelector("#" + wrapId + " #vektor-etq-email-erro");
    const btnSend = modal.querySelector("[data-etq-email-action='enviar']");

    const meuEmail = (typeof USER_EMAIL_REPLACED !== "undefined"
    ? String(USER_EMAIL_REPLACED || "").trim()
    : "");

    // limpa estado visual
    if (errEl) { errEl.style.display = "none"; errEl.textContent = ""; }
    if (toEl) toEl.value = "";

    // abre modal
    modal.style.display = "flex";

    // bind √∫nico do modal (para n√£o duplicar listeners)
    if (modal.dataset.bound === "1") return;
    modal.dataset.bound = "1";

    function closeModal_() {
      modal.style.display = "none";
      if (errEl) { errEl.style.display = "none"; errEl.textContent = ""; }
    }

    modal.addEventListener("click", function(ev) {
  // ‚úÖ novo bot√£o: preencher destinat√°rio com meu e-mail
      const useMyBtn = ev.target && ev.target.closest && ev.target.closest("[data-etq-email-action='meuemail']");
      if (useMyBtn) {
        if (toEl) toEl.value = meuEmail || "";
        if (errEl) { errEl.style.display = "none"; errEl.textContent = ""; }
        if (toEl) toEl.focus();
        return;
      }

      // fechar/cancelar
      const closeBtn = ev.target && ev.target.closest && ev.target.closest("[data-etq-email-action='fechar'],[data-etq-email-action='cancelar']");
      if (closeBtn) closeModal_();
    });

    btnSend.addEventListener("click", function() {
      const emailDestino = toEl ? String(toEl.value || "").trim() : "";
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailDestino || !emailRegex.test(emailDestino)) {
        if (errEl) {
          errEl.style.display = "block";
          errEl.textContent = "Informe um e-mail v√°lido para o destinat√°rio.";
        }
        return;
      }

      // trava bot√£o enquanto envia
      btnSend.disabled = true;
      btnSend.textContent = "Enviando...";

      // envia para o back com destinat√°rio informado
      const payloadEmail = Object.assign({}, payload, { emailDestino: emailDestino });

      google.script.run
          .withSuccessHandler(function(rEmail) {
            btnSend.disabled = false;
            btnSend.textContent = "Enviar";

            // Se o back-end retornou erro, mostra no modal e N√ÉO fecha
            if (!rEmail || rEmail.ok !== true) {
              const msg = (rEmail && rEmail.error) ? String(rEmail.error) : "Falha ao enviar o e-mail.";
              if (errEl) {
                errEl.style.display = "block";
                errEl.textContent = msg;
              }
              return;
            }

            // Sucesso: fecha modal e mostra status no rodap√© (opcional)
            closeModal_();

            const statusEl = document.querySelector("#" + wrapId + " #vektor-etq-email-status");
            if (statusEl) {
              const to = (rEmail && rEmail.to) ? rEmail.to : emailDestino;
              statusEl.innerHTML =
                "<span style='color:#16a34a;font-weight:800;'>E-mail enviado:</span> <b>Base de Gastos por Etiquetas</b> para <b>" + escHtml_(to) + "</b>.";
            }
          })
        .withFailureHandler(function(err) {
          btnSend.disabled = false;
          btnSend.textContent = "Enviar";

          if (errEl) {
            errEl.style.display = "block";
            errEl.textContent = (err && err.message) ? err.message : String(err || "Falha ao enviar.");
          }
        })
        .enviarEmailGastosPorEtiquetasClara(payloadEmail);
    });

  });
}
      })
      .withFailureHandler(function(err) {
        const contentEl = document.getElementById(wrapId + "-content");
        if (!contentEl) return;
        const msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
        contentEl.innerHTML = "<p style='margin:0;color:#b91c1c'><b>Falha:</b> " + escHtml_(msg) + "</p>";
      })
      .getTransacoesPorEtiquetaClara(payload);
  });
}

  // Mensagem (bolha) separada ‚Äî aparece s√≥ uma vez por sess√£o do painel
if (!window.__vektorEtiquetasIntroShown) {
  window.__vektorEtiquetasIntroShown = true;
  await renderBotMessage(
    "HTML:<p class='text-sm text-slate-700' style='margin:0'>" +
      "Vou montar o painel de <b>Gastos por etiquetas</b> com filtros e detalhamento." +
    "</p>"
  );
}

  // execu√ß√£o
  await ensurePanelBubble_();
  bindOnce_();
  const elBoot = document.getElementById(panelId);
  if (elBoot) {
    elBoot.innerHTML = "<p style='margin:0;opacity:0.9'>Carregando dados do per√≠odo selecionado, pode demorar um pouco...</p>";
  }
  await loadResumo_();
}

// Backward-compat: evita quebra caso algum trecho ainda chame o nome antigo
function listarEtiquetasClara() {
  return listarGastosPorEtiquetasClara();
}

    /* ========= ENVIO (ENTER / BOT√ÉO) ========= */

    function enviarMensagem() {

    // üÜï cancela timeout de pend√™ncias ao responder
    if (typeof pendenciasTimeoutId !== "undefined" && pendenciasTimeoutId) {
        clearTimeout(pendenciasTimeoutId);
        pendenciasTimeoutId = null;
    }

    const texto = userInput.value.trim();
    if (!texto) return;

    // Mostra a mensagem do usu√°rio no chat
    renderUserMessage(texto);
    userInput.value = "";  // limpa aqui, sempre

    // üåü FLUXO ESPECIAL: estamos aguardando o NOME para o Termo de Responsabilidade
    if (window.vektorTermoAguardandoNome && window.vektorTermoPending) {

        const nomeCompleto = texto;

        const payload = Object.assign({}, window.vektorTermoPending, {
            usuarioNome: nomeCompleto
        });

        // Limpa o estado ANTES da chamada para evitar duplicidade
        window.vektorTermoAguardandoNome = false;
        window.vektorTermoPending = null;

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Registrando o seu Termo de Responsabilidade. Aguarde...</p>"
        );

        google.script.run
            .withSuccessHandler(function (res) {
                if (res && res.ok) {
                    // Mensagem principal + link do Drive na mesma frase
                    renderBotMessage(
                        "HTML:" +
                        "<p class='text-sm text-slate-700'>" +
                        "Termo de Responsabilidade salvo com sucesso para <b>" + nomeCompleto + "</b>. " +
                        (res.fileUrl
                            ? "Link interno (Drive): <a href='" + res.fileUrl +
                            "' target='_blank' class='text-slate-700 underline'>Abrir Termo</a>."
                            : ""
                        ) +
                        "</p>"
                    );

                    // Mensagem complementar em outra bolha
                    setTimeout(function () {
                        renderBotMessage(
                            "HTML:" +
                            "<p class='text-sm text-slate-700'>" +
                            "Caso o cart√£o ainda esteja impossibilitado de uso devido ao n√£o envio do Termo assinado, " +
                            "em breve ele estar√° ativo. Fique de olho no aplicativo da Clara." +
                            "</p>"
                        );
                    }, 3000);

                } else {
                    // Caso o backend tenha retornado ok: false
                    renderBotMessage(
                        "HTML:" +
                        "<p class='text-sm text-red-700'>N√£o consegui salvar o termo. Motivo: " +
                        (res && res.error ? res.error : "erro desconhecido") +
                        "</p>"
                    );
                }
            })
            .withFailureHandler(function (err) {
                // Erro de comunica√ß√£o Apps Script
                renderBotMessage(
                    "HTML:" +
                    "<p class='text-sm text-red-700'>Falha na comunica√ß√£o ao salvar o termo: " +
                    (err && err.message ? err.message : err) +
                    "</p>"
                );
            })
            .salvarTermoResponsabilidade(payload);

        // IMPORTANTE: n√£o segue para o fluxo normal de pergunta/resposta
        return;
    }

    // ===== FLUXO NORMAL DO VEKTOR (mantido como j√° estava) =====

    // Normaliza o texto para busca de inten√ß√£o
    const norm = normalize(texto || "");

    // =====================================================
    // ‚úÖ FREQU√äNCIA DE USO CLARA (POR TIME OU LOJA)
    // =====================================================
    if (norm.startsWith("frequencia de uso clara")) {

        let tipo = "";
        let valor = "";

        // Captura "para time ..." ou "para o time ..." e para antes do per√≠odo ("nos ultimos X meses")
        const mTime = norm.match(/\bpara\s+(?:o\s+)?time\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:no|nos|na|nas)\s+ultim[oa]s?\b|$)/i);

        // Captura "para loja ..." ou "para a loja ..." e para antes do per√≠odo
        const mLoja = norm.match(/\bpara\s+(?:a\s+)?loja\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:no|nos|na|nas)\s+ultim[oa]s?\b|$)/i);

        if (mLoja) {
            tipo = "loja";

            // ‚úÖ pega SOMENTE o n√∫mero da loja (funciona com autocomplete: "0242 - Loja X")
            const matchNum = (mLoja[1] || "").match(/\d{1,6}/);
            valor = matchNum ? matchNum[0] : "";

            if (!valor) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o n√∫mero da loja. Ex.: <b>frequ√™ncia de uso Clara para a loja 242</b>.</p>"
                );
                return;
            }

        } else if (mTime) {
            tipo = "time";
            valor = (mTime[1] || "").trim();

            // ‚úÖ remove complemento de per√≠odo do "valor" do time (caso venha colado)
            valor = valor
                .replace(/\s+(no|nos|na|nas)\s+ultim[oa]s?\s+.*$/i, "")
                .trim();

            // fallback: corta em " ultimos " ou " ultimo " se ainda sobrar algo
            valor = valor
                .split(" ultimos ")[0]
                .split(" ultimo ")[0]
                .trim();

            if (!valor) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o nome do time. Ex.: <b>frequ√™ncia de uso Clara para o time Furac√£o Sul</b>.</p>"
                );
                return;
            }

        } else {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Me diga se √© por <b>time</b> ou por <b>loja</b>. Ex.: <b>frequ√™ncia de uso Clara para a loja 242</b>.</p>"
            );
            return;
        }

        const mesesBack = vektorParseMesesBack(norm);

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Consultando frequ√™ncia de uso‚Ä¶</p>"
        );

        google.script.run
            .withSuccessHandler(vektorRenderTabelaFrequenciaUso)
            .withFailureHandler(function (err) {
                console.error(err);
                renderBotMessage(
                    "HTML:<p class='text-sm text-slate-700'>Falha ao consultar frequ√™ncia de uso.</p>"
                );
            })
            .getFrequenciaUsoClara(tipo, valor, mesesBack);

        return; // ‚õî IMPORTANTE: impede cair no fluxo gen√©rico
    }

    // =====================================================
    // ‚úÖ LISTA ITENS COMPRADOS (ADM) ‚Äî por TIME ou LOJA + per√≠odo
    // =====================================================
    // ‚úÖ aceita: "lista itens comprados..." e tamb√©m "itens comprados..."
        const isCmdListaItens =
          /^\s*lista(\s+de)?\s+itens\s+comprad/i.test(norm) ||
          /^\s*itens\s+comprad/i.test(norm);

        if (isCmdListaItens) {

        // ‚úÖ Caso geral (sem loja/time)
if (/\bno\s+geral\b/i.test(norm)) {
  const periodo = extrairIntervaloDatas(texto);
  if (!periodo || !periodo.dataInicio || !periodo.dataFim) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Informe um per√≠odo. Ex.: <b>itens comprados no geral de 01/12/2025 a 15/12/2025</b> (ou use <b>este m√™s</b>, <b>√∫ltimos 30 dias</b> etc.).</p>"
    );
    return;
  }

  function fmtBR(d) {
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  const dataIni = fmtBR(periodo.dataInicio);
  const dataFim = fmtBR(periodo.dataFim);

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Consultando itens comprados <b>no geral</b> de <b>" + dataIni + "</b> a <b>" + dataFim + "</b>‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(vektorRenderTabelaListaItensComprados)
    .withFailureHandler(function(err){
      console.error(err);
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao listar itens comprados.</p>");
    })
    .getListaItensCompradosClara("geral", "", dataIni, dataFim, 300); // <- ajuste o limite como preferir

  return;
}

        let tipo = "";
        let valor = "";

        // Captura ‚Äúpor time ...‚Äù
        const mTime = norm.match(/\b(?:por|para)\s+(?:o|os)?\s*times?\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:de|no|nos|na|nas|nessa|nesta|neste|ultima|√∫ltima|ultimos|√∫ltimos|semana|mes|m√™s)\b|$)/i);

        // Captura ‚Äúpor loja ...‚Äù
        const mLoja = norm.match(/\b(?:por|para)\s+(?:a|as)?\s*lojas?\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:de|no|nos|na|nas|nessa|nesta|neste|ultima|√∫ltima|ultimos|√∫ltimos|semana|mes|m√™s)\b|$)/i);

        if (mTime && mTime[1]) {
            tipo = "time";
            valor = (mTime[1] || "").trim();
        } else if (mLoja && mLoja[1]) {
            tipo = "loja";

            // ‚úÖ pega SOMENTE o n√∫mero da loja (evita "0255 - CE255 - ..." quebrar filtro)
            const matchNum = (mLoja[1] || "").match(/\d{1,6}/);
            valor = matchNum ? matchNum[0] : "";
        } else {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Me diga se √© por <b>loja</b> ou por <b>time</b>. Ex.: <b>lista itens comprados por loja 0287 de 01/12/2025 a 15/12/2025</b>.</p>"
            );
            return;
        }

        // ‚úÖ remove "este m√™s / neste m√™s / esse m√™s / nesse m√™s" que veio grudado no nome do time/loja
        valor = valor
          .replace(/\b(neste|nesta|este|esta|nesse|nessa|esse|essa)\s+m[e√™]s\b.*$/i, "")
          .trim();

        if (!valor) {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o filtro. Ex.: <b>lista itens comprados por loja 0287 este m√™s</b> ou <b>...por time Lobos SP este m√™s</b>.</p>"
            );
            return;
        }

        // Extrai per√≠odo usando o parser padr√£o do projeto
        const periodo = extrairIntervaloDatas(texto);
        if (!periodo || !periodo.dataInicio || !periodo.dataFim) {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Informe um per√≠odo. Ex.: <b>de 01/12/2025 a 15/12/2025</b> (ou use <b>este m√™s</b>, <b>√∫ltimos 30 dias</b> etc.).</p>"
            );
            return;
        }

        function fmtBR(d) {
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        const dataIni = fmtBR(periodo.dataInicio);
        const dataFim = fmtBR(periodo.dataFim);

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Consultando itens comprados (" + tipo + ": <b>" + valor + "</b>) de <b>" + dataIni + "</b> a <b>" + dataFim + "</b>‚Ä¶</p>"
        );

        google.script.run
            .withSuccessHandler(vektorRenderTabelaListaItensComprados)
            .withFailureHandler(function (err) {
                console.error(err);
                renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao listar itens comprados.</p>");
            })
            .getListaItensCompradosClara(tipo, valor, dataIni, dataFim, 15);

        return; // ‚õî n√£o cair no fluxo gen√©rico
    }

    // =====================================================
// ‚úÖ RELA√á√ÉO DE SALDOS (ADM) ‚Äî por TIME / LOJA / GERAL
// Exemplos:
// - "rela√ß√£o de saldos geral"
// - "rela√ß√£o de saldos do time lobos sp"
// - "rela√ß√£o de saldos da loja 0242"
// =====================================================
const isCmdRelacaoSaldos = /^\s*rela[c√ß][a√£]o\s+de\s+saldos\b/i.test(norm);

if (isCmdRelacaoSaldos) {

  let tipo = "geral";
let valor = "";

// Geral
if (/\b(no\s+geral|geral)\b/i.test(norm)) {
  tipo = "geral";
  valor = "";
} else {
  // Time
  const mTime = norm.match(/\bdo\s+time\s+(.+?)\s*$/i);

  if (mTime && mTime[1]) {
    tipo = "time";
    valor = (mTime[1] || "").trim();
  } else {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Use: <b>Rela√ß√£o de saldos geral</b> ou <b>Rela√ß√£o de saldos do time X</b>.</p>"
    );
    return;
  }
}

  // Data limite = hoje - 2 dias (D-2), formato dd/MM/yyyy
(function () {
  const d = new Date();
  d.setDate(d.getDate() - 2);

  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  const dataLimite = `${dd}/${mm}/${yyyy}`;

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Consultando rela√ß√£o de saldos... " +
      "Lembrando que a an√°lise √© feita at√© o dia <b>" + dataLimite + "</b>, " +
      "devido ao conjunto de transa√ß√µes consultadas sempre serem com o status de <b>Aprovada</b>.</p>"
  );
})();

  google.script.run
    .withSuccessHandler(function (res) {
      vektorRenderTabelaRelacaoSaldos(res, tipo);
    })
    .withFailureHandler(function (err) {
      console.error(err);
      var msg = (err && (err.message || err.toString)) ? (err.message || String(err)) : "Falha ao consultar rela√ß√£o de saldos.";
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + msg + "</p>");
    })
    .getRelacaoSaldosClara(tipo, valor);

  return; // ‚õî importante
}

// =====================================================
// ‚úÖ COMPARATIVO FATURA ATUAL VS ANTERIOR (CHAT)
// Comando: "comparar fatura" / "comparar fatura atual vs anterior"
// =====================================================
const isCmdCompararFatura = /^\s*compar(ar|a√ß√£o|acao)\s+fatura\b/i.test(norm) ||
                            /^\s*fatura\s+atual\s+vs\s+anterior\b/i.test(norm);

if (isCmdCompararFatura) {
  renderBotMessage("HTML:<p class='text-sm text-slate-700'>Efetuando c√°lculos para demonstrar compara√ß√£o...</p>");

  google.script.run
    .withSuccessHandler(function(res){
      try {
        renderTabelaComparativoFaturas(res);
      } catch (e) {
        console.error("Erro ao renderizar comparativo de faturas:", e);
        renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Erro ao renderizar tabela:</b> " + (e && e.message ? e.message : e) + "</p>");
      }
    })
    .withFailureHandler(function(err){
      console.error("Falha na consulta comparativo faturas:", err);
      var msg = (err && err.message) ? err.message : JSON.stringify(err);
      renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Falha ao consultar comparativo de faturas:</b> " + msg + "</p>");
    })
    .getComparativoFaturasClaraParaChat();

  return; // ‚õî importante
}

// =====================================================
// ‚úÖ TABELA DE ESTORNOS (ADM)
// Comandos:
// - "tabela de estornos"
// - "tabela de estornos do time X"
// =====================================================
const isCmdTabelaEstornos = /^\s*tabela\s+de\s+estornos\b/i.test(norm);

if (isCmdTabelaEstornos) {

  const m = norm.match(/tabela\s+de\s+estornos\s+do\s+time\s+(.+)$/i);

  let tipoFiltro = "geral";
  let valorFiltro = "";

  if (m && m[1]) {
    tipoFiltro = "time";
    valorFiltro = (texto || "").split(/tabela\s+de\s+estornos\s+do\s+time/i)[1] || "";
    valorFiltro = valorFiltro.trim();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-500'>Buscando estornos‚Ä¶</p>"
  );

  google.script.run
  .withSuccessHandler(function (res) {
    // Se voc√™ j√° recebe um HTML direto ou um array, renderiza como antes
    // Se o seu backend j√° retorna {ok:false,error:"..."} em alguns casos:
    if (res && res.ok === false) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>" +
        (res.error ? res.error : "N√£o dispon√≠vel para o seu perfil.") +
        "</p>"
      );
      return;
    }

    vektorRenderTabelaEstornos(res, tipoFiltro);
  })
  .withFailureHandler(function (err) {
    const msg = (err && err.message) ? err.message : String(err || "");

    // Permiss√£o (RBAC)
    if (msg.toLowerCase().includes("n√£o dispon√≠vel para o seu perfil")) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Esse comando n√£o est√° dispon√≠vel para o seu perfil.</p>"
      );
      return;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Erro ao buscar estornos: " +
      (msg ? msg : "erro desconhecido") +
      "</p>"
    );
  })
  .getTabelaEstornosClara(tipoFiltro, valorFiltro);

return; // ‚õî mant√©m isso
}

// =====================================================
// ‚úÖ POSS√çVEL USO IRREGULAR (ADM)
// Comando: "poss√≠vel uso irregular"
// =====================================================
const isCmdUsoIrregular = /^\s*poss(i|√≠)vel\s+uso\s+irregular\b/i.test(norm);

if (isCmdUsoIrregular) {

  // üîí Apenas Administrador (mesmo padr√£o do estornos)
  if (typeof USER_ROLE_REPLACED !== "undefined" && USER_ROLE_REPLACED !== "Administrador") {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Esse comando est√° dispon√≠vel apenas para perfil <b>Administrador</b>.</p>"
    );
    return;
  }

  renderBotMessage(
  "HTML:" +
  "<div class='text-sm text-slate-700'>" +
    "<p style='margin:0 0 6px 0; font-weight:700;'>Poss√≠vel uso irregular ‚Äî selecione o escopo da an√°lise:</p>" +
    "<div style='display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;'>" +

      "<button type='button' " +
        "onclick=\"window.vektorExecutarUsoIrregular('7d')\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Padr√£o (7 dias)" +
      "</button>" +

      "<button type='button' " +
        "onclick=\"window.vektorExecutarUsoIrregular('ciclo')\" " +
        "style='background:#334155;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Ciclo 06‚Äì05" +
      "</button>" +

      "<button type='button' " +
        "onclick=\"window.vektorExecutarUsoIrregular('full')\" " +
        "style='background:#B91C1C;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Base toda (investiga√ß√£o)" +
      "</button>" +

    "</div>" +
    "<p style='margin:8px 0 0 0; font-size:12px; color:#64748B;'>" +
      "Dica: a op√ß√£o <b>Base toda</b> pode ser mais lenta e tende a gerar mais volume (use para investiga√ß√£o pontual)." +
    "</p>" +
  "</div>"
);

return;

}

// =====================================================
// ‚úÖ LOJAS OFENSORAS (ADM) ‚Äî hist√≥rico de pend√™ncias
// Comando: "lojas ofensoras"
// =====================================================
const isCmdLojasOfensoras = /^\s*lojas\s+ofensoras\b/i.test(norm);

if (isCmdLojasOfensoras) {

  // üîí Apenas Administrador
  if (typeof USER_ROLE_REPLACED !== "undefined" && USER_ROLE_REPLACED !== "Administrador") {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Esse comando est√° dispon√≠vel apenas para perfil <b>Administrador</b>.</p>"
    );
    return;
  }

  renderBotMessage("HTML:<p class='text-sm text-slate-700'>Consultando lojas ofensoras‚Ä¶</p>");

  google.script.run
  .withSuccessHandler(function(res){
    try {
      renderTabelaLojasOfensoras(res);
    } catch (e) {
      console.error("Erro ao renderizar tabela lojas ofensoras:", e);
      renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Erro ao renderizar tabela:</b> " + (e && e.message ? e.message : e) + "</p>");
    }
  })
  .withFailureHandler(function(err){
    console.error("Falha na consulta lojas ofensoras:", err);
    var msg = (err && err.message) ? err.message : JSON.stringify(err);
    renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Falha ao consultar lojas ofensoras:</b> " + msg + "</p>");
  })
  .getLojasOfensorasParaChat(60);

  return; // ‚õî importante
}

    // ‚úÖ Agora sim: gera a resposta (e ent√£o usa ACOES)
    const resposta = gerarRespostaDoBot(texto);

   // ‚úÖ Gastos por etiquetas -> abre calend√°rio + tabela
    if (resposta === "ACAO_GASTOS_ETIQUETAS_CLARA") {
      abrirPeriodoGastosEtiquetas_();
      return;
    }

    // ‚úÖ Listagem de etiquetas -> resposta explicativa (cat√°logo)
    if (resposta === "ACAO_LISTAR_ETIQUETAS_CLARA") {
      try {
        renderBotMessage(respCatalogoEtiquetas());
      } catch (e) {
        console.error("Erro ao montar cat√°logo de etiquetas:", e);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui montar a listagem de etiquetas agora.</p>" +
          "<p class='text-xs text-slate-500 mt-1'>Detalhe: " + (e && e.message ? String(e.message) : String(e || "‚Äî")) + "</p>"
        );
      }
      return;
    }

    if (resposta === "ACAO_FREQUENCIA_USO_CLARA") {
        vektorMostrarFrequenciaUsoClara(texto);
        return;
    }

    // Se a inten√ß√£o for listar demiss√µes, s√≥ ADM pode ver
    if (resposta === "ACAO_LISTA_DEMISSOES") {
        if (USER_ROLE_CLEAN !== "Administrador") {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Esse comando est√° dispon√≠vel apenas para perfil Administrador.</p>"
            );
            return;
        }

        window.vektorMostrarTabelaDemissoesAdmin();
        return;
    }

    if (resposta) renderBotMessage(resposta);

    // Depois de responder normalmente, avalia se faz sentido sugerir algo do Manual da Clara
    try {
        vektorSugerirManualAPartirDaPergunta(texto);
    } catch (e) {
        console.warn("Erro ao tentar sugerir Manual da Clara:", e);
    }

    // E tamb√©m sugest√µes gerais (pol√≠tica, relat√≥rios, pend√™ncias, etc.)
    try {
        vektorSugerirTopicosGerais(texto);
    } catch (e) {
        console.warn("Erro ao tentar sugerir t√≥picos gerais:", e);
    }

    userInput.focus();
}

        // ====== RESPOSTA DOS BOT√ïES "SIM" / "N√ÉO" PARA PEND√äNCIAS ======
        window.vektorResponderConfirmacaoPendencias = function (resposta) {
  try {
    // se n√£o estiver aguardando confirma√ß√£o, ignora
    if (typeof estadoPendencias === "undefined" ||
        estadoPendencias !== "aguardando_confirmacao_email") {
      return;
    }

    // Garante que temos os elementos necess√°rios
    if (!window.userInput || typeof enviarMensagem !== "function") {
      console.warn("userInput ou enviarMensagem n√£o dispon√≠veis.");
      return;
    }

    // Preenche a caixa de texto com 'sim' ou 'n√£o' e reaproveita todo o fluxo j√° existente
    userInput.value = resposta;
    enviarMensagem();
  } catch (e) {
    console.error("Erro em vektorResponderConfirmacaoPendencias:", e);
  }
};

// ====== INFO INICIAL POR PERFIL (apenas Administrador) ======
let vektorJaPerguntouInfoIniciais = false;

window.vektorPerguntarInformacoesIniciais = function () {
  try {
    // S√≥ pergunta para Administrador
    if (USER_ROLE_CLEAN !== "Administrador") return;

    // Evita perguntar repetidamente
    if (vektorJaPerguntouInfoIniciais) return;
    vektorJaPerguntouInfoIniciais = true;

    const html =
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>" +
          "Se voc√™ quer ver um resumo das principais informa√ß√µes de utiliza√ß√£o do cart√£o Clara " +
          "(maiores transa√ß√µes, times com mais pend√™ncias, estabelecimentos mais usados, categorias de gasto e √∫ltimas faturas), clique no bot√£o abaixo" +
        "</p>" +
        "<div class='mt-2 flex gap-2'>" +
          "<button type='button' " +
                  "class='px-3 py-1 rounded bg-emerald-600 text-white text-xs' " +
                  "onclick=\"window.vektorRespostaInfoIniciais('sim')\">" +
            "Mostrar resumo" +

          "</button>" +
        "</div>" +
      "</div>";

    renderBotMessage(html);
  } catch (e) {
    console.error("Erro ao perguntar info iniciais:", e);
  }
};

window.vektorMostrarTabelaDemissoesAdmin = function () {
  try {
    google.script.run
      .withSuccessHandler(function (res) {
        try {
          if (!res || !res.ok) {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar as demiss√µes no momento.</p>"
            );
            return;
          }

          const rows = Array.isArray(res.rows) ? res.rows : [];

          // Se n√£o tiver demiss√µes desde a data, mostra mensagem curta e segue o fluxo
          if (!rows.length) {
            renderBotMessage(
              "HTML:<div class='text-sm text-slate-700'>" +
                "<p><b>Conforme consulta efetuada no sistema de informa√ß√µes do RH (Senior) atrav√©s da tabela de informa√ß√µes no BigQuery</b>, n√£o h√° demiss√µes de gerentes de lojas registradas desde <b>01/12/2025</b>.</p>" +
              "</div>"
            );
            return;
          }

          // Monta tabela
                let html =
                  "<div class='text-sm'>" +
                    "<p>Conforme consulta efetuada no sistema de informa√ß√µes do RH (Senior) atrav√©s da tabela de informa√ß√µes no BigQuery, segue abaixo tabela com as √∫ltimas demiss√µes de <b>Gerente de loja</b> ocorridas:</p>" +
                    "<div class='mt-2 overflow-x-auto'>" +
                      "<table class='min-w-full text-xs border border-slate-200'>" +
                        "<thead class='bg-slate-100'>" +
                          "<tr>" +
                            "<th class='border px-2 py-1 text-center'>Matr√≠cula</th>" +
                            "<th class='border px-2 py-1 text-center'>E-mail</th>" +
                            "<th class='border px-2 py-1 text-center'>Cargo</th>" +
                            "<th class='border px-2 py-1 text-center'>Filial</th>" +
                            "<th class='border px-2 py-1 text-center'>Afastamento</th>" +
                            "<th class='border px-2 py-1 text-center'>Data Afastamento</th>" +
                          "</tr>" +
                        "</thead>" +
                        "<tbody class='!text-black'>";

                rows.forEach(function (r) {
                  html +=
                    "<tr>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.matricula || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.des_email_corporativo || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.des_titulo_cargo || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.nom_apelido_filial || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.nom_afastamento || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.dat_afastamento || "") + "</td>" +
                    "</tr>";
                });

          html +=
                  "</tbody>" +
                "</table>" +
              "</div>" +
              "<p class='mt-2'><b>Aten√ß√£o:</b> Verifique se o cart√£o do(a) Gerente j√° est√° bloqueado e cancelado, assim como o perfil deve ser desabilitado na base da Clara tamb√©m.</p>" +
            "</div>";

          renderBotMessage("HTML:" + html);

        } catch (e) {
          console.error("Erro ao renderizar tabela de demiss√µes:", e);
        }
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script (demiss√µes):", err);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as demiss√µes no BigQuery.</p>"
        );
      })
      .getUltimasDemissoesGerentes();

  } catch (e) {
    console.error("Erro geral em vektorMostrarTabelaDemissoesAdmin:", e);
  }
};

window.vektorMostrarFrequenciaUsoClara = function (textoOriginal) {
  try {
    const norm = normalize(textoOriginal || "");

    // 1) Detecta filtro: time ou loja
    let filtroTipo = "";
    let filtroValor = "";

    // tenta achar time pelo seu dicion√°rio oficial
    const timeEncontrado = encontrarTimeNaMensagem(textoOriginal || "");

    // tenta achar loja (n√∫mero)
    const mLoja = (textoOriginal || "").match(/\bloja\s*(\d{1,6})\b/i);
    const lojaEncontrada = mLoja ? mLoja[1] : "";

    if (lojaEncontrada) {
      filtroTipo = "loja";
      filtroValor = lojaEncontrada;
    } else if (timeEncontrado) {
      filtroTipo = "time";
      filtroValor = timeEncontrado;
    } else {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Para eu calcular a frequ√™ncia, digite exatamente assim: <b>frequ√™ncia de uso Clara para o time NOME_DO_TIME</b> ou <b>frequ√™ncia de uso Clara para a loja 123</b>.</p>"
      );
      return;
    }

    // 2) Chama backend
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Beleza. Vou calcular a <b>frequ√™ncia de uso</b> do Clara " +
      (filtroTipo === "time" ? "para o time <b>" + filtroValor + "</b>" : "para a loja <b>" + filtroValor + "</b>") +
      " e j√° te trago a tabela.</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          if (!res || !res.ok) {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>N√£o consegui calcular a frequ√™ncia de uso no momento.</p>"
            );
            return;
          }

          const linhas = Array.isArray(res.linhas) ? res.linhas : [];
          const insight = res.insight || "";

          if (!linhas.length) {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes para esse filtro no per√≠odo analisado.</p>"
            );
            return;
          }

          // 3) Monta tabela (cabe√ßalho centralizado e texto preto nas linhas)
          let html =
            "<div class='text-sm text-slate-700'>" +
              "<p><b>Frequ√™ncia de uso do cart√£o Clara</b> (" +
                (filtroTipo === "time" ? "Time: " + filtroValor : "Loja: " + filtroValor) +
              ")</p>" +
              "<div class='mt-2 overflow-x-auto'>" +
                "<table class='min-w-full text-xs border border-slate-200' style='color:#000;'>" +
                  "<thead class='bg-slate-100'>" +
                    "<tr>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Loja</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Uso Sem.</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Uso M√™s</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Uso Total</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Dias</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Intervalo M√©dio</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Padr√£o de uso</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. x Valor</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Consist√™ncia</th>" +
                    "</tr>" +
                  "</thead>" +
                  "<tbody>";

          linhas.forEach(function (r) {
            html +=
              "<tr style='color:#000;'>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.loja || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqSem || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqMes || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqTotal || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqDias || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.intervaloMedio || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.padraoUso || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqXValor || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.consistencia || "") + "</td>" +
              "</tr>";
          });

          html +=
                  "</tbody>" +
                "</table>" +
              "</div>";

          // bot√£o CSV (igual voc√™ j√° usa em outras tabelas) :contentReference[oaicite:7]{index=7}
          html +=
            "<div style='margin-top:8px;display:flex;justify-content:flex-end;'>" +
              "<button type='button' " +
                "onclick=\"exportTableToCSV(this, 'frequencia_uso_clara')\" " +
                "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                       "border-radius:4px;font-size:11px;cursor:pointer;'>" +
                "‚¨á Exportar CSV" +
              "</button>" +
            "</div>";

          if (insight) {
            html +=
              "<div style='margin-top:10px;font-size:12px;color:#0F172A;background:#F8FAFC;border:1px solid #E2E8F0;border-radius:4px;padding:8px;'>" +
                "<p style='margin:0 0 4px 0;'><b>Insight:</b></p>" +
                "<p style='margin:0;'>" + insight + "</p>" +
              "</div>";
          }

          html += "</div>";

          renderBotMessage("HTML:" + html);
        } catch (e) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Falha ao montar a tabela de frequ√™ncia.</p>"
          );
        }
      })
      .withFailureHandler(function (err) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Falha de comunica√ß√£o ao calcular frequ√™ncia: " +
          (err && err.message ? err.message : err) + "</p>"
        );
      })
      .getFrequenciaUsoClara(filtroTipo, filtroValor);

  } catch (e) {
    console.error("Erro em vektorMostrarFrequenciaUsoClara:", e);
  }
};

window.vektorRespostaInfoIniciais = function (resposta) {
  try {
    if (resposta === "nao") {
      renderBotMessage(
        "HTML:" +
        "<p class='text-sm text-slate-700'>" +
          "Perfeito, seguimos normalmente. Se depois quiser ver esses resumos gerenciais, √© s√≥ pedir no chat. üëç" +
        "</p>"
      );
      return;
    }

    // Caso SIM
    renderBotMessage(
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>Beleza! Vou te mostrar algumas vis√µes gerenciais separadas, conforme abaixo, e tamb√©m alguns insights sobre essas vis√µes:</p>" +
        "<ul class='list-disc ml-4 mt-1 space-y-1'>" +
          "<li><b>Maiores transa√ß√µes individuais</b> dos √∫ltimos 30 dias (Top 10);</li>" +
          "<li><b>Times com mais pend√™ncias</b> nos √∫ltimos 30 dias;</li>" +
          "<li><b>Estabelecimentos mais usados</b> (Top 10);</li>" +
          "<li><b>Categorias com maior valor de transa√ß√µes</b> nos √∫ltimos 30 dias;</li>" +
          "<li><b>Valor das √∫ltimas faturas</b> Clara.</li>" +
        "</ul>" +
        "<p class='mt-2'>Irei enviar cada tabela em sequ√™ncia.</p>" +
      "</div>"
    );

    // Aguarda 1,5s e dispara o carregamento das tabelas
    setTimeout(function () {
      vektorCarregarInformacoesIniciais();
    }, 1500);
  } catch (e) {
    console.error("Erro ao tratar resposta info iniciais:", e);
  }
};

function vektorCarregarInformacoesIniciais() {
  try {
    if (USER_ROLE_CLEAN !== "Administrador") return;

    const hoje = new Date();
    const fim = hoje;
    const ini = new Date();
    ini.setDate(hoje.getDate() - 30);

    const dataInicioIso = ini.toISOString();
    const dataFimIso    = fim.toISOString();

    // 1) Maiores transa√ß√µes individuais
    try {
      google.script.run
        .withSuccessHandler(function (res) {
          try { renderMaioresTransacoesIndividuais(res); }
          catch (e) { console.error("Erro ao renderizar Maiores Transa√ß√µes (inicial):", e); }
        })
        .withFailureHandler(err => console.error("Erro Apps Script Maiores Transa√ß√µes (inicial):", err))
        .getMaioresTransacoesIndividuais("", "", dataInicioIso, dataFimIso, 10);
    } catch (e) {
      console.error("Falha geral ao chamar Maiores Transa√ß√µes (inicial):", e);
    }

    // 2) Pend√™ncias por time (√∫ltimos 30 dias)
          setTimeout(function () {
            try {
              google.script.run
                .withSuccessHandler(function (res) {
                  try {
                    const htmlTabela = vektorRenderTabelaPendenciasPorTime(res, dataInicioIso, dataFimIso);
                    renderBotMessage("HTML:" + htmlTabela);
                  } catch (e) {
                    console.error("Erro ao renderizar Pend√™ncias por time (inicial):", e);
                  }
                })
                .withFailureHandler(function (err) {
                  console.error("Erro Apps Script Pend√™ncias por time (inicial):", err);
                })
                .getResumoPendenciasPorTime(dataInicioIso, dataFimIso, "");
            } catch (e) {
              console.error("Falha geral ao chamar Pend√™ncias por time (inicial):", e);
            }
          }, 3000);

    // 3) Estabelecimentos mais usados (Top 10)
    setTimeout(function () {
      try {
        const tipo = "valor";

        google.script.run
          .withSuccessHandler(function (res) {
            try {
              renderResumoPorChaveGenerico(res, {
                tipoChave: "Estabelecimento",
                titulo: "<b>Locais com maior valor de gastos</b> - Top 10",
                topN: 10
              });
            } catch (e) {
              console.error("Erro ao renderizar Estabelecimentos (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Estabelecimentos (inicial):", err))
          .getResumoTransacoesPorEstabelecimento(
            dataInicioIso,   // <‚Äì CORRIGIDO
            dataFimIso,      // <‚Äì CORRIGIDO
            tipo,            // "valor"
            "",              // grupo
            ""               // loja
          );
      } catch (e) {
        console.error("Falha geral ao chamar Estabelecimentos (inicial):", e);
      }
    }, 6000);

    // 4) Categorias (j√° estava ok)
    setTimeout(function () {
      try {
        const tipo = "valor";

        google.script.run
          .withSuccessHandler(function (res) {
            try {
              renderResumoPorChaveGenerico(res, {
                tipoChave: "Categoria",
                titulo: "Categorias com maior valor de transa√ß√µes"
              });
            } catch (e) {
              console.error("Erro ao renderizar Categorias (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Categorias (inicial):", err))
          .getResumoTransacoesPorCategoria(dataInicioIso, dataFimIso, tipo);
      } catch (e) {
        console.error("Falha geral ao chamar Categorias (inicial):", e);
      }
    }, 9000);

    // 5) √öltimas 6 faturas (j√° estava ok)
    setTimeout(function () {
      try {
        google.script.run
          .withSuccessHandler(function (res) {
            try {
              const todas = (res && res.faturas) || [];
              if (!todas.length) return;

              const selecionadas = vektorFiltrarFaturasPeloModo_(todas, "ultimas", 6);
              if (!selecionadas.length) return;

              const titulo = "VALOR DAS √öLTIMAS " + selecionadas.length + " FATURAS";
              const htmlTabela = vektorMontarTabelaFaturas_(titulo, selecionadas);

              renderBotMessage("HTML:" + htmlTabela);

              const htmlInsights = analisarFaturas(selecionadas);
              if (htmlInsights) renderBotMessage("HTML:" + htmlInsights);

            } catch (e) {
              console.error("Erro ao renderizar Faturas (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Faturas (inicial):", err))
          .getResumoFaturasClara();
      } catch (e) {
        console.error("Falha geral ao chamar Faturas (inicial):", e);
      }
    }, 12000);

  } catch (e) {
    console.error("Erro geral em vektorCarregarInformacoesIniciais:", e);
  }
}



userInput.addEventListener("keydown", (e) => {
    const boxVisivel   = vektorBox && vektorBox.style.display === "block";
    const haSugestoes  = vektorCurrentSuggestions && vektorCurrentSuggestions.length > 0;

    // ESC fecha o autocomplete
    if (e.key === "Escape") {
        if (boxVisivel) {
            e.preventDefault();
            vektorBox.style.display = "none";
            vektorSelectedIndex = -1;
            vektorCurrentSuggestions = [];
        }
        return;
    }

    // Se o autocomplete estiver aberto e tiver sugest√µes
    if (boxVisivel && haSugestoes) {

        // TAB ou seta para baixo -> pr√≥xima sugest√£o
        if (e.key === "ArrowDown" || (e.key === "Tab" && !e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex + 1) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // Shift+TAB ou seta para cima -> sugest√£o anterior
        if (e.key === "ArrowUp" || (e.key === "Tab" && e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex - 1 + vektorCurrentSuggestions.length) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // ENTER com item selecionado -> aplica sugest√£o
        if (e.key === "Enter") {
            if (vektorSelectedIndex >= 0 && vektorCurrentSuggestions[vektorSelectedIndex]) {
                e.preventDefault();

                const textoSugestao = vektorCurrentSuggestions[vektorSelectedIndex];
                vektorApplySuggestion(textoSugestao);

                vektorBox.style.display = "none";
                vektorSelectedIndex = -1;
                vektorCurrentSuggestions = [];
                return; // usu√°rio aperta Enter de novo se quiser enviar
            }
            // se n√£o tiver item selecionado, cai no fluxo padr√£o mais abaixo
        }
    }

    // Fluxo padr√£o: Enter envia a mensagem (sem Shift)
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
    }
});

    sendBtn.addEventListener("click", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    // üü¢ Mostrar o v√≠deo do Vektor s√≥ na primeira visita
    (function () {
      var modal = document.getElementById("vektorModal");
      if (!modal) return;

      // Verifica se j√° mostramos o v√≠deo neste navegador
      var jaMostrou = localStorage.getItem("vektorIntroShown");

      if (!jaMostrou) {
        // Nunca mostrou ‚Üí exibe o modal e marca como exibido
        modal.style.display = "flex";   // combina com as classes flex do Tailwind
        localStorage.setItem("vektorIntroShown", "1");
      } else {
        // J√° mostrou uma vez ‚Üí garante que fique escondido
        modal.style.display = "none";
      }
    })();

      // ===== MODAL DO MANUAL CLARA =====
  window.openManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.remove("hidden");
      // para garantir que fique centralizado como flex
      el.classList.add("flex");
    }
  };

  window.closeManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.add("hidden");
      el.classList.remove("flex");
    }
  };

}); // fim DOMContentLoaded

</script>

<script>
  
document.addEventListener("DOMContentLoaded", function () {
  const home = document.getElementById("homeView");
  const img  = document.getElementById("homeHeroImg");
  if (!home) return;

  function showHome() {
    requestAnimationFrame(() => {
      home.style.opacity = "1";
      home.style.filter = "blur(0px)";
    });
  }

  if (img) {
    if (img.complete) showHome();
    else img.addEventListener("load", showHome, { once: true });
  } else {
    showHome();
  }
});

</script>
</body>
</html>
