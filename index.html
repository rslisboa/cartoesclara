<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Agente Clara</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js + plugin de data labels para o gr√°fico de faturas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:none;
        width:100%; 
        margin:0;
        display:flex;
        flex-direction:column;
        height:100%;
        min-height:0;
    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        background-color:#005E27;
        color:#B5FF20;
        margin-bottom:0.5rem;
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:100px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex: 1;
        display:flex;
        flex-direction:column;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
        min-height:0;
    }
    .chat-window {
        flex:1;              /* ocupa todo o espa√ßo dispon√≠vel dentro do main */
        overflow-y:auto;     /* ativa scroll interno das mensagens */
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
        padding:1rem 1.5rem; /* opcional: espa√ßo interno */
}

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digita√ß√£o menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do hist√≥rico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links nas respostas do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }

    /* ===== Tooltips dos bot√µes de pend√™ncias/justificativas ===== */
.vektor-btn-wrapper {
  position: relative;
  display: inline-block;
}

.vektor-tooltip-base {
  position: absolute;
  bottom: 110%;           /* aparece logo acima do bot√£o */
  right: 0;
  z-index: 9999;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 11px;
  color: #FFFFFF;            /* texto SEMPRE branco, como voc√™ pediu */
  background: rgba(0,0,0,0.85); /* ser√° sobrescrito inline por bot√£o */
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  box-shadow: 0 2px 6px rgba(15,23,42,0.25);
}

.vektor-btn-wrapper:hover .vektor-tooltip-base {
  opacity: 1;
}

/* ===== Spinner de carregamento para pend√™ncias/justificativas ===== */
.vektor-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #0f172a;
}

.vektor-spinner {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  border: 2px solid #e5e7eb;
  border-top-color: #0f172a;
  animation: vektor-spin 0.7s linear infinite;
}

@keyframes vektor-spin {
  to {
    transform: rotate(360deg);
  }
}

/* === VEKTOR AUTOCOMPLETE === */
#vektor-autocomplete-box {
  margin-top: 4px;
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  z-index: 9999;
  display: none;
  font-size: 13px;
  max-height: 220px;
  overflow-y: auto;
}

.vektor-autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
}

.vektor-autocomplete-item:hover {
  background: #B5FF20;
}

.vektor-autocomplete-item.is-active {
  background: #B5FF20;
}


</style>

<style>
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      height: 24px;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background-color: #94a3b8;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>

</head>
 <body class="text-slate-800">
 
 <div class="h-screen flex px-4 py-6 gap-4 items-stretch">
   <!-- COLUNA ESQUERDA: MENU LATERAL -->
   
   <aside class="hidden md:flex w-72 flex-col bg-white rounded-xl shadow-lg border border-slate-200 p-4 space-y-4 h-full">

  <!-- T√≠tulo do menu -->
  <div class="w-full text-center mb-1">
    <p class="text-base font-semibold text-black">Menu</p>
  </div>

  <!-- Bot√£o: assistir apresenta√ß√£o -->
  <button
    type="button"
    onclick="window.open('https://drive.google.com/file/d/1S8j9FuT9Vkc8kNZ_e5wX3cxfGXq3r5L5/view?usp=sharing','_blank')"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    ‚ñ∂ Apresenta√ß√£o Vektor
  </button>

  <!-- Bot√£o: relat√≥rio Looker Studio -->
  <button
    type="button"
    onclick="window.open('https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF/edit','_blank')"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    üìä Relat√≥rio Clara (Looker Studio)
  </button>

  <!-- Bot√£o: Feedback -->
  <button
    type="button"
    onclick= "window.open('https://forms.gle/QSAS9VN4HSws78W99')"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    üìù Feedback
  </button>
  
</aside>
 
   <!-- COLUNA DIREITA: CHAT -->
   <div class="flex-1">
     <div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Grupo SBF | Vektor</h1>

                <p>Pergunte tudo sobre o uso do cart√£o Clara nas lojas.</p>

                <div class="examples"></div>
                <div class="policy-note text-[12px] mt-2"></div>
            </div>

            <div class="chat-header-avatar">
                <img
                    src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
                    alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

                        <!-- Mensagem inicial do bot -->
                <div class="flex items-start gap-3">
                    <img
                        src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
                        alt="Assistente Clara (rob√¥)"
                        class="h-16 w-auto object-contain flex-shrink-0"
                    />
                    <div class="bot-bubble px-4 py-3 max-w-[80%] text-slate-700">
                        <p class="font-semibold text-slate-800 text-base">
                            Ol√°! üëã Eu sou o Vektor, atleta do <b>Grupo SBF</b> especializado na Clara.
                        </p>
                    </div>
                </div>
                </div>     <!-- fecha #chatWindow -->
              </main>      <!-- fecha .chat-body -->

<!-- Modal de apresenta√ß√£o do Vektor -->

<div id="vektorModal"
     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
     style="display:none;">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[600px] w-[95%]">
    <div class="rounded-xl overflow-hidden">
      <iframe
        src="https://drive.google.com/file/d/1S8j9FuT9Vkc8kNZ_e5wX3cxfGXq3r5L5/preview"
        width="100%"
        height="340"
        allow="autoplay"
        style="border:0;"
      ></iframe>
    </div>

    <button onclick="closeVektorModal()"
            class="mt-3 w-full bg-[#005E27] text-white py-2 rounded-lg text-sm font-semibold">
      Continuar
    </button>
  </div>
</div>

<!-- Modal do Manual da Clara -->
<div id="manualClaraModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[520px] w-[95%]">
    <h2 class="text-base font-semibold text-slate-800 mb-2">
      Manual da Clara ‚Äì principais t√≥picos
    </h2>
    <p class="text-xs text-slate-500 mb-3">
      Escolha um dos itens abaixo. A resposta aparece aqui no chat.
    </p>

    <div class="flex flex-col gap-2 text-sm text-slate-700">

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('primeiro_acesso'); closeManualClaraModal();">
        01 Primeiro acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('recebi_cartao'); closeManualClaraModal();">
        02 Recebi o cart√£o, e agora?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('esqueci_senha'); closeManualClaraModal();">
        03 Esqueci a senha do cart√£o / acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('qual_meu_acesso'); closeManualClaraModal();">
        04 Qual o meu acesso?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('anexar_comprovante'); closeManualClaraModal();">
        05 Como anexar comprovante?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('duvidas'); closeManualClaraModal();">
        06 D√∫vidas
      </button>
    </div>

    <button type="button"
            onclick="closeManualClaraModal()"
            class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<!-- AUTOCOMPLETE BOX -->
<div id="vektor-autocomplete-box"></div>

<!-- FOOTER / INPUT -->
<footer class="chat-footer">
    <form id="chatForm" class="w-full">
        <div class="input-shell">
            
            <textarea id="userInput" placeholder="Digite aqui..."></textarea>

            <!-- AUTOCOMPLETE VEKTOR -->
            <div id="vektor-autocomplete-box"></div>

            <button type="submit" id="sendBtn">Enviar</button>
        </div>
    </form>
</footer>

</div> <!-- fecha .chat-wrapper -->
</div>   <!-- fecha coluna direita -->
</div>     <!-- fecha layout com menu + chat -->


<script>

  // Fecha o modal do v√≠deo de apresenta√ß√£o
function closeVektorModal() {
  var modal = document.getElementById("vektorModal");
  if (modal) {
    modal.style.display = "none";
  }
}

let __vektorJaSugeriuLooker = false;

// Registro do plugin de r√≥tulos do Chart.js (se estiver carregado)
if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
  Chart.register(ChartDataLabels);
}

document.addEventListener("DOMContentLoaded", () => {

    let grupoNome = "";
    let grupo = "";

    const ROBOT_IMG_URL = "https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png";


        // Nome vindo do template Apps Script (Code.gs ‚Üí tmpl.userName)
    const userName = <?= JSON.stringify(userName || "") ?>;
    const displayName = userName.replace(/^"+|"+$/g, "").trim();

    // E-mail vindo do Apps Script (Code.gs ‚Üí template.userEmail)
    const USER_EMAIL = <?= JSON.stringify(userEmail || "") ?>;
    const USER_EMAIL_REPLACED = USER_EMAIL.replace(/^"+|"+$/g, "").trim();
    
// üîπ Mensagem inicial: exemplos do que o Vektor faz
renderBotMessage(
  "HTML:" +
  "<p class='text-sm text-slate-700' style='margin-top:8px;'>" +
    "Antes de come√ßarmos, aqui est√£o alguns exemplos do que eu posso fazer por voc√™:" +
  "</p>" +
  "<ul class='text-sm text-slate-700' style='margin-left:14px;margin-top:4px;line-height:1.45;'>" +
    "<li>‚Ä¢ Consultar <b>pend√™ncias</b> e <b>justificativas</b> das lojas.</li>" +
    "<li>‚Ä¢ Exibir <b>tabelas detalhadas</b> com pend√™ncias ou justificativas completas.</li>" +
    "<li>‚Ä¢ Mostrar <b>valor da fatura atual</b>, do m√™s passado ou das √∫ltimas faturas.</li>" +
    "<li>‚Ä¢ Gerar <b>ranking</b> por loja, por time, por categoria ou por estabelecimento.</li>" +
    "<li>‚Ä¢ Explicar regras da <b>Pol√≠tica de Uso dos Cart√µes Clara</b>.</li>" +
    "<li>‚Ä¢ Ajudar com informa√ß√µes de <b>desbloqueio</b>, <b>perda</b>, <b>regras de compra</b>, NF/Recibo e uso correto do cart√£o.</li>" +
    "<li>‚Ä¢ Enviar <b>pend√™ncias por e-mail</b>, e muito mais!</li>" +
  "</ul>"
);

// üîî Sauda√ßao em outra mensagem, depois da mensagem inicial
setTimeout(() => {
    if (displayName) {
        // Vers√£o com nome
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'><b>" +
            displayName +
            "</b>, como posso te ajudar agora?</p>"
        );
    } else {
        // Vers√£o sem nome (fallback)
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Como posso te ajudar agora?</p>"
        );
    }
}, 2000);

    /* ========= ESTADOS ========= */
    let estadoPendencias = "nenhum"; // "nenhum" | "aguardando_loja" | "aguardando_confirmacao_email" | "aguardando_email"
    let lojaPendenciasAtual = "";
    let ultimaPendenciaResumo = null; // { loja, data }
    let fluxoNovoCartao = null; // null | "aguardando_tipo_via"
    let ultimaIntencao = null;
    let origemPendenciasBloqueio = false;
    let pendenciasTimeoutId = null; // üÜï timeout pra mensagem de outro assunto



    /* ========= ELEMENTOS UI ========= */
    const chatWindow = document.getElementById("chatWindow");
    const chatForm   = document.getElementById("chatForm");
    const userInput  = document.getElementById("userInput");

    // =========================
// AUTOCOMPLETE VEKTOR
// =========================

// 1) Lista de inten√ß√µes (VOC√ä J√Å TEM ‚Äî basta mover pra c√°)
const VEKTOR_INTENTS = [
  "Consultar pend√™ncias de uma loja",
  "Ver pend√™ncias por per√≠odo",
  "Ver pend√™ncias por time",
  "Pend√™ncias que causam bloqueio",
  "Ver justificativas completas de uma loja",
  "Ver justificativas completas de um time",
  "Pend√™ncias de etiqueta / descri√ß√£o / nota fiscal",
  "Verificar pend√™ncias de NF/Recibo",
  "Como justificar uma transa√ß√£o da Clara",
  "Loja com maior valor de transa√ß√µes neste m√™s",
  "Loja com mais transa√ß√µes neste m√™s",
  "Ranking de categorias por valor",
  "Lista de categorias por valor",
  "Treinamento Clara",
  "Treinamento pol√≠tica Clara",
  "Treinamento sobre uso do cart√£o Clara",
  "Termo de responsabilidade Clara",
  "Valor da fatura atual",
  "Valor da fatura do m√™s passado",
  "Valor das √∫ltimas 3 faturas",
  "Valor das √∫ltimas 6 faturas",
  "Valor de todas as faturas",
  "Ver extrato da conta da Clara",
  "Qual √© o ciclo da fatura da Clara?",
  "Listagem de etiquetas cadastradas na Clara",
  "Ranking de lojas com mais transa√ß√µes",
  "Ranking de lojas com maior valor",
  "Ranking de times com mais transa√ß√µes",
  "Ranking de times com maior valor",
  "Top 3 lojas de um time",
  "Top 5 lojas do per√≠odo",
  "Lojas que mais gastaram no per√≠odo",
  "Lojas que mais fizeram compras",
  "Resumo de uma loja neste m√™s",
  "Resumo de uma loja na √∫ltima semana",
  "Transa√ß√µes de uma loja no per√≠odo",
  "Quais lojas fazem parte de um time?",
  "Resumo de um time neste m√™s",
  "Resumo de um time no per√≠odo",
  "Times com maior valor de transa√ß√µes",
  "Times com maior n√∫mero de transa√ß√µes",
  "Categoria que mais gastou no per√≠odo",
  "Categorias por loja",
  "Categorias por time",
  "Ranking de categorias",
  "Gastos por categoria no per√≠odo",
  "Estabelecimentos mais usados",
  "Ranking de estabelecimentos por valor",
  "Ranking de estabelecimentos por quantidade",
  "Gastos por estabelecimento no per√≠odo",
  "O que posso comprar com o cart√£o Clara?",
  "Tipos de compra permitidos",
  "Tipos de compra proibidos",
  "Regras da Pol√≠tica de Uso dos Cart√µes Clara",
  "Quando o cart√£o √© bloqueado?",
  "Perdi meu cart√£o Clara, o que fazer?",
  "Cart√£o Clara bloqueado, como resolver?",
  "Como desbloquear o cart√£o Clara?",
  "Meu cart√£o n√£o passou, o que pode ser?",
  "Enviar pend√™ncias por e-mail",
  "Receber pend√™ncias da loja por e-mail",
  "Abrir relat√≥rio gerencial da Clara",
  "Ver dashboard no Looker Studio",
  "Como aumento o limite do cart√£o?",
  "Como usar bem o limite do cart√£o Clara?",
  "Quero gr√°ficos das transa√ß√µes",
  "O que o Vektor pode fazer?",
  "Como anexar nota fiscal na Clara?",
  "Como justificar compras na Clara?"
];

// 2) Normaliza√ß√£o
function vektorNormAutocomplete(str) {
  if (!str) return "";
  return str
    .toString()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// 3) Campos HTML
const vektorInput = document.getElementById("userInput");
const vektorBox   = document.getElementById("vektor-autocomplete-box");

// Estado atual do autocomplete
let vektorCurrentSuggestions = [];
let vektorSelectedIndex = -1;

// Atualiza visualmente qual item est√° selecionado
function vektorHighlightSelected() {
  const items = vektorBox.querySelectorAll(".vektor-autocomplete-item");
  items.forEach((el, idx) => {
    if (idx === vektorSelectedIndex) {
      el.classList.add("is-active");
      // Garante que o item vis√≠vel seja mostrado
      el.scrollIntoView({ block: "nearest" });
    } else {
      el.classList.remove("is-active");
    }
  });
}

// Aplica a sugest√£o substituindo apenas o √∫ltimo "bloco" digitado
function vektorApplySuggestion(textoSugestao) {
  const raw = vektorInput.value || "";

  // casa tudo at√© o √∫ltimo espa√ßo em grupo 1
  // e a √∫ltima "palavra" (sem espa√ßo) em grupo 2
  const m = raw.match(/^(.*\s)(\S+)?$/);

  let novoTexto;

  if (!raw.trim()) {
    // campo vazio -> vira apenas a sugest√£o
    novoTexto = textoSugestao;
  } else if (m) {
    const prefixo = m[1] || "";
    novoTexto = prefixo + textoSugestao;
  } else {
    // fallback: se n√£o bater o regex, substitui tudo
    novoTexto = textoSugestao;
  }

  vektorInput.value = novoTexto;
}

// 4) Carregar lista de LOJAS vinda do back-end
window.__VEKTOR_LOJAS = [];
google.script.run.withSuccessHandler(function(lista){
    if (Array.isArray(lista)) window.__VEKTOR_LOJAS = lista;
}).getListaLojas();

// 5) Lista de times reais (voc√™ ajusta aqui)
const VEKTOR_TIMES = [
  "√Åguias de Elite",
  "√Åguias do Cerrado",
  "Guardi√µes da Fronteira",
  "Esquadr√£o 40 graus",
  "Esquadr√£o Valente",
  "Falc√µes SP",
  "Flechas do Norte",
  "Furac√£o Sul",
  "Ultra High",
  "F√∫ria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Canga√ßo",
  "Legi√£o de Elite",
  "Sulcesso"
];

// 6) Renderizar sugest√µes

function vektorRenderSugestoes(lista) {
  if (!lista.length) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  vektorCurrentSuggestions = lista.slice(0, 8);
  vektorSelectedIndex = -1;

  vektorBox.innerHTML = vektorCurrentSuggestions
    .map((s, idx) => 
      `<div class="vektor-autocomplete-item" data-index="${idx}">${s}</div>`
    )
    .join("");

  vektorBox.style.display = "block";
}

// 7) L√≥gica do autocomplete
vektorInput.addEventListener("input", function () {
  const raw  = vektorInput.value || "";

  // texto inteiro normalizado (para intents)
  const norm = vektorNormAutocomplete(raw);

  // pega apenas o √∫ltimo "bloco" digitado (depois do √∫ltimo espa√ßo)
  const lastMatch = raw.match(/(\S+)$/);
  const lastRaw   = lastMatch ? lastMatch[1] : "";
  const lastNorm  = vektorNormAutocomplete(lastRaw);

  // se o √∫ltimo bloco tem menos de 2 caracteres, n√£o sugere nada
  if (!lastNorm || lastNorm.length < 2) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  let suggestions = [];

  // a) frases do VEKTOR_INTENTS -> usa a frase inteira normalizada
  if (norm.length >= 2) {
    suggestions.push(
      ...VEKTOR_INTENTS.filter(x => vektorNormAutocomplete(x).includes(norm))
    );
  }

  // b) autocomplete de LOJAS -> usa s√≥ os d√≠gitos do √∫ltimo bloco
 if (window.__VEKTOR_LOJAS && window.__VEKTOR_LOJAS.length) {
  const digits = (lastRaw || "").replace(/\D/g, "");
  if (digits && digits.length <= 4) {
    const padded = ("0000" + digits).slice(-4);

    window.__VEKTOR_LOJAS.forEach((l) => {
      const cod = String(l.codigo || "").padStart(4, "0");

      if (cod.startsWith(padded)) {
        const nomeFinal = l.nome || l.nomeLojaTxt || "";
        let label = cod;

        if (nomeFinal) {
          label += " - " + nomeFinal;
        }

        suggestions.push(label);
      }
    });
  }
}

  // c) autocomplete de TIMES -> compara contra o √∫ltimo termo digitado
  if (lastNorm.length >= 2) {
    suggestions.push(
      ...VEKTOR_TIMES.filter(t => vektorNormAutocomplete(t).includes(lastNorm))
    );
  }

  // remover duplicados
  suggestions = [...new Set(suggestions)];

  vektorRenderSugestoes(suggestions);
});

// clique do mouse
vektorBox.addEventListener("mousedown", (e)=>{
  const item = e.target.closest(".vektor-autocomplete-item");
  if (!item) return;

  const idx = item.dataset.index ? parseInt(item.dataset.index, 10) : -1;
  const textoSugestao =
    (idx >= 0 && vektorCurrentSuggestions[idx])
      ? vektorCurrentSuggestions[idx]
      : item.innerText;

  vektorApplySuggestion(textoSugestao);

  vektorBox.style.display = "none";
  vektorSelectedIndex = -1;
  vektorCurrentSuggestions = [];
});

    const sendBtn    = document.getElementById("sendBtn");

    /* ========= FUN√á√ïES DE UI ========= */
    function scrollToBottom() {
        requestAnimationFrame(() => {
            const body = document.querySelector(".chat-body");
            if (body) {
                body.scrollTop = body.scrollHeight;
                setTimeout(() => {
                    body.scrollTop = body.scrollHeight;
                }, 150);
            }
        });
    }

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start justify-end gap-3";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

        // Converte texto tipo "R$ 340.800,00" ou "59,1 mil" em n√∫mero
    function vektorParseNumero(texto) {
      if (!texto) return NaN;

      let t = String(texto).toLowerCase();

      // trata "mil" (ex.: "340,8 mil")
      let multiplicador = 1;
      if (t.includes(" mil")) {
        multiplicador = 1000;
      }
      t = t.replace(/mil/gi, "");

      // remove tudo que n√£o for n√∫mero, v√≠rgula, ponto ou sinal
      t = t.replace(/[^\d,.\-]/g, "");

      // remove pontos de milhar e troca v√≠rgula por ponto
      t = t.replace(/\./g, "").replace(",", ".");

      const n = parseFloat(t);
      if (isNaN(n)) return NaN;
      return n * multiplicador;
    }


        function iniciarTimeoutPendencias() {
        // limpa qualquer timeout pendente
        if (pendenciasTimeoutId) {
            clearTimeout(pendenciasTimeoutId);
            pendenciasTimeoutId = null;
        }

    const mensagensOutroAssunto = [
  "Quer falar sobre outro assunto? Se sim, pode mandar bala!",
  "Quer aproveitar e falar de outro tema?",
  "Quer conversar sobre outra coisa?",
  "Planeta Terra chamando! Tem algu√©m ai? üôÑ",
  "Me diz se quer mudar de assunto? üòâ",  
  "Tem outro assunto que quer tratar?",
  "Posso te ajudar com mais alguma coisa?",
  "Quer mudar de assunto? Manda ver!",
  "Se quiser falar de outro tema, √© s√≥ digitar üëá",
  "Posso te ajudar em outro ponto se quiser...",
  "Quer conversar sobre outra coisa agora?"
];

// üïí dispara o lembrete depois de 10s sem resposta
pendenciasTimeoutId = setTimeout(() => {
  // escolhe uma frase aleat√≥ria do array
  const fraseAleatoria = mensagensOutroAssunto[
    Math.floor(Math.random() * mensagensOutroAssunto.length)
  ];

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">${fraseAleatoria}</p>`
  );
}, 10000);

    }


        // üëá Cole AQUI, logo abaixo de scrollToBottom()

      // Adiciona indicador de "digitando..."
      function showTypingIndicator() {
        const chatWindow = document.getElementById('chatWindow');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex items-start gap-3 mt-3';
        typingDiv.innerHTML = `
          <div class="bot-bubble px-4 py-3 max-w-[80%]">
            <div class="typing-indicator flex gap-1">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

  // ---- DEBUG TURBINADO: mostra erros e rejei√ß√µes dentro do chat ----
(function instalarErroNoChat() {
  if (window.__erroNoChatInstalado) return;
  window.__erroNoChatInstalado = true;

  // Fun√ß√£o auxiliar pra mostrar a mensagem no chat
  function mostrarErro(titulo, msg, linha, arquivo) {
    try {
      renderBotMessage(
        "HTML:<div style='font-family:Arial,sans-serif;font-size:12px;color:#B00020;background:#FFECEC;padding:8px;border:1px solid #B00020;border-radius:6px'>" +
          "<b>" + titulo + ":</b> " + msg +
          (linha ? "<br/><small>(" + (arquivo || "inline") + ":" + linha + ")</small>" : "") +
        "</div>"
      );
    } catch (_) {
      console.error("Erro ao mostrar debug no chat:", msg);
    }
  }

  // 1Ô∏è‚É£ Erros comuns de execu√ß√£o
  window.addEventListener("error", function (e) {
    const msg = e.message || String(e);
    mostrarErro("Erro de script", msg, e.lineno, e.filename);
  });

  // 2Ô∏è‚É£ Promises rejeitadas (async/await sem catch)
  window.addEventListener("unhandledrejection", function (e) {
    const msg = e.reason && e.reason.message ? e.reason.message : String(e.reason);
    mostrarErro("Promise rejeitada", msg);
  });

  // 3Ô∏è‚É£ Aviso de que o script carregou e debug est√° ativo
  window.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Debug do chat ativado!");
  });

  // 4Ô∏è‚É£ Falhas no carregamento de scripts externos
  window.addEventListener("error", function (e) {
    if (e.target && e.target.tagName === "SCRIPT") {
      mostrarErro("Falha ao carregar script", e.target.src || "(inline script)");
    }
  }, true);
})();



  function hideTypingIndicator() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) typingDiv.remove();
  }


            async function renderBotMessage(text) {
          if (!text) return;

          // üëá Mostra o indicador de "digitando..."
          showTypingIndicator();

          // Aguarda 1 segundo (simulando digita√ß√£o)
          await new Promise(r => setTimeout(r, 800));

          // Remove o indicador
          hideTypingIndicator();

          // --- Parte original do seu c√≥digo ---
          const wrapper = document.createElement("div");
          wrapper.className = "flex items-start gap-3";

          const avatar = document.createElement("img");
          avatar.src = ROBOT_IMG_URL;
          avatar.alt = "Assistente Clara (rob√¥)";
          avatar.className = "h-16 w-auto object-contain flex-shrink-0";

          const bubble = document.createElement("div");
          bubble.className =
            "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

          if (typeof text === "string" && text.startsWith("HTML:")) {
            bubble.innerHTML = text.replace(/^HTML:/, "").trim();
          } else {
            bubble.innerText = text;
          }

          wrapper.appendChild(avatar);
          wrapper.appendChild(bubble);
          chatWindow.appendChild(wrapper);

          scrollToBottom();
          // üëá dispara notifica√ß√£o de nova mensagem do bot
          notificarNovaMensagem(text);
        }

          // ========= EXPORTA√á√ÉO DE TABELA PARA CSV =========

  // Usado pelo bot√£o "‚¨á Exportar CSV" dentro das respostas com tabela.
  // IMPORTANT: precisa estar dentro do document.addEventListener("DOMContentLoaded", ...)
  // e exposto em window para o onclick funcionar.
  window.exportTableToCSV = function(btn, defaultFileName) {
    try {
      // 1. Encontrar o container da mensagem do bot onde o bot√£o est√°
      var container = btn.closest(".bot-bubble");
      if (!container) {
        container = btn.closest("div");
      }

      if (!container) {
        alert("N√£o consegui localizar a tabela para exportar.");
        return;
      }

      // 2. Achar a tabela dentro dessa resposta
      var table = container.querySelector("table");
      if (!table) {
        alert("N√£o encontrei nenhuma tabela nessa resposta para exportar.");
        return;
      }

      // 3. Montar o CSV linha a linha
      var linhas = table.querySelectorAll("tr");
      var csvLinhas = [];

      for (var i = 0; i < linhas.length; i++) {
        var cols = linhas[i].querySelectorAll("th,td");
        var linhaCampos = [];
        for (var j = 0; j < cols.length; j++) {
          var texto = (cols[j].innerText || "").replace(/\s+/g, " ").trim();

          // Escapa aspas duplas
          texto = texto.replace(/"/g, '""');

          // Se tiver ;, quebra de linha ou aspas, envolve em aspas
          if (/[;"\n]/.test(texto)) {
            texto = '"' + texto + '"';
          }

          linhaCampos.push(texto);
        }

        // Usando ; como separador (mais comum no Excel PT-BR)
        csvLinhas.push(linhaCampos.join(";"));
      }

      var csv = csvLinhas.join("\n");

      // 4. Criar o arquivo e disparar o download
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var agora = new Date();
      var stamp = agora.toISOString().slice(0,19).replace(/[:T\-]/g,"");

      a.href = url;
      a.download = (defaultFileName || "exportacao") + "_" + stamp + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Erro ao exportar CSV:", e);
      alert("N√£o consegui gerar o CSV desta tabela.");
    }
  };


// ========= DRILL-DOWN: EXPANDIR LINHA DA TABELA (com dropdown + mesmo per√≠odo) ========= //

window.vektorExpandirLinha = function (tr, base) {
  try {
    if (!tr || !tr.cells || !tr.cells.length) return;

    // Nome da linha (Time / Loja / Categoria / Estabelecimento)
    const chave = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    if (!chave) return;

    // Encontra o <select> relacionado ao drilldown
    const container = tr.closest("div");
    const select = container
      ? container.querySelector(".vektor-drill-select[data-base='" + base + "']")
      : null;

    const alvo = select ? select.value : null; // loja / categoria / estabelecimento / time

    // Per√≠odo da pergunta original (cache)
    const periodo = window.__vektorUltimoPeriodo || null;
    const dataInicioStr =
      periodo && periodo.dataInicio ? periodo.dataInicio.toISOString() : "";
    const dataFimStr =
      periodo && periodo.dataFim ? periodo.dataFim.toISOString() : "";

    let periodoTxt = "";
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      const di = periodo.dataInicio;
      const df = periodo.dataFim;
      periodoTxt =
        di.toLocaleDateString("pt-BR") + " a " + df.toLocaleDateString("pt-BR");
    }

    const tipo = "valor"; // padr√£o do drilldown

    // ================== BASE = TIME ==================
    if (base === "time") {
      // ‚ñº TIME ‚Üí LOJAS (padr√£o)
      if (alvo === "loja" || !alvo) {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>lojas</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            // topN null + forGroup=true => todas as lojas do time
            renderResumoTransacoesSemana(res, { topN: null, forGroup: true });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar por lojas.</p>"
            );
          })
          .getResumoTransacoesPorGrupo(chave, dataInicioStr, dataFimStr, tipo);
      }

      // ‚ñº TIME ‚Üí CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> do time <b>" + chave + "</b> " +
            (periodoTxt ? "no per√≠odo <b>" + periodoTxt + "</b>" : "") +
            "‚Ä¶</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias do time.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaTime(
            dataInicioStr,
            dataFimStr,
            tipo,   // "valor" ou "quantidade"
            chave   // nome do time
          );
      }

      // ‚ñº TIME ‚Üí ESTABELECIMENTOS
      else if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>estabelecimentos</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            chave, // grupo = time
            ""     // loja vazia
          );
      }

      return;
    }

    // ================== BASE = LOJA ==================
    if (base === "loja") {
      // ‚ñº LOJA ‚Üí ESTABELECIMENTOS
      if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando a loja <b>${chave}</b> por <b>estabelecimentos</b>‚Ä¶</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            "",
            chave // loja
          );
      }

      // ‚ñº LOJA ‚Üí CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> da loja <b>" + chave + "</b> " +
            (periodoTxt ? "no per√≠odo <b>" + periodoTxt + "</b>" : "") +
            "‚Ä¶</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias da loja.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaLoja(
            dataInicioStr,
            dataFimStr,
            tipo,     // "valor" ou "quantidade"
            chave     // c√≥digo/nome da loja
          );
      }

      return;
    }
  } catch (e) {
    console.error("Erro no vektorExpandirLinha:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Tive um problema ao tentar detalhar essa linha.</p>"
    );
  }
};

    /* ========= NORMALIZA√á√ÉO ========= */
    function normalize(str) {
        return (str || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    // ===== TIMES OFICIAIS (para identificar "time X" / "grupo X") =====
const TIMES_OFICIAIS = [
  "√Åguias de Elite",
  "√Åguias do Cerrado",
  "Guardi√µes da Fronteira",
  "Esquadr√£o 40 Graus",
  "Esquadr√£o Valente",
  "Falc√µes SP",
  "Flechas do Norte",
  "Furac√£o Sul",
  "Ultra High",
  "F√∫ria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Canga√ßo",
  "Legi√£o de Elite",
  "SULcesso"
];

// Usa a mesma normalize() do chat pra comparar mensagem x times
function encontrarTimeNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal);

  let melhorNome = null;
  let melhorScore = 0;

  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // separa em palavras e tira preposi√ß√µes/coisas fracas
    const tokens = nomeNorm
      .split(" ")
      .filter(t => !["do","da","de","dos","das","sp","sul"].includes(t));

    let score = 0;

    // se o nome completo aparecer, j√° d√° um boost forte
    if (texto.includes(nomeNorm)) {
      score += 100;
    }

    // +10 pra cada palavra relevante encontrada
    tokens.forEach(tok => {
      if (texto.includes(tok)) score += 10;
    });

    if (score > melhorScore) {
      melhorScore = score;
      melhorNome = nome;
    }
  });

  // se nada bateu, volta null
  return melhorNome;
}

function encontrarListaTimesNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");
  const encontrados = [];

  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // usa as mesmas regras do encontrarTimeNaMensagem,
    // mas aqui a ideia √© pegar TODOS os que apare√ßam
    const tokens = nomeNorm
      .split(" ")
      .filter(t => !["do","da","de","dos","das","sp","sul"].includes(t));

    let score = 0;
    tokens.forEach((tk) => {
      if (!tk) return;
      if (texto.includes(tk)) score += 1;
    });

    if (score > 0) {
      encontrados.push(nome);
    }
  });

  return encontrados;
}


    /* ========= DADOS / TABELAS ========= */

    const etiquetasOficiais = [
  {
    nome: "MARKETING_PUBLICIDADE E PROPAGANDA",
    palavrasChave: [
      "marketing", "publicidade", "propaganda", "anuncio", "an√∫ncio", "facebook", "instagram", "insta", "face",
      "m√≠dia", "midia", "brinde", "campanha", "banner promocional", "campanhas", "banner", "baner",
      "impulsionamento", "divulga√ß√£o", "panfleto", "adesivo promocional", "social media", "instagram ads", "facebook ads", "promo√ß√£o local", "google ads", "tiktok ads", "youtube ads", "seo", "sem", "email marketing", "e-mail marketing", "inbound marketing", "outbound marketing", "influencer", "influenciadores", "parceria paga", "patrocinado", "stories", "feed", "design gr√°fico", "agencia de publicidade", "ag√™ncia de publicidade", "criacao de conteudo", "cria√ß√£o de conte√∫do", "material promocional", "folder", "cartaz", "outdoor", "tv paga", "revista", "jornal", "marketing digital", "alcance", "engajamento", "convers√£o", "leads", "pixel", "remarketing", "assessoria de imprensa", "rela√ß√µes p√∫blicas", "relacoes publicas", "assessoria"
    ],
    descricao:
      "A√ß√µes promocionais, compra de brindes, banners, impulsionamento de redes sociais, contrata√ß√£o de m√≠dia local.",
    observacaoUso: "Somente campanhas aprovadas pelo regional ou diretoria."
  },
  {
    nome: "TAXAS E EMOLUMENTOS",
    palavrasChave: [
      "taxa", "taxas", "emolumento", "emolumentos", "cartorio", "cart√≥rio",
      "certidao", "certid√£o", "registro", "segunda via documento", "aluguel",
      "documenta√ß√£o oficial", "taxa de servi√ßo", "honorarios", "honor√°rios"
    ],
    descricao:
      "Custos com registros, certid√µes, taxas cartoriais ou administrativas necess√°rias √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA",
    palavrasChave: [
      "detergente", "sabao", "sab√£o", "desinfetante", "alcool", "√°lcool", "pano", "rodo", "vassoura", "esponja", "papel toalha", "limpeza loja", "produto de limpeza", "desengordurante", "multiuso", "saco de lixo", "lixeira", "balde", "mop", "lustra moveis", "lustra m√≥veis", "cera", "removedor", "amaciante", "√°gua sanit√°ria", "agua sanitaria", "limpa vidros", "rasteio", "escova", "flanela", "aspirador", "sapon√°ceo", "sabonete", "dispenser", "tapete sanitizante", "sanitizante", "cloro", "alvejante", "luva", "mascara", "m√°scara", "limpeza do banheiro", "papel higi√™nico", "papel higienico", "aromatizador", "odorizador", "refil", "material de higiene", "higiene"
    ],
    descricao:
      "Materiais de limpeza e higiene da loja: detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE INFORM√ÅTICA",
    palavrasChave: [
      "mouse", "teclado", "teclado pdv", "cabo usb", "pendrive", "pen drive", "roteador", "hub usb", "fonte", "adaptador", "cabo rede", "cart√£o memoria", "cartao memoria", "extensor usb", "carregador", "suporte notebook", "monitor", "impressora", "cartucho", "toner", "cabo hdmi", "ssd", "hd", "memoria ram", "mem√≥ria ram", "headset", "scanner", "leitor de c√≥digo", "leitor de codigo", "mousepad", "modem", "placa de video", "placa de rede", "pilhas", "bateria", "no break", "nobreak", "filtro de linha", "perif√©rico", "periferico", "fone de ouvido", "fones", "fone"
    ],
    descricao:
      "Itens de inform√°tica de baixo valor: mouse, teclado, cabos, pendrives, fontes, roteadores, hubs USB, cart√µes de mem√≥ria.",
    observacaoUso: "N√£o cobre monitores, TVs ou equipamentos patrimoniais."
  },
  {
    nome: "MATERIAL DE ESCRIT√ìRIO",
    palavrasChave: [
      "caneta", "papel", "pasta", "bloco", "caderno", "etiqueta adesiva", "grampeador", "clips", "clipes", "organizador", "post-it", "marcador", "l√°pis", "lapis", "borracha", "corretivo", "tesoura", "r√©gua", "regua", "perfurador", "furador de papel", "cola", "fita adesiva", "fita durex", "envelope", "arquivo", "caixa arquivo", "separador de p√°gina", "separador de pagina",
      "carimbo", "tinta carimbo", "calculadora", "agenda", "calend√°rio", "calendario", "prancheta", "suporte de caneta", "porta-treco", "cartucho de tinta", "toner", "porta revista", "revisteiro", "apontador", "dicion√°rio", "dicionario", "impressos", "sulfite", "folha de sulfite", "folha A4", "folhas", "escada", "escadas"
    ],
    descricao:
      "Canetas, blocos, pap√©is, pastas, grampeadores, clipes, etiquetas adesivas, organizadores de mesa etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE COPA E COZINHA",
    palavrasChave: [
      "copo", "copos", "talher", "talheres", "garrafa termica", "garrafa t√©rmica",
      "pano prato", "pano de prato", "filtro de cafe", "filtro de caf√©",
      "pote", "potes", "pote plastico", "pote pl√°stico", "descartavel", 
    ],
    descricao:
      "Copos, talheres, filtros de caf√©, panos de prato, potes pl√°sticos, garrafas t√©rmicas.",
    observacaoUso: "N√£o cobre eletrodom√©sticos como cafeteiras ou micro-ondas."
  },
  {
    nome: "MATERIAL DE COPA E COZINHA OPERA√á√ïES",
    palavrasChave: ["cozinha loja", "utensilios loja", "material copa opera√ß√µes", "kit acrilico"],
    descricao: "Itens de copa/cozinha utilizados especificamente em opera√ß√µes.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA OPERA√á√ïES",
    palavrasChave: ["limpeza opera√ß√µes", "produto limpeza operacional"],
    descricao: "Materiais de limpeza voltados √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS OPERA√á√ïES",
    palavrasChave: ["banner", "adesivo", "flyer", "folder", "grafica", "impressao", "impress√£o"],
    descricao: "Materiais gr√°ficos operacionais, banners e impress√µes.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO CIVIL",
    palavrasChave: [
      "parede", "porta", "vidro", "prateleira", "fechadura", "reparo loja",
      "conserto parede", "ajuste estrutura", "obra pequena"
    ],
    descricao:
      "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa).",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO ELETRICO",
    palavrasChave: [
      "tomada", "disjuntor", "interruptor", "reator", "soquete", "extensao",
      "fia√ß√£o", "fiacao", "el√©trico", "eletrico", "luz", "l√¢mpada", "lampada"
    ],
    descricao:
      "Troca de tomadas, disjuntores, interruptores, l√¢mpadas e pequenos reparos el√©tricos.",
    observacaoUso: "Apenas servi√ßos simples, sem necessidade de t√©cnico especializado."
  },
  {
    nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
    palavrasChave: [
      "conserto impressora", "ajuste maquina estampar", "reparo computador",
      "ferramenta manual", "manutencao equipamentos", "reparo t√©cnico"
    ],
    descricao:
      "Reparo de impressora, m√°quina de estampar e computador fora de garantia.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
    palavrasChave: [
      "ar condicionado", "ar-condicionado", "limpeza filtro", "carga gas",
      "controle remoto ar", "manuten√ß√£o ar", "reparo ar", "split"
    ],
    descricao:
      "Limpeza, carga de g√°s e pequenos ajustes em ar-condicionado.",
    observacaoUso: "N√£o cobre compra de novo aparelho."
  },
  {
    nome: "TRANSPORTE SERVICOS EMERGENCIAS",
    palavrasChave: [
      "motoboy", "moto boy", "entrega urgente", "frete", "documento matriz",
      "lalamove", "entrega loja", "envio urgente", "courier"
    ],
    descricao:
      "Frete emergencial local, motoboy ou entrega urgente entre lojas e matriz.",
    observacaoUso: "N√£o inclui transporte pessoal via aplicativos."
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
    palavrasChave: [
      "banner", "adesivo", "flyer", "folder", "encadernacao", "grafica", "impressao",
      "material visual", "cartaz", "copiadora"
    ],
    descricao:
      "Impress√µes, banners, adesivos, folders, encaderna√ß√µes e materiais visuais.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS DE LIMPEZA",
    palavrasChave: [
      "limpeza loja", "faxina", "servi√ßo limpeza", "limpeza extra", "empresa limpeza"
    ],
    descricao:
      "Contrata√ß√£o de servi√ßos de limpeza eventuais para manuten√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "CORREIOS_SEDEX/AR/POSTAGEM",
    palavrasChave: [
      "sedex", "correio", "postagem"
    ],
    descricao: "Envio de documentos f√≠sicos via Sedex, AR, ou devolu√ß√µes pequenas.",
    observacaoUso: ""
  },
  {
    nome: "LANCHES DE REFEI√á√ïES",
    palavrasChave: [
      "lanche", "coffee break", "caf√©", "bolo", "salgado", "biscoito", "refrigerante", "suco", "premia√ß√£o", "treinamento", "a√ß√£o interna", "almoco", "almo√ßo", "jantar", "pizza", "comida", "refeicao", "refei√ß√£o", "confraterniza√ß√£o", "confraternizacao", "evento interno", "kit lanche", "break", "doces", "chocolates", "frutas", "p√£o", "pao", "torta", "sandu√≠che", "sanduiche", "kit caf√©", "bebidas", "snacks", "celebracao", "celebra√ß√£o", "coquetel", "buffet", "catering", "alimentos",
  "compra de comida", "alimentacao", "alimenta√ß√£o", "workshop", "curso", "reuniao", "reuni√£o"
    ],
    descricao:
      "Lanches ou coffee break para treinamento interno, a√ß√£o aprovada ou premia√ß√£o.",
    observacaoUso: "N√£o cobre refei√ß√µes pessoais."
  },
  {
    nome: "AGUA POT√ÅVEL",
    palavrasChave: [
      "agua", "√°gua", "gal√£o", "galao", "garrafa agua", "garrafa de agua", "comprar agua", "comprar √°gua", "suprimento de √°gua", "reposi√ß√£o de √°gua", "barril de √°gua", "barril de agua", "√°gua mineral", "agua mineral", "bombona", "garraf√£o", "garrafao",
  "fornecedor de √°gua"
    ],
    descricao:
      "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe.",
    observacaoUso: ""
  },
  {
    nome: "BOBINA ECF",
    palavrasChave: [
      "bobina", "ecf", "cupom fiscal", "bobina impressora", "bobina pdv"
    ],
    descricao:
      "Bobinas para ECF / impressoras fiscais / PDV n√£o centralizados.",
    observacaoUso: ""
  },
  {
    nome: "CHAVEIRO EMERGENCIAL",
    palavrasChave: [
      "chaveiro", "abrir cofre", "abrir estoque", "trocar segredo", "sem chave", "cofre", "problema cofre", "problema fechadura", "fechadura", "perdi a chave", "esqueci a chave", "chave quebrada", "troca de chave", "fazer chave", "duplicata de chave", "copia de chave", "c√≥pia de chave", "abrir porta", "porta travada", "porta emperrada", "trancar", "trocar segredo",
      "segredo cofre", "abertura de cofre", "trocar fechadura", "concerto fechadura", "conserto fechadura", "consertar fechadura", "emerg√™ncia fechadura", "servi√ßo chaveiro", "mestre chaveiro", "tranca", "chaves", "cilindro", "miolo da chave", "reparar cofre", "reparo fechadura", "instalar fechadura"
    ],
    descricao:
      "Servi√ßo emergencial de chaveiro para abertura de cofres, vitrines e estoques.",
    observacaoUso: "Somente em emerg√™ncias operacionais."
  },
  {
    nome: "MANUTEN√á√ÉO MAQ ESTAMPAR",
    palavrasChave: [
      "estampar", "maquina estampar", "m√°quina estampar", "reparo estampar"
    ],
    descricao:
      "Reparos simples ou ajustes t√©cnicos em m√°quinas de estampar, sem controle patrimonial.",
    observacaoUso: ""
  }
];


    const perguntasGeraisEtiqueta = [
        "qual etiqueta devo usar","qual etiqueta usar","qual etiqueta eu uso",
        "que etiqueta devo usar","que etiqueta usar","que etiqueta eu uso",
        "me fala as etiquetas","me diz as etiquetas","me mostra as etiquetas",
        "me envia as etiquetas","me passa as etiquetas",
        "todas as etiquetas","lista de etiquetas","listagem de etiquetas",
        "quais etiquetas existem","quais etiquetas tem","quais sao as etiquetas",
        "quais s√£o as etiquetas","quais etiquetas posso usar",
        "quais etiquetas devo usar","quais etiquetas usar",
        "categorias de gasto","categorias de despesas","categoria de despesa",
        "categoria de gasto","categoria clara","etiqueta clara", "etiqueta", "etiquetas", "categoria"
    ].map(normalize);

    const frasesPolitica = [
        "me envia a politica","me envia a pol√≠tica","me manda a politica","me manda a pol√≠tica",
        "pol√≠tica de uso","politica de uso do cartao","pol√≠tica de uso do cart√£o", "politica", "pol√≠tica",
        "politica do cartao","pol√≠tica do cart√£o","politica do cartao clara","pol√≠tica do cart√£o clara",
        "pdf da politica","pdf da pol√≠tica","manual da politica","manual da pol√≠tica",
        "politica clara","pol√≠tica clara","politica de uso dos cartoes","pol√≠tica de uso dos cart√µes"
    ].map(normalize);

    const frasesTermo = [
        "termo de responsabilidade",
        "termo responsabilidade",
        "termo de responsabilidade do cartao",
        "termo de responsabilidade do cart√£o",
        "termo do cartao",
        "termo do cart√£o",
        "termo de uso do cartao",
        "termo de uso do cart√£o",
        "termo",
        "termo clara",
        "termo do cartao clara",
        "termo do cart√£o clara",
        "termo de aceite",
        "termo de aceite do cartao",
        "termo de aceite do cart√£o",
        "assinar termo do cartao",
        "assinar termo da clara",
        "termo de responsabilidade clara"
    ].map(normalize);

    const saudacoes = [
        "oi","ol√°","ola","opa","eai","e a√≠","iae","oi vektor","ola vektor","ol√° vektor", "bom dia","boa tarde","boa noite", "bom dia!", "boa tarde!", "boa noite!",
        "salve","fala","fala vektor","e a√≠ vektor","eai vektor","opa vektor", "tudo bem","td bem","tdb","como vai","como vc ta","como voce ta", "beleza","tranquilo","tudo certo", "como vai vc", "como vai voc√™", "como t√°", "como ta", "eae", "i ae"
    ].map(normalize);

    const frasesEncerramento = [
        "ok","okay","okey","certo","blz","beleza","ok valeu", "entendi","entendido","tudo certo","td certo","tds certo", "√© nois q t√°", "√© n√≥is", "tmj", "tamo junto", "gratidao", "t√° bom","ta bom","t√° √≥timo","ta otimo","t√° otimo", "muito obrigado", "muito obrigada", "gratid√£o", "show","show de bola","valeu","vlw","obrigado","obrigada", "grato", "grata", "agradessido", "agradecida", "agradecido","agradessida","tranquilo","de boa","suave", "thanks", "tks", "pode deixar","certinho","maravilha","perfeito","j√≥ia","joia", "joinha", "tmj cachorro", "supimpa", "excelente", "fantastico", "fant√°stico", "saquei"
    ].map(normalize);

    const termosPendencias = [
        "pendencia clara","pend√™ncias clara","pendencias clara",
        "bloqueio por pendencia","bloqueio por pend√™ncia",
        "pendencia do cartao","pend√™ncia do cart√£o",
        "loja bloqueada clara","cart√£o bloqueado por pendencia",
        "cobran√ßa clara","transa√ß√µes pendentes clara",
        "pendencia","pend√™ncia","pendencias","pend√™ncias"
    ].map(normalize);

    const palavrasMudancaAssunto = [
        "cartao","cart√£o","etiqueta","categoria","politica","pol√≠tica","sangria",
        "bloqueio","novo","pendencia","pend√™ncia","comprar","limite","uber",
        "agua","√°gua","lanche","fraude","contestacao","contesta√ß√£o","prestacao","presta√ß√£o"
    ].map(normalize);


    const gatilhosNovoCartao = [
        "quero solicitar um cartao",
        "quero solicitar um cart√£o",
        "novo cartao",
        "novo cart√£o",
        "cartao novo",
        "cart√£o novo",
        "quero solicitar cartao clara",
        "quero solicitar cart√£o clara",
        "quero pedir um cartao",
        "quero pedir um cart√£o",
        "quero pedir cartao clara",
        "quero pedir cart√£o clara",
        "quero cartao clara",
        "quero cart√£o clara",
        "preciso de um cartao",
        "preciso de um cart√£o",
        "preciso de cartao clara",
        "preciso de cart√£o clara",
        "nao tenho cartao clara ainda",
        "n√£o tenho cartao clara ainda",
        "nao tenho cart√£o clara ainda",
        "ainda nao tenho cartao clara",
        "ainda n√£o tenho cart√£o clara",
        "como pedir cartao",
        "como pedir cart√£o",
        "como solicitar cartao",
        "como solicitar cart√£o",
        "como conseguir um cartao clara",
        "como conseguir um cart√£o clara",
        "fui promovido e nao tenho cartao",
        "fui promovido e n√£o tenho cart√£o",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e n√£o tenho cart√£o",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e n√£o tenho cart√£o",
        "primeira via do cartao",
        "primeira via do cart√£o",
        "1a via do cartao",
        "1¬™ via do cartao",
        "1a via do cart√£o",
        "1¬™ via do cart√£o",
        "preciso solicitar um cartao",
        "preciso solicitar um cart√£o",
        "gostaria de solicitar um cartao",
        "gostaria de solicitar um cart√£o",
        "quero novo cartao",
        "quero novo cart√£o",
        "preciso novo cartao",
        "preciso novo cart√£o",
        "nao tenho cartao",
        "n√£o tenho cart√£o",
        "nunca tive cartao",
        "nunca tive cart√£o"
    ].map(normalize);

    const termosPrimeiraViaDireta = [
        "primeira via",
        "1 via",
        "1a via",
        "1¬™ via",
        "primeiro cartao",
        "primeiro cart√£o",
        "meu primeiro cartao",
        "meu primeiro cart√£o",
        "nunca tive cartao clara",
        "nunca tive cart√£o clara",
        "quero minha primeira via",
        "quero 1 via",
        "pedir primeira via",
        "solicitar primeira via"
    ].map(normalize);

    const gatilhosSegundaViaDireta = [
        "segunda via",
        "2 via",
        "2a via",
        "2¬™ via",
        "segunda via",
        "segunda bia",
        "segundavia",
        "segunda vias",
        "segundas via",
        "segundas vias",
        "reemitir cartao",
        "reemitir cart√£o",
        "reemissao cartao",
        "reemissao de cartao",
        "reemissao de cartao",
        "reemiss√£o cart√£o",
        "reemitir meu cartao",
        "reemitir meu cart√£o",
        "perdi o cartao",
        "perdi o cart√£o",
        "perdi meu cartao",
        "perdi meu cart√£o",
        "perdi o meu cart√£o",
        "perdi o meu cartao",
        "eu perdi o cart√£o",
        "eu perdi o cartao",
        "percas de cartao",
        "perca de cart√£o",
        "perca de cartao",
        "perda de cartao",
        "perda de cart√£o",
        "solicitar segunda via",
        "solicitar 2via",
        "solicitar 2 via",
        "solicita√ß√£o de segunda via",
        "solicita√ß√£o de 2 via",
        "roubaram meu cartao",
        "roubaram meu cart√£o",
        "me roubaram",
        "mi roubaram",
        "fui roubado",
        "cartao furtado",
        "furto",
        "cart√£o furtado",
        "roubo",
        "roubo de cart√£o",
        "perda de cart√£o",
        "perca de cart√£o",
        "cartao quebrado",
        "cart√£o quebrado",
        "cartao danificado",
        "cart√£o danificado"
    ].map(normalize);

    const perguntasGeraisOquePosso = [
        "o que posso comprar",
        "oq comprar com o cart√£o da Clara",
        "o que pode comprar",
        "o que pode comprar com o cart√£o",
        "o que pode comprar com o cartao",
        "oque comprar",
        "o que comprar",
        "posso comprar o que",
        "o que posso usar",
        "quais compras",
        "o que √© permitido",
        "o que nao posso",
        "o que n√£o posso",
        "o que nao posso comprar",
        "o que n√£o posso comprar",
        "o que nao comprar",
        "o que n√£o comprar"
    ].map(normalize);


    // Pede permiss√£o pro navegador mostrar notifica√ß√µes
            function solicitarPermissaoNotificacao() {
              if (!("Notification" in window)) {
                console.log("Navegador n√£o suporta Notification API.");
                return;
              }

              if (Notification.permission === "default") {
                // S√≥ pede se ainda n√£o tiver "granted" nem "denied"
                Notification.requestPermission().then((result) => {
                  console.log("Permiss√£o de notifica√ß√£o:", result);
                });
              }
            }

          // Dispara notifica√ß√£o quando chega mensagem nova do bot
            function notificarNovaMensagem(text) {
              if (!("Notification" in window)) return;
              if (Notification.permission !== "granted") return;

              let conteudo = "";

              if (typeof text === "string") {
                if (text.startsWith("HTML:")) {
                  const semPrefixo = text.replace(/^HTML:/, "");
                  conteudo = semPrefixo.replace(/<[^>]+>/g, " ");
                } else {
                  conteudo = text;
                }
              }

              conteudo = conteudo.trim();
              if (!conteudo) return;

              if (conteudo.length > 140) {
                conteudo = conteudo.slice(0, 137) + "...";
              }

              new Notification("Vektor - nova resposta", {
                body: conteudo,
                icon: ROBOT_IMG_URL
              });
            }



    /* ========= INTEN√á√ÉO ========= */

    function detectarIntencaoPergunta(msgNorm) {
        const foraEscopoPadroes = [
            "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
            "presidente","futebol","time joga","campeonato","xing","vai tomar",
            "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
            "piada","xingar","palavr√£o","palavrao"
        ];
        for (const termo of foraEscopoPadroes) {
            if (msgNorm.includes(normalize(termo))) {
                return "foraEscopo";
            }
        }

        if (msgNorm.includes("etiqueta") ||
            msgNorm.includes("etiquetas") ||
            msgNorm.includes("qual etiqueta") ||
            msgNorm.includes("que etiqueta")) {
            return "etiqueta";
        }

        if (msgNorm.includes("aumentar limite") ||
            msgNorm.includes("aumento de limite") ||
            msgNorm.includes("limite maior") ||
            msgNorm.includes("limite do cartao") ||
            msgNorm.includes("limite do cart√£o") ||
            msgNorm.includes("limite nao basta") ||
            msgNorm.includes("limite n√£o basta") ||
            msgNorm.includes("limite acabou") ||
            msgNorm.includes("limite estourou") ||
            msgNorm.includes("quero mais limite") ||
            msgNorm.includes("preciso de mais limite") ||
            msgNorm.includes("como aumentar meu limite") ||
            msgNorm.includes("solicitar aumento de limite") ||
            msgNorm.includes("limite baixo") ||
            msgNorm.includes("qual o limite do cartao") ||
            msgNorm.includes("qual o limite do cart√£o") ||
            msgNorm.includes("meu limite") ||
            msgNorm.includes("consultar limite") ||
            msgNorm.includes("ver limite") ||
            msgNorm.includes("quanto tenho de limite") ||
            msgNorm.includes("limite disponivel") ||
            msgNorm.includes("limite dispon√≠vel") ||
            msgNorm.includes("baixar limite") ||
            msgNorm.includes("diminuir limite") ||
            msgNorm.includes("limite de credito") ||
            msgNorm.includes("limite de cr√©dito") ||
            msgNorm.includes("limite total") ||
            msgNorm.includes("limite nao liberado") ||
            msgNorm.includes("limite n√£o liberado") ||
            msgNorm.includes("limite acabou de novo") ||
            msgNorm.includes("por que meu limite nao aumenta") ||
            msgNorm.includes("por que meu limite n√£o aumenta") ||
            msgNorm.includes("limite esgotado") ||
            msgNorm.includes("gastei o limite todo") ||
            msgNorm.includes("aumento de credito") ||
            msgNorm.includes("aumento de cr√©dito") ||
            msgNorm.includes("ajustar limite") ||
            msgNorm.includes("liberar mais limite") ||
            msgNorm.includes("limite")) {
            return "limite";
        }

                // üîπ Transa√ß√£o negada / categoria bloqueada para compra
        if (
            msgNorm.includes("transacao negada") ||
            msgNorm.includes("transa√ß√£o negada") ||
            msgNorm.includes("transacao recusada") ||
            msgNorm.includes("transa√ß√£o recusada") ||
            msgNorm.includes("compra negada") ||
            msgNorm.includes("compra recusada") ||
            msgNorm.includes("compra rejeitada") ||
            msgNorm.includes("compra nao passou") ||
            msgNorm.includes("compra n√£o passou") ||
            msgNorm.includes("compra nao autorizada") ||
            msgNorm.includes("compra n√£o autorizada") ||
            msgNorm.includes("transacao nao autorizada") ||
            msgNorm.includes("transa√ß√£o n√£o autorizada") ||
            msgNorm.includes("transacao bloqueada") ||
            msgNorm.includes("transa√ß√£o bloqueada") ||
            msgNorm.includes("cartao nao passou") ||
            msgNorm.includes("cart√£o n√£o passou") ||
            msgNorm.includes("cartao recusado") ||
            msgNorm.includes("cart√£o recusado") ||
            msgNorm.includes("cartao negado") ||
            msgNorm.includes("cart√£o negado") ||
            msgNorm.includes("cartao nao autorizou") ||
            msgNorm.includes("cart√£o n√£o autorizou") ||
            msgNorm.includes("cartao travou na maquininha") ||
            msgNorm.includes("cartao travou na m√°quina") ||
            msgNorm.includes("cartao travou") ||
            msgNorm.includes("cart√£o travou") ||
            msgNorm.includes("nao passou o cartao") ||
            msgNorm.includes("n√£o passou o cart√£o") ||
            msgNorm.includes("nao autorizou a compra") ||
            msgNorm.includes("n√£o autorizou a compra") ||
            msgNorm.includes("recusou a compra") ||
            msgNorm.includes("recusou o pagamento") ||
            msgNorm.includes("falha na compra") ||
            msgNorm.includes("falha de pagamento") ||
            msgNorm.includes("erro na compra") ||
            msgNorm.includes("erro de pagamento") ||
            msgNorm.includes("erro no cartao") ||
            msgNorm.includes("erro no cart√£o") ||
            msgNorm.includes("compra deu erro") ||
            msgNorm.includes("pagamento negado") ||
            msgNorm.includes("pagamento recusado") ||
            msgNorm.includes("pagamento bloqueado") ||
            msgNorm.includes("categoria bloqueada") ||
            msgNorm.includes("categoria bloqueado") ||
            msgNorm.includes("categoria nao liberada") ||
            msgNorm.includes("tentando usar o cart√£o") ||
            msgNorm.includes("tentando usar o cartao") ||
            msgNorm.includes("categoria n√£o liberada") ||
            msgNorm.includes("liberar categoria") ||
            msgNorm.includes("liberacao de categoria") ||
            msgNorm.includes("tentei passar o cart√£o e deu erro") ||
            msgNorm.includes("tentar passar o cart√£o") ||
            msgNorm.includes("tentar passar o cartao") ||
            msgNorm.includes("tentar usar o cartao") ||
            msgNorm.includes("tentar usar o cart√£o") ||
            msgNorm.includes("tentei passar o cartao e deu erro") ||
            msgNorm.includes("a compra foi recusada na maquininha") ||
            msgNorm.includes("n√£o consegui usar o cart√£o") ||
            msgNorm.includes("n√£o consegui usar o cartao") ||
            msgNorm.includes("nao consegui usar o cartao") ||
            msgNorm.includes("libera√ß√£o de categoria") ||
            msgNorm.includes("mcc bloqueado") ||
            msgNorm.includes("codigo bloqueado") ||
            msgNorm.includes("c√≥digo bloqueado") ||
            msgNorm.includes("nao liberou") ||
            msgNorm.includes("n√£o liberou") ||
            msgNorm.includes("nao conseguiu passar") ||
            msgNorm.includes("n√£o conseguiu passar") ||
            msgNorm.includes("nao consegui usar") ||
            msgNorm.includes("n√£o consegui usar") ||
            msgNorm.includes("tentei usar e nao foi") ||
            msgNorm.includes("tentei usar e n√£o foi") ||
            msgNorm.includes("tentei comprar e deu erro") ||
            msgNorm.includes("tentou passar e nao foi") ||
            msgNorm.includes("tentou passar e n√£o foi") ||
            msgNorm.includes("nao aceitou") ||
            msgNorm.includes("n√£o aceitou") ||
            msgNorm.includes("nao deu certo a compra") ||
            msgNorm.includes("n√£o deu certo a compra") ||
            msgNorm.includes("bloqueou a compra") ||
            msgNorm.includes("bloqueou a transacao") ||
            msgNorm.includes("bloqueou a transa√ß√£o") ||
            msgNorm.includes("compra nao permitida") ||
            msgNorm.includes("compra n√£o permitida") ||
            msgNorm.includes("transacao nao permitida") ||
            msgNorm.includes("transa√ß√£o n√£o permitida")) 

          {
            return "  ";}


        if (msgNorm.includes("bloqueou") ||
            msgNorm.includes("bloqueado") ||
            msgNorm.includes("desbloquear") ||
            msgNorm.includes("cartao travou") ||
            msgNorm.includes("cart√£o travou") ||
            msgNorm.includes("travou o cartao") ||
            msgNorm.includes("travou o cart√£o") ||
            msgNorm.includes("bloquear cartao") ||
            msgNorm.includes("bloquear cart√£o") ||
            msgNorm.includes("queria bloquear") ||
            msgNorm.includes("quero bloquear") ||
            msgNorm.includes("como bloquear") ||
            msgNorm.includes("cartao bloqueado") ||
            msgNorm.includes("cart√£o bloqueado") ||
            msgNorm.includes("meu cartao nao funciona") ||
            msgNorm.includes("meu cart√£o n√£o funciona") ||
            msgNorm.includes("meu cart√£o t√° bloqueado") ||
            msgNorm.includes("pq meu cart√£o t√° bloqueadp") ||
            msgNorm.includes("pq meu cart√£o t√° bloqueado") ||
            msgNorm.includes("meu cartao ta bloqueado") ||
            msgNorm.includes("nao consigo usar o cartao") ||
            msgNorm.includes("n√£o consigo usar o cart√£o") ||
            msgNorm.includes("problema no cartao") ||
            msgNorm.includes("problema no cart√£o") ||
            msgNorm.includes("suspender cartao") ||
            msgNorm.includes("suspender cart√£o") ||
            msgNorm.includes("suspender o uso") ||
            msgNorm.includes("o cartao parou") ||
            msgNorm.includes("o cart√£o parou") ||
            msgNorm.includes("ativar cartao") ||
            msgNorm.includes("ativar cart√£o") ||
            msgNorm.includes("reativar cartao") ||
            msgNorm.includes("reativar cart√£o") ||
            msgNorm.includes("travamento") ||
            msgNorm.includes("por que nao funciona") ||
            msgNorm.includes("por que n√£o funciona") ||
            msgNorm.includes("desliguei o cartao") ||
            msgNorm.includes("desliguei o cart√£o") ||
            msgNorm.includes("bloqueio preventivo")) {
            return "bloqueio";
      }

        if (msgNorm.includes("como justificar") ||
            msgNorm.includes("justificar compra") ||
            msgNorm.includes("prestar contas") ||
            msgNorm.includes("prestacao de contas") ||
            msgNorm.includes("presta√ß√£o de contas") ||
            msgNorm.includes("colocar nota") ||
            msgNorm.includes("inserir nota") ||
            msgNorm.includes("anexar nota") ||
            msgNorm.includes("descricao na clara") ||
            msgNorm.includes("como inserir nota") ||
            msgNorm.includes("nota fiscal") ||
            msgNorm.includes("nota da compra") ||
            msgNorm.includes("escrever justificativa") ||
            msgNorm.includes("como colocar justificativa") ||
            msgNorm.includes("comprovante") ||
            msgNorm.includes("comprovantes") ||
            msgNorm.includes("comprovante de compra") ||
            msgNorm.includes("comprovacao de despesa") ||
            msgNorm.includes("comprova√ß√£o de despesa") ||
            msgNorm.includes("registro de despesa") ||
            msgNorm.includes("lan√ßar despesa") ||
            msgNorm.includes("lancamento de despesa") ||
            msgNorm.includes("lan√ßamento de despesa") ||
            msgNorm.includes("reembolso sem nota") ||
            msgNorm.includes("perdi a nota") ||
            msgNorm.includes("despesa sem comprovante") ||
            msgNorm.includes("colocar comprovante") ||
            msgNorm.includes("como declarar") ||
            msgNorm.includes("declarar despesa") ||
            msgNorm.includes("como finalizar prestacao") ||
            msgNorm.includes("como finalizar presta√ß√£o") ||
            msgNorm.includes("relatorio de despesa") ||
            msgNorm.includes("relat√≥rio de despesa") ||
            msgNorm.includes("enviar nota") ||
            msgNorm.includes("falta a nota") ||
            msgNorm.includes("despesa sem nota") ||
            msgNorm.includes("finalizar contas") ||
            msgNorm.includes("minhas prestacoes") ||
            msgNorm.includes("minhas presta√ß√µes") ||
            msgNorm.includes("descri√ß√£o na clara")) {
            return "prestacao";
        }

        if (msgNorm.includes("lanche") ||
            msgNorm.includes("lanche pro time") ||
            msgNorm.includes("lanche para o time") ||
            msgNorm.includes("cafe pro time") ||
            msgNorm.includes("caf√© pro time") ||
            msgNorm.includes("coffee break") ||
            msgNorm.includes("agua") ||
            msgNorm.includes("√°gua") ||
            msgNorm.includes("gal√£o") ||
            msgNorm.includes("galao") ||
            msgNorm.includes("premiacao") ||
            msgNorm.includes("premia√ß√£o")) {
            return "alimentoTime";
        }

        if (msgNorm.includes("uber") ||
            msgNorm.includes("iber") ||
            msgNorm.includes(" 99") ||
            msgNorm.includes("taxi") ||
            msgNorm.includes("t√°xi") ||
            msgNorm.includes("tax√≠") ||
            msgNorm.includes("cabify") ||
            msgNorm.includes("transporte") ||
            msgNorm.includes("aplicativo de transporte") ||
            msgNorm.includes("motorista de aplicativo") ||
            msgNorm.includes("carro por app") ||
            msgNorm.includes("carona") ||
            msgNorm.includes("como chamar um carro") ||
            msgNorm.includes("como pedir um carro") ||
            msgNorm.includes("uber black") ||
            msgNorm.includes("uber x") ||
            msgNorm.includes("99 pop") ||
            msgNorm.includes("99taxi") ||
            msgNorm.includes("uber drive") ||
            msgNorm.includes("uber motorista") ||
            msgNorm.includes("uber pass") ||
            msgNorm.includes("uber eats") ||
            msgNorm.includes("servi√ßo de transporte") ||
            msgNorm.includes("qual app de carro") ||
            msgNorm.includes("motorista particular") ||
            msgNorm.includes("drive") ||
            msgNorm.includes("drivi") ||
            msgNorm.includes("indriver") ||
            msgNorm.includes("in driver") ||
            msgNorm.includes("waze carpool") ||
            msgNorm.includes("waze car pool") ||
            msgNorm.includes("taxi particular") ||
            msgNorm.includes("taxi 99") ||
            msgNorm.includes("app de taxi") ||
            msgNorm.includes("app de t√°xi") ||
            msgNorm.includes("app de transporte")) {
            return "transportePessoal";
        }

        if (msgNorm.includes("mudar de loja") ||
            msgNorm.includes("troca de loja") ||
            msgNorm.includes("trocar de loja") ||
            msgNorm.includes("mudan√ßa de loja") ||
            msgNorm.includes("mudanca de loja") ||
            msgNorm.includes("vou mudar de loja") ||
            msgNorm.includes("fui transferido") ||
            msgNorm.includes("transferido de loja") ||
            msgNorm.includes("transferencia de loja") ||
            msgNorm.includes("transfer√™ncia de loja") ||
            msgNorm.includes("gerente desligado") ||
            msgNorm.includes("sem gerente") ||
            msgNorm.includes("gerente saiu") ||
            msgNorm.includes("gerente saiu da loja") ||
            msgNorm.includes("cartao de outra loja") ||
            msgNorm.includes("cart√£o de outra loja") ||
            msgNorm.includes("usar cartao de outra loja") ||
            msgNorm.includes("trocar minha loja") ||
            msgNorm.includes("mudar minha loja") ||
            msgNorm.includes("sair da loja") ||
            msgNorm.includes("qual minha loja") ||
            msgNorm.includes("quero mudar a loja") ||
            msgNorm.includes("mudei de unidade") ||
            msgNorm.includes("trocar de unidade") ||
            msgNorm.includes("como troco de loja") ||
            msgNorm.includes("troquei de loja") ||
            msgNorm.includes("sou de outra loja") ||
            msgNorm.includes("sou de outra unidade") ||
            msgNorm.includes("cartao de loja diferente") ||
            msgNorm.includes("cart√£o de loja diferente") ||
            msgNorm.includes("gerente novo") ||
            msgNorm.includes("novo gerente") ||
            msgNorm.includes("cadastro de gerente") ||
            msgNorm.includes("tirar gerente") ||
            msgNorm.includes("excluir gerente") ||
            msgNorm.includes("quem e o gerente") ||
            msgNorm.includes("quem √© o gerente") ||
            msgNorm.includes("problema com gerente") ||
            msgNorm.includes("gerente nao esta na loja") ||
            msgNorm.includes("gerente n√£o est√° na loja") ||
            msgNorm.includes("minha loja esta sem gerente") ||
            msgNorm.includes("gerente demitido") ||
            msgNorm.includes("colocar cartao de outra loja") ||
            msgNorm.includes("habilitar cartao de outra loja") ||
            msgNorm.includes("como uso o cartao em outra loja") ||
            msgNorm.includes("cartao nao funciona em outra loja") ||
            msgNorm.includes("cart√£o n√£o funciona em outra loja") ||
            msgNorm.includes("usar cart√£o de outra loja")) {
            return "trocaGerente";
        }

        if (msgNorm.includes("sangria") ||
            msgNorm.includes("sangrias") ||
            msgNorm.includes("fazer sangria") ||
            msgNorm.includes("puxar dinheiro do caixa") ||
            msgNorm.includes("retirar dinheiro do caixa") ||
            msgNorm.includes("tirar dinheiro do caixa") ||
            msgNorm.includes("retirada de dinheiro do caixa") ||
            msgNorm.includes("movimentacao de dinheiro no caixa") ||
            msgNorm.includes("movimenta√ß√£o de dinheiro no caixa") ||
            msgNorm.includes("fechar o caixa") ||
            msgNorm.includes("como fechar o caixa") ||
            msgNorm.includes("retirar valor do caixa") ||
            msgNorm.includes("como fazer sangria") ||
            msgNorm.includes("registrar saida de dinheiro") ||
            msgNorm.includes("registrar sa√≠da de dinheiro") ||
            msgNorm.includes("saida de dinheiro do caixa") ||
            msgNorm.includes("sa√≠da de dinheiro do caixa") ||
            msgNorm.includes("suprimento") ||
            msgNorm.includes("suprimentos") ||
            msgNorm.includes("fazer suprimento") ||
            msgNorm.includes("colocar dinheiro no caixa") ||
            msgNorm.includes("registro de suprimento") ||
            msgNorm.includes("registro de retirada") ||
            msgNorm.includes("registrando sangria") ||
            msgNorm.includes("registro de sangria") ||
            msgNorm.includes("tirar troco do caixa") ||
            msgNorm.includes("depositar dinheiro no caixa") ||
            msgNorm.includes("deposito no caixa") ||
            msgNorm.includes("dep√≥sito no caixa") ||
            msgNorm.includes("remocao de dinheiro") ||
            msgNorm.includes("remo√ß√£o de dinheiro") ||
            msgNorm.includes("retirar excesso") ||
            msgNorm.includes("dinheiro a mais no caixa") ||
            msgNorm.includes("ajuste de caixa") ||
            msgNorm.includes("retirar dinheiro do caixa")) {
            return "sangria";
        }

        if (msgNorm.includes("nao reconheco") ||
            msgNorm.includes("n√£o reconhe√ßo") ||
            msgNorm.includes("fraude") ||
            msgNorm.includes("compra indevida") ||
            msgNorm.includes("contestar compra") ||
            msgNorm.includes("contestacao") ||
            msgNorm.includes("compra que nao fiz") ||
            msgNorm.includes("compra que n√£o fiz") ||
            msgNorm.includes("nao fiz essa compra") ||
            msgNorm.includes("n√£o fiz essa compra") ||
            msgNorm.includes("compra desconhecida") ||
            msgNorm.includes("uso indevido") ||
            msgNorm.includes("estorno") ||
            msgNorm.includes("quero estornar") ||
            msgNorm.includes("quero cancelar compra") ||
            msgNorm.includes("cancelar compra indevida") ||
            msgNorm.includes("compra suspeita") ||
            msgNorm.includes("transacao nao reconhecida") ||
            msgNorm.includes("transa√ß√£o n√£o reconhecida") ||
            msgNorm.includes("cartao clonado") ||
            msgNorm.includes("clonaram meu cartao") ||
            msgNorm.includes("clonaram meu cart√£o") ||
            msgNorm.includes("roubaram meu cartao") ||
            msgNorm.includes("roubaram meu cart√£o") ||
            msgNorm.includes("uso nao autorizado") ||
            msgNorm.includes("uso n√£o autorizado") ||
            msgNorm.includes("quero o dinheiro de volta") ||
            msgNorm.includes("reembolso") ||
            msgNorm.includes("solicitar estorno") ||
            msgNorm.includes("transacao suspeita") ||
            msgNorm.includes("tentativa de fraude") ||
            msgNorm.includes("estorno da compra") ||
            msgNorm.includes("cai em golpe") ||
            msgNorm.includes("golpe no cartao") ||
            msgNorm.includes("golpe no cart√£o") ||
            msgNorm.includes("fui roubado") ||
            msgNorm.includes("contesta√ß√£o")) {
            return "fraudeContestacao";
        }


        // assunto geral sobre o cart√£o
        if (
          msgNorm.includes("cartao clara") ||
          msgNorm.includes("cart√£o clara") ||
          msgNorm.includes("cartao") && msgNorm.includes("clara") ||
          msgNorm.includes("cartao das lojas") ||
          msgNorm.includes("cartao nas lojas") ||
          msgNorm.includes("cart√£o das lojas") ||
          msgNorm.includes("detalhe cart√£o clara") ||
          msgNorm.includes("detalhes cartao clara") ||
          msgNorm.includes("como funciona a clara") ||
          msgNorm.includes("oq √© a clara") ||
          msgNorm.includes("falar sobre o cartao") ||
          msgNorm.includes("falar sobre o cart√£o") ||
          msgNorm.includes("cartao corporativo") ||
          msgNorm.includes("cart√£o nas lojas") ||
          msgNorm.includes("informa√ß√µes sobre o cartao") ||
          msgNorm.includes("informa√ß√µes sobre o cart√£o") ||
          msgNorm.includes("duvida sobre o cartao") ||
          msgNorm.includes("d√∫vida sobre o cart√£o") ||
          msgNorm.includes("tudo sobre a clara") ||
          msgNorm.includes("o que √© a clara") ||
          msgNorm.includes("como funciona o cartao") ||
          msgNorm.includes("como funciona o cart√£o") ||
          msgNorm.includes("cartao das lojas") ||
          msgNorm.includes("cart√£o das lojas") ||
          msgNorm.includes("regras do cartao") ||
          msgNorm.includes("regras do cart√£o") ||
          msgNorm.includes("detalhes sobre a clara") ||
          msgNorm.includes("como usar o cartao") ||
          msgNorm.includes("como usar o cart√£o") ||
          msgNorm.includes("duvidas sobre a clara") ||
          msgNorm.includes("d√∫vidas sobre a clara") ||
          msgNorm.includes("detalhes do cartao") ||
          msgNorm.includes("detalhes do cart√£o") ||
          msgNorm.includes("tudo sobre o cartao") ||
          msgNorm.includes("tudo sobre o cart√£o") ||
          msgNorm.includes("o que e a clara") ||
          msgNorm.includes("o q e a clara") ||
          msgNorm.includes("cartao de credito corporativo") ||
          msgNorm.includes("cart√£o de cr√©dito corporativo") ||
          msgNorm.includes("informacao cartao") ||
          msgNorm.includes("informa√ß√£o cart√£o") ||
          msgNorm.includes("duvida clara") ||
          msgNorm.includes("d√∫vida clara") ||
          msgNorm.includes("cart√£o corporativo")
        ) {
          return "cartaoGeral";
        }


        if (msgNorm.includes("posso comprar") ||
            msgNorm.includes("posso usar") ||
            msgNorm.includes("pode usar") ||
            msgNorm.includes("pode pagar") ||
            msgNorm.includes("pode gastar") ||
            msgNorm.includes("pode comprar") ||
            msgNorm.includes("o que pode comprar") ||
            msgNorm.includes("oq eu posso comprar com o cart√£o") ||
            msgNorm.includes("oq pode comprar") ||
            msgNorm.includes("pode no cartao") ||
            msgNorm.includes("pode no cart√£o") ||
            msgNorm.includes("pode colocar no cartao") ||
            msgNorm.includes("pode colocar no cart√£o") ||
            msgNorm.includes("posso usar o cartao para") ||
            msgNorm.includes("posso usar o cart√£o para") ||
            msgNorm.includes("para que posso usar") ||
            msgNorm.includes("o que da pra pagar") ||
            msgNorm.includes("oq da pra pagar") ||
            msgNorm.includes("o que da para pagar") ||
            msgNorm.includes("posso pagar") ||
            msgNorm.includes("oq pagar") ||
            msgNorm.includes("pagar com o cartao") ||
            msgNorm.includes("pagar com o cart√£o") ||
            msgNorm.includes("oque posso pagar") ||
            msgNorm.includes("o q posso pagar") ||
            msgNorm.includes("oq eu posso pagar") ||
            msgNorm.includes("eu posso pagar") ||
            msgNorm.includes("posso passar o cartao") ||
            msgNorm.includes("posso passar o cart√£o") ||
            msgNorm.includes("oq eu gasto") ||
            msgNorm.includes("o que posso gastar") ||
            msgNorm.includes("posso usar cartao") ||
            msgNorm.includes("posso usar cart√£o") ||
            msgNorm.includes("o que posso fazer") ||
            msgNorm.includes("oq da pra fazer") ||
            msgNorm.includes("posso adquirir") ||
            msgNorm.includes("que da pra adquirir") ||
            msgNorm.includes("para que serve o cartao") ||
            msgNorm.includes("para que serve o cart√£o") ||
            msgNorm.includes("em que posso usar") ||
            msgNorm.includes("em que eu posso usar") ||
            msgNorm.includes("oq pode pagar") ||
            msgNorm.includes("pode ser pago") ||
            perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
            return "podeNaoPode";
        }

        // BOT: SOBRE O QUE ELE PODE FAZER
        if (
            msgNorm.includes("o que voce faz") ||
            msgNorm.includes("qual o seu nome") ||
            msgNorm.includes("qual seu nome") ||
            msgNorm.includes("qual √© o seu nome") ||
            msgNorm.includes("qual eh o seu nome") ||
            msgNorm.includes("qual eh seu nome") ||
            msgNorm.includes("como vc se chama") ||
            msgNorm.includes("como voce se chama") ||
            msgNorm.includes("como voc√™ se chama") ||
            msgNorm.includes("como vc chama") ||
            msgNorm.includes("como voce chama") ||
            msgNorm.includes("como voc√™ chama") ||
            msgNorm.includes("o que voc√™ faz") ||
            msgNorm.includes("o que vc faz") ||
            msgNorm.includes("pra que serve") ||
            msgNorm.includes("qual sua fun√ß√£o") ||
            msgNorm.includes("qual √© sua fun√ß√£o") ||
            msgNorm.includes("qual e sua fun√ß√£o") ||
            msgNorm.includes("qual sua funcao") ||
            msgNorm.includes("qual √© sua funcao") ||
            msgNorm.includes("quem √© voc√™") ||
            msgNorm.includes("quem e voce") ||
            msgNorm.includes("quem √© vc") ||
            msgNorm.includes("qm √© vc") ||
            msgNorm.includes("qm e vc") ||
            msgNorm.includes("qm eh vc") ||
            msgNorm.includes("qm eh voce") ||
            msgNorm.includes("qm eh voc√™") ||
            msgNorm.includes("quem e vc") ||
            msgNorm.includes("quem √© voc√™ clara") ||
            msgNorm.includes("quem √© o vektor") ||
            msgNorm.includes("quem √© voc√™ vektor") ||
            msgNorm.includes("qual seu papel") ||
            msgNorm.includes("como pode me ajudar") ||
            msgNorm.includes("o que pode fazer") ||
            msgNorm.includes("o que voce pode fazer") ||
            msgNorm.includes("o que voc√™ pode fazer") ||
            msgNorm.includes("sobre o que voce fala") ||
            msgNorm.includes("sobre o que voc√™ fala") ||
            msgNorm.includes("o que pode me orientar")||
            msgNorm.includes("pra que fui criado") ||
            msgNorm.includes("qual e meu proposito") ||
            msgNorm.includes("qual √© o seu proposito") ||
            msgNorm.includes("qual eh o seu proposito") ||
            msgNorm.includes("qual eh o seu fim") ||
            msgNorm.includes("meu proposito") ||  
            msgNorm.includes("diga o que sabe")	||  
            msgNorm.includes("me fale sobre voce") ||
            msgNorm.includes("me fale o que faz") ||	  
            msgNorm.includes("qual a sua utilidade") ||  
            msgNorm.includes("fun√ß√£o") ||
            msgNorm.includes("sua fun√ß√£o") ||
            msgNorm.includes("utilidade") ||
            msgNorm.includes("quais suas funcoes") ||
            msgNorm.includes("o q c faz") ||
            msgNorm.includes("o q faz") ||
            msgNorm.includes("o que √© isso") ||
            msgNorm.includes("oque √© isso") ||
            msgNorm.includes("oq √© isso") ||
            msgNorm.includes("oq eh isso") ||
            msgNorm.includes("o que voc√™ pode responder") ||
            msgNorm.includes("o que voc√™ pode responde") ||
            msgNorm.includes("oq vc faz?") ||
            msgNorm.includes("oq vc faz") ||
            msgNorm.includes("oq vc pode fazer") ||
            msgNorm.includes("oq vc consegue responder") ||
            msgNorm.includes("quais perguntas vc consegue responder") ||
            msgNorm.includes("quais perguntas voce consegue responder") ||
            msgNorm.includes("quais perguntas voc√™ consegue responder") ||
            msgNorm.includes("quais perguntas voc√™ pode responder") ||
            msgNorm.includes("quais perguntas voc√™ responder") ||
            msgNorm.includes("quais perguntas voc√™ responde") ||
            msgNorm.includes("o que vc pode fazer") ||
            msgNorm.includes("oque vc pode fazer") ||
            msgNorm.includes("oq voc√™ pode fazer") ||
            msgNorm.includes("oq voce pode fazer") ||
            msgNorm.includes("oq voce faz?") ||
            msgNorm.includes("o que voce faz?") ||
            msgNorm.includes("o que vc faz?") ||
            msgNorm.includes("o que vc pode fazer") ||
            msgNorm.includes("o que vc sabe fazer") ||
            msgNorm.includes("pra que voce serve") ||
            msgNorm.includes("pra que voc√™ serve") ||
            msgNorm.includes("pra que vc serve") ||
            msgNorm.includes("me explica o que faz") ||
            msgNorm.includes("me diga o que faz") ||
            msgNorm.includes("explica sua fun√ß√£o")
    ) 
    {
        return "sobreBot";
    }

            // ‚úÖ Inten√ß√£o: conversa geral sobre o cart√£o Clara
    if (
        msgNorm.includes("cartao clara") ||
        msgNorm.includes("cart√£o clara") ||
        (msgNorm.includes("cartao") && msgNorm.includes("clara")) ||
        (msgNorm.includes("cart√£o") && msgNorm.includes("clara")) ||
        msgNorm.includes("cartao das lojas") ||
        msgNorm.includes("cart√£o das lojas") ||
        msgNorm.includes("cartao nas lojas") ||
        msgNorm.includes("cart√£o nas lojas") ||
        msgNorm.includes("falar sobre o cartao") ||
        msgNorm.includes("falar sobre o cart√£o") ||
        msgNorm.includes("informacoes sobre o cartao") ||
        msgNorm.includes("informa√ß√µes sobre o cart√£o") ||
        msgNorm.includes("duvida sobre o cartao") ||
        msgNorm.includes("d√∫vida sobre o cart√£o") ||
        msgNorm.includes("tudo sobre a clara") ||
        msgNorm.includes("como funciona a clara") ||
        msgNorm.includes("o que √© a clara") ||
        msgNorm.includes("o que e a clara") ||
        msgNorm.includes("o q e a clara") ||
        msgNorm.includes("cartao corporativo") ||
        msgNorm.includes("cart√£o corporativo") ||
        msgNorm.includes("cartao de credito corporativo") ||
        msgNorm.includes("cart√£o de cr√©dito corporativo") ||
        msgNorm.includes("duvida clara") ||
        msgNorm.includes("d√∫vida clara")
    ) {
        return "cartaoGeral";
    }

    return "generica";
}


    /* ========= ETIQUETA POR MENSAGEM ========= */

    function acharEtiquetaPorMensagem(msgNorm) {
        const stopTerms = [
            "etiqueta","qual etiqueta","que etiqueta","categoria","qual categoria",
            "classificacao","classifica√ß√£o","tag","pode usar","posso usar",
            "posso comprar","pode comprar","cartao","cart√£o","cartao clara",
            "cart√£o clara","clara","limite","ajuda","duvida","d√∫vida"
        ].map(normalize);

        const palavras = msgNorm.split(/\s+/);

        let melhorMatch = null;
        let melhorForca = 0;

        for (const et of etiquetasOficiais) {
            let forcaAtual = 0;

            for (const termoOriginal of et.palavrasChave) {
                const termoNorm = normalize(termoOriginal);
                if (stopTerms.includes(termoNorm)) continue;

                if (palavras.includes(termoNorm)) {
                    forcaAtual += 2;
                }
                if (msgNorm.includes(termoNorm)) {
                    forcaAtual += 1;
                }
            }

            if (forcaAtual > melhorForca) {
                melhorForca = forcaAtual;
                melhorMatch = et;
            }
        }

        if (melhorForca === 0) return null;
        return melhorMatch;
    }

                /* ========= AVALIA√á√ÉO DE COMPRA ========= */

    const gruposProibidos = {
        eletrodomesticos: [
            "geladeira", "microondas", "micro-ondas", "friogrifico", "freezer", "frigobar", "Geladeira",
            "Refrigerador", "Fog√£o", "Cooktop", "Forno", "M√°quina de Lavar Lou√ßas", "Coifa", "Depurador",
            "Purificador de √Ågua", "M√°quina de Lavar Roupas", "Secadora de Roupas", "Centr√≠fuga", "secadora",
            "secadora de lou√ßas", "lavadora", "lava-roupas", "lava e seca", "lava-lou√ßas", "exaustor", "purificador",
            "bebedouro", "forno-microondas"
        ].map(normalize),

        eletroportateis: [
            "Liquidificador", "Batedeira", "Processador de Alimentos", "Mixer", "Air Fryer", "airfryer", "airfrier",
            "Panela El√©trica", "M√°quina de P√£o", "M√°quina de Waffle", "Cafeteira", "Chaleira", "Extrator de Suco",
            "Torradeira", "Sanduicheira", "Pipoqueira El√©trica", "Abridor de Lata El√©trico", "Abridor de Vinho El√©trico",
            "ferro", "ferro de passar", "Ferro de Passar Roupa", "M√°quina de Costura", "Aspirador de P√≥",
            "Lavadora de Jato de √Ågua", "Limpadora a Vapor", "Secador de Cabelo", "Chapinha", "Prancha",
            "Barbeador El√©trico", "barbeador", "Escova de Dente El√©trica", "escova de dente", "vaporizador"
        ].map(normalize),

        climatizacao: [
            "compressor", "ventilador", "ar condicionado", "ar-condicionado", "Ventilador", "Aquecedor El√©trico",
            "Desumidificador", "compressor de ar", "aquecedor", "climatizador"
        ].map(normalize),

        moveisUtensiliosCasa: [
            "mesa", "cadeira", "sof√°", "poltrona", "arm√°rio", "c√¥moda", "estante", "tapete", "persiana", "lustre",
            "aquario", "aquarios", "churraqueira", "carv√£o", "churrasco", "cadeira de balan√ßo", "carrinho de beb√™"
        ].map(normalize),

        eletronicos: [
            "tv", "controle de tv", "controle remoto", "televisao", "televis√£o", "home theater", "hometheater", "som ambiente", "caixa de som grande", "caixa de som", "soundbar", "Celulares", "celular", "Smartphones", "Tablets", "Computadores", "computador", "notebook", "Monitores", "Impressoras", "Scanners", "Roteadores", "Modems", "HD", "SSD", "Calculadoras",
            "Televisores", "calculadora", "Aparelhos de Som", "Caixas de Som", "Fones de Ouvido", "Reprodutores de M√≠dia",
            "dvd", "C√¢meras Fotogr√°ficas Digitais", "C√¢meras de V√≠deo", "C√¢meras de Seguran√ßa", "C√¢meras de Monitoramento",
            "Smartwatches", "Pulseiras Fitness", "Controles Remotos", "Carregadores Port√°teis", "Power Bank", "powerbank",
            "power bank", "Lanterna El√©trica", "lanterna", "rel√≥gio", "relogios", "rel√≥gios", "projetor", "telao",
            "tel√£o", "tela gigante", "drone", "GoPro", "c√¢mera de a√ß√£o", "gimbal", "tablet", "smartwatch",
            "oculos", "√≥culos", "pen-drive", "pendrive", "gps"
        ].map(normalize),

        games: [
            "ps5", "xbox", "x-box", "PS5", "ps4", "playstation", "video game", "videogame", "jogos de videogame",
            "jogo de video game", "jogos de video game", "Consoles de Videogame", "game pass", "ps plus",
            "xbox live", "recarga de jogo", "moeda de jogo", "skin de jogo", "pacote de expans√£o", "jogo digital",
            "joguinho", "e-sports", "jogos online", "software de entretenimento", "ingresso virtual"
        ].map(normalize),

        veiculos: [
            "avi√£o", "caminh√£o", "carro", "veiculo", "ve√≠culo", "moto", "ferrari", "lamborghini", "bicicleta", "lancha",
            "iate", "jet ski", "barco", "trem", "√¥nibus", "trator", "m√°quina agr√≠cola", "patinete el√©trico", "patinete",
            "hoverboard", "caminhonete", "aviao", "avi√µes"
        ].map(normalize),

        instrumentosMusicais: [
            "viol√£o", "violao", "viol√µes", "guitarra", "baixo", "violino", "viola", "violoncelo", "contrabaixo", "harpa",
            "bandolim", "cavaquinho", "ukulele", "banjo", "cravo", "piano", "teclado", "sintetizador", "√≥rg√£o",
            "flauta", "flautim", "clarinete", "saxofone", "obo√©", "fagote", "trompete", "trombone", "tuba", "trompa",
            "harm√¥nica", "gaita", "acorde√£o", "escaleta", "bateria", "tambor", "caixa", "surdo", "pandeiro", "tri√¢ngulo",
            "prato", "chimbal", "bumbo", "t√≠mpano", "xilofone", "marimba", "vibrafone", "glockenspiel", "sinos",
            "caxixi", "agog√¥", "reco-reco", "cu√≠ca", "berimbau", "atabaque", "conga", "bong√¥", "maraca", "castanhola",
            "tamborim", "adufe", "tarol", "repique", "tam-tam", "djembe", "rabeca", "ala√∫de", "balalaica",
            "sitar", "koto", "shamisen", "didgeridoo", "ocarina", "euf√¥nio", "sousafone", "celesta", "theremin", "sampler",
            "sequenciador", "messing", "harpsichord", "clavic√≥rdio", "dulcimer", "rabeca chuleira", "gaita de fole",
            "violino popular", "xilarm√≥nico", "bombardino", "violone", "fliscorne", "clarim", "daxofone", "estradiv√°rio",
            "figle", "museta", "oficleide", "takuapu", "matraca", "c√≠mbalo", "gongo", "prato de bateria", "guitar"
        ].map(normalize),

        ferramentas: [
            "furadeira", "parafusadeira", "serra el√©trica", "compressor de ar"
        ].map(normalize),

        animais: [
            "animais", "vaca", "mam√≠fero", "mam√≠feros", "ave", "aves", "p√°ssaro", "p√°ssaros", "inseto", "insetos", "peixe",
            "peixes", "r√©ptil", "r√©pteis", "anf√≠bio", "anf√≠bios", "vertebrado", "vertebrados", "invertebrado", "invertebrados",
            "felino", "felinos", "can√≠deo", "can√≠deos", "roedor", "roedores", "primata", "primatas", "cerval", "cervais",
            "equino", "equinos", "bovino", "bovinos", "su√≠no", "su√≠nos", "ovino", "ovinos", "caprino", "caprinos", "c√£o",
            "cachorro", "gato", "le√£o", "tigre", "on√ßa", "lobo", "raposa", "urso", "elefante", "rinoceronte", "hipop√≥tamo",
            "girafa", "zebra", "macaco", "chimpanz√©", "gorila", "orangotango", "morcego", "coelho", "lebre", "esquilo",
            "rato", "camundongo", "capivara", "porco-espinho", "tatu", "tamandu√°", "pregui√ßa", "baleia", "golfinho",
            "tubar√£o", "peixe-boi", "foca", "le√£o-marinho", "sapo", "r√£", "perereca", "cobra-cega", "salamandra",
            "crocodilo", "jacar√©", "tartaruga", "c√°gado", "jabuti", "lagarto", "camale√£o", "cobra", "serpente",
            "papagaio", "arara", "tucano", "coruja", "√°guia", "falc√£o", "pardal", "can√°rio", "pintassilgo", "beija-flor",
            "gaivota", "pinguim", "avestruz", "ema", "pato", "ganso", "cisne", "galinha", "peru", "codorna", "mosquito",
            "mosca", "formiga", "abelha", "vespa", "borboleta", "mariposa", "besouro", "joaninha", "lib√©lula", "gafanhoto",
            "barata", "aranha", "escorpi√£o", "carrapato", "siri", "caranguejo", "lagosta", "camar√£o", "polvo", "lula",
            "estrela-do-mar", "ouri√ßo-do-mar", "√°gua-viva", "medusa", "coral", "an√™mona", "esponja-do-mar", "caracol",
            "lesma", "ostra", "mexilh√£o", "verme", "minhoca", "sanguessuga", "centopeia", "lacraia", "peixe-palha√ßo",
            "dourado", "salm√£o", "til√°pia", "bacalhau", "sardinha", "atum", "enguia", "arraia", "cavalo-marinho",
            "sapo-boi", "r√£-touro", "hiena", "chacal", "p√≠ton", "jib√≥ia", "iguana", "gecko", "periquito", "andorinha",
            "grilo", "pulga", "√°caro", "cachorros", "gatos", "c√£es", "ra√ß√£o", "ra√ß√µes"
        ].map(normalize),

        armasGuerra: [
            "tanque", "tanque de guerra", "guerra", "metranca", "metralhadora", "bomba", "C4", "nuclear", "fuzil",
            "fuzil de assalto", "fuzil semiautom√°tico", "fuzil de precis√£o", "rifle", "carabina", "submetralhadora",
            "metralhadora pesada", "metralhadora leve", "pistola", "rev√≥lver", "espingarda", "muni√ß√£o", "muni√ß√µes",
            "cartucho", "bala", "proj√©til", "granada", "morteiro", "m√≠ssil", "m√≠sseis", "bazuca", "lan√ßa-foguetes",
            "canh√£o", "obuseiro", "torpedo", "mina terrestre", "arma qu√≠mica", "arma biol√≥gica", "arma nuclear",
            "faca t√°tica", "baioneta", "faca de combate", "machado t√°tico", "silenciador", "supressor",
            "colete bal√≠stico", "colete a prova de balas", "capacete militar", "capacete t√°tico", "m√°scara de g√°s",
            "g√°s lacrimog√™neo", "c√¢mera de vis√£o noturna", "√≥culos t√°tico", "luva t√°tica", "botas militares",
            "coturno", "farda", "uniforme camuflado", "roupa t√°tica", "coldre", "porta carregador", "bolso modular",
            "cinto t√°tico", "joelheira t√°tica", "cotoveleira t√°tica", "placa bal√≠stica", "placas bal√≠sticas", "bandoleira",
            "blindado", "carro de combate", "ve√≠culo blindado", "lan√ßa m√≠sseis", "porta-avi√µes", "navio de guerra",
            "submarino", "drone militar", "ve√≠culo a√©reo n√£o tripulado", "aeronave de ca√ßa", "jato de ca√ßa",
            "bombardeiro", "avi√£o militar", "helic√≥ptero militar", "caminh√£o militar", "jeep militar", "helicopero",
            "mochila militar", "mochila t√°tica", "kit primeiros socorros t√°tico", "kit sobreviv√™ncia", "cantil",
            "cantil militar", "saco de dormir militar", "bin√≥culo", "tel√™metro", "b√∫ssola", "gps t√°tico",
            "lanterna t√°tica", "apito t√°tico", "marmita militar", "pazinha de trincheira", "B2", "bunker", "missel",
            "armas"
        ].map(normalize),

        bensServicosAbstratos: [
            "diamante", "ouro", "prata", "joia", "bracelete", "colar", "quadro", "escultura", "pintura", "a√ß√µes",
            "criptomoeda", "t√≠tulos", "bonds", "consulta m√©dica", "terapia", "psic√≥logo", "exames", "tratamentos",
            "cirurgia", "plano de sa√∫de", "curso", "faculdade", "mentoria", "aluguel", "imposto", "multa", "reforma",
            "manuten√ß√£o", "limpeza", "seguro", "doa√ß√£o", "gorjeta", "champanhe", "champagne", "viagem", "piscina",
            "piso", "porcelanato", "tijolo", "bloco", "universo", "planeta", "sol", "furacao", "aeroporto", "lua",
            "parque de divers√£o", "cinema", "parque", "ingresso", "ingressos", "teatro", "museu", "exposi√ß√£o",
            "espet√°culo", "circense", "√≥pera", "concerto", "bal√©", "excurs√£o", "tour guiado", "passeio", "visita guiada",
            "galeria de arte", "livro", "livros", "revista", "revistas", "e-book", "cd", "dvd", "vinil", "curso de arte",
            "curso de m√∫sica", "curso de dan√ßa", "assinatura", "streaming", "streaming de v√≠deo", "streaming de √°udio",
            "netflix", "spotify", "disney+", "globoplay", "prime video", "youtube premium", "youtube", "deezer", "tidal",
            "hbo max", "telecine play", "bilhete de trem", "bilhete de √¥nibus", "passagem a√©rea", "hotel", "aula de teatro",
            "aluguel de carro", "praia", "camping", "pesca", "ca√ßa", "boliche", "patina√ß√£o", "escalada", "kart",
            "paintball", "tirolesa", "rapel", "trilha", "academia", "yoga", "pilates", "crossfit", "luta", "massagem",
            "spa", "sauna", "day spa", "clube de campo", "mensalidade clube", "rod√≠zio", "buffet", "restaurante",
            "bar", "cafeteria", "fast food", "pacote de viagem", "lazer", "entretenimento", "recrea√ß√£o", "hobbies",
            "compra com milhas", "cart√£o presente", "gift card", "cr√©dito em plataforma", "recarga de celular",
            "compra de pontos", "programa de pontos", "sorteio", "rifa", "pr√©dio", "casa", "apartamento",
            "previd√™ncia privada", "previd√™ncia", "plano de previd√™ncia", "cdi", "cdb", "certificado de dep√≥sito banc√°rio",
            "lci", "lca", "letra de cr√©dito imobili√°rio", "letra de cr√©dito do agroneg√≥cio", "t√≠tulos de renda fixa",
            "fundos de investimento", "cotas de fundos", "lci 180 dias", "investimento via cart√£o", "aporte via cart√£o",
            "cashback investimento", "milhas para investimento", "compra de milhas", "criptomoedas",
            "token de investimento", "nucoin", "cashback", "cash back", "bitcoin", "milhas", "brinquedo", "brinquedos",
            "veneno", "mata inseto", "isca", "iscas", "cobasi", "arvore", "flores", "planta"
        ].map(normalize),

        restritos: [
            "drogas", "produtos falsificados", "material pornogr√°fico", "porno", "pornografia", "esp√©cies amea√ßadas",
            "rem√©dios controlados", "produtos de tabaco", "cigarro", "charuto", "muni√ß√£o", "prostituta", "puta",
            "programa", "night", "sexo", "transar", "camisinha", "vibrador", "KY", "chupeta"
        ].map(normalize),

        inteligenciaArtificial: [
            "ChatGPT", "GPT-3", "GPT-4", "GPT-4o", "GPT", "Gemini", "Google Gemini", "Gemini Pro", "Gemini Ultra",
            "Microsoft Copilot", "Copilot", "Claude", "Claude 3", "Claude 3 Opus", "Claude 3 Sonnet", "Claude 3 Haiku",
            "Llama", "Llama 2", "Llama 3", "Mistral", "Grok", "AlphaGo", "IBM Watson", "Watson", "TensorFlow", "PyTorch",
            "Keras", "Azure AI", "Azure Machine Learning", "Google Cloud AI", "Vertex AI", "Amazon SageMaker", "DALL-E",
            "DALL-E 2", "DALL-E 3", "Midjourney", "Stable Diffusion", "Stable Diffusion XL", "SDXL", "Code Llama", "Whisper",
            "Jasper", "Jasper AI", "Copy AI", "Beautiful AI", "Grammarly", "Synthesia", "Picsart AI", "Otter AI",
            "Tesla Autopilot", "ClickUp Brain", "H2O.ai", "Scikit-learn", "OpenAI Gym", "Tabnine", "GitHub Copilot",
            "Perplexity", "Duck AI", "Siri", "Alexa", "Meta AI", "NotebookLM", "WordAI", "DeepBrain AI", "Salesforce Einstein",
            "Fireflies", "Pictory", "Speechify", "Poised", "You.com", "Andi", "Chatfuel", "Dialogflow", "Cursor",
            "Mya Systems", "Olivia by Paradox", "SeekOut", "SAP S/4HANA AI", "Breeze by HubSpot", "sap", "github", "excel",
            "word", "text-pad", "textpad"
        ].map(normalize),

        utensiliosCozinha: [
            "garfo", "faca", "colher", "colher de sopa", "colher de ch√°", "colher de sobremesa", "faca de serra",
            "faca de p√£o", "faca de carne", "esp√°tula", "concha", "escumadeira", "fouet", "batedor de ovos",
            "abridor de lata", "abridor de garrafa", "saca-rolhas", "ralador", "descascador", "peneira",
            "espremedor de alho", "cortador de pizza", "tesoura de cozinha", "pegador de macarr√£o",
            "pegador de salada", "t√°bua de corte", "pirex", "travessa", "assadeira", "forma de bolo",
            "frigideira", "panela", "ca√ßarola", "leiteira", "cuscuzeiro", "chaleira", "bule", "x√≠cara",
            "copo", "ta√ßa", "prato", "pires", "saladeira", "tigela", "bowl"
        ].map(normalize)

    };

    const mensagensBrincadeiraPorGrupo = {
        eletrodomesticos: "Interior de loja n√£o √© cozinha planejada, n√©? üòÖ",
        eletroportateis: "Vai montar uma cozinha gourmet a√≠ na loja? üòÇ",
        climatizacao: "Climatizar a loja √© importante, mas isso entra como patrim√¥nio, n√£o no cart√£o da Clara üòâ",
        moveisUtensiliosCasa: "Parece mais compra de mob√≠lia do que despesa do dia a dia da loja üò¨",
        eletronicos: "Isso a√≠ t√° com mais cara de patrim√¥nio do que de gasto operacional‚Ä¶ üì∫",
        games: "Montar lan house com cart√£o da loja n√£o vai rolar, hein üéÆüòÑ",
        veiculos: "Cart√£o Clara n√£o √© financiamento de concession√°ria e nem tem limite infinito, hein! üöóüí≥",
        instrumentosMusicais: "Vai montar uma banda a√≠ na loja? üé∏üòÑ",
        ferramentas: "Vai montar uma oficina? üò•",
        animais: "Nossa, n√£o sabia que voc√™ tava montando um zool√≥gico na loja ü§£",
        armasGuerra: "Calma l√°, Rambo‚Ä¶ o cart√£o √© pra opera√ß√£o da loja, n√£o pra guerra ‚öîÔ∏èüòÇ",
        bensServicosAbstratos: "Isso tem bem mais cara de investimento/lazer/servi√ßo pessoal do que despesa da loja. T√° estressado e quer relaxar, n√©? üòÖ",
        restritos: "Esse tipo de item √© proibido de qualquer jeito, dentro ou fora da pol√≠tica da Clara üò∂‚Äçüå´Ô∏è",
        inteligenciaArtificial: "Nem as IAs escapam da pol√≠tica do cart√£o corporativo, viu? ü§ñüö´",
        utensiliosCozinha: "MasterChef que habita em voc√™ n√£o √© o mesmo que habita na Clara üßëüèº‚Äçüç≥"
    };

    function avaliarCompraEspecifica(msgNorm) {
        const baseMsg = `Esse tipo de item <b>N√ÉO</b> pode ser comprado com o cart√£o.<br>
Ele deve seguir o processo de requisi√ß√£o junto √† √°rea de Compras (se for relevante e apto de acordo com o neg√≥cio e estiver dentro da pol√≠tica da √°rea), com aprova√ß√£o formal, n√£o o cart√£o da loja.`;

        // 1) Checa os GRUPOS de proibidos primeiro
        for (const [grupo, palavras] of Object.entries(gruposProibidos)) {
            for (const palavra of palavras) {
                const regex = new RegExp(`\\b${palavra}\\b`, "i");
                    if (regex.test(msgNorm)) {
                    const intro = mensagensBrincadeiraPorGrupo[grupo] || "‚õî N√£o pode usar o cart√£o Clara pra isso.";
                    const respostaFinal = `${intro}<br><br>${baseMsg}`;

                    return {
                        pode: false,
                        resposta: respostaFinal
                    };
                }
            }
        }

        // 2) Casos espec√≠ficos de PROIBIDOS (alimenta√ß√£o pessoal, √°lcool, transporte pessoal)
        const pessoalAlim = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        for (const termo of pessoalAlim) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja. Se j√° foi pago com o cart√£o, precisa sinalizar como "Despesa Pessoal ‚Äì Uso Indevido", avisar o Financeiro e ressarcir em at√© 2 dias √∫teis.`
                };
            }
        }

        const alcool = ["cerveja","vodka", "gin", "tequila", "rum", "saque", "espumante", "conhaque", "51", "sidra", "brandy", "hidromel", "absinto", "champagne", "menta", "bitter", "vermute", "prosecco", "vinho do porto", "xerez", "marsala", "grappa", "pisco", "mezcal", "calvados", "amaretto", "ouzo", "j√§germeister", "soju", "arac", "baijiu", "vinho","whisky","whiskey","cacha√ßa", "licor", "cachaca","gin","tequila", "Skol", "Brahma", "Heineken", "Corona Extra", "Budweiser", "Bud Light", "Stella Artois", "stella", "itaipava", "devassa", "Guinness", "Pilsner Urquell", "Super Bock", "Asahi", "Tsingtao", "Yanjing", "Smirnoff", "Absolut", "C√Æroc", "Grey Goose", "Belvedere", "Stolichnaya", "Ketel One", "Tito's Handmade Vodka", "Skyy", "Orloff", "Johnnie Walker", "Jack Daniel's", "Jameson", "Chivas Regal", "Jim Beam", "Ballantine's", "Grant's", "Macallan", "Glenfiddich", "Bulleit", "Suntory", "Tanqueray", "Beefeater", "Bombay Sapphire", "Gordon's", "Hendrick's", "Bulldog", "The Botanist", "Seagers", "Jose Cuervo", "Patr√≥n", "Don Julio", "1800", "Casamigos", "Espol√≤n", "El Jimador", "Herradura", "Altos Tequila", "Bacardi", "Havana Club", "Captain Morgan", "Ron Zacapa", "Mount Gay", "Appleton Estate", "Diplom√°tico", "Brugal", "Plantation", "Cacha√ßa 51", "Seleta", "Salinas", "Velho Barreiro", "Pit√∫", "Weber Haus", "Magn√≠fica", "An√≠sio Santiago (Havana)", "Mo√´t & Chandon", "Dom P√©rignon", "Veuve Clicquot", "Krug", "Chandon", "Casa Perini", "Salton", "Freixenet", "Baileys", "Licor 43", "J√§germeister", "Amarula", "Cointreau", "Grand Marnier", "Campari", "Aperol", "Frangelico", "Sheridan's", "Drambuie", "Fireball", "blue label", "gold label","black label", "green label", "ciroc", "absolut", "C√Æroc", "Grey Goose", "Belvedere", "Stolichnaya", "Ketel One", "Tito's Handmade Vodka", "Skyy", "Orloff", "Russian Standard", "≈ªubr√≥wka", "Finlandia", "Eristoff", "Beluga", "Svedka", "Wyborowa", "Crystal Head", 
        "Hangar 1" ].map(normalize);
        for (const termo of alcool) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Bebida alco√≥lica n√£o √© permitida no cart√£o Clara. Isso n√£o √© considerado despesa operacional autorizada.`
                };
            }
        }

        const transportePessoal = ["uber"," 99","taxi","t√°xi","tax√≠","cabify"].map(normalize);
        for (const termo of transportePessoal) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Uber / 99 / t√°xi para deslocamento pessoal n√£o pode no cart√£o Clara. N√£o √© gasto operacional direto da loja.`
                };
            }
        }

        // 3) Casos espec√≠ficos PERMITIDOS (lanche time, perif√©ricos, servi√ßos emergenciais)
        const palavrasTime = [
            "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
            "lanche time","lanche pro time","lanche para o time",
            "treinamento","premiacao","premia√ß√£o","acao oficial","a√ß√£o oficial",
            "acao vm","a√ß√£o vm","acao regional","a√ß√£o regional",
            "agua pra equipe","√°gua pra equipe","gal√£o de agua","galao de agua","gal√£o de √°gua",
            "salgadinho pra treinamento","bolo pra treinamento",
            "suco pra treinamento","suco para treinamento","lanche treinamento"
        ].map(normalize);

        for (const termo of palavrasTime) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "LANCHES DE REFEI√á√ïES / AGUA POT√ÅVEL",
                        desc: "Coffee break autorizado, √°gua/lanche para equipe em treinamento interno aprovado, a√ß√£o oficial da loja (VM, regional, diretoria) ou premia√ß√£o operacional.",
                        exemploDescricao: "Coffee break treinamento VM loja 1234"
                    },
                    resposta: `Pode usar o cart√£o Clara se for a√ß√£o autorizada (treinamento interno, VM, regional, diretoria, premia√ß√£o operacional). Precisa lan√ßar na Clara em at√© 48h com nota fiscal, etiqueta correta e descri√ß√£o objetiva.`
                };
            }
        }

        const perifOperacional = [
            "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
            "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa",
            "bobina ecf","bobina fiscal"
        ].map(normalize);

        for (const termo of perifOperacional) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "MATERIAL DE INFORM√ÅTICA",
                        desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                        exemploDescricao: "Teclado PDV loja 1234"
                    },
                    resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) √© considerado suprimento operacional de baixo valor para a loja e pode ser pago no cart√£o Clara, desde que classificado corretamente e lan√ßado em at√© 48h.`
                };
            }
        }

        const servicoEmerg = [
            "chaveiro","abrir cofre","abrir estoque","perdi a chave",
            "motoboy","sedex","correios","envio de documento","postar documento",
            "mandar documento","enviar documento"
        ].map(normalize);

        for (const termo of servicoEmerg) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "TRANSPORTE SERVI√áOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                        desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                        exemploDescricao: "Motoboy urgente documenta√ß√£o loja 1234"
                    },
                    resposta: `Servi√ßos emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cart√£o Clara, desde que sejam necessidade imediata da opera√ß√£o e sejam justificados na Clara dentro de 48h.`
                };
            }
        }

        // 4) Se n√£o casou em nada, deixa para a resposta gen√©rica
        return { pode: null, resposta: "" };
    }

    /* ========= RESPOSTAS ========= */


    function respostaForaEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
    }

    function respEtiquetaDireta(et) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nome}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.descricao}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}

<p class="mt-2">
<b>Como lan√ßar na Clara (at√© 48h):</b><br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar a etiqueta: "${et.nome}";<br/>
3. Descrever objetivamente o gasto no campo <b>Coment√°rio</b> (ex.: "Compra de xxxx para ____");<br/>
4. Guardar o documento f√≠sico na loja pelo prazo indicado pela pol√≠tica.
</p>
</div>`;
    }

    function respLimite() {
        return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br><br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende,<br>‚Ä¢ Novo limite requerido.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.<br><br>Lembrando que o limite foi definido conforme o hist√≥rico de gastos de cada loja, √© um valor individual e diferente para cada uma. <b>O limite √© reestabelecido todo dia 06 de cada m√™s</b>, fique atento! üòâ';
    }

    function respBloqueio() {
        return `HTML:<p class="text-sm text-slate-700">
            Geralmente quando voc√™ n√£o consegue usar o cart√£o pode ser devido ao bloqueio preventivo, que acontece quando tem alguma compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
            ‚Ä¢ faltou nota fiscal/recibo;<br/>
            ‚Ä¢ n√£o colocou etiqueta correta;<br/>
            ‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
            Passos pra desbloquear:<br/>
            1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolher etiqueta certa, descrever o motivo real).<br/>
            2. Encaminhar chamado via <b>ServiceNow</b> para desbloqueio, caminho: <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Desbloqueio</b>.<br/><br/>
            </p>`;
                }

                // üîπ NOVA RESPOSTA ‚Äì transa√ß√£o negada / categoria bloqueada
                function respTransacaoNegadaCategoria() {
                    return `HTML:<div class="text-sm text-slate-700">
            <p>Algumas compras podem ser <b>negadas</b> mesmo com limite dispon√≠vel e cart√£o ativo (<i>√â importante que voc√™ verifique que seu cart√£o n√£o est√° bloqueado</i>), porque a <b>categoria do estabelecimento</b> (MCC) est√° bloqueada pela pol√≠tica de uso dos cart√µes Clara.</p>

            <p class="mt-2">Nesses casos, siga estes passos:</p>
            <ol class="list-decimal ml-4 mt-1">
            <li>Verifique no app/plataforma da Clara o motivo da recusa e a categoria da compra (MCC);</li>
            <li>Se a despesa for necess√°ria para a opera√ß√£o da loja, abra um chamado no <b>ServiceNow</b> em:<br/>
            <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Libera√ß√£o de Categoria para Compra</b>;</li>
            <li>Explique o contexto da compra, qual tipo de servi√ßo/produto precisa ser liberado e se a libera√ß√£o √© pontual ou recorrente.</li>
            </ol>

            <p class="mt-2">Depois da libera√ß√£o pelo Financeiro no ServiceNow, voc√™ pode tentar a compra novamente com o cart√£o Clara.</p>
            </div>`;
                }

              function respPoliticaOficial() {
        return `HTML:<div class="text-sm text-slate-700">
          <p>Seguem as regras oficiais de refer√™ncia da empresa.</p>
          <p>
          <a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
          <strong>Pol√≠tica de Uso dos Cart√µes Clara (documento oficial)</strong>
          </a>.
          </p>
          <p>Use sempre esse documento como fonte final.</p>
          </div>`;
              }

    function respCatalogoEtiquetas() {
        return `HTML:<div class="text-sm text-slate-700">
            <p><b>Etiquetas oficiais e quando usar:</b></p>

            <p class="mt-2"><b>MATERIAL DE INFORM√ÅTICA</b><br/>
            Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (baixo valor, sem controle patrimonial).<br/>
            Exemplo de descri√ß√£o: "Teclado PDV loja 1234".</p>

            <p class="mt-2"><b>MATERIAL DE ESCRIT√ìRIO</b><br/>
            Caneta, pasta, bloco de anota√ß√£o, grampeador, etiqueta adesiva, organizador de mesa, papelaria b√°sica da opera√ß√£o administrativa da loja.</p>

            <p class="mt-2"><b>AGUA POT√ÅVEL</b><br/>
            Gal√£o de √°gua mineral / garrafas de √°gua para abastecimento da equipe ou uso da loja, quando previsto e autorizado operacionalmente.</p>

            <p class="mt-2"><b>LANCHES DE REFEI√á√ïES</b><br/>
            Coffee break ou lanche para treinamento interno autorizado, a√ß√£o oficial da √°rea (VM, regional, diretoria) ou premia√ß√£o operacional da equipe (n√£o vale refei√ß√£o pessoal).</p>

            <p class="mt-2"><b>TRANSPORTE SERVI√áOS EMERGENCIAS</b><br/>
            Motoboy emergencial / frete local urgente para levar ou buscar material importante entre lojas ou matriz.</p>

            <p class="mt-2"><b>CORREIOS_SEDEX/AR/POSTAGEM</b><br/>
            Envio de documentos oficiais da loja via Sedex/AR/postagem. Tamb√©m serve para devolu√ß√µes pequenas quando for processo formal.</p>

            <p class="mt-2"><b>CHAVEIRO EMERGENCIAL</b><br/>
            Abertura urgente de cofre / estoque / sala administrativa quando houve perda de chave ou travamento, s√≥ em situa√ß√£o emergencial.</p>

            <p class="mt-2"><b>MANUTEN√á√ÉO CIVIL</b><br/>
            Pequenos reparos estruturais internos de baixa complexidade: ajuste em porta, troca de vidro quebrado, fixar prateleira, ajuste de revestimento etc.</p>

            <p class="mt-2"><b>MANUTEN√á√ÉO EL√âTRICA</b><br/>
            Troca de tomada, disjuntor, interruptor, soquete, reator, extens√£o, pequenos reparos de baixa tens√£o necess√°rios pro funcionamento da loja.</p>

            <p class="mt-2"><b>MANUTEN√á√ÉO AR-CONDICIONADO</b><br/>
            Limpeza de filtro, troca de controle remoto, carga de g√°s simples, pequenos ajustes que mantenham o ar funcionando.</p>

            <p class="mt-2"><b>BOBINA ECF</b><br/>
            Bobina fiscal / bobina de impressora obrigat√≥ria pro PDV, quando n√£o h√° fornecimento centralizado.</p>

            <p class="mt-2"><b>SERVI√áOS GR√ÅFICOS E DE COPIADORAS</b><br/>
            Impress√£o de banner, adesivo de campanha, plotagem promocional, encaderna√ß√£o de material de comunica√ß√£o da loja.</p>

            <p class="mt-2"><b>MANUTEN√á√ÉO EQUIPAMENTOS</b><br/>
            Ajustes/reparos em m√°quinas de estampar, impressoras de etiqueta, computadores fora de garantia e de baixo valor etc. (nada de compra de equipamento grande).</p>

            <p class="mt-4">Se voc√™ n√£o encontrou nada que encaixa no seu caso, abra chamado no<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6"target="_blank" rel="noopener noreferrer"><strong>ServiceNow</strong></a>pedindo cria√ß√£o ou libera√ß√£o de etiqueta.</p>
            </div>`;
                }

    function respPrestacaoContas() {
        return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 180 dias corridos. N√£o justificar no prazo =&gt; risco de bloqueio preventivo.
</p>`;
    }

    function respAlimentoTime() {
        return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respTransportePessoal() {
        return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja. O procedimento correto √© solicitar via aplicativo com a conta corporativa da empresa.<br/><br/>
Se j√° usou de forma pessoal (pagando do pr√≥prio bolso) e quer o reembolso:<br/>
‚Ä¢ Solicite o reembolso atrav√©s da plataforma Vexpenses (√© necess√°rio autoriza√ß√£o do seu gestor).<br/>
</p>`;
    }

    function respTrocaGerente() {
        return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja segue assim:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja;<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234";<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado;<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Se tiver caso especial, fale com o Financeiro e, se preciso, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow.
</a>.
</p>`;
    }

    function respCartaoGeral() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Sobre o cart√£o Clara nas lojas:</b></p>

<p class="mt-1">
O cart√£o Clara √© o meio oficial para pagar <b>despesas operacionais da loja</b>, em substitui√ß√£o ao antigo processo de sangrias, como:
</p>
<ul class="list-disc ml-4 mt-1">
  <li>materiais de limpeza e pequenos reparos;</li>
  <li>materiais de escrit√≥rio e inform√°tica de baixo valor;</li>
  <li>√°gua / coffee break para treinamentos internos e a√ß√µes autorizadas;</li>
  <li>servi√ßos emergenciais (motoboy, chaveiro, correios em situa√ß√µes operacionais).</li>
</ul>

<p class="mt-2">
Sempre precisa:
</p>
<ul class="list-disc ml-4 mt-1">
  <li>nota fiscal ou recibo;</li>
  <li>etiqueta correta na Clara;</li>
  <li>descri√ß√£o objetiva do gasto;</li>
  <li>lan√ßar tudo em at√© <b>48h</b> no app/web da Clara.</li>
</ul>

<p class="mt-2">
N√£o pode usar o cart√£o para:
</p>
<ul class="list-disc ml-4 mt-1">
  <li>gasto pessoal (roupa, almo√ßo/jantar pessoal, compras para uso pr√≥prio);</li>
  <li>bebida alco√≥lica;</li>
  <li>Uber / 99 / t√°xi para deslocamento pessoal;</li>
  <li>itens patrimoniais / infraestrutura (TV, geladeira, micro-ondas, mesa, cadeira etc.).</li>
</ul>

<p class="mt-2">
Se quiser, posso te explicar um caso espec√≠fico. Por exemplo:
<br/>‚Ä¢ "Posso comprar teclado?"<br/>
‚Ä¢ "Pode lanche pra equipe?"<br/>
‚Ä¢ "O que n√£o pode no cart√£o?"
</p>
</div>`;
}

    function respSangria() {
        return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© <b>DESCONTINUADO</b>.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
    }

    function respFraudeContestacao() {
        return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente;<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o;<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal, a√≠ precisa ressarcir em at√© 2 dias √∫teis; n√£o √© contesta√ß√£o.
</p>`;
    }

    function respTermoResponsabilidade() {
        return `HTML:<div class="text-sm text-slate-700">
<p>
O <b>Termo de Responsabilidade de uso do cart√£o da Clara</b> deve ser preenchido para que a loja possa utilizar o cart√£o. Esse termo traz tamb√©m o aceite para a Pol√≠tica de uso do cart√£o.
<p class="mt-2">
Preencha <a class="service-link" href="https://docs.google.com/forms/d/e/1FAIpQLSdnQWYFWp-udS9V039avJlXb4x1VnlDC6us5dSCrLkgngAxpg/alreadyresponded" target="_blank" rel="noopener noreferrer"><b>este formul√°rio</b></a>. Ap√≥s preencher voc√™ receber√° o termo anexado ao e-mail, onde deve <b>imprimir, assinar e nos enviar</b>. Ap√≥s isso, o uso do cart√£o estar√° liberado.
</p>
</div>`;
    }

    function respNovoCartaoPrimeiraVia() {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Primeira via de cart√£o Clara (novo cart√£o)</b></p>
<p class="mt-1">
Para solicitar a <b>primeira via</b> do cart√£o Clara, siga estes passos:
</p>
<ol class="list-decimal ml-5 mt-1">
  <li>Preencha o formul√°rio: <a href="https://docs.google.com/forms/d/1vGAsFHuDQ6y5ydJMuE7W9ThJFjsLma_1I6yw92OLHh4/viewform"
       target="_blank" rel="noopener noreferrer"><b>Formul√°rio de Solicita√ß√£o de Cart√£o Clara</b></a>.
  
  <li class="mt-1">Depois de preencher o formul√°rio, envie um e-mail para o Financeiro informando que j√° preencheu, para que o cart√£o seja emitido: <b>contasareceber@gruposbf.com.br</b>
<p class="mt-2">
O prazo de entrega do cart√£o √© de at√© <b>7 dias √∫teis</b>, conforme a pol√≠tica interna.
</p>
</div>`;
    }

function respNovoCartaoSegundaVia() {
  return `HTML:
<div class="text-sm text-slate-700">

  <b>Segunda via de cart√£o Clara (cart√£o j√° existia)</b>

  <p style="margin-top:6px;">
    A solicita√ß√£o de <b>segunda via</b> (perda, roubo, dano ou troca de portador)
    deve seguir o fluxo previsto na Pol√≠tica de Uso dos Cart√µes Clara:

  <p style="margin-top:6px; margin-bottom:4px;">
    ‚Ä¢ Bloquear imediatamente o cart√£o antigo na plataforma / app da Clara
    atrav√©s da funcionalidade de <b>"Congelar"</b>;<br>
    ‚Ä¢ Registrar o motivo (perda, roubo, quebra, etc.) conforme orienta√ß√µes internas;<br>
    ‚Ä¢ Abrir chamado no <b>ServiceNow</b> solicitando a emiss√£o de segunda via do cart√£o Clara.

  <p style="margin-top:6px;">
    Sempre siga as orienta√ß√µes detalhadas na <b>Pol√≠tica de Uso dos Cart√µes Clara</b>
    para casos de reemiss√£o/segunda via.

</div>`;
}

    function respGenerica(msgNorm) {
        const avaliacao = avaliarCompraEspecifica(msgNorm);

        if (avaliacao.pode === false) {
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
        }

        if (avaliacao.pode === true && avaliacao.etiquetaValida) {
            const et = avaliacao.etiquetaValida;
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
</div>`;
        }

        if (perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ O que pode no cart√£o Clara</b> - Exemplos de materiais:</p>
<ul class="list-disc ml-4 mt-1">
<li>Materiais de escrit√≥rio: canetas, blocos, pastas, papel, clips, organizadores, grampeadores;</li>
<li>Servi√ßos gr√°ficos e de comunica√ß√£o visual: impress√£o de banners, adesivos promocionais, folders e plotagens autorizadas pela √°rea de VM;</li>
<li>Compra de √°gua mineral ou gal√µes para abastecimento da equipe (etiqueta ‚Äú√ÅGUA POT√ÅVEL‚Äù);</li>
<li>Suprimentos de inform√°tica (mouse, teclado, cabos, bobina fiscal etc.);</li>
<li>Lanches, coffee breaks ou premia√ß√µes para equipe somente quando vinculados a treinamentos internos, a√ß√µes oficiais ou campanhas aprovadas (etiqueta ‚ÄúLANCHES DE REFEI√á√ïES‚Äù);</li>
<li>Servi√ßos emergenciais (motoboy urgente, chaveiro, Sedex de documento);</li>
<li>Compra de bobinas fiscais ou suprimentos obrigat√≥rios do PDV;</li>
<li>Pequenas manuten√ß√µes (el√©trica, civil, ar-condicionado, equipamentos).</li>
</ul>
<p class="mt-2"><b>‚ùå O que n√£o pode</b> - Exemplos de itens n√£o permitidos:</p>
<ul class="list-disc ml-4">
<li>Itens patrimoniais ou de infraestrutura: TV, micro-ondas, geladeira, freezer, mesa, cadeira, arm√°rio, ventilador, cafeteira el√©trica, computador, impressora, celular, tablets, ou qualquer bem dur√°vel;</li>
<li>Bebidas alco√≥licas (cerveja, vinho, whisky, vodka, gin, tequila, entre outras);</li>
<li>Transporte pessoal: Uber, 99, t√°xi, aplicativos de carona ou combust√≠vel para ve√≠culo particular;</li>
<li>Despesas pessoais: almo√ßo, jantar, lanche, coffee break pessoal, delivery, supermercado para consumo pr√≥prio;</li>
<li>Equipamentos e mobili√°rios que exigem tombamento patrimonial (mesmo que de baixo valor);</li>
<li>Manuten√ß√µes estruturais de grande porte (obras, pintura geral, reformas, trocas de piso, el√©trica complexa, etc.);</li>
<li>Servi√ßos ou produtos sem nota fiscal (inclusive compras em marketplaces sem NF emitida no CNPJ da loja);</li>
<li>Gastos fora da opera√ß√£o da loja ou que n√£o tenham rela√ß√£o com a atividade comercial;</li>
</ul>
</div>`;
        }

        return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cart√£o Clara, o gasto precisa ser <b>necess√°rio pra opera√ß√£o da loja</b> (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal, √°gua/coffee break autorizado pra treinamento interno ou a√ß√£o oficial).</p>
<p class="mt-2">O que <b>n√£o pode</b> no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (refei√ß√£o pessoal, compra pra uso pr√≥prio etc.);<br/>
‚Ä¢ bebida alco√≥lica em geral;<br/>
‚Ä¢ transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira, entre outros).</p><br/>
Caso entenda que a compra √© essencial para o dia a dia da loja, fale com o financeiro, caso seja verificado que o item √© essencial eles podem abrir uma exce√ß√£o para a compra.
</div>`;
    }

    /* ========= FUN√á√ïES DE PEND√äNCIAS (BACKEND) ========= */

    function consultarPendenciasNoServidor(loja) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (!res || !res.ok) {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  N√£o consegui consultar as pend√™ncias da loja <b>${loja}</b>.<br/>
                  Detalhe: ${erro}
                  </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // üÜï loja n√£o existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  A numera√ß√£o informada n√£o existe, pe√ßo que verifique o n¬∫ correto da loja.
                  </p>`
                    );
                    // continua aguardando n√∫mero da loja
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // dispara o timer de 10s
                    return;
                }

                // loja existe, mas N√ÉO tem pend√™ncias na CLARA_PEND
                if (!res.rows || res.rows.length === 0) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                N√£o encontrei pend√™ncias para a loja <b>${loja}</b> na √∫ltima data de cobran√ßa.
                </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // ‚úÖ loja v√°lida + tem pend√™ncias ‚Üí continua igual
                ultimaPendenciaResumo = { loja: res.loja, data: res.ultimaData };
                lojaPendenciasAtual = res.loja;

                let tabela = `
                <div class="text-sm text-slate-700">
                <p>Encontrei abaixo as √∫ltimas pend√™ncias Clara da loja <b>${res.loja}</b> (data de cobran√ßa <b>${res.ultimaData}</b>). Caso a pend√™ncia j√° tenha sido regularizada e o seu cart√£o ainda esteja bloqueado, solicite o desbloqueio atrav√©s de abertura de chamado no ServiceNow, caminho: <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Desbloqueio</b>.</p>
                <div class="mt-2 overflow-x-auto">
                <table class="min-w-full text-xs border border-slate-200">
                <thead class="bg-slate-100">
                <tr>`;

                const header = res.header || [];
                header.forEach(h => {
                    tabela += `<th class="border px-2 py-1">${h}</th>`;
                });
                tabela += `</tr></thead><tbody>`;

                res.rows.forEach(linha => {
                    tabela += `<tr>`;
                    linha.forEach(col => {
                        tabela += `<td class="border px-2 py-1">${col !== null && col !== undefined ? col : ""}</td>`;
                    });
                    tabela += `</tr>`;
                });

                tabela += `</tbody></table></div></div>`;

                renderBotMessage("HTML:" + tabela);

                estadoPendencias = "aguardando_confirmacao_email";

                renderBotMessage(
                  'HTML:' +
                  '<div class="text-sm text-slate-700 mt-2">' +
                    '<p>Quer que eu envie esse resumo por e-mail tamb√©m?</p>' +
                    '<div class="mt-2 flex gap-2">' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'Sim' +
                      '</button>' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'n√£o\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'N√£o' +
                      '</button>' +
                    '</div>' +
                  '</div>'
                );
                
            })
            .withFailureHandler(function(err) {
                console.error("Erro getPendenciasPorLoja:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pend√™ncias dessa loja. Tente novamente mais tarde.</p>'
                );
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
            })
            .getPendenciasPorLoja(loja);
    }

                function consultarPendenciasBloqueio(loja) {
        google.script.run
            .withSuccessHandler(res => {
                // erro gen√©rico
                if (!res || !res.ok) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // üÜï loja n√£o existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    A numera√ß√£o informada n√£o existe, pe√ßo que verifique o n¬∫ correto da loja.
                    </p>`
                    );
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // timer de 10s
                    return;
                }

                // se chegou aqui, loja √© v√°lida ‚Üí precisa ter html
                if (!res.html) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // mostra o HTML (tabela ou "N√£o encontrei pend√™ncias")
                renderBotMessage("HTML:" + res.html);

                // üü° CASO 1: loja v√°lida mas sem pend√™ncias
                if (res.html.includes("N√£o encontrei pend√™ncias")) {
                    estadoPendencias = "nenhum";

                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700 mt-2">
                  Acredito que, caso realmente o cart√£o esteja bloqueado, possa ser por algum outro motivo. Verifique com o time do Financeiro o que pode ter ocorrido, ok?
                  </p>`
                    );
                    return;
                }

                   // üü¢ CASO 2: loja v√°lida + tem pend√™ncias ‚Üí pergunta se quer e-mail
                    estadoPendencias = "aguardando_confirmacao_email";

                    renderBotMessage(
                      'HTML:' +
                      '<div class="text-sm text-slate-700 mt-2">' +
                        '<p>Quer que eu envie esse resumo por e-mail tamb√©m?</p>' +
                        '<div class="mt-2 flex gap-2">' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'Sim' +
                          '</button>' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'n√£o\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'N√£o' +
                          '</button>' +
                        '</div>' +
                      '</div>'
                    );
            })
            .withFailureHandler(err => {
                estadoPendencias = "nenhum";
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
            Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
            </p>`
                );
            })
            .getPendenciasParaBloqueio(loja);
    }


    function chamarEnvioPendenciasPorEmail(loja, email) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Enviei o resumo das pend√™ncias da loja <b>${res.loja || loja}</b> para o e-mail <b>${email}</b> (data de cobran√ßa: <b>${res.data || (ultimaPendenciaResumo && ultimaPendenciaResumo.data) || ""}</b>). N√£o se esque√ßa de regularizar as justificativas na plataforma da Clara e posteriormente encaminhar chamado para que o cart√£o seja desbloqueado (caso esteja bloqueado).</p>`
                    );
                } else {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Tentei enviar o e-mail de pend√™ncias, mas deu problema: ${erro}.</p>`
                    );
                }
            })
            .withFailureHandler(function(err) {
                console.error("Erro enviarPendenciasPorEmail:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail de pend√™ncias. Tente novamente mais tarde.</p>'
                );
            })
            .enviarPendenciasPorEmail(loja, email);
    }

    /* ========= MOTOR DA POL√çTICA ========= */

 function gerarRespostaPolitica(msgUsuario) {
        const norm = normalize(msgUsuario);
        const intencao = detectarIntencaoPergunta(norm);

        // gasto pessoal alimenta√ß√£o
        const padroesGastoPessoalAlimentacao = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","meu lanche com o cartao","meu lanche com o cart√£o",
            "minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));
        if (isGastoPessoalAlimentacao) {
            ultimaIntencao = "gasto_pessoal_alimentacao";
            return `HTML:<div class="text-sm text-slate-700">
            <p>‚õî Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.</p>
            <p class="mt-2">Se j√° foi pago com o cart√£o:</p>
            <ul class="list-disc ml-4">
            <li>Avise o Financeiro e abra chamado no ServiceNow (Contas a Receber &gt; Cart√£o Clara &gt; Gasto Indevido - pessoal);</li>
            <li>Classifique na Clara como "Despesa Pessoal ‚Äì Uso Indevido";</li>
            <li>Ressar√ßa o valor √† empresa em at√© 2 dias √∫teis.</li>
            </ul>
            <p class="mt-2">Se n√£o regularizar, o cart√£o pode ficar bloqueado preventivamente.</p>
            </div>`;
        }

        let resposta;

        switch (intencao) {
            case "foraEscopo":
                ultimaIntencao = "foraEscopo";
                resposta = respostaForaEscopo();
                break;

            case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
                resposta = `HTML:<div class="text-sm text-slate-700">
            <p>O <b>cart√£o Clara</b> √© o meio oficial de pagamento das despesas operacionais das lojas.</p>
            <p class="mt-1">Com ele, voc√™ pode pagar itens de uso di√°rio como materiais de limpeza, escrit√≥rio, inform√°tica, √°gua e lanches para a√ß√µes internas autorizadas.</p>
            <p class="mt-1">Todas as compras devem ser justificadas na plataforma Clara em at√© 48 horas, com etiqueta, nota e descri√ß√£o correta.</p>
            <p class="mt-1">Quer ver a <b>Pol√≠tica completa de uso</b>?<a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer"> Clique aqui.
            </a></p>
            </div>`;
                break;

             // üîπ NOVO: transa√ß√£o negada / categoria bloqueada
            case "transacaoNegadaCategoria":
                ultimaIntencao = "transacaoNegadaCategoria";
                resposta = respTransacaoNegadaCategoria();
                break;   


            case "etiqueta": {
                ultimaIntencao = "etiqueta";
                const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));
                const et = acharEtiquetaPorMensagem(norm);

                if (!et && isPerguntaGeral) {
                    resposta = respCatalogoEtiquetas();
                } else if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
              N√£o consegui identificar uma etiqueta espec√≠fica s√≥ com esse texto.<br/>
              Se o gasto for operacional e n√£o existir etiqueta adequada na lista da Clara, abra chamado no
              <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
              <strong>ServiceNow</strong>
              </a>
              solicitando cria√ß√£o ou ajuste de etiqueta.
              </p>`;
                }
                break;
            }


            case "sobreBot":
            resposta = `HTML:<div class="text-sm text-slate-700">
          <p>Sou o <b>Vektor</b> ü§ñ ‚Äî Agente do <b>Grupo SBF</b> especializado no <b>cart√£o Clara</b>.

          <p class="mt-2">Posso te ajudar com v√°rias coisas, por exemplo:
          <ul class="list-disc ml-5 mt-1">
          <li>Explicar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>;</li>
          <li>Orientar sobre <b>o que pode e o que n√£o pode ser comprado</b>;</li>
          <li>Indicar a <b>etiqueta correta</b> pra cada tipo de gasto (ex.: √°gua, lanche, inform√°tica, manuten√ß√£o...);</li>
          <li>Guiar sobre <b>bloqueio e desbloqueio</b> do cart√£o;</li>
          <li>Consultar <b>pend√™ncias da loja</b> e at√© <b>enviar o resumo por e-mail</b>;</li>
          <li>Consultar <b>transa√ß√µes efetuadas</b> e tamb√©m comparar com outras lojas ou times</b>;</li>
          <li>Mostrar <b>como solicitar novo cart√£o</b> (primeira ou segunda via);</li>
          <li>Explicar sobre o <b>Termo de Responsabilidade</b> e onde preencher;</li>
          <li>Responder d√∫vidas sobre <b>sangria, limite, reembolsos e presta√ß√£o de contas</b>;</li>
          <li>E, claro, te direcionar para os canais certos como <b>Financeiro</b> ou <b>ServiceNow</b> quando for preciso.

          <p class="mt-3">Basta me perguntar de forma natural, tipo:</p>
          <p>‚Ä¢ ‚ÄúQual etiqueta usar para lanche de treinamento?‚Äù<br/>
          ‚Ä¢ ‚ÄúPosso comprar mouse no cart√£o Clara?‚Äù<br/>
          ‚Ä¢ ‚ÄúQuais lojas/times com maior valor/quantidade de transa√ß√µes?‚Äù<br/>
          ‚Ä¢ ‚ÄúTimes X, Y ou Z no periodo XXXXX‚Äù<br/>
          ‚Ä¢ ‚ÄúPend√™ncias da loja 1234?‚Äù</p>

          <p class="mt-3 italic text-slate-500">Estou aqui pra facilitar o dia a dia das lojas no uso do cart√£o Clara. üíú</p>
          </div>`;
            break;

            case "limite":
                ultimaIntencao = "limite";
                resposta = respLimite();
                break;

                    case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
            resposta = respCartaoGeral();
            break;

    
            case "bloqueio": {
                  ultimaIntencao = "bloqueio";

                  // 1) Envia a mensagem principal de bloqueio (j√° aparece com os 3 pontinhos)
                  renderBotMessage(respBloqueio());

                  // 2) Prepara o estado para o fluxo de pend√™ncias ligadas a bloqueio
                  origemPendenciasBloqueio = true;
                  estadoPendencias = "aguardando_loja";
                  lojaPendenciasAtual = "";
                  ultimaPendenciaResumo = null;

                  // 3) Agenda a PR√ìXIMA mensagem, com delay, tamb√©m usando renderBotMessage
                  //    ‚Üí assim aparece de novo o "digitando..." antes dela
                  setTimeout(() => {
                      renderBotMessage(`HTML:<p class="text-sm text-slate-700">
              Caso realmente seu cart√£o esteja bloqueado, devido a situa√ß√µes ligadas a pend√™ncias de justificativas de transa√ß√µes na Clara, posso te mostrar as pend√™ncias mais recentes do cart√£o da sua loja, da√≠ voc√™ j√° corre l√° no app da Clara pra regularizar üòâ .<br/><br/>
              üó£Ô∏è Me informa o n√∫mero da loja, por favor.
              </p>`);
                  }, 1000); // 1000 ms = 1 segundo depois da primeira mensagem

                  // 4) N√£o devolve texto pro fluxo principal, porque a segunda mensagem
                  //    j√° vai ser enviada pelo setTimeout
                  return null;
              }

            case "prestacao":
                ultimaIntencao = "prestacao";
                resposta = respPrestacaoContas();
                break;

            case "alimentoTime":
                ultimaIntencao = "alimentoTime";
                resposta = respAlimentoTime();
                break;

            case "transportePessoal":
                ultimaIntencao = "transportePessoal";
                resposta = respTransportePessoal();
                break;

            case "trocaGerente":
                ultimaIntencao = "trocaGerente";
                resposta = respTrocaGerente();
                break;

            case "sangria":
                ultimaIntencao = "sangria";
                resposta = respSangria();
                break;

            case "fraudeContestacao":
                ultimaIntencao = "fraudeContestacao";
                resposta = respFraudeContestacao();
                break;

                case "podeNaoPode":
                case "generica":
                default:
                    ultimaIntencao = "generica";

                    // antes do gen√©rico
                    if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) {
                      // deixa o bloco singular tratar; n√£o cai no gen√©rico
                      return;
                    } else {
                      resposta = respGenerica(norm);
                    }
                    break;
                        }

        return resposta;
    }

    // ====== MINI BOT DO MANUAL CLARA ======

    
const MANUAL_CLARA_LINK = "https://drive.google.com/file/d/1TYJ7x5Uxb5C47pNpUDWIzxXZb9lJfm8I/view?usp=sharing";
const POLITICA_CARTOES_CLARA_LINK = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";
const LOOKER_RELATORIO_URL = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

window.vektorManualClaraSecao = function (secaoId) {
  let html = "";

  if (secaoId === "primeiro_acesso") {
    html =
      "<p><b>01 Primeiro acesso:</b></p><br>" +
      "<p>1Ô∏è‚É£ Verifique se voc√™ recebeu o e-mail da Clara com o assunto <b>‚ÄúJunte-se √† Clara‚Äù</b> (olhe tamb√©m no SPAM).</p>" +
      "<p>2Ô∏è‚É£ Siga o link do e-mail para criar sua senha.</p>" +
      "<p>3Ô∏è‚É£ Ative a autentica√ß√£o em 2 etapas com um app como o <b>Google Authenticator</b> e escaneie o QR Code ao fazer o primeiro login no site da Clara.</p>" +
      "<p>4Ô∏è‚É£ Depois disso, sempre que entrar no site ser√° pedido o c√≥digo de 6 d√≠gitos gerado pelo app de autentica√ß√£o.</p>";
  }

  else if (secaoId === "recebi_cartao") {
    html =
      "<p><b>02 Recebi o cart√£o, e agora?</b></p><br>" +
      "<p>1Ô∏è‚É£ Baixe o app <b>Clara Card</b> (iOS ou Android).</p>" +
      "<p>2Ô∏è‚É£ Fa√ßa login com o mesmo e-mail/senha que voc√™ usa na plataforma Clara.</p>" +
      "<p>3Ô∏è‚É£ V√° em <b>Cart√µes</b>, selecione o cart√£o recebido e clique em <b>Ativar</b>.</p>" +
      "<p>4Ô∏è‚É£ Informe os <b>4 √∫ltimos d√≠gitos</b> do cart√£o e conclua a ativa√ß√£o.</p>" +
      "<p>Depois disso o cart√£o j√° fica pronto para uso.</p>";
  }

  else if (secaoId === "esqueci_senha") {
    html =
      "<p><b>03 Esqueci a senha do cart√£o / acesso:</b></p><br>" +
      "<p>üîê <b>Senha do cart√£o</b>: voc√™ v√™ apenas pelo aplicativo da Clara, em <b>Cart√µes &gt; Ver senha</b>. A senha √© gerada automaticamente e n√£o √© alter√°vel.</p><br>" +
      "<p>üîë <b>Senha de login</b>: se esqueceu, use a op√ß√£o de <b>redefinir senha</b> na tela de login da Clara. Um link ser√° enviado para seu e-mail para criar uma nova senha.</p>" +
      "<p>Se voc√™ perdeu acesso ao app de autentica√ß√£o (2 etapas), pe√ßa para algu√©m com acesso administrativo redefinir sua autentica√ß√£o.</p>";
  }

  else if (secaoId === "qual_meu_acesso") {
    html =
      "<p><b>04 Qual o meu acesso?</b></p><br>" +
      "<p>1Ô∏è‚É£ Entre na plataforma Clara pelo computador.</p>" +
      "<p>2Ô∏è‚É£ Clique em <b>Meu Perfil</b>, no canto superior direito.</p>" +
      "<p>3Ô∏è‚É£ Na √°rea de <b>A√ß√µes do usu√°rio</b> aparece o seu tipo de acesso:</p>" +
      "<ul>" +
        "<li>‚Ä¢ <b>Administrador (Owner)</b>: acesso total, v√™ saldo global, faturas, relat√≥rios completos.</li>" +
        "<li>‚Ä¢ <b>Gerente (Manager)</b>: gerencia usu√°rios/cart√µes do seu grupo e v√™ saldo global.</li>" +
        "<li>‚Ä¢ <b>Colaborador (Employee)</b>: v√™ somente seus cart√µes, transa√ß√µes e pode anexar notas.</li>" +
        "<li>‚Ä¢ <b>Contador (Accountant)</b>: acesso a todas as faturas, boletos, relat√≥rios e transa√ß√µes.</li>" +
      "</ul>";
  }

  else if (secaoId === "anexar_comprovante") {
    html =
      "<p><b>05 Como anexar comprovante?</b></p><br>" +
      "<p><b>Pelo app (celular):</b></p>" +
      "<ol>" +
        "<li>1. Abra o app da Clara e fa√ßa login.</li>" +
        "<li>2. V√° em <b>Transa√ß√µes</b> e selecione a compra.</li>" +
        "<li>3. Toque em <b>Anexar</b> e tire foto ou escolha o arquivo (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um <b>coment√°rio</b> explicando a despesa.</li><br>" +
      "</ol>" +
      "<p><b>Pelo computador:</b></p>" +
      "<ol>" +
        "<li>1. Acesse a plataforma Clara e v√° em <b>Transa√ß√µes</b>.</li>" +
        "<li>2. Clique na transa√ß√£o desejada.</li>" +
        "<li>3. Em <b>Selecionar arquivos</b>, envie o comprovante (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um coment√°rio explicando a despesa.</li>" +
      "</ol>";
  }

  else if (secaoId === "duvidas") {
    html =
      "<p><b>06 D√∫vidas:</b></p><br>" +
      "<p>Alguns pontos importantes:</p>" +
      "<ul>" +
        "<li>‚Ä¢ <b>Autentica√ß√£o em 2 etapas</b>: sempre use o c√≥digo de 6 d√≠gitos do app de autentica√ß√£o ao entrar no site.</li>" +
        "<li>‚Ä¢ <b>Problema de login</b>: verifique e-mail min√∫sculo, senha correta ou use ‚ÄúContinuar com Google‚Äù se j√° usou antes.</li>" +
        "<li>‚Ä¢ <b>Perdi o celular ou cart√£o</b>: pe√ßa para algu√©m com acesso administrativo bloquear/cancelar o cart√£o e criar outro.</li>" +
        "<li>‚Ä¢ <b>Cancelamento/estorno</b>: tente primeiro com o estabelecimento; se n√£o resolver, conteste a transa√ß√£o via app/plataforma da Clara.</li>" +
      "</ul>" +
      "<p>Canais de suporte Clara: telefone 0800, e-mail, chat na Central de Ajuda (conforme manual).</p>";
  }

  if (!html) return;

  // Rodap√© padr√£o com link para o manual completo
  html +=
    "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
      "Caso queira mais detalhes, acesse o manual completo: " +
      "<a href='" + MANUAL_CLARA_LINK + "' target='_blank' style='color:#005E27;font-weight:bold;'>Manual do Usu√°rio Clara</a>." +
    "</p>";

  // üëâ REGISTRA o t√≥pico no hist√≥rico
  try {
    registrarTopicoManualClara(secaoId);
  } catch (e) {
    console.warn("N√£o consegui registrar hist√≥rico do manual:", e);
  }

  // Envia a resposta principal
  renderBotMessage("HTML:<div class='text-sm text-slate-700'>" + html + "</div>");
  scrollToBottom && scrollToBottom();

  // üëâ Mostra um resumo do que o usu√°rio j√° acessou (se tiver mais de 1 item)
  //vektorMostrarHistoricoManualSeExistir();

    // üëâ Sugest√£o autom√°tica baseada no t√≥pico aberto
  if (typeof window.vektorSugerirTopicoRelacionadoManual === "function") {
    window.vektorSugerirTopicoRelacionadoManual(secaoId);
  }
};

// Mapeia o ID t√©cnico para um t√≠tulo amig√°vel
function mapSecaoManualParaTitulo(secaoId) {
  switch (secaoId) {
    case "primeiro_acesso":
      return "01 Primeiro acesso";
    case "recebi_cartao":
      return "02 Recebi o cart√£o, e agora?";
    case "esqueci_senha":
      return "03 Esqueci a senha do cart√£o / acesso";
    case "qual_meu_acesso":
      return "04 Qual o meu acesso?";
    case "anexar_comprovante":
      return "05 Como anexar comprovante?";
    case "duvidas":
      return "06 D√∫vidas";
    default:
      return null;
  }
}

// Salva o hist√≥rico no localStorage (m√°x. 20 registros)
function registrarTopicoManualClara(secaoId) {
  try {
    const titulo = mapSecaoManualParaTitulo(secaoId);
    if (!titulo) return;

    const STORAGE_KEY = "vektor_manual_clara_historico";

    let historico = [];
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) historico = parsed;
      } catch (e) {
        console.warn("Hist√≥rico do manual Clara estava corrompido, reiniciando.");
      }
    }

    historico.push({
      secao: secaoId,
      titulo: titulo,
      dataIso: new Date().toISOString()
    });

    // limita a 20 entradas mais recentes
    if (historico.length > 20) {
      historico = historico.slice(historico.length - 20);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(historico));
  } catch (e) {
    console.warn("Erro ao salvar hist√≥rico do manual Clara:", e);
  }
}

// L√™ o hist√≥rico e devolve ordenado do mais recente para o mais antigo
function obterHistoricoManualClara() {
  const STORAGE_KEY = "vektor_manual_clara_historico";
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];

    // ordena do mais recente para o mais antigo
    return parsed
      .filter(item => item && item.titulo && item.dataIso)
      .sort((a, b) => (a.dataIso || "").localeCompare(b.dataIso || ""));
  } catch (e) {
    console.warn("Erro ao ler hist√≥rico do manual Clara:", e);
    return [];
  }
}

// Mostra uma mensagem "Voc√™ j√° acessou recentemente..." no chat
function vektorMostrarHistoricoManualSeExistir() {
  try {
    const historico = obterHistoricoManualClara();
    if (!historico || historico.length <= 1) {
      // se s√≥ tem 0 ou 1 item, n√£o faz sentido falar em "recentemente"
      return;
    }

    // pega no m√°ximo 5 mais recentes (sem duplicar t√≠tulos)
    const vistos = [];
    const titulosJaUsados = new Set();

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || !item.titulo) continue;
      if (titulosJaUsados.has(item.titulo)) continue;

      titulosJaUsados.add(item.titulo);
      vistos.push(item.titulo);

      if (vistos.length >= 5) break;
    }

    if (!vistos.length) return;

    const listaHtml = vistos
      .map(t => "<li>‚Ä¢ " + t + "</li>")
      .join("");

    const html =
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Voc√™ j√° acessou recentemente:</b></p>" +
        "<ul style='margin-top:4px;margin-left:16px;'>" +
          listaHtml +
        "</ul>" +
        "<p style='margin-top:6px;font-size:12px;color:#64748b;'>" +
          "Voc√™ pode clicar novamente nos bot√µes do Manual da Clara para reabrir qualquer um desses t√≥picos." +
        "</p>" +
      "</div>";

    renderBotMessage("HTML:" + html);
    if (typeof scrollToBottom === "function") {
      scrollToBottom();
    }
  } catch (e) {
    console.warn("Erro ao mostrar hist√≥rico do manual Clara:", e);
  }
}

// ---------------------------------------------------------------------
// SUGEST√ïES GERAIS DO VEKTOR (fora do Manual da Clara)
// ---------------------------------------------------------------------

function vektorSugerirTopicosGerais(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);
    const blocos = [];

    // 1) D√∫vidas de PERMISS√ÉO DE COMPRA ‚Üí sugerir Pol√≠tica de Uso
    if (
      (
        norm.includes("pode comprar") ||
        norm.includes("posso comprar") ||
        norm.includes("pode usar") ||
        norm.includes("posso usar") ||
        norm.includes("pode pagar") ||
        norm.includes("posso pagar") ||
        norm.includes("permitido") ||
        norm.includes("permitida") ||
        norm.includes("proibido") ||
        norm.includes("proibida")
      ) &&
      typeof POLITICA_CARTOES_CLARA_LINK === "string"
    ) {
      blocos.push(
        "<div style='margin-top:6px;'>" +
          "<p><b>Dica:</b> sempre que tiver d√∫vida se uma compra √© permitida ou n√£o, voc√™ pode consultar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>.</p>" +
          "<button type='button' " +
            "onclick=\"window.open('" + POLITICA_CARTOES_CLARA_LINK + "','_blank')\" " +
            "style='margin-top:6px;background:#06167d;color:#fff;border:none;" +
                   "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir Pol√≠tica de Uso dos Cart√µes Clara" +
          "</button>" +
        "</div>"
      );
    }

    // 2) Pedidos de RELAT√ìRIO / RANKING / DASHBOARD ‚Üí sugerir Looker Studio
    
    if (
  !__vektorJaSugeriuLooker &&   // üëà imp√µe limite de 1 vez por sess√£o
  (
    // termos gen√©ricos de relat√≥rio / ranking / dashboard
    norm.includes("top") ||
    norm.includes("mais comprou") ||
    norm.includes("mais gastos") ||
    norm.includes("mais gastou") ||
    norm.includes("mais compras") ||
    norm.includes("maior valor") ||
    norm.includes("mais transa√ß√µes") ||
    norm.includes("mais transacoes")
  )
) {
      blocos.push(
        "<div style='margin-top:10px;'>" +
          "<p>Se quiser uma vis√£o completa (gr√°ficos, filtros e detalhamentos), voc√™ pode abrir o relat√≥rio gerencial no <b>Looker Studio</b>:</p>" +
          "<button type='button' " +
            "onclick=\"window.open('" + LOOKER_RELATORIO_URL + "','_blank')\" " +
            "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
                   "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir relat√≥rio gerencial (Looker Studio)" +
          "</button>" +
        "</div>"
      );
    }

    __vektorJaSugeriuLooker = true;


    // 3) PEND√äNCIAS / JUSTIFICATIVAS ‚Üí refor√ßar pol√≠tica e fluxo
    if (
        norm.includes("pendencia") ||
        norm.includes("pend√™ncia") ||
        norm.includes("pendencias") ||
        norm.includes("pend√™ncias") ||
        norm.includes("justificativa") ||
        norm.includes("justificativas") ||
        norm.includes("justificar") ||

        // voc√™ comentou frases tipo:
        // "ver justificativas completas de uma loja" / "de um time"
        norm.includes("justificativas completas") ||
        norm.includes("ver justificativas completas") ||
        norm.includes("justificativas de uma loja") ||
        norm.includes("justificativas de um time")
    ) {
      blocos.push(
        "<div style='margin-top:10px;'>" +
          "<p>Al√©m de anexar os comprovantes, existe uma pol√≠tica espec√≠fica de prazos e regras para justificativas.</p>" +
          "<p style='margin-top:4px;'>Em caso de d√∫vida, consulte a <b>Pol√≠tica de Uso dos Cart√µes Clara</b> ou acione o time de Conta a Receber.</p>" +
        "</div>"
      );
    }

    // Se nada acionou, n√£o sugere nada
    if (!blocos.length) return;

    const html =
  "HTML:<div class='text-sm text-slate-700 mt-2'>" +
    blocos.join("<hr style='margin:8px 0;border:none;border-top:1px solid #e2e8f0;'/>") +
  "</div>";

// üîÅ Aguarda para dar tempo da resposta "normal" aparecer antes
setTimeout(function () {
  renderBotMessage(html);
  if (typeof scrollToBottom === "function") {
    scrollToBottom();
  }
}, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir t√≥picos gerais:", e);
  }

  // Sugest√£o quando o usu√°rio fala de ciclo de fatura
if (
  norm.includes("ciclo da fatura") ||
  norm.includes("ciclo de fatura") ||
  norm.includes("ciclo da fatura da clara") ||
  norm.includes("periodo da fatura") ||
  norm.includes("per√≠odo da fatura")
) {
  vektorMostrarSugestao(
    "Quer ver a tabela completa das faturas?",
    "Quero ver a tabela de faturas da Clara"
  );
}

}

// ---------------------------------------------------------------------
// SUGEST√ïES AUTOM√ÅTICAS DO MANUAL DA CLARA A PARTIR DE OUTROS ASSUNTOS
// ---------------------------------------------------------------------

const VEKTOR_TEMPO_SUGESTAO_MIN = 5000; // Depois que j√° sugeriu...
const VEKTOR_SUGESTAO_DELAY_MS = 15000;   // Primeira vez que sugeriu

// Verifica se o usu√°rio j√° abriu um t√≥pico do manual h√° pouco tempo
function usuarioViuTopicoManualRecentemente(secaoId, minutosJanela) {
  try {
    minutosJanela = minutosJanela || 10; // padr√£o = 10 minutos
    const historico = obterHistoricoManualClara();
    if (!historico || !historico.length) return false;

    const agora = Date.now();
    const limiteMs = minutosJanela * 60 * 1000;

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || item.secao !== secaoId || !item.dataIso) continue;

      const t = Date.parse(item.dataIso);
      if (!isNaN(t) && (agora - t) <= limiteMs) {
        return true; // j√° viu recentemente
      }
    }
  } catch (e) {
    console.warn("Erro ao checar hist√≥rico recente do manual:", e);
  }
  return false;
}

// L√™ a pergunta do usu√°rio e, se fizer sentido, sugere um t√≥pico do Manual da Clara

function vektorSugerirManualAPartirDaPergunta(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);

    // Se o usu√°rio j√° pediu o manual explicitamente, n√£o sugerimos aqui
    if (
      norm.includes("manual clara") ||
      norm.includes("manual da clara") ||
      norm.includes("treinamento clara") ||
      norm.includes("treinamento da clara")
    ) {
      return;
    }

    let sugestao = null;

    // 1) Comprovante / nota / justificativa ‚Üí sugerir "Como anexar comprovante"
    if (
      norm.includes("comprovante") ||
      norm.includes("nota fiscal") ||
      norm.includes(" nf ") ||
      norm.includes(" xml") ||
      norm.includes("justificativa") ||
      norm.includes("justificar") ||
      norm.includes("pendencia") ||
      norm.includes("pendencias") ||
      norm.includes("pend√™ncias") ||
      norm.includes("pend√™ncia")
    ) {
      if (!usuarioViuTopicoManualRecentemente("anexar_comprovante", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "anexar_comprovante",
          tituloBotao: "Ver como anexar comprovante",
          textoIntro:
            "Percebi que voc√™ est√° falando de nota fiscal, comprovante ou pend√™ncia. Quer abrir o trecho do Manual da Clara sobre isso?"
        };
      }
    }

    // 2) Problemas de login / primeiro acesso
    else if (
      norm.includes("primeiro acesso") ||
      norm.includes("primeiro login") ||
      norm.includes("junte-se a clara") ||
      norm.includes("junte se a clara") ||
      norm.includes("nao consigo acessar") ||
      norm.includes("n√£o consigo acessar") ||
      norm.includes("erro de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("primeiro_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "primeiro_acesso",
          tituloBotao: "Ver instru√ß√µes de primeiro acesso",
          textoIntro:
            "Se for sua primeira vez usando a Clara ou estiver com dificuldade de acesso, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 3) Esqueci a senha / senha do cart√£o
    else if (
      norm.includes("esqueci a senha") ||
      norm.includes("esqueci minha senha") ||
      norm.includes("senha do cartao") ||
      norm.includes("senha do cart√£o") ||
      norm.includes("senha de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("esqueci_senha", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "esqueci_senha",
          tituloBotao: "Ver como recuperar/consultar senha",
          textoIntro:
            "Voc√™ comentou sobre senha. Posso abrir a parte do Manual da Clara que fala sobre isso:"
        };
      }
    }

    // 4) Tipo de acesso / perfil
    else if (
      norm.includes("meu acesso") ||
      norm.includes("tipo de acesso") ||
      norm.includes("owner") ||
      norm.includes("manager") ||
      norm.includes("employee") ||
      norm.includes("contador")
    ) {
      if (!usuarioViuTopicoManualRecentemente("qual_meu_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "qual_meu_acesso",
          tituloBotao: "Ver tipos de acesso na Clara",
          textoIntro:
            "Se a d√∫vida √© sobre qual √© o seu tipo de acesso na Clara, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 5) D√∫vidas gerais, suporte, estorno, cart√£o perdido, etc.
    else if (
      norm.includes("duvida") ||
      norm.includes("d√∫vida") ||
      norm.includes("ajuda") ||
      norm.includes("suporte") ||
      norm.includes("telefone") ||
      norm.includes("0800") ||
      norm.includes("estorno") ||
      norm.includes("contestacao") ||
      norm.includes("contesta√ß√£o") ||
      norm.includes("perdi o cartao") ||
      norm.includes("perdi o cart√£o") ||
      norm.includes("cartao perdido") ||
      norm.includes("cart√£o perdido") ||
      norm.includes("cartao roubado") ||
      norm.includes("cart√£o roubado") ||
      norm.includes("bloquear cartao") ||
      norm.includes("bloquear cart√£o")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver d√∫vidas e canais de suporte",
          textoIntro:
            "Como voc√™ mencionou d√∫vidas, suporte, estorno ou perda/bloqueio de cart√£o, posso te mostrar o trecho do Manual da Clara com os principais contatos e orienta√ß√µes:"
        };
      }
    }

    // 6) Limite / aumento de limite / limite estourado
    else if (
      norm.includes("limite") ||
      norm.includes("aumentar limite") ||
      norm.includes("aumento de limite") ||
      norm.includes("ajustar limite") ||
      norm.includes("cart√£o sem limite limite") ||
      norm.includes("estourou o limite") ||
      norm.includes("limite estourado")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orienta√ß√µes gerais e canais de suporte",
          textoIntro:
            "Voc√™ falou sobre limite de cart√£o. Posso abrir a parte do Manual do usu√°rio da Clara com orienta√ß√µes gerais e canais de suporte para esse tipo de d√∫vida:"
        };
      }
    }

    // 7) Bloqueio por pend√™ncia / cart√£o recusado
    else if (
      norm.includes("cartao bloqueado") ||
      norm.includes("cart√£o bloqueado") ||
      norm.includes("cartao recusado") ||
      norm.includes("cart√£o recusado") ||
      norm.includes("nao aprovou") ||
      norm.includes("n√£o aprovou") ||
      norm.includes("recusou a compra") ||
      norm.includes("compra recusada")
    ) {
      if (!usuarioViuTopicoManualRecentemente("anexar_comprovante", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "anexar_comprovante",
          tituloBotao: "Ver como regularizar usando comprovantes",
          textoIntro:
            "Quando h√° bloqueios e recusas, muitas vezes o problema est√° em pend√™ncias de comprovantes. Quer ver o trecho do Manual que explica como anexar comprovantes e regularizar?"
        };
      }
    }

    // 8) Fraude / transa√ß√£o desconhecida / contesta√ß√£o
    else if (
      norm.includes("fraude") ||
      norm.includes("transacao desconhecida") ||
      norm.includes("transa√ß√£o desconhecida") ||
      norm.includes("lancamento indevido") ||
      norm.includes("lan√ßamento indevido") ||
      norm.includes("compra indevida")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orienta√ß√µes de contesta√ß√£o/estorno",
          textoIntro:
            "Voc√™ comentou sobre transa√ß√£o desconhecida ou poss√≠vel fraude. Posso abrir a parte do Manual do usu√°rio da Clara que fala sobre contesta√ß√£o e estorno:"
        };
      }
    }

    // Se nenhuma sugest√£o foi montada, sai
    if (!sugestao) return;

    const html =
  "HTML:<div class='text-sm text-slate-700 mt-2'>" +
    "<p>" + sugestao.textoIntro + "</p>" +
    "<button type='button' " +
      "onclick=\"vektorManualClaraSecao('" + sugestao.secaoId + "')\" " +
      "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
             "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
      sugestao.tituloBotao +
    "</button>" +
  "</div>";

// üîÅ Aguarda para dar tempo da resposta principal aparecer antes
setTimeout(function () {
  renderBotMessage(html);
  if (typeof scrollToBottom === "function") {
    scrollToBottom();
  }
}, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir t√≥pico do Manual da Clara:", e);
  }
}


// ========= SUGEST√ÉO AUTOM√ÅTICA DE T√ìPICOS RELACIONADOS ========= //

window.vektorSugerirTopicoRelacionadoManual = function (secaoId) {
  // Por enquanto vamos tratar apenas o caso "anexar_comprovante"
  if (secaoId !== "anexar_comprovante") return;

  const html =
    "HTML:<div class='text-sm text-slate-700 mt-2'>" +
      "<p><b>Sugest√£o:</b> Quer ver tamb√©m como funciona a <b>pol√≠tica de justificativas</b>?</p>" +
      "<div style='margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;'>" +
        "<button onclick=\"vektorAbrirPoliticaJustificativas()\" " +
                "class='px-3 py-2 rounded-md bg-[#005E27] text-white text-sm font-semibold'>" +
          "Ver pol√≠tica de justificativas" +
        "</button>" +
        "<button onclick=\"vektorIgnorarSugestaoPolitica()\" " +
                "class='px-3 py-2 rounded-md border text-sm'>" +
          "Agora n√£o" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
}

// Quando o usu√°rio clicar em "Ver pol√≠tica de justificativas"
window.vektorAbrirPoliticaJustificativas = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p><b>Pol√≠tica de justificativas (resumo):</b></p>" +
      "<ul style='margin-top:4px;margin-left:16px;'>" +
        "<li>‚Ä¢ Cada transa√ß√£o deve ter justificativa e comprovante anexado dentro de, no m√°ximo, 48 horas ap√≥s a cpmpra.</li><br>" +
        "<li>‚Ä¢ <b>Para justificar</b>: Inserir nota fiscal ou recibo da compra, informar a etiqueta do tipo de gasto e inserir no campo Descri√ß√£o o item adquirido.</li><br>" +
        "<li>‚Ä¢ Despesas sem justificativas ou com documentos inconsistentes podem ser questionadas pelo time Financeiro.</li><br>" +
        "<li>‚Ä¢ Em casos recorrentes, a empresa pode adotar medidas adicionais, como o bloqueio preventivo do cart√£o.</li>" +
      "</ul>" +
   // üîΩ AQUI ENTRA O LINK NO RODAP√â
      "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
        "Consulte a Pol√≠tica de Uso dos Cart√µes Clara: " +
        "<a href='" + POLITICA_CARTOES_CLARA_LINK + "' target='_blank' " +
        "style='color:#005E27;font-weight:bold;'>clique aqui para abrir</a>." +
      "</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// Caso ele clique em "Agora n√£o"
window.vektorIgnorarSugestaoPolitica = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p>Beleza. Se quiser ver a pol√≠tica de justificativas depois, √© s√≥ me pedir üòâ</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// ================= VEKTOR_STATE ‚Äì mem√≥ria leve da conversa =================
window.VEKTOR_STATE = {
  ultimaIntencao: null,         // ex: "ranking_lojas", "resumo_times", "fatura_times"
  ultimoPeriodo: null,          // { dataInicioIso, dataFimIso }
  ultimoGrupo: null,            // nome do time / grupo
  ultimaLoja: null,             // c√≥digo da loja
  ultimaAcaoExplicavel: null,   // meta da √∫ltima tabela gerada
  sugestoesMostradas: []        // controle de sugest√µes proativas para n√£o repetir
};

function vektorRegistrarContexto(evento) {
  try {
    if (!evento || typeof evento !== "object") return;

    window.VEKTOR_STATE = window.VEKTOR_STATE || {};
    Object.assign(window.VEKTOR_STATE, evento);
  } catch (e) {
    console.warn("Erro ao registrar contexto:", e);
  }
}

function vektorObterContexto() {
  return window.VEKTOR_STATE || {};
}

    /* ========= GERADOR FINAL ========= */

function gerarRespostaDoBot(msgUsuario) {
  const norm = normalize(msgUsuario || "");

  // Treinamento Clara - apresenta√ß√£o em Slides
if (
  norm.includes("treinamento clara") ||
  norm.includes("treinamento do cartao clara") ||
  norm.includes("treinamento do cart√£o clara") ||
  norm.includes("treinamento sobre uso do cartao") ||
  norm.includes("treinamento sobre uso do cart√£o")
) {
  const htmlTreinamento = `HTML:
<div class="text-sm text-slate-700">

  <h2 style="font-size: 1.1rem; font-weight: 700; text-align: center; margin-top: -8px; margin-bottom: 8px;">
    Treinamento oficial sobre o uso do cart√£o Clara
  </h2>

  <p class="mb-2" style="text-align:center; margin-top: -4px;">
    Use esta apresenta√ß√£o para refor√ßar boas pr√°ticas com o time da loja:
  </p>

  <div style="position:relative;padding-bottom:62%;height:0;overflow:hidden;max-width:100%;
              border-radius:8px;border:1px solid #ddd;">
    <iframe
      src="https://docs.google.com/presentation/d/e/2PACX-1vRTlL30pbq4rkyBlo0cLHgE3Tqeg_bLaWlIBY20tSzEdIS5QlIuWRjIv4A1j_Lfnb9_gaZ6woWJ7SDh/pubembed?start=false&loop=false&delayms=3000"
      frameborder="0"
      style="position:absolute;top:0;left:0;width:100%;height:100%;"
      allowfullscreen="true"
      mozallowfullscreen="true"
      webkitallowfullscreen="true">
    </iframe>
  </div>

  <p class="mt-2 text-xs text-slate-500" style="text-align:center;">
    Se preferir, abra em tela cheia pelo bot√£o dispon√≠vel na apresenta√ß√£o.
  </p>

</div>`;

  return htmlTreinamento;
}

// Relat√≥rio Gerencial / Dashboard Looker Studio
if (
  norm.includes("relatorio gerencial") ||
  norm.includes("relat√≥rio gerencial") ||
  norm.includes("abrir relatorio gerencial") ||
  norm.includes("abrir relat√≥rio gerencial") ||
  norm.includes("ver dashboard") ||
  norm.includes("dashboard looker") ||
  norm.includes("looker studio")
) {
  return "HTML:" +
    "<div style='margin-top:10px;'>" +
      "<p>Para uma vis√£o completa (gr√°ficos, filtros e detalhamentos), acesse o relat√≥rio gerencial da Clara:</p>" +
      "<button type='button' " +
        "onclick=\"window.open('" + LOOKER_RELATORIO_URL + "', '_blank')\" " +
        "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
               "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
        "Abrir relat√≥rio gerencial (Looker Studio)" +
      "</button>" +
    "</div>";
}
  

    // Uso respons√°vel do limite do cart√£o Clara
  if (
    norm.includes("usar bem o limite") ||
    (norm.includes("limite") && norm.includes("usar")) ||
    norm.includes("uso do limite do cartao") ||
    norm.includes("uso do limite do cart√£o")
  ) {
    return "HTML:<div class='text-sm text-slate-700'>"
      + "<p class='mb-2'>"
      + "O limite do cart√£o Clara foi definido para cobrir, com seguran√ßa, os gastos previstos do ciclo de fatura "
      + "(de <b>06</b> at√© <b>05</b> do m√™s seguinte). Para usar bem esse limite, sem precisar aumentar durante o m√™s, "
      + "considere estas pr√°ticas:"
      + "</p>"
      + "<ul class='list-disc ml-4 space-y-1'>"
      + "<li><b>Planeje o m√™s pelo ciclo da fatura:</b> some os gastos previstos entre os dias 06 e 05 e verifique se cabem no limite dispon√≠vel.</li>"
      + "<li><b>Priorize despesas operacionais essenciais:</b> use o cart√£o principalmente para despesas previstas na pol√≠tica (ex.: material de escrit√≥rio, manuten√ß√£o, marketing autorizado, etc.).</li>"
      + "<li><b>Evite concentrar grandes compras no in√≠cio do ciclo:</b> isso pode travar o limite e impedir compras importantes mais para o fim do m√™s.</li>"
      + "<li><b>Prefira compras √† vista ou com poucos parcelamentos:</b> parcelamentos longos consomem o limite pelos pr√≥ximos ciclos e reduzem a flexibilidade da loja.</li>"
      + "<li><b>Acompanhe o uso do limite ao longo do m√™s:</b> consulte o extrato da Clara e os relat√≥rios do Vektor para ver quanto j√° foi utilizado e o que ainda est√° dispon√≠vel.</li>"
      + "<li><b>Reserve uma margem para imprevistos:</b> evite usar 100% do limite com despesas previs√≠veis; mantenha uma folga para emerg√™ncias dentro da pol√≠tica.</li>"
      + "<li><b>Evite compras fora da pol√≠tica:</b> gastos n√£o permitidos podem ser bloqueados ou precisar de reembolso, al√©m de consumir o limite de forma indevida.</li>"
      + "</ul>"
      + "<p class='mt-2'>"
      + "Se mesmo seguindo essas orienta√ß√µes o limite estiver sempre no m√°ximo, vale revisar o planejamento de gastos da loja "
      + "e, se for o caso, discutir um ajuste de limite com o time respons√°vel, com base em dados de uso recorrente."
      + "</p>"
      + "</div>";
  }

  // INTEN√á√ÉO: listar etiquetas da Clara (BaseClara, coluna T)
  if (
    norm.includes("listagem de etiquetas") ||
    norm.includes("lista de etiquetas") ||
    norm.includes("etiquetas disponiveis") ||
    norm.includes("etiquetas dispon√≠veis") ||
    norm.includes("etiquetas da clara") ||
    norm.includes("etiquetas na clara")
  ) {
    return "ACAO_LISTAR_ETIQUETAS_CLARA";
  }

  // üÜï Resposta espec√≠fica para o ciclo da fatura da Clara
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("per√≠odo da fatura")
  ) {
    return "HTML:<p class='text-sm text-slate-700'>" +
      "O <b>ciclo da fatura da Clara</b> funciona assim:<br><br>" +
      "‚Ä¢ As compras realizadas entre <b>o dia 6</b> de cada m√™s e <b>o dia 5</b> do m√™s seguinte s√£o " +
      "agrupadas na mesma fatura.<br>" +
      "‚Ä¢ Tudo o que for gasto dentro desse intervalo entra para pagamento nessa fatura do per√≠odo.<br><br>" +
      "Em resumo: o ciclo vai sempre de <b>06</b> a <b>05</b>, e todas as compras feitas nesse per√≠odo " +
      "entram juntas na mesma fatura.</p>";
  }

  // === Gatilho para o MINI MANUAL DA CLARA ===
  if (
    norm.includes("manual clara") ||
    norm.includes("manual da clara") ||
    norm.includes("manual") ||
    norm.includes("treinamento clara") ||
    norm.includes("treinamento da clara") ||
    norm.includes("treinamentos") ||
    norm.includes("treinamento")
  ) {

    
    const htmlPartes = [];

    htmlPartes.push(
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Posso te ajudar a tirar d√∫vidas sobre o uso do cart√£o da Clara.</b> Escolha um dos t√≥picos abaixo üëá</p>" +
        "<div class='mt-3 flex flex-col gap-2'>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('primeiro_acesso')\">" +
        "01 Primeiro acesso" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('recebi_cartao')\">" +
        "02 Recebi o cart√£o, e agora?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('esqueci_senha')\">" +
        "03 Esqueci a senha do cart√£o" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('qual_meu_acesso')\">" +
        "04 Qual o meu acesso?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('anexar_comprovante')\">" +
        "05 Como anexar comprovante?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('duvidas')\">" +
        "06 D√∫vidas" +
      "</button>"
    );

    htmlPartes.push("</div></div>");

    const htmlFinal = htmlPartes.join("");
    return "HTML:" + htmlFinal;
  }

  // üÜï TODAS AS LOJAS DO TIME XXXXX
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasDoTime = detectarListarTodasLojasDoTime(msgUsuario, norm);
  if (detTodasLojasDoTime) {
    const grupo = detTodasLojasDoTime.grupo;
    const p = detTodasLojasDoTime.periodo;
    const tipo = detTodasLojasDoTime.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Montando a <b>rela√ß√£o de todas as lojas do time " + grupo + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todas as lojas do time
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: true,   // j√° faz tabela de lojas por time
          groupName: grupo
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
          "Tive um problema ao consultar os dados para listar as lojas do time " + grupo + ".</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        grupo,          // time solicitado
        dataInicioStr,
        dataFimStr,
        tipo
      );

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    return null;
  }
}

  // Gatilho pend√™ncias (quando n√£o h√° fluxo pend√™ncias em aberto)

    if (estadoPendencias === "nenhum" &&
    termosPendencias.some(t => norm.includes(t))) {

    // tenta extrair n√∫mero de loja j√° presente na mensagem (2 a 6 d√≠gitos)
    const matchLoja = msgUsuario.match(/\b(\d{2,6})\b/);

    if (matchLoja) {
        const lojaBruta = matchLoja[1];
        const lojaNormalizada = lojaBruta.replace(/\D/g, "");

        lojaPendenciasAtual = lojaNormalizada;
        ultimaPendenciaResumo = null;
        estadoPendencias = "aguardando_confirmacao_email";

        // üÜï busca nome da loja antes de responder
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}${nomeLojaTxt}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );

            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .withFailureHandler((err) => {
            // fallback se der erro no BigQuery
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );
            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .obterNomeLojaBigQuery(lojaNormalizada);

        return null; // n√£o retorna outro texto (renderBotMessage j√° enviou)
    }

    // caso n√£o tenha n√∫mero na frase, segue fluxo normal pedindo a loja
    estadoPendencias = "aguardando_loja";
    lojaPendenciasAtual = "";
    ultimaPendenciaResumo = null;

    return `HTML:<p class="text-sm text-slate-700">
    Consigo consultar as pend√™ncias Clara da sua loja.<br/>
    Me informe o c√≥digo da loja (somente n√∫meros), por exemplo: <b>0123</b>.
    </p>`;
}

 /* // >>> TODAS AS LOJAS (geral) por valor
const detTodasLojasResumo = detectarListarTodasLojasGeral(msgUsuario, norm);
if (detTodasLojasResumo) {
  const p = detTodasLojasResumo.periodo;
  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

  renderBotMessage("HTML:<p class='text-sm text-slate-700'>Listando <b>todas as lojas</b> por <b>valor</b>" +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>");

google.script.run
  .withSuccessHandler(function (res) {
  renderResumoTransacoesSemana(res, { topN: 10, forGroup: false });
  renderBotMessage("HTML:<p class='text-xs text-slate-500 italic'>Mostrando top 10 por padr√£o.</p>");
})
  .withFailureHandler(function () { renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja).</p>"); })
  .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, "valor");
  return;
} */

  // üÜï TIMES ESPEC√çFICOS (ex.: "times √Åguias do Cerrado e Lobos SP no per√≠odo ...")

  const detTimesEspec = detectarTimesEspecificosLista(msgUsuario, norm);
  if (detTimesEspec && detTimesEspec.times && detTimesEspec.times.length > 1) {
    const listaTimes = detTimesEspec.times;
    const p          = detTimesEspec.periodo;
    const tipo       = detTimesEspec.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou comparar apenas os times <b>" + listaTimes.join(", ") + "</b> " +
        "por " + (tipo === "valor" ? "<b>valor total</b>" : "<b>quantidade de transa√ß√µes</b>") +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesPorTime(res, {
          topN: null,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados para esses times.</p>"
        );
      })
      .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

    return null;
  }


// >>> RANKING DE TIMES (top N)
const detRankTimes = detectarRankingTimes(msgUsuario, norm);
if (detRankTimes) {
  const p    = detRankTimes.periodo;
  const tipo = detRankTimes.tipo || "valor";      // "valor" ou "quantidade"
  const topN = detRankTimes.topN ?? 10;           // padr√£o: 10
  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de times</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesPorTime(res, { topN: topN });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // igual ao seu bloco de "detTimes", encerra aqui
}


function detectarConsultasTimes(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);

  // plural por quantidade (listar TODOS)
  if (t.includes("times com maior numero de transacoes") || t.includes("times com mais transacoes") ||
      t.includes("times com mais transacao") || t.includes("times com maior quantidade de transacoes")) {
    return { periodo, tipo: "quantidade", topN: null, modo: "plural" };
  }

  // plural por valor (listar TODOS)
  if (t.includes("quais times mais gastaram") || t.includes("times com maior valor de transacoes") ||
      t.includes("times que mais gastaram")) {
    return { periodo, tipo: "valor", topN: null, modo: "plural" };
  }

  // singular -> top 1 por valor
  if (t.includes("qual time mais gastou") || t.includes("time com maior valor de transacoes")) {
    return { periodo, tipo: "valor", topN: 1, modo: "singular" };
  }

  return null;
}

// =========== DETECTOR: "TIMES X E Y NO PER√çODO" =========== //

function detectarTimesEspecificosLista(msgOriginal, norm) {
  const t = norm || "";

  // se falar de LOJA(S), essa fun√ß√£o N√ÉO deve tratar
  if (!t.includes("time") || t.includes("loja") || t.includes("lojas")) {
    return null;
  }

  const lista = (typeof encontrarListaTimesNaMensagem === "function"
    ? (encontrarListaTimesNaMensagem(msgOriginal) || [])
    : []);

  if (!lista.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: lista,
    periodo,
    tipo
  };
}

if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detRankLoja = detectarRankingLojas(msgUsuario, norm);
if (detRankLoja) {
  const periodo = detRankLoja.periodo;
  const tipo    = detRankLoja.tipo || "valor";
  const grupo   = detRankLoja.grupo || "";
  const topNReq = detRankLoja.topN; // pode ser null

  // üìå Regra de TOP:
  // - Se o usu√°rio falar "top X" ‚Üí usa X
  // - Se N√ÉO falar top e N√ÉO tiver time ‚Üí padr√£o = 10
  // - Se N√ÉO falar top e TIVER time ‚Üí deixa null pra listar todas as lojas do time
  const topNFinal = (topNReq != null)
    ? topNReq
    : (grupo ? null : 10);

  // Aviso: ranking geral de lojas (sem time) e sem "top" informado => mostraremos 10
  if (!grupo && topNReq == null) {
    renderBotMessage(
      "HTML:<p class='text-xs text-slate-600 italic'>Obs.: Como o n√∫mero de lojas √© grande, mostrarei as <b>10 primeiras</b> por padr√£o. Voc√™ pode pedir, por exemplo, <b>top 20 lojas</b>.</p>"
    );
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de lojas</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    (periodo ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, {
        topN: topNFinal,        // respeita TOP pedido (ou 10 / null)
        forGroup: !!grupo       // true se estiver filtrando por time
      });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// 2) LOJAS (plural) sem top/ranking  -> lista TODAS do time
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detLojasPlural = detectarLojasMaisTransacoesPlural(msgUsuario, norm);
if (detLojasPlural) {
  const periodo = detLojasPlural.periodo;
  const tipo    = detLojasPlural.tipo || "valor";
  const grupo   = detLojasPlural.grupo || ""; // se vier time, listaremos TODAS as lojas do time
  const topN    = null; // for√ßa 'todas'

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou listar <b>todas as lojas</b> " +
    (grupo ? "do time <b>" + grupo + "</b> " : "") +
    "ordenadas por " + (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
  const n = (topN == null && !grupo) ? 10 : topN; // 10 s√≥ no geral; por time voc√™ decide
  renderResumoTransacoesSemana(res, { topN: n, forGroup: true });
})
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja por time).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// === NOVO: CONSULTAS POR CATEGORIA (BaseClara) ===
const detCategorias = detectarPerguntaCategorias(msgUsuario, norm);
if (detCategorias) {
  const periodo = detCategorias.periodo;
  const tipo    = detCategorias.tipo || "valor";
  const topN    = detCategorias.topN;

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por categoria</b> " +
    (tipo === "valor" ? "considerando <b>valor</b>" : "por <b>quantidade de transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : " em toda a base") +
    "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoPorChaveGenerico(res, {
        tipoChave: "Categoria",
        titulo: (tipo === "valor"
          ? "Categorias com maior valor de transa√ß√µes"
          : "Categorias com maior quantidade de transa√ß√µes"),
        topN: topN
      });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por categoria.</p>");
    })
    .getResumoTransacoesPorCategoria(
      dataInicioStr,
      dataFimStr,
      tipo
    );

  return null;
}

// === NOVO: CONSULTAS POR ESTABELECIMENTO / LOCAL (BaseClara) ===
const detEstab = detectarPerguntaEstabelecimentos(msgUsuario, norm);
if (detEstab) {
  const periodo = detEstab.periodo;
  const tipo    = detEstab.tipo || "valor";
  const topN    = detEstab.topN;
  const grupo   = detEstab.grupo || "";
  const loja    = detEstab.loja  || "";

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  let contexto = "";
  if (grupo) contexto += " para o time <b>" + grupo + "</b>";
  if (loja)  contexto += (contexto ? " e " : " para ") + "a loja <b>" + loja + "</b>";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por estabelecimento</b>" +
    contexto +
    (tipo === "valor" ? " com foco em <b>valor</b>" : " por <b>quantidade de transa√ß√µes</b>") +
    (periodo ? " no per√≠odo solicitado" : " em toda a base") +
    "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoPorChaveGenerico(res, {
        tipoChave: "Estabelecimento",
        titulo: (tipo === "valor"
          ? "Locais com maior valor de gastos"
          : "Locais com maior quantidade de transa√ß√µes"),
        topN: topN
      });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por estabelecimento.</p>");
    })
    .getResumoTransacoesPorEstabelecimento(
      dataInicioStr,
      dataFimStr,
      tipo,
      grupo,
      loja
    );

  return null;
}

// >>> TIME CAMPE√ÉO (singular): "qual time gastou mais ...", "time com mais transa√ß√µes ..."
const detTimeCampeao = detectarPerguntaTimeMaisTransacoes(msgUsuario, norm);
if (detTimeCampeao) {
  const p    = detTimeCampeao.periodo;
  const tipo = detTimeCampeao.tipo || "valor"; // "valor" ou "quantidade"

  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Buscando o <b>time campe√£o</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transa√ß√µes</b>") +
    (p ? " no per√≠odo solicitado" : "") + "‚Ä¶</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // singular ‚Üí sempre Top 1
      renderResumoTransacoesPorTime(res, { topN: 1 });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // encerra aqui
}


  // üÜï TODOS OS TIMES NO PER√çODO / RELA√á√ÉO DE TIMES
  const detTodosTimes = detectarTodosTimesPeriodo(msgUsuario, norm);
  if (detTodosTimes) {
    const p    = detTodosTimes.periodo;
    const tipo = detTodosTimes.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio)
      ? p.dataInicio.toISOString()
      : "";
    const dataFimStr = (p && p.dataFim)
      ? p.dataFim.toISOString()
      : "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todos os times</b> com gasto " +
        (tipo === "valor" ? "por <b>valor total</b>" : "por <b>n√∫mero de transa√ß√µes</b>") +
        (p ? " no per√≠odo solicitado" : "") +
        ". A tabela vai mostrar para cada time o <b>valor total</b> e a <b>quantidade</b> de transa√ß√µes." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (todos os times).</p>"
        );
      })
      .getResumoTransacoesPorTime(
        dataInicioStr,
        dataFimStr,
        tipo
      );

    return null;
  }

    // >>> BLOCO: perguntas de FATURA (Extrato da conta / BaseClara)
  const detFatura = detectarPerguntaFaturaClara(msgUsuario, norm);
  if (detFatura) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou consultar o <b>valor das faturas</b> da Clara " +
        "de acordo com o per√≠odo solicitado...</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.faturas) || !res.faturas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar " +
            "informa√ß√µes de fatura na BaseClara.</p>"
          );
          return;
        }

        var todas = res.faturas || [];
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          detFatura.modo,
          detFatura.qtd
        );

        if (!selecionadas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o encontrei faturas para " +
            "o crit√©rio informado.</p>"
          );
          return;
        }

        var titulo = "RESUMO DE FATURAS CLARA";

        if (detFatura.modo === "atual") {
          titulo = "VALOR DA FATURA ATUAL";
        } else if (detFatura.modo === "anterior") {
          titulo = "VALOR DA FATURA DO M√äS PASSADO";
        } else if (detFatura.modo === "ultimas") {
          var n = detFatura.qtd || 2;
          // se pediu 3 mas s√≥ existem 2, mostra "2"
          var usado = Math.min(n, selecionadas.length);
          titulo = "VALOR DAS √öLTIMAS " + usado + " FATURAS";
        } else if (detFatura.modo === "todas") {
          titulo = "VALOR DE TODAS AS FATURAS";
        }

        var html = vektorMontarTabelaFaturas_(titulo, selecionadas);
        renderBotMessage("HTML:" + html);

    let __vektorChartFaturas = null;

      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar " +
          "os dados de fatura na BaseClara.</p>"
        );
      })
      .getResumoFaturasClara();

    return;
  }

  // >>> NOVO BLOCO: perguntas de relat√≥rio (planilha Captura_Clara / BaseClara)

    const det = detectarPerguntaLojaMaisTransacoes(msgUsuario, norm);
    if (det) {
          const grupoNome = det.grupo || "";      // pode vir vazio (sem time)
          const periodo   = det.periodo;
          const tipo      = det.tipo || "quantidade"; // "quantidade" ou "valor"

  const grupoTxt = grupoNome
    ? ` do time <b>${grupoNome}</b>`
    : "";

  const criterioTxt = tipo === "valor"
    ? "maior <b>valor</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes";

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">
      Beleza! Vou consultar qual loja tem ${criterioTxt}${grupoTxt}${
        periodo ? " no per√≠odo solicitado" : ""
      } e j√° te trago um resumo. ‚è≥
    </p>`
  );

  // Converte datas (se existirem) para string ISO pra mandar pro Apps Script
  const dataInicioStr = (periodo && periodo.dataInicio)
    ? periodo.dataInicio.toISOString()
    : "";
  const dataFimStr = (periodo && periodo.dataFim)
    ? periodo.dataFim.toISOString()
    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, { topN: 1, forGroup: !!grupoNome });
    })
    .withFailureHandler(function () {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha. Tente novamente em alguns instantes.</p>"
      );
    })
    // üëá agora tamb√©m envia o tipo ("quantidade" ou "valor")
    .getResumoTransacoesPorGrupo(grupoNome, dataInicioStr, dataFimStr, tipo);

  // resposta vem ass√≠ncrona (via renderBotMessage no callback), ent√£o aqui n√£o devolve nada
  return null;
}

  // üÜï LOJAS ESPEC√çFICAS (ex.: "lojas XXXX e XXXX no per√≠odo ...")
  const detLojasEspec = detectarLojasEspecificasLista(msgUsuario, norm);
  if (detLojasEspec && detLojasEspec.codigosLojas.length > 0) {
    const p     = detLojasEspec.periodo;
    const tipo  = detLojasEspec.tipo || "valor";
    const lojas = detLojasEspec.codigosLojas;

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma tabela apenas com as <b>lojas " + lojas.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarLojasCodigos: lojas
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados para essas lojas espec√≠ficas.</p>"
        );
      })
      // grupo vazio => todas as lojas; vamos filtrar no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }

  // üÜï TODAS AS LOJAS NO PER√çODO (sem time)
  if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasPeriodo = detectarListarTodasLojasGeral(msgUsuario, norm);
  if (detTodasLojasPeriodo) {
    const periodo = detTodasLojasPeriodo.periodo;
    const tipo    = detTodasLojasPeriodo.tipo || "valor";

    const dataInicioStr = (periodo && periodo.dataInicio)
      ? periodo.dataInicio.toISOString()
      : "";
    const dataFimStr = (periodo && periodo.dataFim)
      ? periodo.dataFim.toISOString()
      : "";

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma <b>rela√ß√£o de todas as lojas</b> com gastos " +
        (periodo ? "no per√≠odo solicitado" : "no per√≠odo completo dispon√≠vel") +
        ", mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => listar TODAS as lojas
        renderResumoTransacoesSemana(res, { topN: null, forGroup: false });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha para listar todas as lojas.</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        "",              // sem time (todas as lojas)
        dataInicioStr,
        dataFimStr,
        tipo             // "valor" (padr√£o) ou "quantidade"
      );

      // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    // resposta vem via callback, ent√£o encerra aqui
    return null;
  }}

//üÜï TODAS AS LOJAS DE V√ÅRIOS TIMES
  const detLojasTimesMulti = detectarTodasLojasDosTimes(msgUsuario, norm);
  if (detLojasTimesMulti && detLojasTimesMulti.times.length > 0) {
    const listaTimes = detLojasTimesMulti.times;
    const p          = detLojasTimesMulti.periodo;
    const tipo       = detLojasTimesMulti.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

        // üÜï guarda per√≠odo e grupo para os bot√µes de pend√™ncia/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todas as lojas</b> dos times <b>" + listaTimes.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transa√ß√µes</b>" +
        (p ? " no per√≠odo solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar os dados das lojas desses times.</p>"
        );
      })
      // grupo vazio => todas as lojas; filtro por time ser√° feito no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }



// <<< FIM DO BLOCO NOVO


        // 1) Termo de responsabilidade
        if (frasesTermo.some(f => norm.includes(f))) {
            return respTermoResponsabilidade();
        }

        // 2) Sauda√ß√µes
        for (const saud of saudacoes) {
            if (norm === saud || norm.startsWith(saud + " ") || norm.includes(" " + saud + " ")) {
                const respostasSaudacao = [
                    "Ol√°! üòÑ",
                    "Oi! üëã",
                    "Opa, tudo bem por a√≠? üòé",
                    "Fala a√≠! üëã",
                    "E a√≠, tudo certo? üôå",
                    "Bom te ver por aqui! üòÅ"
                ];
                const complementosAjuda = [
                    "Como posso te ajudar hoje?",
                    "Quer saber algo sobre o cart√£o Clara?",
                    "O que voc√™ quer saber?",
                    "Posso te explicar algo sobre o uso dos cart√µes?",
                    "Quer que eu te ajude com alguma d√∫vida?",
                    "Como posso te orientar?",
                    "Qual a sua d√∫vida?"
                ];
                const r1 = respostasSaudacao[Math.floor(Math.random() * respostasSaudacao.length)];
                const r2 = complementosAjuda[Math.floor(Math.random() * complementosAjuda.length)];
                return `HTML:<p class="text-sm text-slate-700">${r1} ${r2}</p>`;
            }
        }

        // 3) Encerramento / agradecimento
        for (const frase of frasesEncerramento) {
            if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
                const respostasEncerramento = [
                    "Que bom que consegui ajudar! ü§ó Pode me chamar sempre que precisar.",
                    "Show! Fico feliz em ajudar üòÑ",
                    "Perfeito üëå qualquer d√∫vida, √© s√≥ chamar de novo!",
                    "Valeu! At√© a pr√≥xima üöÄ",
                    "Beleza üòé t√¥ por aqui se precisar de novo.",
                    "Feito! Agora vou tirar um cochilo de 5 segundos. Me chama de novo, t√°?", 
                    "Resolvido! Fui nessa, mas t√¥ s√≥ a um clique de dist√¢ncia, viu?", 
                    "Show de bola! Se quebrar o meu sistema, n√£o fui eu, foi a formata√ß√£o anterior! üòâ", 
                    "Acabou o recreio! Brincadeiras √† parte, qualquer coisa, √© s√≥ dar um 'tapa' no chat.", 
                    "Tudo pronto. Vou ali beber uma √°gua e j√° volto. Se precisar, s√≥ assobiar!", 
                    "√â isso! Miss√£o dada √© (finalmente) miss√£o cumprida. Fui! üëã", 
                    "Perfeito! Agora vai l√° dominar o mundo (ou s√≥ terminar seu caf√© mesmo).", 
                    "Ufa! Deu tudo certo. Deixa um biscoito pra mim na pr√≥xima vez, valeu?", 
                    "Despedida de campe√£o! Se a d√∫vida voltar, √© porque sentiu minha falta. Pode chamar!", 
                    "Zerou! At√© o pr√≥ximo 'bug' ou a pr√≥xima ideia genial. üöÄ", 
                    "A gente se fala! N√£o faz besteira enquanto eu estiver fora, hein?", 
                    "OK, estou me desligando (s√≥ um pouquinho). Te vejo na pr√≥xima aventura!", 
                    "Quebrando a internet em 3, 2, 1... Brincadeira! Tchau, tchau!", 
                    "Terminamos com chave de ouro e um 'high five' virtual! ‚úã", 
                    "Resolvi essa parada! Agora, vai curtir a vida. Me chama se tiver t√©dio.", 
                    "Fechou o caix√£o! Quer dizer... fechou o chat. üòâ At√© a pr√≥xima!", 
                    "T√° tranquilo, t√° favor√°vel. Qualquer deslize tecnol√≥gico, me avisa!", 
                    "Deu bom! Vou mandar um emoji de comemora√ß√£o aqui: üéâ. Fui!", 
                    "Desaparecendo em 5 segundos. Se precisar de m√°gica, j√° sabe quem chamar.", 
                    "Essa foi r√°pida, hein? Valeu pela companhia. Tamo junto!", 
                    "Encerrando as atividades por hoje. Beijos de luz (e de c√≥digo)! ‚ú®", 
                    "Olha eu indo! Se sobrar um tempinho, manda um meme pra mim. Fui!", 
                    "Sou seu, mas n√£o sou seu (s√≥ at√© voc√™ precisar de mim de novo). Tchau!", 
                    "Gostei da conversa. Se tiver mais perguntas loucas, sou todo ouvidos!", 
                    "Miss√£o conclu√≠da. Agora, a pr√≥xima rodada √© por sua conta! (Brincadeira!).", 
                    "Finalizamos! Mando um abra√ßo de bytes e um at√© breve.", 
                    "Tudo nos conformes. Pode sair correndo e contar a novidade! üòâ", 
                    "Pronto para a aposentadoria (de 5 minutos). Bora na pr√≥xima!", 
                    "E o Oscar de melhor encerramento vai para... mim! Tchau! üòÇ"
                ];
                const r = respostasEncerramento[Math.floor(Math.random() * respostasEncerramento.length)];
                return `HTML:<p class="text-sm text-slate-700">${r}</p>`;
            }
        }

        // 4) Pol√≠tica (PDF oficial)
        if (frasesPolitica.some(f => norm.includes(f))) {
            return respPoliticaOficial();
        }


              // 5) Fluxo pend√™ncias - aguardando c√≥digo da loja
        if (estadoPendencias === "aguardando_loja") {
    const textoOriginal = msgUsuario.trim();
    const soDigitos = textoOriginal.replace(/\D/g, "");

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // usu√°rio mudou de assunto
    if (mudouDeAssunto && !soDigitos) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        origemPendenciasBloqueio = false;
        return `HTML:<div class="text-sm text-slate-700">
        <p>Beleza üëç Vamos mudar de assunto ent√£o.</p>
        <p class="mt-1">Se quiser ver as pend√™ncias da loja depois, √© s√≥ dizer: <b>"consultar pend√™ncias Clara"</b>.</p>
        </div>`;
    }

    // usu√°rio digitou um c√≥digo de loja
    if (soDigitos && soDigitos.length >= 2 && soDigitos.length <= 4) {
        lojaPendenciasAtual = soDigitos;

        // üîπ CASO ESPECIAL: fluxo veio do bloqueio de cart√£o
        if (origemPendenciasBloqueio) {
            origemPendenciasBloqueio = false; // consumiu a flag

            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
                Beleza! Vou consultar as √∫ltimas pend√™ncias relacionadas ao cart√£o da loja <b>${soDigitos}</b>, que podem ter ocasionado o bloqueio. ‚è≥
                </p>`
            );

            consultarPendenciasBloqueio(soDigitos);
            return null;
        }

        // üîπ CASO NORMAL: fluxo padr√£o de pend√™ncias Clara
        estadoPendencias = "nenhum";

        // üÜï busca nome da loja no servidor antes de mostrar a mensagem
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}${nomeLojaTxt}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );

            consultarPendenciasNoServidor(soDigitos);
          })
          .withFailureHandler((err) => {
            // fallback se der erro na consulta do nome
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}</b> e j√° te mostro aqui no chat. ‚è≥
              </p>`
            );
            consultarPendenciasNoServidor(soDigitos);
          })
          .obterNomeLojaBigQuery(soDigitos);

        return null;
    }

    // se chegou aqui, n√£o mudou de assunto e n√£o mandou c√≥digo de loja v√°lido
    return `HTML:<p class="text-sm text-slate-700">
        Pra eu consultar as pend√™ncias, preciso do c√≥digo num√©rico da loja (ex.: <b>0999</b>).<br/>
        Se quiser tratar de outro assunto, √© s√≥ me perguntar diretamente. üòâ
        </p>`;
}

        // 6) Fluxo pend√™ncias - aguardando confirma√ß√£o de envio por e-mail
if (estadoPendencias === "aguardando_confirmacao_email") {
    const ehSim = (
        norm === "sim" ||
        norm.startsWith("sim ") ||
        norm.includes(" sim") ||
        norm.includes("pode enviar") ||
        norm.includes("pode mandar") ||
        norm.includes("manda") ||
        norm.includes("envia") ||
        norm.includes("pode sim")
    );

    const ehNao = (
        norm === "nao" || norm === "n√£o" ||
        norm.startsWith("nao ") || norm.startsWith("n√£o ") ||
        norm.includes("nao precisa") || norm.includes("n√£o precisa") ||
        norm.includes("sem email") || norm.includes("sem e-mail") ||
        norm.includes("nao manda") || norm.includes("n√£o manda")
    );

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // Usu√°rio mudou de assunto no meio
    if (!ehSim && !ehNao && mudouDeAssunto) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<div class="text-sm text-slate-700">
<p>Tranquilo, vamos falar de outro assunto ent√£o. üòâ</p>
<p class="mt-1">Se depois voc√™ quiser receber o resumo por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
    }

    // Usu√°rio disse que N√ÉO quer e-mail
    if (ehNao) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<p class="text-sm text-slate-700">
Fechado, n√£o vou enviar por e-mail. Se quiser depois, √© s√≥ pedir de novo. üëç
</p>`;
    }

    // Usu√°rio disse que SIM quer e-mail
    if (ehSim) {
        const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
        const emailSessao = (USER_EMAIL_REPLACED || "").trim();

        if (!loja) {
            // Por seguran√ßa: se por algum motivo a loja sumiu da mem√≥ria
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";
            return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
        }

        // ‚úÖ Se temos e-mail do usu√°rio logado, j√° envia direto
        if (emailSessao) {
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";

            // avisa no chat
            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${emailSessao}</b>.
</p>`
            );

            // chama o Apps Script pra mandar o e-mail
            chamarEnvioPendenciasPorEmail(loja, emailSessao);

            // j√° usamos renderBotMessage, ent√£o aqui n√£o precisa retornar outro texto
            return null;
        }

        // ‚ùå Se N√ÉO temos e-mail na sess√£o, volta para o fluxo antigo (pede e-mail)
        estadoPendencias = "aguardando_email";
        return `HTML:<p class="text-sm text-slate-700">
Perfeito! Me informa o seu e-mail corporativo (ex.: <b>nome.sobrenome@xxxxx.com.br</b>) para eu enviar o resumo.
</p>`;
    }

    // Se n√£o entendeu nem sim nem n√£o
    return `HTML:<p class="text-sm text-slate-700">
S√≥ pra eu entender: voc√™ quer que eu envie por e-mail tamb√©m?<br/>
Responda apenas <b>"sim"</b> ou <b>"n√£o"</b>. üôÇ
</p>`;
}

        // 7) Fluxo pend√™ncias - aguardando e-mail
        if (estadoPendencias === "aguardando_email") {
            const textoOriginal = msgUsuario.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailRegex.test(textoOriginal)) {
                const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
                if (!loja) {
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
                }

                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${textoOriginal}</b>.
</p>`
                );
                chamarEnvioPendenciasPorEmail(loja, textoOriginal);
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return null;
            }

            const pareceOutroAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (pareceOutroAssunto) {
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return `HTML:<div class="text-sm text-slate-700">
<p>Beleza, vamos mudar de assunto ent√£o üòâ</p>
<p class="mt-1">Se depois voc√™ quiser voltar a ver as pend√™ncias da loja ou receber por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
            }

            return `HTML:<p class="text-sm text-slate-700">
Esse e-mail parece inv√°lido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.<br/><br/>
Se preferir mudar de assunto, pode me perguntar outra coisa diretamente (ex.: "sangria", "novo cart√£o", "limite", "etiqueta", etc.).
</p>`;
        }

        // 8) Fluxo novo cart√£o ‚Äì aguardando se √© 1¬™ ou 2¬™ via
        if (fluxoNovoCartao === "aguardando_tipo_via") {
            const ehPrimeira = (
                norm.includes("primeira via") ||
                norm.includes("1 via") ||
                norm.includes("1a via") ||
                norm.includes("1¬™ via") ||
                norm.includes("primeiro cartao") ||
                norm.includes("primeiro cart√£o") ||
                norm.includes("cartao novo") ||
                norm.includes("cart√£o novo") ||
                norm.includes("meu primeiro cartao") ||
                norm.includes("meu primeiro cart√£o") ||
                norm.includes("nunca tive cartao") ||
                norm.includes("nunca tive cart√£o") ||
                norm.includes("nao tenho cartao") ||
                norm.includes("n√£o tenho cart√£o")
            );

            const ehSegunda = (
                norm.includes("segunda via") ||
                norm.includes("2 via") ||
                norm.includes("2a via") ||
                norm.includes("2¬™ via") ||
                norm.includes("segundo cartao") ||
                norm.includes("segundo cart√£o") ||
                norm.includes("perdi o cartao") ||
                norm.includes("perdi meu cartao") ||
                norm.includes("perdi o cart√£o") ||
                norm.includes("roubaram meu cartao") ||
                norm.includes("roubaram meu cart√£o") ||
                norm.includes("roubo de cart√£o") ||
                norm.includes("perda de cart√£o") ||
                norm.includes("perca de cart√£o") ||
                norm.includes("cartao quebrado") ||
                norm.includes("cart√£o quebrado") ||
                norm.includes("cartao danificado") ||
                norm.includes("cart√£o danificado")
            );

            const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (!ehPrimeira && !ehSegunda && mudouDeAssunto) {
                fluxoNovoCartao = null;
                return `HTML:<p class="text-sm text-slate-700">
Sem problemas, vamos falar de outro assunto ent√£o. üòâ
</p>`;
            }

            if (ehPrimeira) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_primeira";
                return respNovoCartaoPrimeiraVia();
            }

            if (ehSegunda) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_segunda";
                return respNovoCartaoSegundaVia();
            }

            return `HTML:<p class="text-sm text-slate-700">
            N√£o entendi se voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido).<br/><br/>
            Me responde assim, por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }


        // 10) Gatilhos direto ‚Äì primeira via
        if (termosPrimeiraViaDireta.some(t => norm.includes(t))) {
            fluxoNovoCartao = null;
            return respNovoCartaoPrimeiraVia();
        }

        // 11) Gatilhos direto ‚Äì segunda via
        if (gatilhosSegundaViaDireta.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = null;
            return respNovoCartaoSegundaVia();
        }

        // 12) Gatilho ‚Äì quero pedir um cart√£o (abre fluxo pra perguntar primeira/segunda via)
        if (gatilhosNovoCartao.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = "aguardando_tipo_via";
            return `HTML:<p class="text-sm text-slate-700">
            S√≥ pra eu te orientar certinho: voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido)?<br/><br/>
            Responda por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }

        // 13) Demais casos -> motor da pol√≠tica
        return gerarRespostaPolitica(msgUsuario);
    }

    // ========= INTERVALOS DE DATA PARA PERGUNTAS DE RELAT√ìRIO ========= //

   function extrairIntervaloDatas(msgOriginal) {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const meses = {
        janeiro: 0, fevereiro: 1, marco: 2, mar√ßo: 2, abril: 3, maio: 4, junho: 5,
        julho: 6, agosto: 7, setembro: 8, outubro: 9, novembro: 10, dezembro: 11
    };

    // const norm = (msgOriginal || "").toLowerCase();
    const norm = normalize(msgOriginal || "");
    let m; // <<< ADICIONE ESTA LINHA AQUI

    // 0) Hoje / Ontem
    if (norm.includes("ontem")) {
        const d = new Date(hoje);
        d.setDate(hoje.getDate() - 1);
        return { tipo: "ontem", dataInicio: d, dataFim: d };
    }
    if (norm.includes("hoje")) {
        const d = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        return { tipo: "hoje", dataInicio: d, dataFim: d };
    }

    // 0b-a) Esta semana / nessa semana / nesta semana
    if (
        norm.includes("essa semana") ||
        norm.includes("nesta semana") ||
        norm.includes("nessa semana")
    ) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);

        // volta at√© segunda-feira da semana atual
        const diaSemana = fim.getDay();       // 0=Dom, 1=Seg, ..., 6=Sab
        const diff = (diaSemana === 0 ? 6 : diaSemana - 1); // volta at√© segunda

        ini.setDate(fim.getDate() - diff);

        return { tipo: "semana_atual", dataInicio: ini, dataFim: fim };
    }

    // 0b) √öltima semana
    if (norm.includes("ultima semana") || norm.includes("√∫ltima semana")) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);
        ini.setDate(hoje.getDate() - 7);
        return { tipo: "ultima_semana", dataInicio: ini, dataFim: fim };
    }

    // 0c) √öltimo m√™s  (sin√¥nimo de "m√™s passado")
    if (norm.includes("ultimo mes") || norm.includes("√∫ltimo mes") || norm.includes("√∫ltimo m√™s")) {
        let mes = hoje.getMonth() - 1;
        let ano = anoAtual;
        if (mes < 0) {
            mes += 12;
            ano = anoAtual - 1;
        }
        const ini = new Date(ano, mes, 1);
        const fim = new Date(ano, mes + 1, 0);
        return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
    }

    // "√∫ltimo trimestre" / "trimestre passado"
if (norm.includes("ultimo trimestre") || norm.includes("trimestre passado")) {
  const mesAtual = hoje.getMonth();         // 0..11
  const trimestreAtual = Math.floor(mesAtual / 3); // 0..3
  let ano = anoAtual;
  let trimestreAnterior = trimestreAtual - 1;
  if (trimestreAnterior < 0) {
    trimestreAnterior = 3;
    ano = anoAtual - 1;
  }
  const inicioMes = trimestreAnterior * 3; // 0,3,6,9
  const ini = new Date(ano, inicioMes, 1);
  const fim = new Date(ano, inicioMes + 3, 0); // √∫ltimo dia do trimestre
  return { tipo: "trimestre_passado", dataInicio: ini, dataFim: fim };
}

// "neste trimestre" / "este trimestre"
if (norm.includes("neste trimestre") || norm.includes("este trimestre")) {
  const mesAtual = hoje.getMonth();
  const trimestreAtual = Math.floor(mesAtual / 3);
  const inicioMes = trimestreAtual * 3;
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "trimestre_atual", dataInicio: ini, dataFim: fim };
}

// 0) Intervalo num√©rico: aceita com/sem "de" e com/sem ano
// Ex.: "de 01/11/2025 a 15/11/2025", "01/11/2025 a 15/11/2025",
//      "de 01/11 a 15/11", "01/11 a 15/11"
m = norm.match(/(?:de\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?\s+a\s+(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
if (m) {
    const d1 = Number(m[1]);
    const m1 = Number(m[2]) - 1;
    const y1 = m[3] ? Number(m[3]) : anoAtual;

    const d2 = Number(m[4]);
    const m2 = Number(m[5]) - 1;
    const y2 = m[6] ? Number(m[6]) : anoAtual;

    const ini = new Date(y1, m1, d1);
    const fim = new Date(y2, m2, d2, 23, 59, 59);

    return { tipo: "intervalo_numerico", dataInicio: ini, dataFim: fim };
}

    // 0d) Esse m√™s / neste m√™s
    if (
        norm.includes("esse mes") || 
        norm.includes("esse m√™s") ||
        norm.includes("neste mes") || 
        norm.includes("neste m√™s") ||
        norm.includes("nesse m√™s") ||
        norm.includes("nesse mes") ||
        norm.includes("este mes") || 
        norm.includes("este m√™s")
    ) {
        const ini = new Date(anoAtual, hoje.getMonth(), 1);
        const fim = hoje;
        return { tipo: "mes_atual", dataInicio: ini, dataFim: fim };
    }

    // 1) De tal dia a tal dia (ex.: "de 5 a 12 de novembro")
    m = norm.match(/de\s+(\d{1,2})\s+a\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
        const diaIni = Number(m[1]);
        const diaFim = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, diaIni);
            const fim = new Date(anoAtual, mes, diaFim);
            return { tipo: "intervalo", dataInicio: ini, dataFim: fim };
        }
    }

    // 2b) "entre 1 e 15 de novembro"
    m = norm.match(/entre\s+(\d{1,2})\s+e\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
      const dia1 = Number(m[1]);
      const dia2 = Number(m[2]);

      const mesStr = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const mes = meses[mesStr];
      if (mes !== undefined) {
        const ano = anoAtual;
        const ini = new Date(ano, mes, dia1);
        const fim = new Date(ano, mes, dia2, 23, 59, 59);
        return { tipo: "intervalo_mes_texto", dataInicio: ini, dataFim: fim };
      }
    }


      // 2) Dia espec√≠fico num√©rico
    // Aceita: "no dia 10/11/2025", "dia 10/11", "10/11/2025", "10/11"
    m = norm.match(/(?:no\s+dia\s+|dia\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
    if (m) {
        const dia = Number(m[1]);
        const mes = Number(m[2]) - 1;
        const ano = m[3] ? Number(m[3]) : anoAtual;
        const d = new Date(ano, mes, dia);

        return { tipo: "dia", dataInicio: d, dataFim: d };
    }

    // 2b) "em 5 de outubro"
    m = norm.match(/(em|no)\s+(\d{1,2})\s+de\s+([a-z√ß]+)/);
    if (m) {
        const dia = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const d = new Date(anoAtual, mes, dia);
            return { tipo: "dia", dataInicio: d, dataFim: d };
        }
    }

    // 3a) "no m√™s de setembro"
    m = norm.match(/(em|no)\s+mes\s+de\s+([a-z√ß]+)/);
    if (m) {
        const chaveMes2 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes2)
            ? meses[chaveMes2]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 3b) "em outubro"
    m = norm.match(/(em|no)\s+([a-z√ß]+)/);
    if (m) {
        const chaveMes3 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (Object.prototype.hasOwnProperty.call(meses, chaveMes3)) {
            const mes = meses[chaveMes3];
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 4) "m√™s passado"
if (norm.includes("mes passado")) {   // depois do normalize, "m√™s" j√° virou "mes"
    let mes = hoje.getMonth() - 1;
    let ano = anoAtual;
    if (mes < 0) {
        mes += 12;
        ano = anoAtual - 1;
    }
    const ini = new Date(ano, mes, 1);
    const fim = new Date(ano, mes + 1, 0);
    return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
}

// 5) "√∫ltimos X meses"
m = norm.match(/ultimos?\s+(\d{1,2})\s+mes(es)?/);
if (m) {
    const qtdMeses = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setMonth(hoje.getMonth() - qtdMeses);
    return { tipo: "ultimos_meses", dataInicio: ini, dataFim: fim };
}

// 6) "√∫ltimos 15 dias", etc.
m = norm.match(/ultimos?\s+(\d{1,3})\s+dias?/);
if (m) {
    const qtd = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setDate(hoje.getDate() - qtd);
    return { tipo: "ultimos_dias", dataInicio: ini, dataFim: fim };
}

  // 7) "2 ultimas semanas" ou "ultimas 2 semanas"
m = norm.match(/(\d{1,2})\s+ultimas?\s+semanas?/);
if (!m) {
  m = norm.match(/ultimas?\s+(\d{1,2})\s+semanas?/);
}
if (m) {
  const qtdSemanas = Number(m[1]);
  const dias = qtdSemanas * 7;
  const fim = hoje;
  const ini = new Date(hoje);
  ini.setDate(hoje.getDate() - dias);
  return { tipo: "ultimas_semanas", dataInicio: ini, dataFim: fim };
}

    return null;
}

// ===== Cache de per√≠odo para drill-down: "mesmo per√≠odo da pergunta anterior" =====
(function () {
  // Guarda refer√™ncia da fun√ß√£o original
  const _extrairOriginal = extrairIntervaloDatas;

  // Cache global do √∫ltimo per√≠odo entendido
  window.__vektorUltimoPeriodo = null;

  // Sobrescreve a fun√ß√£o usada no restante do c√≥digo
  extrairIntervaloDatas = function (msgOriginal) {
    try {
      // 1) Se a mensagem falar "mesmo per√≠odo da pergunta anterior"
      //    e j√° tivermos um per√≠odo salvo, devolve direto o cache
      if (msgOriginal && typeof msgOriginal === "string") {
        const norm = normalize(msgOriginal);
        if (
          norm.includes("mesmo periodo da pergunta anterior") &&
          window.__vektorUltimoPeriodo &&
          window.__vektorUltimoPeriodo.dataInicio &&
          window.__vektorUltimoPeriodo.dataFim
        ) {
          return window.__vektorUltimoPeriodo;
        }
      }

      // 2) Caso contr√°rio, usa a fun√ß√£o original
      const periodo = _extrairOriginal(msgOriginal);

      // 3) Se a fun√ß√£o original achou um per√≠odo, salva no cache global
      if (periodo && periodo.dataInicio && periodo.dataFim) {
        window.__vektorUltimoPeriodo = periodo;
      }

      return periodo;
    } catch (e) {
      console.error("Erro no wrapper de extrairIntervaloDatas:", e);
      // fallback: chama fun√ß√£o original
      return _extrairOriginal(msgOriginal);
    }
  };
})();

// ========= RESUMO LOJA x TIME (GR√ÅFICO) ========= //

    function renderResumoTransacoesSemana(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar informa√ß√µes de transa√ß√µes para esse filtro. Verifique se o time e o per√≠odo est√£o corretos.</p>"
    );
    return;
  }

  opts = opts || {};

  var criterioTxt = (resumo.tipo === "valor"
  ? "maior <b>valor</b> de transa√ß√µes"
  : "maior <b>n√∫mero</b> de transa√ß√µes");

var grupoHtml = resumo.grupoNome
  ? " no time <b>" + resumo.grupoNome + "</b>"
  : "";

// üÜï verifica se veio filtro de lojas ou de times
var temFiltroLojas = opts && Array.isArray(opts.filtrarLojasCodigos) && opts.filtrarLojasCodigos.length > 0;
var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

var fraseResumo;
if (temFiltroLojas) {
  // Quando o usu√°rio pediu algo tipo "lojas 316 e 39 neste m√™s"
  fraseResumo = "Comparando as lojas <b>" +
    opts.filtrarLojasCodigos.join(", ") +
    "</b> no per√≠odo selecionado" + grupoHtml + ".";
} else if (temFiltroTimes) {
  // Quando o usu√°rio pediu algo tipo "todas as lojas dos times Falc√µes e Lobos"
  fraseResumo = "Mostrando lojas dos times <b>" +
    opts.filtrarTimesNomes.join(", ") +
    "</b> no per√≠odo selecionado" + grupoHtml + ".";
} else {
  // Comportamento antigo padr√£o (sem filtro espec√≠fico)
  fraseResumo = resumo.top
    ? "A loja <b>" + resumo.top.loja + "</b> foi a que teve " + criterioTxt + " no per√≠odo selecionado" + grupoHtml + "."
    : "N√£o encontrei transa√ß√µes" + grupoHtml + " no per√≠odo selecionado.";
}

  // Quantas linhas exibir
var all = Array.isArray(resumo.lojas) ? resumo.lojas : [];

// üÜï aplica filtros de LOJAS e TIMES antes de cortar por topN
if (temFiltroLojas) {
  var codSet = {};
  opts.filtrarLojasCodigos.forEach(function (c) {
    var key = String(c).replace(/\D/g, "");
    codSet[key] = true;
  });

  all = all.filter(function (linha) {
    var codLinha = String(
      linha.loja || linha.Loja || linha.codigoLoja || linha.CodigoLoja || ""
    ).replace(/\D/g, "");
    return codSet[codLinha];
  });
}

if (temFiltroTimes) {
  var timesSet = {};
  opts.filtrarTimesNomes.forEach(function (nome) {
    timesSet[String(nome).toLowerCase()] = true;
  });

  all = all.filter(function (linha) {
    var g = String(linha.grupo || linha.Grupo || "").toLowerCase();
    return !!timesSet[g];
  });
}

  var linhas;

  var linhas;

  if (opts && (opts.topN === null)) {
    // Pedido expl√≠cito para listar TODAS as linhas
    // Ex.: quando a l√≥gica do front diz: "topN: null" = sem limite
    linhas = all;

  } else if (typeof opts.topN === "number") {
    // Quando veio um TOP N (1, 3, 5, 7, etc.)
    // Aqui SEMPRE respeitamos o N, mesmo se tiver time (forGroup = true)
    linhas = all.slice(0, Math.max(0, opts.topN));

  } else if (opts && opts.forGroup) {
    // Sem topN informado + filtrando por time
    // => lista TODAS as lojas do(s) time(s)
    linhas = all;

  } else {
    // Ranking geral sem topN definido
    // Se quiser, pode limitar a 10 aqui (ou deixar todas)
    // Hoje, segue a mesma l√≥gica antiga (todas):
    linhas = all;
  }

    // üÜï guarda lista de lojas exibidas na √∫ltima tabela
  try {
    window.__vektorUltimasLojasTabela = (linhas || []).map(function (l) {
      return (l.loja || "").toString().trim();
    }).filter(Boolean);
  } catch (e) {
    console.warn("Falha ao registrar lista de lojas da tabela:", e);
  }


  // Somat√≥rios com base no que ser√° exibido
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  var linhasTabela = [];
  if (linhas.length) {

    // üîΩ Dropdown de drilldown para a tabela de LOJAS
        linhasTabela.push(
          "<div style='font-size:11px;margin-bottom:4px;color:#334155'>" +
            "Expandir a tabela por: " +
            "<select class='vektor-drill-select' data-base='loja' " +
                   "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
              "<option value='estabelecimento'>Estabelecimentos</option>" +
              "<option value='categoria'>Categorias</option>" +
            "</select>" +
          "</div>"
        );  

    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Loja</th>" +
        "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    for (var j = 0; j < linhas.length; j++) {
      var l = linhas[j];
      var qtd = Number(l.total) || 0;
      var val = Number(l.valorTotal) || 0;
      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

      var hint = "Clique para detalhar pelo filtro escolhido " + l.loja;

      linhasTabela.push(
    "<tr onclick=\"vektorExpandirLinha(this,'loja')\" " +
      "style='cursor:pointer;' " +
      "title=\"" + hint + "\">" +
      "<td style='border:1px solid #000;'>" + l.loja + "</td>" +
      "<td style='border:1px solid #000;'>" + qtd + "</td>" +
      "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
      "<td style='border:1px solid #000;'>" +
        val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
    "</tr>"
  );

    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }
  var tabelaHtml = linhasTabela.join("");

    // üîΩ Bot√µes abaixo da tabela (CSV + Pend√™ncias + Justificativas)
  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +

        // Exportar CSV (igual antes, sem tooltip personalizado)
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_lojas')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +

        // üÜï Verificar pend√™ncias (com tooltip vermelho opaco)
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarPendenciasLojas(this)\" " +
            "style='background:#B91C1C;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "‚ö† Verificar pend√™ncias" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(185,28,28,0.92);'>" +
            "Lista todas as pend√™ncias das lojas dessa tabela no per√≠odo informado" +
          "</span>" +
        "</span>" +

        // üÜï Verificar justificativas (com tooltip azul opaco)
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarJustificativasLojas(this)\" " +
            "style='background:#0F172A;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "‚úî Verificar justificativas" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(15,23,42,0.92);'>" +
            "Lista todas as transa√ß√µes com justificativas feitas de forma correta" +
          "</span>" +
        "</span>" +

      "</div>";
  }

var lookerUrl = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";
var html = [
  "<div class='text-sm text-slate-700'>",
    "<p>", fraseResumo, "</p>",
    tabelaHtml,
    botoesHtml,
  "</div>"
].join("");

renderBotMessage("HTML:" + html);
}

// ========= Bot√µes "Verificar pend√™ncias / justificativas" (tabelas de LOJAS) ========= //

function vektorMontarTabelaPendJust_(titulo, colunas, linhas) {
    // Se n√£o vier nenhuma linha, mostra mensagem
    if (!linhas || !linhas.length) {
        return "<p class='text-sm text-slate-700'>N√£o encontrei registros para " +
               (titulo || "").toLowerCase() + " nesse per√≠odo/sele√ß√£o.</p>";
    }

    // Identifica se √© tabela de pend√™ncias ou de justificativas pelo t√≠tulo
    var lowerTitulo  = (titulo || "").toLowerCase();
    var isPendencias = lowerTitulo.indexOf("pend") >= 0;

    // Cores
    var headerColor   = isPendencias ? "#B91C1C" : "#0F172A"; // vermelho / azul escuro
    var botaoCsvColor = "#005E27";                            // verde padr√£o Vektor

    // Cabe√ßalhos que SER√ÉO exibidos
    var colunasVisiveis;
    if (isPendencias) {
        // PEND√äNCIAS: Loja | Data | Valor | Pend√™ncias (coluna √∫nica)
        colunasVisiveis = [
            "Loja",
            "Data da Transa√ß√£o",
            "Valor (R$)",
            "Pend√™ncias"
        ];
    } else {
        // JUSTIFICATIVAS: formato original com 3 colunas separadas
        // Loja | Data | Valor | Etiqueta | Descri√ß√£o | Recibo
        colunasVisiveis = [
            "Loja",
            "Data da Transa√ß√£o",
            "Valor (R$)",
            "Etiqueta",
            "Descri√ß√£o",
            "Recibo"
        ];
    }

    var partes = [];

    // Container + tabela
    partes.push(
      "<div class='text-sm text-slate-700' style='max-width:1000px;margin:auto;'>",
        "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>", titulo, "</p>",
        "<div style='overflow-x:auto;'>",
          "<table border='1' cellspacing='0' cellpadding='8' " +
          "style='border-collapse:collapse;width:100%;font-size:13px;border:1px solid #000;'>"
    );

    // ===== Cabe√ßalho =====
    partes.push("<thead><tr style='background:" + headerColor + ";color:#fff;'>");

    colunasVisiveis.forEach(function (col) {

        // Ajuste de larguras APENAS na tabela de JUSTIFICATIVAS
        if (!isPendencias) {

            // Data da Transa√ß√£o ‚Äî largura maior
            if (col === "Data da Transa√ß√£o") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:160px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Etiqueta ‚Äî maior que Data
            if (col === "Etiqueta") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:260px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Descri√ß√£o ‚Äî maior que Etiqueta
            if (col === "Descri√ß√£o") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:300px;'>",
                  col,
                  "</th>"
                );
                return;
            }
        }

        // Default para todas as outras colunas
        partes.push(
          "<th style='border:1px solid #000;padding:6px;text-align:center;'>",
          col,
          "</th>"
        );
    });

    partes.push("</tr></thead><tbody>");

    // IMPORTANTE: backend (Code.gs) monta cada linha como:
    // [0] Loja
    // [1] Data da Transa√ß√£o
    // [2] Valor (R$)
    // [3] Etiqueta
    // [4] Descri√ß√£o
    // [5] Recibo
    linhas.forEach(function (row) {
        var loja      = row[0] != null ? String(row[0]) : "";
        var data      = row[1] != null ? String(row[1]) : "";
        var valorNum  = row[2] != null ? Number(row[2]) || 0 : 0;
        var etiqueta  = row[3] != null ? String(row[3]).trim() : "";
        var descricao = row[4] != null ? String(row[4]).trim() : "";
        var reciboRaw = row[5] != null ? String(row[5]).trim() : "";

        var valorFmt = valorNum.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL"
        });

        // Normaliza recibo para ver se √© "n√£o/nao"
        var reciboNorm = reciboRaw
            ? reciboRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase()
            : "";

        partes.push("<tr>");

        // Loja
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          loja,
          "</td>"
        );

        // Data
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          data,
          "</td>"
        );

        // Valor
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          valorFmt,
          "</td>"
        );

        if (isPendencias) {
            // üî¥ TABELA DE PEND√äNCIAS: coluna √∫nica ‚ÄúPend√™ncias‚Äù

            var pendencias = [];
            if (!etiqueta)  pendencias.push("Etiqueta");
            if (!descricao) pendencias.push("Descri√ß√£o");
            if (reciboNorm === "nao" || reciboNorm === "n√£o") {
                pendencias.push("Nota fiscal/Recibo");
            }

            var pendTexto = pendencias.length ? pendencias.join(", ") : "";

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              pendTexto,
              "</td>"
            );

        } else {
            // üîµ TABELA DE JUSTIFICATIVAS: colunas separadas

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              etiqueta,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              descricao,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              reciboRaw,
              "</td>"
            );
        }

        partes.push("</tr>");
    });

    partes.push("</tbody></table></div>");

    // Bot√£o CSV (igual ao resto do sistema)
    var nomeArquivo = isPendencias ? "pendencias_lojas" : "justificativas_lojas";

    partes.push(
      "<div style='margin-top:10px;text-align:right;'>",
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, '" + nomeArquivo + "')\" " +
          "style='background:" + botaoCsvColor + ";color:#fff;border:none;padding:8px 12px;" +
                 "border-radius:4px;font-size:12px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>",
      "</div>"
    );

    partes.push("</div>");

    return partes.join("");
}

function vektorMontarTabelaFaturas_(titulo, faturas) {
  if (!faturas || !faturas.length) {
    return "<p class='text-sm text-slate-700'>N√£o encontrei faturas na BaseClara.</p>";
  }

  var partes = [];

  partes.push(
    "<div class='text-sm text-slate-700' style='max-width:1000px;margin:12px auto 0;'>",
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>",
      "<div style='overflow-x:auto;'>",
        "<table border='1' cellspacing='0' cellpadding='8' " +
        "style='border-collapse:collapse;width:100%;font-size:13px;border:2px double #000;'>",
          "<thead>",
            "<tr style='background:#0F172A;color:#fff;'>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Fatura (per√≠odo / extrato da conta)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Valor total (R$)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Varia√ß√£o</th>",
            "</tr>",
          "</thead>",
          "<tbody>"
  );

  var somaTotal = 0;
  var valorAnterior = null;

  faturas.forEach(function (f) {
    var valor = Number(f.valorTotal) || 0;
    somaTotal += valor;

    var valorFmt = valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

    // Calcula varia√ß√£o em rela√ß√£o √† fatura anterior
    var variacaoTexto = "‚Äî";
    if (valorAnterior !== null && valorAnterior !== 0) {
      var variacao = ((valor - valorAnterior) / valorAnterior) * 100;
      var variacaoFmt = variacao.toFixed(1).replace(".", ",") + "%";
      if (variacao > 0) {
        variacaoTexto = "+" + variacaoFmt;
      } else {
        variacaoTexto = variacaoFmt;
      }
    }

    var extrato = (f.extrato || "").toString();
    // evita quebrar o atributo se tiver aspas simples
    var extratoAttr = extrato.replace(/'/g, "&#39;");

    // üîΩ linha "clic√°vel" com dados da fatura
    partes.push(
      "<tr onclick=\"window.vektorDrillTimesFatura(this)\" " +
        "style='cursor:pointer;' " +
        "data-extrato-fatura='" + extratoAttr + "' " +
        "data-inicio-fatura='" + (f.dataInicioIso || "") + "' " +
        "data-fim-fatura='" + (f.dataFimIso || "") + "' " +
        "title=\"Clique para detalhar esta fatura por time, respeitando o per√≠odo desse extrato.\">",
        "<td style='border:2px double #000;padding:6px;text-align:center;'>" +
          extrato +
        "</td>",
        "<td style='border:2px double #000;padding:6px;text-align:center;'>" +
          valorFmt +
        "</td>",
        "<td style='border:2px double #000;padding:6px;text-align:center;'>" +
          variacaoTexto +
        "</td>",
      "</tr>"
    );

    valorAnterior = valor;
  });

  // Linha de TOTAL
  var somaFmt = somaTotal.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });

  partes.push(
    "<tr style='background:#f1f5f9;font-weight:bold;'>",
      "<td style='border:2px double #000;padding:6px;text-align:center;'>TOTAL</td>",
      "<td style='border:2px double #000;padding:6px;text-align:center;'>" +
        somaFmt +
      "</td>",
      "<td style='border:2px double #000;padding:6px;text-align:center;'></td>",
    "</tr>"
  );

  partes.push(
          "</tbody>",
        "</table>",
      "</div>",

      // üîΩ Bot√£o de Exportar CSV para a tabela de faturas
      "<div style='margin-top:8px;text-align:right;'>",
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'faturas_clara')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>",
          "‚¨á Exportar CSV",
        "</button>",
      "</div>",

    "</div>"
  );

  return partes.join("");
}

// Drilldown: ao clicar numa fatura, detalha por TIME
window.vektorDrillTimesFatura = function (tr) {
  try {
    if (!tr) return;

    var extrato = tr.getAttribute("data-extrato-fatura") || "";
    var dataInicioIso = tr.getAttribute("data-inicio-fatura") || "";
    var dataFimIso = tr.getAttribute("data-fim-fatura") || "";

    extrato = extrato.trim();

    if (!extrato) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>N√£o consegui identificar o extrato dessa fatura para detalhar por time.</p>"
      );
      return;
    }

    var periodoTexto = "";
    if (dataInicioIso || dataFimIso) {
      var ini = dataInicioIso ? new Date(dataInicioIso).toLocaleDateString("pt-BR") : "";
      var fim = dataFimIso ? new Date(dataFimIso).toLocaleDateString("pt-BR") : "";
      if (ini || fim) {
        periodoTexto = "Per√≠odo: " + ini + (fim ? " at√© " + fim : "");
      }
    }

    // Mensagem de contexto no chat
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a fatura <b>" + extrato +
        "</b> por <b>time</b>, considerando o mesmo ciclo do 'Extrato da conta'." +
        (periodoTexto ? "<br><span class='text-xs text-slate-500'>" + periodoTexto + "</span>" : "") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.times) || !res.times.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o encontrei transa√ß√µes por time para essa fatura.</p>"
          );
          return;
        }

        // Reaproveita o renderizador padr√£o de resumo por time
        renderResumoTransacoesPorTime(res, {
          titulo: "Times dessa fatura",
          periodoTexto: periodoTexto
        });
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao detalhar fatura por time:", err);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao buscar o detalhamento por time para essa fatura.</p>"
        );
      })
      .getResumoTransacoesPorTimeExtrato(extrato, "valor");  // usa EXTRATO
  } catch (e) {
    console.error("Erro em vektorDrillTimesFatura:", e);
  }
};


/**
 * Filtra a lista completa de faturas segundo o modo de pergunta.
 * modo: "atual" | "anterior" | "ultimas" | "todas"
 * qtd: n√∫mero de faturas (quando modo = "ultimas")
 */

function vektorFiltrarFaturasPeloModo_(todas, modo, qtd) {
    if (!Array.isArray(todas) || !todas.length) return [];

    // ---------------------------------------------------------
    // Fun√ß√£o para converter "06 Nov 2025" ‚Üí Date real
    // ---------------------------------------------------------
    function parseDataExt(dstr) {
        if (!dstr || typeof dstr !== "string") return null;
        // ex.: "06 Nov 2025"
        var m = dstr.trim().split(/\s+/);  // ["06","Nov","2025"]
        if (m.length !== 3) return null;

        var dia = Number(m[0]);
        var mes = m[1].toLowerCase();
        var ano = Number(m[2]);

        var mapaMes = {
            jan:0, feb:1, mar:2, apr:3, apr:3, mai:4, jun:5,
            jul:6, aug:7, set:8, sep:8, oct:9, out:9, nov:10, dec:11, dez:11
        };

        var mm = mapaMes[mes.substring(0,3)];
        if (mm === undefined) return null;

        return new Date(ano, mm, dia);
    }

    // ---------------------------------------------------------
    // Ordenar faturas REALMENTE por data de in√≠cio
    // ---------------------------------------------------------
    var lista = todas.slice().sort(function (a, b) {
        var da = parseDataExt(a.dataInicio);
        var db = parseDataExt(b.dataInicio);
        if (!da || !db) return 0;
        return da - db;
    });

    var agora = new Date();

    // ---------------------------------------------------------
    // Identificar fatura "atual"
    // ---------------------------------------------------------
    var idxAtual = -1;
    for (var i = 0; i < lista.length; i++) {
        var ini = parseDataExt(lista[i].dataInicio);
        var fim = parseDataExt(lista[i].dataFim);
        if (ini && fim && ini <= agora && agora <= fim) {
            idxAtual = i;
            break;
        }
    }

    // fallback
    if (idxAtual === -1) idxAtual = lista.length - 1;

    // ---------------------------------------------------------
    // Modos
    // ---------------------------------------------------------
    if (modo === "todas") {
        return lista;
    }

    if (modo === "ultimas") {
        var n = Number(qtd) || 2;
        if (n >= lista.length) return lista;
        return lista.slice(lista.length - n);
    }

    if (modo === "anterior") {
        if (idxAtual > 0) {
            return [lista[idxAtual - 1]];
        } else {
            return [lista[idxAtual]];
        }
    }

    // padr√£o ‚Üí atual
    return [lista[idxAtual]];
}


function vektorChamarPendJustLojas_(tipo) {
    var periodo  = window.__vektorUltimoPeriodoIso || {};
    var grupo    = window.__vektorUltimoGrupoBaseClara || "";
    var lojas    = window.__vektorUltimasLojasTabela || [];

    var ini = periodo.inicio || "";
    var fim = periodo.fim    || "";

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>N√£o consegui consultar as " +
            "pend√™ncias/justificativas na planilha BaseClara.</p>"
          );

          // üÜï Mesmo com erro ‚Üí troca spinner por check
          try {
            var statusId = (tipo === "pendencias")
              ? "vektor-status-pendencias"
              : "vektor-status-justificativas";

            var statusEl = document.getElementById(statusId);
            if (statusEl) {
              statusEl.innerHTML =
                "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
            }
          } catch (e) {}

          return;
        }

        var colunas = res.colunas || [];
        var html = "";

        if (tipo === "pendencias") {
          html = vektorMontarTabelaPendJust_(
            "PEND√äNCIAS DE JUSTIFICATIVAS POR LOJA",
            colunas,
            res.pendencias || []
          );
        } else {
          html = vektorMontarTabelaPendJust_(
            "TRANSA√á√ïES COM JUSTIFICATIVA COMPLETA POR LOJA",
            colunas,
            res.justificadas || []
          );
        }

        // Envia tabela
        renderBotMessage("HTML:" + html);

        // üÜï Troca spinner por check (caso de sucesso)
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
          }
        } catch (e) {}

      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as " +
          "pend√™ncias/justificativas na planilha.</p>"
        );

        // üÜï Mesmo no erro ‚Üí spinner vira check
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>‚úÖ Verifica√ß√£o conclu√≠da.</span>";
          }
        } catch (e) {}

      })
      .getPendenciasEJustificativasPorLojas(
        grupo,
        ini,
        fim,
        lojas
      );
}

// ‚ö† Bot√£o "Verificar pend√™ncias"
window.vektorVerificarPendenciasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-pendencias' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando pend√™ncias das lojas dessa tabela no per√≠odo informado...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('pendencias');
};

// ‚úî Bot√£o "Verificar justificativas"
window.vektorVerificarJustificativasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-justificativas' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando transa√ß√µes com justificativas feitas de forma correta...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('justificativas');
};


// RESUMO POR TIME INICIO //

function renderResumoTransacoesPorTime(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui encontrar informa√ß√µes por <b>time</b> para esse per√≠odo.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto base do crit√©rio (valor x quantidade)
  var criterioTxt = (resumo.criterio === "valor")
    ? "maior <b>valor total</b> de transa√ß√µes"
    : "maior <b>n√∫mero</b> de transa√ß√µes";

  // Lista completa de times vinda do back-end
  var all = Array.isArray(resumo.times) ? resumo.times : [];

  // H√° filtro expl√≠cito de times na pergunta? (ex.: "times X e Y")
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  // üîé Filtro opcional por lista de times (nomes)
if (temFiltroTimes) {
  var alvoNorms = opts.filtrarTimesNomes.map(function (n) {
    return normalize(String(n));
  });

  all = all.filter(function (t) {
    var nomeNorm = normalize(String(t.time || ""));

    // Mant√©m o time se QUALQUER alvo ‚Äúbater‚Äù como parte do nome
    return alvoNorms.some(function (alvo) {
      return (
        nomeNorm.indexOf(alvo) >= 0 ||   // ex.: "furacao sul csc" cont√©m "furacao sul"
        alvo.indexOf(nomeNorm) >= 0      // ou o contr√°rio, se o alvo for mais longo
      );
    });
  });
}

  // Quantas linhas exibir (para time: sem top => TODOS)
  var linhas = (typeof opts.topN === "number") ? all.slice(0, opts.topN) : all;

  // Somat√≥rios com base no que ser√° exibido
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // ===== Recalcula o "top time" somente com base nas linhas filtradas =====
  var campoCriterio = (resumo.criterio === "quantidade") ? "total" : "valorTotal";
  var topItem = null;
  var topValor = -Infinity;

  for (var j = 0; j < linhas.length; j++) {
    var item = linhas[j];
    var v = Number(item[campoCriterio]) || 0;
    if (v > topValor) {
      topValor = v;
      topItem = item;
    }
  }

  // Monta a fraseResumo usando APENAS os times considerados na tabela
  var fraseResumo;
  if (!linhas.length || !topItem || topValor <= 0) {
    fraseResumo = temFiltroTimes
      ? "N√£o encontrei transa√ß√µes para os times informados no per√≠odo selecionado."
      : "N√£o encontrei transa√ß√µes no per√≠odo selecionado.";
  } else if (temFiltroTimes) {
    fraseResumo =
      "Entre os times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b>, o <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no per√≠odo selecionado.";
  } else {
    // Comportamento padr√£o quando n√£o h√° filtro de times (ranking geral)
    fraseResumo =
      "O <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no per√≠odo selecionado.";
  }

  // ===== Montagem da tabela (mesmo padr√£o visual das outras) =====
  var linhasTabela = [];
  if (linhas.length) {

    // üîΩ Dropdown de drilldown para a tabela de TIMES
    linhasTabela.push(
      "<div style='font-size:11px;margin-bottom:4px;color:#334155'>" +
        "Expandir a tabela por: " +
        "<select class='vektor-drill-select' data-base='time' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='loja'>Lojas</option>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    // Tabela no padr√£o azul / borda igual √†s demais
    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Time</th>" +
        "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    // Linhas de times
    for (var k = 0; k < linhas.length; k++) {
      var t = linhas[k];
      var qtd = Number(t.total) || 0;
      var val = Number(t.valorTotal) || 0;

      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

      var hint =
        "Clique para detalhar este time pela dimens√£o selecionada (lojas, categorias ou estabelecimentos), " +
        "respeitando o mesmo per√≠odo da pergunta inicial.";

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this, 'time')\" " +
            "style='cursor:pointer;' " +
            "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + (t.time || "") + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

  // üîΩ Bot√£o de exporta√ß√£o em CSV para o resumo por TIME
  var botaoCsv = "";
  if (tabelaHtml) {
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_times')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  // Mantendo o lookerUrl como no seu c√≥digo original (se quiser usar depois)
  var lookerUrl = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      //"<p style='font-size:13px;color:#555;margin:4px 0 8px;'>Clique em uma linha para detalhar (drill-down) no chat.</p>",
      tabelaHtml,
      botaoCsv,
    "</div>"
  ].join("");

  renderBotMessage("HTML:" + html);
}

// üîΩ Drilldown da fatura para TIMES, respeitando o per√≠odo da fatura
window.vektorDetalharFaturaPorTime = function (tr) {
  try {
    if (!tr) return;

    var inicioIso = tr.getAttribute("data-inicio") || "";
    var fimIso    = tr.getAttribute("data-fim") || "";

    // Pega o texto da fatura para mostrar na mensagem
    var extrato = "";
    if (tr.cells && tr.cells.length > 0) {
      extrato = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    }

    // Se n√£o tiver per√≠odo, n√£o faz sentido puxar times
    if (!inicioIso || !fimIso) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>" +
          "N√£o consegui identificar o per√≠odo dessa fatura para detalhar por time. " +
          "Verifique se o campo <b>Extrato da conta</b> est√° no formato esperado na BaseClara." +
        "</p>"
      );
      return;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou detalhar a fatura <b>" + extrato + "</b> " +
        "por <b>time</b>, considerando apenas as transa√ß√µes desse per√≠odo." +
      "</p>"
    );

    // Chama o Apps Script para montar o resumo por time
    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "N√£o consegui montar o resumo por time para esse per√≠odo de fatura." +
            "</p>"
          );
          return;
        }

        // Reutiliza o renderizador geral de times
        // topN: null -> lista todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Tive um problema ao detalhar esta fatura por time." +
          "</p>"
        );
      })
      .getResumoTransacoesPorTime(
        inicioIso, // data in√≠cio da fatura
        fimIso,    // data fim da fatura
        "valor"    // crit√©rio: agrupar por VALOR da fatura
      );

  } catch (e) {
    console.error("Erro em vektorDetalharFaturaPorTime:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Tive um problema ao detalhar esta fatura por time." +
      "</p>"
    );
  }
};

// ========= RENDER GEN√âRICO: CATEGORIAS / ESTABELECIMENTOS ========= //

function renderResumoPorChaveGenerico(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o consegui montar o resumo para esse pedido.</p>"
    );
    return;
  }

  opts = opts || {};
  var tipoChave = opts.tipoChave || "Categoria"; // "Categoria" ou "Estabelecimento"
  var titulo    = opts.titulo || ("Resumo por " + tipoChave.toLowerCase());
  var topN      = (typeof opts.topN === "number" && opts.topN > 0) ? opts.topN : null;

  // ===== Defini√ß√£o da base da tabela (categoria/estabelecimento/loja/time)
  var tipoChaveLower = tipoChave.toLowerCase();
  var baseTabela      = "categoria";    // usado no data-base do <select>
  var tipoTabelaExpand = "categoria";   // par√¢metro passado para vektorExpandirLinha
  var hintBase        = "";

  if (tipoChaveLower === "estabelecimento") {
    baseTabela       = "estabelecimento";
    tipoTabelaExpand = "estabelecimento";
    hintBase =
      "Clique para detalhar este estabelecimento pela dimens√£o selecionada (lojas, times ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "categoria") {
    baseTabela       = "categoria";
    tipoTabelaExpand = "categoria";
    hintBase =
      "Clique para detalhar esta categoria pela dimens√£o selecionada (lojas, times ou estabelecimentos), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "loja") {
    baseTabela       = "loja";
    tipoTabelaExpand = "loja";
    hintBase =
      "Clique para detalhar esta loja pela dimens√£o selecionada (times, estabelecimentos ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  } else if (tipoChaveLower === "time") {
    baseTabela       = "time";
    tipoTabelaExpand = "time";
    hintBase =
      "Clique para detalhar este time pela dimens√£o selecionada (lojas, estabelecimentos ou categorias), " +
      "respeitando o mesmo per√≠odo da pergunta inicial.";
  }

  // Descobre qual lista veio do backend
  var lista = [];
  if (Array.isArray(resumo.categorias)) {
    lista = resumo.categorias;
  } else if (Array.isArray(resumo.estabelecimentos)) {
    lista = resumo.estabelecimentos;
  } else if (Array.isArray(resumo.linhas)) {
    lista = resumo.linhas;
  }

  if (!lista.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>N√£o encontrei movimenta√ß√µes para esse filtro.</p>"
    );
    return;
  }

  // Se tiver topN, recorta
  if (topN !== null && lista.length > topN) {
    lista = lista.slice(0, topN);
  }

  // Calcula somat√≥rios para porcentagens
  var totalQtd = 0;
  var totalValor = 0;

  for (var i = 0; i < lista.length; i++) {
    var it = lista[i];
    totalQtd   += Number(it.total || it.qtd || 0);
    totalValor += Number(it.valorTotal || it.valor || 0);
  }

  var linhasTabela = [];

  // üîπ Flag: s√≥ tem drilldown se a base for TIME ou LOJA
  var temDrilldown = !(baseTabela === "categoria" || baseTabela === "estabelecimento");

  // ===== üîΩ DROPDOWN DE DRILLDOWN (somente se tiver drilldown) =====
  if (temDrilldown) {
    var opcoes = [];
    // Regra: todas as dimens√µes menos a pr√≥pria baseTabela
    if (baseTabela !== "time")            opcoes.push("<option value='time'>Times</option>");
    if (baseTabela !== "loja")            opcoes.push("<option value='loja'>Lojas</option>");
    if (baseTabela !== "estabelecimento") opcoes.push("<option value='estabelecimento'>Estabelecimentos</option>");
    if (baseTabela !== "categoria")       opcoes.push("<option value='categoria'>Categorias</option>");

    linhasTabela.push(
      "<div style='font-size:11px;margin-bottom:4px;color:#334155'>" +
        "Drilldown desta tabela de " + tipoChave.toLowerCase() + ": " +
        "<select class='vektor-drill-select' data-base='" + baseTabela + "' " +
                "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          opcoes.join("") +
        "</select>" +
      "</div>"
    );
  }

  // ===== TABELA PRINCIPAL =====
  linhasTabela.push(
    "<table border='1' cellspacing='0' cellpadding='6' " +
    "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
    "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
  );

  linhasTabela.push(
    "<tr style='background:#06167d;color:#fff'>" +
      "<th style='border:1px solid #000;'>" + tipoChave + "</th>" +
      "<th style='border:1px solid #000;'>Transa√ß√µes</th>" +
      "<th style='border:1px solid #000;'>% Transa√ß√µes</th>" +
      "<th style='border:1px solid #000;'>Valor (R$)</th>" +
      "<th style='border:1px solid #000;'>% Valor</th>" +
    "</tr>"
  );

  for (var j = 0; j < lista.length; j++) {
    var l = lista[j];
    var nome =
      l.estabelecimento ||
      l.categoria ||
      l.chave ||
      "‚Äî";

    var qtd   = Number(l.total || l.qtd || 0);
    var valor = Number(l.valorTotal || l.valor || 0);

    var pctQtd = totalQtd   > 0 ? ((qtd   / totalQtd)   * 100).toFixed(1) + "%" : "‚Äî";
    var pctVal = totalValor > 0 ? ((valor / totalValor) * 100).toFixed(1) + "%" : "‚Äî";

    // ===== LINHA: com ou sem onclick dependendo do drilldown =====
    if (temDrilldown) {
      var hint = hintBase ||
        "Clique para detalhar pela dimens√£o escolhida no seletor acima, respeitando o mesmo per√≠odo da pergunta inicial.";

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'" + tipoTabelaExpand + "')\" " +
          "style='cursor:pointer;' title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    } else {
      // üîπ Categoria / Estabelecimento ‚Üí SEM drilldown
      linhasTabela.push(
        "<tr>" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }
  }

  // Linha de TOTAL
  linhasTabela.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;'>TOTAL</td>" +
      "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
      "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "‚Äî") + "</td>" +
      "<td style='border:1px solid #000;'>" +
        totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "‚Äî") + "</td>" +
    "</tr>"
  );

  linhasTabela.push("</table>");

  // Bot√£o CSV
  var botaoCsv = "";
  if (linhasTabela.length) {
    var slug = tipoChave.toLowerCase();
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'resumo_" + slug + "')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "‚¨á Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      "<p>" + titulo + "</p>" +
      linhasTabela.join("") +
      botaoCsv +
    "</div>";

  renderBotMessage("HTML:" + html);
}

// Extrai "top N" (ex.: "top 5", "top5"). Se n√£o houver "top", retorna null.
function extrairTopN(texto) {
  if (!texto) return null;
  let m = texto.match(/top\s*(\d{1,2})/);
  if (!m) m = texto.match(/top(\d{1,2})/);
  if (m) {
    const n = Number(m[1]);
    if (!isNaN(n)) return Math.min(Math.max(n, 1), 50); // 1..50
  }
  return null;
}

// Decide crit√©rio: "quantidade" se falar de transa√ß√µes; sen√£o "valor".
function extrairCriterioGeral(texto) {
  if (!texto) return "valor";

  const falaDeTransacoes =
    texto.includes("transacoes") || 
    texto.includes("transacao") ||
    texto.includes("numero de transacoes") || 
    texto.includes("quantidade de transacoes") ||
    texto.includes("mais transacoes") || 
    texto.includes("maior numero de transacoes");

  const falaDeValor =
    texto.includes("valor") || 
    texto.includes("gasto") || 
    texto.includes("gastou") ||
    texto.includes("gastaram") || 
    texto.includes("gastos") || 
    texto.includes("compras") ||
    texto.includes("valor de transacoes");

  if (falaDeTransacoes && !falaDeValor) return "quantidade";
  return "valor";
}

function extrairGrupo(msgOriginal, norm) {
  const textoOriginal = msgOriginal || "";
  const lower = (norm || textoOriginal.toLowerCase());

  // procura a palavra "time "
  let idx = lower.indexOf("time ");
  if (idx === -1) {
    // se quiser, pode tentar "time:" tamb√©m
    idx = lower.indexOf("time:");
  }
  if (idx === -1) {
    return "";
  }

  // pega o que vem depois de "time "
  let parte = textoOriginal.substring(idx + 5); // 5 = len("time ")

  // corta quando come√ßar alguma palavra de per√≠odo
  const marcadores = [
    " no ", " neste ", " nesse ", " nesta ", " nessa ",
    " em ", " no per√≠odo", " no periodo",
    " neste mes", " nesse mes", " neste m√™s", " nesse m√™s",
    " na semana", " nesta semana", " nessa semana"
  ];

  let corte = parte.length;
  const parteLower = parte.toLowerCase();

  marcadores.forEach(m => {
    const j = parteLower.indexOf(m);
    if (j !== -1 && j < corte) {
      corte = j;
    }
  });

  parte = parte.substring(0, corte).trim();

  // remove "do", "da", "de" do come√ßo, se tiver
  parte = parte.replace(/^(do|da|de)\s+/i, "").trim();

  return parte;
}

// FILTRAR POR MAIS DE UMA LOJA

function extrairCodigosLojasDaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");

  // localiza a partir da palavra "loja" ou "lojas"
  let idx = texto.indexOf("lojas");
  if (idx < 0) idx = texto.indexOf("loja");
  if (idx < 0) return [];

  const trecho = texto.slice(idx); // parte da frase a partir de "loja(s)"

  // pega n√∫meros com 2 a 4 d√≠gitos (311, 145, 023, 1020 etc.)
  const encontrados = trecho.match(/\b\d{2,4}\b/g);
  if (!encontrados) return [];

  // normaliza tirando zeros √† esquerda
  return encontrados.map(function (c) {
    return c.replace(/^0+/, "") || c;
  });
}

// ========= DETECTOR: CATEGORIAS ========= //
function detectarPerguntaCategorias(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);
  let topN      = extrairTopN(t);
  let tipo      = extrairCriterioGeral(t);  // "valor" ou "quantidade"

  // Se falar "mais uso", for√ßa tratar como quantidade (uso = n√∫mero de vezes)
  if (t.includes("mais uso")) {
    tipo = "quantidade";
  }

  const falaCategoria =
    t.includes("categoria") ||
    t.includes("categorias");

  if (!falaCategoria) return null;

  const falaUso =
    t.includes("mais uso") ||
    t.includes("mais gasto") ||
    t.includes("mais gastos") ||
    t.includes("mais transacoes") ||
    t.includes("mais transacao") ||
    t.includes("maior valor") ||
    t.includes("maior gasto") ||
    t.includes("maior numero de transacoes") ||
    t.includes("maior quantidade de transacoes");

  if (!falaUso) return null;

  // Se n√£o tiver "top" expl√≠cito mas for "qual categoria ...", trata como top 1
  if (!topN && /\bqual\s+categoria\b/.test(t)) {
    topN = 1;
  }

  return {
    periodo,
    tipo,
    topN
  };
}

// ========= DETECTOR: ESTABELECIMENTOS (TRANSACAO) ========= //

function detectarPerguntaEstabelecimentos(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t);
  let   topN    = extrairTopN(t); // let para conseguirmos ajustar para 1

  // Palavras que DEFINEM claramente a inten√ß√£o de estabelecimento
  const falaLocal =
    t.includes("estabelecimento") ||
    t.includes("estabelecimentos") ||
    t.includes("local") ||
    t.includes("locais") ||
    t.includes("lugar") ||
    t.includes("lugares") ||
    t.includes("fornecedor") ||
    t.includes("fornecedores") ||
    t.includes("transacao no") ||
    t.includes("transacao na") ||
    t.includes("transacao em") ||
    t.includes("transa√ß√µes para") ||
    t.includes("transa√ß√£o para") ||
    t.includes("onde foi feita") ||
    t.includes("onde foi a compra");

  // Palavras que INDICAM time campe√£o ‚Äî e por isso devem bloquear
  const falaTimeCampeao =
    t.includes("time que mais gastou") ||
    t.includes("qual time gastou mais") ||
    t.includes("time com maior valor") ||
    t.includes("maior valor total por time") ||
    t.includes("maior gasto por time");

  // Se n√£o for claramente estabelecimento, ou se cair no caso de time ‚Üí ignora
  if (!falaLocal || falaTimeCampeao) return null;

  // Se n√£o tem ‚Äútop‚Äù mas a pessoa perguntou ‚Äúqual local/estabelecimento‚Äù ‚Üí for√ßa topN = 1
  if (!topN) {
    const temQualLocal =
      /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
    const temQualEstab =
      /\bqual\s+estabelecimento\b/.test(t) ||
      /\bqual\s+estabelecimentos\b/.test(t);

    if (temQualLocal || temQualEstab) {
      topN = 1;
    }
  }

  // Tenta extrair time (opcional)
  const grupo = encontrarTimeNaMensagem(msgOriginal) || "";

  // Tenta extrair loja
  let loja = "";
  const mLoja = t.match(/loja\s+([a-z0-9\-]+)/);
  if (mLoja) loja = mLoja[1];

  return {
    periodo,
    tipo,
    topN,
    grupo,
    loja
  };
}

// ========= DETECTOR: PERGUNTAS DE FATURA (Extrato da conta) =========

function detectarPerguntaFaturaClara(msgOriginal, norm) {
    const t = norm || "";
    // precisa citar "fatura"
    if (!t.includes("fatura")) return null;

    // S√≥ consideramos casos relacionados a valor
    const falaValor =
        t.includes("valor da fatura") ||
        t.includes("valor dessa fatura") ||
        t.includes("valor de fatura") ||
        t.includes("valor total da fatura");

    if (
      !falaValor &&
      !t.includes("fatura atual") &&
      !t.includes("fatura do mes") &&
      !t.includes("fatura do m√™s") &&
      !t.includes("fatura") &&
      !t.includes("faturas") &&
      !t.includes("ultimas faturas") &&
      !t.includes("√∫ltimas faturas") &&
      !t.includes("todas as faturas")
    ) {
        // se n√£o tiver nenhum indicativo de valor ou per√≠odo, ignora
        return null;
    }

    let modo = "atual";  // padr√£o
    let qtd  = null;

    // fatura do m√™s passado / anterior
    if (
      t.includes("mes passado") ||
      t.includes("m√™s passado") ||
      t.includes("fatura anterior")
    ) {
        modo = "anterior";
    }

    // √∫ltimas N faturas  ‚Üí pega tanto "ultimas 3" quanto "3 ultimas"
    if (t.includes("ultimas") || t.includes("√∫ltimas")) {
        modo = "ultimas";

        // casos tipo "ultimas 3 faturas"
        let m = t.match(/ultimas?\s+(\d+)/);
        // casos tipo "3 ultimas faturas"
        if (!m) m = t.match(/(\d+)\s+ultimas?/);

        if (m && m[1]) {
            qtd = parseInt(m[1], 10);
        } else {
            qtd = 2; // padr√£o se n√£o achar n√∫mero
        }
    }

    // todas as faturas
    if (t.includes("todas as faturas") || t.includes("todas faturas")) {
        modo = "todas";
    }

    // refor√ßa "atual" se mencionar explicitamente
    if (
      t.includes("fatura atual") ||
      t.includes("fatura deste mes") ||
      t.includes("fatura desse mes") ||
      t.includes("fatura deste m√™s") ||
      t.includes("fatura desse m√™s")
    ) {
        modo = "atual";
    }

    return {
        tipo: "fatura",
        modo: modo,
        qtd: qtd
    };
}

// ========= DETECTOR: "loja e time com maior n√∫mero/valor de transa√ß√µes..." ========= //

function detectarPerguntaLojaMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // fala claramente de loja
  const falaDeLoja =
    texto.includes("qual loja") ||
    texto.includes("loja com")  ||
    texto.includes("loja que mais")  ||
    texto.includes("loja mais");

  // pedindo topo por QUANTIDADE de transa√ß√µes
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // pedindo topo por VALOR de transa√ß√µes
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastou")                 ||
    texto.includes("loja que mais gastou")        ||
    texto.includes("mais gastos")                 ||
    texto.includes("maior gastos")                 ||
    texto.includes("maior gasto")                 ||
    texto.includes("mais comprou");

  // se n√£o for pergunta de loja + (transa√ß√µes ou valor), ignora
  if (!falaDeLoja || (!falaDeTransacoes && !falaDeValor)) {
    return null;
  }

  // intervalo de datas (ontem, esse m√™s, m√™s passado, "de 1 a 30 de outubro", etc.)
  const periodo = extrairIntervaloDatas(msgOriginal);

  // tenta achar um dos TIMES_OFICIAIS no texto
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal); // pode ser null

  // se falou de "valor" (gastou/comprou), √© consulta por valor; sen√£o, por quantidade
  const tipo = falaDeValor ? "valor" : "quantidade";

  return {
    grupo: grupoNomeOficial, // null => todas as lojas, independente de time
    periodo: periodo,
    tipo: tipo
  };

}

// ========= DETECTOR: "ranking geral de times" / "top N times ..." =========

function detectarRankingTimes(msgOriginal, norm) {
  // se for "qual time ..." (singular), deixa o bloco singular tratar
  if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) return null;

  const texto = norm || "";

  // üö´ ESCUDO: se falar de local/estabelecimento, N√ÉO √© pergunta de time
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // se fala explicitamente de loja(s), n√£o √© ranking de times
  if (texto.includes("lojas") || texto.includes("loja")) return null;

  const falaDeTime =
    texto.includes("ranking de times") ||
    texto.includes("ranking geral de times") ||
    (texto.includes("top") && (texto.includes("times") || texto.includes("time")));

  if (!falaDeTime) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = extrairCriterioGeral(texto);  // "valor" ou "quantidade"
  const topN = extrairTopN(texto);           // n√∫mero de linhas

  return { periodo, tipo, topN };
}

// ========= DETECTOR: "TODOS OS TIMES / RELA√á√ÉO DE TIMES" ========= //

function detectarTodosTimesPeriodo(msgOriginal, norm) {
  const t = norm || "";

  // Frases chave:
  // - "todos os times no per√≠odo ..."
  // - "rela√ß√£o de times no per√≠odo ..."
  const pedeTodosTimes =
    t.includes("todos os times") ||
    t.startsWith("todos os times") ||
    t.startsWith("relacao de times") ||
    t.includes("relacao de times no periodo") ||
    t.includes("rela√ß√£o de times") ||
    t.includes("rela√ß√£o de times no per√≠odo");

  if (!pedeTodosTimes) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  let tipo = extrairCriterioGeral(t); // "valor" ou "quantidade"

  // se n√£o especificar crit√©rio, assume valor
  if (!tipo) {
    tipo = "valor";
  }

  return {
    periodo,
    tipo,
    topN: null // null => queremos TODOS os times
  };
}

// ========= DETECTOR: "ranking/top N de LOJAS" (opcional: do time X) =========

function detectarRankingLojas(msgOriginal, norm) {
  const texto = norm || "";

  // üö´ Se falar de local/estabelecimento, N√ÉO √© ranking de lojas
  if (
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // Aceita: "ranking de lojas", "ranking geral de lojas", "top 5 lojas",
  // "ranking loja", "top 3 loja" (singular/plural)
  const mencionaRankingOuTop = texto.includes("ranking") || texto.includes("top");
  const mencionaLojas = texto.includes("lojas") || texto.includes("loja");

  if (!(mencionaRankingOuTop && mencionaLojas)) return null;

  // Time opcional (usa seu matcher)
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(texto); // "valor" ou "quantidade"
  const topN    = extrairTopN(texto);          // null se n√£o informou

  return { grupo: grupoNomeOficial, periodo, tipo, topN };
}

// ========= DETECTOR: "TODAS AS LOJAS" GERAL (sem time) ========= //

function detectarListarTodasLojasGeral(msgOriginal, norm) {
  const t = norm || "";

  // Aceita pedidos do tipo:
  // - "todas as lojas com gastos no per√≠odo ..."
  // - "todas as lojas com valor no per√≠odo ..."
  // - "rela√ß√£o de lojas no per√≠odo ..."
  const pedeTodas =
    t.includes("listar todas as lojas") ||
    t.startsWith("todas as lojas") ||
    t.includes("todas as lojas com gastos") ||
    t.includes("todas as lojas com gasto") ||
    t.includes("todas as lojas com valor") ||
    t.startsWith("relacao de lojas") ||
    t.includes("relacao de lojas no periodo") ||
    t.includes("rela√ß√£o de lojas") ||
    t.includes("rela√ß√£o de lojas no per√≠odo");

  if (!pedeTodas) return null;

  // crit√©rio: por padr√£o ordena por valor, mas a tabela mostra valor e quantidade
  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = "valor"; // mant√©m padr√£o por valor

  return {
    grupo: "",      // sem time
    periodo,
    tipo,
    topN: null      // null => queremos TODAS as lojas
  };
}

// =========== DETECTOR: "TODAS AS LOJAS DOS TIMES X E Y" =========== //

function detectarTodasLojasDosTimes(msgOriginal, norm) {
  const t = norm || "";

  const falaLojas = t.includes("todas as lojas dos times") ||
                    t.includes("todas as lojas dos time")  ||
                    t.includes("todas as lojas do time")   ||
                    t.includes("lojas do time")   ||
                    t.includes("loja do time")   ||
                    t.includes("todas as lojas do grupo")  ||
                    t.includes("todas as lojas dos grupos");

  if (!falaLojas) return null;

  const listaTimes = encontrarListaTimesNaMensagem(msgOriginal) || [];
  if (!listaTimes.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: listaTimes,
    periodo,
    tipo
  };
}

// =========== DETECTOR: "MAIS DE UMA LOJA NO PER√çODO" =========== //

function detectarLojasEspecificasLista(msgOriginal, norm) {
  const texto = norm || "";

  // ‚ö†Ô∏è Se a frase fala de pend√™ncia, N√ÉO tratar como consulta de transa√ß√µes
  // Isso evita conflitos com o fluxo de pend√™ncias (CLARA_PEND)
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "loja" ou "lojas"
  const mencionaLoja =
    texto.includes("loja ") ||
    texto.includes("lojas ");

  if (!mencionaLoja) return null;

  // extrai c√≥digos num√©ricos de loja
  const codigos = [];
  const regexCodigos = /\b(\d{2,6})\b/g;
  let m;
  while ((m = regexCodigos.exec(msgOriginal)) !== null) {
    const cod = m[1];
    if (!codigos.includes(cod)) {
      codigos.push(cod);
    }
  }

  if (!codigos.length) return null;

  // per√≠odo
  const periodo = extrairIntervaloDatas(msgOriginal);
  // tipo (valor ou quantidade)
  const tipo = extrairCriterioGeral(texto) || "valor";

  return {
    codigosLojas: codigos,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "lojas com maior valor/transa√ß√µes ..." (plural, sem 'top'/'ranking') =========
function detectarLojasMaisTransacoesPlural(msgOriginal, norm) {
  const texto = norm || "";

    // ‚ö†Ô∏è Se falar de pend√™ncia, n√£o √© consulta de ranking/lista de transa√ß√µes
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "lojas " (plural) + crit√©rio
  const mencionaLojasPlural = texto.includes("lojas ");
  if (!mencionaLojasPlural) return null;

  // crit√©rio
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior quantidade de transacoes");

  const falaDeValor =
    texto.includes("maior valor")     ||
    texto.includes("mais gastou")     ||
    texto.includes("mais gasto")      ||
    texto.includes("mais gastos")     ||
    texto.includes("maior gasto")     ||
    texto.includes("maior gastos")     ||
    texto.includes("mais comprou")    ||
    texto.includes("valor de transacoes");

  if (!falaDeTransacoes && !falaDeValor) return null;

  const tipo = falaDeValor ? "valor" : "quantidade";
  const periodo = extrairIntervaloDatas(msgOriginal);
  const grupo = encontrarTimeNaMensagem(msgOriginal) || "";

  // sem 'top' => queremos listar TODAS as lojas do time (se grupo vier),
  // ou o default que voc√™ preferir para "todas as lojas gerais" (vamos deixar limitado se n√£o houver time)
  return { grupo, periodo, tipo, topN: null }; // topN=null => deixe o renderer decidir "listar todas"
}

// =========== DETECTOR: "TODAS AS LOJAS DO TIME XXXXX" =========== //

function detectarListarTodasLojasDoTime(msgOriginal, norm) {
  const t = norm || "";

  // üö´ Se falar em "top", N√ÉO √© "todas as lojas do time",
  // e sim um ranking de lojas. Deixa para detectarRankingLojas tratar.
  if (t.includes("top")) {
    return null;
  }

  // Gatilhos espec√≠ficos para perguntas de "lojas do time"
  const pedeTodas =
    t.includes("todas as lojas do time") ||
    t.includes("todas as loja do time") ||   // tolera sem 's'
    t.includes("lojas do time") ||
    t.includes("loja do time") ||            // tolera sem 's'
    t.includes("lojas da regional") ||
    t.includes("loja da regional") ||
    t.includes("todas as lojas do grupo") ||
    t.includes("todas as loja do grupo") ||  // tolera sem 's'
    t.includes("relacao de lojas do time") ||
    t.includes("rela√ß√£o de lojas do time") ||
    t.includes("relacao de lojas do grupo") ||
    t.includes("rela√ß√£o de lojas do grupo");

  if (!pedeTodas) return null;

  // Usa o parser de times que voc√™ j√° tem
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  if (!grupoNomeOficial) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    grupo: grupoNomeOficial,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "time com maior n√∫mero/valor de transa√ß√µes ..." ========= //
function detectarPerguntaTimeMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // üö´ Se a frase fala de estabelecimento/local, N√ÉO √© pergunta de time campe√£o
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // fala claramente de time (n√£o de loja)
  const falaDeTime =
    texto.includes("qual time") ||
    texto.includes("time com")  ||
    texto.includes("time que mais") ||
    texto.includes("time mais");

  // QUANTIDADE
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // VALOR
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastos")                ||
    texto.includes("mais comprou");

  if (!falaDeTime || (!falaDeTransacoes && !falaDeValor)) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = falaDeValor ? "valor" : "quantidade";

  return { periodo, tipo };
}

// Lista as etiquetas dispon√≠veis na BaseClara (coluna T) e mostra no chat

function listarEtiquetasClara() {
  // Mensagem inicial do bot
  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>" +
    "Vou buscar a lista de etiquetas e o resumo de uso e j√° te mostro aqui. ‚è≥" +
    "</p>"
  );

  google.script.run
    .withSuccessHandler(function(resumo) {
      if (!resumo || !Array.isArray(resumo.itens) || !resumo.itens.length) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
          "N√£o encontrei dados suficientes para montar o resumo de etiquetas (coluna T e valor). " +
          "Verifique se a BaseClara tem a coluna de <b>Etiquetas</b> e a coluna de <b>Valor</b> preenchidas." +
          "</p>"
        );
        return;
      }

      var itens = resumo.itens;
      var totalGeral = resumo.totalGeral || 0;

      // formata√ß√µes
      function formatBRL(n) {
        if (!n || isNaN(n)) n = 0;
        return n.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
          minimumFractionDigits: 2
        });
      }

      function formatPct(p) {
        if (!p || isNaN(p)) p = 0;
        return p.toLocaleString("pt-BR", {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1
        }) + " %";
      }

      // soma novamente por seguran√ßa (caso venha alguma inconsist√™ncia)
      var somaValores = 0;
      itens.forEach(function (it) {
        var v = (it.valorTotal || 0);
        if (!isNaN(v)) somaValores += v;
      });

 // Monta a tabela HTML
      var html = "<div class='text-sm text-slate-700 mt-2'>" +
                 "<p class='mb-2'>Resumo de uso das etiquetas na Clara:</p>" +
                 "<div class='overflow-x-auto'>" +
                 "<table id='tabela-etiquetas-clara' style='border-collapse:collapse;width:100%; font-size:12px; border:2px solid #000;'>";  // borda externa preta

      // Cabe√ßalho
      html += "<thead>" +
              "<tr>" +
              "<th style='background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;text-align:left;'>Etiqueta</th>" +
              "<th style='background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;text-align:right;'>% de uso (valor)</th>" +
              "<th style='background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;text-align:right;'>Valor total</th>" +
              "</tr>" +
              "</thead>";

      // Corpo
      html += "<tbody>";

      itens.forEach(function (it) {
        var etiqueta = it.etiqueta || "";
        var perc = formatPct(it.percentual || 0);
        var val = formatBRL(it.valorTotal || 0);

        etiqueta = etiqueta
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        html += "<tr>" +
                "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;'>" + etiqueta + "</td>" +
                "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;'>" + perc + "</td>" +
                "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;'>" + val + "</td>" +
                "</tr>";
      });

      html += "</tbody>";

      // Rodap√© (TOTAL)
      html += "<tfoot>" +
              "<tr>" +
              "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;font-weight:bold;'>TOTAL</td>" +
              "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>100,0 %</td>" +
              "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>" + formatBRL(somaValores) + "</td>" +
              "</tr>" +
              "</tfoot>";

      html += "</table>";

      // Bot√£o CSV no final, canto inferior direito
      html += "<div style='text-align:right; margin-top:8px;'>" +
              "<button type='button' " +
                "onclick=\"exportTableToCSV(this, 'etiquetas_clara')\" " +
                "style='background:#005E27;color:#fff;border:none;padding:6px 12px;" +
                       "border-radius:4px;font-size:11px;cursor:pointer;'>" +
                "‚¨á Exportar CSV" +
              "</button>" +
              "</div>";

      html += "</div></div>";

      renderBotMessage("HTML:" + html);
    })
    .getResumoEtiquetasClara(); // <-- nova fun√ß√£o no Code.gs
}

    /* ========= ENVIO (ENTER / BOT√ÉO) ========= */

    function enviarMensagem() {


      // üÜï cancela timeout de pend√™ncias ao responder
        if (pendenciasTimeoutId) {
            clearTimeout(pendenciasTimeoutId);
            pendenciasTimeoutId = null;
        }

      // üëá pede permiss√£o de notifica√ß√£o logo na primeira intera√ß√£o
        solicitarPermissaoNotificacao();
        const texto = userInput.value.trim();
        if (!texto) return;

        renderUserMessage(texto);
        userInput.value = "";  // limpa aqui, sempre

        // Normaliza o texto para busca de inten√ß√£o
    const norm = normalize(texto || "");

    // Se o usu√°rio pedir listagem de etiquetas, chama a a√ß√£o espec√≠fica
    if (
      norm.includes("listagem de etiquetas") ||
      norm.includes("lista de etiquetas") ||
      norm.includes("etiquetas disponiveis") ||
      norm.includes("etiquetas dispon√≠veis") ||
      norm.includes("etiquetas da clara") ||
      norm.includes("etiquetas na clara")
    ) {
      listarEtiquetasClara();
      return; // n√£o segue para gerarRespostaDoBot
    }

        const resposta = gerarRespostaDoBot(texto);

          // Se a inten√ß√£o for listar etiquetas, chama a fun√ß√£o espec√≠fica e para aqui
  if (resposta === "ACAO_LISTAR_ETIQUETAS_CLARA") {
    listarEtiquetasClara();
    return;
  }

          if (resposta) renderBotMessage(resposta);

          // Depois de responder normalmente, avalia se faz sentido sugerir algo do Manual da Clara
          try {
            vektorSugerirManualAPartirDaPergunta(texto);
          } catch (e) {
            console.warn("Erro ao tentar sugerir Manual da Clara:", e);
          }

          // E tamb√©m sugest√µes gerais (pol√≠tica, relat√≥rios, pend√™ncias, etc.)
          try {
            vektorSugerirTopicosGerais(texto);
          } catch (e) {
            console.warn("Erro ao tentar sugerir t√≥picos gerais:", e);
          }

          userInput.value = "";
          userInput.focus();
          scrollToBottom();
        }

        // ====== RESPOSTA DOS BOT√ïES "SIM" / "N√ÉO" PARA PEND√äNCIAS ======
        window.vektorResponderConfirmacaoPendencias = function (resposta) {
  try {
    // se n√£o estiver aguardando confirma√ß√£o, ignora
    if (typeof estadoPendencias === "undefined" ||
        estadoPendencias !== "aguardando_confirmacao_email") {
      return;
    }

    // Garante que temos os elementos necess√°rios
    if (!window.userInput || typeof enviarMensagem !== "function") {
      console.warn("userInput ou enviarMensagem n√£o dispon√≠veis.");
      return;
    }

    // Preenche a caixa de texto com 'sim' ou 'n√£o' e reaproveita todo o fluxo j√° existente
    userInput.value = resposta;
    enviarMensagem();
  } catch (e) {
    console.error("Erro em vektorResponderConfirmacaoPendencias:", e);
  }
};

userInput.addEventListener("keydown", (e) => {
    const boxVisivel   = vektorBox && vektorBox.style.display === "block";
    const haSugestoes  = vektorCurrentSuggestions && vektorCurrentSuggestions.length > 0;

    // ESC fecha o autocomplete
    if (e.key === "Escape") {
        if (boxVisivel) {
            e.preventDefault();
            vektorBox.style.display = "none";
            vektorSelectedIndex = -1;
            vektorCurrentSuggestions = [];
        }
        return;
    }

    // Se o autocomplete estiver aberto e tiver sugest√µes
    if (boxVisivel && haSugestoes) {

        // TAB ou seta para baixo -> pr√≥xima sugest√£o
        if (e.key === "ArrowDown" || (e.key === "Tab" && !e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex + 1) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // Shift+TAB ou seta para cima -> sugest√£o anterior
        if (e.key === "ArrowUp" || (e.key === "Tab" && e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex - 1 + vektorCurrentSuggestions.length) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // ENTER com item selecionado -> aplica sugest√£o
        if (e.key === "Enter") {
            if (vektorSelectedIndex >= 0 && vektorCurrentSuggestions[vektorSelectedIndex]) {
                e.preventDefault();

                const textoSugestao = vektorCurrentSuggestions[vektorSelectedIndex];
                vektorApplySuggestion(textoSugestao);

                vektorBox.style.display = "none";
                vektorSelectedIndex = -1;
                vektorCurrentSuggestions = [];
                return; // usu√°rio aperta Enter de novo se quiser enviar
            }
            // se n√£o tiver item selecionado, cai no fluxo padr√£o mais abaixo
        }
    }

    // Fluxo padr√£o: Enter envia a mensagem (sem Shift)
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
    }
});

    sendBtn.addEventListener("click", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    // üü¢ Mostrar o v√≠deo do Vektor s√≥ na primeira visita
    (function () {
      var modal = document.getElementById("vektorModal");
      if (!modal) return;

      // Verifica se j√° mostramos o v√≠deo neste navegador
      var jaMostrou = localStorage.getItem("vektorIntroShown");

      if (!jaMostrou) {
        // Nunca mostrou ‚Üí exibe o modal e marca como exibido
        modal.style.display = "flex";   // combina com as classes flex do Tailwind
        localStorage.setItem("vektorIntroShown", "1");
      } else {
        // J√° mostrou uma vez ‚Üí garante que fique escondido
        modal.style.display = "none";
      }
    })();

      // ===== MODAL DO MANUAL CLARA =====
  window.openManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.remove("hidden");
      // para garantir que fique centralizado como flex
      el.classList.add("flex");
    }
  };

  window.closeManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.add("hidden");
      el.classList.remove("flex");
    }
  };

}); // fim DOMContentLoaded

</script>
</body>
</html>
