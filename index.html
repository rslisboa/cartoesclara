<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Vektor</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js + plugin de data labels para o gráfico de faturas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:none;
        width:100%; 
        margin:0;
        display:flex;
        flex-direction:column;
        height:100%;
        min-height:0;
        position: relative;
        overflow: hidden;

    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:0.5rem 1.25rem 0.75rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        background-color:#005E27;
        color:#B5FF20;
        margin-bottom:0.5rem;
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:100px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex: 1;
        display:flex;
        flex-direction:column;
        overflow-y:hidden;
        padding:1rem 1.25rem;
        background-color:#fff;
        min-height:0;
    }
    .chat-window {
        flex:1;              /* ocupa todo o espaço disponível dentro do main */
        overflow-y:auto;     /* ativa scroll interno das mensagens */
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
        padding:1rem 1.5rem; /* opcional: espaço interno */
}

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
        position: relative;
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digitação menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do histórico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links nas respostas do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }

    /* ===== Tooltips dos botões de pendências/justificativas ===== */
.vektor-btn-wrapper {
  position: relative;
  display: inline-block;
}

/* ===== Radar Tooltip (tabela com scroll, sem afetar tooltips globais) ===== */
.vektor-btn-wrapper.vektor-radar-tip:hover .vektor-tooltip-base,
.vektor-tooltip-base.vektor-radar-tip:hover {
  opacity: 1;
  pointer-events: auto; /* permite rolar/interagir */
}



/* Tooltip "grande" apenas quando tiver a classe vektor-radar-tip */
.vektor-tooltip-base.vektor-radar-tip {
  white-space: normal;
  width: min(1100px, 92vw);
  max-height: 360px;
  padding: 10px;
  border-radius: 10px;
  background: rgba(15,23,42,0.97);
  border: 2px solid rgba(226,232,240,0.9);
  box-shadow: 0 10px 25px rgba(0,0,0,0.45);
}

/* Container interno rolável: scroll só no conteúdo da tabela */
.vektor-tooltip-base.vektor-radar-tip .vektor-radar-tip-scroll {
  overflow: auto;
  max-height: 320px;
  max-width: 100%;
  padding-right: 6px;
}

.vektor-tooltip-base {
  position: absolute;
  bottom: 110%;           /* aparece logo acima do botão */
  right: 0;
  z-index: 9999;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 11px;
  color: #FFFFFF;            /* texto SEMPRE branco, como você pediu */
  background: rgba(0,0,0,0.85); /* será sobrescrito inline por botão */
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  box-shadow: 0 2px 6px rgba(15,23,42,0.25);
}

.vektor-btn-wrapper:hover .vektor-tooltip-base {
  opacity: 1;
}

/* ===== Radar: barra de legenda (animada) ===== */
.radar-legend-bar {
  margin-top: 10px;
  height: 10px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.18);
  background: linear-gradient(
    90deg,
    rgba(59,130,246,0.95),
    rgba(148,163,184,0.35),
    rgba(239,68,68,0.95)
  );
  position: relative;
  overflow: hidden;
}

/* brilho suave passando por cima */
.radar-legend-bar::after {
  content: "";
  position: absolute;
  top: -40%;
  left: -35%;
  width: 35%;
  height: 180%;
  background: linear-gradient(
    90deg,
    rgba(255,255,255,0),
    rgba(255,255,255,0.25),
    rgba(255,255,255,0)
  );
  transform: skewX(-18deg);
  pointer-events: none;
}

/* anima SOMENTE quando o Radar estiver aberto */
#radarView.is-open .radar-legend-bar::after {
  animation: radarSheen 2.8s ease-in-out infinite;
}

@keyframes radarSheen {
  0%   { left: -35%; opacity: 0.0; }
  15%  { opacity: 0.55; }
  50%  { left: 105%; opacity: 0.35; }
  85%  { opacity: 0.0; }
  100% { left: 105%; opacity: 0.0; }
}

/* ===== Spinner de carregamento para pendências/justificativas ===== */
.vektor-loading {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #0f172a;
}

.vektor-spinner {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  border: 2px solid #e5e7eb;
  border-top-color: #0f172a;
  animation: vektor-spin 0.7s linear infinite;
}

/* ===== Overlay Envio de Pendências (spinner) ===== */
.envPend_spinner{
  width: 42px;
  height: 42px;
  border-radius: 999px;
  border: 4px solid rgba(226,232,240,0.18);
  border-top-color: #B5FF20;
  animation: envPendSpin 0.9s linear infinite;
}
@keyframes envPendSpin{
  to { transform: rotate(360deg); }
}

@keyframes vektor-spin {
  to {
    transform: rotate(360deg);
  }
}

/* === VEKTOR AUTOCOMPLETE === */
#vektor-autocomplete-box {
  position: absolute;
  left: 0;
  right: 0;

  /* aparece acima do input, sem empurrar layout */
  bottom: calc(100% + 8px);

  margin-top: 0;
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.14);
  z-index: 9999;
  display: none;
  font-size: 13px;
  max-height: 220px;
  overflow-y: auto;
}

.vektor-autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
}

.vektor-autocomplete-item:hover {
  background: #B5FF20;
}

.vektor-autocomplete-item.is-active {
  background: #B5FF20;
}

#attachBtn {
    background-color: transparent !important;
    border-color: #cbd5e1 !important; /* mantém o cinza do Tailwind */
    color: #0f172a !important;         /* mantém cor do ícone */
}

/* === FIX: opções de SELECT visíveis no tema escuro (My Alerts) === */
#myAlertsView select,
#myAlertsView option {
  color: #ffffff;
}

#myAlertsView option {
  background: #0b1220; /* mesmo fundo do header/cards */
}

/* multi-select (etiquetas) */
#myAlertsView select[multiple] option {
  background: #0b1220;
}

/* hover/selecionado (alguns browsers) */
#myAlertsView option:checked,
#myAlertsView option:hover {
  background: rgba(22,163,74,0.35);
}

/* === FIX: opções de SELECT visíveis no tema escuro (Radar Itens) === */
#radarItensView select,
#radarItensView option {
  color: #ffffff;
}
#radarItensView option {
  background: #0b1220;
}
#radarItensView option:checked,
#radarItensView option:hover {
  background: rgba(22,163,74,0.35);
}

/* === FIX: opções de SELECT visíveis no tema escuro (Modal Itens Irregulares) === */
#itensIrregDetalhamentoModal select,
#itensIrregDetalhamentoModal option {
  color: #ffffff;
}
#itensIrregDetalhamentoModal option {
  background: #0b1220;
}
#itensIrregDetalhamentoModal option:checked,
#itensIrregDetalhamentoModal option:hover {
  background: rgba(22,163,74,0.35);
}

/* Ícone do calendário (Chrome/Edge) */
#envioPendView input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(1.6);
  opacity: 1;
  cursor: pointer;
}

/* remove “botões” extras se aparecerem */
#envioPendView input[type="date"]::-webkit-inner-spin-button,
#envioPendView input[type="date"]::-webkit-clear-button {
display: none;
}

/* Ícone do calendário (Chrome/Edge) — Radar Itens Irregulares */
#radarItensView input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1) brightness(1.6);
  opacity: 1;
  cursor: pointer;
}
#radarItensView input[type="date"]::-webkit-inner-spin-button,
#radarItensView input[type="date"]::-webkit-clear-button {
  display: none;
}

/* Ícone do calendário */
#cicloResumoView input[type="date"]::-webkit-calendar-picker-indicator{
  filter: invert(1) brightness(2) contrast(1.2) !important;
  opacity: 1 !important;
  cursor: pointer;
  width: 18px;
  height: 18px;
}

/* evita botões extras */
#cicloResumoView input[type="date"]::-webkit-inner-spin-button,
#cicloResumoView input[type="date"]::-webkit-clear-button{
  display: none;
}

/* ✅ Fundo cinza claro na faixa do filtro de período */
#cicloResumoView .cicloResumoPeriodoBox{
  background: #e5e7eb !important;   /* cinza claro */
  border: 1px solid #cbd5e1 !important;
  border-radius: 14px !important;
  padding: 10px 12px !important;
}

/* =========================
   RESUMO DO CICLO - VISUAL
   ========================= */
.cicloResumoPage {
  background:#ffffff !important;
}

.cicloCard {
  background:#fff;
  border:2px double #005E27;
  border-radius:14px;
  padding:12px;
  box-shadow:0 10px 22px rgba(0,0,0,0.08);
}

.cicloCardLabel {
  color:#0f172a;
  font-size:13px;
  font-weight:900;
}

.cicloCardValue {
  margin-top:6px;
  color:#0b1220;
  font-size:26px;
  font-weight:1000;
}

.cicloCardSub {
  margin-top:2px;
  color:#334155;
  font-size:12px;
  font-weight:800;
}

#cicloResumoTableBox {
  background:#fff;
  border:2px solid #000;
  border-radius:12px;
  overflow:auto;
  max-height:45vh; /* ✅ necessário p/ o sticky “fazer sentido” */
}

/* ===== Resumo do ciclo | Tabela com grade + cabeçalho sticky ===== */
#cicloResumoTable {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  color: #0b1220;
}

#cicloResumoTable thead th{
  position: sticky;
  text-align:center !important;
  vertical-align:middle !important;
  top: 0;
  z-index: 2;
  background: #123a63;
  color: #ffffff;
  font-size: 13px;               /* +1 ponto */
  border-right: 2px double #005E27;
  border-bottom: 2px double #005E27;
  padding: 10px 10px;
}

#cicloResumoTable thead th[data-sort]::after{
  content:" ⇅";
  opacity:0;
  transition: opacity .15s ease;
  margin-left:6px;
}

#cicloResumoTable thead th[data-sort]:hover::after{
  opacity:0.75;
}

#cicloResumoTable tbody td{
  font-size: 12px;               /* +1 ponto */
  border-right: 2px double #111;
  border-bottom: 2px double #111;
  padding: 10px 10px;
  background: #ffffff;
}

#cicloResumoTable thead th:last-child,
#cicloResumoTable tbody td:last-child{
  border-right: none;
}

.cicloResumoRow { cursor: default; }

.cicloResumoRow:hover td {
  background:#f8fafc;
}

#cicloResumoTooltipHeader {
  background:#005E27;
  color:#fff;
  padding:12px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
#cicloResumoTooltipBody {
  background:#fff;
  padding:12px 14px;
  color:#0f172a;
}

/* =========================
   ANALISE DE GASTOS - VISUAL (espelha Resumo do Ciclo, com ajustes)
   ========================= */

/* Ícone do calendário */
#analiseGastosView input[type="date"]::-webkit-calendar-picker-indicator{
  filter: invert(1) brightness(2) contrast(1.2) !important;
  opacity: 1 !important;
  cursor: pointer;
  width: 18px;
  height: 18px;
}
#analiseGastosView input[type="date"]::-webkit-inner-spin-button,
#analiseGastosView input[type="date"]::-webkit-clear-button{
  display: none;
}

/* período */
#analiseGastosView .analiseGastosPeriodoBox{
  background: #e5e7eb !important;
  border: 1px solid #cbd5e1 !important;
  border-radius: 14px !important;
  padding: 8px 10px !important;
}

/* ✅ FIX do desalinhamento inicial:
   largura fixa dos inputs de data para não "crescer" quando muda placeholder -> valor */
#analiseGastos_dtIni,
#analiseGastos_dtFim{
  width: 150px !important;
  min-width: 150px !important;
  max-width: 150px !important;
  box-sizing: border-box !important;
  display: inline-block !important;
  text-align: center !important;
}

/* ✅ Multi-select: opções com texto branco e fundo preto */
#analiseGastos_selTime option,
#analiseGastos_selLoja option,
#analiseGastos_selCategoria option{
  color:#ffffff !important;
  background:#020f2b !important;
}

/* ✅ Opção selecionada: realce para ficar legível */
#analiseGastos_selTime option:checked,
#analiseGastos_selLoja option:checked,
#analiseGastos_selCategoria option:checked{
  background:#0b2a5a !important;  /* azul escuro (realce) */
  color:#ffffff !important;
}

/* cards */
.analiseGastosCard{
  position: relative;
  background:#fff;
  border:2px double #005E27;
  border-radius:14px;
  padding:10px 12px;
  box-shadow:0 10px 22px rgba(0,0,0,0.08);
  min-height: 120px;
  overflow: hidden; /* importante para prender os efeitos dentro do card */
  isolation: isolate;
}

/* camada decorativa 1: "área de gráfico" suave */
.analiseGastosCard::before{
  content:"";
  position:absolute;
  inset:auto -10% -8% -10%;
  height:58%;
  background:
    radial-gradient(120% 90% at 0% 100%, rgba(181,255,32,0.18) 0%, rgba(181,255,32,0.08) 42%, rgba(181,255,32,0.00) 70%),
    radial-gradient(95% 80% at 45% 100%, rgba(181,255,32,0.14) 0%, rgba(181,255,32,0.06) 45%, rgba(181,255,32,0.00) 72%),
    radial-gradient(85% 75% at 90% 100%, rgba(181,255,32,0.12) 0%, rgba(181,255,32,0.05) 44%, rgba(181,255,32,0.00) 70%);
  pointer-events:none;
  z-index:0;
}

/* camada decorativa 2: linha tipo curva/área (bem sutil) */
.analiseGastosCard::after{
  content:"";
  position:absolute;
  left:-6%;
  right:-6%;
  bottom:18px;
  height:42px;
  border-radius:999px;
  background:
    linear-gradient(180deg, rgba(181,255,32,0.00), rgba(181,255,32,0.10));
  clip-path: polygon(
    0% 75%, 8% 68%, 16% 72%, 24% 58%, 32% 63%, 40% 46%, 48% 52%,
    56% 38%, 64% 47%, 72% 33%, 80% 42%, 88% 28%, 100% 38%,
    100% 100%, 0% 100%
  );
  pointer-events:none;
  z-index:0;
}

/* garante texto acima das camadas decorativas */
.analiseGastosCardLabel,
.analiseGastosCardValue,
.analiseGastosCardSub{
  position: relative;
  z-index: 1;
}

.analiseGastosCardLabel{
  position: relative;
  display: inline-block;
  color:#0f172a;
  font-size:15px;
  font-weight:1000;
  line-height:1.15;
  z-index: 1;
  padding-right: 6px;
}

/* linha verde clara atravessando/realçando o título */
.analiseGastosCardLabel::after{
  content:"";
  position:absolute;
  left:0;
  right:0;
  top:-6px;
  height:2px;
  background:#B5FF20;
  opacity:0.95;
  border-radius:999px;
  z-index:-1;
}

.analiseGastosCardValue{
  margin-top:8px;
  color:#0b1220;
  font-size:24px;                    /* ↓ principal um pouco menor */
  font-weight:1000;
  line-height:1.25;
  word-break: break-word;            /* quebra palavras longas */
  overflow-wrap: anywhere;           /* garante quebra em texto "colado" */
  white-space: normal;
}

.analiseGastosCardSub{
  margin-top:4px;
  color:#334155;
  font-size:11px;
  font-weight:900;
  line-height:1.2;
  word-break: break-word;
  overflow-wrap: anywhere;
  white-space: normal;
}

/* ✅ clamp visual nos cards longos (evita estourar layout) */
#analiseGastos_cardCategoriaTop,
#analiseGastos_cardEstabTop{
  display: -webkit-box;
  -webkit-line-clamp: 2;       /* no máximo 2 linhas */
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* tabela */
#analiseGastosTableBox{
  background:#fff;
  border:2px solid #000;
  border-radius:12px;
  overflow:auto;

  /* ✅ AUMENTA área da tabela */
  max-height: calc(100vh - 355px);   /* ajuste principal */
  min-height: 340px;                 /* garante boa área mesmo sem muitos dados */
}

#analiseGastosTable{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  color: #0b1220;
}

#analiseGastosTable thead th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: #123a63;
  color: #ffffff;
  font-size: 13px;
  font-weight: 1000;
  text-align:center !important;      /* ✅ centralizado */
  vertical-align:middle !important;  /* ✅ centralizado vertical */
  line-height: 1.2;
  padding: 14px 10px;                /* pouco maior para centralizar melhor visualmente */
  border-right: 2px double #005E27;
  border-bottom: 2px double #005E27;
}

#analiseGastosTable thead th[data-sort]{
  cursor: pointer;
}

#analiseGastosTable thead th[data-sort]::after{
  content:" ⇅";
  opacity:0;
  transition: opacity .15s ease;
  margin-left:6px;
}
#analiseGastosTable thead th[data-sort]:hover::after{
  opacity:0.75;
}

#analiseGastosTable tbody td{
  font-size: 12px;
  border-right: 2px double #111;
  border-bottom: 2px double #111;
  padding: 10px 10px;
  background: #ffffff;
  vertical-align: middle;
}

#analiseGastosTable thead th:last-child,
#analiseGastosTable tbody td:last-child{
  border-right: none;
}

.analiseGastosRow:hover td{
  background:#f8fafc;
}

/* força centralização visual nas colunas Loja (2) e Valor (6) */
#analiseGastosTable thead th:nth-child(2),
#analiseGastosTable thead th:nth-child(6){
  text-align: center !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* reforço visual de centralização em headers curtos */
#analiseGastosTable thead th:nth-child(2), /* Loja */
#analiseGastosTable thead th:nth-child(6) { /* Valor (R$) */
  text-align: center !important;
  vertical-align: middle !important;
  padding-left: 10px !important;
  padding-right: 10px !important;
}

/* ===========================
   Análise de Gastos - Card Estabelecimento (clicável + hover help)
=========================== */
#analiseGastos_cardEstabWrap{
  cursor: pointer;
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}

#analiseGastos_cardEstabWrap:hover{
  transform: translateY(-2px);
  box-shadow: 0 14px 26px rgba(0,0,0,0.12);
}

/* linha acima do título em vermelho claro */
#analiseGastos_cardEstabWrap .analiseGastosCardLabel::after{
  background: #fca5a5; /* vermelho claro */
}

/* borda do card em tom vermelho claro */
#analiseGastos_cardEstabWrap{
  border-color: #ef4444 !important;
}

/* área decorativa inferior em vermelho claro (substitui verde nesse card) */
#analiseGastos_cardEstabWrap::before{
  background:
    radial-gradient(120% 90% at 0% 100%, rgba(239,68,68,0.16) 0%, rgba(239,68,68,0.07) 42%, rgba(239,68,68,0.00) 70%),
    radial-gradient(95% 80% at 45% 100%, rgba(252,165,165,0.14) 0%, rgba(252,165,165,0.06) 45%, rgba(252,165,165,0.00) 72%),
    radial-gradient(85% 75% at 90% 100%, rgba(254,202,202,0.12) 0%, rgba(254,202,202,0.05) 44%, rgba(254,202,202,0.00) 70%);
}

#analiseGastos_cardEstabWrap::after{
  background: linear-gradient(180deg, rgba(252,165,165,0.00), rgba(252,165,165,0.12));
}

/* texto de ajuda no hover (sobe) */
.analiseGastosCardHoverHelp{
  position:absolute;
  left:10px;
  right:10px;
  bottom:8px;
  z-index:2;
  background: rgba(255,255,255,0.96);
  border:1px solid #fecaca;
  color:#7f1d1d;
  border-radius:10px;
  padding:6px 8px;
  font-size:11px;
  font-weight:900;
  line-height:1.2;
  box-shadow:0 8px 18px rgba(0,0,0,0.08);
  transform: translateY(12px);
  opacity:0;
  pointer-events:none;
  transition: transform .18s ease, opacity .18s ease;
}

#analiseGastos_cardEstabWrap:hover .analiseGastosCardHoverHelp{
  transform: translateY(0);
  opacity:1;
}

/* ===========================
   Modal claro - Detalhe por Estabelecimentos (pivot mensal)
=========================== */
#analiseGastos_estabModal{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
}

#analiseGastos_estabModal.hidden{
  display: none !important;
}

#analiseGastos_estabModalBackdrop{
  position:absolute;
  inset:0;
  background: rgba(15,23,42,0.45);
  backdrop-filter: blur(2px);
}

#analiseGastos_estabModalPanel{
  position:absolute;
  inset: 18px 20px;
  background: #f8fafc;
  border: 1px solid #dbeafe;
  border-radius: 16px;
  box-shadow: 0 28px 60px rgba(2,6,23,0.28);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

#analiseGastos_estabModalHeader{
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  border-bottom: 1px solid #e2e8f0;
  padding: 12px 14px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

#analiseGastos_estabModalTitle{
  font-size: 16px;
  font-weight: 1000;
  color:#0f172a;
  line-height:1.15;
}

#analiseGastos_estabModalSub{
  margin-top:4px;
  font-size:12px;
  font-weight:800;
  color:#475569;
  line-height:1.25;
}

#analiseGastos_estabModalClose{
  border:1px solid #cbd5e1;
  background:#fff;
  color:#0f172a;
  border-radius:12px;
  min-width:40px;
  height:40px;
  font-size:22px;
  font-weight:900;
  line-height:1;
  cursor:pointer;
}

#analiseGastos_estabModalClose:hover{
  border-color:#93c5fd;
  background:#eff6ff;
}

#analiseGastos_estabModalBody{
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
  flex:1;
}

#analiseGastos_estabPivotWrap{
  flex:1;
  min-height:0;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  background:#ffffff;
  overflow:auto;               /* ✅ scroll horizontal e vertical */
  max-height: calc(100vh - 190px);
}

#analiseGastos_estabPivotTable{
  border-collapse: separate;
  border-spacing: 0;
  width: max-content;          /* ✅ permite crescer horizontalmente */
  min-width: 100%;
  color:#0f172a;
  background:#fff;
}

#analiseGastos_estabPivotTable thead th{
  position: sticky;
  top: 0;
  z-index: 3;
  background: #ecfdf5;
  color:#064e3b;
  border-bottom: 2px solid #10b981;
  border-right: 1px solid #d1fae5;
  padding: 10px 10px;
  font-size: 12px;
  font-weight: 1000;
  text-align:center;
  white-space: nowrap;
}

#analiseGastos_estabPivotTable thead th:first-child{
  position: sticky;
  left: 0;
  z-index: 4;
  background: #d1fae5;
  text-align:left;
  min-width: 280px;
}

#analiseGastos_estabPivotTable tbody td,
#analiseGastos_estabPivotTable tfoot td{
  border-right: 1px solid #e2e8f0;
  border-bottom: 1px solid #e2e8f0;
  padding: 8px 10px;
  font-size: 12px;
  white-space: nowrap;
}

#analiseGastos_estabPivotTable tbody td:first-child,
#analiseGastos_estabPivotTable tfoot td:first-child{
  position: sticky;
  left: 0;
  z-index: 2;
  background:#ffffff;
  font-weight: 900;
  min-width: 280px;
  max-width: 420px;
  white-space: normal;
}

#analiseGastos_estabPivotTable tbody tr:nth-child(even) td{
  background:#f8fafc;
}

#analiseGastos_estabPivotTable tbody tr:nth-child(even) td:first-child{
  background:#f8fafc;
}

#analiseGastos_estabPivotTable td.num{
  text-align: right;
  font-weight: 800;
  min-width: 120px;
}

#analiseGastos_estabPivotTable tfoot td{
  position: sticky;
  bottom: 0;
  z-index: 2;
  background:#f0fdf4;
  font-weight: 1000;
  color:#14532d;
  border-top: 2px solid #22c55e;
}

#analiseGastos_estabPivotMsg{
  padding: 18px;
  text-align:center;
  font-size:13px;
  font-weight:900;
  color:#475569;
}

/* =========================
   Modal claro - Mediana por Categoria (Análise de Gastos)
   ========================= */
#analiseGastos_medModal{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;

  /* ✅ garante que o painel centralizado não “estoure” */
  padding: 0;
}

#analiseGastos_medModal.hidden{ display:none !important; }

#analiseGastos_medModalBackdrop{
  position:absolute;
  inset:0;
  background: rgba(15,23,42,0.45);
  backdrop-filter: blur(2px);
}

#analiseGastos_medModalPanel{
  position: absolute;
  left: 50%;
  top: 76px;
  transform: translateX(-50%);

  width: min(980px, calc(100vw - 32px));
  max-height: calc(100vh - 140px);

  background: #f8fafc;
  border: 1px solid #dbeafe;
  border-radius: 18px;
  box-shadow: 0 28px 60px rgba(2,6,23,0.28);

  display:flex;
  flex-direction:column;
  overflow:hidden;
}

#analiseGastos_medModalHeader{
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  border-bottom: 1px solid #e2e8f0;
  padding: 12px 14px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

#analiseGastos_medModalTitle{
  font-size: 16px;
  font-weight: 1000;
  color:#0f172a;
  line-height:1.15;
}
#analiseGastos_medModalSub{
  margin-top:4px;
  font-size:12px;
  font-weight:800;
  color:#475569;
  line-height:1.25;
}

#analiseGastos_medModalClose{
  border:1px solid #cbd5e1;
  background:#fff;
  color:#0f172a;
  border-radius:12px;
  min-width:40px;
  height:40px;
  font-size:22px;
  font-weight:900;
  line-height:1;
  cursor:pointer;
}
#analiseGastos_medModalClose:hover{
  border-color:#93c5fd;
  background:#eff6ff;
}

#analiseGastos_medModalBody{
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:0;
  flex:1;
}

#analiseGastos_medCards{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 920px){
  #analiseGastos_medCards{ grid-template-columns: 1fr; }
}

.analiseGastosMedCard{
  background:#ffffff;
  border:1px solid #e2e8f0;
  border-radius:14px;
  box-shadow:0 10px 22px rgba(0,0,0,0.06);
  padding:12px;
  overflow:hidden;
  position: relative;
}
.analiseGastosMedCard::before{
  content:"";
  position:absolute;
  inset:auto -10% -10% -10%;
  height:62%;
  background:
    radial-gradient(120% 90% at 0% 100%, rgba(181,255,32,0.20) 0%, rgba(181,255,32,0.08) 42%, rgba(181,255,32,0.00) 70%);
  pointer-events:none;
  z-index:0;
}
.analiseGastosMedCard > *{ position:relative; z-index:1; }

.analiseGastosMedCardValue{
  margin-top:6px;
  font-size:20px;
  font-weight:1100;
  color:#0b1220;
}
.analiseGastosMedCardHint{
  margin-top:6px;
  font-size:12px;
  font-weight:800;
  color:#475569;
  line-height:1.25;
}

.analiseGastosMedCard{ padding:10px; }
#analiseGastos_medCards{ gap:10px; }
#analiseGastos_medModalBody{ gap:10px; }

.analiseGastosMedCardHead{
  background:#061a3a;      /* azul marinho */
  color:#ffffff;           /* texto branco */
  border-radius:12px;
  padding:8px 10px;
  font-size:12px;
  font-weight:1100;
  letter-spacing:0.2px;
}

#analiseGastos_medTableWrap{
  flex:1;
  min-height:0;
  border:1px solid #cbd5e1;
  border-radius:14px;
  background:#ffffff;
  overflow:auto;
}

#analiseGastos_medTable{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  color:#0f172a;
  background:#fff;
}

#analiseGastos_medTable thead th{
  position: sticky;
  top: 0;
  z-index: 2;

  background: #061a3a;     /* azul marinho */
  color: #ffffff;          /* texto branco */

  border-bottom: 2px solid rgba(181,255,32,0.55);
  border-right: 1px solid rgba(255,255,255,0.08);

  padding: 10px 10px;
  font-size: 12px;
  font-weight: 1000;
  text-align: center;
  white-space: nowrap;
}

/* ✅ Ordenação no modal (Medianas) */
#analiseGastos_medTable thead th[data-sort]{
  cursor: pointer;
  user-select: none;
}

/* indicador neutro ao passar o mouse */
#analiseGastos_medTable thead th[data-sort]::after{
  content:" ⇅";
  opacity:0;
  transition: opacity .15s ease;
  margin-left:6px;
}
#analiseGastos_medTable thead th[data-sort]:hover::after{
  opacity:0.75;
}

/* setas quando estiver ordenado */
#analiseGastos_medTable thead th[data-sort].asc::after{
  content:" ▲";
  opacity:0.95;
}
#analiseGastos_medTable thead th[data-sort].desc::after{
  content:" ▼";
  opacity:0.95;
}

#analiseGastos_medTable tbody td{
  border-right: 1px solid #e2e8f0;
  border-bottom: 1px solid #e2e8f0;
  padding: 9px 10px;
  font-size: 12px;
  vertical-align: middle;
}

#analiseGastos_medTable tbody tr:nth-child(even) td{
  background:#f8fafc;
}

#analiseGastos_medTable td.num{
  text-align:right;
  font-weight:900;
  white-space: nowrap;
}

#analiseGastos_medMsg{
  padding: 18px;
  text-align:center;
  font-size:13px;
  font-weight:900;
  color:#475569;
}

/* =========================
   Modal full-screen - Fluxograma detalhado (SVG)
   ========================= */
#vektor_fluxoDetModal{
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: none;
}
#vektor_fluxoDetModal.hidden{ display:none !important; }

#vektor_fluxoDetBackdrop{
  position:absolute;
  inset:0;
  background: rgba(2,6,23,0.78);
  backdrop-filter: blur(2px);
}

#vektor_fluxoDetPanel{
  position:absolute;
  inset: 16px;
  border-radius: 18px;
  overflow: hidden;
  background: #0b1220;
  border: 1px solid rgba(148,163,184,0.22);
  box-shadow: 0 28px 70px rgba(0,0,0,0.55);
  display:flex;
  flex-direction:column;
}

#vektor_fluxoDetHeader{
  padding: 12px 14px;
  background: #061a3a;
  color: #fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

#vektor_fluxoDetTitle{
  font-size: 14px;
  font-weight: 1100;
  letter-spacing: 0.2px;
}
#vektor_fluxoDetSub{
  margin-top:2px;
  font-size: 12px;
  font-weight: 800;
  opacity: 0.9;
}

#vektor_fluxoDetActions{
  display:flex;
  align-items:center;
  gap:10px;
}

.vektor_fluxoDetBtn{
  height:36px;
  padding:0 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color:#fff;
  font-weight: 1000;
  font-size: 12px;
  cursor:pointer;
}
.vektor_fluxoDetBtn:hover{ background: rgba(255,255,255,0.12); }

#vektor_fluxoDetClose{
  height:36px;
  width:42px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color:#fff;
  font-weight:1100;
  font-size:18px;
  cursor:pointer;
}

#vektor_fluxoDetBody{
  flex:1;
  min-height:0;
  overflow:auto;
  background:
    radial-gradient(1000px 700px at 15% 0%, rgba(181,255,32,0.10), transparent 55%),
    radial-gradient(900px 650px at 90% 30%, rgba(0,94,39,0.18), transparent 58%),
    #07110c;
  padding: 16px;
}

/* Stage de zoom (escala do SVG) */
#vektor_fluxoDetStageWrap{
  display:flex;
  justify-content:center;
  align-items:flex-start;
}
#vektor_fluxoDetStage{
  transform-origin: top center;
  will-change: transform;
}

/* SVG responsivo e “premium” */
#vektor_fluxoDetSvg{
  width: min(1700px, 96vw);
  height: auto;
  background: #ffffff;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.22);
  box-shadow: 0 16px 42px rgba(0,0,0,0.45);
}

/* =========================
   STATUS (Estado Operacional) - background blur
   ========================= */
.vektor-status-card{
  position: relative;
}

/* layer do fundo */
.vektor-status-card::before{
  content: "";
  position: absolute;
  inset: 0;
  background-image: url("https://raw.githubusercontent.com/rslisboa/cartoesclara/b2a74cc141e69f3940ecaa90855709f743979a34/back_v.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  /* desfoca e deixa bem leve */
  filter: blur(6px);
  opacity: 0.35;

  /* evita borda “fantasma” do blur */
  transform: scale(1.08);

  /* garante que fica atrás do conteúdo */
  z-index: 0;
}

/* conteúdo sempre acima do fundo */
.vektor-status-card > *{
  position: relative;
  z-index: 1;
}

/* =========================
   FLUXOGRAMA - background blur (layer real)
   ========================= */
.vektor-fluxo-bg{
  position: relative;
  overflow: hidden;
  background: transparent !important;
}

.vektor-fluxo-bg-layer{
  position: absolute;
  inset: 0;
  pointer-events: none;

  background-image: url("https://raw.githubusercontent.com/rslisboa/cartoesclara/b2a74cc141e69f3940ecaa90855709f743979a34/back_v.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  filter: blur(6px);
  opacity: 0.30;

  transform: scale(1.12);
  z-index: 0;
}

/* garante que o conteúdo fica por cima */
.vektor-fluxo-bg > :not(.vektor-fluxo-bg-layer){
  position: relative;
  z-index: 2;
}

</style>

<style>
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      height: 24px;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background-color: #94a3b8;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>

  <style>
  /* VEKTOR - APP INVISÍVEL ATÉ LOGIN OK */
  #vektorAppRoot.hidden { display: none !important; }
</style>

<style id="vektorSidebarCollapseStyle">

/* =========================
   SIDEBAR COLLAPSE (menu recolhível)
   ========================= */

#vektorShell.sidebar-collapsed aside{
  width: 72px !important;      /* “modo ícones” */
  padding: 12px !important;
  background: #ffffff !important; 
  border: 1px solid #111827 !important; /* linha preta fina */
}

#vektorShell.sidebar-collapsed aside h1,
#vektorShell.sidebar-collapsed aside #vektorMenuTitle{
  display: none !important;     /* some o título */
}

/* some o texto e deixa só o ícone */
#vektorShell.sidebar-collapsed .vektor-nav-label{
  display: none !important;
}

/* mantém alinhamento bonito no modo recolhido */
#vektorShell.sidebar-collapsed .vektor-nav-btn{
  justify-content: center !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
}

/* evita que o emoji “encolha” */
.vektor-nav-ico{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.5rem;
}

/* no recolhido, centraliza o botão do header */
#vektorShell.sidebar-collapsed #vektorMenuHeader{
  justify-content: center !important;
}

/* garante que “Menu” não aparece */
#vektorShell.sidebar-collapsed #vektorMenuTitle{
  display: none !important;
}

/* garante que o botão fica centralizado */
#vektorShell.sidebar-collapsed #vektorSidebarToggleBtn{
  margin: 0 auto !important;
}

/* remove qualquer “empurrão” do botão */
#vektorShell.sidebar-collapsed #vektorSidebarToggleBtn{
  margin: 0 !important;
}

#vektorShell.sidebar-collapsed #vektorSidebarFooterVersion{
  display: none !important;
}

#vektorMenuHeader{
  position: relative;
}

#vektorMenuTitle{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}

/* Tooltip no menu recolhido */
#vektorShell.sidebar-collapsed aside button{
  position: relative;
}

/* =========================
   MENU RECOLHIDO - clarear botões para destacar emojis
   ========================= */
/* ✅ Clareia apenas os botões de navegação (não pega a seta/toggle) */
#vektorShell.sidebar-collapsed .vektor-nav-btn{
  background: #111827 !important;
  border: 1px solid rgba(148,163,184,0.22) !important;
  color: #f8fafc !important;
}

#vektorShell.sidebar-collapsed .vektor-nav-btn:hover{
  background: #1f2937 !important;
  border-color: rgba(181,255,32,0.35) !important;
  box-shadow: 0 0 0 1px rgba(181,255,32,0.10) inset;
}

/* emoji mais visível no recolhido */
#vektorShell.sidebar-collapsed .vektor-nav-ico{
  font-size: 1.15rem !important; /* aumenta um pouco */
  line-height: 1 !important;
  filter: saturate(1.15) brightness(1.12); /* melhora contraste */
  text-shadow: 0 0 6px rgba(255,255,255,0.10);
}

#vektorShell.sidebar-collapsed aside button:hover::after{
  content: attr(title);
  position: absolute;
  left: calc(100% + 10px);
  top: 50%;
  transform: translateY(-50%);
  white-space: nowrap;

  background: rgba(15,23,42,0.95);
  color: #fff;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 12px;
  line-height: 1.2;
  z-index: 9999;
  pointer-events: none;
}

#vektorShell.sidebar-collapsed .vektor-nav-btn{
  min-height: 44px !important;
}

/* =========================
   HOME HERO - BORDA ANIMADA (CONTORNO REAL via SVG)
   Só aparece com menu expandido
   ========================= */

/* garante referência para overlay */
#homeView{
  position: absolute; /* já está inline; mantido por segurança */
  isolation: isolate;
}

/* SVG ocupa a Home inteira sem alterar tamanho da imagem */
#homeBorderFx{
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 3;
  pointer-events: none;
  opacity: 0;
  transition: opacity .22s ease;
}

/* mostra somente quando menu está EXPANDIDO */
#vektorShell:not(.sidebar-collapsed) #homeBorderFx{
  opacity: 1;
}

/* esconde quando menu está recolhido */
#vektorShell.sidebar-collapsed #homeBorderFx{
  opacity: 0;
}

/* estilos das linhas do SVG */
#homeBorderFx .hb-base,
#homeBorderFx .hb-runner{
  fill: none;
  vector-effect: non-scaling-stroke;
}

/* borda fixa (um pouco mais grossa, discreta) */
#homeBorderFx .hb-base{
  stroke: rgba(181,255,32,0.70);
  stroke-width: 1.6; /* espessura visual no viewBox (escala bem) */
  stroke-linecap: round;
  stroke-linejoin: round;
  filter: drop-shadow(0 0 4px rgba(181,255,32,0.22));
}

/* segmento que "viaja" exatamente pelo contorno */
#homeBorderFx .hb-runner{
  stroke: #B5FF20;
  stroke-width: 2.2; /* um pouco mais grosso que a base */
  stroke-linecap: round;
  stroke-linejoin: round;

  /* pathLength=100 => facilita controlar o segmento */
  /* segmento brilhante curto + resto invisível */
  stroke-dasharray: 7 93;
  stroke-dashoffset: 0;

  filter:
    drop-shadow(0 0 3px rgba(181,255,32,0.85))
    drop-shadow(0 0 8px rgba(181,255,32,0.35));

  animation: homeBorderRunnerLoop 2.8s linear infinite;
}

/* animação apenas com menu expandido */
#vektorShell.sidebar-collapsed #homeBorderFx .hb-runner{
  animation: none;
}

/* loop contínuo no contorno */
@keyframes homeBorderRunnerLoop{
  from { stroke-dashoffset: 0; }
  to   { stroke-dashoffset: -100; }
}

/* acessibilidade */
@media (prefers-reduced-motion: reduce){
  #homeBorderFx .hb-runner{ animation: none !important; }
}

/* =========================
   TOPBAR PREMIUM STRIP (faixa + checkboxes)
   ========================= */

/* container da faixa */
#vektorPremiumStrip .hps-top-inner{ 
  /* ✅ largura limitada e centralizada */
  max-width: min(100%, 1180px);
  width: fit-content;
  margin: 0 auto;

  height: 44px;

  display: inline-flex;          /* ✅ grupo centralizado */
  align-items: center;
  justify-content: center;

  border-radius: 14px;
  background: linear-gradient(
    180deg,
    rgba(0,0,0,0.78) 0%,
    rgba(0,0,0,0.86) 55%,
    rgba(0,0,0,0.78) 100%
  );
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow:
    0 18px 40px rgba(0,0,0,0.22),
    inset 0 1px 0 rgba(255,255,255,0.08);

  backdrop-filter: blur(6px);
  pointer-events: none;

  /* ✅ não estoura, corta o excesso */
  overflow: hidden;

  gap: 18px;
  padding: 0 16px;
}

/* bloco dos 4 checks: não encolhe / não quebra */
#vektorPremiumStrip .hps-steps{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 18px;

  flex: 0 0 auto;     /* ✅ não encolhe */
  white-space: nowrap;
}

/* item (checkbox + label) */
#vektorPremiumStrip .hps-item{
  display: inline-flex;
  align-items: center;
  gap: 8px;

  color: rgba(255,255,255,0.92);
  font-weight: 900;
  font-size: 13px;
  letter-spacing: .2px;
}

/* caixa */
#vektorPremiumStrip .hps-box{
  width: 16px;
  height: 16px;
  border-radius: 4px;
  border: 2px solid rgba(255,255,255,0.55);
  position: relative;
  overflow: hidden;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

/* preenchimento */
#vektorPremiumStrip .hps-box::before{
  content:"";
  position:absolute;
  inset:0;
  background:#B5FF20;
  transform: scaleY(0);
  transform-origin: bottom;
  opacity: 0.95;
}

/* check */
#vektorPremiumStrip .hps-box::after{
  content:"";
  position:absolute;
  left: 4px;
  top: 1px;
  width: 6px;
  height: 10px;
  border-right: 2px solid rgba(0,0,0,0.88);
  border-bottom: 2px solid rgba(0,0,0,0.88);
  transform: rotate(45deg) scale(0);
  transform-origin: center;
  opacity: 0.95;
}

@keyframes hpsFill{
  from { transform: scaleY(0); }
  to   { transform: scaleY(1); }
}
@keyframes hpsCheck{
  from { transform: rotate(45deg) scale(0); opacity: 0; }
  to   { transform: rotate(45deg) scale(1); opacity: 1; }
}

@keyframes hpsItemGlow{
  from { color: rgba(255,255,255,0.70); }
  to   { color: rgba(255,255,255,0.98); text-shadow: 0 0 10px rgba(181,255,32,0.20); }
}

/* frase final: pode encolher e cortar com "..." (sem estourar a largura) */
#vektorPremiumStrip .hps-final{
  color: #ffffff;
  font-weight: 1000;
  font-size: 14px;
  letter-spacing: .2px;

  opacity: 0;
  transform: translateX(48px);

  margin-left: 10px;

  /* ✅ não “puxa” o grupo pro lado */
  flex: 0 0 auto;

  /* ✅ se faltar espaço, corta com ... */
  max-width: 520px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

@keyframes hpsFinalSlideIn{
  from { opacity: 0; transform: translateX(48px); }
  to   { opacity: 1; transform: translateX(0); }
}

/* ======================================================
   ANIMAÇÕES SÓ QUANDO O STRIP ESTIVER "ARMADO" (.hps-run)
   (mantém seus tempos atuais)
   ====================================================== */

#vektorPremiumStrip.hps-run .hps-item{
  animation: hpsItemGlow .55s ease forwards;
  animation-delay: var(--d);
}

#vektorPremiumStrip.hps-run .hps-box::before{
  animation: hpsFill .35s ease forwards;
  animation-delay: calc(var(--d) + .02s);
}

#vektorPremiumStrip.hps-run .hps-box::after{
  animation: hpsCheck .28s ease forwards;
  animation-delay: calc(var(--d) + .14s);
}

#vektorPremiumStrip.hps-run .hps-final{
  animation: hpsFinalSlideIn 1.8s cubic-bezier(.2,.9,.2,1) forwards;
  animation-delay: 5.5s;
}

/* ======================================================
   ESTADO FINAL "CONGELADO" (não reanima ao recolher/expandir)
   ====================================================== */
#vektorPremiumStrip.hps-done .hps-item{
  animation: none !important;
  color: rgba(255,255,255,0.98);
  text-shadow: 0 0 10px rgba(181,255,32,0.20);
}

#vektorPremiumStrip.hps-done .hps-box::before{
  animation: none !important;
  transform: scaleY(1) !important;   /* preenchido */
  opacity: 0.95 !important;
}

#vektorPremiumStrip.hps-done .hps-box::after{
  animation: none !important;
  transform: rotate(45deg) scale(1) !important; /* check visível */
  opacity: 1 !important;
}

#vektorPremiumStrip.hps-done .hps-final{
  animation: none !important;
  opacity: 1 !important;
  transform: translateX(0) !important;
}

@media (prefers-reduced-motion: reduce){
  #vektorPremiumStrip .hps-item,
  #vektorPremiumStrip .hps-box::before,
  #vektorPremiumStrip .hps-box::after,
  #vektorPremiumStrip .hps-final{
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
  }
}

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
 <body class="text-slate-800">

    <!-- Topbar com login, tipo de acesso, relógio e banner sazonal -->
<div id="vektor-topbar"
     class="w-full px-6 pt-3 pb-1 text-[11px] text-black leading-tight flex items-start gap-3">

  <!-- ESQUERDA: login + relógio + logout -->
<div class="shrink-0 flex items-start gap-3">
  <div>
    <div id="vektor-user-info" class="font-semibold"></div>
    <div id="vektor-clock" class="mt-0.5 font-normal"></div>
  </div>

  <button
    id="vektorLogoutBtn"
    type="button"
    class="text-[11px] font-extrabold px-5 py-1 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 transition"
    style="cursor:pointer; margin-top:2px;"
    title="Sair"
  >
    Logout
  </button>
</div>

    <!-- CENTRO: banner (feriado) OU faixa premium (home) -->
  <div class="flex-1 flex items-center justify-center">

    <!-- FERIADO (prioridade máxima) -->
    <div id="vektor-holiday-banner"
         class="w-full flex items-center justify-center text-center font-extrabold"
         style="display:none; font-size:16px; text-shadow: 0 1px 2px rgba(0,0,0,0.15);  line-height:1.3;">
    </div>

    <!-- FAIXA PREMIUM (só na HOME + só menu expandido + não aparece se feriado estiver visível) -->
    <div id="vektorPremiumStrip" class="w-full flex items-center justify-center" style="display:none;">
      <div class="hps-top-inner">
        <div class="hps-steps">
          <div class="hps-item" style="--d:2.1s"><span class="hps-box"></span><span class="hps-label">Segurança</span></div>
          <div class="hps-item" style="--d:3s"><span class="hps-box"></span><span class="hps-label">Controle</span></div>
          <div class="hps-item" style="--d:3.9s"><span class="hps-box"></span><span class="hps-label">Autonomia</span></div>
          <div class="hps-item" style="--d:4.8s"><span class="hps-box"></span><span class="hps-label">Tecnologia</span></div>
        </div>

        <div class="hps-final">
          Vektor - Plataforma de Governança Financeira do Cartão Clara.
        </div>
      </div>
    </div>

  </div>

</div>

<!-- =======================
     MODAL LOGIN (OBRIGATÓRIO)
     ======================= -->
  <div id="vektorLoginModal" class="fixed inset-0 z-[9999] hidden" style="display:none">

  <!-- Título superior (acima do card) -->
<div class="absolute top-10 left-1/2 -translate-x-1/2 w-[95%] max-w-[900px] text-center text-white z-[10020] pointer-events-none">
  <div class="text-[18px] md:text-[22px] font-extrabold tracking-tight drop-shadow-lg">
    Plataforma de Governança Financeira do Cartão Clara
  </div>
</div>

  <!-- camada que ESCONDE 100% de tudo atrás -->
  <div class="absolute inset-0 bg-white"></div>

  <!-- camada de escurecimento (visual) -->
  <div class="absolute inset-0 bg-black/60"></div>

  <!-- conteúdo do modal (CENTRALIZADO DE VERDADE) -->
  <div class="absolute inset-0 flex items-center justify-center">
  <!-- Camada decorativa (logos), atrás do card -->
  <div class="absolute inset-0 pointer-events-none">
    <!-- Logo esquerda -->
    <img
      src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b4a49fd8563aa5311a25d23c977061710da8042b/LOGO%20-%20VERDE%2001.png"
      alt=""
      class="absolute left-10 top-1/2 -translate-y-1/2 w-[320px] opacity-45 blur-[1.5px] hidden md:block"
    />

    <img
      src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b4a49fd8563aa5311a25d23c977061710da8042b/LOGO%20-%20VERDE%2001.png"
      alt=""
      class="absolute right-10 top-1/2 -translate-y-1/2 w-[320px] opacity-45 blur-[1.5px] hidden md:block"
    />
  </div>

  <!-- Card do login (fica acima das logos) -->
  <div class="relative w-[95%] max-w-[520px] rounded-2xl bg-white shadow-2xl border border-slate-200 overflow-hidden">

      <!-- Header -->
      <div class="px-6 py-5 bg-[#0b1220] text-white">
        <div class="text-lg font-extrabold">Acesso ao Vektor</div>
        <div class="text-xs opacity-90 mt-1">
          Validação obrigatória. O e-mail deve ser o mesmo do seu login Google e estar habilitado.
        </div>
      </div>

      <!-- Body -->
        <div class="px-6 py-5">
          <label class="block text-sm font-semibold text-slate-800 mb-2">
            E-mail corporativo
          </label>

          <input
            id="vektorLoginEmail"
            type="email"
            autocomplete="email"
            placeholder="insira seu email aqui"
            class="w-full rounded-xl border border-slate-300 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-slate-900/20"
          />

          <div
            id="vektorLoginError"
            class="hidden mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl px-4 py-3"
          ></div>

          <!-- BOTÕES (mesmo tamanho, alinhados) -->
          <div class="mt-4 grid grid-cols-2 gap-3">

            <!-- Login com Google -->
            <button
              id="vektorLoginGoogleBtn"
              type="button"
              class="flex items-center justify-center gap-2 h-[48px] rounded-xl border border-slate-300 text-sm font-semibold text-slate-800 hover:bg-slate-50 transition"
            >
              <img
                src="https://raw.githubusercontent.com/rslisboa/cartoesclara/e99ecd5a39c515e09bac6546c9aa5d2324c243c2/google.png"
                alt=""
                class="w-[16px] h-[16px]"
              />
              <span>Login com Google</span>
            </button>

            <!-- Entrar -->
            <button
              id="vektorLoginBtn"
              type="button"
              class="h-[48px] rounded-xl bg-[#005E27] text-white text-sm font-extrabold hover:opacity-95 transition"
            >
              Entrar
            </button>

          </div>

          <div class="mt-3 text-[11px] text-slate-500">
            Se você não tiver acesso, solicite inclusão na whitelist do Vektor.
          </div>
        </div>

    </div>
  </div>
</div>

  <!-- =======================
     OVERLAY MANUTENÇÃO
     ======================= -->
<div id="vektorMaintenanceOverlay" class="fixed inset-0 z-[10050] hidden" style="display:none">
  <!-- fundo (mantém o padrão branco) -->
  <div class="absolute inset-0 bg-white"></div>

  <!-- conteúdo central -->
  <div class="absolute inset-0 flex items-center justify-center">
    <div class="w-[95%] max-w-[560px] rounded-2xl bg-white border border-slate-200 shadow-2xl p-6 text-center">
      <div class="text-2xl font-extrabold text-slate-900">Em manutenção</div>
      <div class="mt-2 text-sm text-slate-600">
        O Vektor está temporariamente indisponível. Tente novamente mais tarde.
      </div>
    </div>
  </div>
</div>

<script>
/**
 * VEKTOR — Single Tab Guard (aba única)
 * Regra: a aba mais recente toma posse e desativa a anterior.
 * - Usa localStorage (compatível geral)
 * - Usa BroadcastChannel quando disponível (mais rápido)
 */
(function vektorSingleTabGuard_(){
  const LOCK_KEY = "VEKTOR_ACTIVE_TAB_LOCK";
  const CHANNEL  = "vektor-single-tab";
  const HEARTBEAT_MS = 5000;     // atualiza "vida" da aba dona
  const STALE_MS = 15000;        // se não bater heartbeat nesse tempo, considera morto
  const TAKEOVER_GRACE_MS = 800; // evita flicker em loads rápidos

  // id único da aba (vive enquanto a aba existir)
  let tabId = "";
  try {
    tabId = sessionStorage.getItem("VEKTOR_TAB_ID") || "";
    if (!tabId) {
      tabId = (window.crypto && crypto.randomUUID) ? crypto.randomUUID()
        : (String(Date.now()) + "_" + Math.random().toString(16).slice(2));
      sessionStorage.setItem("VEKTOR_TAB_ID", tabId);
    }
  } catch (e) {
    // fallback: ainda dá pra funcionar, só menos robusto
    tabId = "tab_" + String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  }

  const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(CHANNEL) : null;

  function now_(){ return Date.now(); }

  function safeJsonParse_(s){
    try { return JSON.parse(s); } catch (e) { return null; }
  }

  function readLock_(){
    return safeJsonParse_(localStorage.getItem(LOCK_KEY) || "null");
  }

  function writeLock_(obj){
    localStorage.setItem(LOCK_KEY, JSON.stringify(obj || {}));
  }

  function removeLock_(){
    localStorage.removeItem(LOCK_KEY);
  }

  function isStale_(lock){
    if (!lock || !lock.ts) return true;
    return (now_() - Number(lock.ts || 0)) > STALE_MS;
  }

  function showDisabledOverlay_(title, msg){
    let el = document.getElementById("vektorSingleTabOverlay");
    if (!el) {
      el = document.createElement("div");
      el.id = "vektorSingleTabOverlay";
      el.className = "fixed inset-0 z-[10060]";
      el.style.display = "none";
      el.innerHTML = `
        <div class="absolute inset-0 bg-white"></div>
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="w-[95%] max-w-[560px] rounded-2xl bg-white border border-slate-200 shadow-2xl p-6 text-center">
            <div id="vektorSingleTabOverlayTitle" class="text-2xl font-extrabold text-slate-900"></div>
            <div id="vektorSingleTabOverlayMsg" class="mt-2 text-sm text-slate-600"></div>
            <div class="mt-4 text-[11px] text-slate-500">
              Esta guia foi desativada para evitar múltiplas sessões abertas. Use a guia mais recente.
            </div>
          </div>
        </div>`;
      document.body.appendChild(el);
    }

    el.querySelector("#vektorSingleTabOverlayTitle").textContent = title || "Aba desativada";
    el.querySelector("#vektorSingleTabOverlayMsg").textContent = msg || "";
    el.style.display = "block";
  }

  function hideDisabledOverlay_(){
    const el = document.getElementById("vektorSingleTabOverlay");
    if (el) el.style.display = "none";
  }

  function forceLogoutUI_(reason){
    // 1) tenta clicar no Logout (se existir)
    try {
      const btn = document.getElementById("vektorLogoutBtn");
      if (btn) btn.click();
    } catch (e) {}

    // 2) mostra mensagem no modal de login (se existir)
    try {
      const err = document.getElementById("vektorLoginError");
      if (err) {
        err.classList.remove("hidden");
        err.textContent = reason || "Sessão movida para outra aba.";
      }
      const modal = document.getElementById("vektorLoginModal");
      if (modal) modal.style.display = "block";
    } catch (e) {}

    // 3) esconde app root (se existir)
    try {
      const root = document.getElementById("vektorAppRoot");
      if (root) root.classList.add("hidden");
    } catch (e) {}
  }

  function disableThisTab_(lockOwnerId){
    if (window.__vektorTabDisabled) return;
    window.__vektorTabDisabled = true;

    forceLogoutUI_("Você abriu o Vektor em outra guia. Esta guia foi desativada.");

    showDisabledOverlay_(
      "Esta aba foi desativada",
      "Você abriu o Vektor em outra guia. Use a guia mais recente."
    );
  }

  function enableThisTab_(){
    if (!window.__vektorTabDisabled) return;
    window.__vektorTabDisabled = false;
    hideDisabledOverlay_();
  }

  function broadcast_(payload){
    try { if (bc) bc.postMessage(payload); } catch (e) {}
  }

  function takeover_(why){
    const ts = now_();
    writeLock_({ tabId, ts });
    broadcast_({ type: "TAKEOVER", tabId, ts, why: why || "" });
  }

  // Regra: SEMPRE que esta aba carregar, ela toma posse (aba mais recente manda).
  // Pequena graça pra evitar flicker em refresh instantâneo.
  setTimeout(function(){
    takeover_("init");
    enableThisTab_();
  }, TAKEOVER_GRACE_MS);

  // Heartbeat: se eu sou dono, atualizo timestamp
  setInterval(function(){
    const lock = readLock_();
    if (lock && lock.tabId === tabId) {
      writeLock_({ tabId, ts: now_() });
    }
  }, HEARTBEAT_MS);

  // Se outra aba tomar posse (localStorage), eu desativo
  window.addEventListener("storage", function(e){
    if (e.key !== LOCK_KEY) return;

    const lock = readLock_();
    if (!lock) return;

    // se eu não sou dono e o lock está vivo, desabilita
    if (lock.tabId !== tabId && !isStale_(lock)) {
      disableThisTab_(lock.tabId);
    }
  });

  // BroadcastChannel: resposta mais rápida que storage event
  if (bc) {
    bc.onmessage = function(ev){
      const m = ev && ev.data ? ev.data : null;
      if (!m || m.type !== "TAKEOVER") return;

      if (m.tabId !== tabId) {
        // alguém tomou posse
        const lock = readLock_();
        if (lock && lock.tabId !== tabId && !isStale_(lock)) {
          disableThisTab_(lock.tabId);
        }
      }
    };
  }

  // Se eu fechar e eu era dono, removo lock (boa prática; heartbeat já cobre queda)
  window.addEventListener("beforeunload", function(){
    const lock = readLock_();
    if (lock && lock.tabId === tabId) {
      removeLock_();
      broadcast_({ type: "RELEASE", tabId, ts: now_() });
    }
  });

  // Export (debug manual)
  window.vektorSingleTabTakeover = function(){
    takeover_("manual");
    enableThisTab_();
  };
})();
</script>

 <div id="vektorAppRoot" class="hidden">
 <div id="vektorShell" class="h-screen flex px-4 py-6 gap-4 items-stretch overflow-hidden">
   <!-- COLUNA ESQUERDA: MENU LATERAL -->
   
  <aside class="hidden md:flex w-72 shrink-0 flex-none flex-col bg-white rounded-xl shadow-lg border border-slate-200 p-4 self-stretch min-h-0">

  <!-- Bloco Vektor + título -->
  <div class="w-full flex flex-col items-center mb-4">
    <h1 class="text-xl font-extrabold bg-[#005E27] text-[#B5FF20] px-3 py-2 rounded-lg text-center">
      Grupo SBF | Vektor
    </h1>
  </div>

  <!-- Header do menu: título + recolher -->
<div id="vektorMenuHeader" class="w-full mb-1 flex items-center justify-between">
  <p id="vektorMenuTitle" class="text-base font-semibold text-black m-0">Menu</p>

  <button
    id="vektorSidebarToggleBtn"
    type="button"
    class="w-9 h-9 inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition"
    title="Recolher/Expandir menu"
    aria-label="Recolher/Expandir menu"
    style="cursor:pointer;"
  >
    <!-- ícone simples -->
    <span id="vektorSidebarToggleIcon" style="font-size:18px; line-height:1;">⫷</span>
  </button>
</div>

 <!-- Conteúdo rolável do menu (botões) -->
<div class="flex-1 min-h-0 overflow-y-auto space-y-3.5 pb-2.5">

  <!-- Apresentação Vektor desativada -->
  <!-- Relatório Clara (Looker Studio) desativado -->

  <button
    id="navChatBtn"
    type="button"
    onclick="window.vektorShowChatView()"
    title="Chat"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">💬</span>
    <span class="vektor-nav-label">Chat</span>
  </button>

  <button
    type="button"
    onclick="openStatusVektorModal()"
    title="Estado Operacional"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">🟢</span>
    <span class="vektor-nav-label">Estado Operacional</span>
  </button>

  <button
    type="button"
    onclick="window.vektorOpenResumoCiclo()"
    title="Pendências do Ciclo"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">📌</span>
    <span class="vektor-nav-label">Pendências do Ciclo</span>
  </button>

    <button
    type="button"
    onclick="window.vektorOpenAnaliseGastos()"
    title="Análise de Gastos"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">🔍</span>
    <span class="vektor-nav-label">Análise de Gastos</span>
  </button>

  <button
    type="button"
    onclick="window.vektorOpenFluxograma()"
    title="Fluxograma"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">🧩</span>
    <span class="vektor-nav-label">Fluxograma</span>
  </button>

  <button
    type="button"
    onclick="window.vektorOpenMyAlerts()"
    title="Alertas Programados"
    class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
  >
    <span class="vektor-nav-ico" aria-hidden="true">⏱️</span>
    <span class="vektor-nav-label">Alertas Programados</span>
  </button>

  <? if ((userRole || "") === "Administrador") { ?>

    <button
      type="button"
      onclick="openAlertasRecentesModal()"
      title="Disparo de Ocorrências"
      class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
    >
      <span class="vektor-nav-ico" aria-hidden="true">📋</span>
      <span class="vektor-nav-label">Disparo de Ocorrências</span>
    </button>

    <button
      type="button"
      onclick="window.vektorOpenRadar('7d')"
      title="Radar de Irregularidade"
      class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
    >
      <span class="vektor-nav-ico" aria-hidden="true">📈</span>
      <span class="vektor-nav-label">Radar de Irregularidade</span>
    </button>

    <button
      type="button"
      onclick="window.vektorOpenEnvioPendencias()"
      title="Envio de Pendências"
      class="w-full inline-flex items-center justify-center rounded-lg bg-black text-white text-sm font-semibold px-3 py-2 hover:bg-slate-900 transition"
    >
      <span class="vektor-nav-ico" aria-hidden="true">📩</span>
      <span class="vektor-nav-label">Envio de Pendências</span>
    </button>

  <? } ?>

</div>

  <!-- Rodapé do menu: Versão do Vektor -->
<div id="vektorSidebarFooterVersion" class="mt-4 px-3 py-3 text-center border-t border-slate-200">
  <div class="text-[11px] text-slate-500 leading-tight">
    Vektor v1.9.0<br>
    <span class="text-slate-400">Build 25/02/2026</span>
  </div>
</div>
  
</aside>
 
   <!-- COLUNA DIREITA: CHAT -->
   <div class="flex-1 min-w-0 min-h-0" style="position:relative; overflow:hidden;">
     <div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
  <div class="chat-header-inner">
    <div class="chat-header-left">
      <div class="examples"></div>
      <div class="policy-note text-[12px] mt-2"></div>
    </div>
  </div>
</header>

<!-- HOME (aparece ao carregar o sistema) -->
<div id="homeView"
     style="position:absolute; inset:0; width:100%; height:100%; display:flex; align-items:stretch; justify-content:stretch; overflow:hidden; opacity:0; filter:blur(10px); transition:opacity 900ms ease, filter 900ms ease; z-index:1;">
  <img id="homeHeroImg"
       src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b4a53c6c2516825897ee0080048ddab3f57c0964/sys_vek_2.png"
       alt="Vektor"
       style="width:100%; height:100%; object-fit:cover; object-position:center center; display:block;"/>

         <!-- Overlay SVG da borda animada da Home (somente menu expandido via CSS) -->
  <svg id="homeBorderFx"
       viewBox="0 0 100 100"
       preserveAspectRatio="none"
       aria-hidden="true">
    <!-- borda base (fixa) -->
    <rect class="hb-base"
          x="1.2" y="1.2" width="97.6" height="97.6"
          rx="2.2" ry="2.2"
          pathLength="100" />
    <!-- segmento animado (ponto/trilha viajando pelo contorno) -->
    <rect class="hb-runner"
          x="1.2" y="1.2" width="97.6" height="97.6"
          rx="2.2" ry="2.2"
          pathLength="100" />
  </svg> 

</div>

<!-- BODY -->
<div id="chatView" class="hidden" style="height:100%; display:none; flex-direction:column; min-height:0;">
  <main class="chat-body">
    <div id="chatWindow" class="chat-window">

      <!-- Mensagem inicial do bot -->
      <div class="flex items-start gap-3">
        <img
          src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
          alt="Assistente Clara (robô)"
          class="h-16 w-auto object-contain flex-shrink-0"
        />
        <div class="bot-bubble px-4 py-3 max-w-[80%] text-slate-700">
          <p id="vektorGreeting" class="text-slate-800 text-base">
          </p>
          
        </div>
      </div>

    </div> <!-- fecha #chatWindow -->
  </main> <!-- fecha .chat-body -->

<!-- FOOTER / INPUT (AGORA DENTRO DO chatView) -->
  <footer class="chat-footer">
    <form id="chatForm" class="w-full">
      <div class="input-shell">
        <textarea id="userInput" placeholder="Digite aqui."></textarea>

        <!-- AUTOCOMPLETE VEKTOR -->
        <div id="vektor-autocomplete-box"></div>

        <!-- Botão de anexo do Termo -->
        <button
          type="button"
          id="attachBtn"
          title="Anexar"
          class="ml-1 px-2 py-2 rounded-md border border-slate-300 text-sm flex items-center justify-center bg-transparent"
        >
          <svg xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 24 24" stroke-width="2"
            stroke="#0f172a" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M21 12.79V9a6 6 0 10-12 0v7a4 4 0 008 0v-6a2 2 0 00-4 0v5"/>
          </svg>
        </button>

        <!-- Botão Enviar -->
        <button type="submit" id="sendBtn">Enviar</button>

        <!-- Input de arquivo escondido (Termo) -->
        <input
          type="file"
          id="fileTermo"
          accept=".pdf,.jpg,.jpeg,.png,.heic,.HEIC"
          class="hidden"
        />
      </div>
    </form>
  </footer>
</div> <!-- fecha #chatView -->

<!-- VIEW: RESUMO DO CICLO -->
<div id="cicloResumoView"
     class="hidden"
     style="position:absolute; inset:0; z-index:20; display:none;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column; min-height:0;">

      <!-- Header (título/sub + filtros) -->
      <div style="padding:14px 16px; background:#0b1220; border-bottom:1px solid rgba(148,163,184,0.18);">
        <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:14px; flex-wrap:wrap;">

          <!-- Esquerda: título + subtítulo -->
          <div style="min-width:240px;">
            <div style="font-size:18px;font-weight:1000;color:#fff;line-height:1.1;">Pendências do ciclo</div>
            <div id="cicloResumoSubTitle"
                 style="margin-top:5px;font-size:12px;font-weight:800;color:rgba(226,232,240,0.8);">
              Consolidado das pendências no ciclo atual, considerando transações com status <b>Autorizada</b>.
            </div>
          </div>

          <!-- Direita: filtros -->
          <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;">

            <!-- Período -->
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Período</div>

              <!-- ✅ APENAS 1 BLOCO DE CALENDÁRIO (não duplique IDs) -->
              <div style="display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid rgba(226,232,240,0.45); border-radius:12px; background:rgba(226,232,240,0.85);">
                <input id="cicloResumo_dtIni" type="date"
                       style="border:none; outline:none; background:rgba(255,255,255,0.06); border-radius:10px; padding:4px 8px; color:#000000; font-weight:800; font-size:12px;" />
                <span style="opacity:0.65;">—</span>
                <input id="cicloResumo_dtFim" type="date"
                       style="border:none; outline:none; background:rgba(255,255,255,0.06); border-radius:10px; padding:4px 8px; color:#000000; font-weight:800; font-size:12px;" />
              </div>
            </div>

            <!-- Time -->
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Time</div>
              <select id="cicloResumo_selTime"
                      style="height:34px;border-radius:12px;background:#0f172a;color:#fff;border:1px solid rgba(181,255,32,0.35);padding:0 10px;font-weight:900;font-size:12px;min-width:180px;">
                <option value="">Todos</option>
              </select>
            </div>

            <!-- Loja -->
            <div style="display:flex; flex-direction:column; gap:6px;">
              <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Loja</div>
              <select id="cicloResumo_selLoja"
                      style="height:34px;border-radius:12px;background:#0f172a;color:#fff;border:1px solid rgba(181,255,32,0.35);padding:0 10px;font-weight:900;font-size:12px;min-width:180px;">
                <option value="">Todas</option>
              </select>
            </div>

           <button id="cicloResumo_btnLimpar" type="button"
              onclick="window.vektorResumoCicloLimparFiltros && window.vektorResumoCicloLimparFiltros()"
              style="height:34px;border-radius:12px;padding:0 14px;background:transparent;color:#B5FF20;border:1px solid rgba(181,255,32,0.45);font-weight:1000; font-size: 12px; cursor:pointer;">
                    Limpar
                  </button>

            <button id="cicloResumo_btnAtualizar" type="button"
                    onclick="window.vektorLoadResumoCiclo && window.vektorLoadResumoCiclo(true)"
                    style="height:34px;border-radius:12px;padding:0 14px;background:rgba(255,255,255,0.06);color:#fff;border:1px solid rgba(255,255,255,0.18);font-weight:1000; font-size: 12px; cursor:pointer;">
              Atualizar
            </button>

                      <button id="cicloResumo_aiBtn" type="button"
                          style="
                            height:34px;
                            padding:0 14px;
                            border-radius:12px;
                            border:1px solid rgba(181,255,32,0.55);
                            background: linear-gradient(180deg, rgba(22,163,74,0.55), rgba(0,94,39,0.55));
                            font-weight:1000;
                            font-size: 12px;
                            color:#ffffff;
                            box-shadow:0 10px 22px rgba(0,0,0,0.18);
                            cursor:pointer;
                            white-space:nowrap;
                          ">
                          Análise do Ciclo
                        </button>

          </div>
        </div>
      </div>

      <!-- Conteúdo -->
      <div class="cicloResumoPage" style="flex:1; min-height:0; overflow:auto; background:#fff; padding:14px 16px;">
        
        <div id="cicloResumoContent" style="display:none;">

          <!-- Cards (mantém layout “como era” – cards em cima) -->
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:stretch;">
            <div class="cicloCard">
              <div class="cicloCardLabel">🏬 Lojas com pendências</div>
              <div id="cicloResumo_totalLojas" class="cicloCardValue">—</div>
            </div>

            <!-- ✅ sem clique -->
            <div class="cicloCard" id="cicloResumo_cardTotalPend" style="cursor:default;">
              <div class="cicloCardLabel">🧾 Qtde de pendências</div>
              <div id="cicloResumo_totalPend" class="cicloCardValue">—</div>
            </div>

            <div class="cicloCard">
              <div class="cicloCardLabel">💰 Valor pendente</div>
              <div id="cicloResumo_totalValor" class="cicloCardValue">—</div>
            </div>

            <!-- ✅ sem clique -->
            <div class="cicloCard" id="cicloResumo_cardTopTime" style="cursor:default;">
              <div class="cicloCardLabel">🏆 Top time (mais pendências)</div>
              <div id="cicloResumo_topTime" class="cicloCardValue">—</div>
              <div id="cicloResumo_topTimeSub" class="cicloCardSub">—</div>
            </div>

            <div class="cicloCard">
              <div class="cicloCardLabel">🔥 Top loja (mais pendências)</div>
              <div id="cicloResumo_topLoja" class="cicloCardValue">—</div>
              <div id="cicloResumo_topLojaSub" class="cicloCardSub">—</div>
            </div>

          </div>

          <!-- Tabela (transações detalhadas / filtradas) -->
         <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 8px 0;">
            <div style="font-weight:1000; font-size:13px;">
              Transações pendentes (detalhado) — ordene clicando no cabeçalho
            </div>

            <button id="cicloResumo_btnCsv"
              style="border:none; cursor:pointer; border-radius:10px; padding:6px 10px; font-weight:900;
                    font-size:12px; background:#0f172a; color:#fff; border:1px solid rgba(148,163,184,0.35);">
              Exportar CSV
            </button>

          </div>

            <!-- wrapper com scroll vertical + horizontal -->
            <div id="cicloResumoTableWrap"
                 style="margin-top:10px; overflow:auto; max-height:520px; border-radius:12px; border:2px solid #000; background:#fff;">

              <table id="cicloResumoTable"
                     style="width:max-content; min-width:100%; border-collapse:separate; border-spacing:0; font-size:13px; color:#000; background:#fff;">
                <thead>
                  <tr>
                    <th data-sort="loja"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Loja
                    </th>

                    <th data-sort="time"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Time
                    </th>

                    <th data-sort="dataISO"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Data da transação
                    </th>

                    <th data-sort="estabelecimento"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Estabelecimento
                    </th>

                    <th data-sort="valor"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:right; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Valor
                    </th>

                    <th data-sort="categoria"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-right:2px double #005E27; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Categoria
                    </th>

                    <th data-sort="pendencias"
                        style="position:sticky; top:0; z-index:2; background:#12325c; color:#fff; padding:10px; text-align:left; border-bottom:2px double #005E27; cursor:pointer; white-space:nowrap;">
                      Pendências
                    </th>
                  </tr>
                </thead>

                <tbody id="cicloResumo_tbody"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <!-- ✅ OVERLAY IA: FORA da tabela e FORA do grid (não quebra layout) -->
      <div id="cicloResumoAI" style="display:none; position:fixed; inset:0; z-index:120; background:rgba(2,6,23,0.55);">
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
            width:min(920px, 94vw);
            max-height:86vh;               /* ✅ garante que cabe na tela */
            border-radius:18px; overflow:hidden;
            border:1px solid rgba(148,163,184,0.55);
            box-shadow:0 22px 60px rgba(0,0,0,0.35);
            display:flex; flex-direction:column;">
          <div style="background:#0b1220; color:#fff; padding:14px 16px; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:1000;">Análise do Ciclo</div>
            <button id="cicloResumoAIClose" type="button"
              style="background:rgba(255,255,255,0.12); padding:8px 12px; border-radius:12px; font-weight:900; color:#fff; border:1px solid rgba(255,255,255,0.18); cursor:pointer;">
              Fechar
            </button>
          </div>
          <div id="cicloResumoAIBody"
            style="background:#fff; padding:14px 16px; color:#0f172a;
            overflow:auto;                 /* ✅ scroll vertical quando precisar */
            max-height:calc(86vh - 56px);  /* ✅ 56px ≈ header do modal */
            -webkit-overflow-scrolling:touch;">
            <!-- preenchido via JS -->
          </div>
        </div>
      </div>

      <!-- OVERLAY (bloqueia tela) - Resumo do Ciclo -->
<div id="cicloResumo_overlay"
     style="display:none; position:absolute; inset:0; z-index:110; background:rgba(0,0,0,0.65);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
    <div style="width:min(520px, 92vw); background:#0b1220; border:1px solid rgba(148,163,184,0.22);
                border-radius:16px; padding:18px; box-shadow:0 18px 46px rgba(0,0,0,0.55); text-align:center;">
      <div style="display:flex; justify-content:center; margin-bottom:12px;">
        <div class="envPend_spinner"></div>
      </div>
      <div id="cicloResumo_overlayTitle" style="color:#fff; font-weight:1000; font-size:16px;">Carregando…</div>
      <div id="cicloResumo_overlaySub" style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:6px;">
        Aguarde um instante.
      </div>
    </div>
  </div>
</div>

    </div>
  </main>
</div>

<!-- VIEW: ANALISE DE GASTOS -->
<div id="analiseGastosView"
     class="hidden"
     style="position:absolute; inset:0; z-index:20; display:none;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column; min-height:0;">

            <!-- Header (título/sub + filtros + Macro Visões) -->
      <div style="padding:14px 16px; background:#0b1220; border-bottom:1px solid rgba(148,163,184,0.18);">
        
        <!-- Linha superior: título/sub + Macro Visões -->
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;">
          <!-- Esquerda: título + subtítulo -->
          <div style="min-width:260px;">
            <div style="font-size:18px;font-weight:1000;color:#fff;line-height:1.1;">Análise de gastos</div>
            <div id="analiseGastosSubTitle"
                 style="margin-top:5px;font-size:12px;font-weight:800;color:rgba(226,232,240,0.8);">
              Análise dos gastos por período, com identificação dos maiores valores por loja, categoria e estabelecimento.
            </div>
          </div>

          <!-- Direita superior: botões -->
          <div style="display:flex; align-items:flex-start; gap:8px; margin-left:auto;">
            <button id="analiseGastos_btnMediana" type="button"
                  style="height:36px; padding:0 14px; border:1px solid rgba(148,163,184,0.35); border-radius:10px; font-weight:900; font-size:12px; background:rgba(255,255,255,0.06); color:#ffffff; cursor:pointer; white-space:nowrap;">
            Média de Gastos
          </button>
            <button id="analiseGastos_btnBuscar" type="button"
                    style="height:36px; padding:0 14px; border:none; border-radius:10px; font-weight:900; font-size:12px; background:#006b2c; color:#ffffff; cursor:pointer; white-space:nowrap;">
              Buscar
            </button>

            <button id="analiseGastos_btnMacroVisoes" type="button"
                    style="height:36px; padding:0 14px; border:1px solid rgba(181,255,32,0.35); border-radius:10px; font-weight:900; font-size:12px; background:rgba(181,255,32,0.10); color:#eaffb8; cursor:pointer; white-space:nowrap;">
              Macro Visões
            </button>
          </div>
        </div>

        <!-- Linha inferior: filtros -->
        <div id="analiseGastosFilterRow"
             style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap; justify-content:flex-start; width:100%; margin-top:14px;">

          <!-- Ano -->
          <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 120px; min-width:120px;">
            <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Ano</div>
            <select id="analiseGastos_selAno"
                    style="height:40px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
              <option value="">Todos</option>
            </select>
          </div>

          <!-- Mês -->
          <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 150px; min-width:150px;">
            <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Mês</div>
            <select id="analiseGastos_selMes"
                    style="height:40px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
              <option value="">Todos</option>
            </select>
          </div>

          <!-- Período -->
          <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 auto;">
            <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Período</div>

            <div class="analiseGastosPeriodoBox"
                 style="display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid rgba(226,232,240,0.45); border-radius:12px; background:rgba(226,232,240,0.85);">
              <input id="analiseGastos_dtIni" type="date"
                     style="width:150px; min-width:150px; max-width:150px; box-sizing:border-box; border:none; outline:none; background:rgba(255,255,255,0.06); border-radius:10px; padding:4px 8px; color:#000000; font-weight:800; font-size:12px; text-align:center;" />
              <span style="opacity:0.65; min-width:14px; text-align:center;">—</span>
              <input id="analiseGastos_dtFim" type="date"
                     style="width:150px; min-width:150px; max-width:150px; box-sizing:border-box; border:none; outline:none; background:rgba(255,255,255,0.06); border-radius:10px; padding:4px 8px; color:#000000; font-weight:800; font-size:12px; text-align:center;" />
            </div>
          </div>

          <!-- Time -->
          <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 170px; min-width:170px;">
            <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Time</div>
            <select id="analiseGastos_selTime" multiple size="1"
                    style="height:40px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
              <option value="">Carregue os filtros...</option>
            </select>
          </div>

          <!-- Loja -->
          <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 160px; min-width:160px;">
            <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Loja</div>
            <select id="analiseGastos_selLoja" multiple size="1"
                    style="height:40px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
              <option value="">Carregue os filtros...</option>
            </select>
          </div>

          <!-- Categoria -->
          <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 200px; min-width:200px;">
            <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Categoria</div>
            <select id="analiseGastos_selCategoria" multiple size="1"
                    style="height:40px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
              <option value="">Carregue os filtros...</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Conteúdo -->
      <div style="flex:1; min-height:0; overflow:hidden; padding:14px 16px;">

        <!-- Overlay -->
        <div id="analiseGastos_overlay"
             class="hidden"
             style="position:absolute; inset:0; z-index:50; display:none; background:rgba(15,23,42,0.55);">
          <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
            <div style="width:min(520px, 92vw); background:#fff; border-radius:16px; border:1px solid rgba(226,232,240,1); box-shadow:0 30px 60px rgba(0,0,0,0.25); padding:16px;">
              <div id="analiseGastos_overlayTitle" style="font-size:16px; font-weight:1000; color:#0b1220;">Carregando…</div>
              <div id="analiseGastos_overlaySub" style="margin-top:6px; font-size:12px; font-weight:800; color:#334155;">Aguarde</div>
              <div style="margin-top:12px; display:flex; align-items:center; gap:10px;">
                <div class="vektor-spinner"></div>
                <div style="font-size:12px; font-weight:900; color:#0f172a;">Processando informações, aguarde...</div>
              </div>
            </div>
          </div>
        </div>

                <!-- MODAL: Macro Visões (independente da tela principal) -->
        <div id="analiseGastos_macroModal"
             class="hidden"
             style="position:absolute; inset:0; z-index:70; display:none; background:rgba(2,6,23,0.72);">
          <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
            <div style="width:min(1180px, 96vw); height:min(86vh, 900px); background:linear-gradient(180deg,#071227 0%, #0b1220 100%); border:1px solid rgba(148,163,184,0.22); border-radius:16px; box-shadow:0 40px 80px rgba(0,0,0,0.45); display:flex; flex-direction:column; overflow:hidden;">

              <!-- Header do modal -->
              <div style="padding:14px 16px; border-bottom:1px solid rgba(148,163,184,0.16); display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
                <div>
                  <div style="font-size:16px; font-weight:1000; color:#ffffff;">Visão Mensal de Valores</div>
                  <div style="margin-top:4px; font-size:12px; font-weight:800; color:rgba(226,232,240,0.75);">
                    Séries mensais consolidadas (somatória) com linha de variação percentual e visões por <b>Lojas</b> e <b>Categorias</b>.
                  </div>
                </div>
                <button id="analiseGastos_btnMacroFechar" type="button"
                        style="height:34px; min-width:34px; padding:0 10px; border:1px solid rgba(148,163,184,0.35); border-radius:10px; background:rgba(15,23,42,0.7); color:#fff; font-weight:1000; cursor:pointer;">
                  ✕
                </button>
              </div>

              <!-- Filtros do modal -->

              <div style="padding:12px 16px; border-bottom:1px solid rgba(148,163,184,0.12); display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap;">
                <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 180px; min-width:180px;">
                  <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Loja (Macro)</div>
                  <select id="analiseGastos_macro_selLoja"
                          style="height:38px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
                    <option value="">Todas</option>
                  </select>
                </div>

                <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 240px; min-width:240px;">
                  <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Categoria (Macro)</div>
                  <select id="analiseGastos_macro_selCategoria"
                          style="height:38px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
                    <option value="">Todas</option>
                  </select>
                </div>

                <div style="display:flex; flex-direction:column; gap:6px; flex:0 0 160px; min-width:160px;">
                  <div style="font-size:11px;font-weight:1000;color:rgba(226,232,240,0.85);">Ano (Macro)</div>
                  <select id="analiseGastos_macro_selAno"
                          style="height:38px; width:100%; border:1px solid rgba(148,163,184,0.45); background:#020f2b; color:#fff; border-radius:10px; padding:0 10px; font-weight:800; font-size:12px;">
                    <option value="">Último ano</option>
                  </select>
                </div>

                <div style="display:flex; align-items:flex-end; gap:8px; margin-left:auto;">
                  <button id="analiseGastos_macro_btnAtualizar" type="button"
                          style="height:38px; padding:0 14px; border:none; border-radius:10px; font-weight:900; font-size:11px; background:#006b2c; color:#fff; cursor:pointer;">
                    Atualizar
                  </button>
                </div>
              </div>

              <!-- Corpo do modal -->
              <div style="flex:1; min-height:0; overflow:auto; padding:14px 16px; position:relative;">
                <div id="analiseGastos_macro_loading"
                     class="hidden"
                     style="display:none; position:absolute; inset:14px 16px; z-index:2; background:rgba(2,6,23,0.55); border-radius:14px;">
                  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
                    <div style="background:#ffffff; border:1px solid rgba(226,232,240,1); border-radius:14px; padding:14px 16px; box-shadow:0 24px 50px rgba(0,0,0,0.35);">
                      <div style="font-size:14px; font-weight:1000; color:#0b1220;">Carregando Macro Visões…</div>
                      <div style="margin-top:5px; font-size:12px; font-weight:800; color:#475569;">Processando série mensal.</div>
                    </div>
                  </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr; gap:14px;">
                  <!-- Chart 1 -->
                  <div style="border:1px solid rgba(148,163,184,0.18); border-radius:14px; background:rgba(15,23,42,0.65); padding:12px;">
                    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:8px;">
                      <div>
                        <div style="font-size:13px; font-weight:1000; color:#fff;">Lojas — Evolução mensal (somatória)</div>
                        <div id="analiseGastos_macro_hintLojas" style="margin-top:4px; font-size:12px; font-weight:800; color:rgba(226,232,240,0.75);">
                          —
                        </div>
                      </div>
                    </div>
                    <div style="margin-top:10px; height:320px; position:relative;">
                      <canvas id="analiseGastos_macro_chartLojas" style="width:100%; height:100%;"></canvas>
                    </div>
                    <!-- Chart 1.2 - Top 10 Lojas -->
                    <div style="border:1px solid rgba(148,163,184,0.18); border-radius:14px; background:rgba(15,23,42,0.65); padding:12px;">
                      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:8px;">
                        <div>
                          <div style="font-size:13px; font-weight:1000; color:#fff;">Top 10 Lojas — Maior valor de gastos</div>
                          <div id="analiseGastos_macro_hintTopLojas" style="margin-top:4px; font-size:12px; font-weight:800; color:rgba(226,232,240,0.75);">
                            —
                          </div>
                        </div>
                      </div>
                      <div style="margin-top:10px; height:320px; position:relative;">
                        <canvas id="analiseGastos_macro_chartTopLojas" style="width:100%; height:100%;"></canvas>
                      </div>
                    </div>
                  </div>

                  <!-- Chart 2 -->
                  <div style="border:1px solid rgba(148,163,184,0.18); border-radius:14px; background:rgba(15,23,42,0.65); padding:12px;">
                    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:8px;">
                      <div>
                        <div style="font-size:13px; font-weight:1000; color:#fff;">Categorias — Evolução mensal (somatória)</div>
                        <div id="analiseGastos_macro_hintCategorias" style="margin-top:4px; font-size:12px; font-weight:800; color:rgba(226,232,240,0.75);">
                          —
                        </div>
                      </div>
                    </div>
                    <div style="margin-top:10px; height:320px; position:relative;">
                      <canvas id="analiseGastos_macro_chartCategorias" style="width:100%; height:100%;"></canvas>
                    </div>
                    <!-- Chart 2.2 - Top 10 Categorias -->
                    <div style="border:1px solid rgba(148,163,184,0.18); border-radius:14px; background:rgba(15,23,42,0.65); padding:12px;">
                      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:8px;">
                        <div>
                          <div style="font-size:13px; font-weight:1000; color:#fff;">Top 10 Categorias — Maior valor de gastos</div>
                          <div id="analiseGastos_macro_hintTopCategorias" style="margin-top:4px; font-size:12px; font-weight:800; color:rgba(226,232,240,0.75);">
                            —
                          </div>
                        </div>
                      </div>
                      <div style="margin-top:10px; height:320px; position:relative;">
                        <canvas id="analiseGastos_macro_chartTopCategorias" style="width:100%; height:100%;"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Modal: Mediana por Categoria (respeita filtros e período) -->
<div id="analiseGastos_medModal" class="hidden" aria-hidden="true">
  <div id="analiseGastos_medModalBackdrop"></div>

  <div id="analiseGastos_medModalPanel" role="dialog" aria-modal="true" aria-labelledby="analiseGastos_medModalTitle">
    <div id="analiseGastos_medModalHeader">
      <div>
        <div id="analiseGastos_medModalTitle">Resumo Estatístico de Gastos</div>
        <div id="analiseGastos_medModalSub">
          Considera período e filtros (Time/Loja/Categoria) aplicados na tela principal.
        </div>
      </div>

      <button id="analiseGastos_medModalClose" type="button" title="Fechar">×</button>
    </div>

    <div id="analiseGastos_medModalBody">
      <!-- Cards premium -->

      <div id="analiseGastos_medCards">
        <div class="analiseGastosMedCard">
          <div class="analiseGastosMedCardHead">Mediana</div>
          <div id="analiseGastos_medCardMedian" class="analiseGastosMedCardValue">—</div>
          <div class="analiseGastosMedCardHint">Valor “típico” do período: metade das compras fica acima e metade abaixo.</div>
        </div>

        <div class="analiseGastosMedCard">
          <div class="analiseGastosMedCardHead">Média</div>
          <div id="analiseGastos_medCardMean" class="analiseGastosMedCardValue">—</div>
          <div class="analiseGastosMedCardHint">Total dividido pela quantidade de compras (pode subir muito com compras muito altas).</div>
        </div>

        <div class="analiseGastosMedCard">
          <div class="analiseGastosMedCardHead">Normalização</div>
          <div id="analiseGastos_medCardNorm" class="analiseGastosMedCardValue">—</div>
          <div class="analiseGastosMedCardHint">Mostra a mediana numa escala de 0 a 1 usando o menor e o maior valor do período.</div>
        </div>
      </div>

      <!-- Tabela -->
      <div id="analiseGastos_medTableWrap">
        <table id="analiseGastos_medTable">
          <thead>
            <tr>
              <th data-sort="loja">Loja</th>
              <th data-sort="categoria">Categoria</th>
              <th data-sort="mediana">Valor (mediana)</th>
              <th data-sort="max">Maior valor</th>
              <th data-sort="min">Menor valor</th>
            </tr>
          </thead>
          <tbody id="analiseGastos_medTbody">
            <tr><td colspan="5" id="analiseGastos_medMsg">Carregando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

        <!-- Modal: Detalhe de Estabelecimentos (pivot mensal) -->
        <div id="analiseGastos_estabModal" class="hidden" aria-hidden="true">
          <div id="analiseGastos_estabModalBackdrop"></div>

          <div id="analiseGastos_estabModalPanel" role="dialog" aria-modal="true" aria-labelledby="analiseGastos_estabModalTitle">
            <div id="analiseGastos_estabModalHeader">
              <div>
                <div id="analiseGastos_estabModalTitle">Detalhamento de Estabelecimentos por mês</div>
                <div id="analiseGastos_estabModalSub">
                  Somatória mensal por estabelecimento com base nos filtros aplicados na página principal.
                </div>
              </div>

              <button id="analiseGastos_estabModalClose" type="button" title="Fechar">×</button>
            </div>

            <div id="analiseGastos_estabModalBody">
            <!-- Toolbar -->
            <div id="analiseGastos_estabPivotToolbar" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;">
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; min-width:0;">
                <input
                  id="analiseGastos_estabPivotSearch"
                  type="text"
                  placeholder="Buscar estabelecimento..."
                  style="
                    width:min(420px, 78vw);
                    max-width:100%;
                    height:38px;
                    border:1px solid #cbd5e1;
                    border-radius:10px;
                    padding:0 12px;
                    font-size:13px;
                    font-weight:800;
                    color:#0f172a;
                    background:#fff;
                    outline:none;
                  "
                />
                <button id="analiseGastos_estabPivotSearchClear" type="button" style="
                  height:38px;
                  padding:0 12px;
                  border:1px solid #cbd5e1;
                  border-radius:10px;
                  background:#fff;
                  color:#0f172a;
                  font-size:12px;
                  font-weight:900;
                  cursor:pointer;
                ">Limpar</button>

                <div id="analiseGastos_estabPivotCount" style="
                  font-size:12px;
                  font-weight:900;
                  color:#475569;
                  white-space:nowrap;
                ">—</div>
              </div>

              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button id="analiseGastos_estabPivotExportCsv" type="button" style="
                  height:38px;
                  padding:0 12px;
                  border:1px solid #86efac;
                  border-radius:10px;
                  background:#f0fdf4;
                  color:#14532d;
                  font-size:12px;
                  font-weight:1000;
                  cursor:pointer;
                ">Exportar CSV</button>
              </div>
            </div>

            <div id="analiseGastos_estabPivotWrap">
              <div id="analiseGastos_estabPivotMsg">Clique no card para carregar os detalhes.</div>
            </div>
          </div>
          </div>
        </div>

        <!-- Cards -->
        <div style="display:grid; grid-template-columns:repeat(4, minmax(220px, 1fr)); gap:10px; align-items:stretch;">
          <div class="analiseGastosCard">
            <div class="analiseGastosCardLabel">Loja com maior valor</div>
            <div id="analiseGastos_cardLojaTop" class="analiseGastosCardValue">—</div>
            <div id="analiseGastos_cardLojaTopSub" class="analiseGastosCardSub">—</div>
          </div>

          <div class="analiseGastosCard">
            <div class="analiseGastosCardLabel">Valor total de gastos</div>
            <div id="analiseGastos_cardTotal" class="analiseGastosCardValue">—</div>
            <div id="analiseGastos_cardTotalSub" class="analiseGastosCardSub">—</div>
          </div>

          <div class="analiseGastosCard">
            <div class="analiseGastosCardLabel">Categoria com maior valor</div>
            <div id="analiseGastos_cardCategoriaTop" class="analiseGastosCardValue">—</div>
            <div id="analiseGastos_cardCategoriaTopSub" class="analiseGastosCardSub">—</div>
          </div>

          <div class="analiseGastosCard" id="analiseGastos_cardEstabWrap" role="button" tabindex="0" aria-label="Abrir detalhes de estabelecimentos por mês">
            <div class="analiseGastosCardLabel">Estabelecimento com maior valor</div>
            <div id="analiseGastos_cardEstabTop" class="analiseGastosCardValue">—</div>
            <div id="analiseGastos_cardEstabTopSub" class="analiseGastosCardSub">—</div>

            <div class="analiseGastosCardHoverHelp">
              Clique para visualizar mais detalhes de todos os estabelecimentos do período aplicado.
            </div>
          </div>
        </div>

        <!-- Tabela -->
        <div style="margin-top:14px;">
          <div id="analiseGastosTableBox">
            <table id="analiseGastosTable">
              <colgroup>
                <col style="width:110px;">  <!-- Data -->
                <col style="width:90px;">   <!-- Loja (↑ aumentada) -->
                <col style="width:170px;">  <!-- Time -->
                <col style="width:170px;">  <!-- Categoria -->
                <col style="width:260px;">  <!-- Estabelecimento -->
                <col style="width:120px;">  <!-- Valor -->
                <col style="width:auto;">   <!-- Descrição -->
              </colgroup>
              <thead>
                <tr>
                  <th data-sort="data">Data</th>
                  <th data-sort="loja">Loja</th>
                  <th data-sort="time">Time</th>
                  <th data-sort="categoria">Categoria</th>
                  <th data-sort="estab">Estabelecimento</th>
                  <th data-sort="valor">Valor (R$)</th>
                  <th data-sort="descricao">Descrição</th>
                </tr>
              </thead>
              <tbody id="analiseGastos_tbody">
                <tr>
                  <td colspan="7" style="text-align:center; padding:14px; font-weight:900; color:#334155;">
                    Carregue os filtros e clique em Buscar.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>
  </main>
</div>

<!-- VIEW: ENVIO DE PENDÊNCIAS (sobrepõe SOMENTE a área do chat) -->
<div id="envioPendView" class="hidden" style="position:absolute; inset:0; z-index:20;">
  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Envio de Pendências</div>
            <div style="color:rgba(226,232,240,0.85); font-size:12px; margin-top:2px;">
              Prévia + seleção (checkbox) + rastreabilidade (envio único por transação)
            </div>
          </div>
        </div>

        <!-- Modal: Como funciona a análise? (Envio de Pendências) -->
<div id="envPendAnaliseModal"
     class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[920px] overflow-hidden border border-slate-200">

    <!-- Header -->
    <div class="px-5 py-4 text-white flex items-center justify-between"
         style="background:#005E27;">
      <div>
        <div class="text-base font-extrabold">Como funciona a análise (Envio de Pendências)</div>
        <div class="text-xs opacity-90">
          Tutorial rápido do fluxo: prévia → seleção → envio → rastreabilidade
        </div>
      </div>

      <button type="button"
              onclick="closeEnvPendAnaliseModal()"
              class="transition rounded-lg px-3 py-2 text-sm font-semibold"
              style="background:rgba(255,255,255,0.18);">
        Fechar
      </button>
    </div>

    <!-- Faixa destaque -->
    <div style="height:6px; background:#B5FF20;"></div>

    <!-- Body -->
    <div class="p-5 text-sm text-slate-800 space-y-4 max-h-[72vh] overflow-y-auto">

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">1) O que a página analisa</div>
        <div class="mt-2">
          O Vektor lê a <b>base de transações da Clara</b> no período selecionado (Data inicial / Data final) e identifica transações com:
          <ul class="list-disc ml-5 mt-2 space-y-1">
            <li><b>Status de aprovação = Recusada</b></li>
            <li>Pendências de justificativa: <b>NF/Recibo</b>, <b>Etiqueta</b>, <b>Descrição</b> e/ou <b>NF/Recibo divergente</b> - Para essa pendencia de divergêcnia na nota fiscal, será identificado sempre que houver no momento da recusa da transação a informação de: <i>NF/Recibo divergente</i>, ou seja, é necessário colocar essa chave de texto para identificação da pendência.</li>
          </ul>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">2) Botão “Gerar prévia”</div>
        <div class="mt-2">
          Monta a lista de transações elegíveis, calcula métricas (quantidade, lojas, valor total, distribuição por tipo),
          e prepara a tabela de revisão.
        </div>
        <div class="mt-3 rounded-lg p-3" style="background:rgba(0,94,39,0.06); border:1px solid rgba(0,94,39,0.15);">
          <div class="font-extrabold" style="color:#005E27;">Dica</div>
          <div class="mt-1">
            Se o período for grande, a prévia pode demorar mais. Prefira rodar por semana/datas focadas quando possível.
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">3) Botão “Revisar linhas” (checkbox)</div>
        <div class="mt-2">
          Abre o modal com a lista detalhada e permite <b>desmarcar</b> transações específicas para não enviar naquele disparo.
        </div>
        <ul class="list-disc ml-5 mt-2 space-y-1">
          <li>Por padrão, o sistema marca o que <b>ainda não foi enviado</b>.</li>
          <li>Transações já enviadas aparecem como <b>bloqueadas</b> (não devem ser reenviadas).</li>
        </ul>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">4) Botão “Enviar selecionadas”</div>
        <div class="mt-2">
          Envia e-mails agrupados por <b>Loja</b> (e data, quando aplicável) apenas para as linhas selecionadas.
          Após o envio, as transações são registradas no histórico de rastreabilidade para <b>não serem reenviadas</b>.
        </div>
        <div class="mt-3 rounded-lg p-3"
             style="background:rgba(181,255,32,0.22); border:1px solid rgba(0,94,39,0.18);">
          <div class="font-extrabold" style="color:#0b1220;">Regra crítica</div>
          <div class="mt-1">
            <b>Cada transação deve ser enviada uma única vez.</b> O controle é feito por chave/hash da transação.
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-extrabold text-slate-900">5) Feedback de envio</div>
        <div class="mt-2">
          A página exibe o status do disparo e lista:
          <ul class="list-disc ml-5 mt-2 space-y-1">
            <li><b>Enviados</b>: lojas que receberam e-mail e quantidade de transações</li>
            <li><b>Falhas</b>: lojas que não foi possível enviar (ex.: e-mail ausente, erro de serviço)</li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Popup central: gráfico de valores por loja (Envio de Pendências) -->
<div id="envPendLojasPopup"
     style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.72);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
    <div style="
      width:min(980px, 96vw);
      max-height:min(78vh, 820px);
      background:#f8fafc;
      border:1px solid rgba(148,163,184,0.22);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,0.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    ">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(148,163,184,0.18);">
  <!-- Esquerda -->
  <div style="min-width:0;">
    <!-- Linha 1: título + filtro -->
    <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap;">
      <div style="color:#0b1220; font-weight:1000; font-size:14px; white-space:nowrap;">
        Pendências recusadas — Valor por loja
      </div>

      <div style="display:flex; align-items:center; gap:8px;">
        <div style="color:rgba(15,23,42,0.75); font-size:12px; font-weight:900; white-space:nowrap;">
          Filtrar por Time
        </div>

        <select id="envPendLojasTimeFilter"
          style="height:34px; border-radius:10px; background:#ffffff; color:#0b1220;
                 border:1px solid rgba(15,23,42,0.18); padding:0 10px; font-weight:900; font-size:12px; min-width:180px;">
          <option value="">Todos</option>
        </select>
      </div>
    </div>

    <!-- Linha 2: período -->
    <div id="envPendLojasPopupSub" style="color:rgba(15,23,42,0.75); font-size:12px; margin-top:2px;"></div>
  </div>

  <!-- Direita: botão fechar -->
  <button type="button"
    onclick="window.vektorEnvPendLojasPopupClose_()"
    style="background:#005E27;color:#fff;border:none;padding:8px 14px;border-radius:12px;font-weight:900;cursor:pointer;">
    Fechar
  </button>
</div>

      <!-- Scroll vertical quando tiver muitas lojas -->
      <div style="padding:12px 14px; overflow:auto;">
        <canvas id="envPendLojasChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div id="envPend_distOverlay"
     style="position:fixed; inset:0; display:none; z-index:99998;">
  <div id="envPend_distOverlayBg"
       style="position:absolute; inset:0; background:rgba(15,23,42,0.55);"></div>

  <div id="envPend_distOverlayCard"
       style="
         position:absolute;
         left:50%; top:50%;
         transform:translate(-50%,-50%);
         width:min(980px, 92vw);
         max-height:min(640px, 82vh);
         background:#ffffff;
         border-radius:18px;
         border:1px solid rgba(15,23,42,0.18);
         box-shadow:0 18px 50px rgba(0,0,0,0.35);
         padding:14px 14px 12px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div style="font-weight:1000; color:#0f172a;">Distribuição de pendências por loja</div>
      <button type="button"
              id="envPend_distOverlayClose"
              style="height:32px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,94,39,0.35); background:#005E27; color:#fff; font-weight:900; font-size:12px; cursor:pointer;">
        Fechar
      </button>
    </div>

    <div style="margin-top:6px; color:#334155; font-size:12px;">
      Cada barra soma 100% (composição por tipo de pendência dentro da loja).
    </div>

    <div id="envPend_distOverlayBody"
         style="margin-top:10px; overflow:auto; max-height:calc(82vh - 120px); padding-right:6px;">
    </div>

    <div style="margin-top:10px; display:flex; gap:14px; flex-wrap:wrap; font-size:12px; color:#334155;">
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#005E27;margin-right:6px;"></span>NF/Recibo</div>
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#0ea5e9;margin-right:6px;"></span>Etiqueta</div>
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#a855f7;margin-right:6px;"></span>Descrição</div>
      <div><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#f59e0b;margin-right:6px;"></span>NF divergente</div>
    </div>
  </div>
</div>

<!-- Botão central: Como funciona a análise? -->
        <div style="flex:1; display:flex; justify-content:center; align-items:center; padding:0 10px;">
          <button
            type="button"
            onclick="openEnvPendAnaliseModal()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:1px solid rgba(255,255,255,0.22);
              background:rgba(255,255,255,0.86);
              color:#0b1220;
              font-weight:900;
              font-size:12px;
              cursor:pointer;
              box-shadow:0 10px 22px rgba(0,0,0,0.18);
            ">
            Como funciona a análise?
          </button>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" onclick="window.vektorEnvioPendenciasPreview()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
            Gerar prévia
          </button>

          <button type="button" onclick="window.vektorEnvioPendenciasAbrirModal()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(59,130,246,0.35); background:rgba(59,130,246,0.15); color:#fff; font-weight:900; font-size:12px;">
            Revisar linhas
          </button>

          <button
            id="envPend_btnEnviarSelecionadas"
            type="button"
            onclick="window.vektorEnvioPendenciasEnviarSelecionadas()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:none;
              background:#B5FF20;
              color:#0b1f3a;
              font-weight:900;
              font-size:12px;
              cursor:pointer;
            ">
            Enviar selecionadas
          </button>

        </div>
      </div>

      <!-- Conteúdo -->
      <div style="flex:1; overflow:auto; background:#070b14; padding:14px 16px;">
        <!-- filtros -->
        <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
            <div style="display:flex; flex-direction:column; gap:4px;">
              <label style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900;">Data inicial</label>
              <input id="envPend_ini" type="date"
                style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
            </div>

            <div style="display:flex; flex-direction:column; gap:4px;">
              <label style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900;">Data final</label>
              <input id="envPend_fim" type="date"
                style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
            </div>

           <div id="envPend_statusText"
              style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:800; white-space:nowrap;">
          </div>

          <div id="envPend_statusCards"
              style="margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; justify-content:flex-end;">
          </div>
          </div>
        </div>

        <!-- resumo -->
        <div class="mt-3" style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
          <div style="color:#fff; font-weight:900; font-size:14px;">Resumo</div>
          <div id="envPend_resumo" style="margin-top:8px; color:rgba(226,232,240,0.85); font-size:12px;">
            Gere uma prévia para ver o resumo.
          </div>
          <div id="envPend_falhas" style="margin-top:10px;"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- OVERLAY (bloqueia tela) - Envio de Pendências -->
<div id="envPend_overlay" style="display:none; position:absolute; inset:0; z-index:90; background:rgba(0,0,0,0.65);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;">
    <div style="width:min(520px, 92vw); background:#0b1220; border:1px solid rgba(148,163,184,0.22); border-radius:16px; padding:18px; box-shadow:0 18px 46px rgba(0,0,0,0.55); text-align:center;">
      <div style="display:flex; justify-content:center; margin-bottom:12px;">
        <div class="envPend_spinner"></div>
      </div>
      <div id="envPend_overlayTitle" style="color:#fff; font-weight:1000; font-size:16px;">Carregando…</div>
      <div id="envPend_overlaySub" style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:6px;">Aguarde um instante.</div>
    </div>
  </div>
</div>

<!-- MODAL: Revisar pré-listagem (checkbox) -->
<div id="envPendModal" class="hidden" style="position:absolute; inset:0; z-index:60; background:rgba(0,0,0,0.55);">
  <div style="position:absolute; inset:22px; background:#0b1220; border:1px solid rgba(148,163,184,0.25); border-radius:16px; overflow:hidden; display:flex; flex-direction:column;">
    <div style="padding:12px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(148,163,184,0.18);">
      <div style="color:#fff; font-weight:900;">Revisar linhas (desmarque o que não deve ir)</div>
      <div style="display:flex; gap:8px;">
          <button type="button" onclick="window.vektorEnvPendExportCsv()"
          style="height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          Exportar CSV
        </button>
        <button type="button" onclick="window.vektorEnvPendSelectAll(true)"
          style="height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          Marcar tudo
        </button>
        <button type="button" onclick="window.vektorEnvPendSelectAll(false)"
          style="height:32px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          Desmarcar tudo
        </button>
        <button type="button" onclick="window.vektorEnvioPendenciasFecharModal()"
          style="height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(248,113,113,0.35); background:rgba(248,113,113,0.12); color:#fff; font-weight:900;font-size:12px;">
          Fechar
        </button>
      </div>
    </div>

    <div style="padding:12px 14px; flex:1; overflow:auto;">
      <table style="width:100%; border-collapse:collapse; font-size:12px; color:rgba(226,232,240,0.9);">
        <thead>
          <tr>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Enviar</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Loja</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Data Transação</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Estabelecimento</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Valor</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Cartão</th>
            <th style="position:sticky; top:0; background:#ef4444; color:#fff; padding:8px; text-align:left;">Pendências</th>
            <th style="position:sticky; top:0; background:#0b1f3a; color:#fff; padding:8px; text-align:left;">Já enviado?</th>
          </tr>
        </thead>
        <tbody id="envPend_tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- VIEW: RADAR (sobrepõe SOMENTE a área do chat) -->
<div id="radarView" class="hidden" style="position:absolute; inset:0; z-index:20;">

    <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
      <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header do Radar -->
        <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
          <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Radar de Irregularidade</div>
           <div id="radarSubTitle" style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.88); line-height:1.35;">
            Correlação entre métricas + ranking de proximidade por loja
          </div>
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">

          <button id="radarBtnHistEnvios" type="button" onclick="window.vektorOpenHistEnviosItensIrreg_()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;
                  display:inline-flex; align-items:center; justify-content:center;">
            Histórico de envios
          </button>

          <button id="radarBtnItens" type="button" onclick="window.vektorToggleRadarItensIrregulares()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.25);
                  background:#fde68a; color:#111827; font-weight:1000; font-size:12px;
                  margin-right:18px; display:inline-flex; align-items:center; justify-content:center; line-height:1;">
            Itens Irregulares
          </button>
         <button id="radarBtn7d" type="button" onclick="window.vektorOpenRadar('7d')"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            7 dias
          </button>

          <button id="radarBtnCiclo" type="button" onclick="window.vektorOpenRadar('ciclo')"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            Ciclo
          </button>

          <button id="radarBtnFull" type="button" onclick="window.vektorOpenRadar('full')"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            Base toda
          </button>

          <button
          id="radarBtnComoAnalise"
            type="button"
            onclick="openRadarAnaliseModal()"
            style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
                  background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px; display:inline-flex; align-items:center;justify-content:center;">
            Como acontece a análise?
          </button>

        </div>
      </div>

      <!-- Conteúdo -->
      <div style="flex:1; overflow:auto; background:#070b14; padding:14px 16px;">
        <div id="radarLoading" style="display:none; color:rgba(226,232,240,0.9); font-size:13px; font-weight:700;">
          Carregando dados do Radar...
        </div>

        <!-- ✅ NOVA VISÃO: ITENS IRREGULARES (substitui o radar tradicional quando ativo) -->
<div id="radarItensView" style="display:none;">

  <!-- Filtros -->
  <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Data inicial</div>
        <input id="itensIrregDtIni" type="date"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22); background:rgba(255,255,255,0.06); color:#fff; font-weight:800; font-size:12px;">
      </div>

      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Data final</div>
        <input id="itensIrregDtFim" type="date"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22); background:rgba(255,255,255,0.06); color:#fff; font-weight:800; font-size:12px;">
      </div>

      <div style="min-width:260px; flex:1;">
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Item comprado (contém)</div>
        <input id="itensIrregItemQ" type="text" placeholder="Ex.: água, impressão, pilha..."
          style="height:36px; width:100%; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22); background:rgba(255,255,255,0.06); color:#fff; font-weight:800; font-size:12px;">
      </div>

            <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">&nbsp;</div>
        <button type="button" onclick="window.vektorLoadRadarItensIrregulares()"
          style="height:36px; padding:0 14px; border-radius:10px;
                display:inline-flex; align-items:center; justify-content:center;
                border:1px solid rgba(0,0,0,0.25);
                background:#7CFC00; color:#111827; font-weight:1000; font-size:12px;">
          Atualizar
        </button>
      </div>

      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Conformidade</div>
        <select id="itensIrregConf" onchange="window.vektorLoadRadarItensIrregulares()"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22);
                background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          <option value="" selected>Todos</option>
          <option value="OK">OK</option>
          <option value="REVISAR">REVISAR</option>
          <option value="ALERTA">ALERTA</option>
        </select>
      </div>

      <div>
        <div style="color:rgba(226,232,240,0.8); font-size:11px; font-weight:900;">Gráfico por</div>
        <select id="itensIrregGroupBy" onchange="window.vektorLoadRadarItensIrregulares()"
          style="height:36px; padding:0 10px; border-radius:10px; border:1px solid rgba(148,163,184,0.22);
                background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
          <option value="loja" selected>Loja</option>
          <option value="time">Time</option>
        </select>
      </div>

      <div style="display:flex; gap:8px; margin-left:auto; flex-wrap:wrap;">

        <button type="button" onclick="window.vektorExportRadarItensIrregularesCSV()"
          style="height:36px; padding:0 14px; border-radius:10px;
                display:inline-flex; align-items:center; justify-content:center;
                border:1px solid rgba(255,255,255,0.18);
                background:rgba(255,255,255,0.06); color:#fff; font-weight:1000; font-size:12px;">
          Exportar CSV
        </button>

        <button type="button" onclick="window.vektorOpenItensIrregDetalhamentoModal()"
          style="height:36px; padding:0 14px; border-radius:10px;
                display:inline-flex; align-items:center; justify-content:center;
                border:1px solid rgba(181,255,32,0.30);
                background:rgba(181,255,32,0.10); color:#B5FF20; font-weight:1000; font-size:12px;">
          Ver detalhamento
        </button>

      </div>
      </div>
      </div>

  <!-- KPIs -->
  <div style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin-top:12px;">
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Itens (total)</div>
      <div id="itensIrregKpiTotal" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">—</div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Valor (total)</div>
      <div id="itensIrregKpiValor" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">—</div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">ALERTA (qtd)</div>
      <div id="itensIrregKpiAlertas" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">—</div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">ALERTA (% valor)</div>
      <div id="itensIrregKpiPctAlertas" style="color:#fff; font-size:18px; font-weight:1000; margin-top:4px;">—</div>
    </div>
  </div>

  <!-- Agregações + gráfico -->
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:#fff; font-weight:1000; font-size:14px;">Por Loja (valor + %)</div>
      <div id="itensIrregAggLoja" style="margin-top:10px;"></div>
    </div>
    <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
      <div style="color:#fff; font-weight:1000; font-size:14px;">Por Time (valor + %)</div>
      <div id="itensIrregAggTime" style="margin-top:10px;"></div>
    </div>
  </div>

  <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px; margin-top:12px;">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
      <div>
        <div style="color:#fff; font-weight:1000; font-size:14px;">ALERTA — quantidade por <span id="itensIrregChartLabel">Loja</span></div>
        <div style="color:rgba(226,232,240,0.7); font-size:12px; margin-top:2px;">Somente itens com conformidade ALERTA.</div>
      </div>
    </div>
    <div id="itensIrregChart" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
  </div>

</div>

<!-- MODAL: Detalhamento de Itens Irregulares -->
<div id="itensIrregDetalhamentoModal"
  style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.65); backdrop-filter: blur(6px);">

  <div style="position:absolute; inset:40px; max-width:1200px; margin:0 auto;
              background:rgba(15,23,42,0.92);
              border:1px solid rgba(148,163,184,0.22);
              border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,0.55);
              display:flex; flex-direction:column; overflow:hidden;">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px;
                border-bottom:1px solid rgba(148,163,184,0.18);
                background:rgba(255,255,255,0.04);">
      <div>
        <div style="color:#fff; font-weight:1000; font-size:14px;">Detalhamento — Itens Irregulares</div>
        <div style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:2px;">
          Data, Valor, Loja, Time, Item, Conformidade e Motivo.
        </div>
      </div>

      <button type="button" onclick="window.vektorCloseItensIrregDetalhamentoModal()"
        style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
               background:rgba(255,255,255,0.06); color:#fff; font-weight:1000; font-size:12px; cursor:pointer;">
        Fechar
      </button>

    </div>

    <!-- Filtros (LOCAL, sem recarregar backend) -->
<div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; padding:12px 14px;
            border-bottom:1px solid rgba(148,163,184,0.18);">

  <!-- Loja -->
  <div style="display:flex; flex-direction:column; gap:6px; min-width:160px;">
    <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Loja</div>
    <select id="itensIrregDetFiltroLoja"
      style="height:34px; border-radius:10px; padding:0 10px;
             background:rgba(255,255,255,0.06); border:1px solid rgba(148,163,184,0.18);
             color:#fff; font-weight:900; font-size:12px;">
      <option value="">Todas</option>
    </select>
  </div>

  <!-- Time -->
  <div style="display:flex; flex-direction:column; gap:6px; min-width:220px;">
    <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Time</div>
    <select id="itensIrregDetFiltroTime"
      style="height:34px; border-radius:10px; padding:0 10px;
             background:rgba(255,255,255,0.06); border:1px solid rgba(148,163,184,0.18);
             color:#fff; font-weight:900; font-size:12px;">
      <option value="">Todos</option>
    </select>
  </div>

  <!-- Limpar filtros -->
  <button type="button" onclick="window.vektorClearItensIrregDetFilters_()"
    style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(181,255,32,0.30);
           background:rgba(181,255,32,0.10); color:#B5FF20;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Limpar filtros
  </button>

  <!-- ✅ NOVO: Prévia (fica no “lugar” do enviar) -->
  <button type="button" onclick="window.vektorOpenPreviewItensIrregDet_()"
    style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Prévia
  </button>

  <!-- ✅ Espaço do meio: Sel. All / Desel. All -->
<div style="flex:1 1 auto; display:flex; justify-content:flex-end; gap:10px; padding-right:10px;">

  <button type="button" onclick="window.vektorItensIrregDetSelectAll_()"
    style="height:34px; padding:0 12px; border-radius:10px;
           border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Sel. All
  </button>

  <button type="button" onclick="window.vektorItensIrregDetDeselectAll_()"
    style="height:34px; padding:0 12px; border-radius:10px;
           border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Desel. All
  </button>

</div>

  <!-- ✅ Enviar Notificação no canto direito -->
  <button type="button" onclick="window.vektorEnviarNotificacaoItensIrregularesSelecionados_()"
    style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
           background:rgba(255,255,255,0.06); color:#fff;
           font-weight:1000; font-size:12px; cursor:pointer;">
    Enviar Notificação
  </button>

</div>

    <!-- Table (scroll) -->
    <div style="padding:12px;">
      <div style="border-radius:12px; border:1px solid rgba(148,163,184,0.18);
            overflow:auto; max-height:65vh; background:rgba(226,232,240,0.92);">

        <table style="width:100%; border-collapse:separate; border-spacing:0; min-width:1480px;">
          <thead>
            <tr>
              <th onclick="window.vektorToggleItensIrregDetSort_('data')"
                  title="Ordenar por Data"
                  style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                        background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;
                        cursor:pointer; user-select:none;">
                Data ↕
              </th>
              <th onclick="window.vektorToggleItensIrregDetSort_('valor')"
                  title="Ordenar por Valor"
                  style="position:sticky; top:0; z-index:5; text-align:right; padding:10px; width:100px; min-width:100px;
                        background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;
                        cursor:pointer; user-select:none;">
                Valor (R$) ↕
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Loja
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px; width:180px; min-width:180px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Time
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Item Comprado
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                        background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Estabelecimento
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Conformidade
              </th>
              <th style="position:sticky; top:0; z-index:5; text-align:left; padding:10px; width:320px; min-width:320px;
                         background:rgba(15,23,42,0.96); color:#fff; font-size:12px; font-weight:1000;">
                Motivo
              </th>
            </tr>
          </thead>

          <tbody id="itensIrregDetTbody">
            <tr>
              <td colspan="8" style="padding:12px; color:rgba(226,232,240,0.75); font-weight:800; font-size:12px;">
                Clique em “Atualizar” para carregar e depois use “Ver detalhamento”.
              </td>
            </tr>
          </tbody>

        <!-- ✅ MINI MODAL: Prévia seleção -->
<div id="itensIrregPreviewModal" style="display:none; position:fixed; inset:0; z-index:999999;">
  <div onclick="window.vektorClosePreviewItensIrregDet_()"
       style="position:absolute; inset:0; background:rgba(0,0,0,0.55);"></div>

  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
              width:min(900px, calc(100vw - 28px));
              max-height:calc(100vh - 120px);
              overflow:auto;
              background:linear-gradient(180deg, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
              border:1px solid rgba(148,163,184,0.22);
              border-radius:16px;
              box-shadow:0 18px 50px rgba(0,0,0,0.45);">

    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px;
                border-bottom:1px solid rgba(148,163,184,0.18);">
      <div style="color:#fff; font-weight:1000; font-size:14px;">Prévia — Itens selecionados</div>
      <button type="button" onclick="window.vektorClosePreviewItensIrregDet_()"
        style="height:34px; padding:0 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
               background:rgba(255,255,255,0.06); color:#fff; font-weight:1000; font-size:12px; cursor:pointer;">
        Fechar
      </button>
    </div>

    <div id="itensIrregPreviewBody" style="padding:14px 16px; color:rgba(226,232,240,0.92);">
      <!-- preenchido via JS -->
    </div>

  </div>
</div>

        </table>

      </div>
    </div>

  </div>
</div>

        <div id="radarContent" style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px;">
          <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
              <div style="color:#fff; font-weight:900; font-size:14px;">Correlação (Pearson)</div>
              <div style="color:rgba(226,232,240,0.75); font-size:11px;">-1 · 0 · +1</div>
            </div>
            <div id="radarHeatmap" style="margin-top:10px;"></div>
            <div class="radar-legend-bar"></div>
           <!-- INSIGHTS dinâmicos (explicação "tipo IA") -->
            <div id="radarInsights"
                style="margin-top:12px; padding:12px; border-radius:12px;
                border:1px solid rgba(148,163,184,0.18);
                background:rgba(255,255,255,0.03);
                color:rgba(226,232,240,0.9);
                font-size:12px; line-height:1.5;
                min-height:260px; max-height:360px; overflow:auto;">
              <div style="font-weight:900; color:#fff; margin-bottom:6px; font-size:14px;">
                Leitura automática do Radar
              </div>
              <div style="opacity:0.85;">
                Carregando interpretação…
              </div>
            </div>
          </div>
          <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
            <div style="color:#fff; font-weight:900; font-size:14px;">Lojas mais próximas</div>
            <div style="color:rgba(226,232,240,0.7); font-size:12px; margin-top:2px;">
              Ranking de proximidade (baseado em MAX_SCORE, CASOS e PENDÊNCIA)
            </div>
            <div id="radarRanking" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </div>
      </div>

    </div>
  </main>
 </div> <!-- fecha #radarView -->

 <div id="itensIrregHistEnviosModal"
     style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(2,6,23,0.55);">
  <div style="width:min(1100px,96vw); margin:4vh auto; background:#ffffff; border-radius:16px;
              box-shadow:0 20px 50px rgba(2,6,23,0.25); overflow:hidden; border:1px solid #e2e8f0;">

    <div style="display:flex; align-items:center; justify-content:space-between;
                padding:14px 16px; border-bottom:1px solid #e2e8f0; background:#f8fafc;">
      <div>
        <div style="font-size:16px; font-weight:1000; color:#0f172a;">Histórico de envios — Itens Irregulares</div>
        <div style="font-size:12px; color:#475569; margin-top:4px;">
          Consolidado por loja (reincidência de alertas enviados)
        </div>
      </div>

      <button type="button" onclick="window.vektorCloseHistEnviosItensIrreg_()"
        style="height:34px; padding:0 12px; border-radius:10px; border:1px solid #cbd5e1;
               background:#fff; color:#0f172a; font-weight:900; cursor:pointer;">
        Fechar
      </button>
    </div>

    <div style="padding:14px;">
      <div id="itensIrregHistEnviosLoading" style="display:none; color:#334155; font-weight:900; font-size:12px; margin-bottom:8px;">
        Carregando histórico...
      </div>

      <div style="border:1px solid #e2e8f0; border-radius:12px; overflow:auto; max-height:68vh;">
        <table style="width:100%; min-width:980px; border-collapse:separate; border-spacing:0;">
          <thead>
            <tr style="background:#f1f5f9;">
              <th style="position:sticky; top:0; padding:10px; text-align:left; font-size:12px; font-weight:1000; color:#0f172a;">Loja</th>
              <th style="position:sticky; top:0; padding:10px; text-align:left; font-size:12px; font-weight:1000; color:#0f172a;">Time</th>
              <th style="position:sticky; top:0; padding:10px; text-align:right; font-size:12px; font-weight:1000; color:#0f172a;">Qtd. Envios</th>
              <th style="position:sticky; top:0; padding:10px; text-align:right; font-size:12px; font-weight:1000; color:#0f172a;">Qtd. Itens</th>
              <th style="position:sticky; top:0; padding:10px; text-align:right; font-size:12px; font-weight:1000; color:#0f172a;">Valor Total</th>
              <th style="position:sticky; top:0; padding:10px; text-align:left; font-size:12px; font-weight:1000; color:#0f172a;">Último envio</th>
              <th style="position:sticky; top:0; padding:10px; text-align:left; font-size:12px; font-weight:1000; color:#0f172a;">Status</th>
            </tr>
          </thead>
          <tbody id="itensIrregHistEnviosTbody">
            <tr><td colspan="7" style="padding:12px; font-size:12px; color:#64748b;">Sem dados.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

 <!-- VIEW: MEUS ALERTAS (sobrepõe SOMENTE a área do chat) -->
<div id="myAlertsView" class="hidden" style="position:absolute; inset:0; z-index:20;">

  <!-- MODAL: Tutorial (Alertas Programados) -->
  <div id="myAlTutorialModal"
       class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center"
       style="display:none;">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[980px] overflow-hidden border border-slate-200">
      <!-- Header -->
      <div class="px-5 py-4 text-white flex items-center justify-between"
           style="background:#005E27;">
        <div>
          <div class="text-base font-extrabold">Tutorial — Alertas Programados</div>
          <div class="text-xs opacity-90">Vídeo rápido de uso da página</div>
        </div>

        <button type="button"
                onclick="closeMyAlTutorialModal()"
                class="transition rounded-lg px-3 py-2 text-sm font-semibold"
                style="background:rgba(255,255,255,0.18);">
          Fechar
        </button>
      </div>

      <!-- Faixa destaque -->
      <div style="height:6px; background:#B5FF20;"></div>

      <!-- Body -->
      <div class="p-4" style="background:#f8fafc;">
        <div style="position:relative; padding-bottom:56.25%; height:0; border-radius:12px; overflow:hidden; border:1px solid rgba(15,23,42,0.12); background:#000;">
          <iframe
            src="https://www.loom.com/embed/4c49cc7ba6444bc9ae7931e4a9940b57"
            frameborder="0"
            webkitallowfullscreen
            mozallowfullscreen
            allowfullscreen
            style="position:absolute; top:0; left:0; width:100%; height:100%;">
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center; gap:10px;">

          <div>
            <div id="myAl_title" style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Definição de Alertas</div>
            <div style="color:rgba(226,232,240,0.9); font-size:13px; margin-top:2px;">
              <span id="myAl_subtitle">Alertas de Transações por Lojas, Times e Tags (com histórico e execução programada), disparado sempre em dias úteis.</span>
            </div>
          </div>
        </div>

        <div id="myAl_headerBtns"
             style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; transform: translateY(13px);">

          <button
            id="myAl_btnValores"
            type="button"
            onclick="openMyAlValoresContabilizadosView()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:1px solid rgba(148,163,184,0.28);
              background:rgba(255,255,255,0.10);
              color:#fff;
              font-weight:900;
              font-size:12px;
              display:flex;
              align-items:center;
              gap:8px;
            ">
            📊 Valores Contabilizados
          </button>

          <button
            id="myAl_btnTutorial"
            type="button"
            onclick="openMyAlTutorialModal()"
            style="
              height:36px;
              padding:0 14px;
              border-radius:10px;
              border:1px solid rgba(0,0,0,0.25);
              background:#00FFFF;
              color:#000;
              font-weight:900;
              font-size:12px;
              display:flex;
              align-items:center;
              gap:6px;
            ">
            ▶ Tutorial (vídeo)
          </button>
        </div>

        <div id="myAl_typeWrap" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
            <div style="color:rgba(226,232,240,0.85); font-size:13px; font-weight:900;">Tipo de alerta</div>
            <select id="myAl_alertType"
              style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                    border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
              <option value="TRANSACOES">Transações</option>
              <option value="PENDENCIAS">Pendências</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Conteúdo -->
      <div style="flex:1; overflow:auto; background:#070b14; padding:14px 16px;">

        <!-- ===== VIEW 1: Definição de Alertas (tudo que já existe) ===== -->
        <div id="myAl_defView">

          <!-- Cards: Criar + Listagem -->
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">

            <!-- Card: Criar alerta -->
            <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">
              <div style="color:#fff; font-weight:900; font-size:15px;">Criar alerta</div>
              <div style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:2px;">
                <span id="myAl_createHint">O alerta gera uma tabela (Loja, Time, Data, Estabelecimento, Valor, Etiqueta, Descrição).</span>
              </div>

              <div style="margin-top:10px; display:grid; gap:10px;">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                  <div>
                    <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Frequência</label>
                    <select id="myAl_freq" style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;">
                      <option value="DAILY">Diário</option>
                      <option value="3D">A cada 3 dias</option>
                      <option value="WEEKLY">Semanal</option>
                      <option value="MONTHLY">Mensal</option>
                    </select>
                  </div>

                  <div>
                    <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Janela de análise (dias)</label>
                    <input id="myAl_windowDays" type="number" min="1" max="365" placeholder="30"
                      title="Se vazio, considera automaticamente os últimos 30 dias."
                      style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;" />
                  </div>
                </div>

                <div>
                  <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">
                    Horário do e-mail
                  </label>
                  <select id="myAl_sendAt"
                  style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;">
                  <option value="">Selecione…</option>
                  <option value="11:30">11:30</option>
                  <option value="16:00">16:00</option>
                </select>
                </div>

                <div>
                  <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Time</label>
                  <select id="myAl_team" style="width:100%; height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px;">
                    <option value="__ALL__">Todos os times</option>
                    <option value="" disabled>Carregando…</option>
                  </select>
                </div>

                <div>
                  <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">Lojas (do time)</label>
                  <div id="myAl_storesBox" style="max-height:160px; overflow:auto; border-radius:12px; border:1px solid rgba(148,163,184,0.18); padding:10px; background:rgba(255,255,255,0.03); color:#fff;">
                    <div style="opacity:0.8; font-size:12px;">Selecione um time para listar as lojas.</div>
                  </div>
                </div>

                <div>
                  <div id="myAl_labelWrap">
                    <label style="display:block; color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">
                      Etiquetas (multi-seleção)
                    </label>

                    <select id="myAl_label" multiple
                      style="width:100%; min-height:120px; border-radius:12px; background:rgba(255,255,255,0.06);
                            color:#fff; border:1px solid rgba(148,163,184,0.18); padding:8px 10px; font-size:12px;">
                      <option value="__ALL__">Todas</option>
                    </select>

                    <div style="margin-top:6px; font-size:11px; color:rgba(226,232,240,0.75);">
                      Dica: segure Ctrl (Windows) ou Cmd (Mac) para selecionar mais de uma etiqueta.
                    </div>
                  </div>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                  <button id="myAl_saveBtn" type="button" onclick="window.vektorMyAlertsCreate()"
                    style="height:36px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:#16a34a; color:#04110a; font-weight:900; font-size:12px;">
                    Criar alerta
                  </button>

                  <button type="button" onclick="window.vektorMyAlertsRefresh()"
                    style="height:36px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;">
                    Atualizar lista
                  </button>

                  <button id="myAl_cancelEditBtn" type="button" onclick="window.vektorMyAlertsCancelEdit_()"
                    style="display:none;
                    height:36px;
                    padding:0 14px;
                    border-radius:10px;
                    border:1px solid rgba(148,163,184,0.18);
                    background:rgba(255,255,255,0.06);
                    color:#fff;
                    font-weight:900;
                    font-size:12px;
                    align-items:center;
                    justify-content:center;
                    line-height:1;">
                    Cancelar edição
                  </button>
                </div>

                <div id="myAl_createStatus" style="margin-top:4px; font-size:12px; color:rgba(226,232,240,0.85);"></div>

              </div>
            </div>

            <!-- Card: Alertas existentes -->
            <div style="background:#0b1220; border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:12px;">

              <!-- Header do card -->
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:#fff; font-weight:900; font-size:15px;">
                  Alertas cadastrados
                </div>
                <div style="color:rgba(226,232,240,0.75); font-size:12px;">
                  Seu histórico é privado. O botão <b>Executar</b> irá enviar o alerta diretamente aqui no chat. O envio por e-mail ocorrerá <b>automaticamente</b> conforme a <b>frequência</b> configurada neste alerta.
                </div>
              </div>

              <!-- Filtros ADMIN -->
              <div id="myAl_adminFilterBox" style="display:none; margin-top:12px;">

                <div style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:800; margin-bottom:6px;">
                  Filtros (Admin)
                </div>

                <div style="display:flex; gap:8px; width:100%;">

                  <input
                    id="myAl_adminEmail"
                    type="text"
                    placeholder="filtrar por e-mail"
                    style="flex:1; height:34px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-size:12px;"
                  />

                  <select
                    id="myAl_adminRole"
                    style="flex:1; height:34px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-size:12px;"
                  >
                    <option value="">Todas as áreas</option>
                  </select>

                </div>
              </div>

              <!-- ✅ LISTA: agora DENTRO do card Alertas cadastrados -->
              <div id="myAl_list"
                style="margin-top:12px; display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto; padding-right:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px;">Carregando…</div>
              </div>
            </div>

          </div> <!-- /Cards grid -->

        </div> <!-- /myAl_defView -->


        <!-- ===== VIEW 2: Valores Contabilizados (NOVA PÁGINA) ===== -->

      <div id="myAl_valoresView" style="display:none;">
      
          <!-- Filtros -->
          <div style="
              background:#0b1220;
              border:1px solid rgba(148,163,184,0.18);
              border-radius:14px;
              padding:12px;
              margin-bottom:12px;
            ">
            <div style="color:#fff; font-weight:900; font-size:13px; margin-bottom:10px;">Filtros</div>

            <div style="display:grid; grid-template-columns: 0.85fr 0.95fr 0.75fr 160px 160px auto; gap:10px; align-items:end;">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Time</div>
                <select id="myAl_val_time"
                  style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                         border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
                </select>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Loja</div>
                <select id="myAl_val_loja"
                  style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                         border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
                </select>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Conta Contábil</div>
                <select id="myAl_val_conta"
                  style="height:36px; border-radius:10px; background:rgba(255,255,255,0.06); color:#fff;
                        border:1px solid rgba(148,163,184,0.18); padding:0 10px; font-weight:900; font-size:12px;">
                  <option value="__ALL__">Todas</option>
                </select>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Período (Início)</div>
                <input id="myAl_val_dtIni" type="date"
                  style="height:34px; border-radius:10px; background:#e5e7eb; color:#0b1220;
                    border:1px solid #cbd5e1; padding:0 10px; font-weight:900; font-size:12px;"/>
              </div>

              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="color:rgba(226,232,240,0.85); font-size:12px; font-weight:900;">Período (Fim)</div>
                <input id="myAl_val_dtFim" type="date"
                  style="height:34px; border-radius:10px; background:#e5e7eb; color:#0b1220;
       border:1px solid #cbd5e1; padding:0 10px; font-weight:900; font-size:12px;"/>
              </div>

              <button
                type="button"
                onclick="myAlValoresClearFilters()"
                style="
                  height:36px;
                  padding:0 12px;
                  border-radius:10px;
                  border:1px solid rgba(148,163,184,0.22);
                  background:rgba(255,255,255,0.06);
                  color:#fff;
                  font-weight:900;
                  font-size:12px;
                ">
                Limpar
              </button>
            </div>
          </div>

            <!-- Loading (Valores Contabilizados) -->
              <div id="myAl_valLoading"
                  style="display:none; margin-bottom:12px; padding:10px 12px; border-radius:12px;
                          background:#0b1220; border:1px solid rgba(148,163,184,0.18); color:#fff; font-weight:900;">
                Carregando valores contabilizados…
                <div style="margin-top:4px; font-size:12px; color:rgba(226,232,240,0.75); font-weight:700;">
                  Aguarde a consolidação por etiqueta e categoria.
                </div>
              </div>

          <!-- Layout: Funil + Tabela -->
<div style="display:grid; grid-template-columns: 560px 1fr; gap:12px; align-items:start;">

  <!-- Gráfico por categoria (barras) -->
  <div style="background:#0b1220; border:1px solid rgba(255,255,255,0.85); border-radius:14px; padding:12px;">
    <div style="color:#fff; font-weight:900; font-size:13px; margin-bottom:10px;">
      Barras por clusterização das categorias (valor e %)
    </div>

    <div id="myAl_funilWrap" style="width:100%; overflow:hidden;">
  <div id="myAl_catChartWrap" style="height:360px; position:relative; width:100%;">
    <canvas id="myAl_catChart" style="width:100%; height:100%; display:none;"></canvas>
  </div>

  <div id="myAl_catHint"
       style="margin-top:10px; font-size:12px; color:rgba(226,232,240,0.75); font-weight:800;">
    Defina o período para exibir o gráfico.
  </div>
</div>

  </div>

  <!-- Tabela - wrapper com scroll -->
  <div style="background:#e5e7eb; border:1px solid #000; border-radius:14px; padding:10px; overflow:auto; max-height:440px;">
    <table style="width:100%; border-collapse:collapse; font-size:12px; background:#f8fafc;">
      <thead>
        <tr>
          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">Etiquetas</th>

          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">Conta Contábil</th>

          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">Valor</th>

          <th style="
            position:sticky; top:0; z-index:3;
            background:#005E27; color:#fff; font-weight:900;
            border:1px solid #000; padding:8px; text-align:center;
            background-clip:padding-box;
          ">% Valor</th>
        </tr>
      </thead>

      <tbody id="myAl_valoresTbody"></tbody>
    </table>
  </div>
</div>

          <!-- ✅ NOVO: Série 12 meses (Total + Variação) -->
          <div style="margin-top:12px; background:#0b1220; border:1px solid #ffffff; border-radius:14px; padding:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div style="color:#fff; font-weight:900; font-size:13px;">
                Evolução (últimos 12 meses) — Total e Variação mensal
              </div>
              <div id="myAl_serie12mHint" style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:800;">
                Defina o período para exibir o gráfico.
              </div>
            </div>

            <div id="myAl_serie12mWrap" style="margin-top:10px; height:340px; position:relative; width:100%;">
              <canvas id="myAl_serie12mChart" style="width:100%; height:100%; display:none;"></canvas>
            </div>
          </div>

        </div> <!-- /myAl_valoresView -->

      </div> <!-- /Conteúdo -->


      <!-- ✅ Overlay / Toast (My Alerts) -->
      <div id="myAl_overlay" style="display:none; position:absolute; inset:0; z-index:60; background:rgba(0,0,0,0.55);">
        <div style="height:100%; display:flex; align-items:center; justify-content:center; padding:16px;">
          <div style="width:min(420px, 92vw); background:#0b1220; border:1px solid rgba(148,163,184,0.25); border-radius:16px; padding:14px;">
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="vektor-spinner" style="border-top-color:#16a34a;"></div>
              <div>
                <div id="myAl_overlayTitle" style="color:#fff; font-weight:900; font-size:13px;">Carregando…</div>
                <div id="myAl_overlaySub" style="color:rgba(226,232,240,0.75); font-size:12px; margin-top:2px;">Aguarde um instante.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="myAl_toast" style="display:none; position:absolute; right:16px; bottom:16px; z-index:70;
        background:#0b1220; border:1px solid rgba(148,163,184,0.25); border-radius:14px; padding:10px 12px; min-width:260px;">
        <div id="myAl_toastMsg" style="color:#fff; font-weight:900; font-size:12px;">OK</div>
      </div>

    </div>
  </main>
</div>

 <!-- VIEW: FEEDBACK (sobrepõe SOMENTE a área do chat) -->
<div id="feedbackView" class="hidden" style="position:absolute; inset:0; z-index:20;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div style="height:100%; width:100%; display:flex; flex-direction:column;">

      <!-- Header do Feedback -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Feedback do Vektor</div>
            <div style="color:rgba(226,232,240,0.9); font-size:12px; margin-top:2px;">
              Preencha e envie o formulário sem sair do Vektor
            </div>
          </div>
        </div>
      </div>

      <!-- Conteúdo (iframe do Google Forms) -->
      <div style="flex:1; background:#0b1220; padding:14px 16px;">
        <div style="height:100%; background:#ffffff; border-radius:14px; overflow:hidden; border:1px solid rgba(148,163,184,0.25);">
          <iframe
            id="feedbackFrame"
            title="Formulário de Feedback"
            src="https://docs.google.com/forms/d/e/1FAIpQLSfk-XlpYWvA_WgfcMq9o0VC-QhqXfygFgwdTsrlJmQ-OEyKIw/viewform?embedded=true"
            style="width:100%; height:100%; border:0;"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
          ></iframe>
        </div>
      </div>

    </div>
  </main>

</div> <!-- fecha #feedbackView -->

<!-- VIEW: FLUXOGRAMA (sobrepõe SOMENTE a área do chat) -->
<div id="fluxogramaView" class="hidden" style="position:absolute; inset:0; z-index:20;">

  <main class="chat-body" style="padding:0; height:100%; overflow:hidden;">
    <div class="vektor-fluxo-bg relative overflow-hidden"
     style="height:100%; width:100%; display:flex; flex-direction:column;">
        <div class="vektor-fluxo-bg-layer" aria-hidden="true"></div>

      <!-- Header do Fluxograma -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(226,232,240,1); background:#0b1220;">
        <div style="display:flex; align-items:center;">

          <div>
            <div style="color:#fff; font-weight:900; font-size:16px; letter-spacing:0.2px;">Fluxograma do Vektor</div>
            <div style="color:rgba(226,232,240,0.9); font-size:14px; margin-top:2px;">
              Visão interna do funcionamento (bases, jobs, consultas e entregas)
            </div>
          </div>
        </div>

        <!-- Ações do header (direita) -->
        <div style="display:flex; align-items:center; gap:10px;">
          <button type="button"
                  onclick="vektorOpenFluxogramaDetalhado_()"
                  style="height:36px; padding:0 12px; border-radius:10px; border:1px solid rgba(181,255,32,0.45); background:rgba(2,6,23,0.35); color:#fff; font-weight:1000; font-size:12px; cursor:pointer;">
            Ver fluxograma detalhado
          </button>
        </div>

      </div>

      <!-- Conteúdo -->
      <div style="flex:1; padding:16px; overflow:auto; background:radial-gradient(1200px 900px at 20% 0%, rgba(181,255,32,0.14), transparent 55%), radial-gradient(900px 700px at 90% 20%, rgba(0,94,39,0.22), transparent 55%), #07110c;">
        <div style="max-width:1100px; margin:0 auto;">

          <!-- Legend -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <div style="color:rgba(226,232,240,0.92); font-size:14px;">
              <b>Objetivo:</b> mostrar como o Vektor percorre <b>fontes → processamento → regras → saídas</b>.
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(181,255,32,0.35); background:rgba(2,6,23,0.35); color:#fff; font-size:11px; font-weight:800;">
                ■ Caixas: componentes
              </span>
              <span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(181,255,32,0.35); background:rgba(2,6,23,0.35); color:#fff; font-size:11px; font-weight:800;">
                ⟶ Setas: fluxo de dados
              </span>
            </div>
          </div>

          <!-- Flow container (zig-zag) -->
          <div class="flow-container" style="position:relative; padding:14px 12px 24px; border-radius:18px; border:1px solid rgba(148,163,184,0.20); background:rgba(2,6,23,0.35);">

            <!-- SVG overlay dos conectores (setas “coladas” nas caixas, com cotovelo reto) -->
            <svg id="fluxoConnectorsSvg"
                style="position:absolute; inset:0; width:100%; height:100%; z-index:5; pointer-events:none; shape-rendering:geometricPrecision;"
                viewBox="0 0 1000 1000" preserveAspectRatio="none">
              <defs>
              <marker id="arrowHeadGreen" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto">
              <polygon points="0,0 7,3.5 0,7" fill="rgb(181,255,32)" fill-opacity="1"></polygon>
            </marker>

            <marker id="arrowHeadDarkGreen" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto">
              <polygon points="0,0 7,3.5 0,7" fill="rgb(34,197,94)" fill-opacity="1"></polygon>
            </marker>

              </defs>
            </svg>

            <!-- Step 1 (left) -->
<div style="display:flex; justify-content:flex-start;">
  <div id="fgStep1" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(181,255,32,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">1) Fontes (entrada)</div>
    <div style="margin-top:6px; font-size:13px; color:rgba(226,232,240,0.88); line-height:1.35;">
      • <b>API CLara</b>: Em desenvolvimento<br/>
      • <b>Google Sheets</b>: Base de transações da Clara + consultas auxiliares<br/>
      • <b>BigQuery</b>: consultas e validações (deduplicação, agregações e cruzamentos quando aplicável)<br/>
      • <b>PropertiesService</b>: controle de execução (última execução, estado de jobs, parâmetros, anti-spam)<br/>
      • <b>Drive</b>: anexos/exports (CSV/XLSX), evidências e arquivos de apoio
    </div>
  </div>
</div>

<!-- Spacer (sem connector SVG solto) -->
<div style="height:26px;"></div>

<!-- Step 2 (right) -->
<div style="display:flex; justify-content:flex-end;">
  <div id="fgStep2" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(34,197,94,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">2) Orquestração (jobs & gatilhos)</div>
    <div style="margin-top:6px; font-size:13px; color:rgba(226,232,240,0.88); line-height:1.35;">
      • <b>Triggers</b>: agendadores (ex.: execução periódica para alertas, monitoramento e rotinas)<br/>
      • <b>Jobs</b>: consolidação, verificação de consistência, enriquecimento e atualização de sinais operacionais<br/>
      • <b>APIs/Serviços</b>: Drive, Sheets, BigQuery, MailApp (chamadas conforme necessidade do fluxo)<br/>
      • <b>Logs</b>: registro de execução (sucesso/erro), auditoria e rastreabilidade operacional
    </div>
  </div>
</div>

<!-- Spacer -->
<div style="height:26px;"></div>

<!-- Step 3 (left) -->
<div style="display:flex; justify-content:flex-start;">
  <div id="fgStep3" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(181,255,32,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">3) Motor de regras (governança & inteligência)</div>
    <div style="margin-top:6px; font-size:13px; color:rgba(226,232,240,0.88); line-height:1.35;">
      • <b>Regras de pendência</b>: etiqueta vazia, recibo = “Não”, descrição vazia<br/>
      • <b>Classificações e alertas</b>: padrões, exceções, limites, lojas ofensoras e possíveis irregularidades (quando aplicável)<br/>
      • <b>Normalização</b>: datas, valores, textos, lojas (CE####), times e filtros consistentes<br/>
      • <b>Consolidações</b>: métricas por Loja, Time, período e tipo (Etiqueta / NF / Descrição)<br/>
      • <b>Detecção de duplicidade e fraude “simples”</b>: transações repetidas (mesmo valor/estabelecimento/data/loja), split de compras (várias transações pequenas em sequência), categorias incompatíveis.
    </div>
  </div>
</div>

<!-- Spacer -->
<div style="height:26px;"></div>

<!-- Step 4 (right) -->
<div style="display:flex; justify-content:flex-end;">
  <div id="fgStep4" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(34,197,94,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">4) Produtos (saídas visíveis)</div>
    <div style="margin-top:6px; font-size:13px; color:rgba(226,232,240,0.88); line-height:1.35;">
      • <b>Chat</b>: consultas, tabelas, rankings e resumos com explicação de “como foi calculado”<br/>
      • <b>Alertas Programados</b>: Transações e Pendências (histórico + execução programada por e-mail)<br/>
      • <b>Alertas Operacionais</b>: limites de cartões, lojas ofensoras, irregularidades e monitoramentos (quando aplicável)<br/>
      • <b>Disparo de Pendências</b>: Envio de e-mails alertando sobre pendencias, procedimento automtizado via Script<br/>
       • <b>Indicadores de Uso</b>: Visão detalhada sobre gastos, mapeando as transações por diferentes critérios de filtros<br/>
      • <b>Radar</b>: indicadores e ranking de risco (admin, quando aplicável)<br/>
      • <b>Exportações</b>: CSV/XLSX e evidências conforme necessidade do processo
    </div>
  </div>
</div>

<!-- Spacer -->
<div style="height:26px;"></div>

<!-- Step 5 (left) -->
<div style="display:flex; justify-content:flex-start;">
  <div id="fgStep5" style="position:relative; z-index:2; width:min(520px, 92%); border-radius:16px; padding:12px 14px; background:#000; color:#fff; border:1px solid rgba(181,255,32,0.55); box-shadow:0 10px 26px rgba(0,0,0,0.35);">
    <div style="font-weight:1000; letter-spacing:0.2px;">5) Evidências, auditoria & governança</div>
    <div style="margin-top:6px; font-size:13px; color:rgba(226,232,240,0.88); line-height:1.35;">
      • <b>E-mail (MailApp)</b>: envio com <b>anexo</b> (CSV/XLSX) e corpo consolidado (quando aplicável)<br/>
      • <b>Logs de execução</b>: rastreabilidade por job/alerta/rodada/quantidade de linhas e período<br/>
      • <b>RBAC</b>: controle de acesso por role/whitelist (sem expor dados indevidos)<br/>
      • <b>Confiabilidade</b>: validações, consistência e histórico para suporte e auditoria<br/>
      • <b>Snapshot/Imutabilidade</b>: registro “congelado” da rodada (txKeys + hash do dataset/anexo) para prova de evidência
    </div>
  </div>
</div>

          </div><!-- /flow container -->

        </div>
      </div>

    </div>
  </main>

</div> <!-- fecha #fluxogramaView -->

<!-- Modal full-screen: Fluxograma detalhado (SVG) -->
<div id="vektor_fluxoDetModal" class="hidden" aria-hidden="true">
  <div id="vektor_fluxoDetBackdrop"></div>

  <div id="vektor_fluxoDetPanel" role="dialog" aria-modal="true">
    <div id="vektor_fluxoDetHeader">
      <div>
        <div id="vektor_fluxoDetTitle">Fluxograma detalhado — Arquitetura Vektor</div>
        <div id="vektor_fluxoDetSub">Use +/– para zoom.</div>
      </div>

      <div id="vektor_fluxoDetActions">
        <button type="button" class="vektor_fluxoDetBtn" onclick="vektorFluxoDetZoom_(-0.15)">–</button>
        <button type="button" class="vektor_fluxoDetBtn" onclick="vektorFluxoDetZoom_(+0.15)">+</button>
        <button type="button" class="vektor_fluxoDetBtn" onclick="vektorFluxoDetZoomReset_()">100%</button>
        <button id="vektor_fluxoDetClose" type="button" onclick="vektorCloseFluxogramaDetalhado_()" title="Fechar">×</button>
      </div>
    </div>

    <div id="vektor_fluxoDetBody">
      <div id="vektor_fluxoDetStageWrap">
        <div id="vektor_fluxoDetStage">
          <!-- SVG do fluxograma detalhado (vetorial / sem imagem externa) -->
          <svg id="vektor_fluxoDetSvg" viewBox="0 0 1600 1300" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Fluxograma detalhado do Vektor">
            <defs>
              <style>
                .tTitle{ font: 800 16px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#0b1220; }
                .tSub{ font: 700 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#334155; }
                .tTxt{ font: 700 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#0f172a; }
                .tSmall{ font: 700 11px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#0f172a; }
                .box{ rx:16; ry:16; fill:#ffffff; stroke:#cbd5e1; stroke-width:1.2; }
                .boxDark{ rx:16; ry:16; fill:#0b1220; stroke:#0b1220; stroke-width:1.2; }
                .capBlue{ fill:#061a3a; }
                .capOrange{ fill:#c2410c; }
                .capGreen{ fill:#166534; }
                .capLime{ fill:#b5ff20; }
                .capTxt{ font: 1000 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#ffffff; }
                .capTxtDark{ font: 1000 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#0b1220; }
                .line{ stroke:#0f172a; stroke-width:2; fill:none; opacity:.75; }
                .lineG{ stroke:#16a34a; stroke-width:2.4; fill:none; opacity:.85; }
              </style>

              <marker id="arr" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                <path d="M0,0 L9,3 L0,6 Z" fill="#0f172a"/>
              </marker>
              <marker id="arrG" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                <path d="M0,0 L9,3 L0,6 Z" fill="#16a34a"/>
              </marker>
            </defs>

            <!-- ========= TOPO: Usuário ========= -->
            <circle cx="800" cy="70" r="28" fill="#ffffff" stroke="#cbd5e1" stroke-width="1.2"/>
            <text x="800" y="76" text-anchor="middle" class="tTxt">Usuário</text>

            <!-- ========= BLOCO: Entrada e Navegação ========= -->
            <rect x="120" y="130" width="560" height="190" class="box"/>
            <rect x="120" y="130" width="560" height="34" rx="16" ry="16" class="capBlue"/>
            <text x="140" y="152" class="capTxt">Entrada e Navegação</text>

            <rect x="140" y="184" width="180" height="50" rx="12" ry="12" fill="#0b3a7a" opacity="0.95"/>
            <text x="230" y="214" text-anchor="middle" class="capTxt">Entrada do Usuário</text>

            <rect x="340" y="178" width="320" height="132" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="360" y="202" class="tSmall">• Chat (consulta + comandos)</text>
            <text x="360" y="222" class="tSmall">• Páginas dedicadas (Alertas / Pendências)</text>
            <text x="360" y="242" class="tSmall">• Filtros (período, loja, regional)</text>
            <text x="360" y="262" class="tSmall">• Ações guiadas (botões + modais)</text>
            <text x="360" y="282" class="tSmall">• Perfil de acesso (admin / usuário)</text>

            <!-- ========= BLOCO: Arquitetura GAS ========= -->
            <rect x="920" y="130" width="560" height="270" class="box"/>
            <rect x="920" y="130" width="560" height="34" rx="16" ry="16" class="capBlue"/>
            <text x="940" y="152" class="capTxt">Arquitetura GAS</text>

            <rect x="980" y="190" width="180" height="44" rx="12" ry="12" fill="#0b3a7a" opacity="0.95"/>
            <text x="1070" y="218" text-anchor="middle" class="capTxt">Backend Apps Script</text>

            <rect x="1220" y="190" width="200" height="44" rx="12" ry="12" fill="#0b3a7a" opacity="0.95"/>
            <text x="1320" y="218" text-anchor="middle" class="capTxt">Chamada ao Backend</text>

            <rect x="980" y="250" width="440" height="124" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="1000" y="274" class="tSmall">• Validação / RBAC</text>
            <text x="1000" y="294" class="tSmall">• Orquestração (jobs, envios, exportações)</text>
            <text x="1000" y="314" class="tSmall">• Logs e rastreabilidade</text>
            <text x="1000" y="344" class="tSmall">• Contrato controlado: google.script.run</text>

            <!-- ========= BLOCO: Camada de Aplicação ========= -->
            <rect x="520" y="370" width="560" height="180" class="box"/>
            <rect x="520" y="370" width="560" height="34" rx="16" ry="16" class="capBlue"/>
            <text x="540" y="392" class="capTxt">Camada de Aplicação (Web App)</text>

            <rect x="540" y="424" width="160" height="46" rx="12" ry="12" fill="#0b3a7a" opacity="0.95"/>
            <text x="620" y="452" text-anchor="middle" class="capTxt">Frontend Web App</text>

            <rect x="720" y="424" width="340" height="106" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="740" y="448" class="tSmall">• Normalização e parsing</text>
            <text x="740" y="468" class="tSmall">• Controle de estado (views/modais)</text>
            <text x="740" y="488" class="tSmall">• Renderização (KPIs, gráficos, tabelas)</text>
            <text x="740" y="508" class="tSmall">• Confirmação explícita prévia (envios)</text>

            <!-- ========= BLOCO: Fontes de Dados e Históricos ========= -->
            <rect x="120" y="600" width="820" height="370" class="box"/>
            <rect x="120" y="600" width="820" height="34" rx="16" ry="16" class="capBlue"/>
            <text x="140" y="622" class="capTxt">Fontes de Dados & Históricos</text>

            <rect x="150" y="670" width="220" height="50" rx="12" ry="12" fill="#0b3a7a" opacity="0.95"/>
            <text x="260" y="700" text-anchor="middle" class="capTxt">Fontes de Dados</text>

            <rect x="150" y="740" width="260" height="120" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="170" y="766" class="tSmall">• Fonte operacional + histórico</text>

            <rect x="150" y="880" width="260" height="80" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="170" y="906" class="tSmall">Operacional (AS-IS)</text>
            <text x="170" y="928" class="tSmall">• BaseClara (Sheets)</text>
            <text x="170" y="950" class="tSmall">• Acessos / mapeamentos</text>

            <rect x="440" y="880" width="260" height="80" rx="14" ry="14" fill="#fff7ed" stroke="#fdba74"/>
            <text x="460" y="906" class="tSmall">Escalabilidade (TO-BE)</text>
            <text x="460" y="928" class="tSmall">• BigQuery / API Clara</text>
            <text x="460" y="950" class="tSmall">• Consolidação / trilhas</text>

            <rect x="720" y="880" width="200" height="80" rx="14" ry="14" fill="#ecfdf5" stroke="#86efac"/>
            <text x="740" y="906" class="tSmall">Históricos / Logs</text>
            <text x="740" y="928" class="tSmall">• HIST_* / auditoria</text>
            <text x="740" y="950" class="tSmall">• Execuções / envios</text>

            <!-- ========= BLOCO: Camada Transacional ========= -->
            <rect x="980" y="600" width="500" height="170" class="box"/>
            <rect x="980" y="600" width="500" height="34" rx="16" ry="16" class="capOrange"/>
            <text x="1000" y="622" class="capTxt">Camada Transacional</text>

            <rect x="1010" y="660" width="180" height="44" rx="12" ry="12" fill="#c2410c" opacity="0.95"/>
            <text x="1100" y="688" text-anchor="middle" class="capTxt">Ações Transacionais</text>

            <rect x="1210" y="650" width="250" height="110" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="1230" y="676" class="tSmall">• Envio e-mails (loja/regional/CC)</text>
            <text x="1230" y="696" class="tSmall">• Alertas programados (rotinas)</text>
            <text x="1230" y="716" class="tSmall">• Histórico / auditoria (logs)</text>

            <!-- ========= BLOCO: Camada Analítica ========= -->
            <rect x="980" y="800" width="500" height="160" class="box"/>
            <rect x="980" y="800" width="500" height="34" rx="16" ry="16" class="capOrange"/>
            <text x="1000" y="822" class="capTxt">Camada Analítica</text>

            <rect x="1010" y="860" width="220" height="44" rx="12" ry="12" fill="#c2410c" opacity="0.95"/>
            <text x="1120" y="888" text-anchor="middle" class="capTxt">Motor Analítico (det.)</text>

            <rect x="1240" y="850" width="230" height="110" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="1260" y="876" class="tSmall">• Elegibilidade e classificação</text>
            <text x="1260" y="896" class="tSmall">• Cruzamento multidimensional</text>
            <text x="1260" y="916" class="tSmall">• Indicadores + séries temporais</text>
            <text x="1260" y="936" class="tSmall">• Regras explícitas auditáveis</text>

                        <!-- ========= BLOCO: Governança Operacional ========= -->
            <rect x="1010" y="950" width="470" height="108" class="box"/>
            <rect x="1010" y="950" width="470" height="34" rx="16" ry="16" class="capGreen"/>
            <text x="1030" y="972" class="capTxt">Governança Operacional</text>

            <rect x="1040" y="998" width="220" height="48" rx="12" ry="12" fill="#b5ff20" opacity="0.95"/>
            <text x="1150" y="1028" text-anchor="middle" class="capTxtDark">Governança (prévia)</text>

            <rect x="1280" y="990" width="175" height="58" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <text x="1298" y="1014" class="tSmall">• Prévia analítica</text>
            <text x="1298" y="1034" class="tSmall">• Seleção + registro</text>

            <!-- ========= BLOCO: Saída / Visualização ========= -->
            <rect x="250" y="1090" width="1230" height="185" class="box"/>
            <rect x="250" y="1090" width="1230" height="34" rx="16" ry="16" class="capGreen"/>
            <text x="270" y="1112" class="capTxt">Saída / Renderização</text>

            <!-- UI / Visual -->
            <rect x="285" y="1140" width="360" height="102" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <rect x="305" y="1154" width="185" height="36" rx="12" ry="12" fill="#16a34a" opacity="0.95"/>
            <text x="397" y="1177" text-anchor="middle" class="capTxt">UI / Visual</text>
            <text x="305" y="1206" class="tSmall">• KPIs e cards (ciclo, pendências, irregularidades)</text>
            <text x="305" y="1224" class="tSmall">• Tabelas interativas + drilldown por loja/time/estab.</text>

            <!-- Operacional -->
            <rect x="685" y="1140" width="390" height="102" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <rect x="705" y="1154" width="190" height="36" rx="12" ry="12" fill="#16a34a" opacity="0.95"/>
            <text x="800" y="1177" text-anchor="middle" class="capTxt">Operacional</text>
            <text x="705" y="1206" class="tSmall">• Filtros persistentes + macro visões + aplicar/salvar</text>
            <text x="705" y="1224" class="tSmall">• Alertas, disparos assistidos e escalonamento por SLA</text>

            <!-- Evidências / Auditoria -->
            <rect x="1115" y="1140" width="330" height="102" rx="14" ry="14" fill="#f8fafc" stroke="#e2e8f0"/>
            <rect x="1135" y="1154" width="205" height="36" rx="12" ry="12" fill="#16a34a" opacity="0.95"/>
            <text x="1237" y="1177" text-anchor="middle" class="capTxt">Evidências / Auditoria</text>
            <text x="1135" y="1206" class="tSmall">• Exports, rodadas, histórico, logs e notificações</text>
            <text x="1135" y="1224" class="tSmall">• Status, acesso, trilha e auditoria operacional</text>

            <!-- Linha-resumo inferior -->
            <text x="285" y="1260" class="tSmall">Inclui: período/loja/time/categoria, registro de quem disparou/quando/quantidade/resultado, histórico SENT/FAIL, destinatários, anexos e evidências vinculadas à rodada.</text>

            <!-- ========= CONEXÕES (setas) ========= -->
            <!-- Usuário -> Entrada e Navegação -->
            <path d="M800,98 L800,120 L400,120 L400,130" class="line" marker-end="url(#arr)"/>
            <!-- Usuário -> Arquitetura GAS -->
            <path d="M800,98 L800,120 L1200,120 L1200,130" class="line" marker-end="url(#arr)"/>

            <!-- Entrada -> App -->
            <path d="M680,240 L760,240 L760,370" class="lineG" marker-end="url(#arrG)"/>
            <!-- GAS -> App -->
            <path d="M1200,400 L1200,450 L1080,450" class="lineG" marker-end="url(#arrG)"/>

            <!-- Fontes -> GAS -->
            <path d="M410,920 L760,920 L760,520 L980,520 L980,250" class="line" marker-end="url(#arr)"/>

            <!-- App -> Transacional -->
            <path d="M1080,550 L1080,600" class="lineG" marker-end="url(#arrG)"/>

            <!-- App -> Analítica -->
            <path d="M1000,550 L1340,550 L1340,800" class="lineG" marker-end="url(#arrG)"/>

            <!-- Governança -> Saída -->
            <path d="M1150,1058 L1150,1090" class="lineG" marker-end="url(#arrG)"/>

            <!-- Transacional -> Históricos -->
            <path d="M1100,770 L1100,880 L920,880" class="line" marker-end="url(#arr)"/>
          </svg>
        </div>
      </div>
    </div>
  </div>
</div>

 <!-- Modal: Como acontece a análise? (Radar) -->
<div id="radarAnaliseModal"
     class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[860px] overflow-hidden border border-slate-200">
    <!-- Header -->
    <div class="px-5 py-4 bg-[#0b1220] text-white flex items-center justify-between">
      <div>
        <div class="text-base font-extrabold">Como acontece a análise?</div>
        <div class="text-xs opacity-90">Leitura objetiva do heatmap (correlação) e do ranking de risco</div>
      </div>
      <button type="button"
              onclick="closeRadarAnaliseModal()"
              class="bg-white/15 hover:bg-white/25 transition rounded-lg px-3 py-2 text-sm font-semibold">
        Fechar
      </button>
    </div>

    <!-- Body -->
    <div class="p-5 text-sm text-slate-700 space-y-4 max-h-[70vh] overflow-y-auto">
      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-semibold text-slate-900">1) Correlação (Pearson)</div>
        <div class="mt-2 text-sm">
          O heatmap mede <b>relação entre métricas</b> (não aponta loja individual).
          <br/>
          <b>+1</b> = sobem juntas · <b>0</b> = sem relação · <b>-1</b> = uma sobe e a outra tende a descer.
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold text-slate-900">Interpretação (positiva)</div>
          <div class="mt-2 overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-xl overflow-hidden">
              <thead class="bg-slate-100">
                <tr>
                  <th class="text-left px-3 py-2 border-b">Valor</th>
                  <th class="text-left px-3 py-2 border-b">Interpretação</th>
                </tr>
              </thead>
              <tbody>
                <tr><td class="px-3 py-2 border-b">0.00 – 0.19</td><td class="px-3 py-2 border-b">Irrelevante</td></tr>
                <tr><td class="px-3 py-2 border-b">0.20 – 0.39</td><td class="px-3 py-2 border-b">Fraca</td></tr>
                <tr><td class="px-3 py-2 border-b">0.40 – 0.59</td><td class="px-3 py-2 border-b">Moderada</td></tr>
                <tr><td class="px-3 py-2 border-b">0.60 – 0.79</td><td class="px-3 py-2 border-b">Forte</td></tr>
                <tr><td class="px-3 py-2">0.80 – 1.00</td><td class="px-3 py-2">Muito forte</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-xl border border-slate-200 p-4">
          <div class="font-semibold text-slate-900">Interpretação (negativa)</div>
          <div class="mt-2 text-sm">
            A escala negativa tem a mesma “força”, mas no sentido inverso:
            <br/>
            <b>-1</b> = quando uma métrica sobe, a outra tende a descer.
          </div>
          <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm border border-slate-200 rounded-xl overflow-hidden">
              <thead class="bg-slate-100">
                <tr>
                  <th class="text-left px-3 py-2 border-b">Valor</th>
                  <th class="text-left px-3 py-2 border-b">Interpretação</th>
                </tr>
              </thead>
              <tbody>
                <tr><td class="px-3 py-2 border-b">-0.00 – -0.19</td><td class="px-3 py-2 border-b">Irrelevante</td></tr>
                <tr><td class="px-3 py-2 border-b">-0.20 – -0.39</td><td class="px-3 py-2 border-b">Fraca (inversa)</td></tr>
                <tr><td class="px-3 py-2 border-b">-0.40 – -0.59</td><td class="px-3 py-2 border-b">Moderada (inversa)</td></tr>
                <tr><td class="px-3 py-2 border-b">-0.60 – -0.79</td><td class="px-3 py-2 border-b">Forte (inversa)</td></tr>
                <tr><td class="px-3 py-2">-0.80 – -1.00</td><td class="px-3 py-2">Muito forte (inversa)</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-semibold text-slate-900">
          Métricas utilizadas no Radar
        </div>

        <ul class="mt-3 text-sm space-y-2">
          <li>
            <b>AVG (Average Score)</b> – média do score de irregularidade das transações da loja no período.
            Indica se o comportamento é recorrente ou pontual.
          </li>

          <li>
            <b>MAX (Maximum Score)</b> – maior score de irregularidade identificado em uma única transação.
            Destaca picos críticos mesmo que isolados.
          </li>

          <li>
            <b>PEND (Pending Rate)</b> – percentual de transações com pendência de justificativa ou documentação.
            Mede risco operacional e falhas de conformidade.
          </li>

          <li>
            <b>QTD/D (Quantidade por Dia)</b> – média de transações realizadas por dia no período analisado.
            Ajuda a identificar frequência atípica de uso.
          </li>

          <li>
            <b>VALOR (Valor Financeiro)</b> – valor financeiro médio ou máximo das transações analisadas.
            Auxilia na avaliação de impacto financeiro potencial.
          </li>
        </ul>
      </div>

      <div class="rounded-xl border border-slate-200 p-4">
        <div class="font-semibold text-slate-900">2) Ranking “Lojas mais próximas”</div>
        <div class="mt-2 text-sm">
          O número do ranking (ex.: <b>55</b>) é um <b>índice relativo de prioridade</b> (0–100), calculado por score composto:
          <br/>
          <b>55% MAX_SCORE + 30% CASOS + 15% PEND_RATE</b> (com normalização 0–1 por período).
          <br/>
          Quanto maior, maior a prioridade de análise — <b>não</b> é prova de fraude.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de apresentação do Vektor -->

<div id="vektorModal"
     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
     style="display:none;">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[600px] w-[95%]">
    <div class="rounded-xl overflow-hidden">
      <iframe
        src="https://drive.google.com/file/d/1nYhrveAoL2A5cYfV_LdzXECC2_5BpM-b/preview"
        width="100%"
        height="340"
        allow="autoplay"
        style="border:0;"
      ></iframe>
    </div>

    <button onclick="closeVektorModal()"
            class="mt-3 w-full bg-[#005E27] text-white py-2 rounded-lg text-sm font-semibold">
      Continuar
    </button>
  </div>
</div>

<!-- Modal do Manual da Clara -->
<div id="manualClaraModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[520px] w-[95%]">
    <h2 class="text-base font-semibold text-slate-800 mb-2">
      Manual da Clara – principais tópicos
    </h2>
    <p class="text-xs text-slate-500 mb-3">
      Escolha um dos itens abaixo. A resposta aparece aqui no chat.
    </p>

    <div class="flex flex-col gap-2 text-sm text-slate-700">

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('primeiro_acesso'); closeManualClaraModal();">
        01 Primeiro acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('recebi_cartao'); closeManualClaraModal();">
        02 Recebi o cartão, e agora?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('esqueci_senha'); closeManualClaraModal();">
        03 Esqueci a senha do cartão / acesso
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('qual_meu_acesso'); closeManualClaraModal();">
        04 Qual o meu acesso?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('anexar_comprovante'); closeManualClaraModal();">
        05 Como anexar comprovante?
      </button>

      <button type="button"
              class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-left"
              onclick="window.vektorManualClaraSecao('duvidas'); closeManualClaraModal();">
        06 Dúvidas
      </button>
    </div>

    <button type="button"
            onclick="closeManualClaraModal()"
            class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<div id="statusVektorModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[520px] w-[95%] text-sm text-slate-700 relative overflow-hidden vektor-status-card">
    <h2 class="text-base font-semibold text-slate-800 mb-3">
      Status
    </h2>

    <ul class="space-y-2">
    <!-- Sempre visível -->
    <li><b>Última atualização da Base de Transações:</b> <span id="status-baseclara">—</span></li>
    <li><b>Status Geral:</b> <span id="status-geral">—</span></li>

    <? if ((userRole || "") === "Administrador") { ?>
      <!-- Somente Admin -->
      <li><b>Última execução dos jobs:</b> <span id="status-jobs">—</span></li>
      <li><b>Usuários ativos hoje:</b> <span id="status-ativos-hoje">—</span></li>
      <li><b>Serviços Google (Apps Script / E-mail):</b> <span id="status-google">—</span></li>
      <li><b>BigQuery:</b> <span id="status-bigquery">—</span></li>
      <!-- <li><b>Manutenção:</b> <span id="status-manutencao">—</span></li>-->
    <? } ?>
  </ul>


    <button
      onclick="closeStatusVektorModal()"
      class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<!-- Modal do Como Usar o Vektor -->
<div id="ajudaVektorModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white p-5 rounded-xl shadow-lg max-w-[720px] w-[95%]">
    <h2 class="text-base font-semibold text-slate-800 mb-2">
      Como usar o Vektor ❓
    </h2>
    <p class="text-xs text-slate-500 mb-3">
      Guia rápido dos principais procedimentos e exemplos de uso.
    </p>

    <!-- Conteúdo com scroll (para não estourar a tela) -->
    <div class="text-sm text-slate-700 space-y-3 max-h-[60vh] overflow-y-auto pr-2">

      <p>
        O Vektor é a plataforma de governança financeira do cartão Clara, onde é possível, entre outras coisas: consultar bases, aplicar regras padronizadas e criar ações para reduzir pendências.
      </p>

      <div>
        <p class="font-semibold text-slate-800">Principais procedimentos:</p>
        <ul style="margin-left:14px; line-height:1.55; margin-top:6px;">
          <li>
            <b>1) Pendências e regularização</b><br/>
            • Consultar pendências por loja/time e exibir tabela detalhada.<br/>
            <i>Exemplos:</i> “pendências da loja 0297”, “lojas com mais pendências”, “pendências do time Furacão Sul”.
          </li>

          <li style="margin-top:10px;">
            <b>2) Relatório Gerencial</b><br/>
            • Relatório Looker Studio com as principais métricas de uso do cartão.<br/>
            <i>Exemplos:</i> “Abrir relatório gerencial da Clara”.
          </li>

          <li style="margin-top:10px;">
            <b>3) Faturas e comparativos</b><br/>
            • Consulta valores, extrai informações e compara com fatura anterior.<br/>
            <i>Exemplos:</i> “valor da fatura atual”, “valor das últimas 3 faturas”, "Comparar fatura atual vs anterior", “qual é o ciclo da fatura?”.
          </li>

          <li style="margin-top:10px;">
            <b>4) Rankings e análises gerenciais</b><br/>
            • Rankings por loja/time/categoria/estabelecimento e comparativos por período.<br/>
            <i>Exemplos:</i> “ranking de lojas com maior valor”, “categorias com maior valor”, “estabelecimentos mais usados”.
          </li>

          <li style="margin-top:10px;">
            <b>5) Estornos</b><br/>
            • Exibe tabelas de estornos quando disponível no seu perfil.<br/>
            <i>Exemplos:</i> “tabela de estornos”, “tabela de estornos do time”.
          </li>

                    <li style="margin-top:10px;">
            <b>6) Alertas Programados (e-mail)</b><br/>
            • Permite cadastrar alertas recorrentes, com envio automático por e-mail e anexo (CSV/XLSX), conforme filtros configurados.<br/>
            • Existem 2 tipos: <b>Transações</b> (por Lojas/Times/Tags) e <b>Pendências</b> (por Lojas/Times e Tipos de pendências).<br/>
            <i>Como acessar:</i> Menu → “⏱️ Alertas Programados”.<br/>
            <i>Dicas:</i> use “Executar” para testar o alerta imediatamente no chat; o envio por e-mail segue a frequência/horário configurados.
          </li>

          <li style="margin-top:10px;">
            <b>7) Possível uso irregular</b><br/>
            • Apoia investigação e leitura objetiva do que disparou o alerta.<br/>
            <i>Exemplo:</i> “possível uso irregular”.
          </li>

          <li style="margin-top:10px;">
            <b>8) Cartão (bloqueio, perda, suporte e direcionamento)</b><br/>
            • Orienta o procedimento e encaminha para o canal correto (ex.: ServiceNow).<br/>
            <i>Exemplos:</i> “perdi meu cartão”, “cartão bloqueado, como resolver?”, “servicenow”.
          </li>

          <li style="margin-top:10px;">
            <b>9) Listagem de Itens Comprados</b><br/>
            • Relatórios com análises dos itens adquirido pela lojas (levando em consideração o campo descrição das transações).<br/>
            <i>Exemplos:</i> “Itens comprados no geral”, “Itens comprados para o time xxxxxxxx”, “Itens comprados para a loja xxxx”.
          </li>

          <li style="margin-top:10px;">
            <b>10) Limite dos cartões</b><br/>
            • Demonstra o saldo dos cartões, probabilidade de uso, possibilidade de aumento ou redução de limite.<br/>
            <i>Exemplos:</i> “Relação de saldos geral”, “Relação de saldos do time xxxxxxxx”.
          </li>

          <li style="margin-top:10px;">
            <b>11) Termo de responsabilidade</b><br/>
            • Anexar o termo pelo botão de clipe e concluir com nome completo.<br/>
            <i>Exemplo:</i> “termo de responsabilidade Clara”.
          </li>
        </ul>
      </div>

      <div>
        <p class="font-semibold text-slate-800">⚠️ Regras importantes ⚠️</p>
        <ul style="margin-left:14px; line-height:1.55; margin-top:6px;">
          <li><b>Padronização:</b> respostas seguem política/processo (não “opinião do Vektor”).</li>
          <li><b>Perfil de acesso:</b> algumas visões são restritas ao perfil de Administrador.</li>
          <li><b>Boas práticas:</b> informe a loja e time para consultas especificas; inclua período quando fizer sentido (nesse mes, nessa semana, semana passada, mes passado, nesse trtimestre, periodo de datas etc); sempre use as orientações de texto que aparecem no chat pra completar sua dúvida ou solicitação.</li>
        </ul>
      </div>

    </div>

    <button type="button"
            onclick="closeAjudaVektorModal()"
            class="mt-4 w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-semibold">
      Fechar
    </button>
  </div>
</div>

<? if ((userRole || "") === "Administrador") { ?>

<!-- Modal: Alertas Recentes -->
<div id="alertasRecentesModal"
     class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-[980px] overflow-hidden border border-slate-200">
    
    <!-- Header -->
    <div class="px-5 py-4 bg-[#005E27] text-white flex items-center justify-between">
      <div>
        <div class="text-base font-extrabold">📋 Ocorrências</div>
        <div class="text-xs opacity-90">Rastreabilidade de alertas enviados (limite, pendências, possíveis irregularidades)</div>
      </div>
      <button type="button"
              onclick="closeAlertasRecentesModal()"
              class="bg-white/15 hover:bg-white/25 transition rounded-lg px-3 py-2 text-sm font-semibold">
        Fechar
      </button>
    </div>

    <!-- Body -->
    <div class="p-5">
      <!-- Filtros -->
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="flex-1">
          <label class="text-xs font-semibold text-slate-600">Janela (dias)</label>
          <select id="alertasRecentesDias"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
            <option value="7">Últimos 7 dias</option>
            <option value="14" selected>Últimos 14 dias</option>
            <option value="30">Últimos 30 dias</option>
          </select>
        </div>

        <div class="flex-1">
          <label class="text-xs font-semibold text-slate-600">Tipo</label>
          <select id="alertasRecentesTipo"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm">
            <option value="" selected>Todos</option>
            <option value="LIMITE">Limite</option>
            <option value="PENDENCIAS">Pendências</option>
            <option value="USO_IRREGULAR">Possível irregularidade</option>
            <option value="ITENS_IRREGULARES">Possíveis itens irregulares</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button type="button"
                  onclick="carregarAlertasRecentes()"
                  class="rounded-lg bg-black text-white text-sm font-semibold px-4 py-2 hover:bg-slate-900 transition">
            Atualizar
          </button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="text-xs font-semibold text-slate-500">Total de alertas</div>
          <div id="kpiAlertasTotal" class="text-2xl font-extrabold text-slate-900 mt-1">—</div>
        </div>
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="text-xs font-semibold text-slate-500">Último envio</div>
          <div id="kpiAlertasUltimo" class="text-sm font-semibold text-slate-900 mt-2">—</div>
        </div>
        <div class="rounded-xl border border-slate-200 p-4">
          <div class="text-xs font-semibold text-slate-500">Observação</div>
          <div class="text-sm text-slate-700 mt-2">
            Este painel mostra apenas alertas que foram <b>efetivamente enviados</b> por e-mail.
          </div>
        </div>
      </div>

      <!-- Conteúdo -->
      <div class="mt-4">
        <div id="alertasRecentesLoading" class="hidden text-sm text-slate-700">
          Carregando alertas...
        </div>

        <div id="alertasRecentesEmpty" class="hidden text-sm text-slate-700 rounded-xl border border-slate-200 p-4">
          Nenhum alerta encontrado na janela selecionada.
        </div>

        <div class="mt-2 overflow-x-auto overflow-y-auto max-h-[45vh] rounded-xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Data/Hora</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Tipo</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Loja</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Time</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Detalhe</th>
              <th class="sticky top-0 z-10 bg-slate-100 text-left px-3 py-2 border-b">Origem</th>
            </tr>
          </thead>
          <tbody id="alertasRecentesTbody"></tbody>
        </table>
      </div>
      </div>
    </div>

  </div>
</div>

<? } ?>

</div> <!-- fecha .chat-wrapper -->
</div>   <!-- fecha coluna direita -->
</div>     <!-- fecha layout com menu + chat -->
</div>

<?!= include('politica_dados'); ?>

<script>

  // ===============================
// MODO MANUTENÇÃO (MANUAL)
// ===============================
// ATIVE/DESATIVE (false ou true)
const VEKTOR_MANUTENCAO_ATIVA = false; // <--------------------- ALTERAR PARA MANUTENÇÃO SEMPRE AQUI//

// ===============================
// LOGIN GATE (ESCONDE APP ATÉ VALIDAR)
// ===============================
(function () {

    // ===============================
  // VEKTOR - SESSAO (LOCAL, 3H)
  // ===============================
  const VEKTOR_SESSION_KEY = "vektor_session_token_v1";

  function saveSessionToken_(token, ttlSeconds) {
    try {
      const exp = Date.now() + (Number(ttlSeconds || 0) * 1000);
      localStorage.setItem(
        VEKTOR_SESSION_KEY,
        JSON.stringify({ token: token, exp: exp })
      );
    } catch (_) {}
  }

  function getSessionToken_() {
    try {
      const raw = localStorage.getItem(VEKTOR_SESSION_KEY);
      if (!raw) return null;

      const obj = JSON.parse(raw);
      if (!obj || !obj.token || !obj.exp) return null;
      if (Date.now() > Number(obj.exp)) return null;

      return obj.token;
    } catch (_) {
      return null;
    }
  }

  function clearSessionToken_() {
    try {
      localStorage.removeItem(VEKTOR_SESSION_KEY);
    } catch (_) {}
  }

  let vektorLogoutTimer_ = null;

function scheduleAutoLogout_() {
  try {
    if (vektorLogoutTimer_) {
      clearTimeout(vektorLogoutTimer_);
      vektorLogoutTimer_ = null;
    }

    const raw = localStorage.getItem(VEKTOR_SESSION_KEY);
    if (!raw) return;

    const obj = JSON.parse(raw);
    if (!obj || !obj.exp) return;

    const ms = Math.max(0, Number(obj.exp) - Date.now());

    // agenda o logout automático exatamente no vencimento
    vektorLogoutTimer_ = setTimeout(function () {
      clearSessionToken_();
      hideApp_();
      openModal_();
      setError_("Sessão expirada. Faça login novamente.");
    }, ms);
  } catch (_) {}
}

  function byId(id) { return document.getElementById(id); }

  function hideApp_() {
    var root = byId("vektorAppRoot");
    if (root) root.classList.add("hidden");
    document.body.style.overflow = "hidden";
  }

  function showApp_() {
    var root = byId("vektorAppRoot");
    if (root) root.classList.remove("hidden");
    document.body.style.overflow = "";
  }

  function showMaintenance_() {
  // esconde app e modal
  hideApp_();
  closeModal_();

  // mostra overlay de manutenção
  var o = document.getElementById("vektorMaintenanceOverlay");
  if (o) {
    o.classList.remove("hidden");
    o.style.display = "block";
  }
}

function hideMaintenance_() {
  var o = document.getElementById("vektorMaintenanceOverlay");
  if (o) {
    o.style.display = "none";
    o.classList.add("hidden");
  }
}

  function openModal_() {
    var m = byId("vektorLoginModal");
    if (!m) return;
    m.classList.remove("hidden");
    m.style.display = "block";
  }

  function closeModal_() {
    var m = byId("vektorLoginModal");
    if (!m) return;
    m.style.display = "none";
    m.classList.add("hidden");
  }

  function setError_(msg) {
    var box = byId("vektorLoginError");
    if (!box) return;
    if (!msg) {
      box.textContent = "";
      box.classList.add("hidden");
      return;
    }
    box.textContent = String(msg);
    box.classList.remove("hidden");
  }

  function setLoading_(on) {
    var btn = byId("vektorLoginBtn");
    if (!btn) return;
    btn.disabled = !!on;
    btn.textContent = on ? "Validando..." : "Entrar";
  }

    // ✅ Reinicia TODAS as animações do strip (inclui ::before/::after)
  function vektorRestartPremiumStrip_(){
    const strip = document.getElementById("vektorPremiumStrip");
    if (!strip) return;

    strip.classList.remove("hps-run");
    void strip.offsetWidth; // reflow
    strip.classList.add("hps-run");
  }

  function attempt_() {
  setError_("");
  var email = (byId("vektorLoginEmail") && byId("vektorLoginEmail").value ? byId("vektorLoginEmail").value : "").trim();

  if (!email) {
    setError_("Informe seu e-mail corporativo.");
    return;
  }

  if (typeof google === "undefined" || !google.script || !google.script.run) {
    setError_("google.script.run indisponível. Abra o Vektor via WebApp publicado.");
    return;
  }

  setLoading_(true);

  google.script.run
    .withSuccessHandler(function (res) {
      setLoading_(false);

      if (res && res.ok) {
        if (res.token && res.ttlSeconds) {
          saveSessionToken_(res.token, res.ttlSeconds);
          scheduleAutoLogout_();
        }
        closeModal_();
        showApp_();
        if (window.vektorPlayTopbarPremiumStrip) {
          requestAnimationFrame(function(){
            requestAnimationFrame(function(){
              window.vektorPlayTopbarPremiumStrip();
            });
          });
        }
        return;
      }

      hideApp_();
      openModal_();
      setError_(res && res.error ? res.error : "Acesso negado.");
    })
    .withFailureHandler(function (err) {
      setLoading_(false);
      hideApp_();
      openModal_();
      setError_("Erro na validação: " + (err && err.message ? err.message : err));
    })
    .validarLoginVektor(email);
}

let __vektorLoginHandlersBound = false;

function bindLoginHandlers_() {
  if (__vektorLoginHandlersBound) return;
  __vektorLoginHandlersBound = true;

  byId("vektorLoginBtn")?.addEventListener("click", attempt_);

  byId("vektorLoginGoogleBtn")?.addEventListener("click", function () {
    try {
      const emailGoogle = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
      if (!emailGoogle) {
        setError_("Não foi possível capturar seu e-mail do Google. Digite manualmente.");
        return;
      }
      const inp = byId("vektorLoginEmail");
      if (inp) inp.value = emailGoogle;
      attempt_();
    } catch (e) {
      setError_("Falha ao aplicar Login com Google.");
    }
  });

  byId("vektorLoginEmail")?.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      attempt_();
    }
  });
}

document.addEventListener("DOMContentLoaded", function () {
  bindLoginHandlers_(); // ✅ garante listeners sempre

    // =========================
  // SIDEBAR COLLAPSE (Menu recolhível)
  // =========================
  (function initSidebarCollapse_(){
    const shell = document.getElementById("vektorShell");
    const btn = document.getElementById("vektorSidebarToggleBtn");
    if (!shell || !btn) return;

    const KEY = "VEKTOR_SIDEBAR_COLLAPSED";

    function apply_(collapsed){
  shell.classList.toggle("sidebar-collapsed", !!collapsed);

  const icon = document.getElementById("vektorSidebarToggleIcon");
  if (icon) {
    icon.textContent = collapsed ? "⫸" : "⫷";
  }

  // Ajuste da imagem da Home (sem faixa preta)
  const homeHeroImg = document.getElementById("homeHeroImg");
  const homeView = document.getElementById("homeView");

  if (homeView) {
    homeView.style.background = "transparent";
  }

  if (homeHeroImg) {
    homeHeroImg.style.objectFit = "cover";

    if (collapsed) {
      // prioriza topo/esquerda no menu recolhido (ajuste fino da arte)
      homeHeroImg.style.objectPosition = "18% 1%"; // teste também "left top"
    } else {
      homeHeroImg.style.objectPosition = "center 40%";
    }
  }
}

    // aplica estado salvo
    let saved = null;
    try { saved = localStorage.getItem(KEY); } catch(e) {}
    apply_(saved === "1");

    // click toggle
    btn.addEventListener("click", function(){
      const isCollapsed = shell.classList.contains("sidebar-collapsed");
      const next = !isCollapsed;
      apply_(next);
      try { localStorage.setItem(KEY, next ? "1" : "0"); } catch(e) {}
    });
  })();

    // =========================
  // TOPBAR PREMIUM STRIP (faixa no vazio acima da tela)
  // Regras:
  // - Só mostra quando HOME estiver visível
  // - Só mostra quando menu NÃO estiver recolhido (sem .sidebar-collapsed)
  // - NÃO mostra se banner de feriado estiver ativo/visível
  // =========================
  (function initTopbarPremiumStrip_(){
  const shell  = document.getElementById("vektorShell");           // existe (linha ~1733)
  const home   = document.getElementById("homeView");              // existe (linha ~1890)
  const strip  = document.getElementById("vektorPremiumStrip");    // topbar
  const banner = document.getElementById("vektor-holiday-banner"); // existe (linha ~1392)
  if (!shell || !home || !strip || !banner) return;

  function isShown_(el){
    if (!el) return false;
    if (el.classList.contains("hidden")) return false;
    const ds = (el.style && el.style.display) ? el.style.display : "";
    if (ds === "none") return false;
    return true;
  }

  function isHolidayOn_(){
    if (!isShown_(banner)) return false;
    return !!String(banner.textContent || "").trim();
  }

  // ✅ reinicia TODAS as animações do strip (inclui ::before/::after)
  function restartStrip_(){
  // limpa estado final congelado
  strip.classList.remove("hps-done");

  // reinicia timeline
  strip.classList.remove("hps-run");
  void strip.offsetWidth; // reflow
  strip.classList.add("hps-run");
}

  // ✅ trava: só anima quando "armed" = true (ex.: após login)
  let armed_ = false;

  function update_(){
  const menuCollapsed = shell.classList.contains("sidebar-collapsed");
  const holidayOn     = isHolidayOn_();
  const shouldShow    = !menuCollapsed && !holidayOn;

  strip.style.display = shouldShow ? "flex" : "none";

  // 🔒 só anima UMA vez quando o login arma
  if (shouldShow && armed_) {
    restartStrip_();
    armed_ = false;

    // ✅ após terminar, congela no estado final e remove hps-run
    // tempo total (baseado no seu timing):
    // último item começa em 5.2s; frase começa em 6.1s e dura 1.8s => ~8.1s
    window.clearTimeout(window.__hpsDoneTmr);
    window.__hpsDoneTmr = window.setTimeout(function(){
      strip.classList.remove("hps-run");
      strip.classList.add("hps-done");
    }, 8200);
  }

  // ✅ não mexe em hps-run/hps-done ao recolher/expandir
  // (assim não reanima e não some)
}

  // ✅ função pública: chame isto SOMENTE no login OK
  window.vektorPlayTopbarPremiumStrip = function(){
    armed_ = true;   // arma para o próximo update
    update_();       // executa imediatamente
  };

  // Observa mudanças: colapso do menu e ativação do feriado
  // (home pode continuar aqui, mas não reinicia mais na navegação)
  try {
    const obs = new MutationObserver(update_);
    obs.observe(shell,  { attributes:true, attributeFilter:["class"] });
    obs.observe(home,   { attributes:true, attributeFilter:["class","style"] });
    obs.observe(banner, { attributes:true, attributeFilter:["class","style"] });
    obs.observe(banner, { childList:true, subtree:true, characterData:true });
  } catch(e){}

  update_();
})();

    // ✅ Logout (volta para tela de login)
      byId("vektorLogoutBtn")?.addEventListener("click", function () {
        try {
          const token = getSessionToken_(); // pode ser null

          // 1) invalida local
          clearSessionToken_();

          // 2) opcional: invalida token no servidor (se você implementar no Code.gs)
          if (token && typeof google !== "undefined" && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler(function () {})
              .withFailureHandler(function () {})
              .encerrarSessaoVektor(token);
          }

          // 3) volta para login
          hideApp_();
          openModal_();
          setError_("Você saiu. Faça login novamente.");
        } catch (_) {
          try {
            clearSessionToken_();
            hideApp_();
            openModal_();
          } catch (_) {}
        }
      });

  // Manutenção tem prioridade: mostra tela e sai
  if (typeof VEKTOR_MANUTENCAO_ATIVA !== "undefined" && VEKTOR_MANUTENCAO_ATIVA) {
    showMaintenance_();
    return;
  } else {
    hideMaintenance_();
  }

      hideApp_();

      scheduleAutoLogout_();

  const token = getSessionToken_();

  if (token && typeof google !== "undefined" && google.script && google.script.run) {
    // tenta validar sessão silenciosamente
    google.script.run
      .withSuccessHandler(function (res) {
        if (res && res.ok) {
          // sessão válida: libera sem modal
          showApp_();
          if (window.vektorPlayTopbarPremiumStrip) {
            requestAnimationFrame(function(){
              requestAnimationFrame(function(){
                window.vektorPlayTopbarPremiumStrip();
              });
            });
          }
          closeModal_();
          scheduleAutoLogout_();
          return;
        }

        // sessão inválida
        clearSessionToken_();
        openModal_();
      })
      .withFailureHandler(function () {
        clearSessionToken_();
        openModal_();
      })
      .validarSessaoVektor(token);

    return; // IMPORTANTÍSSIMO: não abrir modal agora
  }

  // sem token: exige login
  openModal_();

    byId("vektorLoginBtn")?.addEventListener("click", attempt_);

    // Botão "Login com Google" -> preenche com e-mail do Google Workspace (do template)
    byId("vektorLoginGoogleBtn")?.addEventListener("click", function () {
      try {
        const emailGoogle = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
        if (!emailGoogle) {
          setError_("Não foi possível capturar seu e-mail do Google. Digite manualmente.");
          return;
        }
        const inp = byId("vektorLoginEmail");
        if (inp) inp.value = emailGoogle;

        // opcional: já dispara o login automaticamente
        attempt_();
      } catch (e) {
        setError_("Falha ao aplicar Login com Google.");
      }
    });

    byId("vektorLoginEmail")?.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        attempt_();
      }
    });

    setTimeout(function(){ try { byId("vektorLoginEmail")?.focus(); } catch(_){} }, 50);
  });
})();

// Mensagem manual (edite data/hora aqui)
const VEKTOR_MSG_MANUTENCAO_HTML = `
  <div class="bot-bubble px-4 py-3 max-w-[80%] text-slate-700">
    <p class="font-semibold text-slate-800 text-base">
      Em manutenção preventiva, previsão de término às <b>22:30</b> do dia <b>10/01/2026</b>.
    </p>
  </div>
`;

function vektorAplicarManutencao_() {
  // 1) substitui conteúdo do chat
  const chat = document.getElementById("chatWindow");
  if (chat) {
    chat.innerHTML = `
      <div class="flex items-start gap-3">
        <img src="https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png"
             alt="Vektor"
             class="h-16 w-auto object-contain flex-shrink-0" />
        ${VEKTOR_MSG_MANUTENCAO_HTML}
      </div>
    `;
  }

  // 2) bloqueia input e envio
  const input = document.getElementById("userInput");
  if (input) {
    input.value = "";
    input.disabled = true;
    input.placeholder = "Indisponível (manutenção).";
  }

  const btn = document.getElementById("sendBtn");
  if (btn) btn.disabled = true;

  // 3) trava submit do form
  const form = document.getElementById("chatForm");
  if (form) {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      return false;
    }, { capture: true });
  }
}

// ✅ aplica manutenção SOMENTE quando estiver true
if (VEKTOR_MANUTENCAO_ATIVA) {
  vektorAplicarManutencao_();
  setTimeout(vektorAplicarManutencao_, 100); // garante que ninguém reescreva depois
}

    // Estado global para o upload do Termo de Responsabilidade
  window.vektorTermoPending = null;         // guarda o arquivo em memória até receber o nome
  window.vektorTermoAguardandoNome = false; // indica se o próximo texto é o nome completo


  // Fecha o modal do vídeo de apresentação
function closeVektorModal() {
  var modal = document.getElementById("vektorModal");
  if (modal) {
    modal.style.display = "none";
  }
}

function openAlertasRecentesModal() {
  const modal = document.getElementById("alertasRecentesModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
  carregarAlertasRecentes();
}

function closeAlertasRecentesModal() {
  const modal = document.getElementById("alertasRecentesModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function openRadarAnaliseModal() {
  const modal = document.getElementById("radarAnaliseModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeRadarAnaliseModal() {
  const modal = document.getElementById("radarAnaliseModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function openEnvPendAnaliseModal() {
  const modal = document.getElementById("envPendAnaliseModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeEnvPendAnaliseModal() {
  const modal = document.getElementById("envPendAnaliseModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function openMyAlTutorialModal() {
  const modal = document.getElementById("myAlTutorialModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeMyAlTutorialModal() {
  const modal = document.getElementById("myAlTutorialModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function closeStatusVektorModal() {
  const modal = document.getElementById("statusVektorModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

function carregarAlertasRecentes() {
  const loading = document.getElementById("alertasRecentesLoading");
  const empty = document.getElementById("alertasRecentesEmpty");
  const tbody = document.getElementById("alertasRecentesTbody");

  const kpiTotal = document.getElementById("kpiAlertasTotal");
  const kpiUltimo = document.getElementById("kpiAlertasUltimo");

  const diasEl = document.getElementById("alertasRecentesDias");
  const tipoEl = document.getElementById("alertasRecentesTipo");

  const dias = Number(diasEl ? diasEl.value : 14) || 14;
  const tipo = (tipoEl ? tipoEl.value : "").trim();

    // Normaliza tipos do log (ex.: PENDENCIAS_LOJA -> PENDENCIAS)
  const normTipo = (t) => {
  const x = String(t || "").toUpperCase().trim();
    if (x.startsWith("PENDENCIAS")) return "PENDENCIAS";
    if (x.startsWith("LIMITE")) return "LIMITE";
    if (x.startsWith("USO_IRREGULAR")) return "USO_IRREGULAR";
    if (x.startsWith("ITENS_IRREGULARES")) return "ITENS_IRREGULARES";
    return x; // fallback
  };

  // Reset UI
  if (loading) loading.classList.remove("hidden");
  if (empty) empty.classList.add("hidden");
  if (tbody) tbody.innerHTML = "";
  if (kpiTotal) kpiTotal.textContent = "—";
  if (kpiUltimo) kpiUltimo.textContent = "—";

  // Proteção: google.script.run precisa existir
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    if (loading) loading.classList.add("hidden");
    if (empty) {
      empty.classList.remove("hidden");
      empty.textContent = "google.script.run não disponível. Abra pela URL do WebApp do Apps Script.";
    }
    return;
  }

  // Proteção: DOM precisa existir
  if (!tbody) {
    if (loading) loading.classList.add("hidden");
    console.error("alertasRecentesTbody não encontrado no DOM.");
    return;
  }

      const fmtTs = (ts) => {
      try {
        if (!ts) return "";

        // 1) Se já veio como Date (às vezes o Apps Script manda assim)
        if (ts instanceof Date) return ts.toLocaleString("pt-BR");

        const s = String(ts).trim();

        // 2) Se veio em formato BR: "dd/MM/yyyy HH:mm:ss" (ou sem segundos)
        const mBR = s.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
        if (mBR) {
          const dd = Number(mBR[1]);
          const mm = Number(mBR[2]);
          const yyyy = Number(mBR[3]);
          const HH = Number(mBR[4] || 0);
          const MI = Number(mBR[5] || 0);
          const SS = Number(mBR[6] || 0);

          const d = new Date(yyyy, mm - 1, dd, HH, MI, SS);
          return d.toLocaleString("pt-BR");
        }

        // 3) ISO (ex.: 2026-01-12T22:19:21.000Z) ou "yyyy-MM-dd HH:mm:ss"
        const d2 = new Date(s.replace(" ", "T"));
        return isNaN(d2.getTime()) ? s : d2.toLocaleString("pt-BR");
      } catch (e) {
        return String(ts || "");
      }
    };

  const badge = (t) => {
    const x = String(t || "").toUpperCase();
    if (x === "LIMITE") return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800'>Limite</span>";
    if (x.startsWith("PENDENCIAS")) return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800'>Pendências</span>";
    if (x.startsWith("USO_IRREGULAR")) return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-violet-100 text-violet-800'>Possível irregularidade</span>";
    return "<span class='px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-800'>" + (t || "Outro") + "</span>";
  };

  google.script.run
    .withSuccessHandler(function (res) {
      try {
        if (loading) loading.classList.add("hidden");

        // Debug: te mostra no console o que voltou do backend
        console.log("[AlertasRecentes] res:", res);

        if (!res || !res.ok) {
          if (empty) {
            empty.classList.remove("hidden");
            empty.textContent =
          "Falha ao carregar alertas. " +
          (res && res.error ? res.error : "Sem mensagem de erro.") +
          " | payload=" + JSON.stringify(res);
          }
          return;
        }

        let rows = Array.isArray(res.rows) ? res.rows : [];
        if (tipo) {
        const tipoFiltro = String(tipo || "").toUpperCase().trim();
        rows = rows.filter(r => normTipo(r.tipo) === tipoFiltro);
      }

        if (!rows.length) {
          if (empty) empty.classList.remove("hidden");
          if (kpiTotal) kpiTotal.textContent = "0";
          if (kpiUltimo) kpiUltimo.textContent = "—";
          return;
        }

        if (kpiTotal) kpiTotal.textContent = String(rows.length);
        if (kpiUltimo) kpiUltimo.textContent = fmtTs(rows[0].timestamp || "—");

        rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50";
          tr.innerHTML = `
            <td class="px-3 py-2 border-b text-xs text-slate-700 whitespace-nowrap">${fmtTs(r.timestamp || "")}</td>
            <td class="px-3 py-2 border-b">${badge(r.tipo)}</td>
            <td class="px-3 py-2 border-b text-slate-700 whitespace-nowrap">${(r.loja && String(r.loja).trim()) ? r.loja : "Consolidado"}</td>
            <td class="px-3 py-2 border-b text-slate-700 whitespace-nowrap">${(r.time && String(r.time).trim()) ? r.time : "Consolidado"}</td>
            <td class="px-3 py-2 border-b text-slate-700">${r.detalhe || ""}</td>
            <td class="px-3 py-2 border-b text-xs text-slate-500 whitespace-nowrap">${r.origem || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        // Se der erro aqui, antes ficava “mudo”. Agora você vai ver.
        if (loading) loading.classList.add("hidden");
        if (empty) {
          empty.classList.remove("hidden");
          empty.textContent = "Erro ao renderizar alertas: " + (e && e.message ? e.message : e);
        }
        console.error("Erro ao renderizar Alertas Recentes:", e);
      }
    })
    .withFailureHandler(function (err) {
      if (loading) loading.classList.add("hidden");
      if (empty) {
        empty.classList.remove("hidden");
        empty.textContent = "Erro ao carregar alertas: " + (err && err.message ? err.message : err);
      }
      console.error("[AlertasRecentes] failure:", err);
    })
    .getAlertasRecentes(dias, 200);
}

function openAjudaVektorModal() {
  var modal = document.getElementById("ajudaVektorModal");
  if (modal) {
    modal.style.display = "flex";
    modal.classList.remove("hidden");
  }
}

function closeAjudaVektorModal() {
  var modal = document.getElementById("ajudaVektorModal");
  if (modal) {
    modal.style.display = "none";
    modal.classList.add("hidden");
  }
}

document.addEventListener("click", function (e) {
  var modal = document.getElementById("ajudaVektorModal");
  if (!modal || modal.classList.contains("hidden")) return;

  // clicou no fundo escuro (overlay) -> fecha
  if (e.target === modal) closeAjudaVektorModal();
});

function openStatusVektorModal() {
  const modal = document.getElementById("statusVektorModal");
  if (modal) modal.style.display = "flex";

  // Helper seguro: só escreve se o elemento existir
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = (value == null || value === "") ? "—" : String(value);
  };

  // Status Geral (sempre visível)
  setText("status-geral", "Em operação");

  // Manutenção (somente admin, se existir no DOM)
  if (typeof VEKTOR_MANUTENCAO_ATIVA !== "undefined") {
    setText("status-manutencao", VEKTOR_MANUTENCAO_ATIVA ? "Em manutenção" : "Em operação");
  } else {
    // se a constante não existir, não quebra
    setText("status-manutencao", "Em operação");
  }

  // Proteção: se abriu fora do WebApp
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    setText("status-geral", "google.script.run indisponível (abra via WebApp).");
    return;
  }

  google.script.run
    .withSuccessHandler(function (data) {
      // Base (sempre visível)
      setText("status-baseclara", data && (data.baseClara || data.baseclara));

      // Status Geral (sempre visível)
      const geral = data && (data.geral || data.statusGeral);
      setText("status-geral", geral || "Em operação");

      // A partir daqui: campos admin-only (só preenche se existirem)
      setText("status-jobs", data && data.jobs);

      setText("status-ativos-hoje", data && (data.usuariosAtivosHoje ?? data.ativosHoje));

      // Serviços Google (Apps Script / E-mail)
      const googleStatus = data && (data.google ?? data.googleStatus ?? data.servicosGoogle);
      setText("status-google", googleStatus || "Indisponível");

      // BigQuery
      const bigQueryStatus = data && (data.bigquery ?? data.bigQuery ?? data.bigQueryStatus);
      setText("status-bigquery", bigQueryStatus || "Indisponível");

    })
    .withFailureHandler(function (err) {
      const msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
      setText("status-geral", "Erro ao buscar status: " + msg);
    })
    .vektorStatusSistema();
}

// ===============================
// VIEW CONTROL (Chat <-> Radar)
// ===============================
window.vektorShowChatView = function () {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  // ✅ Envio de Pendências
  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");

  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");
  const analiseGastosView = document.getElementById("analiseGastosView");

  // fecha outras views
  [
    radarView,
    feedbackView,
    myAlertsView,
    fluxView,
    envioPendView,
    cicloResumoView,
    analiseGastosView,
    homeView
  ].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.classList.remove("is-open");
    v.style.display = "none";
  });

  // fecha modal envio pendências (se estiver aberto)
  if (envPendModal) {
    envPendModal.classList.add("hidden");
    envPendModal.style.display = "none";
  }

  // ✅ abre chat de verdade
  if (chatView) {
    chatView.classList.remove("hidden"); 
    chatView.classList.add("is-open");
    chatView.style.display = "flex";
  }

  // ✅ abrir modal "Como usar o Vektor?" apenas 1x por dia (por navegador)
  try {
    const now = new Date();
    const yyyy = String(now.getFullYear());
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const hojeKey = `${yyyy}-${mm}-${dd}`;

    const LS_KEY = "VEKTOR_CHAT_HELP_LAST_SHOWN_DAY";
    const last = localStorage.getItem(LS_KEY) || "";

    if (last !== hojeKey) {
      localStorage.setItem(LS_KEY, hojeKey);

      setTimeout(function () {
        if (typeof openAjudaVektorModal === "function") openAjudaVektorModal();
      }, 80);
    }
  } catch (e) {}

  const input = document.getElementById("userInput");
  if (input && !input.disabled) setTimeout(() => input.focus(), 50);
};

function vektorShowRadarView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  // fecha TODAS
  [chatView, feedbackView, myAlertsView, fluxView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (envPendModal) { envPendModal.classList.add("hidden"); envPendModal.style.display = "none"; }
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  // abre Radar
  if (radarView) {
    radarView.classList.remove("hidden");
    radarView.style.display = "block";
    radarView.classList.add("is-open");
  }
}

function vektorShowFeedbackView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  // fecha as demais páginas
  if (chatView) chatView.classList.add("hidden");
  if (radarView) radarView.classList.add("hidden");
  if (myAlertsView) myAlertsView.classList.add("hidden");
  if (fluxView) fluxView.classList.add("hidden");

  // abre feedback
  if (feedbackView) feedbackView.classList.remove("hidden");

  // opcional: garante estado do radar
  if (radarView) radarView.classList.remove("is-open");
}

function vektorShowFluxogramaView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  [chatView, radarView, feedbackView, myAlertsView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (envPendModal) { envPendModal.classList.add("hidden"); envPendModal.style.display = "none"; }
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (fluxView) {
    fluxView.classList.remove("hidden");
    fluxView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
}

// =========================
// Fluxograma detalhado (modal full-screen / SVG / zoom)
// =========================
window.__vektorFluxoDetZoom = window.__vektorFluxoDetZoom || 1;

function vektorFluxoDetApplyZoom_(){
  const st = document.getElementById("vektor_fluxoDetStage");
  if (!st) return;
  st.style.transform = `scale(${window.__vektorFluxoDetZoom || 1})`;
}

function vektorFluxoDetZoom_(delta){
  window.__vektorFluxoDetZoom = Math.max(0.45, Math.min(2.8, (window.__vektorFluxoDetZoom || 1) + delta));
  vektorFluxoDetApplyZoom_();
}

function vektorFluxoDetZoomReset_(){
  window.__vektorFluxoDetZoom = 1;
  vektorFluxoDetApplyZoom_();
}

function vektorOpenFluxogramaDetalhado_(){
  const m = document.getElementById("vektor_fluxoDetModal");
  if (!m) return;

  m.classList.remove("hidden");
  m.style.display = "block";
  m.setAttribute("aria-hidden", "false");

  // sempre abre em 100% (para UX previsível)
  try { vektorFluxoDetZoomReset_(); } catch(_) {}
}

function vektorCloseFluxogramaDetalhado_(){
  const m = document.getElementById("vektor_fluxoDetModal");
  if (!m) return;

  m.classList.add("hidden");
  m.style.display = "none";
  m.setAttribute("aria-hidden", "true");
}

// backdrop fecha
(function bindFluxoDetBackdropOnce_(){
  const b = document.getElementById("vektor_fluxoDetBackdrop");
  if (!b || b.__bound) return;
  b.__bound = true;
  b.addEventListener("click", function(){ vektorCloseFluxogramaDetalhado_(); });
})();

// ESC fecha
(function bindFluxoDetEscOnce_(){
  if (window.__vektorFluxoDetEscBound) return;
  window.__vektorFluxoDetEscBound = true;

  document.addEventListener("keydown", function(ev){
    if (ev && ev.key === "Escape") {
      const m = document.getElementById("vektor_fluxoDetModal");
      if (m && !m.classList.contains("hidden")) vektorCloseFluxogramaDetalhado_();
    }
  });
})();

// ===============================
// ENVIO DE PENDÊNCIAS (view + modal + fluxo)
// ===============================
function vektorShowEnvioPendenciasView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  [chatView, radarView, feedbackView, myAlertsView, fluxView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (envioPendView) {
    envioPendView.classList.remove("hidden");
    envioPendView.style.display = "block";
  }

  // fecha modal (não abre sozinho)
  if (envPendModal) {
    envPendModal.classList.add("hidden");
    envPendModal.style.display = "none";
  }

  if (radarView) radarView.classList.remove("is-open");
}

window.vektorOpenEnvioPendencias = function () {
  vektorShowEnvioPendenciasView_();
};

window.vektorOpenResumoCiclo = function () {
  window.vektorShowResumoCicloView_();
  window.vektorLoadResumoCiclo(false);
};

// ===============================
// RESUMO DO CICLO (FRONT)
// - agora: guarda dataset, cria/binda filtros (time/loja), aplica filtros,
//   e renderiza a TABELA com TODAS as linhas filtradas (não top 10)
// ===============================
window.vektorLoadResumoCiclo = function (force) {
  const loading = document.getElementById("cicloResumoLoading");
  const content = document.getElementById("cicloResumoContent");
  const tbody = document.getElementById("cicloResumo_tbody");

setResumoCicloBusy_(true, "Carregando pendências do ciclo…");

  if (tbody) tbody.innerHTML = "";

  const fmtBRL = (n) => {
    try { return (Number(n || 0)).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }
    catch (e) { return String(n || 0); }
  };

  function setResumoCicloBusy_(isBusy, msg){
  const loading = document.getElementById("cicloResumoLoading");
  const content = document.getElementById("cicloResumoContent");

  const ov = document.getElementById("cicloResumo_overlay"); // <<< precisa existir no HTML
  const ovTitle = document.getElementById("cicloResumo_overlayTitle");
  const ovSub = document.getElementById("cicloResumo_overlaySub");

  // overlay (trava tela)
  if (ov) ov.style.display = isBusy ? "block" : "none";
  if (ovTitle) ovTitle.textContent = msg || (isBusy ? "Carregando…" : "");
  if (ovSub) ovSub.textContent = isBusy ? "Aguarde um instante." : "";

  // mensagem / loading (texto “Carregando pendências do ciclo…”)
  if (loading) {
    loading.textContent = msg || (isBusy ? "Carregando pendências do ciclo… aguarde." : "");
    loading.style.display = isBusy ? "block" : "none";
  }

  if (content) content.style.opacity = isBusy ? "0.55" : "1";

  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");
  const btnLimpar = document.getElementById("cicloResumo_btnLimpar");
  const btnAtualizar = document.getElementById("cicloResumo_btnAtualizar");
  const btnAI = document.getElementById("cicloResumo_aiBtn");
  const btnCsv = document.getElementById("cicloResumo_btnCsv");

  [dtIniEl, dtFimEl, selTime, selLoja, btnLimpar, btnAtualizar, btnAI, btnCsv].forEach(el => {
    if (!el) return;
    el.disabled = !!isBusy;
    el.style.pointerEvents = isBusy ? "none" : "auto";
    el.style.opacity = isBusy ? "0.65" : "1";
  });
}

  function applyFiltros_(){
    const res = window.__cicloResumoData || {};
    const txAll = Array.isArray(res.tx) ? res.tx : [];

    const selTime = document.getElementById("cicloResumo_selTime");
    const selLoja = document.getElementById("cicloResumo_selLoja");
    const dtIniEl = document.getElementById("cicloResumo_dtIni");
    const dtFimEl = document.getElementById("cicloResumo_dtFim");

    const timeSel = (selTime && typeof selTime.value === "string") ? selTime.value : "";
    const lojaSel = (selLoja && typeof selLoja.value === "string") ? selLoja.value : "";

    const dtIni = (dtIniEl && dtIniEl.value) ? dtIniEl.value : "";
    const dtFim = (dtFimEl && dtFimEl.value) ? dtFimEl.value : "";

    // 1) filtro por datas (ISO yyyy-mm-dd)
    let tx = txAll.filter(r => {
      const d = String(r.dataISO || r.dataIso || "");
      if (dtIni && d < dtIni) return false;
      if (dtFim && d > dtFim) return false;
      return true;
    });

    // 2) repopula TIME com base no recorte de data
    const times = Array.from(new Set(tx.map(r => String(r.time || "N/D"))))
      .filter(Boolean)
      .sort((a,b)=>a.localeCompare(b, "pt-BR"));

    if (selTime) {
      const cur = timeSel;
      selTime.innerHTML = "<option value=''>Todos</option>" +
        times.map(t => `<option value="${String(t).replace(/"/g,"&quot;")}">${t}</option>`).join("");
      selTime.value = (cur && times.includes(cur)) ? cur : "";
    }

    // aplica TIME
    const timeNow = selTime ? (selTime.value || "") : "";
    if (timeNow) tx = tx.filter(r => String(r.time || "") === timeNow);

    // 3) repopula LOJA com base no recorte (data + time)
    const lojas = Array.from(new Set(tx.map(r => String(r.loja || ""))))
      .filter(Boolean)
      .sort((a,b)=>Number(a)-Number(b));

    if (selLoja) {
      const curL = lojaSel;
      selLoja.innerHTML = "<option value=''>Todas</option>" +
        lojas.map(l => `<option value="${l}">${l}</option>`).join("");
      selLoja.value = (curL && lojas.includes(curL)) ? curL : "";
    }

    // aplica LOJA
    const lojaNow = selLoja ? (selLoja.value || "") : "";
    if (lojaNow) tx = tx.filter(r => String(r.loja || "") === lojaNow);

    // ✅ fonte única do recorte atual (IA usa isso)
      window.__cicloResumoTxFiltered = tx;

    // 4) recalcula cards (consistente com filtros)
    const lojasSet = {};
    let totalPend = 0;
    let totalValor = 0;

    const aggTime = {};
    const aggLoja = {};

    tx.forEach(r => {
      const loja = String(r.loja || "");
      const time = String(r.time || "N/D");
      const pend = Number(r.pendCount || 0);
      const val  = Number(r.valor || 0);

      if (loja) lojasSet[loja] = true;
      totalPend += pend;
      totalValor += val;

      aggTime[time] = aggTime[time] || { k: time, pend: 0 };
      aggTime[time].pend += pend;

      aggLoja[loja] = aggLoja[loja] || { k: loja, pend: 0 };
      aggLoja[loja].pend += pend;
    });

    function pickTop(obj){
      let best = null;
      Object.keys(obj).forEach(k=>{
        if (!best || obj[k].pend > best.pend) best = obj[k];
      });
      return best;
    }

    const topT = pickTop(aggTime);
    const topL = pickTop(aggLoja);

    const elTotLojas = document.getElementById("cicloResumo_totalLojas");
    const elTotPend  = document.getElementById("cicloResumo_totalPend");
    const elTotValor = document.getElementById("cicloResumo_totalValor");
    const elTopTime  = document.getElementById("cicloResumo_topTime");
    const elTopTimeSub = document.getElementById("cicloResumo_topTimeSub");
    const elTopLoja  = document.getElementById("cicloResumo_topLoja");
    const elTopLojaSub = document.getElementById("cicloResumo_topLojaSub");

    if (elTotLojas) elTotLojas.textContent = String(Object.keys(lojasSet).length);
    if (elTotPend)  elTotPend.textContent  = String(totalPend);
    if (elTotValor) elTotValor.textContent = fmtBRL(totalValor);

    if (elTopTime) elTopTime.textContent = topT ? topT.k : "—";
    if (elTopTimeSub) elTopTimeSub.textContent = topT ? `${topT.pend} pendências` : "—";

    if (elTopLoja) elTopLoja.textContent = topL ? topL.k : "—";
    if (elTopLojaSub) elTopLojaSub.textContent = topL ? `${topL.pend} pendências` : "—";

    // 5) ordenação
    window.__cicloResumoSort = window.__cicloResumoSort || { col: "valor", dir: "desc" };
    const sort = window.__cicloResumoSort;

    function cmp(a,b){
      const dir = (sort.dir === "asc") ? 1 : -1;
      const col = sort.col || "valor";

      const va = a[col];
      const vb = b[col];

      if (col === "valor" || col === "pendCount") return (Number(va||0) - Number(vb||0)) * dir;
      if (col === "loja") return (Number(va||0) - Number(vb||0)) * dir;

      // dataISO é yyyy-mm-dd: comparar string funciona
      return String(va||"").localeCompare(String(vb||""), "pt-BR") * dir;
    }

    tx.sort(cmp);

    window.__cicloResumoTxExport = tx.slice();

    // 6) render tabela (detalhada)
    if (!tbody) return;

    if (!tx.length) {
      tbody.innerHTML = "<tr><td colspan='7' style='padding:10px;'>Sem transações pendentes no recorte.</td></tr>";
      return;
    }

    tbody.innerHTML = tx.map(r => `
      <tr class="cicloResumoRow">
        <td>${r.loja || "—"}</td>
        <td>${r.time || "N/D"}</td>
        <td style="white-space:nowrap;">${r.dataBR || "—"}</td>
        <td style="max-width:420px;">${(r.estabelecimento || "—")}</td>
        <td style="text-align:right; white-space:nowrap;">${r.valorBRL || fmtBRL(r.valor)}</td>
        <td style="max-width:260px;">${(r.categoria || "—")}</td>
        <td style="max-width:320px;">${(r.pendencias || "—")}</td>
      </tr>
    `).join("");
  }

  // expõe limpar filtros (se você tiver botão de limpar)
  window.vektorResumoCicloLimparFiltros = function () {
    const selTime = document.getElementById("cicloResumo_selTime");
    const selLoja = document.getElementById("cicloResumo_selLoja");
    const dtIniEl = document.getElementById("cicloResumo_dtIni");
    const dtFimEl = document.getElementById("cicloResumo_dtFim");

    if (selTime) selTime.value = "";
    if (selLoja) selLoja.value = "";
    // datas: mantém como estão (ou zera se você quiser)
    applyFiltros_();
  };

  function exportCsv_(rows){
  rows = Array.isArray(rows) ? rows : [];
  if (!rows.length) {
    alert("Sem dados para exportar no filtro atual.");
    return;
  }

  const header = ["Loja", "Time", "Data da transação", "Estabelecimento", "Valor", "Categoria", "Pendências"];

  const esc = (v) => {
    const s = String(v ?? "");
    if (/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };

  const lines = [];
  lines.push(header.join(";"));

  rows.forEach(r => {
    lines.push([
      esc(r.loja || "—"),
      esc(r.time || "N/D"),
      esc(r.dataBR || r.dataTxt || "—"),
      esc(r.estabelecimento || "—"),
      esc(r.valorBRL || (typeof r.valor === "number" ? r.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}) : (r.valor || ""))),
      esc(r.categoria || "—"),
      esc(r.pendencias || "—")
    ].join(";"));
  });

  const csv = "\uFEFF" + lines.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const dtIni = dtIniEl && dtIniEl.value ? dtIniEl.value : "";
  const dtFim = dtFimEl && dtFimEl.value ? dtFimEl.value : "";

  const fileName = `resumo_ciclo_pendencias_${dtIni || "ini"}_${dtFim || "fim"}.csv`;

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 0);
}

setResumoCicloBusy_(true, "Carregando pendências do ciclo…");

  google.script.run
    .withSuccessHandler(function (res) {
      setResumoCicloBusy_(false);

      if (!res || !res.ok) {
        if (content) content.style.display = "block";
        if (tbody) tbody.innerHTML = "<tr><td colspan='7' style='padding:10px;color:#111;'>Não disponível para o seu perfil.</td></tr>";
        return;
      }

      if (content) content.style.display = "block";

            // ✅ NORMALIZA tx (back devolve dataIso/dataTxt/valorTxt e flags; front usa dataISO/dataBR/valorBRL/pendCount)
      try {
        if (res && Array.isArray(res.tx)) {
          res.tx = res.tx.map(r => {
            const pendNF = Number(r.pendNF || 0);
            const pendEtiqueta = Number(r.pendEtiqueta || 0);
            const pendDesc = Number(r.pendDesc || 0);

            return {
              ...r,
              // datas
              dataISO: r.dataISO || r.dataIso || "",
              dataBR:  r.dataBR  || r.dataTxt || "",
              // valor
              valorBRL: r.valorBRL || r.valorTxt || "",
              // contagem de pendências
              pendCount: (r.pendCount != null) ? Number(r.pendCount || 0) : (pendNF + pendEtiqueta + pendDesc),
              // string pendências (garante)
              pendencias: r.pendencias || "",
            };
          });
        }
      } catch(_) {}

      // ✅ guarda dataset inteiro para filtros
      window.__cicloResumoData = res;

      // ✅ bind botão CSV (1x)
        try {
          const btnCsv = document.getElementById("cicloResumo_btnCsv");
          if (btnCsv && !btnCsv.__bindCsv) {
            btnCsv.__bindCsv = true;
            btnCsv.addEventListener("click", function(){
              const rows = Array.isArray(window.__cicloResumoTxExport) ? window.__cicloResumoTxExport : [];
              exportCsv_(rows);
            });
          }
        } catch(_) {}

      // cabeçalho (período)
      const sub = document.getElementById("cicloResumoSubTitle");
      if (sub && res.periodo && res.periodo.inicio && res.periodo.fim) {
        sub.textContent = `Consolidado das pendências no ciclo atual (${res.periodo.inicio} → ${res.periodo.fim})`;
      }

      // =========================================================
      // 3) DATE RANGE (dtIni/dtFim) — BLOCO COMPLETO (min/max + bind)
      // (cole aqui mesmo: depois do subtítulo e antes do bind dos filtros)
      // =========================================================
      try {
        const dtIniEl = document.getElementById("cicloResumo_dtIni");
        const dtFimEl = document.getElementById("cicloResumo_dtFim");

        if (dtIniEl && dtFimEl && res && res.periodo && res.periodo.inicio && res.periodo.fim) {
          function br2iso(br){
            const m = String(br||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (!m) return "";
            return `${m[3]}-${m[2]}-${m[1]}`;
          }
          const min = br2iso(res.periodo.inicio);
          const max = br2iso(res.periodo.fim);

          if (min) { dtIniEl.min = min; dtFimEl.min = min; }
          if (max) { dtIniEl.max = max; dtFimEl.max = max; }

          if (!dtIniEl.value && min) dtIniEl.value = min;
          if (!dtFimEl.value && max) dtFimEl.value = max;

          if (!dtIniEl.__bindResumo) {
            dtIniEl.__bindResumo = true;
            dtIniEl.addEventListener("change", applyFiltros_);
          }
          if (!dtFimEl.__bindResumo) {
            dtFimEl.__bindResumo = true;
            dtFimEl.addEventListener("change", applyFiltros_);
          }
        }
      } catch(_) {}

      // ✅ bind dos filtros (uma vez só)
      try {
        const selTime = document.getElementById("cicloResumo_selTime");
        const selLoja = document.getElementById("cicloResumo_selLoja");

        if (selTime && !selTime.__bindResumo) {
          selTime.__bindResumo = true;
          selTime.addEventListener("change", function () {
            if (selLoja) selLoja.value = "";
            applyFiltros_();
          });
        }

        if (selLoja && !selLoja.__bindResumo) {
          selLoja.__bindResumo = true;
          selLoja.addEventListener("change", function () {
            applyFiltros_();
          });
        }
      } catch (e) {}

      // =========================================================
      // 4.2) SORT NO THEAD — BLOCO COMPLETO (bind 1x)
      // (cole aqui: depois do bind dos filtros e antes do applyFiltros_())
      // =========================================================
      try {
        const thead = document.querySelector("#cicloResumoTable thead");
        if (thead && !thead.__bindSortResumo) {
          thead.__bindSortResumo = true;
          thead.addEventListener("click", function(ev){
            const th = ev.target && ev.target.closest ? ev.target.closest("th[data-sort]") : null;
            if (!th) return;

            const col = th.getAttribute("data-sort") || "";
            if (!col) return;

            window.__cicloResumoSort = window.__cicloResumoSort || { col: "valor", dir: "desc" };

            if (window.__cicloResumoSort.col === col) {
              window.__cicloResumoSort.dir = (window.__cicloResumoSort.dir === "desc") ? "asc" : "desc";
            } else {
              window.__cicloResumoSort.col = col;
              window.__cicloResumoSort.dir = "desc";
            }

            applyFiltros_();
          });
        }
      } catch(_) {}

      // ✅ render inicial
      applyFiltros_();
    })
    .withFailureHandler(function (err) {
      setResumoCicloBusy_(false);
      if (loading) loading.style.display = "none";
      if (content) content.style.display = "block";
      if (tbody) tbody.innerHTML = "<tr><td colspan='7' style='padding:10px;color:#111;'>Erro no backend.</td></tr>";
    })
    .getResumoCicloPendencias();
};

function vektorResumoCicloBuildAI_(data, opts){
  opts = opts || {};
  const periodoTxt = opts.periodoTxt || "";
  const filtroTxt  = opts.filtroTxt  || "";

  const tx = (data && Array.isArray(data.tx)) ? data.tx : [];
  const totalTx = tx.length;

  if (!totalTx){
    return `
      <div style="padding:14px 16px;">
        <div style="font-weight:1000; font-size:15px; color:#0f172a;">Leitura do cenário</div>
        <div style="margin-top:6px; font-size:13px; color:#334155; line-height:1.5;">
          No recorte atual (${periodoTxt}${filtroTxt ? " • " + filtroTxt : ""}), não existem transações pendentes.
          Se você esperava ver casos aqui, o problema provavelmente está na carga/consulta do backend (dados não chegando no resumo).
        </div>
      </div>
    `;
  }

  // helpers
  const asNum = (v) => (typeof v === "number" && isFinite(v)) ? v : 0;
  const pct = (a, b) => b ? Math.round((a / b) * 100) : 0;

  // total valor pendente (se existir)
  let totalValor = 0;
  for (const r of tx) totalValor += asNum(r.valor);

  // concentração por time / loja
  const byTime = {};
  const byLoja = {};
  const byCatCompra = {}; // categoria da compra
  let nf = 0, etiq = 0, desc = 0;

  // ✅ NOVO: datas com mais pendências
  const byData = {}; // "dd/MM/yyyy" -> totalPendenciasNoDia

  const getPendCount = (r) => {
    // preferir pendCount se existir; senão soma flags
    if (r && r.pendCount != null && isFinite(Number(r.pendCount))) return Number(r.pendCount) || 0;
    const a = Number(r.pendNF || 0) + Number(r.pendEtiqueta || 0) + Number(r.pendDesc || 0);
    // fallback extra (caso algum nome antigo apareça)
    const b = Number(r.pendDescricao || 0);
    return a + b;
  };

  for (const r of tx){
    const time = (r.time || "Sem time").trim();
    const loja = (r.loja || r.lojaNum || "Sem loja").toString().trim();
    const cat  = (r.categoria || r.categoriaCompra || "Sem categoria").trim();

    byTime[time] = (byTime[time] || 0) + 1;
    byLoja[loja] = (byLoja[loja] || 0) + 1;
    byCatCompra[cat] = (byCatCompra[cat] || 0) + 1;
    
    const dataKey = String((r.dataBR || r.dataTxt || "")).trim() || "Sem data";
    byData[dataKey] = (byData[dataKey] || 0) + getPendCount(r);

    if (r.pendNF) nf++;
    if (r.pendEtiqueta) etiq++;
    if (r.pendDesc) desc++;
  }

  const topN = (obj, n) =>
    Object.entries(obj)
      .sort((a,b) => b[1] - a[1])
      .slice(0, n);

  const topTimes = topN(byTime, 3);
  const topLojas = topN(byLoja, 3);
  const topCats  = topN(byCatCompra, 4);

  const topTime = topTimes[0] ? { k: topTimes[0][0], v: topTimes[0][1] } : null;
  const topLoja = topLojas[0] ? { k: topLojas[0][0], v: topLojas[0][1] } : null;

  // “natureza” do problema (tipos de pendência)
  // OBS: uma tx pode contar em mais de um tipo
  const domTipo = (() => {
    const arr = [
      ["Nota fiscal/Recibo", nf],
      ["Etiqueta", etiq],
      ["Descrição", desc],
    ].sort((a,b)=>b[1]-a[1]);
    return arr[0];
  })();

  const fmtMoney = (v) => {
    try { return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" }); }
    catch(_){ return "R$ " + (Math.round(v*100)/100).toFixed(2).replace(".",","); }
  };

  // Heurística de “concentração” (pra texto ficar útil)
  const concTime = topTime ? pct(topTime.v, totalTx) : 0;
  const concLoja = topLoja ? pct(topLoja.v, totalTx) : 0;

  const concMsg = (() => {
    if (concTime >= 35) return "Há uma concentração relevante em um único time, o que sugere falha local de disciplina/processo.";
    if (concLoja >= 25) return "Há uma concentração relevante em uma loja específica, sugerindo gargalo operacional (rotina/treinamento/gestão).";
    return "As pendências estão relativamente distribuídas, o que sugere um tema mais sistêmico (processo/treinamento geral).";
  })();

  // monta texto explicativo
  const topTimesTxt = topTimes.map(([k,v]) => `• ${k}: ${v} (${pct(v,totalTx)}%)`).join("<br/>");
  const topLojasTxt = topLojas.map(([k,v]) => `• ${k}: ${v} (${pct(v,totalTx)}%)`).join("<br/>");
  const topCatsTxt  = topCats.map(([k,v]) => `• ${k}: ${v} (${pct(v,totalTx)}%)`).join("<br/>");

  const topDatas = Object.entries(byData)
  .filter(([k,v]) => k && k !== "Sem data" && Number(v) > 0)
  .sort((a,b) => (Number(b[1]) - Number(a[1])))
  .slice(0, 6);

  const topDatasTxt = topDatas
  .map(([k,v]) => `• ${k}: <b>${v}</b>`)
  .join("<br/>");

  return `
    <div style="padding:14px 16px;">
      <div style="font-weight:1000; font-size:15px; color:#0f172a;">Leitura do cenário</div>
      <div style="margin-top:6px; font-size:13px; color:#334155; line-height:1.55;">
        No recorte atual (${periodoTxt}${filtroTxt ? " • " + filtroTxt : ""}), existem
        <b>${totalTx}</b> transações com pendência, somando <b>${fmtMoney(totalValor)}</b> em valor associado.
        ${topTime ? `O principal foco é o time <b>${topTime.k}</b> (${topTime.v}, ${concTime}%).` : ""}
        ${topLoja ? `A loja mais crítica é <b>${topLoja.k}</b> (${topLoja.v}, ${concLoja}%).` : ""}
      </div>

      <div style="margin-top:10px; font-size:13px; color:#334155; line-height:1.55;">
        <b>Interpretação:</b> ${concMsg}
      </div>

      <div style="margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Onde está concentrando</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            <div style="font-weight:900; color:#0f172a;">Top times</div>
            ${topTimesTxt || "—"}
            <div style="margin-top:10px; font-weight:900; color:#0f172a;">Top lojas</div>
            ${topLojasTxt || "—"}
          </div>
        </div>

        <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Natureza do problema</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            <div>• Nota fiscal/Recibo: <b>${nf}</b></div>
            <div>• Etiqueta: <b>${etiq}</b></div>
            <div>• Descrição: <b>${desc}</b></div>
            <div style="margin-top:8px;">
              <b>Ponto dominante:</b> ${domTipo[0]} (${domTipo[1]} ocorrências).
              <span style="opacity:0.9;">(uma mesma transação pode ter mais de um tipo de pendência)</span>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Categorias de compra mais envolvidas</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            ${topCatsTxt || "Sem dados de categoria no recorte."}
          </div>
        </div>

        <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:14px; padding:12px;">
          <div style="font-weight:1000; color:#0f172a;">Datas com mais pendências</div>
          <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.5;">
            ${topDatasTxt || "Sem dados de data no recorte."}
          </div>
        </div>
      </div>

      <div style="margin-top:12px; background:rgba(181,255,32,0.12); border:1px solid rgba(181,255,32,0.45); border-radius:14px; padding:12px;">
        <div style="font-weight:1000; color:#0f172a;">Ações recomendadas (objetivas)</div>
        <div style="margin-top:8px; font-size:13px; color:#334155; line-height:1.55;">
          1) Priorize o time/loja líder do ranking (ataca onde dói mais).<br/>
          2) Se o dominante for <b>${domTipo[0]}</b>, padronize a rotina (checklist + cobrança diária) e valide se o problema é captura ou anexação.<br/>
          3) Use o detalhamento por categoria de compra para focar em fornecedores/rotas que geram mais pendência (ex.: combustível, manutenção, alimentação).<br/>
          4) Se a concentração estiver alta, trate como falha local; se estiver distribuída, trate como ajuste de processo/treinamento em rede.
        </div>
      </div>
    </div>
  `;
}

function vektorResumoCicloOpenAI_(){
  const bg = document.getElementById("cicloResumoAI");
  const body = document.getElementById("cicloResumoAIBody");
  if (!bg || !body) return;

  // usa SEMPRE o recorte já filtrado pela tela (applyFiltros_/Apply_)
  const tx = Array.isArray(window.__cicloResumoTxFiltered) ? window.__cicloResumoTxFiltered : [];

  // texto do período (se inputs existirem)
  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const dtIni = dtIniEl && dtIniEl.value ? dtIniEl.value : "";
  const dtFim = dtFimEl && dtFimEl.value ? dtFimEl.value : "";

  const periodoTxt = (dtIni && dtFim)
    ? `${dtIni.split("-").reverse().join("/") } → ${dtFim.split("-").reverse().join("/")}`
    : "";

  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");
  const filtroTxt = [
    selTime && selTime.value ? `Time: ${selTime.value}` : "Time: Todos",
    selLoja && selLoja.value ? `Loja: ${selLoja.value}` : ""
  ].filter(Boolean).join(" • ");

  body.innerHTML = vektorResumoCicloBuildAI_({ tx }, { periodoTxt, filtroTxt });

  bg.style.display = "block";
}

function vektorResumoCicloCloseAI_(){
  const bg = document.getElementById("cicloResumoAI");
  if (bg) bg.style.display = "none";
}

// bind 1x
try{
  const btn = document.getElementById("cicloResumo_aiBtn");
  const close = document.getElementById("cicloResumoAIClose");
  const bg = document.getElementById("cicloResumoAI");

  if (btn && !btn.__bindAI){
    btn.__bindAI = true;
    btn.addEventListener("click", vektorResumoCicloOpenAI_);
  }
  if (close && !close.__bindAI){
    close.__bindAI = true;
    close.addEventListener("click", vektorResumoCicloCloseAI_);
  }
  if (bg && !bg.__bindAI){
    bg.__bindAI = true;
    bg.addEventListener("mousedown", function(ev){
      if (ev.target === bg) vektorResumoCicloCloseAI_();
    });
    document.addEventListener("keydown", function(ev){
      if (ev.key === "Escape") vektorResumoCicloCloseAI_();
    });
  }
} catch(_){}

/* ===============================
   ANALISE DE GASTOS (FRONT)
   - não carrega automático
   - carrega filtros via backend
   - busca dados via backend ao clicar em "Buscar"
   - aplica filtros + sort + render tabela/cards
   =============================== */

function vektorShowAnaliseGastosView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");
  const envioPendView = document.getElementById("envioPendView");
  const cicloResumoView = document.getElementById("cicloResumoView");
  const homeView = document.getElementById("homeView");
  const analiseGastosView = document.getElementById("analiseGastosView");

  [chatView, radarView, feedbackView, myAlertsView, fluxView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (analiseGastosView) {
    analiseGastosView.classList.remove("hidden");
    analiseGastosView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
}

window.vektorOpenAnaliseGastos = function () {
  // Views existentes
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxogramaView = document.getElementById("fluxogramaView");
  const envioPendView = document.getElementById("envioPendView");
  const cicloResumoView = document.getElementById("cicloResumoView");
  const homeView = document.getElementById("homeView");

  // ✅ nova view
  const analiseGastosView = document.getElementById("analiseGastosView");

  // Esconde todas as outras
  [
    chatView,
    radarView,
    feedbackView,
    myAlertsView,
    fluxogramaView,
    envioPendView,
    cicloResumoView,
    homeView
  ].forEach(function(v){
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });

  // Abre Análise de Gastos
  if (analiseGastosView) {
    analiseGastosView.classList.remove("hidden");
    analiseGastosView.style.display = "block";
  }

  // Inicializa apenas uma vez
  try {
    vektorAnaliseGastosInitOnce_();
  } catch (e) {
    console.error("Erro ao inicializar Análise de Gastos:", e);
  }

  // ✅ NÃO reaproveitar dataset antigo ao entrar novamente na página
  try {
    window.__analiseGastosData = null;
    window.__analiseGastosTx = [];
  } catch (_) {}

  // ✅ Reset visual (cards + tabela) sem buscar dados
  try {
    const cLoja = document.getElementById("analiseGastos_cardLojaTop");
    const cLojaSub = document.getElementById("analiseGastos_cardLojaTopSub");
    const cTot = document.getElementById("analiseGastos_cardTotal");
    const cTotSub = document.getElementById("analiseGastos_cardTotalSub");
    const cCat = document.getElementById("analiseGastos_cardCategoriaTop");
    const cCatSub = document.getElementById("analiseGastos_cardCategoriaTopSub");
    const cEst = document.getElementById("analiseGastos_cardEstabTop");
    const cEstSub = document.getElementById("analiseGastos_cardEstabTopSub");
    const tb = document.getElementById("analiseGastos_tbody");

    if (cLoja) cLoja.textContent = "—";
    if (cLojaSub) cLojaSub.textContent = "—";

    if (cTot) cTot.textContent = "—";
    if (cTotSub) cTotSub.textContent = "—";

    if (cCat) cCat.textContent = "—";
    if (cCatSub) cCatSub.textContent = "—";

    if (cEst) cEst.textContent = "—";
    if (cEstSub) cEstSub.textContent = "—";

    if (tb) {
      tb.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#334155;">Informe o período e clique em Buscar para consultar os gastos.</td></tr>';
    }
  } catch (e) {
    console.error("Erro ao resetar visual da Análise de Gastos:", e);
  }

  // ✅ Carrega SOMENTE meta/filtros (ACL), sem buscar dataset
  try {
    vektorAnaliseGastosEnsureMeta_(function()
    {}, { silent: true });
  } catch (e) {
    console.error("Erro ao carregar meta da Análise de Gastos:", e);
  }
};

let __analiseGastos_inited = false;

function vektorAnaliseGastosEnsureMeta_(cb, opts){
  if (window.__analiseGastosMeta && window.__analiseGastosMeta.ok) {
    try { cb && cb(); } catch(_) {}
    return;
  }

  opts = opts || {};
  var silent = !!opts.silent;

  if (!silent) {
    vektorAnaliseGastosSetBusy_(true, "Carregando filtros…", "Respeitando permissões do usuário");
  }

  google.script.run
    .withSuccessHandler(function(res){
      if (!silent) vektorAnaliseGastosSetBusy_(false);

      if (!res || !res.ok) {
        const tb = document.getElementById("analiseGastos_tbody");
        if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Falha: ${vektorSafe_(res && res.error ? res.error : "erro desconhecido")}</td></tr>`;
        return;
      }

      window.__analiseGastosMeta = res;

      const selTime = document.getElementById("analiseGastos_selTime");
      const selLoja = document.getElementById("analiseGastos_selLoja");
      const selCat  = document.getElementById("analiseGastos_selCategoria");

      vektorBuildOptions_(selTime, (res.times || []), "Todos");
      vektorBuildOptions_(selLoja, (res.lojas || []), "Todas");
      vektorBuildOptions_(selCat,  (res.categorias || []), "Todas");

      // Primeiro reconstrói filtros dependentes (se necessário)
      try { vektorAnaliseGastosRebuildFilterOptions_(); } catch(_) {}

      // ✅ Depois hidrata Ano/Mês (para não ser sobrescrito)
      try { vektorAnaliseGastosHydrateAnoMes_(res); } catch(e){ console.error(e); }

      // ✅ Depois hidrata filtros do modal Macro
      try { vektorAnaliseGastosMacroHydrateFilters_(res); } catch(e){ console.error(e); }

      try { cb && cb(); } catch(_) {}
    })
    .withFailureHandler(function(err){
      if (!silent) vektorAnaliseGastosSetBusy_(false);

      const tb = document.getElementById("analiseGastos_tbody");
      if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Falha: ${vektorSafe_(err && err.message ? err.message : err)}</td></tr>`;
    })
    .getAnaliseGastosMeta();
}

function vektorAnaliseGastosBuscar_(){
  // ✅ sincroniza Ano/Mês -> Período antes de validar e buscar
  try { vektorAnaliseGastosSyncPeriodoByAnoMes_(); } catch(e){ console.error(e); }

  const dtIni = document.getElementById("analiseGastos_dtIni")?.value || "";
  const dtFim = document.getElementById("analiseGastos_dtFim")?.value || "";

  // ✅ NÃO carrega nada sem período completo
  if (!String(dtIni).trim() || !String(dtFim).trim()) {
    const tb = document.getElementById("analiseGastos_tbody");
    if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:1000;color:#334155;">Informe início e fim do período para buscar.</td></tr>`;
    return;
  }
  if (dtIni > dtFim) {
    const tb = document.getElementById("analiseGastos_tbody");
    if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:1000;color:#b91c1c;">Período inválido: início maior que fim.</td></tr>`;
    return;
  }

  // ✅ garante filtros carregados (com ACL) antes de buscar dataset
  vektorAnaliseGastosEnsureMeta_(function(){
    try { vektorAnaliseGastosRebuildFilterOptions_(); } catch(_) {}

    const selTime = document.getElementById("analiseGastos_selTime");
    const selLoja = document.getElementById("analiseGastos_selLoja");
    const selCat  = document.getElementById("analiseGastos_selCategoria");

    // ✅ MULTI: lê seleção como array (vazio = "Todos/Todas")
    const time = (typeof vektorGetMultiValues_ === "function") ? vektorGetMultiValues_(selTime) : [];
    const loja = (typeof vektorGetMultiValues_ === "function") ? vektorGetMultiValues_(selLoja) : [];
    const cat  = (typeof vektorGetMultiValues_ === "function") ? vektorGetMultiValues_(selCat)  : [];

    vektorAnaliseGastosSetBusy_(true, "Buscando dados…", "Aplicando permissões e filtros");

    google.script.run
      .withSuccessHandler(function(res){
        vektorAnaliseGastosSetBusy_(false);

        if (!res || !res.ok) {
          const tb = document.getElementById("analiseGastos_tbody");
          if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:1000;color:#b91c1c;">Falha: ${vektorSafe_(res && res.error ? res.error : "erro desconhecido")}</td></tr>`;
          return;
        }

        // guarda para sort/aplicar
        window.__analiseGastosData = res;
        window.__analiseGastosTx   = Array.isArray(res.tx) ? res.tx : [];

        // render direto (cards+tabela)
        vektorAnaliseGastosRender_(window.__analiseGastosTx, res.meta || { periodoTxt: dtIni + " a " + dtFim });
      })
      .withFailureHandler(function(err){
        vektorAnaliseGastosSetBusy_(false);
        const tb = document.getElementById("analiseGastos_tbody");
        if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:1000;color:#b91c1c;">Falha: ${vektorSafe_(err && err.message ? err.message : err)}</td></tr>`;
      })
      .getAnaliseGastosDataset({
        dtIni: dtIni,
        dtFim: dtFim,
        time: time,           // ✅ array
        loja: loja,           // ✅ array
        categoria: cat        // ✅ array
      });
  });
}

function vektorAnaliseGastosSetBusy_(isBusy, title, sub){
  const ov = document.getElementById("analiseGastos_overlay");
  const ovTitle = document.getElementById("analiseGastos_overlayTitle");
  const ovSub = document.getElementById("analiseGastos_overlaySub");
  if (!ov) return;

  if (isBusy) {
    if (ovTitle) ovTitle.textContent = title || "Carregando…";
    if (ovSub) ovSub.textContent = sub || "Aguarde";
    ov.classList.remove("hidden");
    ov.style.display = "block";
  } else {
    ov.classList.add("hidden");
    ov.style.display = "none";
  }
}

function vektorFmtBRL_(n){
  try { return (Number(n || 0)).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }
  catch(e){ return String(n || 0); }
}

function vektorSafe_(s){
  return String(s ?? "").replace(/[&<>"']/g, ch => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[ch]));
}

function vektorBuildOptions_(selectEl, values, allLabel){
  if (!selectEl) return;

  const isMulti = !!selectEl.multiple;
  const prevSelected = isMulti
    ? Array.from(selectEl.selectedOptions || []).map(o=>String(o.value||"")).filter(v=>v!=="")
    : [String(selectEl.value || "")].filter(v=>v!=="");

  selectEl.innerHTML =
    `<option value="">${allLabel}</option>` +
    (values || []).map(v => `<option value="${vektorSafe_(v)}">${vektorSafe_(v)}</option>`).join("");

  if (isMulti) {
    // se nada selecionado antes, mantém "Todos" selecionado
    if (!prevSelected.length) {
      selectEl.value = "";
    } else {
      // re-seleciona o que ainda existir
      Array.from(selectEl.options).forEach(opt=>{
        opt.selected = (opt.value === "") ? false : prevSelected.includes(opt.value);
      });
    }
  } else {
    const vAtual = prevSelected[0] || "";
    if (vAtual && (values || []).includes(vAtual)) selectEl.value = vAtual;
    else selectEl.value = "";
  }
}

function vektorGetMultiValues_(sel){
  if (!sel) return [];
  if (!sel.multiple) {
    const v = String(sel.value || "").trim();
    return v ? [v] : [];
  }
  const vals = Array.from(sel.selectedOptions || [])
    .map(o => String(o.value || "").trim())
    .filter(v => v !== "");
  return vals;
}

// regra do "Todos" no multi:
// - se selecionou algo (não vazio), desmarca o ""
// - se ficou sem nada, marca ""
function vektorNormalizeMultiAll_(sel){
  if (!sel || !sel.multiple) return;
  const picked = Array.from(sel.selectedOptions || []).map(o=>String(o.value||""));
  const hasNonAll = picked.some(v => v !== "");
  if (hasNonAll) {
    Array.from(sel.options).forEach(opt=>{
      if (opt.value === "") opt.selected = false;
    });
  } else {
    // garante "Todos" marcado
    sel.value = "";
  }
}

function vektorAnaliseGastosInitOnce_(){
  if (__analiseGastos_inited) return;
  __analiseGastos_inited = true;

  const btnBuscar = document.getElementById("analiseGastos_btnBuscar");

  const btnMediana = document.getElementById("analiseGastos_btnMediana");
  const medModal = document.getElementById("analiseGastos_medModal");
  const medModalClose = document.getElementById("analiseGastos_medModalClose");
  const medModalBackdrop = document.getElementById("analiseGastos_medModalBackdrop");

  const selTime = document.getElementById("analiseGastos_selTime");
  const selLoja = document.getElementById("analiseGastos_selLoja");
  const selCat  = document.getElementById("analiseGastos_selCategoria");

  const dtIniEl = document.getElementById("analiseGastos_dtIni");
  const dtFimEl = document.getElementById("analiseGastos_dtFim");

  const selAno = document.getElementById("analiseGastos_selAno");
  const selMes = document.getElementById("analiseGastos_selMes");

  const btnMacro = document.getElementById("analiseGastos_btnMacroVisoes");
  const btnMacroFechar = document.getElementById("analiseGastos_btnMacroFechar");
  const btnMacroAtualizar = document.getElementById("analiseGastos_macro_btnAtualizar");
  const macroSelLoja = document.getElementById("analiseGastos_macro_selLoja");
  const macroSelCat  = document.getElementById("analiseGastos_macro_selCategoria");
  const macroSelAno = document.getElementById("analiseGastos_macro_selAno");

  const cardEstabWrap = document.getElementById("analiseGastos_cardEstabWrap");
  const estabModal = document.getElementById("analiseGastos_estabModal");
  const estabModalClose = document.getElementById("analiseGastos_estabModalClose");
  const estabModalBackdrop = document.getElementById("analiseGastos_estabModalBackdrop");

  const estabPivotSearch = document.getElementById("analiseGastos_estabPivotSearch");
  const estabPivotSearchClear = document.getElementById("analiseGastos_estabPivotSearchClear");
  const estabPivotExportCsv = document.getElementById("analiseGastos_estabPivotExportCsv");

  // Estado inicial da tabela (sem carregar automaticamente)
  const tb = document.getElementById("analiseGastos_tbody");
  if (tb && !tb.dataset.initMsgDone) {
    tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#334155;">Informe o período e clique em Buscar para consultar os gastos.</td></tr>`;
    tb.dataset.initMsgDone = "1";
  }

  // filtros se respeitando (Time x Loja x Categoria) + apply local
  if (selTime) {
    selTime.addEventListener("change", function(){
      // ao trocar Time, limpa Loja para evitar combinação inválida persistida
      if (selLoja) selLoja.value = "";
      try { vektorAnaliseGastosRebuildFilterOptions_(); } catch(_) {}
      vektorAnaliseGastosApply_();
    });
  }

  if (selLoja) {
    selLoja.addEventListener("change", function(){
      try { vektorAnaliseGastosRebuildFilterOptions_(); } catch(_) {}
      vektorAnaliseGastosApply_();
    });
  }

  if (selCat) {
    selCat.addEventListener("change", function(){
      try { vektorAnaliseGastosRebuildFilterOptions_(); } catch(_) {}
      vektorAnaliseGastosApply_();
    });
  }

  if (macroSelAno && !macroSelAno.__bindMacroAnoChange) {
  macroSelAno.__bindMacroAnoChange = true;

  macroSelAno.addEventListener("change", function(){
    try { vektorAnaliseGastosMacroLoad_(); } catch(e){ console.error(e); }
  });

  // fallback para alguns comportamentos de UI/browser
  macroSelAno.addEventListener("input", function(){
    try { vektorAnaliseGastosMacroLoad_(); } catch(e){ console.error(e); }
  });
}

  // mudar datas NÃO busca automático; apenas reaplica local se já houver dataset
  if (dtIniEl) dtIniEl.addEventListener("change", function(){
  try { vektorAnaliseGastosClampDateInputs_(); } catch(e){ console.error(e); }
  vektorAnaliseGastosApply_();
});
if (dtFimEl) dtFimEl.addEventListener("change", function(){
  try { vektorAnaliseGastosClampDateInputs_(); } catch(e){ console.error(e); }
  vektorAnaliseGastosApply_();
});

  // ✅ Ano/Mês -> restringe período e aplica localmente (sem buscar automático)
if (selAno) {
  selAno.addEventListener("change", function(){
    try { vektorAnaliseGastosRebuildMesByAno_(); } catch(e){ console.error(e); }
    try { vektorAnaliseGastosSyncPeriodoByAnoMes_(); } catch(e){ console.error(e); }
    vektorAnaliseGastosApply_();
  });
}

if (selMes) {
  selMes.addEventListener("change", function(){
    try { vektorAnaliseGastosSyncPeriodoByAnoMes_(); } catch(e){ console.error(e); }
    vektorAnaliseGastosApply_();
  });
}

  // sort thead (bind 1x)
  try {
    const thead = document.querySelector("#analiseGastosTable thead");
    if (thead && !thead.__bindSortAnalise) {
      thead.__bindSortAnalise = true;
      thead.addEventListener("click", function(ev){
        const th = ev.target && ev.target.closest ? ev.target.closest("th[data-sort]") : null;
        if (!th) return;

        const col = th.getAttribute("data-sort") || "";
        if (!col) return;

        window.__analiseGastosSort = window.__analiseGastosSort || { col: "valor", dir: "desc" };

        if (window.__analiseGastosSort.col === col) {
          window.__analiseGastosSort.dir = (window.__analiseGastosSort.dir === "desc") ? "asc" : "desc";
        } else {
          window.__analiseGastosSort.col = col;
          window.__analiseGastosSort.dir = "desc";
        }

        vektorAnaliseGastosApply_();
      });
    }
  } catch(_) {}

  // ✅ único botão da página: Buscar
  // Ele mesmo garante meta (ACL + filtros) e depois busca dataset
  if (btnBuscar && !btnBuscar.__bindAnaliseBuscar) {
    btnBuscar.__bindAnaliseBuscar = true;
    btnBuscar.addEventListener("click", function(){
      vektorAnaliseGastosBuscar_();
    });
  }

  // ✅ botão "Média de Gastos" (modal de MEDIANA)
if (btnMediana && !btnMediana.__bindMedianaOpen) {
  btnMediana.__bindMedianaOpen = true;
  btnMediana.addEventListener("click", function(){
    try { vektorAnaliseGastosOpenMedianaModal_(); } catch(e){ console.error(e); }
  });
}

// ✅ fechar modal de mediana
if (medModalClose && !medModalClose.__bindMedianaClose) {
  medModalClose.__bindMedianaClose = true;
  medModalClose.addEventListener("click", function(){
    try { vektorAnaliseGastosCloseMedianaModal_(); } catch(e){ console.error(e); }
  });
}
if (medModalBackdrop && !medModalBackdrop.__bindMedianaClose) {
  medModalBackdrop.__bindMedianaClose = true;
  medModalBackdrop.addEventListener("click", function(){
    try { vektorAnaliseGastosCloseMedianaModal_(); } catch(e){ console.error(e); }
  });
}

  // ✅ abrir Macro Visões (garante meta/ACL carregada)
if (btnMacro && !btnMacro.__bindMacroOpen) {
  btnMacro.__bindMacroOpen = true;
  btnMacro.addEventListener("click", function(){
    vektorAnaliseGastosEnsureMeta_(function(){
      try { vektorAnaliseGastosOpenMacroModal_(); } catch(e){ console.error(e); }
    });
  });
}

// ✅ fechar modal Macro
if (btnMacroFechar && !btnMacroFechar.__bindMacroClose) {
  btnMacroFechar.__bindMacroClose = true;
  btnMacroFechar.addEventListener("click", function(){
    try { vektorAnaliseGastosCloseMacroModal_(); } catch(e){ console.error(e); }
  });
}

// ✅ atualizar gráficos do modal Macro
if (btnMacroAtualizar && !btnMacroAtualizar.__bindMacroLoad) {
  btnMacroAtualizar.__bindMacroLoad = true;
  btnMacroAtualizar.addEventListener("click", function(){
    try { vektorAnaliseGastosMacroLoad_(); } catch(e){ console.error(e); }
  });
}

// ✅ auto-update ao trocar filtros do modal
if (macroSelLoja && !macroSelLoja.__bindMacroChange) {
  macroSelLoja.__bindMacroChange = true;
  macroSelLoja.addEventListener("change", function(){
    try { vektorAnaliseGastosMacroLoad_(); } catch(e){ console.error(e); }
  });
}

if (macroSelCat && !macroSelCat.__bindMacroChange) {
  macroSelCat.__bindMacroChange = true;
  macroSelCat.addEventListener("change", function(){
    try { vektorAnaliseGastosMacroLoad_(); } catch(e){ console.error(e); }
  });
}

// ✅ abrir modal de detalhe por estabelecimentos (pivot mensal)
if (cardEstabWrap && !cardEstabWrap.__bindEstabPivotOpen) {
  cardEstabWrap.__bindEstabPivotOpen = true;

  cardEstabWrap.addEventListener("click", function(){
    try { vektorAnaliseGastosOpenEstabPivotModal_(); } catch(e){ console.error(e); }
  });

  // acessibilidade por teclado
  cardEstabWrap.addEventListener("keydown", function(ev){
    if (!ev) return;
    if (ev.key === "Enter" || ev.key === " ") {
      ev.preventDefault();
      try { vektorAnaliseGastosOpenEstabPivotModal_(); } catch(e){ console.error(e); }
    }
  });
}

// ✅ fechar modal de estabelecimentos
if (estabModalClose && !estabModalClose.__bindEstabPivotClose) {
  estabModalClose.__bindEstabPivotClose = true;
  estabModalClose.addEventListener("click", function(){
    try { vektorAnaliseGastosCloseEstabPivotModal_(); } catch(e){ console.error(e); }
  });
}

if (estabModalBackdrop && !estabModalBackdrop.__bindEstabPivotClose) {
  estabModalBackdrop.__bindEstabPivotClose = true;
  estabModalBackdrop.addEventListener("click", function(){
    try { vektorAnaliseGastosCloseEstabPivotModal_(); } catch(e){ console.error(e); }
  });
}

// ✅ filtro textual da pivot (modal de estabelecimentos)
if (estabPivotSearch && !estabPivotSearch.__bindPivotSearch) {
  estabPivotSearch.__bindPivotSearch = true;

  estabPivotSearch.addEventListener("input", function(){
    try { vektorAnaliseGastosEstabPivotApplySearch_(); } catch(e){ console.error(e); }
  });
}

if (estabPivotSearchClear && !estabPivotSearchClear.__bindPivotSearchClear) {
  estabPivotSearchClear.__bindPivotSearchClear = true;

  estabPivotSearchClear.addEventListener("click", function(){
    try {
      var inp = document.getElementById("analiseGastos_estabPivotSearch");
      if (inp) inp.value = "";
      vektorAnaliseGastosEstabPivotApplySearch_();
      if (inp) inp.focus();
    } catch(e){ console.error(e); }
  });
}

// ✅ exportar CSV
if (estabPivotExportCsv && !estabPivotExportCsv.__bindPivotCsv) {
  estabPivotExportCsv.__bindPivotCsv = true;
  estabPivotExportCsv.addEventListener("click", function(){
    try { vektorAnaliseGastosEstabPivotExportCsv_(); } catch(e){ console.error(e); }
  });
}

}

/* --------- BACKEND: meta (times/lojas/categorias permitidas) --------- */
function vektorAnaliseGastosLoadMeta_(){
  vektorAnaliseGastosSetBusy_(true, "Carregando filtros…", "Montando Times/Lojas/Categorias permitidos");

  google.script.run
    .withSuccessHandler(function(res){
      vektorAnaliseGastosSetBusy_(false);

      if (!res || !res.ok) {
        const tb = document.getElementById("analiseGastos_tbody");
        if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Falha: ${vektorSafe_(res && res.error ? res.error : "erro desconhecido")}</td></tr>`;
        return;
      }

      window.__analiseGastosMeta = res;

      const selTime = document.getElementById("analiseGastos_selTime");
      const selLoja = document.getElementById("analiseGastos_selLoja");
      const selCat  = document.getElementById("analiseGastos_selCategoria");

      // carrega opções iniciais completas
      vektorBuildOptions_(selTime, (res.times || []), "Todos");
      vektorBuildOptions_(selLoja, (res.lojas || []), "Todas");
      vektorBuildOptions_(selCat,  (res.categorias || []), "Todas");

      try { vektorAnaliseGastosHydrateAnoMes_(res); } catch(e){ console.error(e); }
      try { vektorAnaliseGastosMacroHydrateFilters_(res); } catch(e){ console.error(e); }

      // garante que os filtros passem a se respeitar
      vektorAnaliseGastosRebuildFilterOptions_();

      const tb = document.getElementById("analiseGastos_tbody");
      if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#334155;">Agora selecione filtros e clique em Buscar.</td></tr>`;
    })
    .withFailureHandler(function(err){
      vektorAnaliseGastosSetBusy_(false);
      const tb = document.getElementById("analiseGastos_tbody");
      if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Falha: ${vektorSafe_(err && err.message ? err.message : err)}</td></tr>`;
    })
    .getAnaliseGastosMeta();
}

/* --------- BACKEND: dados (tx) --------- */
function vektorAnaliseGastosFetchData_(){
  const meta = window.__analiseGastosMeta;
  if (!meta || !meta.ok) {
    const tb = document.getElementById("analiseGastos_tbody");
    if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Antes de Buscar, clique em “Carregar filtros”.</td></tr>`;
    return;
  }

  const dtIni = document.getElementById("analiseGastos_dtIni")?.value || "";
  const dtFim = document.getElementById("analiseGastos_dtFim")?.value || "";
  if (!dtIni || !dtFim) {
    const tb = document.getElementById("analiseGastos_tbody");
    if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Informe Início e Fim (período completo) antes de Buscar.</td></tr>`;
    return;
  }
  if (dtIni > dtFim) {
    const tb = document.getElementById("analiseGastos_tbody");
    if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Período inválido: Início maior que Fim.</td></tr>`;
    return;
  }

  const time = document.getElementById("analiseGastos_selTime")?.value || "";
  const loja = document.getElementById("analiseGastos_selLoja")?.value || "";
  const cat  = document.getElementById("analiseGastos_selCategoria")?.value || "";

  vektorAnaliseGastosSetBusy_(true, "Buscando BaseClara…", "Aplicando recortes por perfil e filtros");

  google.script.run
    .withSuccessHandler(function(res){
      vektorAnaliseGastosSetBusy_(false);
      if (!res || !res.ok) {
        const tb = document.getElementById("analiseGastos_tbody");
        if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Falha: ${vektorSafe_(res && res.error ? res.error : "erro desconhecido")}</td></tr>`;
        return;
      }

      window.__analiseGastosData = res;
      // grava tx base
      window.__analiseGastosTx = Array.isArray(res.tx) ? res.tx.slice() : [];

      // aplica filtros e render
      vektorAnaliseGastosApply_();
    })
    .withFailureHandler(function(err){
      vektorAnaliseGastosSetBusy_(false);
      const tb = document.getElementById("analiseGastos_tbody");
      if (tb) tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#b91c1c;">Falha: ${vektorSafe_(err && err.message ? err.message : err)}</td></tr>`;
    })
    .getAnaliseGastosDataset({
      dtIni: dtIni,
      dtFim: dtFim,
      time: time,
      loja: loja,
      categoria: cat
    });
}

function vektorAnaliseGastosRebuildFilterOptions_(){
  var meta = window.__analiseGastosMeta || {};
  var combos = Array.isArray(meta.combos) ? meta.combos : [];

  var selTime = document.getElementById("analiseGastos_selTime");
  var selLoja = document.getElementById("analiseGastos_selLoja");
  var selCat  = document.getElementById("analiseGastos_selCategoria");

  if (!selTime || !selLoja || !selCat) return;

  // normaliza "Todos" no multi
  try { vektorNormalizeMultiAll_(selTime); } catch(_) {}
  try { vektorNormalizeMultiAll_(selLoja); } catch(_) {}
  try { vektorNormalizeMultiAll_(selCat); } catch(_) {}

  var curTimes = vektorGetMultiValues_(selTime); // [] = todos
  var curLojas = vektorGetMultiValues_(selLoja);
  var curCats  = vektorGetMultiValues_(selCat);

  function inSet_(arr, v){
    if (!arr || !arr.length) return true; // vazio = todos
    return arr.indexOf(String(v||"")) >= 0;
  }

  // 1) LOJAS possíveis respeitando Times e Cats selecionados
  var lojasSet = {};
  combos.forEach(function(c){
    if (!inSet_(curTimes, c.time)) return;
    if (!inSet_(curCats,  c.categoria)) return;
    lojasSet[String(c.loja || "")] = true;
  });
  var lojas = Object.keys(lojasSet).filter(Boolean).sort((a,b)=>a.localeCompare(b,"pt-BR"));

  // 2) TIMES possíveis respeitando Lojas e Cats selecionados
  var timesSet = {};
  combos.forEach(function(c){
    if (!inSet_(curLojas, c.loja)) return;
    if (!inSet_(curCats,  c.categoria)) return;
    timesSet[String(c.time || "")] = true;
  });
  var times = Object.keys(timesSet).filter(Boolean).sort((a,b)=>a.localeCompare(b,"pt-BR"));

  // 3) CATEGORIAS possíveis respeitando Times e Lojas selecionados
  var catsSet = {};
  combos.forEach(function(c){
    if (!inSet_(curTimes, c.time)) return;
    if (!inSet_(curLojas, c.loja)) return;
    catsSet[String(c.categoria || "")] = true;
  });
  var cats = Object.keys(catsSet).filter(Boolean).sort((a,b)=>a.localeCompare(b,"pt-BR"));

  // rebuild preservando o que ainda existir
  vektorBuildOptions_(selTime, times, "Todos");
  vektorBuildOptions_(selLoja, lojas, "Todas");
  vektorBuildOptions_(selCat,  cats,  "Todas");

  // remove seleções inválidas (multi)
  function dropInvalid_(sel, allowed){
    if (!sel || !sel.multiple) return;
    const allowedSet = {};
    allowed.forEach(v=>allowedSet[String(v)] = true);

    let any = false;
    Array.from(sel.options).forEach(opt=>{
      if (opt.value === "") return;
      if (opt.selected && !allowedSet[opt.value]) opt.selected = false;
      if (opt.selected) any = true;
    });

    // se não sobrou nada, volta para "Todos"
    if (!any) sel.value = "";
  }

  dropInvalid_(selTime, times);
  dropInvalid_(selLoja, lojas);
  dropInvalid_(selCat,  cats);
}

/* --------- Apply (filtros locais + sort + render cards/tabela) --------- */
function vektorAnaliseGastosApply_(){
  // ✅ faz os filtros se respeitarem entre si (Time x Loja x Categoria)
  try { vektorAnaliseGastosRebuildFilterOptions_(); } catch(_) {}

  if (!window.__analiseGastosData || !Array.isArray(window.__analiseGastosTx)) {
  return; // ainda não houve busca; não renderiza cards/tabela
}

  const res = window.__analiseGastosData;
  let tx = Array.isArray(window.__analiseGastosTx) ? window.__analiseGastosTx.slice() : [];

  const dtIni = document.getElementById("analiseGastos_dtIni")?.value || "";
  const dtFim = document.getElementById("analiseGastos_dtFim")?.value || "";
  const time = vektorGetMultiValues_(document.getElementById("analiseGastos_selTime"));
  const loja = vektorGetMultiValues_(document.getElementById("analiseGastos_selLoja"));
  const cat  = vektorGetMultiValues_(document.getElementById("analiseGastos_selCategoria"));

  const ano   = document.getElementById("analiseGastos_selAno")?.value || "";
  const mes   = document.getElementById("analiseGastos_selMes")?.value || ""; // "01".."12"

  // filtros locais (reforço visual / pós-busca)
  tx = tx.filter(t => {
    const d = String(t.dataISO || "");
    if (dtIni && d < dtIni) return false;
    if (dtFim && d > dtFim) return false;
    if (time.length && time.indexOf(String(t.time||"")) < 0) return false;
    if (loja.length && loja.indexOf(String(t.loja||"")) < 0) return false;
    if (cat.length  && cat.indexOf(String(t.categoria||"")) < 0) return false;
    if (ano && String(d).slice(0,4) !== String(ano)) return false;
    if (mes && String(d).slice(5,7) !== String(mes)) return false;
    return true;
  });

  // sort
  const s = window.__analiseGastosSort || { col: "valor", dir: "desc" };
  const dir = (s.dir === "asc") ? 1 : -1;

  function cmpStr(a,b){ return String(a||"").localeCompare(String(b||""), "pt-BR"); }
  function cmpNum(a,b){ return (Number(a||0) - Number(b||0)); }

  tx.sort(function(a,b){
    const col = s.col;
    let r = 0;

    if (col === "data") r = cmpStr(a.dataISO, b.dataISO);
    else if (col === "loja") r = cmpStr(a.loja, b.loja);
    else if (col === "time") r = cmpStr(a.time, b.time);
    else if (col === "categoria") r = cmpStr(a.categoria, b.categoria);
    else if (col === "estab") r = cmpStr(a.estabelecimento, b.estabelecimento);
    else if (col === "descricao") r = cmpStr(a.descricao, b.descricao);
    else if (col === "valor") r = cmpNum(a.valor, b.valor);
    else r = cmpNum(a.valor, b.valor);

    return r * dir;
  });

  vektorAnaliseGastosRender_(tx, res && res.meta ? res.meta : null);
}

function vektorAnaliseGastosRender_(tx, meta){
  // ✅ guarda snapshot filtrado atual para o modal de estabelecimentos
    try {
      window.__analiseGastosLastFilteredTx = Array.isArray(tx) ? tx.slice() : [];
      window.__analiseGastosLastFilteredMeta = meta || null;
    } catch(_) {}

  function toBRPeriod_(txt){
    var s = String(txt || "").trim();
    if (!s) return "—";
    // espera "yyyy-mm-dd a yyyy-mm-dd"
    var m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+a\s+(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return s;
    return m[3] + "/" + m[2] + "/" + m[1] + " a " + m[6] + "/" + m[5] + "/" + m[4];
  }

  // cards
  const total = tx.reduce((s,t)=> s + (Number(t.valor)||0), 0);

  let topLoja = { k:"—", v:0 };
  let topCat  = { k:"—", v:0 };
  let topEst  = { k:"—", v:0 };

  const mapLoja = {};
  const mapCat  = {};
  const mapEst  = {};

  tx.forEach(t=>{
    const v = Number(t.valor)||0;
    const loja = String(t.loja||"").trim() || "—";
    const cat  = String(t.categoria||"").trim() || "—";
    const est  = String(t.estabelecimento||"").trim() || "—";

    mapLoja[loja] = (mapLoja[loja]||0) + v;
    mapCat[cat]   = (mapCat[cat]||0) + v;
    mapEst[est]   = (mapEst[est]||0) + v;
  });

  Object.keys(mapLoja).forEach(k=>{ if (mapLoja[k] > topLoja.v) topLoja = { k, v: mapLoja[k] }; });
  Object.keys(mapCat).forEach(k=>{ if (mapCat[k] > topCat.v) topCat = { k, v: mapCat[k] }; });
  Object.keys(mapEst).forEach(k=>{ if (mapEst[k] > topEst.v) topEst = { k, v: mapEst[k] }; });

  // ✅ normaliza textos longos (sem cortar valor, só o nome)
  const maxCardText = (s, n) => {
    s = String(s || "—");
    return s.length > n ? (s.slice(0, n - 1) + "…") : s;
  };

  const elLoja = document.getElementById("analiseGastos_cardLojaTop");
  const elLojaSub = document.getElementById("analiseGastos_cardLojaTopSub");
  const elTotal = document.getElementById("analiseGastos_cardTotal");
  const elTotalSub = document.getElementById("analiseGastos_cardTotalSub");
  const elCat = document.getElementById("analiseGastos_cardCategoriaTop");
  const elCatSub = document.getElementById("analiseGastos_cardCategoriaTopSub");
  const elEst = document.getElementById("analiseGastos_cardEstabTop");
  const elEstSub = document.getElementById("analiseGastos_cardEstabTopSub");

  if (elLoja) elLoja.textContent = topLoja.k;
  if (elLojaSub) elLojaSub.textContent = vektorFmtBRL_(topLoja.v);

  if (elTotal) elTotal.textContent = vektorFmtBRL_(total);
  if (elTotalSub) {
    var periodoTxt = (meta && meta.periodoTxt) ? meta.periodoTxt : "";
    elTotalSub.textContent = toBRPeriod_(periodoTxt);
  }

  if (elCat) elCat.textContent = maxCardText(topCat.k, 44);
  if (elCatSub) elCatSub.textContent = vektorFmtBRL_(topCat.v);

  if (elEst) elEst.textContent = maxCardText(topEst.k, 36);
  if (elEstSub) elEstSub.textContent = vektorFmtBRL_(topEst.v);

  // tabela
  const tb = document.getElementById("analiseGastos_tbody");
  if (!tb) return;

  if (!tx.length) {
    tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:14px;font-weight:900;color:#334155;">Sem dados para os filtros selecionados.</td></tr>`;
    return;
  }

  tb.innerHTML = tx.map(t=>{
    const dataTxt = t.dataBR || (t.dataISO ? String(t.dataISO).split("-").reverse().join("/") : "—");
    return `
      <tr class="analiseGastosRow">
        <td style="text-align:center;">${vektorSafe_(dataTxt)}</td>
        <td style="text-align:center;font-weight:900;">${vektorSafe_(t.loja||"—")}</td>
        <td style="text-align:center;">${vektorSafe_(t.time||"—")}</td>
        <td style="text-align:center;">${vektorSafe_(t.categoria||"—")}</td>
        <td style="text-align:left;">${vektorSafe_(t.estabelecimento||"—")}</td>
        <td style="text-align:right;font-weight:900;">${vektorFmtBRL_(t.valor||0)}</td>
        <td style="text-align:left;">${vektorSafe_(t.descricao||"—")}</td>
      </tr>
    `;
  }).join("");
}

// =========================
// Modal (Medianas) - Sort state
// =========================
window.__analiseGastosMedSort = window.__analiseGastosMedSort || { col: "mediana", dir: "desc" };
window.__analiseGastosMedRows = window.__analiseGastosMedRows || [];

// bind 1x no thead do modal
function vektorAnaliseGastosMedBindSort_(){
  const thead = document.querySelector("#analiseGastos_medTable thead");
  if (!thead || thead.__bindSortMed) return;
  thead.__bindSortMed = true;

  thead.addEventListener("click", function(ev){
    const th = ev.target && ev.target.closest ? ev.target.closest("th[data-sort]") : null;
    if (!th) return;

    const col = String(th.getAttribute("data-sort") || "").trim();
    if (!col) return;

    window.__analiseGastosMedSort = window.__analiseGastosMedSort || { col: "mediana", dir: "desc" };

    if (window.__analiseGastosMedSort.col === col) {
      window.__analiseGastosMedSort.dir = (window.__analiseGastosMedSort.dir === "desc") ? "asc" : "desc";
    } else {
      window.__analiseGastosMedSort.col = col;
      window.__analiseGastosMedSort.dir = "desc";
    }

    vektorAnaliseGastosMedUpdateSortIcons_();
    vektorAnaliseGastosMedApplySortAndRender_();
  });

  // aplica ícones iniciais
  vektorAnaliseGastosMedUpdateSortIcons_();
}

function vektorAnaliseGastosMedUpdateSortIcons_(){
  try {
    const ths = document.querySelectorAll("#analiseGastos_medTable thead th[data-sort]");
    if (!ths) return;

    ths.forEach(x => x.classList.remove("asc","desc"));

    const st = window.__analiseGastosMedSort || { col:"mediana", dir:"desc" };
    const active = document.querySelector(`#analiseGastos_medTable thead th[data-sort="${st.col}"]`);
    if (active) active.classList.add(st.dir);
  } catch(_) {}
}

function vektorAnaliseGastosMedApplySortAndRender_(){
  const tb = document.getElementById("analiseGastos_medTbody");
  if (!tb) return;

  const rows0 = Array.isArray(window.__analiseGastosMedRows) ? window.__analiseGastosMedRows.slice() : [];
  if (!rows0.length) {
    tb.innerHTML = `<tr><td colspan="5" id="analiseGastos_medMsg">Sem dados para o período/filtros.</td></tr>`;
    return;
  }

  const st = window.__analiseGastosMedSort || { col:"mediana", dir:"desc" };
  const dirMul = (st.dir === "asc") ? 1 : -1;

  function num_(v){
    const n = Number(v);
    return isFinite(n) ? n : 0;
  }

  rows0.sort(function(a,b){
    let va, vb;

    switch (st.col) {
      case "loja":
        // tenta numérico primeiro (loja costuma ser número)
        va = num_(a.loja); vb = num_(b.loja);
        if (va !== vb) return (va - vb) * dirMul;
        return String(a.loja||"").localeCompare(String(b.loja||""), "pt-BR") * dirMul;

      case "categoria":
        return String(a.categoria||"").localeCompare(String(b.categoria||""), "pt-BR") * dirMul;

      case "max":
        return (num_(a.max) - num_(b.max)) * dirMul;

      case "min":
        return (num_(a.min) - num_(b.min)) * dirMul;

      case "mediana":
      default:
        return (num_(a.mediana) - num_(b.mediana)) * dirMul;
    }
  });

  tb.innerHTML = rows0.map(function(r){
    return `
      <tr>
        <td style="text-align:center;font-weight:1000;">${vektorSafe_(r.loja || "—")}</td>
        <td style="text-align:left;font-weight:900;">${vektorSafe_(r.categoria || "—")}</td>
        <td class="num">${vektorFmtBRL_(r.mediana || 0)}</td>
        <td class="num">${vektorFmtBRL_(r.max || 0)}</td>
        <td class="num">${vektorFmtBRL_(r.min || 0)}</td>
      </tr>
    `;
  }).join("");
}

function vektorAnaliseGastosOpenMedianaModal_(){
  var modal = document.getElementById("analiseGastos_medModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.style.display = "block";
  modal.setAttribute("aria-hidden", "false");

  try { vektorAnaliseGastosMedBindSort_(); } catch(e){ console.error(e); }

  // mensagem inicial
  var tb = document.getElementById("analiseGastos_medTbody");
  if (tb) tb.innerHTML = `<tr><td colspan="5" id="analiseGastos_medMsg">Carregando…</td></tr>`;

  vektorAnaliseGastosLoadMedianas_();
}

function vektorAnaliseGastosCloseMedianaModal_(){
  var modal = document.getElementById("analiseGastos_medModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");
}

function vektorAnaliseGastosLoadMedianas_(){
  const dtIni = document.getElementById("analiseGastos_dtIni")?.value || "";
  const dtFim = document.getElementById("analiseGastos_dtFim")?.value || "";

  if (!dtIni || !dtFim || dtIni > dtFim) {
    var tb = document.getElementById("analiseGastos_medTbody");
    if (tb) tb.innerHTML = `<tr><td colspan="5" id="analiseGastos_medMsg">Defina um período válido na tela principal.</td></tr>`;
    return;
  }

  const time = vektorGetMultiValues_(document.getElementById("analiseGastos_selTime"));
  const loja = vektorGetMultiValues_(document.getElementById("analiseGastos_selLoja"));
  const cat  = vektorGetMultiValues_(document.getElementById("analiseGastos_selCategoria"));

  google.script.run
    .withSuccessHandler(function(res){
      if (!res || !res.ok) {
        var tb = document.getElementById("analiseGastos_medTbody");
        if (tb) tb.innerHTML = `<tr><td colspan="5" id="analiseGastos_medMsg" style="color:#b91c1c;">Falha: ${vektorSafe_(res && res.error ? res.error : "erro desconhecido")}</td></tr>`;
        return;
      }
      vektorAnaliseGastosRenderMedianas_(res);
    })
    .withFailureHandler(function(err){
      var tb = document.getElementById("analiseGastos_medTbody");
      if (tb) tb.innerHTML = `<tr><td colspan="5" id="analiseGastos_medMsg" style="color:#b91c1c;">Falha: ${vektorSafe_(err && err.message ? err.message : err)}</td></tr>`;
    })
    .getAnaliseGastosMedianas({
      dtIni: dtIni,
      dtFim: dtFim,
      time: time,
      loja: loja,
      categoria: cat
    });
}

function vektorAnaliseGastosRenderMedianas_(res){
  const rows = Array.isArray(res.rows) ? res.rows : [];
  const m = res.metrics || {};

  const elMed = document.getElementById("analiseGastos_medCardMedian");
  const elAvg = document.getElementById("analiseGastos_medCardMean");
  const elNor = document.getElementById("analiseGastos_medCardNorm");

  if (elMed) elMed.textContent = vektorFmtBRL_(m.median || 0);
  if (elAvg) elAvg.textContent = vektorFmtBRL_(m.mean || 0);

  // normalização 0..1 (render como % também)
  const norm = Number(m.normalization || 0);
  if (elNor) elNor.textContent = (isFinite(norm) ? (norm.toFixed(3) + " (" + Math.round(norm*100) + "%)") : "—");

  const tb = document.getElementById("analiseGastos_medTbody");
  if (!tb) return;

  if (!rows.length) {
    // ✅ limpa cache e mantém msg
    window.__analiseGastosMedRows = [];
    tb.innerHTML = `<tr><td colspan="5" id="analiseGastos_medMsg">Sem dados para o período/filtros.</td></tr>`;
    return;
  }

  // ✅ cache das linhas + aplica ordenação atual (clique no header)
  window.__analiseGastosMedRows = rows.slice();

  try { vektorAnaliseGastosMedBindSort_(); } catch(_) {}
  try { vektorAnaliseGastosMedUpdateSortIcons_(); } catch(_) {}

  // ✅ render pela rotina de sort (evita duplicação de lógica)
  try {
    vektorAnaliseGastosMedApplySortAndRender_();
  } catch(e) {
    // fallback: render direto sem sort se algo falhar
    console.error(e);
    tb.innerHTML = rows.map(r=>{
      return `
        <tr>
          <td style="text-align:center;font-weight:1000;">${vektorSafe_(r.loja || "—")}</td>
          <td style="text-align:left;font-weight:900;">${vektorSafe_(r.categoria || "—")}</td>
          <td class="num">${vektorFmtBRL_(r.mediana || 0)}</td>
          <td class="num">${vektorFmtBRL_(r.max || 0)}</td>
          <td class="num">${vektorFmtBRL_(r.min || 0)}</td>
        </tr>
      `;
    }).join("");
  }
}

function vektorAnaliseGastosOpenEstabPivotModal_(){
  var modal = document.getElementById("analiseGastos_estabModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.style.display = "block";
  modal.setAttribute("aria-hidden", "false");

  try {
  var countEl = document.getElementById("analiseGastos_estabPivotCount");
  if (countEl) countEl.textContent = "Carregando...";
} catch(_) {}

  vektorAnaliseGastosRenderEstabPivotModal_();
}

function vektorAnaliseGastosCloseEstabPivotModal_(){
  var modal = document.getElementById("analiseGastos_estabModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");
}

function vektorAnaliseGastosRenderEstabPivotModal_(){
  var wrap = document.getElementById("analiseGastos_estabPivotWrap");
  var sub  = document.getElementById("analiseGastos_estabModalSub");
  if (!wrap) return;

  var tx = Array.isArray(window.__analiseGastosLastFilteredTx) ? window.__analiseGastosLastFilteredTx.slice() : [];
  var meta = window.__analiseGastosLastFilteredMeta || {};

  if (!tx.length) {
    wrap.innerHTML = `<div id="analiseGastos_estabPivotMsg">Sem dados para os filtros aplicados na página principal.</div>`;
    if (sub) sub.textContent = "Sem dados para os filtros aplicados na página principal.";

    // ✅ limpa estado da pivot quando não há dados
    try {
      window.__analiseGastosEstabPivotState = null;
      window.__analiseGastosEstabPivotStateCurrentView = null;
    } catch(_) {}

    // ✅ reseta busca/contador do modal
    try {
      var inp0 = document.getElementById("analiseGastos_estabPivotSearch");
      var cnt0 = document.getElementById("analiseGastos_estabPivotCount");
      if (inp0) inp0.value = "";
      if (cnt0) cnt0.textContent = "0 estabelecimentos exibidos";
    } catch(_) {}

    return;
  }

  function ymFromISO_(iso){
    var s = String(iso || "");
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return "";
    return s.slice(0, 7); // yyyy-mm
  }

  // maps
  var monthSet = {};
  var estabMap = {}; // { estab: { total, byMonth:{ym:sum} } }
  var colTotals = {};
  var grandTotal = 0;

  tx.forEach(function(t){
    var est = String((t && t.estabelecimento) || "").trim() || "—";
    var dIso = String((t && t.dataISO) || "").trim();
    var ym = ymFromISO_(dIso);
    if (!ym) return;

    var v = Number((t && t.valor) || 0) || 0;

    monthSet[ym] = true;

    if (!estabMap[est]) {
      estabMap[est] = { total: 0, byMonth: {} };
    }

    estabMap[est].total += v;
    estabMap[est].byMonth[ym] = (Number(estabMap[est].byMonth[ym]) || 0) + v;

    colTotals[ym] = (Number(colTotals[ym]) || 0) + v;
    grandTotal += v;
  });

  var months = Object.keys(monthSet).sort(); // yyyy-mm crescente
  if (!months.length) {
    wrap.innerHTML = `<div id="analiseGastos_estabPivotMsg">Não foi possível identificar os meses no período filtrado.</div>`;

    try {
      window.__analiseGastosEstabPivotState = null;
      window.__analiseGastosEstabPivotStateCurrentView = null;
    } catch(_) {}

    try {
      var inp1 = document.getElementById("analiseGastos_estabPivotSearch");
      var cnt1 = document.getElementById("analiseGastos_estabPivotCount");
      if (inp1) inp1.value = "";
      if (cnt1) cnt1.textContent = "0 estabelecimentos exibidos";
    } catch(_) {}

    return;
  }

  // ordena estabelecimentos por total desc
  var estRows = Object.keys(estabMap).map(function(est){
    return {
      estabelecimento: est,
      total: Number(estabMap[est].total || 0) || 0,
      byMonth: estabMap[est].byMonth || {}
    };
  });

  estRows.sort(function(a,b){
    if (b.total !== a.total) return b.total - a.total;
    return String(a.estabelecimento).localeCompare(String(b.estabelecimento), "pt-BR");
  });

  // subtítulo do modal
  try {
    var qtdEst = estRows.length;
    var perTxt = (meta && meta.periodoTxt) ? String(meta.periodoTxt) : "";
    sub.textContent =
      "Somatória mensal por estabelecimento (" + qtdEst + " estabelecimento" + (qtdEst === 1 ? "" : "s") + ") • " +
      (perTxt ? ("Período aplicado: " + perTxt.replace(/^(\d{4})-(\d{2})-(\d{2})\s+a\s+(\d{4})-(\d{2})-(\d{2})$/, "$3/$2/$1 a $6/$5/$4")) : "Filtros da página principal");
  } catch(_) {}

  // ✅ guarda estado completo da pivot para filtro/export
  window.__analiseGastosEstabPivotState = {
    months: months.slice(), // ["2026-01","2026-02",...]
    rows: estRows.map(function(r){
      return {
        estabelecimento: String(r.estabelecimento || ""),
        total: Number(r.total || 0) || 0,
        byMonth: Object.assign({}, r.byMonth || {})
      };
    }),
    colTotalsAll: Object.assign({}, colTotals || {}),
    grandTotalAll: Number(grandTotal || 0) || 0,
    search: ""
  };

  // ✅ limpa busca ao abrir novo dataset
  try {
    var inpSearch = document.getElementById("analiseGastos_estabPivotSearch");
    if (inpSearch) inpSearch.value = "";
  } catch(_) {}

  // ✅ renderiza tabela a partir do estado (necessário para busca + export CSV)
  if (typeof vektorAnaliseGastosEstabPivotRenderTableFromState_ === "function") {
    vektorAnaliseGastosEstabPivotRenderTableFromState_();
  } else {
    // fallback defensivo (se a função ainda não foi colada)
    wrap.innerHTML = `<div id="analiseGastos_estabPivotMsg">Tabela pronta, mas a função de renderização da pivot não foi encontrada.</div>`;
  }
}

function vektorAnaliseGastosEstabPivotApplySearch_(){
  var st = window.__analiseGastosEstabPivotState || null;
  if (!st) return;

  var inp = document.getElementById("analiseGastos_estabPivotSearch");
  st.search = String((inp && inp.value) || "").trim().toLowerCase();

  vektorAnaliseGastosEstabPivotRenderTableFromState_();
}

function vektorAnaliseGastosEstabPivotRenderTableFromState_(){
  var wrap = document.getElementById("analiseGastos_estabPivotWrap");
  var countEl = document.getElementById("analiseGastos_estabPivotCount");
  var st = window.__analiseGastosEstabPivotState || null;
  if (!wrap) return;

  if (!st || !Array.isArray(st.months) || !Array.isArray(st.rows)) {
    wrap.innerHTML = `<div id="analiseGastos_estabPivotMsg">Estrutura da tabela não disponível.</div>`;
    if (countEl) countEl.textContent = "0 itens";
    return;
  }

  function ymToMMYYYY_(ym){
    if (!/^\d{4}-\d{2}$/.test(String(ym || ""))) return String(ym || "");
    return String(ym).slice(5,7) + "/" + String(ym).slice(0,4);
  }

  var months = st.months.slice();
  var search = String(st.search || "").trim().toLowerCase();

  var rows = (st.rows || []).filter(function(r){
    var nome = String((r && r.estabelecimento) || "").toLowerCase();
    if (!search) return true;
    return nome.indexOf(search) >= 0;
  });

  // recalcula totais com base no filtro textual atual
  var colTotals = {};
  var grandTotal = 0;
  months.forEach(function(ym){ colTotals[ym] = 0; });

  rows.forEach(function(r){
    months.forEach(function(ym){
      var v = Number((r.byMonth && r.byMonth[ym]) || 0) || 0;
      colTotals[ym] = (Number(colTotals[ym]) || 0) + v;
    });
    grandTotal += Number(r.total || 0) || 0;
  });

  if (countEl) {
    countEl.textContent = rows.length + " estabelecimento" + (rows.length === 1 ? "" : "s") + " exibido" + (rows.length === 1 ? "" : "s");
  }

  if (!rows.length) {
    wrap.innerHTML = `<div id="analiseGastos_estabPivotMsg">Nenhum estabelecimento encontrado para a busca informada.</div>`;
    return;
  }

  var thead = `
    <thead>
      <tr>
        <th>Estabelecimento</th>
        ${months.map(function(ym){ return `<th>${vektorSafe_(ymToMMYYYY_(ym))}</th>`; }).join("")}
        <th>Total</th>
      </tr>
    </thead>
  `;

  var tbody = `
    <tbody>
      ${rows.map(function(r){
        return `
          <tr>
            <td>${vektorSafe_(r.estabelecimento)}</td>
            ${months.map(function(ym){
              var v = Number((r.byMonth && r.byMonth[ym]) || 0) || 0;
              return `<td class="num estabPivotHeatCell" data-v="${v}">${vektorFmtBRL_(v)}</td>`;
            }).join("")}
            <td class="num" style="font-weight:1000;">${vektorFmtBRL_(Number(r.total || 0) || 0)}</td>
          </tr>
        `;
      }).join("")}
    </tbody>
  `;

  var tfoot = `
    <tfoot>
      <tr>
        <td>Total geral</td>
        ${months.map(function(ym){
          return `<td class="num">${vektorFmtBRL_(Number(colTotals[ym] || 0) || 0)}</td>`;
        }).join("")}
        <td class="num">${vektorFmtBRL_(Number(grandTotal || 0) || 0)}</td>
      </tr>
    </tfoot>
  `;

  wrap.innerHTML = `
    <table id="analiseGastos_estabPivotTable">
      ${thead}
      ${tbody}
      ${tfoot}
    </table>
  `;
  try { vektorAnaliseGastosApplyEstabPivotHeatmap_(); } catch(e){ console.error(e); }

  // ✅ snapshot da visão atual (já filtrada por texto) para export
  window.__analiseGastosEstabPivotStateCurrentView = {
    months: months.slice(),
    rows: rows.map(function(r){
      return {
        estabelecimento: String(r.estabelecimento || ""),
        total: Number(r.total || 0) || 0,
        byMonth: Object.assign({}, r.byMonth || {})
      };
    }),
    colTotals: Object.assign({}, colTotals || {}),
    grandTotal: Number(grandTotal || 0) || 0
  };
}

function vektorAnaliseGastosApplyEstabPivotHeatmap_(){
  var table = document.getElementById("analiseGastos_estabPivotTable");
  if (!table) return;

  var tbody = table.querySelector("tbody");
  if (!tbody) return;

  var rows = Array.prototype.slice.call(tbody.querySelectorAll("tr"));
  if (!rows.length) return;

  // Descobre quantas colunas existem no tbody
  // Estrutura esperada:
  // col 0 = Estabelecimento
  // col 1..N = meses (heatmap)
  // última col = Total (sem heatmap)
  var firstTds = rows[0].querySelectorAll("td");
  if (!firstTds || firstTds.length < 3) return;

  var totalCols = firstTds.length;
  var firstMonthColIndex = 1;
  var lastMonthColIndex = totalCols - 2; // última é "Total"

  // 1) Limpa estilos anteriores das células heatmap (defensivo)
  rows.forEach(function(tr){
    var tds = tr.querySelectorAll("td.estabPivotHeatCell");
    Array.prototype.forEach.call(tds, function(td){
      td.style.background = "";
      td.style.color = "";
      td.style.fontWeight = "900";
      td.style.textShadow = "none";
    });
  });

  // 2) Aplica escala por coluna de mês
  for (var colIdx = firstMonthColIndex; colIdx <= lastMonthColIndex; colIdx++) {
    var colCells = [];
    var positives = [];

    rows.forEach(function(tr){
      var tds = tr.querySelectorAll("td");
      var td = tds[colIdx];
      if (!td) return;

      // Só aplica nas células marcadas como heatmap
      if (!td.classList.contains("estabPivotHeatCell")) return;

      var v = Number(td.getAttribute("data-v") || 0) || 0;
      colCells.push({ td: td, v: v });

      if (v > 0) positives.push(v);
    });

    // Se não há valores positivos nesta coluna, deixa neutro
    if (!positives.length) {
      colCells.forEach(function(obj){
        obj.td.style.background = "rgba(148,163,184,0.06)";
        obj.td.style.color = "#334155";
        obj.td.style.fontWeight = "800";
        obj.td.style.textShadow = "none";
      });
      continue;
    }

    var minV = Math.min.apply(null, positives);
    var maxV = Math.max.apply(null, positives);
    var same = (maxV === minV);

    colCells.forEach(function(obj){
      var td = obj.td;
      var v = obj.v;

      // zero ou negativo: neutro (mais legível)
      if (v <= 0) {
        td.style.background = "rgba(148,163,184,0.06)";
        td.style.color = "#334155";
        td.style.fontWeight = "800";
        td.style.textShadow = "none";
        return;
      }

      var t = same ? 1 : ((v - minV) / (maxV - minV)); // escala 0..1 por coluna

      // Verde claro -> verde escuro (por coluna)
      var alpha = 0.14 + (t * 0.72); // 0.14 até 0.86
      td.style.background = "rgba(0, 94, 39, " + alpha.toFixed(3) + ")";

      // Legibilidade
      if (t >= 0.55) {
        td.style.color = "#ffffff";
        td.style.fontWeight = "900";
        td.style.textShadow = "0 1px 1px rgba(0,0,0,0.20)";
      } else {
        td.style.color = "#052e16";
        td.style.fontWeight = "900";
        td.style.textShadow = "none";
      }
    });
  }
}

function vektorAnaliseGastosEstabPivotBuildExportMatrix_(){
  var view = window.__analiseGastosEstabPivotStateCurrentView || null;
  if (!view || !Array.isArray(view.months) || !Array.isArray(view.rows)) return null;

  function ymToMMYYYY_(ym){
    if (!/^\d{4}-\d{2}$/.test(String(ym || ""))) return String(ym || "");
    return String(ym).slice(5,7) + "/" + String(ym).slice(0,4);
  }

  var months = view.months.slice();

  var header = ["Estabelecimento"].concat(
    months.map(function(ym){ return ymToMMYYYY_(ym); })
  ).concat(["Total"]);

  var body = view.rows.map(function(r){
    var row = [String(r.estabelecimento || "")];
    months.forEach(function(ym){
      row.push(Number((r.byMonth && r.byMonth[ym]) || 0) || 0);
    });
    row.push(Number(r.total || 0) || 0);
    return row;
  });

  var totalRow = ["Total geral"].concat(
    months.map(function(ym){ return Number(view.colTotals && view.colTotals[ym] || 0) || 0; })
  ).concat([Number(view.grandTotal || 0) || 0]);

  return {
    header: header,
    rows: body,
    footer: totalRow,
    matrix: [header].concat(body).concat([totalRow])
  };
}

function vektorAnaliseGastosEstabPivotExportCsv_(){
  var data = vektorAnaliseGastosEstabPivotBuildExportMatrix_();
  if (!data) {
    alert("Não há dados para exportar.");
    return;
  }

  // CSV com separador ; (melhor para Excel pt-BR)
  var lines = data.matrix.map(function(row){
    return row.map(function(cell, idx){
      if (idx === 0) {
        // texto
        var s = String(cell == null ? "" : cell);
        s = s.replace(/"/g, '""');
        return '"' + s + '"';
      }
      // número
      var n = Number(cell || 0) || 0;
      // exporta como número com ponto decimal (Excel interpreta corretamente)
      return String(n);
    }).join(";");
  });

  // BOM UTF-8 para acentuação no Excel
  var csvContent = "\uFEFF" + lines.join("\r\n");
  var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

  var now = new Date();
  var fn = "analise_gastos_estabelecimentos_pivot_" +
    now.getFullYear() +
    String(now.getMonth()+1).padStart(2,"0") +
    String(now.getDate()).padStart(2,"0") + "_" +
    String(now.getHours()).padStart(2,"0") +
    String(now.getMinutes()).padStart(2,"0") + ".csv";

  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = fn;
  document.body.appendChild(a);
  a.click();
  setTimeout(function(){
    try { document.body.removeChild(a); } catch(_) {}
    try { URL.revokeObjectURL(url); } catch(_) {}
  }, 120);
}

/* =========================================================
   ANÁLISE DE GASTOS — NOVOS FILTROS (ANO/MÊS) + MACRO VISÕES
   Inserido após vektorAnaliseGastosRender_()
========================================================= */

window.__analiseGastosMacroChartLojas = null;
window.__analiseGastosMacroChartCategorias = null;

function vektorAnaliseGastosMonthLabelPt_(mes){
  var m = String(mes || "").padStart(2, "0");
  var map = {
    "01":"Janeiro","02":"Fevereiro","03":"Março","04":"Abril","05":"Maio","06":"Junho",
    "07":"Julho","08":"Agosto","09":"Setembro","10":"Outubro","11":"Novembro","12":"Dezembro"
  };
  return map[m] || m;
}

function vektorAnaliseGastosHydrateAnoMes_(meta){
  meta = meta || {};
  var selAno = document.getElementById("analiseGastos_selAno");
  var selMes = document.getElementById("analiseGastos_selMes");
  if (!selAno || !selMes) return;

  var anos = Array.isArray(meta.anos) ? meta.anos : [];
  var mesesPorAno = meta.mesesPorAno || {};

  // guarda meta local para rebuild
  window.__analiseGastosAnoMesMeta = {
    anos: anos.slice(),
    mesesPorAno: mesesPorAno
  };

  var anoAtual = String(selAno.value || "");
  selAno.innerHTML = `<option value="">Todos</option>` + anos
    .map(function(a){ return `<option value="${vektorSafe_(a)}">${vektorSafe_(a)}</option>`; })
    .join("");

  if (anoAtual && anos.indexOf(anoAtual) >= 0) selAno.value = anoAtual;

  vektorAnaliseGastosRebuildMesByAno_();
  vektorAnaliseGastosSyncPeriodoByAnoMes_();
}

function vektorAnaliseGastosRebuildMesByAno_(){
  var selAno = document.getElementById("analiseGastos_selAno");
  var selMes = document.getElementById("analiseGastos_selMes");
  if (!selAno || !selMes) return;

  var meta = window.__analiseGastosAnoMesMeta || {};
  var mesesPorAno = meta.mesesPorAno || {};
  var ano = String(selAno.value || "");
  var mesAtual = String(selMes.value || "");

  var meses = [];
  if (ano) {
    meses = Array.isArray(mesesPorAno[ano]) ? mesesPorAno[ano] : [];
  } else {
    // sem ano: união de todos os meses existentes
    var union = {};
    Object.keys(mesesPorAno).forEach(function(a){
      (mesesPorAno[a] || []).forEach(function(m){ union[String(m)] = true; });
    });
    meses = Object.keys(union).sort(function(a,b){ return Number(a) - Number(b); });
  }

  selMes.innerHTML = `<option value="">Todos</option>` + meses.map(function(m){
    return `<option value="${vektorSafe_(m)}">${vektorSafe_(vektorAnaliseGastosMonthLabelPt_(m))}</option>`;
  }).join("");

  if (mesAtual && meses.indexOf(mesAtual) >= 0) {
    selMes.value = mesAtual;
  } else {
    selMes.value = "";
  }
}

function vektorAnaliseGastosGetMonthBounds_(ano, mes){
  ano = String(ano || "").trim();
  mes = String(mes || "").trim();
  if (!ano || !mes) return null;

  var y = Number(ano);
  var m = Number(mes);
  if (!y || !m) return null;

  var lastDay = new Date(y, m, 0).getDate(); // mês é 1..12 aqui
  var ini = ano + "-" + String(m).padStart(2,"0") + "-01";
  var fim = ano + "-" + String(m).padStart(2,"0") + "-" + String(lastDay).padStart(2,"0");
  return { ini: ini, fim: fim };
}

function vektorAnaliseGastosGetYearBounds_(ano){
  ano = String(ano || "").trim();
  if (!/^\d{4}$/.test(ano)) return null;
  return { ini: ano + "-01-01", fim: ano + "-12-31" };
}

function vektorAnaliseGastosClampDateInputs_(){
  var selAno = document.getElementById("analiseGastos_selAno");
  var selMes = document.getElementById("analiseGastos_selMes");
  var dtIniEl = document.getElementById("analiseGastos_dtIni");
  var dtFimEl = document.getElementById("analiseGastos_dtFim");
  if (!dtIniEl || !dtFimEl) return;

  var ano = String(selAno && selAno.value || "");
  var mes = String(selMes && selMes.value || "");

  var bounds = null;
  if (ano && mes) bounds = vektorAnaliseGastosGetMonthBounds_(ano, mes);
  else if (ano) bounds = vektorAnaliseGastosGetYearBounds_(ano);

  if (!bounds) {
    dtIniEl.min = "";
    dtIniEl.max = "";
    dtFimEl.min = "";
    dtFimEl.max = "";
    return;
  }

  dtIniEl.min = bounds.ini;
  dtIniEl.max = bounds.fim;
  dtFimEl.min = bounds.ini;
  dtFimEl.max = bounds.fim;

  if (dtIniEl.value && dtIniEl.value < bounds.ini) dtIniEl.value = bounds.ini;
  if (dtIniEl.value && dtIniEl.value > bounds.fim) dtIniEl.value = bounds.fim;
  if (dtFimEl.value && dtFimEl.value < bounds.ini) dtFimEl.value = bounds.ini;
  if (dtFimEl.value && dtFimEl.value > bounds.fim) dtFimEl.value = bounds.fim;

  if (dtIniEl.value && dtFimEl.value && dtIniEl.value > dtFimEl.value) {
    // mantém coerência sem “quebrar” input
    dtFimEl.value = dtIniEl.value;
  }
}

function vektorAnaliseGastosSyncPeriodoByAnoMes_(){
  var selAno = document.getElementById("analiseGastos_selAno");
  var selMes = document.getElementById("analiseGastos_selMes");
  var dtIniEl = document.getElementById("analiseGastos_dtIni");
  var dtFimEl = document.getElementById("analiseGastos_dtFim");
  if (!dtIniEl || !dtFimEl) return;

  var ano = String(selAno && selAno.value || "");
  var mes = String(selMes && selMes.value || "");

  // Regras:
  // - sem ano/mes => datas livres (comportamento atual)
  // - ano selecionado => restringe datas ao ano
  // - ano+mês => restringe datas ao mês e força período daquele mês se vazio/fora do range
  if (!ano && !mes) {
    vektorAnaliseGastosClampDateInputs_();
    return;
  }

  // Se o usuário selecionou mês sem ano, inferimos pelo ano do dtIni se existir; se não, limpa mês (inconsistente)
  if (!ano && mes) {
    var anoInferido = "";
    if (dtIniEl.value && /^\d{4}-\d{2}-\d{2}$/.test(dtIniEl.value)) {
      anoInferido = dtIniEl.value.slice(0,4);
      if (selAno) selAno.value = anoInferido;
      ano = anoInferido;
      try { vektorAnaliseGastosRebuildMesByAno_(); } catch(_) {}
      if (selMes) selMes.value = mes;
    } else {
      if (selMes) selMes.value = "";
      mes = "";
    }
  }

  var bounds = (ano && mes)
    ? vektorAnaliseGastosGetMonthBounds_(ano, mes)
    : (ano ? vektorAnaliseGastosGetYearBounds_(ano) : null);

  if (!bounds) {
    vektorAnaliseGastosClampDateInputs_();
    return;
  }

  vektorAnaliseGastosClampDateInputs_();

  // Se mês selecionado, o período deve ficar dentro do mês selecionado
  if (ano && mes) {
    if (!dtIniEl.value || dtIniEl.value < bounds.ini || dtIniEl.value > bounds.fim) dtIniEl.value = bounds.ini;
    if (!dtFimEl.value || dtFimEl.value < bounds.ini || dtFimEl.value > bounds.fim) dtFimEl.value = bounds.fim;
    if (dtIniEl.value > dtFimEl.value) dtFimEl.value = dtIniEl.value;
    return;
  }

  // Se só ano selecionado, restringe mas não obriga preencher (se já houver datas, corrige)
  if (ano && !mes) {
    if (dtIniEl.value && (dtIniEl.value < bounds.ini || dtIniEl.value > bounds.fim)) dtIniEl.value = bounds.ini;
    if (dtFimEl.value && (dtFimEl.value < bounds.ini || dtFimEl.value > bounds.fim)) dtFimEl.value = bounds.fim;
    if (dtIniEl.value && dtFimEl.value && dtIniEl.value > dtFimEl.value) dtFimEl.value = dtIniEl.value;
  }
}

/* =========================
   MACRO VISÕES (MODAL)
========================= */

function vektorAnaliseGastosMacroHydrateFilters_(meta){
  meta = meta || {};
  var selAno  = document.getElementById("analiseGastos_macro_selAno");
  var selLoja = document.getElementById("analiseGastos_macro_selLoja");
  var selCat  = document.getElementById("analiseGastos_macro_selCategoria");
  if (!selLoja || !selCat) return;

  // Loja/Categoria
  vektorBuildOptions_(selLoja, (meta.lojas || []), "Todas");
  vektorBuildOptions_(selCat,  (meta.categorias || []), "Todas");

  // Ano (macro) — usa anos retornados pelo getAnaliseGastosMeta()
  if (selAno) {
    var anos = Array.isArray(meta.anos) ? meta.anos.slice() : [];
    var atual = String(selAno.value || "");

    // ordem desc no modal (mais recente primeiro)
    anos.sort(function(a,b){ return Number(b) - Number(a); });

    selAno.innerHTML =
      `<option value="">Último ano</option>` +
      anos.map(function(a){
        return `<option value="${vektorSafe_(a)}">${vektorSafe_(a)}</option>`;
      }).join("");

    if (atual && anos.indexOf(atual) >= 0) selAno.value = atual;
  }
}

function vektorAnaliseGastosOpenMacroModal_(){
  var m = document.getElementById("analiseGastos_macroModal");
  if (!m) return;

  m.classList.remove("hidden");
  m.style.display = "block";

  // ✅ só carrega se ainda não houver resultado anterior
  // (evita “carregamento” desnecessário ao reabrir)
  if (!window.__analiseGastosMacroLastRes && !window.__analiseGastosMacroLoading) {
    vektorAnaliseGastosMacroLoad_();
  } else {
    // garante overlay desligado ao reabrir
    try { vektorAnaliseGastosMacroSetLoading_(false); } catch(_) {}
  }
}

function vektorAnaliseGastosCloseMacroModal_(){
  var m = document.getElementById("analiseGastos_macroModal");
  if (!m) return;

  m.classList.add("hidden");
  m.style.display = "none";
}

function vektorAnaliseGastosMacroSetLoading_(on){
  var el = document.getElementById("analiseGastos_macro_loading");
  if (!el) return;
  window.__analiseGastosMacroLoading = !!on;
  if (on) {
    el.classList.remove("hidden");
    el.style.display = "block";
  } else {
    el.classList.add("hidden");
    el.style.display = "none";
  }
}

function vektorAnaliseGastosMacroLoad_(){
  var selLoja = document.getElementById("analiseGastos_macro_selLoja");
  var selCat  = document.getElementById("analiseGastos_macro_selCategoria");
  var selAno = document.getElementById("analiseGastos_macro_selAno");
  var ano = String(selAno && selAno.value || "");
  var loja = String(selLoja && selLoja.value || "");
  var categoria = String(selCat && selCat.value || "");

  vektorAnaliseGastosMacroSetLoading_(true);

  google.script.run
    .withSuccessHandler(function(res){
      vektorAnaliseGastosMacroSetLoading_(false);

      if (!res || !res.ok) {
        vektorAnaliseGastosMacroRenderEmpty_("Falha: " + vektorSafe_(res && res.error ? res.error : "erro desconhecido"));
        return;
      }

      // ✅ cache do último resultado para não recarregar ao reabrir modal
      window.__analiseGastosMacroLastRes = res;

      var hintL = document.getElementById("analiseGastos_macro_hintLojas");
      var hintC = document.getElementById("analiseGastos_macro_hintCategorias");
      var hintTopL = document.getElementById("analiseGastos_macro_hintTopLojas");
      var hintTopC = document.getElementById("analiseGastos_macro_hintTopCategorias");

      if (hintL) {
        hintL.textContent = loja
          ? ("Recorte aplicado na visão de Lojas: Loja " + loja)
          : "Acumulado mensal de todas as lojas";
      }
      if (hintC) {
        hintC.textContent = categoria
          ? ("Recorte aplicado na visão de Categorias: " + categoria)
          : "Acumulado mensal de todas as categorias";
      }
      if (hintTopL) {
        hintTopL.textContent =
          "Ranking por somatória no período (Top 10)";
      }
      if (hintTopC) {
        hintTopC.textContent =
          "Ranking por somatória no período (Top 10)";
      }

      vektorAnaliseGastosMacroRenderChart_(
        "analiseGastos_macro_chartLojas",
        res.serieLojas || { labels: [], totais: [], variacoesPct: [] },
        "__analiseGastosMacroChartLojas"
      );

      vektorAnaliseGastosMacroRenderTop10Chart_(
        "analiseGastos_macro_chartTopLojas",
        res.top10Lojas || { labels: [], totais: [] },
        "__analiseGastosMacroChartTopLojas",
        "Lojas"
      );

      vektorAnaliseGastosMacroRenderTop10Chart_(
        "analiseGastos_macro_chartTopCategorias",
        res.top10Categorias || { labels: [], totais: [] },
        "__analiseGastosMacroChartTopCategorias",
        "Categorias"
      );

      vektorAnaliseGastosMacroRenderChart_(
        "analiseGastos_macro_chartCategorias",
        res.serieCategorias || { labels: [], totais: [], variacoesPct: [] },
        "__analiseGastosMacroChartCategorias"
      );
    })
    .withFailureHandler(function(err){
      vektorAnaliseGastosMacroSetLoading_(false);
      vektorAnaliseGastosMacroRenderEmpty_("Falha: " + vektorSafe_(err && err.message ? err.message : err));
    })
    .getAnaliseGastosMacroVisoesDataset({
      ano: ano,
      loja: loja,
      categoria: categoria
    });
}

function vektorAnaliseGastosMacroRenderEmpty_(msg){
  msg = String(msg || "Sem dados.");
  var hL = document.getElementById("analiseGastos_macro_hintLojas");
  var hC = document.getElementById("analiseGastos_macro_hintCategorias");
  var hTopL = document.getElementById("analiseGastos_macro_hintTopLojas");
  var hTopC = document.getElementById("analiseGastos_macro_hintTopCategorias");

  if (hL) hL.textContent = msg;
  if (hC) hC.textContent = msg;
  if (hTopL) hTopL.textContent = msg;
  if (hTopC) hTopC.textContent = msg;

  try {
    if (window.__analiseGastosMacroChartLojas) {
      window.__analiseGastosMacroChartLojas.destroy();
      window.__analiseGastosMacroChartLojas = null;
    }
  } catch(_) {}
  try {
    if (window.__analiseGastosMacroChartCategorias) {
      window.__analiseGastosMacroChartCategorias.destroy();
      window.__analiseGastosMacroChartCategorias = null;
    }
  } catch(_) {}
  try {
  if (window.__analiseGastosMacroChartTopLojas) {
    window.__analiseGastosMacroChartTopLojas.destroy();
    window.__analiseGastosMacroChartTopLojas = null;
  }
} catch(_) {}

try {
  if (window.__analiseGastosMacroChartTopCategorias) {
    window.__analiseGastosMacroChartTopCategorias.destroy();
    window.__analiseGastosMacroChartTopCategorias = null;
  }
} catch(_) {}
}

function vektorAnaliseGastosMacroRenderChart_(canvasId, serie, chartRefName){
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;

  var labels = Array.isArray(serie && serie.labels) ? serie.labels : [];
  var totais = Array.isArray(serie && serie.totais) ? serie.totais : [];
  var varsPct = Array.isArray(serie && serie.variacoesPct) ? serie.variacoesPct : [];

  try {
    if (window[chartRefName]) {
      window[chartRefName].destroy();
      window[chartRefName] = null;
    }
  } catch(_) {}

  if (!labels.length) return;

  var ctx = canvas.getContext("2d");

  function fmtCompactK_(n){
    n = Number(n || 0) || 0;
    var abs = Math.abs(n);
    if (abs >= 1000000) return Math.round(n / 1000000) + "M";
    if (abs >= 1000)    return Math.round(n / 1000) + "k";
    return String(Math.round(n));
  }

  // ✅ Igual ao "Valores contabilizados": rótulo no centro EXATO da barra (dataset 0)
  var vektorMacroBarCenterLabelsPlugin = {
    id: "vektorMacroBarCenterLabels",
    afterDatasetsDraw: function(chart, args, pluginOptions) {
      var dsIndex = 0; // barras = dataset 0
      var meta = chart.getDatasetMeta(dsIndex);
      if (!meta || meta.hidden) return;

      var data = (chart.data.datasets[dsIndex] && chart.data.datasets[dsIndex].data) || [];
      var c = chart.ctx;

      c.save();
      c.fillStyle = (pluginOptions && pluginOptions.color) ? pluginOptions.color : "#ffffff";
      c.textAlign = "center";
      c.textBaseline = "middle";

      var fontSize = (pluginOptions && pluginOptions.fontSize) ? pluginOptions.fontSize : 10;
      var fontWeight = (pluginOptions && pluginOptions.fontWeight) ? pluginOptions.fontWeight : "900";
      c.font = fontWeight + " " + fontSize + "px Arial";

      for (var i = 0; i < meta.data.length; i++) {
        var el = meta.data[i];
        if (!el) continue;

        var v = Number(data[i] || 0) || 0;
        if (!v) continue;
        if (Math.abs(v) < 1000) continue; // evita poluição em barras pequenas

        // ✅ centro geométrico da barra vertical
        var x = el.x;
        var yTop = el.y;
        var yBase = el.base;
        var y = yTop + (yBase - yTop) / 2;

        c.fillText(fmtCompactK_(v), x, y);
      }

      c.restore();
    }
  };

  window[chartRefName] = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          type: "bar",
          label: "Total (R$)",
          data: totais,
          backgroundColor: "rgba(255,255,255,0.22)",
          borderColor: "rgba(255,255,255,0.55)",
          borderWidth: 1,
          barPercentage: 0.8,
          categoryPercentage: 0.9,
          order: 1
        },
        {
          type: "line",
          label: "Variação mensal (%)",
          data: varsPct,
          yAxisID: "y2",
          tension: 0.22,
          fill: false,
          borderColor: "#38bdf8",
          borderWidth: 2,
          borderDash: [7, 5],
          pointRadius: 3,
          pointHoverRadius: 4,
          order: 2,
          datalabels: { display: false }
        }
      ]
    },
    plugins: [
      ChartDataLabels,               // mantém compatibilidade do projeto
      vektorMacroBarCenterLabelsPlugin // ✅ rótulo central real
    ],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      animation: { duration: 700, easing: "easeOutQuart" },

      plugins: {
        legend: {
          labels: { color: "rgba(255,255,255,0.85)", font: { weight: "800" } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx){
              var v = Number(ctx.raw || 0) || 0;
              if (ctx.datasetIndex === 0) return ctx.dataset.label + ": " + vektorFmtBRL_(v);
              return ctx.dataset.label + ": " + v.toFixed(1).replace(".", ",") + "%";
            }
          }
        },

        // ✅ desliga datalabels (rótulo agora é pelo plugin custom)
        datalabels: {
          display: false
        },

        // ✅ opções do plugin custom (nome = id do plugin)
        vektorMacroBarCenterLabels: {
          color: "#ffffff",
          fontSize: 10,
          fontWeight: "900"
        }
      },

      scales: {
        x: {
          ticks: { color: "rgba(255,255,255,0.85)" },
          grid: { color: "rgba(148,163,184,0.14)" }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: "rgba(255,255,255,0.85)",
            callback: function(v){
              var n = Number(v || 0) || 0;
              if (Math.abs(n) >= 1000000) return (n / 1000000).toFixed(0) + "M";
              if (Math.abs(n) >= 1000) return Math.round(n / 1000) + "k";
              return n;
            }
          },
          grid: { color: "rgba(148,163,184,0.18)" }
        },
        y2: {
          position: "right",
          ticks: {
            color: "rgba(56,189,248,0.95)",
            callback: function(v){
              var n = Number(v || 0) || 0;
              return n.toFixed(0) + "%";
            }
          },
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function vektorAnaliseGastosMacroRenderTop10Chart_(canvasId, serie, chartRefName, tipoLabel){
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;

  var labels = Array.isArray(serie && serie.labels) ? serie.labels.slice() : [];
  var totais = Array.isArray(serie && serie.totais) ? serie.totais.slice() : [];

  try {
    if (window[chartRefName]) {
      window[chartRefName].destroy();
      window[chartRefName] = null;
    }
  } catch(_) {}

  if (!labels.length) return;

  var ctx = canvas.getContext("2d");

  function fmtCompactK_(n){
    n = Number(n || 0) || 0;
    var abs = Math.abs(n);
    if (abs >= 1000000) return Math.round(n / 1000000) + "M";
    if (abs >= 1000)    return Math.round(n / 1000) + "k";
    return String(Math.round(n));
  }

  // ✅ plugin custom: desenha nome (loja/categoria) no centro da barra horizontal
  var vektorMacroTop10BarLabelsPlugin = {
    id: "vektorMacroTop10BarLabels",
    afterDatasetsDraw: function(chart, args, pluginOptions) {
      var dsIndex = 0;
      var meta = chart.getDatasetMeta(dsIndex);
      if (!meta || meta.hidden) return;

      var c = chart.ctx;
      var ds = chart.data.datasets[dsIndex];
      var textLabels = (chart.data && chart.data.labels) ? chart.data.labels : [];

      c.save();
      c.fillStyle = (pluginOptions && pluginOptions.color) ? pluginOptions.color : "#ffffff";
      c.textAlign = "center";
      c.textBaseline = "middle";

      var fontSize = (pluginOptions && pluginOptions.fontSize) ? pluginOptions.fontSize : 10;
      var fontWeight = (pluginOptions && pluginOptions.fontWeight) ? pluginOptions.fontWeight : "900";
      c.font = fontWeight + " " + fontSize + "px Arial";

      for (var i = 0; i < meta.data.length; i++) {
        var el = meta.data[i];
        if (!el) continue;

        var v = Number(ds.data[i] || 0) || 0;
        if (!v) continue;

        var label = String(textLabels[i] || "");
        if (!label) continue;

        // centro geométrico da barra horizontal
        var xCenter = el.base + (el.x - el.base) / 2;
        var yCenter = el.y;

        // largura visual da barra em pixels
        var barW = Math.abs(el.x - el.base);

        // texto (truncado para não poluir)
        var txt = label.length > 30 ? (label.slice(0, 30) + "…") : label;

        // mede largura do texto para decidir se cabe dentro
        var textW = c.measureText(txt).width;
        var paddingInside = 14; // margem interna
        var xMax = chart.chartArea ? chart.chartArea.right : el.x + 200;

        // Se couber dentro da barra -> centro (branco)
        // Se não couber -> desenha à frente da barra (à direita), alinhado à esquerda
        if (barW >= (textW + paddingInside)) {
          c.textAlign = "center";
          c.fillStyle = (pluginOptions && pluginOptions.colorInside) ? pluginOptions.colorInside : "#ffffff";
          c.fillText(txt, xCenter, yCenter);
        } else {
          var xOutside = el.x + 8;
          // evita sair da área do gráfico
          if (xOutside + textW > xMax) {
            xOutside = Math.max(el.base + 4, xMax - textW - 2);
          }

          c.textAlign = "left";
          c.fillStyle = (pluginOptions && pluginOptions.colorOutside) ? pluginOptions.colorOutside : "rgba(255,255,255,0.92)";
          c.fillText(txt, xOutside, yCenter);
        }
      }

      c.restore();
    }
  };

  window[chartRefName] = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Total (R$)",
          data: totais,
          backgroundColor: "#005E27",
          borderColor: "#B5FF20",
          borderWidth: 2,
          borderRadius: 6,
          barPercentage: 0.92,
          categoryPercentage: 0.92
        }
      ]
    },
    plugins: [ChartDataLabels, vektorMacroTop10BarLabelsPlugin],
    options: {
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 600, easing: "easeOutQuart" },

      plugins: {
        legend: { display: false },

        tooltip: {
          callbacks: {
            title: function(items){
              if (!items || !items.length) return "";
              return String(items[0].label || "");
            },
            label: function(ctx){
              var v = Number(ctx.raw || 0) || 0;
              return "Total: " + vektorFmtBRL_(v);
            }
          }
        },

        datalabels: { display: false },

        vektorMacroTop10BarLabels: {
          color: "#ffffff",
          fontSize: 10,
          fontWeight: "900"
        }
      },

      scales: {
        y: {
          ticks: {
            // ✅ nomes já vão dentro das barras, então eixo Y pode ficar discreto/oculto
            display: false,
            color: "rgba(255,255,255,0.75)"
          },
          grid: { display: false }
        },
        x: {
          beginAtZero: true,
          ticks: {
            color: "rgba(255,255,255,0.85)",
            callback: function(v){
              var n = Number(v || 0) || 0;
              if (Math.abs(n) >= 1000000) return Math.round(n / 1000000) + "M";
              if (Math.abs(n) >= 1000) return Math.round(n / 1000) + "k";
              return Math.round(n);
            }
          },
          grid: { color: "rgba(148,163,184,0.14)" }
        }
      }
    }
  });
}

// estado local da página
window.__envPend = {
  periodo: { iniIso: "", fimIso: "" },
  rows: [],        // preview detalhado
  selected: {},    // txKey -> true/false
  resumo: null
};

window.vektorEnvioPendenciasAbrirModal = function () {
  const m = document.getElementById("envPendModal");
  if (!m) return;

  // ✅ desfaz o "display:none" que a view aplica
  m.classList.remove("hidden");
  m.style.display = "block";
};

window.vektorEnvioPendenciasFecharModal = function () {
  const m = document.getElementById("envPendModal");
  if (!m) return;

  m.classList.add("hidden");
  m.style.display = "none";
};

window.vektorEnvPendSelectAll = function (on) {
  (window.__envPend.rows || []).forEach(r => {
    if (r.jaEnviado) return; // não deixa marcar linhas já enviadas
    window.__envPend.selected[r.txKey] = !!on;
  });
  window.__renderEnvPendTbody();
};

window.vektorEnvPendExportCsv = function () {
  try {
    var rows = (window.__envPend && Array.isArray(window.__envPend.rows)) ? window.__envPend.rows : [];

    // CSV pt-BR: separador ;
    function esc(v) {
      var s = (v === null || v === undefined) ? "" : String(v);
      s = s.replace(/"/g, '""');
      return '"' + s + '"';
    }

    var header = ["Loja", "Data Transação", "Estabelecimento", "Valor", "Cartão", "Pendências", "Já enviado?"];
    var lines = [];
    lines.push(header.map(esc).join(";"));

    rows.forEach(function (r) {
      lines.push([
        r.lojaKey || "",
        r.dataTransBR || "",
        r.estabelecimento || "",
        r.valorOriginalTxt || "",
        r.cartao || "",
        r.pendenciasTxt || "",
        (r.jaEnviado ? "SIM" : "NÃO")
      ].map(esc).join(";"));
    });

    var csv = lines.join("\n");

    // nome do arquivo com período (quando existir)
    var ini = (window.__envPend && window.__envPend.periodo && window.__envPend.periodo.iniIso) ? String(window.__envPend.periodo.iniIso).slice(0, 10) : "ini";
    var fim = (window.__envPend && window.__envPend.periodo && window.__envPend.periodo.fimIso) ? String(window.__envPend.periodo.fimIso).slice(0, 10) : "fim";
    var filename = "Vektor_Pendencias_" + ini + "_" + fim + ".csv";

    var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    var url = URL.createObjectURL(blob);

    var a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    setTimeout(function () {
      try { URL.revokeObjectURL(url); } catch (_) {}
      try { document.body.removeChild(a); } catch (_) {}
    }, 0);

  } catch (e) {
    console.error("Falha ao exportar CSV (Envio de Pendências):", e);
    if (window.vektorEnvPendToast_) {
      window.vektorEnvPendToast_("Falha ao exportar CSV.", "error");
    }
  }
};

window.__renderEnvPendTbody = function () {
  const tb = document.getElementById("envPend_tbody");
  if (!tb) return;
  const rows = window.__envPend.rows || [];
  tb.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.style.borderBottom = "1px solid rgba(148,163,184,0.15)";

    const checked = !!window.__envPend.selected[r.txKey];
    const disabled = !!r.jaEnviado;

    tr.innerHTML =
      `<td style="padding:8px;">
        <input type="checkbox" ${checked ? "checked" : ""} ${disabled ? "disabled" : ""}
          onchange="window.__envPend.selected['${r.txKey}']=this.checked" />
      </td>
      <td style="padding:8px; white-space:nowrap;">${r.lojaKey || ""}</td>
      <td style="padding:8px; white-space:nowrap;">${r.dataTransBR || ""}</td>
      <td style="padding:8px;">${(r.estabelecimento || "").replace(/</g,"&lt;")}</td>
      <td style="padding:8px; white-space:nowrap;">${r.valorOriginalTxt || ""}</td>
      <td style="padding:8px; white-space:nowrap;">${r.cartao || ""}</td>
      <td style="padding:8px;"><b>${r.pendenciasTxt || ""}</b></td>
      <td style="padding:8px; white-space:nowrap; color:${r.jaEnviado ? "rgba(34,197,94,0.95)" : "rgba(226,232,240,0.7)"};">
        ${r.jaEnviado ? "SIM" : "NÃO"}
      </td>`;

    tb.appendChild(tr);
  });
};

window.vektorGlobalLoadingShow_ = function(titulo, subtitulo) {
  const ov = document.getElementById("envPend_overlay");

  // ✅ IDs corretos do overlay existente (os mesmos do Envio de Pendências)
  const t = document.getElementById("envPend_overlayTitle") || document.getElementById("envPend_overlay_title");
  const s = document.getElementById("envPend_overlaySub")   || document.getElementById("envPend_overlay_sub");

  if (t) t.textContent = titulo || "Carregando…";
  if (s) s.textContent = subtitulo || "Aguarde.";

  // ✅ o overlay do HTML foi criado com display:block (não flex)
  if (ov) ov.style.display = "block";
};

window.vektorGlobalLoadingHide_ = function() {
  const ov = document.getElementById("envPend_overlay");
  if (ov) ov.style.display = "none";
};

window.vektorEnvPendOverlayShow_ = function(title, sub){
  const ov = document.getElementById("envPend_overlay");
  const t  = document.getElementById("envPend_overlayTitle");
  const s  = document.getElementById("envPend_overlaySub");
  if (t) t.textContent = String(title || "Carregando…");
  if (s) s.textContent = String(sub || "Aguarde um instante.");
  if (ov) ov.style.display = "block";
};

window.vektorEnvPendOverlayHide_ = function(){
  const ov = document.getElementById("envPend_overlay");
  if (ov) ov.style.display = "none";
};

window.vektorEnvPendLojasPopupClose_ = function(){
  const pop = document.getElementById("envPendLojasPopup");
  if (pop) pop.style.display = "none";

  // destrói chart anterior (evita “duplicar” canvas / memory leak)
  try {
    if (window.__envPend && window.__envPend.__lojasChart) {
      window.__envPend.__lojasChart.destroy();
      window.__envPend.__lojasChart = null;
    }
  } catch(_) {}
};

window.vektorEnvPendRenderLojasChart_ = function () {
  const canvas = document.getElementById("envPendLojasChart");
  if (!canvas) return;

  const resumo = (window.__envPend && window.__envPend.resumo) ? window.__envPend.resumo : {};
  const arr = Array.isArray(resumo.lojasValor) ? resumo.lojasValor : [];

  // ✅ filtro por Time (usa arr com {lojaKey, valor, time})
  const sel = document.getElementById("envPendLojasTimeFilter");

  // popula opções 1x (ou quando mudar o conjunto)
  try {
    if (sel && !sel.__filled) {
      const times = Array.from(
        new Set(arr.map(x => String(x.time || "—").trim()).filter(Boolean))
      ).sort((a, b) => a.localeCompare(b));

      // mantém primeira opção "Todos" e repopula
      sel.innerHTML =
        "<option value=''>Todos</option>" +
        times.map(t => `<option value="${t.replace(/"/g, "&quot;")}">${t}</option>`).join("");

      sel.__filled = true;

      // onchange -> redesenha
      sel.onchange = function () {
        window.vektorEnvPendRenderLojasChart_();
      };
    }
  } catch (_) {}

  const timeSel = (sel && typeof sel.value === "string") ? sel.value : "";
  const arrFiltrado = timeSel ? arr.filter(x => String(x.time || "—").trim() === timeSel) : arr;

  // labels e valores
  const labels = arrFiltrado.map(x => String(x.lojaKey || ""));
  const values = arrFiltrado.map(x => Number(x.valor || 0));
  const maxV = values.reduce((m, v) => Math.max(m, Number(v) || 0), 0);
  const suggestedMaxX = maxV ? (maxV * 1.12) : 0; // 12% de folga pro rótulo caber

  // altura dinâmica (para permitir MUITAS lojas com scroll)
  const rowH = 22; // “grossura” por barra
  const topPad = 14;
  const minH = 260;
  const desiredH = topPad + labels.length * rowH;
  canvas.height = Math.max(minH, desiredH);

  // formata BRL
  const fmtBRL = (n) => (Number(n) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  // destroy antigo
  try {
    if (window.__envPend && window.__envPend.__lojasChart) {
      window.__envPend.__lojasChart.destroy();
      window.__envPend.__lojasChart = null;
    }
  } catch (_) {}

  const ctx = canvas.getContext("2d");

  // Chart.js + DataLabels
  try {
    if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
      Chart.register(ChartDataLabels);
    }
  } catch (_) {}

  window.__envPend.__lojasChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Valor pendente (R$)",
        data: values,
        backgroundColor: "#005E27",
        borderRadius: 10,
        categoryPercentage: 0.75,
        barPercentage: 0.85
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y",

      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              return " " + fmtBRL(context.parsed.x);
            }
          }
        },
        datalabels: {
          color: "#0f172a",
          anchor: "end",
          align: "right",
          clamp: true,
          clip: false,
          formatter: function (v) { return fmtBRL(v); },
          font: { weight: "700", size: 11 }
        }
      }, // ✅ vírgula correta aqui (fecha plugins)

      layout: { padding: { right: 120, left: 10, top: 10, bottom: 10 } },

      scales: {
        x: {
          suggestedMax: suggestedMaxX,
          ticks: {
            callback: function (v) { return fmtBRL(v); }
          }
        },
        y: {
          ticks: { autoSkip: false }
        }
      }
    }
  });
};

window.vektorEnvPendLojasPopupOpen_ = function(){
  const pop = document.getElementById("envPendLojasPopup");
  if (!pop) return;

  const sub = document.getElementById("envPendLojasPopupSub");
  const periodo = (window.__envPend && window.__envPend.resumo && window.__envPend.resumo.periodo) ? window.__envPend.resumo.periodo : null;
  if (sub) {
    sub.textContent = periodo ? (`Período: ${periodo.inicio || ""} → ${periodo.fim || ""}`) : "";
  }

  pop.style.display = "block";
    // ✅ reset do filtro a cada abertura (evita ficar “preso” em times antigos)
  const sel = document.getElementById("envPendLojasTimeFilter");
  if (sel) {
    sel.__filled = false; // força repopular
    sel.value = "";
  }
  window.vektorEnvPendRenderLojasChart_();
};

// fecha clicando no “fundo” escuro
document.addEventListener("click", function(ev){
  const pop = document.getElementById("envPendLojasPopup");
  if (!pop || pop.style.display !== "block") return;
  if (ev.target === pop) window.vektorEnvPendLojasPopupClose_();
});

// fecha com ESC
document.addEventListener("keydown", function(ev){
  if (ev.key === "Escape") {
    window.vektorEnvPendLojasPopupClose_();
  }
});

window.vektorEnvioPendenciasPreview = function () {
  try {
    const ini = document.getElementById("envPend_ini")?.value || "";
    const fim = document.getElementById("envPend_fim")?.value || "";
    const st = document.getElementById("envPend_statusText");
    const resumoEl = document.getElementById("envPend_resumo");
    const falhasEl = document.getElementById("envPend_falhas");

    if (falhasEl) falhasEl.innerHTML = "";
    if (!ini || !fim) {
      if (st) st.textContent = "Informe data inicial e final.";
      return;
    }

    // ✅ envie "YYYY-MM-DD" puro (sem ISO/UTC)
    const iniIso = String(ini || "").trim();
    const fimIso = String(fim || "").trim();
    window.__envPend.periodo = { iniIso, fimIso };


    window.vektorEnvPendOverlayShow_("Gerando prévia, aguarde…", "Consultando Transações e preparando os dados.");

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          if (st) st.textContent = "Falha ao gerar prévia.";

          const errTxt =
            (res && (res.error || res.erro || res.message)) ?
              String(res.error || res.erro || res.message) :
              ("Erro desconhecido. Resposta do backend: " + JSON.stringify(res || {}, null, 2));

          if (resumoEl) resumoEl.textContent = errTxt;
          const bx = document.getElementById("envPend_statusCards");
            if (bx) bx.innerHTML = "";

            window.vektorEnvPendOverlayHide_();

          return;
        }

        window.__envPend.rows = res.rows || [];
        window.__envPend.resumo = res.resumo || null;

        // default: marca tudo que NÃO foi enviado ainda
        window.__envPend.selected = {};
        window.__envPend.rows.forEach(r => {
          if (!r.jaEnviado) window.__envPend.selected[r.txKey] = true;
        });

        // resumo
        const R = res.resumo || {};
        const money = (Number(R.totalValor || 0)).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const pct = (x) => ((x || 0) * 100).toFixed(1).replace(".", ",") + "%";

        if (resumoEl) {
          const itens = [
            { key: "NF/Recibo", v: R.pendRecibo || 0, p: R.pctRecibo || 0 },
            { key: "Etiqueta", v: R.pendEtiqueta || 0, p: R.pctEtiqueta || 0 },
            { key: "Descrição", v: R.pendDescricao || 0, p: R.pctDescricao || 0 },
            { key: "NF divergente", v: R.pendDivergNF || 0, p: R.pctDivergNF || 0 },
          ];

          const sumTipos = itens.reduce((a, x) => a + (Number(x.v) || 0), 0) || 1;

          function donutSegs() {
            const r = 54;
            const c = 2 * Math.PI * r;
            let acc = 0;

            return itens.map((it, idx) => {
              const frac = (Number(it.v) || 0) / sumTipos;
              const len = c * frac;
              const dash = `${len} ${c - len}`;
              const offset = -acc;
              acc += len;

              const cor = ["#60a5fa", "#34d399", "#fbbf24", "#f87171"][idx] || "#94a3b8";

              return `
                <circle cx="64" cy="64" r="${r}"
                  fill="transparent"
                  stroke="${cor}"
                  stroke-width="14"
                  stroke-linecap="round"
                  stroke-dasharray="${dash}"
                  stroke-dashoffset="${offset}"
                />`;
            }).join("");
          }

          function bars() {
            return itens.map((it, idx) => {
              const cor = ["#60a5fa", "#34d399", "#fbbf24", "#f87171"][idx] || "#94a3b8";
              const w = Math.min(100, Math.max(0, (Number(it.p) || 0) * 100));
              return `
                <div style="margin-top:10px;">
                  <div style="display:flex; justify-content:space-between; gap:12px; font-size:12px; color:rgba(226,232,240,0.88);">
                    <div style="font-weight:900;">${it.key}</div>
                    <div style="font-weight:900;">${it.v} (${pct(it.p)})</div>
                  </div>
                  <div style="margin-top:6px; height:10px; background:rgba(148,163,184,0.14); border-radius:999px; overflow:hidden;">
                    <div style="height:100%; width:${w}%; background:${cor}; border-radius:999px;"></div>
                  </div>
                </div>`;
            }).join("");
          }

          // ✅ adicionamos um container do gráfico de linha logo abaixo
          resumoEl.innerHTML = `
            <div style="display:grid; grid-template-columns: 1.1fr 1fr; gap:14px; align-items:stretch;">

              <!-- Coluna esquerda: KPIs -->
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Transações elegíveis (Com pendências)</div>
                  <div style="color:#fff; font-size:26px; font-weight:1000; margin-top:6px;">${R.totalTransacoes || 0}</div>
                  <div id="envPend_sp_tx" style="margin-top:10px; height:26px;"></div>
                </div>

                <div id="envPend_card_lojas" style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Lojas</div>
                  <div style="color:#fff; font-size:26px; font-weight:1000; margin-top:6px;">${R.totalLojas || 0}</div>
                  <div id="envPend_sp_lojas" style="margin-top:10px; height:26px;"></div>
                </div>

                <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Valor total (Elegíveis)</div>
                  <div style="color:#fff; font-size:20px; font-weight:1000; margin-top:6px;">${money}</div>
                  <div id="envPend_sp_valor" style="margin-top:10px; height:26px;"></div>
                </div>

                <div style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Já enviadas (bloqueadas)</div>
                  <div style="color:#fff; font-size:26px; font-weight:1000; margin-top:6px;">${R.totalJaEnviadas || 0}</div>
                  <div id="envPend_sp_enviadas" style="margin-top:10px; height:26px;"></div>
                </div>
              </div>

              <!-- Coluna direita: donut + barras -->
              <div id="envPend_card_dist"
                title="Passe o mouse para ver distribuição por loja"
                style="background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px; display:flex; gap:14px; align-items:center;">
                <div style="width:160px; min-width:160px; display:flex; align-items:center; justify-content:center;">
                  <svg width="128" height="128" viewBox="0 0 128 128">
                    <circle cx="64" cy="64" r="54" fill="transparent" stroke="rgba(148,163,184,0.12)" stroke-width="14" />
                    ${donutSegs()}
                  </svg>
                </div>
                <div style="flex:1;">
                  <div style="color:#fff; font-weight:1000; margin-bottom:4px;">Distribuição de pendências</div>
                  <div style="color:rgba(226,232,240,0.7); font-size:12px;">Percentuais por tipo (observação: uma transação pode ter múltiplas pendências).</div>
                  ${bars()}
                </div>
              </div>

            </div>

            <!-- ✅ Gráfico de linha: pendências por data -->
            <div style="margin-top:14px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:16px; padding:14px;">
              <div style="color:#fff; font-weight:1000; margin-bottom:4px;">Evolução de pendências no período</div>
              <div style="color:rgba(226,232,240,0.7); font-size:12px; margin-bottom:10px;">
                Quantidade total de transações pendentes por data
              </div>

              <svg id="envPend_svgLine" width="100%" height="220" viewBox="0 0 800 220" preserveAspectRatio="none"></svg>

            </div>
          `;

            // === bind popup do gráfico no card "Lojas" ===
            try {
              const cardLojas = document.getElementById("envPend_card_lojas");
              if (cardLojas && !cardLojas.__bindGrafico) {
                cardLojas.__bindGrafico = true;
                cardLojas.style.cursor = "pointer";
                cardLojas.title = "Clique para visualizar detalhamento";

                cardLojas.onclick = function () {
                  window.vektorEnvPendLojasPopupOpen_();
                };

              }
            } catch (e) {
              console.error("Erro bind card lojas:", e);
            }

            // === bind hover no donut "Distribuição de pendências" (abre overlay stacked) ===
              try {
                const dist = document.getElementById("envPend_card_dist");
                const overlay = document.getElementById("envPend_distOverlay");
                const overlayBg = document.getElementById("envPend_distOverlayBg");
                const overlayClose = document.getElementById("envPend_distOverlayClose");

                function pctTxt(x){ return ((Number(x)||0)*100).toFixed(1).replace(".", ",") + "%"; }

                function renderDistOverlay_() {
                  const body = document.getElementById("envPend_distOverlayBody");
                  if (!body) return;

                  const arr = window.__envPend?.resumo?.lojasPendStack;
                  if (!Array.isArray(arr) || !arr.length) {
                    body.innerHTML = `<div style="color:#64748b;font-size:12px;">Sem dados por loja.</div>`;
                    return;
                  }

                  const top = arr.slice(0, 60); // evita overlay infinito (scroll já existe)
                  body.innerHTML = top.map(it => {
                    const r = Math.max(0, Math.min(100, (it.pctRecibo||0)*100));
                    const e = Math.max(0, Math.min(100, (it.pctEtiqueta||0)*100));
                    const d = Math.max(0, Math.min(100, (it.pctDescricao||0)*100));
                    const n = Math.max(0, Math.min(100, (it.pctDivergNF||0)*100));

                    return `
                      <div style="padding:10px 10px; border:1px solid rgba(15,23,42,0.08); border-radius:14px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
                          <div style="font-weight:1000; color:#0f172a;">Loja ${it.lojaKey}</div>
                          <div style="font-size:12px; color:#334155;">(base: ${it.totalFlags||0} flags)</div>
                        </div>

                        <div style="margin-top:8px; height:14px; background:#e2e8f0; border-radius:999px; overflow:hidden; display:flex;">
                          <div style="width:${r}%; background:#005E27;"></div>
                          <div style="width:${e}%; background:#0ea5e9;"></div>
                          <div style="width:${d}%; background:#a855f7;"></div>
                          <div style="width:${n}%; background:#f59e0b;"></div>
                        </div>

                        <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#334155;">
                          <div><b>Recibo:</b> ${pctTxt(it.pctRecibo)}</div>
                          <div><b>Etiqueta:</b> ${pctTxt(it.pctEtiqueta)}</div>
                          <div><b>Descrição:</b> ${pctTxt(it.pctDescricao)}</div>
                          <div><b>NF div.:</b> ${pctTxt(it.pctDivergNF)}</div>
                        </div>
                      </div>
                    `;
                  }).join("");
                }

                function openDist_() {
                  if (!overlay) return;
                  renderDistOverlay_();
                  overlay.style.display = "block";
                }
                function closeDist_() {
                  if (!overlay) return;
                  overlay.style.display = "none";
                }

                if (overlayBg) overlayBg.onclick = closeDist_;
                if (overlayClose) overlayClose.onclick = closeDist_;

                if (dist && !dist.__bindHoverDist) {
                    dist.__bindHoverDist = true;
                    dist.style.cursor = "help";

                    let t = null;

                    dist.addEventListener("mouseenter", function () {
                      if (t) clearTimeout(t);

                      // só abre se o mouse ficar parado por 350ms
                      t = setTimeout(function () {
                        // não abre de novo se já está aberto
                        if (overlay && overlay.style.display === "block") return;
                        openDist_();
                      }, 2200);
                    });

                    dist.addEventListener("mouseleave", function () {
                      if (t) clearTimeout(t);
                      t = null;
                    });
                  }
              } catch (e) {
                console.error("Erro bind dist donut:", e);
              }

          // ===== mini-sparklines (cards KPI) =====
            (function renderKpiSparklines() {
              const rows = Array.isArray(window.__envPend.rows) ? window.__envPend.rows : [];
              const serie = Array.isArray(res.seriePorData) ? res.seriePorData : [];

              // Se não tiver série por data, não renderiza
              if (!serie.length) return;

              // lista de datas (dd/MM/yyyy) na ordem do gráfico
              const dates = serie.map(p => String(p.data || "").trim()).filter(Boolean);

              // helpers de valor
              const toNum = (v) => {
                const s = String(v || "")
                  .replace(/[R$\s]/g, "")
                  .replace(/\./g, "")
                  .replace(",", ".");
                const n = Number(s);
                return isNaN(n) ? 0 : n;
              };

              // agregações por data
              const mapTx = {};        // data -> total tx (usa seriePorData, mas mantemos por simetria)
              const mapValor = {};     // data -> soma valor
              const mapEnviadas = {};  // data -> count jaEnviado
              const setLojas = {};     // data -> {lojaKey:true}

              dates.forEach(d => {
                mapTx[d] = 0;
                mapValor[d] = 0;
                mapEnviadas[d] = 0;
                setLojas[d] = {};
              });

              // preenche tx a partir da própria seriePorData
              serie.forEach(p => {
                const d = String(p.data || "").trim();
                if (!d) return;
                mapTx[d] = Number(p.total) || 0;
              });

              // preenche lojas/valor/enviadas a partir das rows
              rows.forEach(r => {
                const d = String(r.dataTransBR || r.data || "").trim(); // preferencialmente dataTransBR
                if (!d || !(d in setLojas)) return;

                const loja = String(r.lojaKey || "").trim();
                if (loja) setLojas[d][loja] = true;

                mapValor[d] += toNum(r.valorOriginal || r.valorOriginalTxt || 0);

                if (r.jaEnviado) mapEnviadas[d] += 1;
              });

              const seriesTx = dates.map(d => mapTx[d] || 0);
              const seriesLojas = dates.map(d => Object.keys(setLojas[d] || {}).length);
              const seriesValor = dates.map(d => mapValor[d] || 0);
              const seriesEnviadas = dates.map(d => mapEnviadas[d] || 0);

              // render SVG sparkline
              function renderSpark(targetId, values) {
                const box = document.getElementById(targetId);
                if (!box) return;

                const W = 160, H = 26;
                const PAD = 3;

                const maxV = Math.max.apply(null, values.concat([1]));
                const minV = Math.min.apply(null, values.concat([0]));
                const span = Math.max(1e-9, (maxV - minV));

                const xOf = (i) => {
                  if (values.length <= 1) return PAD;
                  return PAD + (i * (W - PAD * 2)) / (values.length - 1);
                };
                const yOf = (v) => {
                  const t = (v - minV) / span;     // 0..1
                  return (H - PAD) - t * (H - PAD * 2);
                };

                let d = "";
                values.forEach((v, i) => {
                  const x = xOf(i);
                  const y = yOf(Number(v) || 0);
                  d += (i === 0 ? "M" : " L") + x + " " + y;
                });

                // marcador no último ponto
                const lastX = xOf(values.length - 1);
                const lastY = yOf(values[values.length - 1] || 0);

                box.innerHTML = `
                <svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
                  <!-- linha base (fundo) -->
                  <path d="${d}" fill="none" stroke="rgba(181,255,32,0.25)" stroke-width="1.8" stroke-linecap="round" />

                  <!-- linha tracejada “viva” (anima dashoffset) -->
                  <path d="${d}" fill="none" stroke="#B5FF20" stroke-width="1.2" stroke-dasharray="4 6" stroke-linecap="round">
                    <animate attributeName="stroke-dashoffset"
                            from="0"
                            to="-20"
                            dur="1.8s"
                            repeatCount="indefinite" />
                  </path>

                  <!-- último ponto com pulso leve -->
                  <circle cx="${lastX}" cy="${lastY}" r="2.8" fill="#B5FF20">
                    <animate attributeName="r"
                            values="2.6;3.2;2.6"
                            dur="1.6s"
                            repeatCount="indefinite" />
                    <animate attributeName="opacity"
                            values="0.85;1;0.85"
                            dur="1.6s"
                            repeatCount="indefinite" />
                  </circle>
                </svg>
              `;
              }

              renderSpark("envPend_sp_tx", seriesTx);
              renderSpark("envPend_sp_lojas", seriesLojas);
              renderSpark("envPend_sp_valor", seriesValor);
              renderSpark("envPend_sp_enviadas", seriesEnviadas);
            })();

          // ===== desenha o gráfico de linha (SVG) =====
          (function renderLineChart() {
            const svg = document.getElementById("envPend_svgLine");
            const serie = Array.isArray(res.seriePorData) ? res.seriePorData : [];
            if (!svg || !serie.length) {
              if (svg) svg.innerHTML = `<text x="10" y="20" fill="rgba(226,232,240,0.75)" font-size="12">Sem dados no período.</text>`;
              return;
            }

            const W = 800, H = 220;
            const PAD_X = 56, PAD_Y = 26; // PAD_X maior para caber labels do eixo Y

            const maxY = Math.max(...serie.map(p => Number(p.total) || 0), 1);
            const stepX = (W - PAD_X * 2) / Math.max(1, serie.length - 1);

            const yOf = (v) => H - PAD_Y - (v / maxY) * (H - PAD_Y * 2);

            // path da linha
            let dPath = "";
            serie.forEach((p, i) => {
              const x = PAD_X + i * stepX;
              const y = yOf(Number(p.total) || 0);
              dPath += (i === 0 ? "M" : " L") + x + " " + y;
            });

            // ✅ NOVO: área preenchida sob a linha (fecha até a base do gráfico)
            const baseY = H - PAD_Y; // linha do "chão" do gráfico
            const lastX = PAD_X + (serie.length - 1) * stepX;
            const firstX = PAD_X;

            const dArea = dPath + " L " + lastX + " " + baseY + " L " + firstX + " " + baseY + " Z";

            // grid + eixo Y labels
            const ticks = 4;
            const grid = [];
            for (let t = 0; t <= ticks; t++) {
              const frac = t / ticks;
              const y = PAD_Y + frac * (H - PAD_Y * 2);
              const val = Math.round(maxY * (1 - frac));

              grid.push(`<line x1="${PAD_X}" y1="${y}" x2="${W - PAD_X}" y2="${y}" stroke="rgba(148,163,184,0.12)" stroke-width="1" />`);
              grid.push(`
                <text x="${PAD_X - 10}" y="${y}"
                      text-anchor="end"
                      dominant-baseline="middle"
                      font-size="11"
                      fill="rgba(226,232,240,0.55)">${val}</text>
              `);
            }

            svg.innerHTML = `
              ${grid.join("")}

              <!-- ✅ NOVO: área (vermelho claro) sob a linha -->
              <path id="envPend_areaFill"
              d="${dArea}"
              fill="rgba(248,113,113,0.18)"
              stroke="none" />

              <!-- linha base (vai ser animada via getTotalLength) -->
              <path id="envPend_lineBase"
                    d="${dPath}"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="2.0"
                    stroke-linecap="round"
                    stroke-linejoin="round" />

              <!-- highlight “vivo” (animação infinita) -->
              <path id="envPend_lineHighlight"
                    d="${dPath}"
                    fill="none"
                    stroke="rgba(255,255,255,0.45)"
                    stroke-width="3.0"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-dasharray="10 18" />

              ${serie.map((p, i) => {
                const x = PAD_X + i * stepX;
                const y = yOf(Number(p.total) || 0);
                const val = Number(p.total) || 0;
                const labelY = Math.max(PAD_Y + 10, y - 16); // sobe mais pra não encostar no marcador

                // ✅ ordem: CÍRCULO primeiro, TEXTO depois (texto não fica coberto)
                return `
                  <circle cx="${x}" cy="${y}" r="4.2" fill="#ffffff" opacity="0.95" />
                  <text x="${x}" y="${labelY}"
                        text-anchor="middle"
                        dominant-baseline="middle"
                        font-size="10"
                        font-weight="800"
                        style="paint-order:stroke; stroke:#0b1220; stroke-width:2px;"
                        fill="#ffffff">${val}</text>

                  <text x="${x}" y="${H - 6}"
                        text-anchor="middle"
                        font-size="10"
                        fill="rgba(226,232,240,0.65)">${p.data}</text>
                `;
              }).join("")}
            `;

            // ✅ animações com velocidade ajustável
            try {
              const base = svg.querySelector("#envPend_lineBase");
              const hi = svg.querySelector("#envPend_lineHighlight");
              if (base && base.getTotalLength) {
                const len = base.getTotalLength();

                // --- velocidade (ajuste aqui) ---
                const DUR_DRAW = "2.2s";     // desenhar linha
                const DUR_RUN  = "3.5s";     // highlight correndo (mais lento = mais premium)

                base.style.strokeDasharray = String(len);
                base.style.strokeDashoffset = String(len);

                base.innerHTML = `
                  <animate attributeName="stroke-dashoffset"
                          from="${len}"
                          to="0"
                          dur="${DUR_DRAW}"
                          fill="freeze" />`;

                if (hi) {
                  hi.style.opacity = "0";
                  hi.innerHTML = `
                    <animate attributeName="opacity" from="0" to="1" dur="0.35s" begin="${DUR_DRAW}" fill="freeze" />
                    <animate attributeName="stroke-dashoffset"
                            from="0" to="-220"
                            dur="${DUR_RUN}"
                            begin="${DUR_DRAW}"
                            repeatCount="indefinite" />
                  `;
                }
              }
            } catch (e) {
              // fallback: sem getTotalLength, ainda renderiza estático
            }
})();
        }

        // ✅ NOVO: cards de status mix do período
            (function renderStatusCards() {
              const box = document.getElementById("envPend_statusCards");
              const M = (res && res.statusMix) ? res.statusMix : (res && res.resumo ? res.resumo.statusMix : null);
              if (!box) return;

              if (!M || !M.total) {
                box.innerHTML = "";
                return;
              }

              const pct = (x) => ((x || 0) * 100).toFixed(1).replace(".", ",") + "%";

              box.innerHTML = `
                <div style="min-width:160px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:10px 12px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Aprovadas</div>
                  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
                    <div style="color:#fff; font-size:22px; font-weight:1000;">${M.aprovada}</div>
                    <div style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:900;">${pct(M.pctAprovada)}</div>
                  </div>
                </div>

                <div style="min-width:160px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:10px 12px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Recusadas</div>
                  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
                    <div style="color:#fff; font-size:22px; font-weight:1000;">${M.recusada}</div>
                    <div style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:900;">${pct(M.pctRecusada)}</div>
                  </div>
                </div>

                <div style="min-width:190px; background:rgba(255,255,255,0.04); border:1px solid rgba(148,163,184,0.18); border-radius:14px; padding:10px 12px;">
                  <div style="color:rgba(226,232,240,0.7); font-size:11px; font-weight:900;">Necessita aprovação</div>
                  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
                    <div style="color:#fff; font-size:22px; font-weight:1000;">${M.necessita}</div>
                    <div style="color:rgba(226,232,240,0.75); font-size:12px; font-weight:900;">${pct(M.pctNecessita)}</div>
                  </div>
                </div>
              `;
              })();

          // ✅ NOVO: overlay de sucesso no centro + fecha automaticamente
            const linhasOk = (window.__envPend.rows || []).length;

            window.vektorEnvPendOverlayShow_(
              `Prévia pronta: ${linhasOk} linha(s).`,
              "Você já pode revisar as linhas e enviar."
            );

            setTimeout(function () {
              window.vektorEnvPendOverlayHide_();
            }, 1200);

        window.__renderEnvPendTbody();
        if (st) st.textContent = `Prévia pronta: ${window.__envPend.rows.length} linha(s).`;

        if ((window.__envPend.rows || []).length > 0) {
          window.vektorEnvioPendenciasAbrirModal();
        }
      })
      .withFailureHandler(function (err) {
        window.vektorEnvPendOverlayHide_();
        if (st) st.textContent = "Erro ao gerar prévia.";
        if (resumoEl) resumoEl.textContent = (err && err.message) ? err.message : String(err || "Erro");
      })
      .previewEnvioPendenciasClaraRecusadasDetalhado(iniIso, fimIso);

  } catch (e) {
    try { window.vektorEnvPendOverlayHide_(); } catch (_) {}
    const st = document.getElementById("envPend_statusText");
    if (st) st.textContent = "Erro inesperado na prévia.";
  }
};

window.vektorEnvioPendenciasEnviarSelecionadas = function () {
  const falhasEl = document.getElementById("envPend_falhas");
  const st = document.getElementById("envPend_statusText");
  if (falhasEl) falhasEl.innerHTML = "";

  // ✅ anti-duplo-clique (front)
  if (window.__envPendSendInFlight) return;
  window.__envPendSendInFlight = true;

  // ✅ desabilita botão
  var btn = document.getElementById("envPend_btnEnviarSelecionadas");
  if (btn) {
    btn.disabled = true;
    btn.style.opacity = "0.6";
    btn.style.pointerEvents = "none";
  }

  function releaseUi_() {
    window.__envPendSendInFlight = false;
    if (btn) {
      btn.disabled = false;
      btn.style.opacity = "";
      btn.style.pointerEvents = "";
    }
  }

  try {
    const iniIso = window.__envPend && window.__envPend.periodo ? (window.__envPend.periodo.iniIso || "") : "";
    const fimIso = window.__envPend && window.__envPend.periodo ? (window.__envPend.periodo.fimIso || "") : "";

    if (!iniIso || !fimIso) {
      if (st) st.textContent = "Rode a prévia antes de enviar.";
      releaseUi_();
      return;
    }

    const selected = (window.__envPend && window.__envPend.selected) ? window.__envPend.selected : {};
    const keys = Object.keys(selected).filter(k => selected[k]);

    if (!keys.length) {
      if (st) st.textContent = "Nenhuma linha selecionada para enviar.";
      releaseUi_();
      return;
    }

    if (st) st.textContent = "Enviando e-mails…";

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          if (!res || !res.ok) {
            if (st) st.textContent = "Falha no envio.";
            if (falhasEl) falhasEl.innerHTML =
              `<div style="color:rgba(248,113,113,0.95); font-weight:900;">${res && res.error ? res.error : "Erro desconhecido"}</div>`;
            return;
          }

          if (st) st.textContent = `Envio concluído: e-mails=${res.emailsEnviados || 0}, transações registradas=${res.txRegistradas || 0}.`;

          const falhas = Array.isArray(res.falhasPorLoja) ? res.falhasPorLoja : [];
          const sucessos = Array.isArray(res.sucessoPorLoja) ? res.sucessoPorLoja : [];

          let html = "";
          if (sucessos.length) {
            html += `<div style="margin-top:8px; color:rgba(34,197,94,0.95); font-weight:900;">Enviados (${sucessos.length} loja(s))</div>`;
            html += "<ul style='margin-left:18px; color:rgba(226,232,240,0.85); font-size:12px;'>";
            sucessos.slice(0, 12).forEach(s => {
              html += `<li>${s.lojaKey}: ${s.qtdTx} transação(ões)</li>`;
            });
            html += "</ul>";
          }

          if (falhas.length) {
            html += `<div style="margin-top:12px; color:rgba(248,113,113,0.95); font-weight:900;">Não enviados (${falhas.length} loja(s))</div>`;
            html += "<ul style='margin-left:18px; color:rgba(226,232,240,0.85); font-size:12px;'>";
            falhas.slice(0, 12).forEach(f => {
              html += `<li>${f.lojaKey}: ${f.error}</li>`;
            });
            html += "</ul>";
          }

          if (falhasEl) falhasEl.innerHTML = html;

          // Atualiza prévia para refletir envios
          window.vektorEnvioPendenciasFecharModal();
          window.vektorEnvioPendenciasPreview();

        } finally {
          releaseUi_();
        }
      })
      .withFailureHandler(function (err) {
        try {
          if (st) st.textContent = "Erro no envio.";
          if (falhasEl) falhasEl.innerHTML =
            `<div style="color:rgba(248,113,113,0.95); font-weight:900;">${(err && err.message) ? err.message : String(err || "Erro")}</div>`;
        } finally {
          releaseUi_();
        }
      })
      .dispararEnvioPendenciasClaraRecusadasSelecionadas(iniIso, fimIso, keys);

  } catch (e) {
    // erro síncrono do JS (antes do google.script.run)
    if (st) st.textContent = "Erro inesperado no envio.";
    if (falhasEl) falhasEl.innerHTML =
      `<div style="color:rgba(248,113,113,0.95); font-weight:900;">${(e && e.message) ? e.message : String(e || "Erro")}</div>`;
    releaseUi_();
  }
};

window.vektorOpenFluxograma = function () {
  vektorShowFluxogramaView_();

  // desenha após layout estabilizar
  setTimeout(vektorDrawFluxogramaConnectors_, 50);
  setTimeout(vektorDrawFluxogramaConnectors_, 220);
};

window.addEventListener("resize", function () {
  // só tenta redesenhar se a view estiver aberta
  const v = document.getElementById("fluxogramaView");
  if (v && !v.classList.contains("hidden")) {
    vektorDrawFluxogramaConnectors_();
  }
});

function vektorDrawFluxogramaConnectors_() {
  try {
    const flow = document.querySelector("#fluxogramaView .flow-container") || null;
    const svg = document.getElementById("fluxoConnectorsSvg");
    if (!svg) return;

    const s1 = document.getElementById("fgStep1");
    const s2 = document.getElementById("fgStep2");
    const s3 = document.getElementById("fgStep3");
    const s4 = document.getElementById("fgStep4");
    const s5 = document.getElementById("fgStep5");
    if (!s1 || !s2 || !s3 || !s4 || !s5) return;

    // o SVG está dentro do flow container (position:relative). Precisamos de coordenadas relativas a ele
    const svgRect = svg.getBoundingClientRect();

    const rect = (el) => el.getBoundingClientRect();

    function midY(r) { return r.top + r.height / 2; }

    // ponto de saída = centro vertical na borda "externa" da caixa
      function outPoint(fromRect, side) {
        const GAP = 8; // << controla o quanto o traço fica FORA da caixa
        const x = (side === "right") ? (fromRect.right + GAP) : (fromRect.left - GAP);
        const y = midY(fromRect);
        return { x: x - svgRect.left, y: y - svgRect.top };
      }

      // ponto de entrada = centro vertical na borda "interna" da caixa
      function inPoint(toRect, side) {
        const GAP = 8; // mesmo GAP, para não “entrar” na borda
        const x = (side === "left") ? (toRect.left - GAP) : (toRect.right + GAP);
        const y = midY(toRect);
        return { x: x - svgRect.left, y: y - svgRect.top };
      }


    function elbowPath(p1, p2, bendX) {
      // horizontal → vertical → horizontal
      // p1 -> (bendX, p1.y) -> (bendX, p2.y) -> p2
      return `M ${p1.x} ${p1.y} L ${bendX} ${p1.y} L ${bendX} ${p2.y} L ${p2.x} ${p2.y}`;
    }

    function drawOne(fromEl, toEl, dir, stroke, markerId) {
      const r1 = rect(fromEl);
      const r2 = rect(toEl);

      // dir = "L2R" (step esquerdo para step direito) ou "R2L"
      const p1 = outPoint(r1, dir === "L2R" ? "right" : "left");
      const p2 = inPoint(r2, dir === "L2R" ? "left" : "right");

      // define um bendX mais ou menos no meio, mas preservando “reto saindo e entrando”
      const bendX = (dir === "L2R")
        ? Math.min(p1.x + 180, (p1.x + p2.x) / 2)
        : Math.max(p1.x - 180, (p1.x + p2.x) / 2);

      const d = elbowPath(p1, p2, bendX);

      return `<path d="${d}"
        fill="none"
        stroke="${stroke}"
        stroke-opacity="1"
        stroke-width="2"
        stroke-linecap="square"
        stroke-linejoin="miter"
        marker-end="url(#${markerId})"
        shape-rendering="crispEdges"
      ></path>`;

    }

    // limpa e redesenha
    const paths = [];
    paths.push(drawOne(s1, s2, "L2R", "rgb(181,255,32)", "arrowHeadGreen"));
    paths.push(drawOne(s2, s3, "R2L", "rgb(34,197,94)", "arrowHeadDarkGreen"));
    paths.push(drawOne(s3, s4, "L2R", "rgb(181,255,32)", "arrowHeadGreen"));
    paths.push(drawOne(s4, s5, "R2L", "rgb(34,197,94)", "arrowHeadDarkGreen"));

    // mantém defs e injeta paths
    const defs = svg.querySelector("defs")?.outerHTML || "";
    svg.innerHTML = defs + paths.join("");

    // ajusta viewBox para o tamanho atual do SVG
    svg.setAttribute("viewBox", `0 0 ${svgRect.width} ${svgRect.height}`);
  } catch (e) {
    // silencioso
  }
}

// FEEDBACK (tela cheia)
window.vektorOpenFeedback = function () {
  vektorShowFeedbackView_();

  // (opcional) força recarregar o iframe sempre que abrir
  const fr = document.getElementById("feedbackFrame");
  if (fr && fr.src) {
    fr.src = fr.src; // recarrega mantendo mesma URL
  }
};

// ===============================
// RADAR (tela cheia)
// ===============================
window.vektorOpenRadar = function (modo) {
  // abre Radar e fecha outras views (base)
  vektorShowRadarView_();

  // ✅ garante que Alertas Programados não fique por cima
  const myAlertsView = document.getElementById("myAlertsView");
  if (myAlertsView) myAlertsView.classList.add("hidden");

  const radarView = document.getElementById("radarView");
  if (radarView) radarView.classList.add("is-open");

  setRadarActiveBtn_(modo);

  // ✅ garante que ao abrir o Radar, volta para a visão tradicional
    window.vektorSetRadarViewMode_("RADAR");

  const loading = document.getElementById("radarLoading");
  const heat = document.getElementById("radarHeatmap");
  const rank = document.getElementById("radarRanking");

  if (loading) loading.style.display = "block";
  if (heat) heat.innerHTML = "";
  if (rank) rank.innerHTML = "";

  google.script.run
    .withSuccessHandler(function (res) {
      if (loading) loading.style.display = "none";

      if (!res || !res.ok) {
        const msg = (res && res.restrito)
          ? "Acesso restrito: apenas Administrador."
          : "Falha ao carregar dados do Radar.";
        if (heat) {
          heat.innerHTML = `<div style="color:rgba(226,232,240,0.85); font-weight:700; font-size:13px;">${msg}</div>`;
        }
        return;
      }

      const lojas = Array.isArray(res.lojas) ? res.lojas : [];
      if (!lojas.length) {
        if (heat) {
          heat.innerHTML = `<div style="color:rgba(226,232,240,0.85); font-weight:700; font-size:13px;">Sem dados suficientes no período.</div>`;
        }
        return;
      }

      renderRadarHeatmap_(lojas);
      renderRadarRanking_(lojas, res.detalhesPorLoja || {});
      renderRadarInsights_(lojas);

    })
    .withFailureHandler(function (err) {
      if (loading) loading.style.display = "none";
      const msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
      if (heat) {
        heat.innerHTML = `<div style="color:rgba(248,113,113,0.95); font-weight:800; font-size:13px;">Falha: ${msg}</div>`;
      }
    })
    .getRadarIrregularidadeParaChat(modo);
};

// ===============================
// RADAR - ITENS IRREGULARES (view mode)
// ===============================
window.__radarViewMode = "RADAR"; // "RADAR" | "ITENS"

window.vektorSetRadarViewMode_ = function(mode) {
  const m = String(mode || "RADAR").toUpperCase();
  window.__radarViewMode = (m === "ITENS") ? "ITENS" : "RADAR";

  const radarContent = document.getElementById("radarContent");
  const itensView = document.getElementById("radarItensView");
  const btnItens = document.getElementById("radarBtnItens");
  const btnHistEnvios = document.getElementById("radarBtnHistEnvios"); // ✅ novo botão

  // ✅ botões que só fazem sentido no RADAR (devem sumir no modo ITENS)
  const btn7d = document.getElementById("radarBtn7d");
  const btnCiclo = document.getElementById("radarBtnCiclo");
  const btnFull = document.getElementById("radarBtnFull");
  const btnComo = document.getElementById("radarBtnComoAnalise");

  const isRadar = (window.__radarViewMode === "RADAR");
  const isItens = (window.__radarViewMode === "ITENS");

  [btn7d, btnCiclo, btnFull, btnComo].forEach(function(b){
    if (!b) return;
    b.style.display = isRadar ? "inline-flex" : "none";
  });

  // ✅ Histórico de envios: só aparece no modo ITENS
  if (btnHistEnvios) {
    btnHistEnvios.style.display = isItens ? "inline-flex" : "none";
  }

  if (radarContent) radarContent.style.display = isRadar ? "grid" : "none";
  if (itensView) itensView.style.display = isItens ? "block" : "none";

  if (btnItens) {
    btnItens.textContent = isItens ? "Radar" : "Itens Irregulares";
    btnItens.style.background = isItens ? "rgba(226,232,240,0.90)" : "#fde68a";
    btnItens.style.color = "#111827";
    btnItens.style.borderColor = isItens ? "rgba(15,23,42,0.25)" : "rgba(0,0,0,0.25)";
    btnItens.style.fontWeight = "1000";
    btnItens.style.display = "inline-flex"; // garante que o botão principal sempre apareça
  }
};

window.vektorToggleRadarItensIrregulares = function() {
  const irParaItens = (window.__radarViewMode !== "ITENS");
  window.vektorSetRadarViewMode_(irParaItens ? "ITENS" : "RADAR");

    // ✅ ajusta subtítulo do header conforme a visão
  const sub = document.getElementById("radarSubTitle");
  if (sub) {
    sub.textContent = irParaItens
      ? "Itens irregulares — revisão de possíveis divergências por período (selecione um período e clique em “Atualizar”)."
      : "Correlação entre métricas + ranking de proximidade por loja";
  }

  // ✅ ao entrar em ITENS: apenas prepara defaults e zera a tela.
// ❌ NÃO carregar automaticamente.
if (irParaItens) {
  window.vektorInitRadarItensIrregularesDefaults_();

  // limpa KPIs/visuais até clicar em "Atualizar"
  const k1 = document.getElementById("itensIrregKpiTotal");
  const k2 = document.getElementById("itensIrregKpiValor");
  const k3 = document.getElementById("itensIrregKpiAlertas");
  const k4 = document.getElementById("itensIrregKpiPctAlertas");
  if (k1) k1.textContent = "—";
  if (k2) k2.textContent = "—";
  if (k3) k3.textContent = "—";
  if (k4) k4.textContent = "—";

  const a1 = document.getElementById("itensIrregAggLoja");
  const a2 = document.getElementById("itensIrregAggTime");
  const ch = document.getElementById("itensIrregChart");
  if (a1) a1.innerHTML = "";
  if (a2) a2.innerHTML = "";
  if (ch) ch.innerHTML = "";

  window.__itensIrregLastRows = [];
  window.__itensIrregLastRes = null;

  const msg = document.getElementById("itensIrregMsg");
  if (msg) msg.innerHTML = `<div style="color:rgba(226,232,240,0.75); font-weight:900; font-size:12px;">Selecione um período e clique em “Atualizar”.</div>`;
}
};

window.vektorInitRadarItensIrregularesDefaults_ = function() {
  const iniEl = document.getElementById("itensIrregDtIni");
  const fimEl = document.getElementById("itensIrregDtFim");
  if (!iniEl || !fimEl) return;

  // default: últimos 7 dias
  const hoje = new Date();
  const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  const ini = new Date(fim);
  ini.setDate(fim.getDate() - 6);

  const toISO = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${dd}`;
  };

  if (!fimEl.value) fimEl.value = toISO(fim);
  if (!iniEl.value) iniEl.value = toISO(ini);
};

window.vektorLoadRadarItensIrregulares = function() {
  const tbody = document.getElementById("itensIrregTbody");
  const kpiTotal = document.getElementById("itensIrregKpiTotal");
  const kpiValor = document.getElementById("itensIrregKpiValor");
  const kpiAlertas = document.getElementById("itensIrregKpiAlertas");
  const kpiPctAlertas = document.getElementById("itensIrregKpiPctAlertas");

  const aggLoja = document.getElementById("itensIrregAggLoja");
  const aggTime = document.getElementById("itensIrregAggTime");
  const chart = document.getElementById("itensIrregChart");
  const chartLabel = document.getElementById("itensIrregChartLabel");

  const ini = (document.getElementById("itensIrregDtIni") || {}).value || "";
  const fim = (document.getElementById("itensIrregDtFim") || {}).value || "";
  const itemQ = (document.getElementById("itensIrregItemQ") || {}).value || "";
  const conf = (document.getElementById("itensIrregConf") || {}).value || "";
  const groupBy = (document.getElementById("itensIrregGroupBy") || {}).value || "loja";

  if (chartLabel) chartLabel.textContent = (groupBy === "time") ? "Time" : "Loja";

  const fmtBRL = (v) => {
    const n = Number(v || 0);
    return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  };

  const badge = (c) => {
    const x = String(c || "").toUpperCase();
    let bg = "rgba(255,255,255,0.06)", bd = "rgba(148,163,184,0.25)", tx = "rgba(226,232,240,0.95)";
    if (x === "OK") { bg = "rgba(34,197,94,0.18)"; bd = "rgba(34,197,94,0.35)"; tx = "#bbf7d0"; }
    if (x === "REVISAR") { bg = "rgba(245,158,11,0.18)"; bd = "rgba(245,158,11,0.35)"; tx = "#fde68a"; }
    if (x === "ALERTA") { bg = "rgba(248,113,113,0.18)"; bd = "rgba(248,113,113,0.35)"; tx = "#fecaca"; }
    return `<span style="display:inline-flex; align-items:center; height:22px; padding:0 10px; border-radius:999px;
      border:1px solid ${bd}; background:${bg}; color:${tx}; font-weight:1000; font-size:11px;">${x || "—"}</span>`;
  };

  if (tbody) tbody.innerHTML = `<tr><td colspan="8" style="padding:12px; color:rgba(226,232,240,0.75); font-weight:900; font-size:12px;">Carregando…</td></tr>`;
  if (aggLoja) aggLoja.innerHTML = "";
  if (aggTime) aggTime.innerHTML = "";
  if (chart) chart.innerHTML = "";

  if (kpiTotal) kpiTotal.textContent = "—";
  if (kpiValor) kpiValor.textContent = "—";
  if (kpiAlertas) kpiAlertas.textContent = "—";
  if (kpiPctAlertas) kpiPctAlertas.textContent = "—";

  google.script.run
    .withSuccessHandler(function(res) {
      window.vektorGlobalLoadingHide_();
      if (!res || !res.ok) {
        const msg = (res && res.error) ? res.error : "Falha ao carregar itens irregulares.";
        if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(248,113,113,0.95); font-weight:1000; font-size:12px;">${msg}</td></tr>`;
        return;
      }

      // KPIs
      if (kpiTotal) kpiTotal.textContent = String(res.kpis && res.kpis.totalItens != null ? res.kpis.totalItens : "0");
      if (kpiValor) kpiValor.textContent = fmtBRL(res.kpis ? res.kpis.totalValor : 0);
      if (kpiAlertas) kpiAlertas.textContent = String(res.kpis && res.kpis.alertaQtd != null ? res.kpis.alertaQtd : "0");
      if (kpiPctAlertas) kpiPctAlertas.textContent = (res.kpis && res.kpis.alertaPctValorTxt) ? res.kpis.alertaPctValorTxt : "—";

      // Aggs
      const renderAgg = (el, arr) => {
        if (!el) return;
        if (!Array.isArray(arr) || !arr.length) {
          el.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;
          return;
        }
        let h = `<div style="display:flex; flex-direction:column; gap:8px;">`;
        arr.slice(0, 12).forEach(x => {
          const nome = x.key || "—";
          const v = fmtBRL(x.valor || 0);
          const pct = x.pctTxt || "—";
          h += `
            <div style="display:flex; justify-content:space-between; gap:10px; padding:10px; border-radius:12px;
            border:1px solid rgba(181,255,32,0.28);
            background:rgba(181,255,32,0.06);
            box-shadow:0 8px 18px rgba(0,0,0,0.22);">
              <div style="color:#fff; font-weight:1000; font-size:12px;">${nome}</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <div style="color:rgba(226,232,240,0.8); font-weight:900; font-size:12px;">${pct}</div>
                <div style="color:#fff; font-weight:1000; font-size:12px;">${v}</div>
              </div>
            </div>`;
        });
        h += `</div>`;
        el.innerHTML = h;
      };

      renderAgg(aggLoja, res.aggLoja);
      renderAgg(aggTime, res.aggTime);

      // Gráfico ALERTA (dinâmico por Loja/Time)
        const serie = (groupBy === "time") ? (res.alertaByTime || []) : (res.alertaByLoja || []);
        if (chart) {
          if (!Array.isArray(serie) || !serie.length) {
            chart.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem ALERTA no período.</div>`;
          } else {
            const top = serie.slice(0, 12);
            const max = Math.max.apply(null, top.map(x => Number(x.qtd || 0)));
            let h = `<div style="display:flex; flex-direction:column; gap:8px;">`;
            top.forEach(x => {
              const nome = x.key || "—";
              const qtd = Number(x.qtd || 0);
              const w = (max > 0 ? Math.round((qtd / max) * 100) : 0);
              h += `
                <div style="display:flex; gap:10px; align-items:center;">
                  <div style="width:140px; color:#fff; font-weight:1000; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${nome}</div>
                  <div style="flex:1; height:10px; border-radius:999px; background:rgba(148,163,184,0.16); overflow:hidden;">
                    <div style="height:10px; width:${w}%; background:#B5FF20;"></div>
                  </div>
                  <div style="width:32px; text-align:right; color:rgba(226,232,240,0.92); font-weight:1000; font-size:12px;">${qtd}</div>
                </div>`;
            });
            h += `</div>`;
            chart.innerHTML = h;
          }
        }

      // Table
      const rows = Array.isArray(res.rows) ? res.rows : [];

       // ✅ EMPTY STATE: evita "tela em branco" quando não há linhas + mostra debug do backend
        if (!rows.length) {
          const dbg = res && res.debug ? res.debug : null;

          const dbgTxt = dbg ? `
            <div style="margin-top:8px; padding:10px; border-radius:10px; background:rgba(15,23,42,0.55);
                        border:1px solid rgba(148,163,184,0.18); color:rgba(226,232,240,0.92); font-size:12px;">
              <div style="font-weight:1000; margin-bottom:6px;">Debug (backend)</div>
              <div><b>dtIniRaw:</b> ${dbg.dtIniRaw || "—"}</div>
              <div><b>dtFimRaw:</b> ${dbg.dtFimRaw || "—"}</div>
              <div><b>dtIniParsed:</b> ${dbg.dtIniParsed || "—"}</div>
              <div><b>dtFimParsed:</b> ${dbg.dtFimParsed || "—"}</div>
              <div><b>totalMotor (antes de filtros):</b> ${Number(dbg.totalMotor || 0)}</div>
              <div><b>totalAposFiltros:</b> ${Number(dbg.totalAposFiltros || 0)}</div>
            </div>
          ` : "";

          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="padding:12px; color:rgba(226,232,240,0.85); font-weight:900; font-size:12px;">
                  Sem itens no período/filtros selecionados.
                  ${dbgTxt}
                </td>
              </tr>`;
          }

          window.__itensIrregLastRows = [];

          if (aggLoja) aggLoja.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;
          if (aggTime) aggTime.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;
          if (chart) chart.innerHTML = `<div style="color:rgba(226,232,240,0.7); font-size:12px; font-weight:800;">Sem dados.</div>`;

          return;
        }

            if (!rows.length) {
        const dbg = (res && res.debug) ? res.debug : null;
        const dbgTxt = dbg ? `
          <div style="margin-top:10px; padding:10px; border:1px dashed rgba(148,163,184,0.35); border-radius:10px; background:rgba(2,6,23,0.35);">
            <div style="font-weight:1000; font-size:12px; color:rgba(226,232,240,0.92);">Diagnóstico (debug)</div>
            <div style="margin-top:6px; font-size:12px; color:rgba(226,232,240,0.78); line-height:1.35;">
              dtIniIso: <b>${String(dbg.dtIniIsoRecebido || "")}</b><br/>
              dtFimIso: <b>${String(dbg.dtFimIsoRecebido || "")}</b><br/>
              janela: <b>${String(dbg.dIniBR || "")}</b> → <b>${String(dbg.dFimBR || "")}</b><br/>
              totalMotor: <b>${Number(dbg.totalMotor || 0)}</b><br/>
              resumoMotor: <b>${dbg.resumoMotor ? JSON.stringify(dbg.resumoMotor) : "—"}</b>
            </div>
          </div>
        ` : "";

        if (tbody) {
          tbody.innerHTML =
            `<tr><td colspan="7" style="padding:12px; color:rgba(226,232,240,0.78); font-weight:900; font-size:12px;">
              Sem registros no período.
              ${dbgTxt}
            </td></tr>`;
        }
        window.__itensIrregLastRows = [];
        return;
      }

      // cache para export CSV
      window.__itensIrregLastRows = rows;

      // se modal estiver aberto, atualiza o tbody na hora
      const modal = document.getElementById("itensIrregDetalhamentoModal");
      if (modal && modal.style.display === "block") {
        window.vektorRenderItensIrregDetalhamentoFromCache_();
      }

    })
    .withFailureHandler(function(err) {
      window.vektorGlobalLoadingHide_();
      const msg = (err && err.message) ? err.message : String(err || "Erro");
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(248,113,113,0.95); font-weight:1000; font-size:12px;">Falha: ${msg}</td></tr>`;
    })
    .getItensIrregularesRadarVisao({
        dtIniIso: ini,
        dtFimIso: fim,
        itemContains: itemQ,
        conformidade: conf,
        groupBy: groupBy,
        limit: 2500
        });

        window.vektorGlobalLoadingShow_(
  "Carregando Itens Irregulares…",
  "Buscando e agregando dados. Isso pode levar alguns segundos."
);

};

// =====================================================
// MODAL — Detalhamento Itens Irregulares (Radar)
// =====================================================
window.vektorOpenItensIrregDetalhamentoModal = function () {
  const m = document.getElementById("itensIrregDetalhamentoModal");
  if (!m) return;

  const rows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];

  // abre modal
  m.style.display = "block";

  // se ainda não carregou nada, só mostra aviso
  if (!rows.length) {
    const tbody = document.getElementById("itensIrregTbody");
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" style="padding:12px; color:rgba(226,232,240,0.80); font-weight:900; font-size:12px;">
            Sem dados para detalhar. Selecione o período e clique em <b>Atualizar</b> primeiro.
          </td>
        </tr>`;
    }
    return;
  }

  // popula filtros e renderiza (local, sem backend)
  if (typeof window.vektorItensIrregDetBuildFilters_ === "function") {
    window.vektorItensIrregDetBuildFilters_();
  }
  if (typeof window.vektorRenderItensIrregDetalhamentoFromCache_ === "function") {
    window.vektorRenderItensIrregDetalhamentoFromCache_();
  }
};

window.vektorOpenHistEnviosItensIrreg_ = function () {
  const m = document.getElementById("itensIrregHistEnviosModal");
  const tbody = document.getElementById("itensIrregHistEnviosTbody");
  const loading = document.getElementById("itensIrregHistEnviosLoading");
  if (!m || !tbody) return;

  m.style.display = "block";
  if (loading) loading.style.display = "block";
  tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; font-size:12px; color:#64748b;">Carregando...</td></tr>`;

  google.script.run
    .withSuccessHandler(function(res){
      if (loading) loading.style.display = "none";

      if (!res || !res.ok) {
        tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; font-size:12px; color:#b91c1c; font-weight:900;">
          ${(res && res.error) ? res.error : "Falha ao carregar histórico."}
        </td></tr>`;
        return;
      }

      const rows = Array.isArray(res.rows) ? res.rows : [];
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; font-size:12px; color:#64748b;">Nenhum envio registrado ainda.</td></tr>`;
        return;
      }

      const fmtBRL = (v) => Number(v || 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });

      const badgeStatus = (qtdEnvios) => {
        if (Number(qtdEnvios || 0) >= 3) {
          return `<span style="display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px;
                        border:1px solid #f59e0b; background:#fef3c7; color:#92400e; font-weight:1000; font-size:11px;">
                    Necessita de treinamento adicional / Envio de Política
                  </span>`;
        }
        return `<span style="display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px;
                      border:1px solid #cbd5e1; background:#f8fafc; color:#334155; font-weight:1000; font-size:11px;">
                  Monitorar
                </span>`;
      };

      tbody.innerHTML = rows.map((r, i) => {
        const bg = (i % 2 === 0) ? "#ffffff" : "#f8fafc";
        return `
          <tr style="background:${bg};">
            <td style="padding:10px; border-bottom:1px solid #e2e8f0; font-size:12px; font-weight:900; color:#0f172a;">${r.lojaKey || "—"}</td>
            <td style="padding:10px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#0f172a;">${r.time || "—"}</td>
            <td style="padding:10px; border-bottom:1px solid #e2e8f0; text-align:right; font-size:12px; font-weight:900; color:#0f172a;">${Number(r.qtdEnvios || 0)}</td>
            <td style="padding:10px; border-bottom:1px solid #e2e8f0; text-align:right; font-size:12px; font-weight:900; color:#0f172a;">${Number(r.qtdItens || 0)}</td>
            <td style="padding:10px; border-bottom:1px solid #e2e8f0; text-align:right; font-size:12px; font-weight:900; color:#0f172a;">${fmtBRL(r.valorTotal || 0)}</td>
            <td style="padding:10px; border-bottom:1px solid #e2e8f0; font-size:12px; color:#0f172a;">${r.ultimoEnvio || "—"}</td>
            <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${badgeStatus(r.qtdEnvios)}</td>
          </tr>
        `;
      }).join("");
    })
    .withFailureHandler(function(err){
      if (loading) loading.style.display = "none";
      const msg = (err && err.message) ? err.message : String(err || "Erro");
      tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; font-size:12px; color:#b91c1c; font-weight:900;">
        Falha ao carregar histórico: ${msg}
      </td></tr>`;
    })
    .vektorGetHistoricoEnviosItensIrregularesResumo();
};

window.vektorCloseHistEnviosItensIrreg_ = function () {
  const m = document.getElementById("itensIrregHistEnviosModal");
  if (m) m.style.display = "none";
};

window.vektorCloseItensIrregDetalhamentoModal = function () {
  const m = document.getElementById("itensIrregDetalhamentoModal");
  if (!m) return;
  m.style.display = "none";
};

// ✅ alias (caso alguma parte antiga chame o nome “sem Detalhamento”)
window.vektorOpenItensIrregDetalhamentoModal = window.vektorOpenItensIrregDetalhamentoModal;
window.vektorCloseItensIrregDetalhamentoModal = window.vektorCloseItensIrregDetalhamentoModal;

window.vektorItensIrregDetBuildFilters_ = function () {
  const rows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selLoja = document.getElementById("itensIrregDetFiltroLoja");
  const selTime = document.getElementById("itensIrregDetFiltroTime");
  if (!selLoja || !selTime) return;

  const curLoja = String(selLoja.value || "").trim();
  const curTime = String(selTime.value || "").trim();

  const norm = (x) => String(x || "").trim();
  const uniq = (arr) => Array.from(new Set(arr)).filter(Boolean).sort((a, b) => String(a).localeCompare(String(b), "pt-BR"));

  // 1) calcula lojas possíveis respeitando o TIME selecionado
  const lojasPossiveis = uniq(
    rows
      .filter(r => !curTime || norm(r.time) === curTime)
      .map(r => norm(r.loja))
      .filter(x => x && x !== "—")
  );

  // 2) calcula times possíveis respeitando a LOJA selecionada
  const timesPossiveis = uniq(
    rows
      .filter(r => !curLoja || norm(r.loja) === curLoja)
      .map(r => norm(r.time))
      .filter(x => x && x !== "—")
  );

  // helper para montar options
  const esc = (s) => String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");

  // atualiza select Loja
  selLoja.innerHTML =
    `<option value="">Todas</option>` +
    lojasPossiveis.map(x => `<option value="${esc(x)}">${esc(x)}</option>`).join("");

  // atualiza select Time
  selTime.innerHTML =
    `<option value="">Todos</option>` +
    timesPossiveis.map(x => `<option value="${esc(x)}">${esc(x)}</option>`).join("");

    // ✅ cascata: ao mudar um, refaz opções do outro e re-renderiza a tabela
    selLoja.onchange = function () {
      window.vektorItensIrregDetBuildFilters_();             // refaz opções respeitando a Loja
      window.vektorRenderItensIrregDetalhamentoFromCache_(); // re-renderiza tabela
    };

    selTime.onchange = function () {
      window.vektorItensIrregDetBuildFilters_();             // refaz opções respeitando o Time
      window.vektorRenderItensIrregDetalhamentoFromCache_(); // re-renderiza tabela
    };

  // 3) tenta manter seleção atual, mas se não existir mais, zera
  if (curLoja && lojasPossiveis.indexOf(curLoja) === -1) selLoja.value = "";
  else selLoja.value = curLoja;

  if (curTime && timesPossiveis.indexOf(curTime) === -1) selTime.value = "";
  else selTime.value = curTime;
};

window.vektorClearItensIrregDetFilters_ = function() {
  const selLoja = document.getElementById("itensIrregDetFiltroLoja");
  const selTime = document.getElementById("itensIrregDetFiltroTime");
  if (selLoja) selLoja.value = "";
  if (selTime) selTime.value = "";
  window.vektorItensIrregDetBuildFilters_();
  window.vektorRenderItensIrregDetalhamentoFromCache_();
};

// Estado da ordenação do modal de detalhamento (padrão: Data desc = mais recente primeiro)
window.__itensIrregDetSort = window.__itensIrregDetSort || {
  key: "data",
  dir: "desc" // "asc" | "desc"
};

window.vektorToggleItensIrregDetSort_ = function(key){
  key = String(key || "").toLowerCase();
  if (!key) return;

  const cur = window.__itensIrregDetSort || { key: "data", dir: "desc" };

  if (cur.key === key) {
    cur.dir = (cur.dir === "asc") ? "desc" : "asc";
  } else {
    cur.key = key;
    // padrão por coluna:
    // data -> desc (mais recente primeiro)
    // valor -> desc (maior primeiro)
    cur.dir = "desc";
  }

  window.__itensIrregDetSort = cur;
  window.vektorRenderItensIrregDetalhamentoFromCache_();
};

window.vektorRenderItensIrregDetalhamentoFromCache_ = function () {
  const tbody = document.getElementById("itensIrregDetTbody");
  if (!tbody) return;

  const baseRowsRaw = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];

  // ✅ cria índice estável p/ checkbox (não quebra com filtros)
  const baseRows = baseRowsRaw.map((r, i) => Object.assign({}, r, { __baseIdx: i }));

  // ✅ lê filtros do modal
  const selLojaEl = document.getElementById("itensIrregDetFiltroLoja");
  const selTimeEl = document.getElementById("itensIrregDetFiltroTime");
  const selLoja = selLojaEl ? String(selLojaEl.value || "").trim() : "";
  const selTime = selTimeEl ? String(selTimeEl.value || "").trim() : "";

  // ✅ aplica filtros (local, sem backend)
  let rows = baseRows.slice();

  // Ordena por data mais recente -> mais antiga (dd/MM/yyyy)
  rows.sort(function(a, b){
    function toTs_(s){
      const m = String(s || "").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return 0;
      return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1])).getTime();
    }
    const ta = toTs_(a.dataTxt || a.data || "");
    const tb = toTs_(b.dataTxt || b.data || "");
    if (tb !== ta) return tb - ta;

    // desempate por valor (maior primeiro)
    return (Number(b.valor || 0) - Number(a.valor || 0));
  });

  if (selLoja) rows = rows.filter(r => String(r.loja || "").trim() === selLoja);
  if (selTime) rows = rows.filter(r => String(r.time || "").trim() === selTime);

  // ✅ ordenação local (Data / Valor)
function parseBRDateToTs_(s) {
  s = String(s || "").trim();
  // dd/MM/yyyy
  var m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (m) {
    var d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]), 0, 0, 0, 0);
    return isNaN(d.getTime()) ? 0 : d.getTime();
  }
  // fallback
  var d2 = new Date(s);
  return isNaN(d2.getTime()) ? 0 : d2.getTime();
}

const sortCfg = window.__itensIrregDetSort || { key: "data", dir: "desc" };
const sortKey = String(sortCfg.key || "data").toLowerCase();
const sortDir = (String(sortCfg.dir || "desc").toLowerCase() === "asc") ? 1 : -1;

rows.sort(function(a, b){
  var av = 0, bv = 0;

  if (sortKey === "valor") {
    av = Number(a && a.valor || 0);
    bv = Number(b && b.valor || 0);
  } else {
    // padrão = data
    av = parseBRDateToTs_(a && a.dataTxt);
    bv = parseBRDateToTs_(b && b.dataTxt);
  }

  if (av < bv) return -1 * sortDir;
  if (av > bv) return  1 * sortDir;

  // desempate estável: valor desc
  var av2 = Number(a && a.valor || 0);
  var bv2 = Number(b && b.valor || 0);
  if (av2 < bv2) return 1;
  if (av2 > bv2) return -1;
  return 0;
});

  const fmtBRL = (v) =>
    Number(v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  // ✅ badge igual ao do sistema (ALERTA/OK/REVISAR)
  const badge = (c) => {
    const x = String(c || "").toUpperCase();
    let bg = "rgba(255,255,255,0.06)", bd = "rgba(148,163,184,0.25)", tx = "rgba(226,232,240,0.95)";
    if (x === "OK") { bg = "rgba(34,197,94,0.18)"; bd = "rgba(34,197,94,0.35)"; tx = "#14532d"; }
    if (x === "REVISAR") { bg = "rgba(245,158,11,0.20)"; bd = "rgba(245,158,11,0.40)"; tx = "#713f12"; }
    if (x === "ALERTA") { bg = "rgba(248,113,113,0.20)"; bd = "rgba(248,113,113,0.40)"; tx = "#7f1d1d"; }
    return `<span style="display:inline-flex; align-items:center; height:22px; padding:0 10px; border-radius:999px;
      border:1px solid ${bd}; background:${bg}; color:${tx}; font-weight:1000; font-size:11px;">${x || "—"}</span>`;
  };

  if (!rows.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="padding:12px; color:rgba(15,23,42,0.75); font-weight:900; font-size:12px;">
          Sem itens para os filtros selecionados.
        </td>
      </tr>`;
    return;
  }

  const grid = "1px solid rgba(2,6,23,0.22)";
  const tdBase = `padding:10px; border-bottom:${grid}; border-right:${grid};
                  color:rgba(15,23,42,0.92); font-weight:900; font-size:12px;`;

  tbody.innerHTML = rows.map((r, idx) => {
    const bg = (idx % 2 === 0) ? "rgba(226,232,240,0.92)" : "rgba(226,232,240,0.82)";
    const td = (extra) => `${tdBase} background:${bg}; ${extra || ""}`;

    // ✅ checkbox dentro da 1ª coluna (Data), sem criar coluna nova
    const checked = (window.__itensIrregDetSel && window.__itensIrregDetSel[r.__baseIdx]) ? "checked" : "";

    return `
      <tr>
        <td style="${td()}">
          <input type="checkbox"
            class="itensIrregDetChk"
            data-base-idx="${r.__baseIdx}"
            ${checked}
            style="width:14px; height:14px; margin-right:10px; vertical-align:middle; cursor:pointer;" />
          <span style="vertical-align:middle;">${r.dataTxt || "—"}</span>
        </td>

        <td style="${td("text-align:right; font-weight:1000; width:100px; min-width:100px;")}">${fmtBRL(r.valor)}</td>
        <td style="${td("font-weight:1000;")}">${r.loja || "—"}</td>
        <td style="${td("font-weight:900; width:180px; min-width:180px;")}">${r.time || "—"}</td>
        <td style="${td("font-weight:900;")}">${r.item || "—"}</td>
        <td style="${td("font-weight:900; max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;")}">${r.estabelecimento || "—"}
</td>
        <td style="${td("font-weight:1000;")}">${badge(r.conformidade || r.status || "")}</td>
        <td style="${td("border-right:none; font-weight:900; color:rgba(15,23,42,0.82); width:320px; min-width:320px;")}">${r.motivo || "—"}</td>
      </tr>
    `;
  }).join("");

  // ✅ persiste seleção ao clicar
  tbody.querySelectorAll('input.itensIrregDetChk').forEach(chk => {
    chk.onchange = function () {
      const bi = Number(this.getAttribute("data-base-idx"));
      window.__itensIrregDetSel = window.__itensIrregDetSel || {};
      if (this.checked) window.__itensIrregDetSel[bi] = true;
      else delete window.__itensIrregDetSel[bi];
    };
  });
};

window.vektorItensIrregDetSelectAll_ = function () {
  const baseRows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  if (!baseRows.length) return;

  window.__itensIrregDetSel = {};

  for (let i = 0; i < baseRows.length; i++) {
    window.__itensIrregDetSel[i] = true;
  }

  // Atualiza visualmente os checkboxes visíveis
  document.querySelectorAll("#itensIrregDetTbody input.itensIrregDetChk").forEach(chk => {
    chk.checked = true;
  });
};

window.vektorItensIrregDetDeselectAll_ = function () {
  window.__itensIrregDetSel = {};

  // Atualiza visualmente os checkboxes visíveis
  document.querySelectorAll("#itensIrregDetTbody input.itensIrregDetChk").forEach(chk => {
    chk.checked = false;
  });
};

window.vektorEnviarNotificacaoItensIrregularesSelecionados_ = function () {
  const baseRows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selMap = window.__itensIrregDetSel || {};

  const idxs = Object.keys(selMap).map(n => Number(n)).filter(n => Number.isFinite(n));
  if (!idxs.length) {
    alert("Selecione pelo menos 1 linha (checkbox) para enviar.");
    return;
  }

  const selected = idxs
    .map(i => baseRows[i])
    .filter(Boolean)
    .map(r => ({
      dataTxt: r.dataTxt || "",
      valor: r.valor || 0,
      loja: r.loja || "",
      time: r.time || "",
      estabelecimento: r.estabelecimento || "",
      item: r.item || "",
      conformidade: (r.conformidade || r.status || ""),
      motivo: r.motivo || ""
    }));

  // loading padrão do Vektor (já existe no seu projeto)
  try {
    window.vektorGlobalLoadingShow_(
      "Enviando Notificações…",
      "Aguarde: estamos enviando os e-mails para lojas e regionais."
    );
  } catch (e) {}

  google.script.run
    .withSuccessHandler(function (res) {
      try { window.vektorGlobalLoadingHide_(); } catch (e) {}

      if (!res || !res.ok) {
        alert((res && res.error) ? res.error : "Falha ao enviar e-mails.");
        return;
      }

      // ✅ limpa seleção após sucesso (evita reenvio acidental / “spam”)
      window.__itensIrregDetSel = {};
      // re-render para desmarcar visualmente
      try { window.vektorRenderItensIrregDetalhamentoFromCache_(); } catch (e) {}

      alert("Emails enviados com sucesso.");
    })
    .withFailureHandler(function (err) {
      try { window.vektorGlobalLoadingHide_(); } catch (e) {}
      const msg = (err && err.message) ? err.message : String(err || "Erro");
      alert("Falha ao enviar e-mails: " + msg);
    })
    .dispararNotificacaoItensIrregularesSelecionados(selected);
};

window.vektorClosePreviewItensIrregDet_ = function () {
  const m = document.getElementById("itensIrregPreviewModal");
  if (m) m.style.display = "none";
};

window.vektorOpenPreviewItensIrregDet_ = function () {
  const m = document.getElementById("itensIrregPreviewModal");
  const body = document.getElementById("itensIrregPreviewBody");
  if (!m || !body) return;

  const baseRows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selMap = window.__itensIrregDetSel || {};
  const idxs = Object.keys(selMap).map(n => Number(n)).filter(n => Number.isFinite(n));

  if (!idxs.length) {
    body.innerHTML = `<div style="font-weight:900; color:rgba(226,232,240,0.92);">
      Nenhuma linha selecionada. Marque os checkboxes na tabela para ver a prévia.
    </div>`;
    m.style.display = "block";
    return;
  }

  const selected = idxs.map(i => baseRows[i]).filter(Boolean);

  const sumBRL = (n) => {
    try { return Number(n || 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" }); }
    catch(e){ return String(n || 0); }
  };

  function addAgg(map, key, valor) {
    key = String(key || "—").trim() || "—";
    if (!map[key]) map[key] = { key, qtd: 0, total: 0 };
    map[key].qtd += 1;
    map[key].total += Number(valor || 0);
  }

  const byTime = {};
  const byLoja = {};

  selected.forEach(r => {
    addAgg(byTime, r.time, r.valor);
    addAgg(byLoja, r.loja, r.valor);
  });

  const arrTime = Object.values(byTime).sort((a,b) => b.total - a.total);
  const arrLoja = Object.values(byLoja).sort((a,b) => b.total - a.total);

  const mkTable = (title, arr) => {
    const rows = arr.map(x => `
      <tr>
        <td style="padding:10px; border-top:1px solid rgba(148,163,184,0.18); font-weight:900;">${x.key}</td>
        <td style="padding:10px; border-top:1px solid rgba(148,163,184,0.18); text-align:right; font-weight:1000;">${x.qtd}</td>
        <td style="padding:10px; border-top:1px solid rgba(148,163,184,0.18); text-align:right; font-weight:1000;">${sumBRL(x.total)}</td>
      </tr>
    `).join("");

    return `
      <div style="margin-top:12px; font-weight:1000; color:#fff;">${title}</div>
      <div style="margin-top:8px; border:1px solid rgba(148,163,184,0.18); border-radius:12px; overflow:hidden;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:rgba(255,255,255,0.06);">
              <th style="text-align:left; padding:10px; font-size:12px; color:rgba(226,232,240,0.85);">Grupo</th>
              <th style="text-align:right; padding:10px; font-size:12px; color:rgba(226,232,240,0.85);">Qtde</th>
              <th style="text-align:right; padding:10px; font-size:12px; color:rgba(226,232,240,0.85);">Total</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  };

  const totalSel = selected.length;
  const totalValor = selected.reduce((acc, r) => acc + Number(r.valor || 0), 0);

  body.innerHTML = `
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <div style="padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.18);
                  background:rgba(255,255,255,0.04);">
        <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Linhas selecionadas</div>
        <div style="font-size:18px; color:#fff; font-weight:1000;">${totalSel}</div>
      </div>

      <div style="padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.18);
                  background:rgba(255,255,255,0.04);">
        <div style="font-size:12px; color:rgba(226,232,240,0.75); font-weight:900;">Valor total selecionado</div>
        <div style="font-size:18px; color:#fff; font-weight:1000;">${sumBRL(totalValor)}</div>
      </div>
    </div>

    ${mkTable("Resumo por Time", arrTime)}
    ${mkTable("Resumo por Loja", arrLoja)}
  `;

  m.style.display = "block";
};

window.vektorExportRadarItensIrregularesCSV = function() {
  const rows = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  if (!rows.length) {
    alert("Sem dados para exportar.");
    return;
  }

  const esc = (s) => `"${String(s || "").replace(/"/g, '""')}"`;
  const header = ["Data", "Valor (R$)", "Loja", "Time", "Item Comprado", "Conformidade", "Motivo"];
  const csv = [header.map(esc).join(",")].concat(rows.map(r => {
    return [
      r.dataTxt || "",
      (Number(r.valor || 0)).toFixed(2).replace(".", ","),
      r.loja || "",
      r.time || "",
      r.item || "",
      r.conformidade || "",
      r.motivo || ""
    ].map(esc).join(",");
  })).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "itens_irregulares.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 500);
};

window.vektorRenderItensIrregDetalhamentoModal_ = function() {
  const tbody = document.getElementById("itensIrregDetTbody");
  if (!tbody) return;

  const base = Array.isArray(window.__itensIrregLastRows) ? window.__itensIrregLastRows : [];
  const selLoja = (document.getElementById("itensIrregDetFilterLoja") || {}).value || "";
  const selTime = (document.getElementById("itensIrregDetFilterTime") || {}).value || "";

  let rows = base.slice();
  if (selLoja) rows = rows.filter(r => String(r.loja || "").trim() === selLoja);
  if (selTime) rows = rows.filter(r => String(r.time || "").trim() === selTime);

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(226,232,240,0.75); font-weight:900; font-size:12px;">Sem itens para os filtros selecionados.</td></tr>`;
    return;
  }

  const fmtBRL = (v) => Number(v||0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });

  tbody.innerHTML = rows.map(r => {
    const conf = String(r.conformidade || "");
    const confBg =
      (conf.toUpperCase() === "ALERTA") ? "rgba(239,68,68,0.20)" :
      (conf.toUpperCase() === "REVISAR") ? "rgba(251,191,36,0.18)" :
      "rgba(34,197,94,0.16)";

    return `
      <tr style="border-bottom:1px solid rgba(148,163,184,0.10);">
        <td style="padding:10px; color:rgba(226,232,240,0.90); font-size:12px; font-weight:800;">${r.dataTxt || ""}</td>
        <td style="padding:10px; color:#fff; font-size:12px; font-weight:900; text-align:right;">${fmtBRL(r.valor)}</td>
        <td style="padding:10px; color:#fff; font-size:12px; font-weight:900;">${r.loja || "—"}</td>
        <td style="padding:10px; color:rgba(226,232,240,0.92); font-size:12px; font-weight:800;">${r.time || "—"}</td>
        <td style="padding:10px; color:rgba(226,232,240,0.92); font-size:12px; font-weight:800;">${(r.item || "")}</td>
        <td style="padding:10px; color:#fff; font-size:12px; font-weight:1000; background:${confBg}; border-radius:8px;">${conf}</td>
        <td style="padding:10px; color:rgba(226,232,240,0.86); font-size:12px; font-weight:800;">${(r.motivo || "")}</td>
      </tr>
    `;
  }).join("");
};

// ===============================
// HELPERS (Radar / Itens Irregulares)
// ===============================
function vektorIsoDateToBR_(iso) {
  // iso esperado: "yyyy-mm-dd" (input type="date")
  if (!iso || typeof iso !== "string") return "";
  const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return "";
  return `${m[3]}/${m[2]}/${m[1]}`; // dd/MM/yyyy
}

function setRadarActiveBtn_(modo) {
  const map = {
    "7d": "radarBtn7d",
    "ciclo": "radarBtnCiclo",
    "full": "radarBtnFull"
  };

  // reseta todos
  ["radarBtn7d", "radarBtnCiclo", "radarBtnFull"].forEach(id => {
    const b = document.getElementById(id);
    if (!b) return;
    b.style.background = "rgba(255,255,255,0.06)";
    b.style.color = "#ffffff";
  });

  // aplica ativo
  const activeId = map[String(modo || "7d").toLowerCase()] || "radarBtn7d";
  const a = document.getElementById(activeId);
  if (a) {
    a.style.background = "#16a34a";   // verde
    a.style.color = "#04110a";        // texto escuro
  }
}

function renderRadarHeatmap_(lojas) {
  const heat = document.getElementById("radarHeatmap");
  if (!heat) return;

  const metrics = [
    { key: "casos", label: "CASOS" },
    { key: "avgScore", label: "AVG" },
    { key: "maxScore", label: "MAX" },
    { key: "pendRate", label: "PEND" },
    { key: "avgQtdDia", label: "QTD/D" },
    { key: "maxValor", label: "VALOR" }
  ];

  const series = {};
  metrics.forEach(m => { series[m.key] = lojas.map(x => Number(x[m.key] || 0)); });

  const corr = (a, b) => {
    const n = Math.min(a.length, b.length);
    if (n < 3) return 0;
    let sa = 0, sb = 0;
    for (let i = 0; i < n; i++) { sa += a[i]; sb += b[i]; }
    const ma = sa / n, mb = sb / n;

    let num = 0, da = 0, db = 0;
    for (let i = 0; i < n; i++) {
      const xa = a[i] - ma;
      const xb = b[i] - mb;
      num += xa * xb;
      da += xa * xa;
      db += xb * xb;
    }
    const den = Math.sqrt(da * db);
    return den ? (num / den) : 0;
  };

  // Cores fortes e “realistas”: azul forte <-> cinza escuro <-> vermelho forte
  const colorFor = (v) => {
    v = Math.max(-1, Math.min(1, v));
    if (v >= 0) {
      const t = v;
      return `rgba(239,68,68,${0.22 + 0.78 * t})`; // vermelho forte
    } else {
      const t = Math.abs(v);
      return `rgba(59,130,246,${0.22 + 0.78 * t})`; // azul forte
    }
  };

  // Grid compacto, sem “buracos” grandes
  const n = metrics.length;
  let html = `
    <div style="display:grid; grid-template-columns: 70px repeat(${n}, 56px); gap:2px; align-items:center;">
      <div></div>
      ${metrics.map(m => `<div style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900; text-align:center;">${m.label}</div>`).join("")}
  `;

  for (let i = 0; i < n; i++) {
    html += `<div style="color:rgba(226,232,240,0.9); font-size:11px; font-weight:900; padding-left:2px;">${metrics[i].label}</div>`;
    for (let j = 0; j < n; j++) {
      if (j <= i) {
        // triangular (meia matriz), mas sem espaçamento absurdo
        html += `<div style="width:56px; height:44px; background:rgba(2,6,23,0.35); border:1px solid rgba(148,163,184,0.10); border-radius:8px;"></div>`;
      } else {
        const v = corr(series[metrics[i].key], series[metrics[j].key]);
        const txt = (Math.round(v * 100) / 100).toFixed(2);
        html += `
          <div style="width:56px; height:44px; border-radius:8px; background:${colorFor(v)};
                      border:1px solid rgba(15,23,42,0.25); display:flex; align-items:center; justify-content:center;">
            <div style="font-size:12px; font-weight:1000; color:rgba(255,255,255,0.95);
            text-shadow:0 2px 6px rgba(0,0,0,0.85);">${txt}</div>
          </div>`;
      }
    }
  }

  html += `</div>`;
  heat.innerHTML = html;
}

function radarCorr_(a, b) {
  const n = Math.min(a.length, b.length);
  if (n < 3) return 0;

  let sa = 0, sb = 0;
  for (let i = 0; i < n; i++) { sa += a[i]; sb += b[i]; }
  const ma = sa / n, mb = sb / n;

  let num = 0, da = 0, db = 0;
  for (let i = 0; i < n; i++) {
    const xa = a[i] - ma;
    const xb = b[i] - mb;
    num += xa * xb;
    da += xa * xa;
    db += xb * xb;
  }
  const den = Math.sqrt(da * db);
  return den ? (num / den) : 0;
}

function radarStrengthLabel_(vAbs) {
  if (vAbs < 0.20) return "irrelevante";
  if (vAbs < 0.40) return "fraca";
  if (vAbs < 0.60) return "moderada";
  if (vAbs < 0.80) return "forte";
  return "muito forte";
}

function renderRadarInsights_(lojas) {
  const el = document.getElementById("radarInsights");
  if (!el) return;

  const nLojas = Array.isArray(lojas) ? lojas.length : 0;
  if (nLojas < 3) {
    el.innerHTML =
      "<div style='font-weight:900;color:#fff;margin-bottom:6px;'>Leitura automática do Radar</div>" +
      "<div style='opacity:0.85;'>Amostra pequena (" + nLojas + " lojas). A correlação pode ficar instável; use como sinal.</div>";
    return;
  }

  const metrics = [
    { key: "casos", label: "CASOS" },
    { key: "avgScore", label: "AVG" },
    { key: "maxScore", label: "MAX" },
    { key: "pendRate", label: "PEND" },
    { key: "avgQtdDia", label: "QTD/D" },
    { key: "maxValor", label: "VALOR" }
  ];

  const series = {};
  metrics.forEach(m => { series[m.key] = lojas.map(x => Number(x[m.key] || 0)); });

  let bestPos = { v: -999, a: null, b: null };
  let bestNeg = { v:  999, a: null, b: null };
  let absSum = 0, absCount = 0;

  for (let i = 0; i < metrics.length; i++) {
    for (let j = i + 1; j < metrics.length; j++) {
      const a = metrics[i], b = metrics[j];
      const v = radarCorr_(series[a.key], series[b.key]);
      const av = Math.abs(v);
      absSum += av; absCount++;
      if (v > bestPos.v) bestPos = { v, a, b };
      if (v < bestNeg.v) bestNeg = { v, a, b };
    }
  }

  const avgAbs = absCount ? (absSum / absCount) : 0;
  const trend =
    (avgAbs < 0.20) ? "As métricas estão pouco acopladas entre si (correlações em geral fracas)." :
    (avgAbs < 0.40) ? "Há sinais de relação entre métricas, mas ainda majoritariamente fracos/moderados." :
    "As métricas estão bem conectadas (correlações moderadas/fortes dominantes).";

  const fmt = (v) => (Math.round(v * 100) / 100).toFixed(2);

  const posAbs = Math.abs(bestPos.v);
  const negAbs = Math.abs(bestNeg.v);

    el.innerHTML =
    "<div style='font-weight:900;color:#fff;margin-bottom:6px;'>Leitura automática do Radar</div>" +
    "<div style='opacity:0.85; margin:-2px 0 8px 0; line-height:1.35;'>" +
        "Base da análise: <b>" + nLojas + "</b> loja(s)" +
      "</div>" +

    "<div style='opacity:0.9; line-height:1.45; margin-bottom:6px;'>" +
      "Este quadro mostra <b>como as métricas se comportaram juntas</b> no período. " +
      "Use como <b>triagem operacional</b>: ele sugere onde vale olhar primeiro — não conclui irregularidade." +
    "</div>" +

    "<div style='opacity:0.9; line-height:1.45; margin-bottom:6px;'>" +
      "<b>Como ler:</b> <b>positivo</b> = tendem a subir juntas · <b>negativo</b> = quando uma sobe, a outra tende a cair. " +
      "Quanto mais forte a correlação, mais consistente o padrão no período." +
    "</div>" +

    "<div style='opacity:0.9;'>" + trend + "</div>" +

    "<div style='margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;'>" +

      "<div style='padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.18);background:rgba(239,68,68,0.10);'>" +
        "<div style='font-weight:900;color:#fff;margin-bottom:4px;'>Mais alinhadas (positivo)</div>" +
        "<div style='opacity:0.9; line-height:1.35;'><b>" + bestPos.a.label + "</b> × <b>" + bestPos.b.label + "</b> = <b>" + fmt(bestPos.v) + "</b> (" + radarStrengthLabel_(posAbs) + ")</div>" +
        "<div style='margin-top:6px; font-size:11px; opacity:0.85; line-height:1.35;'>" +
          "Lojas onde <b>" + bestPos.a.label + "</b> sobe tendem a vir com <b>" + bestPos.b.label + "</b> mais alto no período. " +
          "Priorize estas lojas no ranking à direita e valide no detalhe se necessário." +
        "</div>" +
      "</div>" +

      "<div style='padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.18);background:rgba(59,130,246,0.12);'>" +
        "<div style='font-weight:900;color:#fff;margin-bottom:4px;'>Mais inversas (negativo)</div>" +
        "<div style='opacity:0.9; line-height:1.35;'><b>" + bestNeg.a.label + "</b> × <b>" + bestNeg.b.label + "</b> = <b>" + fmt(bestNeg.v) + "</b> (" + radarStrengthLabel_(negAbs) + ")</div>" +
        "<div style='margin-top:6px; font-size:11px; opacity:0.85; line-height:1.35;'>" +
          "Quando <b>" + bestNeg.a.label + "</b> aumenta, <b>" + bestNeg.b.label + "</b> tende a cair no período. " +
          "Use isso para entender <b>o que está puxando o risco</b> (volume, valor, pendência, frequência)." +
        "</div>" +
      "</div>" +

    "</div>" +

    "<div style='margin-top:10px;font-size:12px;opacity:0.85; line-height:1.35;'>" +
      "<b>Nota:</b> correlação indica associação (não causalidade). " +
      "Ação recomendada: selecione a loja em <b>Lojas mais próximas</b> e, se precisar confirmar, use o chat <b>“Possível uso irregular”</b> para ver transações e regras." +
    "</div>";

}

function renderRadarRanking_(lojas, detalhesPorLoja) {
  const rank = document.getElementById("radarRanking");
  if (!rank) return;

  lojas = Array.isArray(lojas) ? lojas : [];
  detalhesPorLoja = (detalhesPorLoja && typeof detalhesPorLoja === "object") ? detalhesPorLoja : {};

  const esc = (s) => String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");

  if (!lojas.length) {
    rank.innerHTML = `<div style="opacity:0.85; color:rgba(226,232,240,0.85); font-size:12px;">Sem dados suficientes no período.</div>`;
    return;
  }

  const norm01 = (arr, v) => {
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    if (!isFinite(min) || !isFinite(max) || max === min) return 0;
    return (v - min) / (max - min);
  };

  const arrMax = lojas.map(x => Number(x.maxScore || 0));
  const arrCasos = lojas.map(x => Number(x.casos || 0));
  const arrPend = lojas.map(x => Number(x.pendRate || 0));

  // tooltip: tabela (1 linha)
  const buildTooltipTable = (row) => {
    if (!row) {
      return "<div style='font-size:12px;opacity:0.9;'>Sem detalhe transacional disponível para esta loja no período.</div>";
    }

    const th = "padding:6px 8px;font-size:11px;text-align:left;border-bottom:1px solid rgba(226,232,240,0.12);white-space:nowrap;";
    const td = "padding:6px 8px;font-size:11px;border-bottom:1px solid rgba(226,232,240,0.08);white-space:nowrap;";

    // IMPORTANTE: container rolável é SÓ aqui (classe do Passo 1)
    return (
      "<div style='font-size:12px;font-weight:900;margin-bottom:6px;'>Detalhe (mesma linha do Possível uso irregular)</div>" +
      "<div class='vektor-radar-tip-scroll'>" +
        "<table style='border-collapse:collapse; width:max-content; min-width:980px;'>" +
          "<thead>" +
            "<tr style='background:rgba(255,255,255,0.06);'>" +
              "<th style='" + th + "'>Loja</th>" +
              "<th style='" + th + "'>Time</th>" +
              "<th style='" + th + "'>Data</th>" +
              "<th style='" + th + "'>Cartão</th>" +
              "<th style='" + th + "'>Estabelecimento</th>" +
              "<th style='" + th + "'>Qtd (dia)</th>" +
              "<th style='" + th + "'>Soma suma (dia)</th>".replace("S", "So") + // evita autocorreção estranha ao colar (mantém "Soma")
              "<th style='" + th + "'>Maior valor</th>" +
              "<th style='" + th + "'>Pendências</th>" +
              "<th style='" + th + "'>Score</th>" +
              "<th style='" + th + "'>Regras</th>" +
            "</tr>" +
          "</thead>" +
          "<tbody>" +
            "<tr>" +
              "<td style='" + td + "'>" + esc(row.loja) + "</td>" +
              "<td style='" + td + "'>" + esc(row.time) + "</td>" +
              "<td style='" + td + "'>" + esc(row.data) + "</td>" +
              "<td style='" + td + "'>" + esc(row.cartao) + "</td>" +
              "<td style='" + td + "'>" + esc(row.estabelecimento) + "</td>" +
              "<td style='" + td + "'>" + esc(row.qtdDia) + "</td>" +
              "<td style='" + td + "'>" + esc(row.somaDia) + "</td>" +
              "<td style='" + td + "'>" + esc(row.valor) + "</td>" +
              "<td style='" + td + "'>" + esc(row.pendenciasTxt) + "</td>" +
              "<td style='" + td + "'>" + esc(row.score) + "</td>" +
              "<td style='" + td + "; white-space:normal; min-width:240px;'>" + esc(row.regrasTxt) + "</td>" +
            "</tr>" +
          "</tbody>" +
        "</table>" +
      "</div>"
    );
  };

  const ranked = lojas.map(l => {
    const s1 = norm01(arrMax, Number(l.maxScore || 0));
    const s2 = norm01(arrCasos, Number(l.casos || 0));
    const s3 = norm01(arrPend, Number(l.pendRate || 0));
    const risco = (0.55*s1 + 0.30*s2 + 0.15*s3);
    return { ...l, risco: Number((risco * 100).toFixed(1)), _s1: s1, _s2: s2, _s3: s3 };
  }).sort((a,b) => b.risco - a.risco);

  rank.innerHTML = ranked.slice(0, 18).map((r, idx) => {
    const w = Math.max(2, Math.min(100, r.risco));
    const detalhe = detalhesPorLoja[String(r.loja)] || null;

    return `
      <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(148,163,184,0.18); border-radius:12px; padding:10px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:baseline;">
          <div style="color:#fff; font-weight:950; font-size:12px;">
            ${idx+1}. Loja ${esc(r.loja)} <span style="color:rgba(226,232,240,0.7); font-weight:800;">(${esc(r.time || "N/D")})</span>
          </div>

          <div style="color:#fff; font-weight:1000; font-size:12px; display:flex; align-items:center; gap:6px;">
            ${esc(r.risco)}

            <span class="vektor-btn-wrapper" style="display:inline-flex; align-items:center;">
              <span style="font-size:12px; font-weight:900; color:#93c5fd; cursor:help;">ⓘ</span>
              <span class="vektor-tooltip-base" style="white-space:normal; max-width:280px; line-height:1.35; background:rgba(15,23,42,0.95); border:1px solid rgba(148,163,184,0.25);">
                <b>Score composto (0–100)</b><br/>
                risco = (0.55·MAX + 0.30·CASOS + 0.15·PEND)·100<br/><br/>
                <b>Normalizados (0–1):</b><br/>
                MAX: ${(r._s1).toFixed(2)} · CASOS: ${(r._s2).toFixed(2)} · PEND: ${(r._s3).toFixed(2)}<br/><br/>
                <b>Valores:</b><br/>
                maxScore=${esc(r.maxScore)} · casos=${esc(r.casos)} · pendRate=${(Number(r.pendRate||0)*100).toFixed(1)}%
              </span>
            </span>
          </div>
        </div>

        <!-- Tooltip NA BARRA (tabela rolável, não some ao rolar) -->
        <span class="vektor-btn-wrapper vektor-radar-tip" style="display:block; margin-top:8px;">
          <div style="height:10px; border-radius:999px; background:rgba(148,163,184,0.18); overflow:hidden;">
            <div style="height:10px; width:${w}%; background:linear-gradient(90deg, rgba(239,68,68,0.85), rgba(234,179,8,0.75));"></div>
          </div>

          <span class="vektor-tooltip-base vektor-radar-tip">
            ${buildTooltipTable(detalhe)}
          </span>
        </span>

        <div style="margin-top:8px; color:rgba(226,232,240,0.85); font-size:11px;">
          casos: <b>${esc(r.casos)}</b> · maxScore: <b>${esc(r.maxScore)}</b> · pend: <b>${(Number(r.pendRate||0)*100).toFixed(1)}%</b>
        </div>
      </div>
    `;
  }).join("");
}

// ===============================
// MEUS ALERTAS (Transações por Etiqueta)
// ===============================

function vektorShowMyAlertsView_() {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");

  const envioPendView = document.getElementById("envioPendView");
  const envPendModal = document.getElementById("envPendModal");
  const homeView = document.getElementById("homeView");
  const cicloResumoView = document.getElementById("cicloResumoView");

  [chatView, radarView, feedbackView, fluxView, envioPendView, cicloResumoView].forEach(v => {
    if (!v) return;
    v.classList.add("hidden");
    v.style.display = "none";
  });
  if (envPendModal) { envPendModal.classList.add("hidden"); envPendModal.style.display = "none"; }
  if (homeView) { homeView.classList.add("hidden"); homeView.style.display = "none"; }

  if (myAlertsView) {
    myAlertsView.classList.remove("hidden");
    myAlertsView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
}

window.vektorOpenMyAlerts = function () {
  vektorShowMyAlertsView_();

  // ✅ mostra filtros admin (e-mail + área) — REGRA ÚNICA (robusta)
  try {
    const roleTxt = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "") : "");
    console.log("ROLE FRONT:", roleTxt);
    const isAdmin = (roleTxt.trim().toLowerCase() === "administrador");
    const box = document.getElementById("myAl_adminFilterBox");
    if (box) box.style.display = isAdmin ? "block" : "none";
  } catch (_) {}

  window.vektorMyAlertsInit_();
};

window.vektorMyAlertsInit_ = function () {
  // 1) carrega times/lojas
  if (typeof google === "undefined" || !google.script || !google.script.run) return;

  google.script.run
    .withSuccessHandler(function (res) {
      // ✅ NÃO falhar silencioso
      if (!res || !res.ok) {
        const msg = "Falha ao carregar Times/Lojas: " + (res && res.error ? res.error : "sem permissão ou erro desconhecido");
        if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
        return;
      }

      window.__myAl_lojasPorTime = res.lojasPorTime || {};

      // popula times
      const teamSel = document.getElementById("myAl_team");
      if (teamSel) {
        teamSel.innerHTML =
          "<option value='__ALL__'>Todos os times</option>" +
          "<option value='' disabled>Selecione…</option>";

        (res.times || []).forEach(t => {
          const op = document.createElement("option");
          op.value = t;
          op.textContent = t;
          teamSel.appendChild(op);
        });

        teamSel.onchange = function () {
          const val = String(teamSel.value || "").trim();
          const box = document.getElementById("myAl_storesBox");

          if (val === "__ALL__") {
            // ✅ Todos os times => todas as lojas (não precisa selecionar nada)
            if (box) {
              box.innerHTML =
                "<div style='opacity:0.95; font-size:12px; font-weight:900; color:#B5FF20;'>Aplicado para todas as lojas</div>" +
                "<div style='opacity:0.75; font-size:11px; margin-top:4px; color:#E2E8F0;'>Selecione um time específico para escolher lojas.</div>";

              // efeito visual de desativado
              box.style.pointerEvents = "none";
              box.style.opacity = "0.75";
            }
            return;
          }

          // ✅ Time específico => habilita e renderiza lojas
          if (box) {
            box.style.pointerEvents = "auto";
            box.style.opacity = "1";
          }
          window.vektorMyAlertsRenderStores_(window.__myAl_lojasPorTime || {}, val);
        };
      }

      // default: limpa lojas
      window.vektorMyAlertsRenderStores_(window.__myAl_lojasPorTime || {}, "");
    })
    .withFailureHandler(function (err) {
      const msg = "Erro ao carregar Times/Lojas: " + (err && err.message ? err.message : err);
      if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
    })
    .getTimesELojasParaAlertasVektor(); // Code.gs

  // 1.1) carrega etiquetas
  google.script.run
    .withSuccessHandler(function (res2) {
      // ✅ NÃO falhar silencioso
      if (!res2 || !res2.ok) {
        const msg = "Falha ao carregar Etiquetas: " + (res2 && res2.error ? res2.error : "sem permissão ou erro desconhecido");
        if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
        return;
      }

      const sel = document.getElementById("myAl_label");
      if (!sel) return;

      sel.innerHTML = "";

      // opção "todas"
      const opAll = document.createElement("option");
      opAll.value = "__ALL__";
      opAll.textContent = "Todas";
      sel.appendChild(opAll);

      (res2.etiquetas || []).forEach(function (t) {
        const op = document.createElement("option");
        op.value = t;
        op.textContent = t;
        sel.appendChild(op);
      });

      // ✅ UX: se selecionar "Todas", seleciona visualmente tudo
      sel.onchange = function () {
        const pickedAll = Array.from(sel.selectedOptions || []).some(op => op.value === "__ALL__");
        if (!pickedAll) return;
        Array.from(sel.options || []).forEach(op => { op.selected = true; });
      };
    })
    .withFailureHandler(function (err) {
      const msg = "Erro ao carregar Etiquetas: " + (err && err.message ? err.message : err);
      if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
    })
    .getEtiquetasDisponiveisVektor();

      // =========================
  // Tipo de alerta (Transações vs Pendências)
  // =========================
  try {
    const typeSel = document.getElementById("myAl_alertType");
    const subtitle = document.getElementById("myAl_subtitle");
    const hint = document.getElementById("myAl_createHint");
    const labelWrap = document.getElementById("myAl_labelWrap");

    const applyType = () => {
      const t = String(typeSel?.value || "TRANSACOES").trim();

      if (t === "PENDENCIAS") {
        if (subtitle) subtitle.textContent = "Alertas de Pendências por Lojas e Times (com histórico e execução programada), disparado sempre em dias úteis.";
        if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Valor, Estabelecimento, Titular, Pendências).";
        if (labelWrap) labelWrap.style.display = "none";
      } else {
        if (subtitle) subtitle.textContent = "Alertas de Transações por Lojas, Times e Tags (com histórico e execução programada), disparado sempre em dias úteis.";
        if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Estabelecimento, Valor, Etiqueta, Descrição).";
        if (labelWrap) labelWrap.style.display = "block";
      }
    };

    if (typeSel) {
      typeSel.onchange = function () {
        // ao trocar tipo, limpa edição (evita editar pendências como transações)
        window.__myAl_editingAlertId = "";
        const btn = document.getElementById("myAl_saveBtn");
        if (btn) btn.textContent = "Criar alerta";
        applyType();
      };
    }

    applyType();
  } catch (_) {}

  // ✅ Filtros Admin: popular "Área" + atualizar lista ao mudar filtros
  try {
    const roleTxt = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "") : "");
    const isAdmin = (roleTxt.trim().toLowerCase() === "administrador");

    const emailInp = document.getElementById("myAl_adminEmail");
    const roleSel  = document.getElementById("myAl_adminRole");

    if (emailInp) emailInp.oninput = function () { window.vektorMyAlertsRefresh(); };
    if (roleSel)  roleSel.onchange = function () { window.vektorMyAlertsRefresh(); };

    // popula as áreas só para Admin
    if (isAdmin && roleSel && typeof google !== "undefined" && google.script && google.script.run) {
      roleSel.innerHTML = "<option value=''>Todas as áreas</option>";

      google.script.run
        .withSuccessHandler(function (r) {
          if (!r || !r.ok) return;
          (r.roles || []).forEach(function (name) {
            const op = document.createElement("option");
            op.value = name;
            op.textContent = name;
            roleSel.appendChild(op);
          });
        })
        .withFailureHandler(function (err) {
          const msg = "Erro ao carregar Áreas (Admin): " + (err && err.message ? err.message : err);
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
        })
        .getRolesParaFiltroAlertasVektor();
    }
  } catch (_) {}

  // 2) carrega lista
  window.vektorMyAlertsRefresh();
};

window.vektorMyAlertsRenderStores_ = function (map, time) {
  const box = document.getElementById("myAl_storesBox");
  if (!box) return;

  const lojas = (time && map && Array.isArray(map[time])) ? map[time] : [];

  if (!time || time === "__ALL__") {
    box.innerHTML = "<div style='opacity:0.8; font-size:12px;'>Selecione um time para listar as lojas.</div>";
    return;
  }

  if (!lojas.length) {
    box.innerHTML = "<div style='opacity:0.8; font-size:12px;'>Nenhuma loja encontrada para esse time.</div>";
    return;
  }

  box.innerHTML = "";

  // ✅ Selecionar todas
  const wrapAll = document.createElement("label");
  wrapAll.style.display = "flex";
  wrapAll.style.alignItems = "center";
  wrapAll.style.gap = "8px";
  wrapAll.style.fontSize = "12px";
  wrapAll.style.marginBottom = "10px";
  wrapAll.style.fontWeight = "900";

  const cbAllEl = document.createElement("input");
  cbAllEl.type = "checkbox";
  cbAllEl.id = "myAl_store_all";

  const cbAllTxt = document.createElement("span");
  cbAllTxt.style.opacity = "0.95";
  cbAllTxt.textContent = "Selecionar todas";

  wrapAll.appendChild(cbAllEl);
  wrapAll.appendChild(cbAllTxt);
  box.appendChild(wrapAll);

  const cbAll = cbAllEl;

  if (cbAll) {
    cbAll.addEventListener("change", function () {
      const on = !!cbAll.checked;
      box.querySelectorAll("input[type='checkbox'][data-loja]").forEach(function(cb){
        cb.checked = on;
      });
    });
  }

  // ✅ lista de lojas (aceita string OU objeto {codigo,nome})
  lojas.forEach(function (l) {
    var codigo = "";
    var nome = "";

    if (l && typeof l === "object") {
      codigo = String(l.codigo || l.loja || l.lojaNum || "").trim();
      nome = String(l.nome || l.descricao || "").trim();
    } else {
      codigo = String(l || "").trim();
    }

    if (!codigo) return;

    const id = "myAl_store_" + String(codigo).replace(/\W+/g, "_");
    const row = document.createElement("label");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "8px";
    row.style.fontSize = "12px";
    row.style.marginBottom = "6px";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.id = id;
    input.setAttribute("data-loja", codigo);

    const span = document.createElement("span");
    span.style.opacity = "0.95";
    span.textContent = nome ? (codigo + " — " + nome) : codigo;

    row.appendChild(input);
    row.appendChild(span);
    box.appendChild(row);
  });

  // Se desmarcar qualquer uma, desmarca “todas”
  box.querySelectorAll("input[type='checkbox'][data-loja]").forEach(function(cb){
    cb.addEventListener("change", function(){
      if (!cb.checked && cbAll) cbAll.checked = false;
      if (cb.checked && cbAll) {
        const items = box.querySelectorAll("input[type='checkbox'][data-loja]");
        const allChecked = Array.from(items).every(function(x){ return !!x.checked; });
        cbAll.checked = allChecked;
      }
    });
  });
};

window.vektorMyAlertsCreate = function () {
  const status = document.getElementById("myAl_createStatus");
  const setStatus = (t) => { if (status) status.textContent = String(t || ""); };

  try {
    const email = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
    const role  = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "").trim() : "");

    const freq = (document.getElementById("myAl_freq")?.value || "DAILY").trim();

    // Janela: se vazio -> 30
    const winRaw = String(document.getElementById("myAl_windowDays")?.value || "").trim();
    const windowDays = Number(winRaw || 30) || 30;

    // Time / Grupo
    const time = (document.getElementById("myAl_team")?.value || "").trim();

    // Horário (HH:mm) - obrigatório e restrito
    const allowedTimes = ["11:30", "16:00"];
    const sendAt = String(document.getElementById("myAl_sendAt")?.value || "").trim(); // ✅ FIX

    // Tipo de alerta
    const alertType = String(document.getElementById("myAl_alertType")?.value || "TRANSACOES").trim();

    // Etiquetas
    const etiquetas = [];
    const labelEl = document.getElementById("myAl_label");
    if (labelEl) {
      if (labelEl.tagName === "SELECT" && labelEl.multiple) {
        Array.from(labelEl.selectedOptions || []).forEach(op => {
          const v = String(op.value || "").trim();
          if (v) etiquetas.push(v);
        });
      } else {
        const v = String(labelEl.value || "").trim();
        if (v) etiquetas.push(v);
      }
    }

    const isAll = etiquetas.includes("__ALL__");
    const etiquetasFinal = isAll ? [] : etiquetas.filter(x => x && x !== "__ALL__");

    // ✅ regra: Pendências não usa etiquetas
    const etiquetasFinalEff = (alertType === "PENDENCIAS") ? [] : etiquetasFinal;

    // Lojas
    const storesBox = document.getElementById("myAl_storesBox");
    const lojas = [];
    if (storesBox) {
      storesBox.querySelectorAll("input[type='checkbox'][data-loja]").forEach(cb => {
        if (cb.checked) lojas.push(cb.getAttribute("data-loja"));
      });
    }

    // Validações
    if (!email) { setStatus("Não foi possível identificar seu e-mail."); return; }
    if (!time) { setStatus("Selecione um time."); return; }

    if (time !== "__ALL__" && !lojas.length) {
      setStatus("Selecione ao menos 1 loja.");
      return;
    }

    if (windowDays < 1 || windowDays > 365) {
      setStatus("Janela de análise deve estar entre 1 e 365 dias.");
      return;
    }

    // ✅ sendAt obrigatório e restrito
    if (!sendAt) {
      setStatus("Selecione o horário do e-mail (11:30 ou 16:00).");
      return;
    }
    if (allowedTimes.indexOf(sendAt) < 0) {
      setStatus("Horário inválido. Use somente 11:30 ou 16:00.");
      return;
    }

    const editingId = window.__myAl_editingAlertId ? String(window.__myAl_editingAlertId) : "";

    // Overlay
    if (window.vektorMyAlertsShowLoading_) {
      window.vektorMyAlertsShowLoading_(
        editingId ? "Salvando edição..." : "Criando alerta...",
        "Aguarde."
      );
    }

    // Payload
    const payload = {
      email: email,
      role: role,

      // ✅ novo
      alertType: alertType,

      freq: freq,
      windowDays: windowDays,
      time: time,
      sendAt: sendAt,     // ✅ FIX
      lojas: lojas,

      // ✅ transações usam etiquetas; pendências sempre vazio
      etiquetas: etiquetasFinalEff,
      etiqueta: (etiquetasFinalEff[0] || "")
    };

    // ✅ handlers ligados à chamada real
    const runner = google.script.run
      .withSuccessHandler(function (res) {
        if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();

        if (!res || !res.ok) {
          const msg = "Falha: " + (res && res.error ? res.error : "erro desconhecido");
          setStatus(msg);
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
          return;
        }

        if (editingId) {
          setStatus("Alerta atualizado com sucesso. ID mantido: " + editingId);
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Alerta atualizado com sucesso!", "success");
          window.__myAl_editingAlertId = "";
          const btn = document.getElementById("myAl_saveBtn");
          if (btn) btn.textContent = "Criar alerta";
          const cancelBtn = document.getElementById("myAl_cancelEditBtn");
          if (cancelBtn) cancelBtn.style.display = "none";
        } else {
          setStatus("Alerta criado com sucesso. ID: " + (res.alertId || "—"));
          if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Alerta criado com sucesso!", "success");
        }

        window.vektorMyAlertsRefresh();
      })
      .withFailureHandler(function (err) {
        if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();
        const msg = "Erro: " + (err && err.message ? err.message : err);
        setStatus(msg);
        if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
      });

    // chamada REAL
    if (editingId) {
      payload.alertId = editingId;
      runner.atualizarAlertaEtiquetaVektor(payload);
    } else {
      runner.criarAlertaEtiquetaVektor(payload);
    }

  } catch (e) {
    if (window.vektorMyAlertsHideLoading_) window.vektorMyAlertsHideLoading_();
    setStatus("Erro inesperado ao salvar alerta.");
    if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Erro inesperado ao salvar alerta.", "error");
    try { console.error("vektorMyAlertsCreate error:", e); } catch(_) {}
  }
};

window.vektorMyAlertsShowLoading_ = function(title, sub){
  const ov = document.getElementById("myAl_overlay");
  const t  = document.getElementById("myAl_overlayTitle");
  const s  = document.getElementById("myAl_overlaySub");
  if (t) t.textContent = String(title || "Carregando…");
  if (s) s.textContent = String(sub || "Aguarde um instante.");
  if (ov) ov.style.display = "block";
};

window.vektorMyAlertsHideLoading_ = function(){
  const ov = document.getElementById("myAl_overlay");
  if (ov) ov.style.display = "none";
};

window.vektorMyAlertsToast_ = function(msg, kind){
  const box = document.getElementById("myAl_toast");
  const el  = document.getElementById("myAl_toastMsg");
  if (el) el.textContent = String(msg || "");

  if (box) {
    // ✅ centraliza no meio da tela do myAlertsView
    box.style.left = "50%";
    box.style.top = "50%";
    box.style.right = "auto";
    box.style.bottom = "auto";
    box.style.transform = "translate(-50%, -50%)";
    box.style.minWidth = "320px";
    box.style.textAlign = "center";

    box.style.borderColor = (kind === "error") ? "rgba(248,113,113,0.55)" : "rgba(34,197,94,0.45)";
    box.style.display = "block";
    setTimeout(()=>{ box.style.display = "none"; }, 2600);
  }
};

window.vektorMyAlertsDelete = function(alertId) {
  if (!alertId) return;

  const ok = confirm("Deseja excluir este alerta? Essa ação não poderá ser desfeita.");
  if (!ok) return;

  const email = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
  const role  = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "").trim() : "");

  window.vektorMyAlertsShowLoading_("Excluindo alerta...");

  google.script.run
    .withSuccessHandler(function(res){
      window.vektorMyAlertsHideLoading_();
      if (!res || !res.ok) {
        window.vektorMyAlertsToast_("Falha ao excluir: " + (res && res.error ? res.error : "erro desconhecido"), "error");
        return;
      }
      window.vektorMyAlertsToast_("Alerta excluído com sucesso.", "success");
      window.vektorMyAlertsRefresh();
    })
    .withFailureHandler(function(err){
      window.vektorMyAlertsHideLoading_();
      window.vektorMyAlertsToast_("Erro ao excluir: " + (err && err.message ? err.message : err), "error");
    })
    .excluirAlertaVektor({ alertId: alertId, email: email, role: role });
};

window.vektorMyAlertsCancelEdit_ = function () {
  try {
    window.__myAl_editingAlertId = "";

    const btn = document.getElementById("myAl_saveBtn");
    if (btn) btn.textContent = "Criar alerta";

    const cancelBtn = document.getElementById("myAl_cancelEditBtn");
    if (cancelBtn) cancelBtn.style.display = "none";

    const st = document.getElementById("myAl_createStatus");
    if (st) st.textContent = "Edição cancelada.";
  } catch (_) {}
};

window.vektorMyAlertsStartEdit_ = function (a) {
  if (!a || !a.alertId) return;

  window.__myAl_editingAlertId = String(a.alertId);

  // muda texto do botão
  const btn = document.getElementById("myAl_saveBtn");
  if (btn) btn.textContent = "Salvar edição";

  // ✅ mostra botão "Cancelar edição"
  const cancelBtn = document.getElementById("myAl_cancelEditBtn");
  if (cancelBtn) cancelBtn.style.display = "inline-flex";

  // status
  const st = document.getElementById("myAl_createStatus");
  if (st) st.textContent = "Editando alerta " + a.alertId + " (não será gerado novo ID).";

  // ✅ tipo de alerta + UI (subtítulo/hint/etiquetas)
  const typeSel = document.getElementById("myAl_alertType");
  const labelWrap = document.getElementById("myAl_labelWrap");
  const subtitle = document.getElementById("myAl_subtitle");
  const hint = document.getElementById("myAl_createHint");

  const t = String(a.alertType || "TRANSACOES").trim();
  if (typeSel) typeSel.value = t;

  if (t === "PENDENCIAS") {
    if (labelWrap) labelWrap.style.display = "none";
    if (subtitle) subtitle.textContent = "Alertas de Pendências por Lojas e Times (com histórico e execução programada), disparado sempre em dias úteis.";
    if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Valor, Estabelecimento, Titular, Pendências).";
  } else {
    if (labelWrap) labelWrap.style.display = "block";
    if (subtitle) subtitle.textContent = "Alertas de Transações por Lojas, Times e Tags (com histórico e execução programada), disparado sempre em dias úteis.";
    if (hint) hint.textContent = "O alerta gera uma tabela (Loja, Time, Data, Estabelecimento, Valor, Etiqueta, Descrição).";
  }

  // freq
  const freqEl = document.getElementById("myAl_freq");
  if (freqEl && a.freq) freqEl.value = a.freq;

  // janela
  const winEl = document.getElementById("myAl_windowDays");
  if (winEl) winEl.value = String(a.windowDays || 30);

  // hora
  const sendAtEl = document.getElementById("myAl_sendAt");
  if (sendAtEl) sendAtEl.value = String(a.sendAt || "").trim();

  // time (isso re-renderiza lojas)
  const teamSel = document.getElementById("myAl_team");
  if (teamSel) {
    teamSel.value = String(a.time || "").trim();
    if (typeof teamSel.onchange === "function") teamSel.onchange();
  }

  // etiquetas (multi) — ✅ só para Transações
  if (t !== "PENDENCIAS") {
    const labelEl = document.getElementById("myAl_label");
    if (labelEl && labelEl.tagName === "SELECT") {
      const raw = String(a.etiqueta || "").trim(); // "A | B | C" ou ""
      const tags = raw
        ? raw.split("|").map(s => String(s || "").trim()).filter(Boolean)
        : [];

      // limpa seleção
      Array.from(labelEl.options || []).forEach(op => { op.selected = false; });

      if (!tags.length) {
        // “todas”
        Array.from(labelEl.options || []).forEach(op => { op.selected = true; });
      } else {
        const set = {};
        tags.forEach(tg => { set[tg] = true; });
        Array.from(labelEl.options || []).forEach(op => {
          if (set[String(op.value || "").trim()]) op.selected = true;
        });
      }
    }
  }

  // lojas: precisa do DOM já renderizado
  const lojasCsv = String(a.lojasCsv || "");
  const lojas = lojasCsv ? lojasCsv.split(",").map(s => s.trim()).filter(Boolean) : [];

  if (String(a.time || "").trim() !== "__ALL__") {
    const box = document.getElementById("myAl_storesBox");
    if (box) {
      // marca checkboxes após render
      box.querySelectorAll("input[type='checkbox'][data-loja]").forEach(cb => {
        const l = cb.getAttribute("data-loja");
        cb.checked = (lojas.indexOf(l) >= 0);
      });
    }
  }

  // opcional: levar o usuário para o topo do formulário
  try { document.getElementById("myAlertsView")?.scrollTo?.(0, 0); } catch (_) {}
};

window.vektorMyAlertsRefresh = function () {
  const list = document.getElementById("myAl_list");
  if (list) {
    list.innerHTML = "<div style='color:rgba(226,232,240,0.85); font-size:12px;'>Carregando…</div>";
  }

  const email = (typeof USER_EMAIL_REPLACED !== "undefined" ? String(USER_EMAIL_REPLACED || "").trim() : "");
  const role  = (typeof USER_ROLE_REPLACED !== "undefined" ? String(USER_ROLE_REPLACED || "").trim() : "");

  // filtros admin
  const adminEmailEl = document.getElementById("myAl_adminEmail");
  const adminRoleEl  = document.getElementById("myAl_adminRole");

  const adminFilterEmail = (role === "Administrador" && adminEmailEl) ? String(adminEmailEl.value || "").trim() : "";
  const adminFilterRole  = (role === "Administrador" && adminRoleEl)  ? String(adminRoleEl.value  || "").trim() : "";

  if (typeof google === "undefined" || !google.script || !google.script.run) {
    if (list) list.innerHTML = "<div style='color:rgba(248,113,113,0.95); font-weight:800; font-size:12px;'>google.script.run indisponível.</div>";
    return;
  }

  google.script.run
    .withSuccessHandler(function (res) {
      if (!list) return;

      if (!res || !res.ok) {
        const msg = (res && res.error) ? String(res.error) : "Falha ao carregar alertas.";
        list.innerHTML = "<div style='color:rgba(248,113,113,0.95); font-weight:800; font-size:12px;'>" + msg + "</div>";
        return;
      }

      const rows = Array.isArray(res.alertas) ? res.alertas : [];
      if (!rows.length) {
        list.innerHTML = "<div style='color:rgba(226,232,240,0.85); font-size:12px;'>Nenhum alerta cadastrado.</div>";
        return;
      }

      list.innerHTML = "";

      rows.forEach(a => {
        const card = document.createElement("div");
        card.style.border = "1px solid rgba(148,163,184,0.18)";
        card.style.background = "rgba(255,255,255,0.03)";
        card.style.borderRadius = "12px";
        card.style.padding = "10px";
        card.style.color = "rgba(226,232,240,0.92)";
        card.style.fontSize = "12px";

        const timeLabel =
          (String(a.time || "").trim() === "__ALL__") ? "Todos" : (a.time || "—");

        const lojasLabel =
          (String(a.time || "").trim() === "__ALL__") ? "Todos" : String(a.lojasCount || 0);

        const etiquetaLabel =
          (a.etiquetaLabel != null && String(a.etiquetaLabel).trim() !== "")
            ? String(a.etiquetaLabel)
            : ((a.etiqueta && String(a.etiqueta).trim()) ? String(a.etiqueta).trim() : "Todas");

            const horaLabel = (a.sendAt && String(a.sendAt).trim())
          ? String(a.sendAt).trim()
          : "Imediato";

            const t = String(a.alertType || "TRANSACOES").trim();
            const tipoLbl = (a.alertTypeLabel || (t === "PENDENCIAS" ? "Pendências" : "Transações"));

            const head =
              "<div style='display:flex; justify-content:space-between; gap:10px; align-items:flex-start;'>" +
                "<div>" +
                  "<div style='font-weight:900; color:#fff; font-size:13px;'>" +
                    "ID: " + (a.alertId || "—") +
                    " &nbsp; <span style='opacity:0.85; font-weight:900;'>TIPO ALERTA:</span> " + tipoLbl +
                  "</div>" +
                  "<div style='opacity:0.85; margin-top:2px;'>" +
                    (t === "PENDENCIAS" ? "" : ("<b>Etiqueta:</b> " + etiquetaLabel + " &nbsp; ")) +
                    "<b>Time:</b> " + timeLabel +
                    " &nbsp; <b>Lojas:</b> " + lojasLabel +
                    " &nbsp; <b>Freq:</b> " + (a.freqLabel || a.freq || "—") +
                  "</div>" +

            "<div style='opacity:0.75; margin-top:2px;'>" +
              "<b>Dono:</b> " + (a.ownerEmail || "—") +
              " &nbsp; <b>Hora:</b> " + horaLabel +
              " &nbsp; <b>Última execução:</b> " + (a.lastRunAt || "—") +
            "</div>" +
            "</div>" +

            "<div style='display:flex; gap:8px; align-items:flex-start;'>" +

            // Coluna da direita
            "<div style='display:flex; flex-direction:column; gap:6px;'>" +

              "<button type='button' data-id='" + a.alertId + "' class='myAl_toggleBtn' " +
                "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#fff; font-weight:900; font-size:12px;'>" +
                (a.isActive ? "Desativar" : "Ativar") +
              "</button>" +

              // ✅ Novo botão Editar (abaixo do Desativar)
              "<button type='button' data-id='" + a.alertId + "' class='myAl_editBtn' " +
                "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(59,130,246,0.22); color:#fff; font-weight:900; font-size:12px;'>" +
                "Editar</button>" +

              "<button type='button' data-id='" + a.alertId + "' class='myAl_delBtn' " +
                "style='height:32px; padding:0 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(239,68,68,0.22); color:#fff; font-weight:900; font-size:12px;'>Excluir</button>" +

            "</div>" +
          "</div>"

        card.innerHTML = head;
        list.appendChild(card);
      });

      list.querySelectorAll(".myAl_toggleBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          google.script.run
            .withSuccessHandler(function () { window.vektorMyAlertsRefresh(); })
            .withFailureHandler(function (err) {
              const msg = "Falha ao alterar status: " + (err && err.message ? err.message : err);
              if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
            })
            .toggleAlertaEtiquetaVektor({ alertId: alertId });
        };
      });

            list.querySelectorAll(".myAl_editBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          // acha o objeto do alerta pelo id dentro de "rows"
          const a = rows.find(x => String(x.alertId) === String(alertId));
          if (!a) {
            if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_("Não foi possível localizar os dados do alerta para editar.", "error");
            return;
          }

          window.vektorMyAlertsStartEdit_(a);
        };
      });

      list.querySelectorAll(".myAl_delBtn").forEach(btn => {
        btn.onclick = function () {
          const alertId = btn.getAttribute("data-id");
          if (!alertId) return;

          if (!confirm("Deseja excluir este alerta? Essa ação não pode ser desfeita.")) return;

          google.script.run
            .withSuccessHandler(function () { window.vektorMyAlertsRefresh(); })
            .withFailureHandler(function (err) {
              const msg = "Falha ao excluir: " + (err && err.message ? err.message : err);
              if (window.vektorMyAlertsToast_) window.vektorMyAlertsToast_(msg, "error");
            })
            .excluirAlertaVektor({ alertId: alertId }); // ✅ nome correto
        };
      });
    })
    .withFailureHandler(function (err) {
      if (!list) return;
      const msg = "Falha ao carregar alertas: " + (err && err.message ? err.message : err);
      list.innerHTML = "<div style='color:rgba(248,113,113,0.95); font-weight:800; font-size:12px;'>" + msg + "</div>";
    })
    .listarAlertasUsuarioVektor({
      email: email,
      role: role,
      adminFilterEmail: adminFilterEmail,
      adminFilterRole: adminFilterRole
    });
};

// ================================
// VIEW: Valores Contabilizados
// ================================
window.__myAl_valores_last = { ok:false, rows:[], categorias:[], total:0 };


function openMyAlValoresContabilizadosView() {
  // 1) header texts
  const title = document.getElementById("myAl_title");
  const sub   = document.getElementById("myAl_subtitle");
  if (title) title.textContent = "Valores Contabilizados";
  if (sub)   sub.textContent   = "Consolidação histórica de valores por etiqueta (BaseClara) + funil por categoria.";

    // 2) header: trocar botões (canto direito) para o modo "Valores"
  const btns = document.getElementById("myAl_headerBtns");
  const type = document.getElementById("myAl_typeWrap");

  // guarda o HTML original (uma vez) para poder voltar depois
  if (btns && !window.__myAl_headerBtns_defaultHTML) {
    window.__myAl_headerBtns_defaultHTML = btns.innerHTML;
  }

  // mostra headerBtns e injeta os 3 botões aqui (em vez de ficar dentro da view)
  if (btns) {
    btns.style.display = "flex";
    btns.innerHTML = `
      <button type="button"
        onclick="openMyAlDefinicaoAlertasView()"
        style="height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(148,163,184,0.22);background:rgba(255,255,255,0.06);color:#fff;font-weight:900;font-size:12px;display:inline-flex;align-items:center;gap:8px;">
        ← Definição de Alertas
      </button>

      <button type="button"
        onclick="myAlValoresLoad_()"
        style="height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(148,163,184,0.22);background:rgba(255,255,255,0.06);color:#fff;font-weight:900;font-size:12px;display:inline-flex;align-items:center;gap:8px;">
        Aplicar
      </button>

      <button type="button"
        onclick="myAlValoresDownloadCsv()"
        style="height:34px;padding:0 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.25);background:#B5FF20;color:#000;font-weight:900;font-size:12px;display:inline-flex;align-items:center;gap:8px;">
        ⬇ Download
      </button>
    `;
  }

  // some com o seletor "Tipo de alerta" nesse modo
  if (type) type.style.display = "none";

  // 3) swap body
  const defV = document.getElementById("myAl_defView");
  const valV = document.getElementById("myAl_valoresView");

  if (defV) defV.style.display = "none";
  if (valV) valV.style.display = "block";

  // 4) init filters + load
  myAlValoresInitOnce_();
}

function myAlValLoading_(on) {
  const el = document.getElementById("myAl_valLoading");
  if (el) el.style.display = on ? "block" : "none";
}

function openMyAlDefinicaoAlertasView() {
  const title = document.getElementById("myAl_title");
  const sub   = document.getElementById("myAl_subtitle");
  if (title) title.textContent = "Definição de Alertas";
  if (sub)   sub.textContent   = "Alertas de Transações por Lojas, Times e Tags (com histórico e execução programada), disparado sempre em dias úteis.";

  const btns = document.getElementById("myAl_headerBtns");
  const type = document.getElementById("myAl_typeWrap");
  if (btns) btns.style.display = "flex";
  if (type) type.style.display = "flex";

    // restaura os botões originais do header (Valores Contabilizados + Tutorial)
  if (btns && window.__myAl_headerBtns_defaultHTML) {
    btns.innerHTML = window.__myAl_headerBtns_defaultHTML;
  }

  const defV = document.getElementById("myAl_defView");
  const valV = document.getElementById("myAl_valoresView");
  if (valV) valV.style.display = "none";
  if (defV) defV.style.display = "block";
}

let __myAl_valores_inited = false;

function myAlValoresInitOnce_(){
  if (__myAl_valores_inited) return;
  __myAl_valores_inited = true;

  const selTime  = document.getElementById("myAl_val_time");
  const selLoja  = document.getElementById("myAl_val_loja");
  const selConta = document.getElementById("myAl_val_conta");
  const dtIniEl  = document.getElementById("myAl_val_dtIni");
  const dtFimEl  = document.getElementById("myAl_val_dtFim");

  // =========================
  // helpers UI
  // =========================
  function setSelectLoading_(sel, label){
    if (!sel) return;
    sel.innerHTML = `<option value="__ALL__">${label}</option>`;
  }

  // ✅ popula contas a partir do último dataset retornado (se existir)
  function fillContasFromLast_(){
    if (!selConta) return;

    const cur = String(selConta.value || "__ALL__");
    const rows = (window.__myAl_valores_last && Array.isArray(window.__myAl_valores_last.rows))
      ? window.__myAl_valores_last.rows
      : [];

    // sem dados ainda: deixa somente "Todas"
    if (!rows.length) {
      selConta.innerHTML = `<option value="__ALL__">Todas</option>`;
      selConta.value = "__ALL__";
      return;
    }

    const seen = {};
    rows.forEach(function(r){
      const c = (r && r.conta != null) ? String(r.conta).trim() : "";
      if (c) seen[c] = true;
    });

    const contas = Object.keys(seen).sort(function(a,b){
      return String(a).localeCompare(String(b), "pt-BR");
    });

    selConta.innerHTML =
      `<option value="__ALL__">Todas</option>` +
      contas.map(c => `<option value="${escAttr_(c)}">${escHtml_(c)}</option>`).join("");

    // tenta manter o valor atual
    if (cur && Array.prototype.some.call(selConta.options, o => o.value === cur)) {
      selConta.value = cur;
    } else {
      selConta.value = "__ALL__";
    }
  }

    // ✅ NÃO MEXE no innerHTML do myAl_funilWrap (não destrói o canvas)
    function renderNeedPeriod_(){
      const tbody = document.getElementById("myAl_valoresTbody");
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
          Defina <b>Período (Início)</b> e <b>Período (Fim)</b> para carregar.
        </td></tr>`;
      }

      const hint = document.getElementById("myAl_catHint");
      if (hint) {
        hint.innerHTML = `<span style="color:rgba(226,232,240,0.75);">
          Defina o período para exibir o gráfico.
        </span>`;
      }

      const canvas = document.getElementById("myAl_catChart");
      if (canvas) {
        canvas.style.display = "none";
        try {
          const ctx0 = canvas.getContext("2d");
          ctx0 && ctx0.clearRect(0,0,canvas.width,canvas.height);
        } catch(_) {}
      }

      // mata instância anterior do chart pra parar qualquer "vida própria"
      try {
        if (window.__myAl_catChartInst) {
          window.__myAl_catChartInst.destroy();
          window.__myAl_catChartInst = null;
        }
      } catch(_) {}

          // ✅ NOVO: reseta o chart de série 12m
      const c12 = document.getElementById("myAl_serie12mChart");
      if (c12) {
        c12.style.display = "none";
        try {
          const ctx12 = c12.getContext("2d");
          ctx12 && ctx12.clearRect(0,0,c12.width,c12.height);
        } catch(_) {}
      }
      const hint12 = document.getElementById("myAl_serie12mHint");
      if (hint12) hint12.textContent = "Defina o período para exibir o gráfico.";

      try {
        if (window.__myAl_serie12mChartInst) {
          window.__myAl_serie12mChartInst.destroy();
          window.__myAl_serie12mChartInst = null;
        }
      } catch(_) {}

    const meta = document.getElementById("myAl_valoresMeta");
    if (meta) meta.textContent = "";
  }

  function canLoad_(){
    const a = dtIniEl ? String(dtIniEl.value || "").trim() : "";
    const b = dtFimEl ? String(dtFimEl.value || "").trim() : "";
    return !!(a && b);
  }

  function tryLoad_(){
    if (!canLoad_()) {
      renderNeedPeriod_();
      return;
    }
    // debounce simples
    if (window.__myAl_valores_tryload_tmr) clearTimeout(window.__myAl_valores_tryload_tmr);
    window.__myAl_valores_tryload_tmr = setTimeout(function(){
      myAlValoresLoad_();
    }, 150);
  }

  // =========================
  // Map (Time -> Lojas)
  // =========================
  let map = (window.__myAl_lojasPorTime && typeof window.__myAl_lojasPorTime === "object")
    ? window.__myAl_lojasPorTime
    : {};

  function normLojas_(arr){
    return (arr || []).map(it => {
      if (typeof it === "string") return { lojaKey: it, lojaNome: it };
      return {
        lojaKey: (it && (it.lojaKey || it.key || it.codigo || "")) || "",
        lojaNome: (it && (it.lojaNome || it.nome || it.label || it.lojaKey || "")) || ""
      };
    });
  }

  function fillTimes_(){
    if (!selTime) return;
    const times = Object.keys(map).sort((a,b)=>String(a).localeCompare(String(b), "pt-BR"));
    selTime.innerHTML =
      `<option value="__ALL__">Todos</option>` +
      times.map(t => `<option value="${escAttr_(t)}">${escHtml_(t)}</option>`).join("");
  }

  function fillLojas_(){
    if (!selLoja) return;

    const t = selTime ? (selTime.value || "__ALL__") : "__ALL__";
    let lojas = [];

    if (t === "__ALL__"){
      Object.keys(map).forEach(k => (map[k] || []).forEach(x => lojas.push(x)));
    } else {
      lojas = Array.isArray(map[t]) ? map[t] : [];
    }

    lojas = normLojas_(lojas);
    lojas.sort((a,b)=>String(a.lojaNome||"").localeCompare(String(b.lojaNome||""), "pt-BR"));

    selLoja.innerHTML =
      `<option value="__ALL__">Todas</option>` +
      lojas.map(x => `<option value="${escAttr_(x.lojaKey || "")}">${escHtml_(x.lojaNome || x.lojaKey || "")}</option>`).join("");
  }

  // =========================
  // ✅ init Conta Contábil (placeholder) + tenta popular se já houver dataset
  // =========================
  if (selConta) {
    selConta.innerHTML = `<option value="__ALL__">Todas</option>`;
    // se já tem resultado anterior (ex.: usuário voltou pra view), tenta popular
    fillContasFromLast_();
  }

  // =========================
  // ✅ Se map vazio, carrega DIRETO do backend (mesma fonte da tela principal)
  // getTimesELojasParaAlertasVektor() existe no Code.gs
  // =========================
  if (!map || Object.keys(map).length === 0) {
    setSelectLoading_(selTime, "Carregando times…");
    setSelectLoading_(selLoja, "Carregando lojas…");

    if (typeof google !== "undefined" && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function(res){
          if (!res || !res.ok) {
            setSelectLoading_(selTime, "Sem times (falha ao carregar)");
            setSelectLoading_(selLoja, "Sem lojas (falha ao carregar)");
            renderNeedPeriod_();
            return;
          }

          // backend retorna { times, lojasPorTime }, onde lojasPorTime pode ser array de strings
          const lp = res.lojasPorTime || {};
          const fixed = {};

          Object.keys(lp).forEach(function(t){
            fixed[t] = (lp[t] || []).map(function(l){
              // mantém compat com o resto do front
              return { lojaKey: String(l||""), lojaNome: String(l||"") };
            });
          });

          window.__myAl_lojasPorTime = fixed;
          map = fixed;

          fillTimes_();
          fillLojas_();

          // não carrega automaticamente sem período; mas se já estiver preenchido, carrega.
          tryLoad_();
        })
        .withFailureHandler(function(err){
          setSelectLoading_(selTime, "Sem times (erro)");
          setSelectLoading_(selLoja, "Sem lojas (erro)");
          renderNeedPeriod_();
        })
        .getTimesELojasParaAlertasVektor();
    } else {
      setSelectLoading_(selTime, "Sem times (google.script.run indisponível)");
      setSelectLoading_(selLoja, "Sem lojas (google.script.run indisponível)");
      renderNeedPeriod_();
    }
  } else {
    fillTimes_();
    fillLojas_();
  }

    // =========================
  // binds
  // =========================
  selTime && selTime.addEventListener("change", function(){
    fillLojas_();
    tryLoad_();
    try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}
  });

  selLoja && selLoja.addEventListener("change", function(){
    tryLoad_();
    try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}
  });

  // ✅ filtro Conta Contábil
  selConta && selConta.addEventListener("change", function(){
    tryLoad_();
    try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}
  });

  dtIniEl && dtIniEl.addEventListener("change", function(){
    tryLoad_();
    try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}
  });

  dtFimEl && dtFimEl.addEventListener("change", function(){
    tryLoad_();
    try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}
  });

  // ✅ IMPORTANTE: não carregar ao abrir
  renderNeedPeriod_();
}

function myAlValoresFillContasFromRows_(rows){
  const selConta = document.getElementById("myAl_val_conta");
  if (!selConta) return;

  const cur = String(selConta.value || "__ALL__");

  const seen = {};
  (rows || []).forEach(function(r){
    const c = (r && r.conta != null) ? String(r.conta).trim() : "";
    if (c) seen[c] = true;
  });

  const contas = Object.keys(seen).sort(function(a,b){
    return String(a).localeCompare(String(b), "pt-BR");
  });

  selConta.innerHTML =
    `<option value="__ALL__">Todas</option>` +
    contas.map(function(c){
      return `<option value="${escAttr_(c)}">${escHtml_(c)}</option>`;
    }).join("");

  // mantém seleção se ainda existir
  if (cur && Array.prototype.some.call(selConta.options, function(o){ return o.value === cur; })) {
    selConta.value = cur;
  } else {
    selConta.value = "__ALL__";
  }
}

function myAlValoresOnPeriodChange_(){
  // ids: ajuste para os ids reais dos seus inputs
  const iniEl = document.getElementById("myAl_val_dtIni");
  const fimEl = document.getElementById("myAl_val_dtFim");
  if (!iniEl || !fimEl) return;

  const dtIni = String(iniEl.value || "").trim();
  const dtFim = String(fimEl.value || "").trim();

  // Só carrega quando os DOIS estiverem preenchidos
  if (!dtIni || !dtFim) return;

  // (Opcional) evita disparar várias vezes seguidas
  if (window.__myAl_valores_period_tmr) clearTimeout(window.__myAl_valores_period_tmr);
  window.__myAl_valores_period_tmr = setTimeout(function(){
    myAlValoresLoad_();
  }, 200);
}

function myAlValoresClearFilters() {
  const selTime = document.getElementById("myAl_val_time");
  const selLoja = document.getElementById("myAl_val_loja");
  const selConta = document.getElementById("myAl_val_conta");
  const dtIni   = document.getElementById("myAl_val_dtIni");
  const dtFim   = document.getElementById("myAl_val_dtFim");

  // volta para "Todos/Todas" (se você usar "__ALL__" nos options)
  if (selTime) selTime.value = "__ALL__";
  if (selLoja) selLoja.value = "__ALL__";
  if (selConta) selConta.value = "__ALL__";

  // limpa período
  if (dtIni) dtIni.value = "";
  if (dtFim) dtFim.value = "";

  // limpa filtro de categoria do gráfico/tabela
  window.__myAl_valores_filterCategoria = "";

  // ❌ não chama load ao limpar: só mostra placeholder
  const tbody = document.getElementById("myAl_valoresTbody");
  if (tbody) {
    tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
      Defina <b>Período (Início)</b> e <b>Período (Fim)</b> para carregar.
    </td></tr>`;
  }

  const hint = document.getElementById("myAl_catHint");
  if (hint) hint.innerHTML = `Defina o período para exibir o gráfico.`;

  const canvas = document.getElementById("myAl_catChart");
  if (canvas) canvas.style.display = "none";

  try {
    if (window.__myAl_catChartInst) {
      window.__myAl_catChartInst.destroy();
      window.__myAl_catChartInst = null;
    }
  } catch (_) {}

  const meta = document.getElementById("myAl_valoresMeta");
  if (meta) meta.textContent = "";
}

function myAlValoresLoad_() {
  const time  = document.getElementById("myAl_val_time")?.value  || "__ALL__";
  const loja  = document.getElementById("myAl_val_loja")?.value  || "__ALL__";
  const conta = document.getElementById("myAl_val_conta")?.value || "__ALL__";
  const dtIni = document.getElementById("myAl_val_dtIni")?.value || "";
  const dtFim = document.getElementById("myAl_val_dtFim")?.value || "";

  // ✅ não chama backend sem período completo
  if (!String(dtIni || "").trim() || !String(dtFim || "").trim()) {
    myAlValLoading_(false);

    const tbody = document.getElementById("myAl_valoresTbody");
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
        Defina <b>Período (Início)</b> e <b>Período (Fim)</b> para carregar.
      </td></tr>`;
    }

    const hint = document.getElementById("myAl_catHint");
    if (hint) hint.innerHTML = `Defina o período para exibir o gráfico.`;

    // ✅ NOVO: a série 12m NÃO depende de período → carrega mesmo sem dtIni/dtFim
        try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}

        return;
  }

  // ✅ loading da página (barra “Carregando valores contabilizados…”)
  myAlValLoading_(true);

  // ✅ (opcional) overlay do MyAlerts
  try { window.vektorMyAlertsShowLoading_ && window.vektorMyAlertsShowLoading_("Carregando valores contabilizados."); } catch(_) {}

  google.script.run
    .withSuccessHandler(function(resp){
      try {
        const res0 = (resp && typeof resp === "object")
          ? resp
          : { ok:false, rows:[], categorias:[], total:0 };

        // guarda cache global
        window.__myAl_valores_last = res0;

        // ✅ preenche filtro de contas a partir do retorno real
        // (mantém a seleção se ela ainda existir)
        try {
          myAlValoresFillContasFromRows_(Array.isArray(res0.rows) ? res0.rows : []);
        } catch (_) {}

        if (!res0.ok) {
          const tb = document.getElementById("myAl_valoresTbody");
          if (tb) tb.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px;">
            ${escHtml_(res0.error || "Falha ao carregar dados.")}
          </td></tr>`;

          // esconde gráfico se falhou
          const canvas = document.getElementById("myAl_catChart");
          if (canvas) canvas.style.display = "none";
          return;
        }

        // ============================================================
        // ✅ Fallback de filtro no FRONT por Conta (se backend não filtrar)
        // ============================================================
        let res = res0;

        const contaSel = String(conta || "__ALL__");
        if (contaSel !== "__ALL__") {
          const rowsAll = Array.isArray(res0.rows) ? res0.rows : [];

          // filtra por conta
          const rowsFiltradas = rowsAll.filter(function(r){
            const c = (r && r.conta != null) ? String(r.conta).trim() : "";
            return c === contaSel;
          });

          // recalcula total
          let total = 0;
          for (let i = 0; i < rowsFiltradas.length; i++) {
            total += (Number(rowsFiltradas[i].valor || 0) || 0);
          }

          // recalcula pct nas rows
          const rowsOut = rowsFiltradas.map(function(r){
            const v = Number(r.valor || 0) || 0;
            return Object.assign({}, r, {
              pct: (total > 0 ? (v / total) : 0)
            });
          });

          // recalcula categorias (para o gráfico de barras)
          const sumCat = {};
          for (let i = 0; i < rowsOut.length; i++) {
            const cat = String(rowsOut[i].categoria || "").trim();
            if (!cat) continue;
            sumCat[cat] = (Number(sumCat[cat] || 0) || 0) + (Number(rowsOut[i].valor || 0) || 0);
          }

          const catsOut = Object.keys(sumCat).map(function(k){
            const v = Number(sumCat[k] || 0) || 0;
            return { categoria: k, valor: v, pct: (total > 0 ? (v / total) : 0) };
          }).sort(function(a,b){ return (b.valor||0) - (a.valor||0); });

          res = {
            ok: true,
            total: total,
            rows: rowsOut,
            categorias: catsOut
          };
        }

        // ✅ render: tabela + funil + gráfico de barras
        if (typeof myAlValoresRenderTable_ === "function") myAlValoresRenderTable_(res);
        if (typeof myAlValoresRenderFunil_ === "function") myAlValoresRenderFunil_(res);
        if (typeof myAlValoresRenderCategoriasBar_ === "function") myAlValoresRenderCategoriasBar_(res);

                // ✅ NOVO: render série 12 meses (total + variação)
        try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}

      } finally {
        myAlValLoading_(false);
        try { window.vektorMyAlertsHideLoading_ && window.vektorMyAlertsHideLoading_(); } catch(_) {}
      }
    })
    .withFailureHandler(function(err){
      myAlValLoading_(false);
      try { window.vektorMyAlertsHideLoading_ && window.vektorMyAlertsHideLoading_(); } catch(_) {}
      alert("Erro ao carregar Valores Contabilizados: " + (err && err.message ? err.message : err));
    })
    .getValoresContabilizadosEtiquetas({
      time: time,
      loja: loja,
      conta: conta,
      dataInicioIso: dtIni,
      dataFimIso: dtFim
    });
}

function myAlValoresRenderTable_(res) {
  const tbody = document.getElementById("myAl_valoresTbody");
  const meta  = document.getElementById("myAl_valoresMeta");
  if (!tbody) return;

  const rows = Array.isArray(res.rows) ? res.rows : [];
  const total = Number(res.total || 0) || 0;

  if (meta) meta.textContent = `Total: ${fmtBRL_(total)} | Linhas: ${rows.length}`;

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="border:1px solid #000; padding:10px; color:#000; background:#fff;">Sem dados para os filtros.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const etiqueta  = r.etiqueta || "";
    const conta     = r.conta || "";
    const categoria = r.categoria || ""; // <- vem do backend (vou ajustar no Code.gs)
    return `
      <tr data-conta="${escAttr_(conta)}" data-etiqueta="${escAttr_(etiqueta)}" data-categoria="${escAttr_(categoria)}" data-valor="${Number(r.valor||0)||0}"
          style="background:#fff; color:#000;">
        <td style="border:1px solid #000; padding:8px; text-align:left; color:#000; background:#fff;">${escHtml_(etiqueta)}</td>
        <td style="border:1px solid #000; padding:8px; text-align:left; color:#000; background:#fff;">${escHtml_(conta)}</td>
        <td style="border:1px solid #000; padding:8px; text-align:right; color:#000; background:#fff;">${fmtBRL_(r.valor || 0)}</td>
        <td style="border:1px solid #000; padding:8px; text-align:right; color:#000; background:#fff;">${fmtPct_(r.pct || 0)}</td>
      </tr>
    `;
  }).join("");

  // ✅ adiciona uma linha TOTAL (será recalculada conforme filtro)
tbody.insertAdjacentHTML("beforeend", `
  <tr id="myAl_valTotalRow" data-total="1"
      style="background:#f3f4f6; color:#000; font-weight:900;">
    <td style="border:1px solid #000; padding:8px; text-align:left;">TOTAL</td>
    <td style="border:1px solid #000; padding:8px; text-align:left;">—</td>
    <td id="myAl_totalValorCell" style="border:1px solid #000; padding:8px; text-align:right;">—</td>
    <td id="myAl_totalPctCell" style="border:1px solid #000; padding:8px; text-align:right;">100%</td>
  </tr>
`);

  // aplica filtro de categoria se já houver
  myAlValoresApplyCategoriaFilter_();
}

// aplica filtro local na tabela (não chama backend)
function myAlValoresApplyCategoriaFilter_(){
  const cat = (window.__myAl_valores_filterCategoria || "").trim();
  const tbody = document.getElementById("myAl_valoresTbody");
  if (!tbody) return;

  Array.from(tbody.querySelectorAll("tr[data-categoria]")).forEach(tr=>{
    const c = (tr.getAttribute("data-categoria") || "").trim();
    tr.style.display = (!cat || c === cat) ? "" : "none";
  });

  myAlValoresUpdateTotalRow_();
}

function myAlValoresUpdateTotalRow_(){
  const tbody = document.getElementById("myAl_valoresTbody");
  if (!tbody) return;

  const totalRow = document.getElementById("myAl_valTotalRow");
  const cellV = document.getElementById("myAl_totalValorCell");
  const cellP = document.getElementById("myAl_totalPctCell");
  if (!totalRow || !cellV || !cellP) return;

  let sum = 0;

  const trs = Array.from(tbody.querySelectorAll("tr"));
  trs.forEach(tr => {
    if (tr.getAttribute("data-total") === "1") return;
    if (tr.style.display === "none") return;

    // pega o valor real do dataset (mais confiável) ou parse da célula
    const v = Number(tr.getAttribute("data-valor") || 0) || 0;
    sum += v;
  });

  cellV.textContent = fmtBRL_(sum);
  cellP.textContent = "100%";
}

let __myAl_catChartInst = null;

function myAlValoresRenderCategoriasBar_(res){
  const canvas = document.getElementById("myAl_catChart");
  const hint   = document.getElementById("myAl_catHint");
  if (!canvas) return;

  canvas.style.display = "block";

  const cats  = Array.isArray(res && res.categorias) ? res.categorias : [];
  const total = Number((res && res.total) || 0) || 0;

  // limpa chart anterior
  try {
    if (__myAl_catChartInst) {
      __myAl_catChartInst.destroy();
      __myAl_catChartInst = null;
    }
  } catch(_) {}

  if (!cats.length) {
    if (hint) hint.textContent = "Sem dados para o gráfico.";
    const ctx0 = canvas.getContext("2d");
    ctx0 && ctx0.clearRect(0,0,canvas.width,canvas.height);
    return;
  }

  const labels = cats.map(x => String(x.categoria || ""));
  const values = cats.map(x => Number(x.valor || 0) || 0);

  // hint de filtro atual
  const sel = window.__myAl_valores_filterCategoria ? String(window.__myAl_valores_filterCategoria) : "";
  if (hint) {
    hint.innerHTML = sel
      ? `Filtro ativo: <b>${escHtml_(sel)}</b> (clique novamente na barra para limpar)`
      : `Clique em uma categoria para filtrar a tabela.`;
  }

  const ctx = canvas.getContext("2d");

  // Chart.js + DataLabels (igual você já faz em outros gráficos)
  try {
    if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
      Chart.register(ChartDataLabels);
    }
  } catch (_) {}

  __myAl_catChartInst = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Valor",
        data: values,

        // ✅ CORES PEDIDAS
        backgroundColor: "#005E27", // verde escuro
        borderColor: "#B5FF20",     // verde claro
        borderWidth: 2,

        maxBarThickness: 18,
        categoryPercentage: 0.75,
        barPercentage: 0.75
      }]
    },
    options: {
      // ✅ barras horizontais (deitadas)
      indexAxis: "y",

      responsive: true,
      maintainAspectRatio: false,

      // ✅ reduz “resize thrash” em layouts com container problemático
      resizeDelay: 150,

      // ✅ mata animações/reflows “fantasmas”
      animation: false,

      layout: {
        padding: { top: 12, right: 70, bottom: 6, left: 0 }
      },

      onClick: function(evt, elements){
        if (!elements || !elements.length) return;

        const idx = elements[0].index;
        const cat = labels[idx] || "";

        // toggle: se clicar na mesma, limpa
        const cur = window.__myAl_valores_filterCategoria ? String(window.__myAl_valores_filterCategoria) : "";
        window.__myAl_valores_filterCategoria = (cur === cat ? "" : cat);

        // aplica filtro na tabela
        myAlValoresApplyCategoriaFilter_();

        // re-render gráfico de categorias
        myAlValoresRenderCategoriasBar_(window.__myAl_valores_last || res);

        // ✅ NOVO: atualizar gráfico 12 meses conforme cluster selecionado
        try { myAlValoresLoadSerie12m_ && myAlValoresLoadSerie12m_(); } catch(_) {}
          },

      plugins: {
        legend: { display: false },

        tooltip: {
          callbacks: {
            label: function(tctx){
              const v = Number(tctx.raw || 0) || 0;
              const pct = total > 0 ? (v / total) : 0;
              return `${fmtBRL_(v)} (${fmtPct_(pct)})`;
            }
          }
        },

        // ✅ rótulos (valor + %), brancos
        datalabels: {
          color: "#ffffff",
          anchor: "end",
          align: "right",
          offset: 6,
          clamp: true,
          clip: false,
          formatter: function(value){
            const v = Number(value || 0) || 0;
            const pct = total > 0 ? (v / total) : 0;
            const brl0 = new Intl.NumberFormat("pt-BR", {
              style: "currency",
              currency: "BRL",
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(v);

            return `${brl0}\n${fmtPct_(pct)}`;
          },
          font: { weight: "700", size: 11 }
        }
      },

      scales: {
        // ✅ eixo X é o valor (BRL) no gráfico horizontal
        x: {
          ticks: {
            color: "rgba(255,255,255,0.85)",
            callback: function(v){
              const n = Number(v || 0) || 0;

              if (Math.abs(n) >= 1000000) {
                return (n / 1000000).toFixed(0) + "M";
              }

              if (Math.abs(n) >= 1000) {
                return Math.round(n / 1000) + "k";
              }

              return n;
            }
          },
          grid: { color: "rgba(148,163,184,0.18)" }
        },

        // ✅ eixo Y são as categorias (não formatar como dinheiro)
        y: {
          ticks: {
            color: "rgba(255,255,255,0.85)",
            autoSkip: false
          },
          grid: { color: "rgba(148,163,184,0.12)" }
        }
      }
    }
  });
}

function myAlValoresLoadSerie12m_(){
  const selTime  = document.getElementById("myAl_val_time");
  const selLoja  = document.getElementById("myAl_val_loja");
  const selConta = document.getElementById("myAl_val_conta");

  const hint = document.getElementById("myAl_serie12mHint");
  const canvas = document.getElementById("myAl_serie12mChart");

  const time  = selTime  ? String(selTime.value || "__ALL__") : "__ALL__";
  const loja  = selLoja  ? String(selLoja.value || "__ALL__") : "__ALL__";
  const conta = selConta ? String(selConta.value || "__ALL__") : "__ALL__";

  // categoria selecionada no gráfico de cluster (se existir)
  const catSel = (window.__myAl_valores_filterCategoria != null)
    ? String(window.__myAl_valores_filterCategoria || "").trim()
    : "";

  if (hint) hint.textContent = "Carregando…";
  if (canvas) canvas.style.display = "block";

  // mata instância anterior para evitar “travadas”
  try {
    if (window.__myAl_serie12mChartInst) {
      window.__myAl_serie12mChartInst.destroy();
      window.__myAl_serie12mChartInst = null;
    }
  } catch(_) {}

  if (!(typeof google !== "undefined" && google.script && google.script.run)) {
    if (hint) hint.textContent = "google.script.run indisponível.";
    if (canvas) canvas.style.display = "none";
    return;
  }

  google.script.run
    .withSuccessHandler(function(resp){
      const r = (resp && typeof resp === "object") ? resp : { ok:false };
      if (!r.ok) {
        if (hint) hint.textContent = r.error ? String(r.error) : "Falha ao carregar série 12m.";
        if (canvas) canvas.style.display = "none";
        return;
      }
      try {
        myAlValoresRenderSerie12m_(r);
        if (hint) hint.textContent = "";
        if (canvas) canvas.style.display = "block";
      } catch(e) {
        if (hint) hint.textContent = "Erro ao renderizar série 12m.";
        if (canvas) canvas.style.display = "none";
      }
    })
    .withFailureHandler(function(err){
      if (hint) hint.textContent = "Erro ao carregar série 12m.";
      if (canvas) canvas.style.display = "none";
    })
    .getValoresContabilizadosSerie12m({
      time: time,
      loja: loja,
      conta: conta,
      categoria: catSel,
      // mantidos só por compatibilidade (backend vai ignorar)
      dataInicioIso: "",
      dataFimIso: ""
    });
}

function myAlValoresRenderSerie12m_(serie){
  const canvas = document.getElementById("myAl_serie12mChart");
  const hint = document.getElementById("myAl_serie12mHint");
  if (!canvas) return;

  const labels = Array.isArray(serie.labels) ? serie.labels : [];
  const totais = Array.isArray(serie.totais) ? serie.totais : [];
  const varsPct = Array.isArray(serie.variacoesPct) ? serie.variacoesPct : [];

  if (!labels.length) {
    if (hint) hint.textContent = "Sem dados para a série.";
    canvas.style.display = "none";
    return;
  }

  if (hint) hint.textContent = "";

  // garante visível
  canvas.style.display = "block";

  // mata instância anterior
  try {
    if (window.__myAl_serie12mChartInst) {
      window.__myAl_serie12mChartInst.destroy();
      window.__myAl_serie12mChartInst = null;
    }
  } catch(_) {}

  const ctx = canvas.getContext("2d");

  // ✅ Plugin: desenha rótulo no centro exato das barras (dataset 0)
const vektorBarCenterLabelsPlugin = {
  id: "vektorBarCenterLabels",
  afterDatasetsDraw(chart, args, pluginOptions) {
    const dsIndex = 0; // barras = dataset 0
    const meta = chart.getDatasetMeta(dsIndex);
    if (!meta || meta.hidden) return;

    const data = chart.data.datasets[dsIndex]?.data || [];
    const ctx = chart.ctx;

    ctx.save();
    ctx.fillStyle = (pluginOptions && pluginOptions.color) ? pluginOptions.color : "#ffffff";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const fontSize = (pluginOptions && pluginOptions.fontSize) ? pluginOptions.fontSize : 11;
    const fontWeight = (pluginOptions && pluginOptions.fontWeight) ? pluginOptions.fontWeight : "900";
    ctx.font = `${fontWeight} ${fontSize}px Arial`;

    function formatK(v){
      v = Number(v || 0) || 0;
      const abs = Math.abs(v);
      if (abs >= 1000000) return "R$ " + (v/1000000).toFixed(1).replace(".", ",") + "M";
      if (abs >= 1000) return "R$ " + Math.round(v/1000) + "k";
      return "R$ " + Math.round(v);
    }

    for (let i = 0; i < meta.data.length; i++) {
      const el = meta.data[i];
      if (!el) continue;

      const v = data[i];
      if (!v) continue;

      // Para barra vertical: el.x = centro X, el.y = topo da barra, el.base = base (zero)
      const x = el.x;
      const yTop = el.y;
      const yBase = el.base;
      const y = yTop + (yBase - yTop) / 2; // ✅ centro exato da barra

      ctx.fillText(formatK(v), x, y);
    }

    ctx.restore();
  }
};

  window.__myAl_serie12mChartInst = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [
        {
          type: "bar",
          label: "Total (R$)",
          data: totais,
          borderWidth: 0,
          backgroundColor: "rgba(255,255,255,0.22)",   // barra “cinza-branco” elegante
          borderColor: "rgba(255,255,255,0.55)",
          borderWidth: 1,
          barPercentage: 0.8,
          categoryPercentage: 0.9,
          order: 1
        },
        {
          type: "line",
          label: "Variação mensal (%)",
          data: varsPct,
          yAxisID: "y2",
          tension: 0.22,
          fill: false,
          borderColor: "#38bdf8",   // azul claro brilhante (sky)
          borderWidth: 2,
          borderDash: [7, 5],       // tracejada
          pointRadius: 3,
          pointHoverRadius: 4,
          order: 2
        }
      ]
    },
    plugins: [ChartDataLabels, vektorBarCenterLabelsPlugin],
    options: {
  responsive: true,
  maintainAspectRatio: false,
  interaction: { mode: "index", intersect: false },

  // ✅ animação geral
  animation: {
    duration: 1100,
    easing: "easeOutQuart"
  },

    // ✅ animações específicas (linha desenhando ponto a ponto)
  animations: {
    // barras sobem primeiro (rápido) — sem delay
    y: {
      duration: 700,
      easing: "easeOutCubic",
      delay: function(ctx) {
        // ✅ delay só na linha (datasetIndex 1)
        if (ctx.type !== "data" || ctx.datasetIndex !== 1) return 0;
        return ctx.dataIndex * 80;
      }
    },

    // linha: aparece ponto a ponto (datasetIndex === 1)
    x: {
      type: "number",
      easing: "linear",
      duration: 900,
      delay: function(ctx) {
        if (ctx.type !== "data" || ctx.datasetIndex !== 1) return 0;
        return ctx.dataIndex * 80;
      }
    }
  },

  plugins: {
    legend: {
      labels: { color: "rgba(255,255,255,0.85)", font: { weight: "800" } }
    },
    tooltip: {
      callbacks: {
        label: function(ctx){
          const v = Number(ctx.raw || 0) || 0;
          if (ctx.datasetIndex === 0) return `${ctx.dataset.label}: ${fmtBRL_(v)}`;
          return `${ctx.dataset.label}: ${v.toFixed(1)}%`;
        }
      }
    },

    datalabels: {
        display: false
      }
  },

  scales: {
    x: {
      ticks: { color: "rgba(255,255,255,0.85)" },
      grid: { color: "rgba(148,163,184,0.14)" }
    },
    y: {
      beginAtZero: true,
      ticks: {
        color: "rgba(255,255,255,0.85)",
        callback: function(v){
          const n = Number(v || 0) || 0;

          if (Math.abs(n) >= 1000000) {
            return (n / 1000000).toFixed(0) + "M";
          }

          if (Math.abs(n) >= 1000) {
            return Math.round(n / 1000) + "k";
          }

          return n;
    }
      },
      grid: { color: "rgba(148,163,184,0.18)" }
    },
    y2: {
      position: "right",
      ticks: {
        color: "rgba(56,189,248,0.95)",
        callback: function(v){
          const n = Number(v || 0) || 0;
          return n.toFixed(0) + "%";
        }
      },
      grid: { drawOnChartArea: false }
    }
  }
}
  });
}

function myAlValoresDownloadCsv() {
  const res = window.__myAl_valores_last;
  if (!res || !res.ok) {
    try { window.vektorMyAlertsToast_ && window.vektorMyAlertsToast_("Não há dados para download.", "error"); } catch(_) {}
    return;
  }

  const rows = Array.isArray(res.rows) ? res.rows : [];
  const header = ["Etiquetas","Conta Contábil","Valor","% Valor"];
  const lines = [header.join(";")];

  rows.forEach(r => {
    lines.push([
      String(r.etiqueta || ""),
      String(r.conta || ""),
      String(Number(r.valor||0) || 0).replace(".", ","),
      String((Number(r.pct||0)*100).toFixed(2)).replace(".", ",") + "%"
    ].map(csvEsc_).join(";"));
  });

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "Vektor_Valores_Contabilizados.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ===== helpers locais (não conflitar com os seus) =====
function escHtml_(s){ return String(s==null?"":s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escAttr_(s){ return String(s==null?"":s).replace(/"/g,'&quot;'); }
function escSvg_(s){ return String(s==null?"":s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function fmtBRL_(n){ try { return (Number(n||0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); } catch(_) { return String(n||0); } }
function fmtPct_(p){ const v = Number(p||0); return (v*100).toFixed(1).replace(".",",") + "%"; }
function csvEsc_(s){ s = String(s==null?"":s); if (/[;\n"]/.test(s)) s = '"' + s.replace(/"/g,'""') + '"'; return s; }

let __myAl_barTimer = null;


// ✅ 4 — vektorShowResumoCicloView_ (corrigir: também setar display="none" nas outras views)
window.vektorShowResumoCicloView_ = function () {
  const chatView = document.getElementById("chatView");
  const radarView = document.getElementById("radarView");
  const feedbackView = document.getElementById("feedbackView");
  const myAlertsView = document.getElementById("myAlertsView");
  const fluxView = document.getElementById("fluxogramaView");
  const envView = document.getElementById("envioPendView");
  const cicloView = document.getElementById("cicloResumoView");
  const analiseGastosView = document.getElementById("analiseGastosView");

  // ✅ fecha outras views (hidden + display none)
  if (chatView) { chatView.classList.add("hidden"); chatView.style.display = "none"; }
  if (radarView) { radarView.classList.add("hidden"); radarView.style.display = "none"; }
  if (feedbackView) { feedbackView.classList.add("hidden"); feedbackView.style.display = "none"; }
  if (myAlertsView) { myAlertsView.classList.add("hidden"); myAlertsView.style.display = "none"; }
  if (fluxView) { fluxView.classList.add("hidden"); fluxView.style.display = "none"; }
  if (envView) { envView.classList.add("hidden"); envView.style.display = "none"; }
  if (analiseGastosView) { analiseGastosView.classList.add("hidden"); analiseGastosView.style.display = "none"; }

  // ✅ abre resumo do ciclo
  if (cicloView) {
    cicloView.classList.remove("hidden");
    cicloView.style.display = "block";
  }

  if (radarView) radarView.classList.remove("is-open");
};

function vektorResumoCicloNorm_(s){
  return String(s || "").trim().toLowerCase();
}

function vektorResumoCicloGetRows_(res){
  // 1) compat: se vier rows pronto, usa
  if (res && Array.isArray(res.rows) && res.rows.length) {
    return res.rows.map(r => ({
      loja: String(r.loja || ""),
      time: String(r.time || "N/D"),
      qtde: Number(r.qtde || 0),
      txCount: Number((r.txCount != null ? r.txCount : r.qtdeTransacoes) || 0),
      valor: Number(r.valor || 0)
    }));
  }

  // 2) BaseClara-only: agrega a partir de tx
  const tx = (res && Array.isArray(res.tx)) ? res.tx : [];
  const byLoja = {}; // loja -> agg

  tx.forEach(t => {
    const loja = String(t.loja || "");
    if (!loja) return;
    const time = String(t.time || "N/D");
    const valor = Number(t.valor || 0);
    const pend = Number((t.pendNF||0) + (t.pendEtiqueta||0) + (t.pendDesc||0));

    if (!byLoja[loja]) byLoja[loja] = { loja, time, qtde:0, txCount:0, valor:0 };
    byLoja[loja].qtde += pend;      // “Qtde de pendências” = soma de pendências nas transações
    byLoja[loja].txCount += 1;      // nº de transações pendentes
    byLoja[loja].valor += valor;    // valor pendente somado
    // se time variar (não deveria), mantém o último
    byLoja[loja].time = time;
  });

  return Object.keys(byLoja).map(k => byLoja[k]);
}

function vektorResumoCicloBuildOptions_(selectEl, values, allLabel){
  if (!selectEl) return;
  const vAtual = selectEl.value || "";
  selectEl.innerHTML = `<option value="">${allLabel}</option>` + values
    .map(v => `<option value="${String(v).replace(/"/g,'&quot;')}">${v}</option>`)
    .join("");
  // tenta manter seleção se ainda existir
  if (vAtual && values.includes(vAtual)) selectEl.value = vAtual;
}

function vektorResumoCicloApply_(){
  const res = window.__cicloResumoData;
  if (!res || !res.ok) return;

  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");

  const time = (selTime && selTime.value) ? selTime.value : "";
  const loja = (selLoja && selLoja.value) ? selLoja.value : "";

  // recorte detalhado (BaseClara) para tabela + IA
  const dtIniEl = document.getElementById("cicloResumo_dtIni");
  const dtFimEl = document.getElementById("cicloResumo_dtFim");
  const dtIni = dtIniEl && dtIniEl.value ? String(dtIniEl.value) : "";
  const dtFim = dtFimEl && dtFimEl.value ? String(dtFimEl.value) : "";

  let tx = (res && Array.isArray(res.tx)) ? res.tx.slice() : [];

  // compat: data pode vir como dataIso (backend) ou dataISO (front antigo)
  tx = tx.map(t => {
    const dataISO = t.dataISO || t.dataIso || "";
    return Object.assign({}, t, { dataISO });
  });

  // filtra por período (se informado) — ✅ mais rígido
  tx = tx.filter(t => {
    const d = String(t.dataISO || "");
    if ((dtIni || dtFim) && !d) return false; // se tem filtro e a tx não tem data, descarta
    if (dtIni && d < dtIni) return false;
    if (dtFim && d > dtFim) return false;
    return true;
  });

  if (time) tx = tx.filter(t => String(t.time || "N/D") === String(time));
  if (loja) tx = tx.filter(t => String(t.loja || "") === String(loja));

  // fonte única do recorte atual (IA usa isso)
  window.__cicloResumoTxFiltered = tx;

  const allRows = vektorResumoCicloGetRows_(res);

  // opções de TIME (sempre a partir do dataset total)
  const times = Array.from(new Set(allRows.map(r => r.time))).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  vektorResumoCicloBuildOptions_(selTime, times, "Todos");

  // opções de LOJA dependem do time selecionado
  const rowsByTime = time ? allRows.filter(r => r.time === time) : allRows;
  const lojas = Array.from(new Set(rowsByTime.map(r => r.loja))).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  vektorResumoCicloBuildOptions_(selLoja, lojas, "Todas");

  // aplica filtros finais (time + loja)
  let filtered = rowsByTime;
  if (loja) filtered = filtered.filter(r => r.loja === loja);

  // ✅ FALLBACK: se backend não mandou tx detalhado, mas existe pendência agregada
  // Evita a IA mentir "não existem transações pendentes" quando a página tem dados.
  if ((!window.__cicloResumoTxFiltered || window.__cicloResumoTxFiltered.length === 0) && filtered && filtered.length) {
    const temPendAgregada = filtered.some(r => Number(r.qtde || 0) > 0);
    if (temPendAgregada) {
      window.__cicloResumoTxFiltered = filtered.map(r => ({
        loja: r.loja,
        time: r.time,
        dataISO: "",           // não existe no agregado
        estabelecimento: "",
        valor: Number(r.valor || 0),
        categoria: "",
        pendTotal: Number(r.qtde || 0),
        txCount: Number(r.txCount || 0),
        _agregado: true
      }));
    }
  }

  // recalcula cards + top
  const totalLojas = new Set(filtered.map(r => r.loja)).size;
  const totalPend = filtered.reduce((acc,r)=>acc + (Number(r.qtde)||0), 0);
  const totalValor = filtered.reduce((acc,r)=>acc + (Number(r.valor)||0), 0);

  const elL = document.getElementById("cicloResumo_totalLojas");
  const elP = document.getElementById("cicloResumo_totalPend");
  const elV = document.getElementById("cicloResumo_totalValor");

  const fmtBRL = (v) => {
    try { return Number(v||0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" }); }
    catch(e){ return String(v||0); }
  };

  if (elL) elL.textContent = String(totalLojas || 0);
  if (elP) elP.textContent = String(totalPend || 0);
  if (elV) elV.textContent = fmtBRL(totalValor || 0);

  // top 10 por valor
  const top = filtered.slice().sort((a,b)=> (b.valor||0)-(a.valor||0)).slice(0,10);

  const tbody = document.getElementById("cicloResumo_tbody");
  if (tbody) {
    if (!top.length) {
      tbody.innerHTML = `<tr><td colspan="5" style="padding:10px;color:#0f172a;font-weight:900;">Nenhum resultado para o filtro.</td></tr>`;
    } else {
      tbody.innerHTML = top.map(r => `
        <tr>
          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);white-space:nowrap;">${r.loja}</td>
          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);white-space:nowrap;">${r.time}</td>

          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);text-align:right;white-space:nowrap;">
            ${Number(r.qtde||0)}
          </td>

          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);text-align:right;white-space:nowrap;">
            ${Number(r.txCount||0)}
          </td>

          <td style="padding:8px;border-top:1px solid rgba(148,163,184,0.12);text-align:right;white-space:nowrap;">
            ${fmtBRL(r.valor)}
          </td>
        </tr>
      `).join("");
    }
  }
}

window.vektorResumoCicloLimparFiltros = function(){
  const selTime = document.getElementById("cicloResumo_selTime");
  const selLoja = document.getElementById("cicloResumo_selLoja");
  if (selTime) selTime.value = "";
  if (selLoja) selLoja.value = "";
  vektorResumoCicloApply_();
};

// Render “bonito” do alerta no chat (reaproveita o padrão da sua tabela já existente)
window.vektorRenderTabelaTransacoesEtiquetaAlert_ = function (resp) {
  const rows = Array.isArray(resp.rows) ? resp.rows : [];
  const periodo = resp.periodo ? (resp.periodo.inicio + " a " + resp.periodo.fim) : "—";

  const esc = (s) => String(s ?? "").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));
  const fmt = (v) => (typeof v === "number" ? v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}) : String(v||""));

  // ==========================
  // NOVO: Pendências
  // ==========================
  if (String(resp.alertType || "") === "PENDENCIAS") {
    const tituloP = "🔔 Visual de Pendências Via Alerta do Vektor — " + (resp.alertId || "—");
    const subtP = "<div style='margin-top:4px; font-size:12px; color:#64748B; text-align:center;'>" +
      "<b>Período:</b> " + esc(periodo) +
      " &nbsp; <b>Linhas:</b> " + rows.length +
    "</div>";

    if (!rows.length) {
      return "<div class='text-sm text-slate-700'><p style='text-align:center;font-weight:bold;'>" + tituloP + "</p>" + subtP +
        "<p style='margin-top:8px; text-align:center;'>Nenhuma pendência encontrada para o filtro.</p></div>";
    }

    let h = "";
    h += "<div class='text-sm text-slate-700'>";
    h += "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + tituloP + "</p>";
    h += subtP;
    h += "<div style='overflow:auto;border:1px solid rgba(0,0,0,0.12);border-radius:10px;margin-top:10px;'>";
    h += "<table style='border-collapse:collapse;width:100%;font-size:12px;'>";
    h += "<thead><tr style='background:#B5FF20;'>";
    ["Loja","Time","Data da Transação","Valor (R$)","Estabelecimento","Titular","Pendências"].forEach(t => {
      h += "<th style='background:#B5FF20;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;position:sticky;top:0;z-index:10;'>" + esc(t) + "</th>";
    });
    h += "</tr></thead><tbody>";

    rows.slice(0, 60).forEach(r => {
      h += "<tr>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.loja) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.time) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.data) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;white-space:nowrap;'>" + esc(fmt(r.valor)) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:260px;'>" + esc(r.estabelecimento) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.titular) + "</td>";
      h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:240px;'>" + esc(r.pendencias) + "</td>";
      h += "</tr>";
    });

    h += "</tbody></table></div></div>";
    return h;
  }

  // ==========================
  // Original: Transações
  // ==========================
  const titulo = "🔔 Visual de Transações Via Alerta do Vektor — " + (resp.alertId || "—");
  const subt = "<div style='margin-top:4px; font-size:12px; color:#64748B; text-align:center;'>" +
    "<b>Período:</b> " + esc(periodo) +
    " &nbsp; <b>Etiqueta:</b> " + esc(resp.etiqueta || "—") +
    " &nbsp; <b>Linhas:</b> " + rows.length +
  "</div>";

  if (!rows.length) {
    return "<div class='text-sm text-slate-700'><p style='text-align:center;font-weight:bold;'>" + titulo + "</p>" + subt +
      "<p style='margin-top:8px; text-align:center;'>Nenhuma transação encontrada para o filtro.</p></div>";
  }

  let h = "";
  h += "<div class='text-sm text-slate-700'>";
  h += "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>";
  h += subt;
  h += "<div style='overflow:auto;border:1px solid rgba(0,0,0,0.12);border-radius:10px;margin-top:10px;'>";
  h += "<table style='border-collapse:collapse;width:100%;font-size:12px;'>";
  h += "<thead><tr style='background:#B5FF20;'>";
  ["Loja","Time","Data","Estabelecimento","Valor","Etiqueta inserida","Item comprado (descrição)"].forEach(t => {
    h += "<th style='background:#B5FF20;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;position:sticky;top:0;z-index:10;'>" + esc(t) + "</th>";
  });
  h += "</tr></thead><tbody>";

  rows.slice(0, 60).forEach(r => {
    h += "<tr>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.loja) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.time) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;white-space:nowrap;'>" + esc(r.data) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:260px;'>" + esc(r.estabelecimento) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;white-space:nowrap;'>" + esc(fmt(r.valor)) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:240px;'>" + esc(r.etiqueta) + "</td>";
    h += "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;min-width:360px;'>" + esc(r.descricao) + "</td>";
    h += "</tr>";
  });

  h += "</tbody></table></div></div>";
  return h;
};

function closeStatusVektorModal() {
  document.getElementById("statusVektorModal").style.display = "none";
}

let __vektorJaSugeriuLooker = false;
let __vektorJaSugeriuPoliticaRestricoes = false;
let __vektorJaSugeriuPoliticaUso = false;
let __vektorJaSugeriuJustificativas = false;


// Registro do plugin de rótulos do Chart.js (se estiver carregado)
if (typeof Chart !== "undefined" && typeof ChartDataLabels !== "undefined") {
  Chart.register(ChartDataLabels);
}

// ===== DADOS DO USUÁRIO (globais, vindos do Apps Script) =====

// Nome vindo do template Apps Script (Code.gs → tmpl.userName)
const USER_NAME_RAW = <?= JSON.stringify(userName || "") ?>;
const displayName = (USER_NAME_RAW || "")
  .replace(/^"+|"+$/g, "")
  .trim();
const USER_ROLE_RAW  = <?= JSON.stringify(userRole  || "") ?>;

// E-mail vindo do Apps Script (Code.gs → template.userEmail)
const USER_EMAIL_RAW = <?= JSON.stringify(userEmail || "") ?>;
const USER_EMAIL_REPLACED = (USER_EMAIL_RAW || "")
  .replace(/^"+|"+$/g, "")
  .trim();
const USER_ROLE_CLEAN     = (USER_ROLE_RAW  || "").replace(/^"+|"+$/g, "").trim();
const USER_ROLE_REPLACED = USER_ROLE_CLEAN;

// ================== MÉTRICAS VEKTOR → GOOGLE SHEETS ==================

function vektorRegistrarMetrica(
  intencao,
  msgOriginal,
  norm,
  resultado,
  topicoExtra,
  funcaoOrigem
) {
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    console.warn("google.script.run não disponível");
    return;
  }

  const payload = {
    intencao: intencao || "",
    topico: topicoExtra || "",
    mensagemOriginal: msgOriginal || "",
    norm: norm || "",
    resultado: resultado || "",
    usuarioNome: displayName || "",
    usuarioEmail: USER_EMAIL_REPLACED || "",
    loja: (window.VEKTOR_LOJA || ""),
    funcaoOrigem: funcaoOrigem || "desconhecida"
  };

  google.script.run
    .withFailureHandler(err => console.error("Falha métrica:", err))
    .registrarMetricaVektor(payload);
}

document.addEventListener("DOMContentLoaded", () => {

  if (VEKTOR_MANUTENCAO_ATIVA) return;

    let grupoNome = "";
    let grupo = "";

    const ROBOT_IMG_URL = "https://raw.githubusercontent.com/rslisboa/cartoesclara/b2c7d49969645f314f80fe7df3e0eaeb8ebaf585/ChatGPT%20Image%2012%20de%20nov.%20de%202025%2C%2011_41_54.png";

    // >>> NOVO: preencher barra de usuário
    const topUserEl = document.getElementById("vektor-user-info");
    const topClockEl = document.getElementById("vektor-clock");
    const topBuEl = document.getElementById("vektor-bu");

    const nomeParaMostrar = displayName || USER_EMAIL_REPLACED || "Usuário";
    const roleParaMostrar = USER_ROLE_CLEAN || "Acesso padrão";

    if (topUserEl) {
      topUserEl.textContent = `Login: ${nomeParaMostrar} (${roleParaMostrar})`;
    }

          if (topBuEl) {
        try {
          // não deixa ReferenceError/qualquer erro aqui derrubar o DOMContentLoaded
          var em = "";
          if (typeof USER_EMAIL_REPLACED !== "undefined" && USER_EMAIL_REPLACED != null) {
            em = "" + USER_EMAIL_REPLACED;
          }

          em = em.toLowerCase();
          em = em.replace(/^\s+|\s+$/g, "");

          if (!em) {
            topBuEl.textContent = "BU: —";
          } else if (em.indexOf("@gruposbf.com.br") !== -1 || em.indexOf("@centauro.com.br") !== -1) {
            topBuEl.textContent = "BU: Centauro";
          } else {
            topBuEl.textContent = "BU: Nike";
          }
        } catch (e) {
          // fallback silencioso: não quebra a tela
          topBuEl.textContent = "BU: —";
        }
      }

    function atualizarRelogio() {
      const agora = new Date();
      const data = agora.toLocaleDateString("pt-BR", {
        weekday: "short",
        day:    "2-digit",
        month:  "2-digit",
        year:   "numeric"
      });
      const hora = agora.toLocaleTimeString("pt-BR", {
        hour:   "2-digit",
        minute: "2-digit",
        hour12: false
      });

      if (topClockEl) {
        topClockEl.textContent = `${data} · ${hora}`;
      }
    };

    atualizarRelogio();               // primeira atualização
    setInterval(atualizarRelogio, 1000);  // atualiza todo segundo

    // ============================
// BANNER DE FERIADOS (TOPBAR)
// ============================
(function vektorAtualizarBannerFeriadosTopo() {
  try {
    var banner = document.getElementById("vektor-holiday-banner");
    if (!banner) return;

    // Hoje sem horário (evita bug de fuso)
    var hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    function dateOnly(y, m, d) {
      var dt = new Date(y, m, d);
      dt.setHours(0, 0, 0, 0);
      return dt;
    }

    function diffDias(a, b) {
      // b - a em dias
      var ms = b.getTime() - a.getTime();
      return Math.floor(ms / 86400000);
    }

    var ano = hoje.getFullYear();

    // Regras pedidas:
    // - Natal: exibir a partir de 3 dias antes (22/12 -> 25/12)
    // - Ano Novo: você quer começar dia 28/12, então offset = 4 (pra 01/01)
    var candidatos = [
                  {
              nome: "Natal",
              cor: "#B91C1C",
              data: dateOnly(ano, 11, 25),
              startOffsetDias: 3,
              endOffsetDias: 0,
              html: function (diasPara) {
                // Dia 25 exatamente
                if (diasPara === 0) {
                  return "🎄 Feliz Natal! Que o dia seja leve, alegre e cheio de boas energias!";
                }
                // Dias anteriores (22, 23, 24)
                return "🎄 Natal chegando! Desejamos um tempo de paz e alegria!";
              }
            },
      {
        nome: "Ano Novo",
        cor: "#D4AF37",
        data: dateOnly(ano + 1, 0, 1), // Jan = 0 (próximo ano)
        startOffsetDias: 4,
        endOffsetDias: 0,
        html: "✨ Ano Novo chegando! Boa virada."
      }
    ];

    var msgHtml = "";
    for (var i = 0; i < candidatos.length; i++) {
      var h = candidatos[i];
      var delta = diffDias(hoje, h.data); // dias até o feriado

      if (delta <= h.startOffsetDias && delta >= h.endOffsetDias) {
        msgHtml = "<span style='color:" + h.cor + ";'>" +
          (typeof h.html === "function" ? h.html(delta) : h.html) +
          "</span>";
        break;
      }
    }

    if (msgHtml) {
      banner.innerHTML = msgHtml;
      banner.style.display = "block";
    } else {
      banner.innerHTML = "";
      banner.style.display = "none";
    }
  } catch (e) {
    console.warn("Falha ao montar banner de feriados na topbar:", e);
  }
})();

// SAUDAÇÃO MSG INICIAL //
  function getSaudacaoPorHorario_() {
    const hora = new Date().getHours();

    if (hora >= 5 && hora < 12) return "bom dia";
    if (hora >= 12 && hora < 18) return "boa tarde";
    return "boa noite";
  }

  function renderSaudacaoVektor_() {
  const el = document.getElementById("vektorGreeting");
  if (!el) return;

  const saudacao = getSaudacaoPorHorario_();

  const nome = (typeof FIRST_NAME !== "undefined" && FIRST_NAME)
    ? FIRST_NAME
    : (typeof displayName !== "undefined" ? displayName : "");

  const prefixo = nome
    ? `Olá ${nome}, ${saudacao}!`
    : `Olá, ${saudacao}!`;

  el.innerHTML =
    `${prefixo} Esse é o <b>Vektor</b>, <b>Plataforma de Governança Financeira do Cartão Clara</b>.`;
}

  // Executa assim que o DOM estiver pronto
  document.addEventListener("DOMContentLoaded", renderSaudacaoVektor_);

  renderSaudacaoVektor_();
    
// 🔹 Mensagem inicial: CTA para abrir o guia "Como usar o Vektor"
renderBotMessage(
  "HTML:" +
  "<div class='text-sm text-slate-700' style='margin-top:8px'>" +
    "<div style='margin-bottom:8px; font-weight:800; color:#0f172a;'>Quer ver o guia rápido do Vektor?</div>" +
    "<button type='button' onclick='openAjudaVektorModal()' " +
      "style='width:100%; display:flex; align-items:center; justify-content:center; gap:8px;" +
      "padding:10px 12px; border-radius:12px; border:1px solid rgba(181,255,32,0.9);" +
      "background:#0b1220; color:#fff; font-weight:900; cursor:pointer;'>" +
      "Como usar o Vektor ❓" +
    "</button>" +
    "<div style='margin-top:8px; font-size:12px; color:#475569;'>Clique para abrir exemplos e procedimentos.</div>" +
  "</div>"
);

// 🔔 Saudaçao em outra mensagem, depois da mensagem inicial
// ✅ Só para NÃO Administrador
setTimeout(() => {

    // Se for ADM, NÃO mostra essa saudação (ADM já tem o fluxo do informativo + pergunta inicial)
    if (USER_ROLE_CLEAN === "Administrador") return;

    if (displayName) {
        // Versão com nome
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'><b>" +
            displayName +
            "</b>, como posso te ajudar hoje?</p>"
        );
    } else {
        // Versão sem nome (fallback)
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Como posso te ajudar hoje?</p>"
        );
    }
}, 2000);

setTimeout(function () {
  try {
    // ✅ Agora NÃO mostra demissões no carregamento
    window.vektorPerguntarInformacoesIniciais();
  } catch (e) {
    console.error("Erro ao disparar pergunta de info iniciais:", e);
  }
}, 2500);

      // Variáveis vindas do Apps Script (template do doGet)
      const USER_EMAIL_REPLACED = "<?= userEmail ?>";
      const USER_ROLE_REPLACED  = "<?= userRole ?>";

    /* ========= ESTADOS ========= */
    let estadoPendencias = "nenhum"; // "nenhum" | "aguardando_loja" | "aguardando_confirmacao_email" | "aguardando_email"
    let lojaPendenciasAtual = "";
    let ultimaPendenciaResumo = null; // { loja, data }
    let fluxoNovoCartao = null; // null | "aguardando_tipo_via"
    let ultimaIntencao = null;
    let origemPendenciasBloqueio = false;
    let pendenciasTimeoutId = null; // 🆕 timeout pra mensagem de outro assunto

    /* ========= ELEMENTOS UI ========= */
    const chatWindow = document.getElementById("chatWindow");
    const chatForm   = document.getElementById("chatForm");
    const userInput  = document.getElementById("userInput");
    const attachBtn = document.getElementById("attachBtn");
    const fileInputTermo = document.getElementById("fileTermo");

        // ===== Upload do Termo de Responsabilidade =====
    if (attachBtn && fileInputTermo) {

        // Garante que o input aceite apenas os formatos liberados
        fileInputTermo.accept = ".pdf,.jpg,.jpeg,.png,.heic,.HEIC";

        // Ao clicar no botão 📎, abre o seletor de arquivos
        attachBtn.addEventListener("click", () => {
            fileInputTermo.click();
        });

        // Quando o usuário escolhe o arquivo
        fileInputTermo.addEventListener("change", function () {
            const file = this.files && this.files[0];
            if (!file) return;

            // Valida tipo permitido
            const mime = file.type || "";

            // Aceita qualquer variação de JPEG e PNG, além de PDF e HEIC
            const isPdf  = mime === "application/pdf";
            const isPng  = mime === "image/png";
            const isHeic = mime.includes("heic") || mime.includes("heif");

            // Alguns navegadores enviam JPEG como image/jpg, image/pjpeg, image/jfif, etc.
            const isJpeg = mime.includes("jpeg") || mime.includes("jpg") || mime.includes("pjpeg") || mime.includes("jfif");

            // Verificação final
            if (!(isPdf || isPng || isHeic || isJpeg)) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-red-700'>Só é permitido enviar o <b>Termo de Responsabilidade</b> nos formatos PDF, JPG, JPEG, PNG ou HEIC.</p>"
                );
                this.value = "";
                return;
            }

            const reader = new FileReader();
    reader.onload = function (e) {
        const dataUrl = e.target.result || "";
        const base64  = dataUrl.split(",")[1];

        // Guarda temporariamente o arquivo do termo
        window.vektorTermoPending = {
            base64:           base64,
            mimeType:         mime,
            fileNameOriginal: file.name,
            usuarioEmail:     USER_EMAIL_REPLACED || ""
        };
        window.vektorTermoAguardandoNome = true;

        // 1) Pré-visualização (quando for imagem)
        if (mime.startsWith("image/")) {
            renderBotMessage(
                "HTML:" +
                "<div class='text-sm text-slate-700'>" +
                  "<p>Pré-visualização do Termo anexado:</p>" +
                  "<img src='" + dataUrl + "' " +
                        "alt='Pré-visualização do Termo' " +
                        "class='mt-2 max-h-64 rounded border border-slate-200' />" +
                "</div>"
            );
        } else {
            // PDF ou outro formato suportado sem preview direto
            renderBotMessage(
                "HTML:" +
                "<div class='text-sm text-slate-700'>" +
                  "<p>Arquivo PDF do Termo foi anexado (pré-visualização não disponível aqui no chat).</p>" +
                "</div>"
            );
        }

        // 2) Mensagem pedindo o nome completo (em outra bolha)
        setTimeout(function () {
            renderBotMessage(
                "HTML:" +
                "<p class='text-sm text-slate-700'>" +
                "Para concluir o registro, por favor informe seu <b>nome completo</b>." +
                "</p>"
            );
        }, 150);
    };

    reader.readAsDataURL(file);

            // limpa o input para permitir novo upload depois
            this.value = "";
        });
    }

    // =========================
// AUTOCOMPLETE VEKTOR
// =========================

// 1) Lista de intenções (VOCÊ JÁ TEM — basta mover pra cá)
const VEKTOR_INTENTS = [
  "Consultar pendências de uma loja",
  "Gerente está de férias",
  "Gerente foi demitido",
  "Sangria",
  "Gerente foi desligado",
  "Gerente mudou de loja",
  "Troca de gerente entre lojas",
  "Servicenow",
  "Como abrir chamado no servicenow?",  
  "Lojas com mais pendências do time",
  "Pendências do time",
  "Pendências da loja",
  "Time com mais pendências",
  "Vídeo de justificativas",
  "Como justificar uma transação",
  "Loja com maior valor de transações neste mês",
  "Loja com mais transações neste mês",
  "Treinamento Clara",
  "Termo de responsabilidade Clara",
  "Maiores transações do time",
  "Maiores transações da loja",
  "Maiores transações",
  "Valor da fatura atual",
  "Valor da fatura do mês passado",
  "Valor das últimas 3 faturas",
  "Valor das últimas 6 faturas",
  "Valor de todas as faturas",
  "Qual é o ciclo da fatura da Clara?",
  "Qual etiqueta usar para compra de",
  "Listagem de etiquetas cadastradas na Clara",
  "Ranking de lojas com mais transações",
  "Ranking de lojas com maior valor",
  "Ranking de times com mais transações",
  "Ranking de times com maior valor",
  "Top 3 lojas de um time",
  "Top 5 lojas do período",
  "Resumo da loja xxxx neste mês",
  "Resumo de uma loja na última semana",
  "Transações de uma loja no período",
  "Quais lojas fazem parte de um time?",
  "Resumo de um time neste mês",
  "Resumo de um time no período",
  "Time com maior valor de transações",
  "Time com maior número de transações",
  "Categorias com maior valor de transações",
  "Estabelecimentos mais usados",
  "O que posso comprar com o cartão Clara?",
  "Tipos de compra permitidos",
  "Tipos de compra proibidos",
  "Regras da Política de Uso dos Cartões Clara",
  "Quando o cartão é bloqueado?",
  "Lojas ofensoras",
  "Frequência de uso Clara para o time",
  "Frequência de uso Clara para a loja",
  "Perdi meu cartão Clara, o que fazer?",
  "Comparar fatura atual vs anterior",
  "Cartão Clara bloqueado, como resolver?",
  "Como desbloquear o cartão Clara?",
  "Meu cartão não passou, o que pode ser?",
  "Abrir relatório gerencial da Clara",
  "Como aumento o limite do cartão?",
  "Itens comprados para o time",
  "Itens comprados para a loja",
  "Itens comprados no geral",
  "Relação de saldos geral",
  "Relação de saldos do time",
  "Tabela de estornos",
  "Tabela de estornos do time",
  "Como usar bem o limite do cartão Clara?",
  "Gastos por etiquetas",
  "Quero gráficos das transações",
  "O que o Vektor pode fazer?",
  "Como anexar nota fiscal na Clara?",
  "Possível uso irregular",
  "Emissão de 1ª via",
  "Emissão de 2ª via",
  "Novo cartão Clara",
  "Como justificar compras na Clara?"
];

// 2) Normalização
function vektorNormAutocomplete(str) {
  if (!str) return "";
  return str
    .toString()
    .trim()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase();
}

// 3) Campos HTML
const vektorInput = document.getElementById("userInput");
const vektorBox   = document.getElementById("vektor-autocomplete-box");

// Estado atual do autocomplete
let vektorCurrentSuggestions = [];
let vektorSelectedIndex = -1;

// Atualiza visualmente qual item está selecionado
function vektorHighlightSelected() {
  const items = vektorBox.querySelectorAll(".vektor-autocomplete-item");
  items.forEach((el, idx) => {
    if (idx === vektorSelectedIndex) {
      el.classList.add("is-active");
      // Garante que o item visível seja mostrado
      el.scrollIntoView({ block: "nearest" });
    } else {
      el.classList.remove("is-active");
    }
  });
}

function vektorApplySuggestion(textoSugestao) {
  const sugestao = textoSugestao || "";
  const atual = vektorInput.value || "";

  // Normaliza a sugestão pra comparar com a lista de times
  const normSug = vektorNormAutocomplete(sugestao);

  // É um TIME se a sugestão bater exatamente com algum VEKTOR_TIMES normalizado
  const isTime = VEKTOR_TIMES.some(
    (t) => vektorNormAutocomplete(t) === normSug
  );

  // É uma LOJA se vier no formato "0001 - NOME" (é assim que você monta lá embaixo)
  const isLoja = /^\d{3,4}\s*-/.test(sugestao);

  // Para time/loja: NÃO apagar tudo, só trocar a última palavra digitada
  if (isTime || isLoja) {
    // remove espaços do fim
    const base = atual.replace(/\s+$/g, "");
    const m = base.match(/^(.*\s)(\S+)$/); // tudo antes + última palavra

    if (m) {
      const antes = m[1];   // frase antes da última palavra
      vektorInput.value = antes + sugestao; // substitui só a última palavra
    } else {
      // se só tinha uma palavra no campo, aí não tem muito o que fazer
      vektorInput.value = sugestao;
    }
  } else {
    // Sugestões genéricas (intents): mantém comportamento antigo
    vektorInput.value = sugestao;
  }

  vektorInput.focus();
}

// 4) Carregar lista de LOJAS vinda do back-end
window.__VEKTOR_LOJAS = [];
google.script.run.withSuccessHandler(function(lista){
    if (Array.isArray(lista)) window.__VEKTOR_LOJAS = lista;
}).getListaLojas();

// 5) Lista de times reais (você ajusta aqui)
const VEKTOR_TIMES = [
  "Águias de Elite",
  "Águias do Cerrado",
  "Guardiões da Fronteira",
  "Esquadrão 40 graus",
  "Esquadrão Valente",
  "Falcões SP",
  "Flechas do Norte",
  "Furacão Sul I",
  "Ultra High",
  "Fúria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Cangaço",
  "Legião de Elite",
  "Sulcesso"
];

// 6) Renderizar sugestões

function vektorRenderSugestoes(lista) {
  if (!lista.length) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  vektorCurrentSuggestions = lista.slice(0, 8);
  vektorSelectedIndex = -1;

  vektorBox.innerHTML = vektorCurrentSuggestions
    .map((s, idx) => 
      `<div class="vektor-autocomplete-item" data-index="${idx}">${s}</div>`
    )
    .join("");

  vektorBox.style.display = "block";
}

// 7) Lógica do autocomplete
vektorInput.addEventListener("input", function () {
  const raw = vektorInput.value || "";

  // Se o campo está vazio, limpa e sai
  if (!raw.trim()) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  // texto inteiro normalizado (para intents)
  const norm = vektorNormAutocomplete(raw);

  // Usa o texto SEM os espaços finais para pegar a última palavra completa
  const base = raw.replace(/\s+$/g, ""); // remove espaços do fim
  const lastMatch = base.match(/(\S+)$/);
  const lastRaw   = lastMatch ? lastMatch[1] : "";
  const lastNorm  = vektorNormAutocomplete(lastRaw);

  // se a última palavra completa tem menos de 2 caracteres, não sugere nada
  if (!lastNorm || lastNorm.length < 2) {
    vektorBox.style.display = "none";
    vektorCurrentSuggestions = [];
    vektorSelectedIndex = -1;
    return;
  }

  let suggestions = [];

  // a) frases do VEKTOR_INTENTS -> usa a frase inteira normalizada
  if (norm.length >= 2) {
    suggestions.push(
      ...VEKTOR_INTENTS.filter(x => vektorNormAutocomplete(x).includes(norm))
    );
  }

  // b) autocomplete de LOJAS -> usa só os dígitos da última palavra
  if (window.__VEKTOR_LOJAS && window.__VEKTOR_LOJAS.length) {
    const digits = (lastRaw || "").replace(/\D/g, "");
    if (digits && digits.length <= 4) {
      const padded = ("0000" + digits).slice(-4);

      window.__VEKTOR_LOJAS.forEach((l) => {
        const cod = String(l.codigo || "").padStart(4, "0");

        if (cod.startsWith(padded)) {
          const nomeFinal = l.nome || l.nomeLojaTxt || "";
          let label = cod;

          if (nomeFinal) {
            label += " - " + nomeFinal;
          }

          suggestions.push(label);
        }
      });
    }
  }

  // c) autocomplete de TIMES -> compara contra a última palavra completa
  if (lastNorm.length >= 2) {
    suggestions.push(
      ...VEKTOR_TIMES.filter(t => vektorNormAutocomplete(t).includes(lastNorm))
    );
  }

  // remover duplicados
  suggestions = [...new Set(suggestions)];

  vektorRenderSugestoes(suggestions);
});

// clique do mouse
vektorBox.addEventListener("mousedown", (e)=>{
  const item = e.target.closest(".vektor-autocomplete-item");
  if (!item) return;

  const idx = item.dataset.index ? parseInt(item.dataset.index, 10) : -1;
  const textoSugestao =
    (idx >= 0 && vektorCurrentSuggestions[idx])
      ? vektorCurrentSuggestions[idx]
      : item.innerText;

  vektorApplySuggestion(textoSugestao);

  vektorBox.style.display = "none";
  vektorSelectedIndex = -1;
  vektorCurrentSuggestions = [];
});

    const sendBtn    = document.getElementById("sendBtn");

    /* ========= FUNÇÕES DE UI ========= */
    function scrollToBottom() {
  requestAnimationFrame(() => {
    const w = document.getElementById("chatWindow");
    if (!w) return;
    w.scrollTop = w.scrollHeight;
    setTimeout(() => { w.scrollTop = w.scrollHeight; }, 150);
  });
}

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start justify-end gap-3";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

        // Converte texto tipo "R$ 340.800,00" ou "59,1 mil" em número
    function vektorParseNumero(texto) {
      if (!texto) return NaN;

      let t = String(texto).toLowerCase();

      // trata "mil" (ex.: "340,8 mil")
      let multiplicador = 1;
      if (t.includes(" mil")) {
        multiplicador = 1000;
      }
      t = t.replace(/mil/gi, "");

      // remove tudo que não for número, vírgula, ponto ou sinal
      t = t.replace(/[^\d,.\-]/g, "");

      // remove pontos de milhar e troca vírgula por ponto
      t = t.replace(/\./g, "").replace(",", ".");

      const n = parseFloat(t);
      if (isNaN(n)) return NaN;
      return n * multiplicador;
    }


        function iniciarTimeoutPendencias() {
        // limpa qualquer timeout pendente
        if (pendenciasTimeoutId) {
            clearTimeout(pendenciasTimeoutId);
            pendenciasTimeoutId = null;
        }

    const mensagensOutroAssunto = [
  "Quer falar sobre outro assunto? Se sim, pode mandar bala!",
  "Quer aproveitar e falar de outro tema?",
  "Quer conversar sobre outra coisa?",
  "Planeta Terra chamando! Tem alguém ai? 🙄",
  "Me diz se quer mudar de assunto? 😉",  
  "Tem outro assunto que quer tratar?",
  "Posso te ajudar com mais alguma coisa?",
  "Quer mudar de assunto? Manda ver!",
  "Se quiser falar de outro tema, é só digitar 👇",
  "Posso te ajudar em outro ponto se quiser...",
  "Quer conversar sobre outra coisa agora?"
];

// 🕒 dispara o lembrete depois de 10s sem resposta
pendenciasTimeoutId = setTimeout(() => {
  // escolhe uma frase aleatória do array
  const fraseAleatoria = mensagensOutroAssunto[
    Math.floor(Math.random() * mensagensOutroAssunto.length)
  ];

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">${fraseAleatoria}</p>`
  );
}, 10000);

    }


        // 👇 Cole AQUI, logo abaixo de scrollToBottom()

      // Adiciona indicador de "digitando..."
      function showTypingIndicator() {
        const chatWindow = document.getElementById('chatWindow');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex items-start gap-3 mt-3';
        typingDiv.innerHTML = `
          <div class="bot-bubble px-4 py-3 max-w-[80%]">
            <div class="typing-indicator flex gap-1">
              <span></span><span></span><span></span>
            </div>
          </div>
        `;
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

  // ---- DEBUG TURBINADO: mostra erros e rejeições dentro do chat ----
(function instalarErroNoChat() {
  if (window.__erroNoChatInstalado) return;
  window.__erroNoChatInstalado = true;

  // Função auxiliar pra mostrar a mensagem no chat
  function mostrarErro(titulo, msg, linha, arquivo) {
    try {
      renderBotMessage(
        "HTML:<div style='font-family:Arial,sans-serif;font-size:12px;color:#B00020;background:#FFECEC;padding:8px;border:1px solid #B00020;border-radius:6px'>" +
          "<b>" + titulo + ":</b> " + msg +
          (linha ? "<br/><small>(" + (arquivo || "inline") + ":" + linha + ")</small>" : "") +
        "</div>"
      );
    } catch (_) {
      console.error("Erro ao mostrar debug no chat:", msg);
    }
  }

  // 1️⃣ Erros comuns de execução
  window.addEventListener("error", function (e) {
    const msg = e.message || String(e);
    mostrarErro("Erro de script", msg, e.lineno, e.filename);
  });

  // 2️⃣ Promises rejeitadas (async/await sem catch)
  window.addEventListener("unhandledrejection", function (e) {
    const msg = e.reason && e.reason.message ? e.reason.message : String(e.reason);
    mostrarErro("Promise rejeitada", msg);
  });

  // 3️⃣ Aviso de que o script carregou e debug está ativo
  window.addEventListener("DOMContentLoaded", function () {
    console.log("✅ Debug do chat ativado!");
  });

  // 4️⃣ Falhas no carregamento de scripts externos
  window.addEventListener("error", function (e) {
    if (e.target && e.target.tagName === "SCRIPT") {
      mostrarErro("Falha ao carregar script", e.target.src || "(inline script)");
    }
  }, true);
})();



  function hideTypingIndicator() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) typingDiv.remove();
  }

  function vektorStripHtml(html) {
  if (!html) return "";
  // remove prefixo "HTML:" se existir
  if (typeof html === "string" && html.startsWith("HTML:")) {
    html = html.substring(5);
  }
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  const text = tmp.textContent || tmp.innerText || "";
  return text.replace(/\s+/g, " ").trim();
}

function vektorResumoTexto(texto, maxLen) {
  maxLen = maxLen || 200;
  if (!texto) return "";
  if (texto.length <= maxLen) return texto;
  return texto.substring(0, maxLen) + " ...";
}

function vektorDetectarFuncaoOrigem() {
  let origem = "renderBotMessage";
  try {
    // Em muitos navegadores, em modo não-estrito, caller funciona
    const caller = renderBotMessage.caller;
    if (caller && caller.name) {
      origem = caller.name;
    }
  } catch (e) {
    // Se der erro por restrição de caller, mantém o fallback
    console.warn("Não foi possível detectar caller da renderBotMessage:", e);
  }
  return origem;
}

  async function renderBotMessage(text) {
  if (!text) return;

  // 👇 Mostra o indicador de "digitando..."
  showTypingIndicator();

  // Aguarda 1 segundo (simulando digitação)
  await new Promise(r => setTimeout(r, 800));

  // Remove o indicador
  hideTypingIndicator();

  // --- Parte original do seu código ---
  const wrapper = document.createElement("div");
  wrapper.className = "flex items-start gap-3";

  const avatar = document.createElement("img");
  avatar.src = ROBOT_IMG_URL;
  avatar.alt = "Assistente Clara (robô)";
  avatar.className = "h-16 w-auto object-contain flex-shrink-0";

  const bubble = document.createElement("div");
  const baseBubbleClasses =
    "bot-bubble px-4 py-3 text-sm whitespace-pre-line text-slate-700";
  bubble.className = baseBubbleClasses;

  // Conteúdo: HTML ou texto puro
  if (typeof text === "string" && text.startsWith("HTML:")) {
    bubble.innerHTML = text.replace(/^HTML:/, "").trim();
  } else {
    bubble.innerText = text;
  }

  // Se a resposta contém <iframe> (ex.: relatório gerencial),
  // a bolha ocupa a largura total do chat; caso contrário, 80%.
  if (bubble.querySelector("iframe")) {
    bubble.className = baseBubbleClasses + " w-full";
  } else {
    bubble.className = baseBubbleClasses + " max-w-[80%]";
  }

  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);
  chatWindow.appendChild(wrapper);

  scrollToBottom();

  // ============================================================
  // 🔹 LOG CENTRALIZADO DE SAÍDA DO BOT → GOOGLE SHEETS
  // ============================================================
  try {
    const textoLimpo = vektorStripHtml(text);
    const resumo = vektorResumoTexto(textoLimpo, 250);

    let intencaoSaida = "bot_generico";
    if (typeof ultimaIntencao !== "undefined" && ultimaIntencao) {
      intencaoSaida = ultimaIntencao;
    }

    // 🔹 AGORA A ORIGEM É DETECTADA AUTOMATICAMENTE
    const origemSaida = vektorDetectarFuncaoOrigem();

    vektorRegistrarMetrica(
      intencaoSaida,         // intencao
      "[BOT] " + resumo,     // mensagemOriginal
      "",                    // norm
      "bot_msg",             // resultado
      "SaidaBot",            // topico
      origemSaida            // funcaoOrigem (ex.: vektorBlocoRaciocinioPolitica)
    );

    if (typeof ultimaIntencao !== "undefined") {
      ultimaIntencao = null;
    }
    // não precisa mais de ultimaFuncaoOrigem, então nada pra resetar aqui

  } catch (e) {
    console.error("Erro ao registrar métrica de saída do bot:", e);
  }
}

window.renderBotMessage = renderBotMessage;

// ---- RELATÓRIO GERENCIAL LOOKER STUDIO EMBUTIDO NO CHAT (sem abrir nova aba)
window.vektorAbrirRelatorioGerencialNoChat = function () {
  try {
    // Mesmo comportamento do comando "abrir relatório gerencial..."
    renderBotMessage("HTML:" + htmlRelatorioGerencial);

    if (typeof scrollToBottom === "function") {
      setTimeout(scrollToBottom, 50);
    }
  } catch (e) {
    console.warn("Falha ao abrir relatório gerencial no chat:", e);
    renderBotMessage("Não consegui abrir o relatório gerencial no chat.");
  }
};

          // ========= EXPORTAÇÃO DE TABELA PARA CSV =========

  // Usado pelo botão "⬇ Exportar CSV" dentro das respostas com tabela.
  // IMPORTANTE: precisa estar dentro do document.addEventListener("DOMContentLoaded", ...)
  // e exposto em window para o onclick funcionar.
  window.exportTableToCSV = function(btn, defaultFileName) {
    try {
      // 1. Encontrar o container da mensagem do bot onde o botão está
      var container = btn.closest(".bot-bubble");
      if (!container) {
        container = btn.closest("div");
      }

      if (!container) {
        alert("Não consegui localizar a tabela para exportar.");
        return;
      }

      // 2. Achar a tabela dentro dessa resposta
      var table = container.querySelector("table");
      if (!table) {
        alert("Não encontrei nenhuma tabela nessa resposta para exportar.");
        return;
      }

      // 3. Montar o CSV linha a linha
      var linhas = table.querySelectorAll("tr");
      var csvLinhas = [];

      for (var i = 0; i < linhas.length; i++) {
        var cols = linhas[i].querySelectorAll("th,td");
        var linhaCampos = [];
        for (var j = 0; j < cols.length; j++) {
          var texto = (cols[j].innerText || "").replace(/\s+/g, " ").trim();

          // Escapa aspas duplas
          texto = texto.replace(/"/g, '""');

          // Se tiver ;, quebra de linha ou aspas, envolve em aspas
          if (/[;"\n]/.test(texto)) {
            texto = '"' + texto + '"';
          }

          linhaCampos.push(texto);
        }

        // Usando ; como separador (mais comum no Excel PT-BR)
        csvLinhas.push(linhaCampos.join(";"));
      }

      var csv = csvLinhas.join("\n");

      // 4. Criar o arquivo e disparar o download
      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var agora = new Date();
      var stamp = agora.toISOString().slice(0,19).replace(/[:T\-]/g,"");

      a.href = url;
      a.download = (defaultFileName || "exportacao") + "_" + stamp + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Erro ao exportar CSV:", e);
      alert("Não consegui gerar o CSV desta tabela.");
    }
  };


  function vektorFiltrarRelacaoSaldos(wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = document.getElementById("filtroRelacaoSaldosLoja");
    var selAcao = document.getElementById("filtroRelacaoSaldosAcao");

    var lojaVal = selLoja ? (selLoja.value || "") : "";
    var acaoVal = selAcao ? (selAcao.value || "") : "";

    var tbody = wrap.querySelector("tbody");
    if (!tbody) return;

    var trs = tbody.querySelectorAll("tr");
    trs.forEach(function(tr){
      var alias = tr.getAttribute("data-alias") || "";
      var acao  = tr.getAttribute("data-acao")  || "";

      var okLoja = !lojaVal || alias === lojaVal;
      var okAcao = !acaoVal || acao === acaoVal;

      tr.style.display = (okLoja && okAcao) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar relação de saldos:", e);
  }
}

// 1) FUNÇÃO DE FILTRAR (obrigatória)
window.vektorFiltrarRelacaoSaldos = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = document.getElementById("filtroRelacaoSaldosLoja");
    var selAcao = document.getElementById("filtroRelacaoSaldosAcao");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var acaoVal = selAcao ? (selAcao.value || "").trim() : ""; // "Aumentar" | "Manter" | "Reduzir"

    // Normaliza a seleção de ação para comparação (base)
    var acaoValNorm = "";
    if (acaoVal) {
      var a = acaoVal.toLowerCase();
      if (a.indexOf("aumentar") === 0) acaoValNorm = "aumentar";
      else if (a.indexOf("reduzir") === 0) acaoValNorm = "reduzir";
      else if (a.indexOf("manter") === 0) acaoValNorm = "manter";
      else acaoValNorm = a; // fallback
    }

    var tbody = wrap.querySelector("tbody");
    if (!tbody) return;

    var trs = tbody.querySelectorAll("tr");
    trs.forEach(function (tr) {
      var alias = (tr.getAttribute("data-alias") || "").trim();

      // Pode vir "Aumentar (+R$...)" etc. Vamos pegar só a base.
      var acaoRaw = (tr.getAttribute("data-acao") || "").trim();
      var acaoNorm = "";
      if (acaoRaw) {
        var x = acaoRaw.toLowerCase();
        if (x.indexOf("aumentar") === 0) acaoNorm = "aumentar";
        else if (x.indexOf("reduzir") === 0) acaoNorm = "reduzir";
        else if (x.indexOf("manter") === 0) acaoNorm = "manter";
        else acaoNorm = x; // fallback
      }

      var okLoja = !lojaVal || alias === lojaVal;
      var okAcao = !acaoValNorm || acaoNorm === acaoValNorm;

      tr.style.display = (okLoja && okAcao) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar relação de saldos:", e);
  }
};

// 2) FUNÇÃO DE LIMPAR (mantém a sua, só garantindo window.)
window.vektorLimparFiltroRelacaoSaldos = function (wrapId) {
  try {
    var selLoja = document.getElementById("filtroRelacaoSaldosLoja");
    var selAcao = document.getElementById("filtroRelacaoSaldosAcao");
    if (selLoja) selLoja.value = "";
    if (selAcao) selAcao.value = "";

    window.vektorFiltrarRelacaoSaldos(wrapId);
  } catch (e) {
    console.error("Erro ao limpar filtro relação de saldos:", e);
  }
};

window.filtrarLojasOfensoras = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = document.getElementById("filtroOfensorLoja");
    var selTime = document.getElementById("filtroOfensorTime");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var timeVal = selTime ? (selTime.value || "").trim() : "";

    var tbody = wrap.querySelector("tbody");
    if (!tbody) return;

    var trs = tbody.querySelectorAll("tr");
    trs.forEach(function (tr) {
      var loja = (tr.getAttribute("data-loja") || "").trim();
      var time = (tr.getAttribute("data-time") || "").trim();

      var okLoja = !lojaVal || loja === lojaVal;
      var okTime = !timeVal || time === timeVal;

      tr.style.display = (okLoja && okTime) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar lojas ofensoras:", e);
  }
};

window.vektorAplicarFiltrosItensComprados = function (wrapId) {
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  const selStatus = wrap.querySelector('select[data-filtro="status"]');
  const chkReinc = wrap.querySelector('input[data-filtro="reinc"]');

  // ✅ agora serão MULTI (no item C), mas já deixo compatível:
  const selTime = wrap.querySelector('select[data-filtro="time"]');
  const selLoja = wrap.querySelector('select[data-filtro="loja"]');

  const statusFiltro = selStatus ? selStatus.value : "";
  const somenteReinc = !!(chkReinc && chkReinc.checked);

  const timesSel = selTime ? Array.from(selTime.selectedOptions).map(o => o.value).filter(Boolean) : [];
  const lojasSel = selLoja ? Array.from(selLoja.selectedOptions).map(o => o.value).filter(Boolean) : [];

  const trs = Array.from(wrap.querySelectorAll("tbody tr[data-status]"));

  // 1) aplica filtro nas linhas
  trs.forEach(tr => {
    const st = (tr.getAttribute("data-status") || "").toUpperCase();
    const reinc = tr.getAttribute("data-reinc") === "1";
    const t = (tr.getAttribute("data-time") || "");
    const l = (tr.getAttribute("data-loja") || "");

    let ok = true;

    if (statusFiltro && st !== statusFiltro) ok = false;
    if (somenteReinc && !reinc) ok = false;

    if (timesSel.length && !timesSel.includes(t)) ok = false;
    if (lojasSel.length && !lojasSel.includes(l)) ok = false;

    tr.style.display = ok ? "" : "none";
  });

  // 2) recalcula opções disponíveis (cascata)
  // base: linhas VISÍVEIS após filtros (exceto o próprio filtro do select que vamos recalcular)
  const visibleTrs = trs.filter(tr => tr.style.display !== "none");

  // Times disponíveis com base nas lojas selecionadas (ou nas linhas visíveis)
  if (selTime) {
    const setTimes = new Set();
    visibleTrs.forEach(tr => {
      const t = (tr.getAttribute("data-time") || "");
      if (t) setTimes.add(t);
    });

    // Rebuild options mantendo seleção válida
    const prev = new Set(timesSel);
    const opts = ["<option value=''>Todos</option>"]
      .concat(Array.from(setTimes).sort().map(t => {
        const sel = prev.has(t) ? " selected" : "";
        return `<option value="${t.replace(/"/g,'&quot;')}"${sel}>${t}</option>`;
      }));
    selTime.innerHTML = opts.join("");
  }

  if (selLoja) {
    const setLojas = new Set();
    visibleTrs.forEach(tr => {
      const l = (tr.getAttribute("data-loja") || "");
      if (l) setLojas.add(l);
    });

    const prev = new Set(lojasSel);
    const opts = ["<option value=''>Todas</option>"]
      .concat(Array.from(setLojas).sort().map(l => {
        const sel = prev.has(l) ? " selected" : "";
        return `<option value="${l.replace(/"/g,'&quot;')}"${sel}>${l}</option>`;
      }));
    selLoja.innerHTML = opts.join("");
  }
};

window.vektorLimparFiltrosItensComprados = function (wrapId) {
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  const selStatus = wrap.querySelector('select[data-filtro="status"]');
  const chkReinc  = wrap.querySelector('input[data-filtro="reinc"]');
  const selTime   = wrap.querySelector('select[data-filtro="time"]');
  const selLoja   = wrap.querySelector('select[data-filtro="loja"]');

  if (selStatus) selStatus.value = "";
  if (chkReinc) chkReinc.checked = false;

  // limpa multi-seleção (se existir)
  if (selTime) Array.from(selTime.options).forEach(o => o.selected = false);
  if (selLoja) Array.from(selLoja.options).forEach(o => o.selected = false);

  window.vektorAplicarFiltrosItensComprados(wrapId);
};

// ========= DRILL-DOWN: EXPANDIR LINHA DA TABELA (com dropdown + mesmo período) ========= //

window.vektorExpandirLinha = function (tr, base) {
  try {
    if (!tr || !tr.cells || !tr.cells.length) return;

    // Nome da linha (Time / Loja / Categoria / Estabelecimento)
    const chave = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    if (!chave) return;

    // Encontra o <select> relacionado ao drilldown
    const container = tr.closest("div");
    const select = container
      ? container.querySelector(".vektor-drill-select[data-base='" + base + "']")
      : null;

    const alvo = select ? select.value : null; // loja / categoria / estabelecimento / time

    // Período da pergunta original (cache)
    const periodo = window.__vektorUltimoPeriodo || null;
    const dataInicioStr =
      periodo && periodo.dataInicio ? periodo.dataInicio.toISOString() : "";
    const dataFimStr =
      periodo && periodo.dataFim ? periodo.dataFim.toISOString() : "";

    let periodoTxt = "";
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      const di = periodo.dataInicio;
      const df = periodo.dataFim;
      periodoTxt =
        di.toLocaleDateString("pt-BR") + " a " + df.toLocaleDateString("pt-BR");
    }

    const tipo = "valor"; // padrão do drilldown

    // ================== BASE = TIME ==================
    if (base === "time") {
      // ▼ TIME → LOJAS (padrão)
      if (alvo === "loja" || !alvo) {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>lojas</b>…</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            // topN null + forGroup=true => todas as lojas do time
            renderResumoTransacoesSemana(res, { topN: null, forGroup: true });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar por lojas.</p>"
            );
          })
          .getResumoTransacoesPorGrupo(chave, dataInicioStr, dataFimStr, tipo);
      }

      // ▼ TIME → CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> do time <b>" + chave + "</b> " +
            (periodoTxt ? "no período <b>" + periodoTxt + "</b>" : "") +
            "…</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias do time.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaTime(
            dataInicioStr,
            dataFimStr,
            tipo,   // "valor" ou "quantidade"
            chave   // nome do time
          );
      }

      // ▼ TIME → ESTABELECIMENTOS
      else if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando o time <b>${chave}</b> por <b>estabelecimentos</b>…</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos do time " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            chave, // grupo = time
            ""     // loja vazia
          );
      }

      return;
    }

    // ================== BASE = LOJA ==================
    if (base === "loja") {
      // ▼ LOJA → ESTABELECIMENTOS
      if (alvo === "estabelecimento") {
        renderBotMessage(
          `HTML:<p class="text-sm text-slate-700">
            Detalhando a loja <b>${chave}</b> por <b>estabelecimentos</b>…</p>`
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Estabelecimento",
              titulo: "Estabelecimentos da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar estabelecimentos.</p>"
            );
          })
          .getResumoTransacoesPorEstabelecimento(
            dataInicioStr,
            dataFimStr,
            tipo,
            "",
            chave // loja
          );
      }

      // ▼ LOJA → CATEGORIAS
      else if (alvo === "categoria") {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Detalhando por <b>categorias</b> da loja <b>" + chave + "</b> " +
            (periodoTxt ? "no período <b>" + periodoTxt + "</b>" : "") +
            "…</p>"
        );

        google.script.run
          .withSuccessHandler(function (res) {
            renderResumoPorChaveGenerico(res, {
              tipoChave: "Categoria",
              titulo: "Categorias da loja " + chave,
              topN: null
            });
          })
          .withFailureHandler(function () {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Falha ao detalhar categorias da loja.</p>"
            );
          })
          .getResumoTransacoesPorCategoriaLoja(
            dataInicioStr,
            dataFimStr,
            tipo,     // "valor" ou "quantidade"
            chave     // código/nome da loja
          );
      }

      return;
    }
  } catch (e) {
    console.error("Erro no vektorExpandirLinha:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Tive um problema ao tentar detalhar essa linha.</p>"
    );
  }
};

window.vektorDrillTransacoesCategoria = function (nomeCategoria) {
  try {
    if (!nomeCategoria) return;

    // Usa o último período entendido pelo Vektor
    var periodo = window.__vektorUltimoPeriodo || null;
    var dataInicioStr = "";
    var dataFimStr    = "";

    if (periodo && periodo.dataInicio && periodo.dataFim) {
      dataInicioStr = periodo.dataInicio.toISOString();
      dataFimStr    = periodo.dataFim.toISOString();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a categoria <b>" + nomeCategoria + "</b> " +
        "pelas transações individuais no mesmo período da consulta…</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          var html = vektorRenderTransacoesPorCategoria(res, nomeCategoria);
          if (html) {
            renderBotMessage("HTML:" + html);
          } else {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>" +
                "Não encontrei transações para essa categoria neste período." +
              "</p>"
            );
          }
        } catch (e) {
          console.error("Erro ao renderizar transações por categoria:", e);
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "Falha ao detalhar as transações dessa categoria." +
            "</p>"
          );
        }
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script getTransacoesPorCategoria:", err);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Não consegui consultar as transações dessa categoria agora." +
          "</p>"
        );
      })
      .getTransacoesPorCategoria(
        dataInicioStr,
        dataFimStr,
        nomeCategoria
      );

  } catch (e) {
    console.error("Erro geral em vektorDrillTransacoesCategoria:", e);
  }
};

window.vektorDrillTransacoesEstabelecimento = function (nomeEstab) {
  try {
    // Pega período do cache global (mesma lógica que você já usa em categorias)
    let dataInicioIso = "";
    let dataFimIso = "";

    if (window.__vektorUltimoPeriodo && window.__vektorUltimoPeriodo.dataInicio && window.__vektorUltimoPeriodo.dataFim) {
      dataInicioIso = window.__vektorUltimoPeriodo.dataInicio.toISOString();
      dataFimIso    = window.__vektorUltimoPeriodo.dataFim.toISOString();
    } else if (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio && window.__vektorUltimoPeriodoIso.fim) {
      dataInicioIso = window.__vektorUltimoPeriodoIso.inicio;
      dataFimIso    = window.__vektorUltimoPeriodoIso.fim;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Buscando transações do estabelecimento <b>" +
        nomeEstab +
      "</b> por loja no mesmo período...</p>"
    );

    google.script.run
      .withSuccessHandler(function(res) {
        renderTransacoesEstabelecimentoPorLoja(res);
      })
      .withFailureHandler(function(err) {
        console.error("Erro ao buscar transações por estabelecimento:", err);
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>Não consegui carregar as transações desse estabelecimento agora.</p>");
      })
      .getTransacoesIndividuaisPorEstabelecimento(dataInicioIso, dataFimIso, nomeEstab);

  } catch (e) {
    console.error("Falha em vektorDrillTransacoesEstabelecimento:", e);
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao tentar expandir o estabelecimento.</p>");
  }
}

function renderTransacoesEstabelecimentoPorLoja(res) {
  if (!res || !res.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não encontrei transações para esse estabelecimento no período.</p>"
    );
    return;
  }

  const linhas = res.linhas || [];
  if (!linhas.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não encontrei transações para esse estabelecimento no período.</p>"
    );
    return;
  }

  // período
  let periodoHtml = "";
  try {
    const di = res.dataInicioIso ? new Date(res.dataInicioIso) : null;
    const df = res.dataFimIso ? new Date(res.dataFimIso) : null;
    if (di && df && !isNaN(di.getTime()) && !isNaN(df.getTime())) {
      periodoHtml =
        "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
          "Período da consulta: de " + di.toLocaleDateString("pt-BR") +
          " a " + df.toLocaleDateString("pt-BR") + "." +
        "</p>";
    }
  } catch (e) {}

  // monta tabela
  let html = [];
  html.push("<div class='text-sm text-slate-700'>");
  html.push("<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>Transações por loja – " + (res.estabelecimento || "") + "</p>");
  html.push(periodoHtml);

  html.push("<div style='overflow-x:auto;'>");
  html.push("<table style='border-collapse:collapse;width:100%;font-size:12px;text-align:center;border:1px solid #000;'>");

  // ✅ Valor (R$) movido para a ÚLTIMA coluna
  html.push(
    "<thead><tr style='background:#06167d;color:#fff;'>" +
      "<th style='border:1px solid #000;padding:4px;'>Loja</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Estabelecimento</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Data</th>" +

      "<th style='border:1px solid #000;padding:4px;'>Titular</th>" +
      "<th style='border:1px solid #000;padding:4px;'>Grupos</th>" +

      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Recibo</th>" +
      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Etiquetas</th>" +
      "<th style='border:1px solid #000;padding:4px;background:#FECACA;color:#7F1D1D;font-weight:700;'>Descrição</th>" +

      "<th style='border:1px solid #000;padding:4px;'>Valor (R$)</th>" +
    "</tr></thead><tbody>"
  );

  let soma = 0;
  for (let i = 0; i < linhas.length; i++) {
    const l = linhas[i] || {};
    const valor = Number(l.valor || 0);
    soma += valor;

    // ✅ Valor movido para o ÚLTIMO <td>
    html.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.loja || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.estabelecimento || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.data || "") + "</td>" +

        "<td style='border:1px solid #000;padding:4px;'>" + (l.titular || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.grupos || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.recibo || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.etiquetas || "") + "</td>" +
        "<td style='border:1px solid #000;padding:4px;'>" + (l.descricao || "") + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
          valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
      "</tr>"
    );
  }

  // total (colspan continua correto: 8)
  html.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;padding:4px;' colspan='8'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
        soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  html.push("</tbody></table></div>");

  // botão CSV abaixo (igual padrão)
  html.push(
    "<div style='margin-top:8px;text-align:right;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'transacoes_estabelecimento_por_loja')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "⬇ Exportar CSV" +
      "</button>" +
    "</div>"
  );

  html.push("</div>");

  renderBotMessage("HTML:" + html.join(""));
}

    /* ========= NORMALIZAÇÃO ========= */
    function normalize(str) {
        return (str || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    // ================= VEKTOR – bloco de raciocínio da política =================

function vektorBlocoRaciocinioPolitica(explicacao, risco, referencia) {
  explicacao = explicacao || "Essa decisão segue as regras da política de uso dos cartões Clara.";
  risco = risco || "";

  // Garante referência com fallback seguro
  if (typeof POLITICA_CARTOES_CLARA_LINK !== "undefined") {
    referencia = referencia || POLITICA_CARTOES_CLARA_LINK;
  } else {
    referencia = referencia || "#";
  }

  // Monta o “cartão” de raciocínio
  var html =
    "<div style='margin-top:6px;padding:8px;border-radius:6px;border:1px dashed #cbd5e1;background:#f8fafc;'>" +
      "<p style='font-size:14px;color:#0f172a;'><b>Segue minha análise para o seu questionamento:</b></p><br>";

  // Aqui a explicação já pode ser HTML completo (ex.: o bloco da categoria)
  html += explicacao;

  if (risco) {
    html +=
      "<p style='font-size:12px;color:#b91c1c;margin-top:4px;'><b>Risco:</b> " + risco + "</p>";
  }

  html +=
      "<p style='font-size:11px;color:#64748b;margin-top:6px;'>" +
        "Para detalhes completos, consulte a Política de Uso dos Cartões Clara: " +
        "<a href='" + referencia + "' target='_blank' style='color:#005E27;font-weight:600;'>abrir política</a>." +
      "</p>" +
    "</div>";

  // ⚠️ IMPORTANTE: prefixo "HTML:" para o renderBotMessage usar innerHTML
  return "HTML:" + html;
}

    // =============== MOTOR DE POLÍTICA POR CATEGORIA (SEM MCC AINDA) ===============

    // Encontra uma categoria de política a partir do nome
    function classificarCategoriaPolitica(nomeCategoria) {
      if (!nomeCategoria) return null;

      const normCat = normalize(nomeCategoria);
      if (!Array.isArray(POLITICA_CATEGORIA)) return null;

      // Busca por match exato no nome normalizado
      for (const regra of POLITICA_CATEGORIA) {
        if (!regra || !regra.categoria) continue;
        const normRegra = normalize(regra.categoria);
        if (normRegra === normCat) {
          return regra;
        }
      }

      return null;
    }

    // Avalia se uma categoria é permitida / condicional / proibida
    function avaliarCategoriaPolitica(categoriaPolitica) {
      const regra = classificarCategoriaPolitica(categoriaPolitica);

      if (!regra) {
        return {
          decisao: "indefinido",
          idRegra: null,
          motivoTecnico: "Nenhuma regra específica encontrada para essa categoria na matriz POLITICA_CATEGORIA.",
          mensagemUsuario:
            "Essa categoria não está mapeada automaticamente no Vektor. Consulte a política oficial ou abra chamado no financeiro para análise."
        };
      }

      if (regra.status === "permitido") {
        return {
          decisao: "permitido",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como liberada na política (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria de compra é permitida pela política de uso dos cartões Clara, desde que o gasto seja necessário para a operação da loja."
        };
      }

      if (regra.status === "condicional") {
        return {
          decisao: "condicional",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como sujeita à análise/liberação prévia do financeiro (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria exige análise e liberação prévia do financeiro. Abra chamado no ServiceNow explicando a necessidade antes de concluir a compra."
        };
      }

      if (regra.status === "proibido") {
        return {
          decisao: "proibido",
          idRegra: regra.idRegra,
          motivoTecnico: "Categoria listada como proibida na política (grupo: " + regra.categoria + ").",
          mensagemUsuario:
            "Essa categoria é proibida pela política de uso dos cartões Clara. Não use o cartão Clara para esse tipo de despesa."
        };
      }

      // fallback defensivo
      return {
        decisao: "indefinido",
        idRegra: regra.idRegra,
        motivoTecnico: "Status de regra não reconhecido: " + regra.status,
        mensagemUsuario:
          "Não consegui classificar essa categoria automaticamente. Consulte o financeiro ou a política oficial."
      };
    }

    // ===== TIMES OFICIAIS (para identificar "time X" / "grupo X") =====
const TIMES_OFICIAIS = [
  "Águias de Elite",
  "Águias do Cerrado",
  "Guardiões da Fronteira",
  "Esquadrão 40 Graus",
  "Esquadrão Valente",
  "Falcões SP",
  "Flechas do Norte",
  "Furacão Sul I",
  "Ultra High",
  "Fúria do Interior",
  "Gigante Paulista",
  "Lobos SP",
  "Guerreiros do Cangaço",
  "Legião de Elite",
  "SULcesso"
];

// Usa a mesma normalize() do chat pra comparar mensagem x times
function encontrarTimeNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal);

  let melhorNome = null;
  let melhorScore = 0;

  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // separa em palavras e tira preposições/coisas fracas
    const tokens = nomeNorm
      .split(" ")
      .filter(t => {
          if (!t) return false;
          if (["do","da","de","dos","das","sp","sul"].includes(t)) return false;
          if (t.length < 3) return false; // elimina "i", "ii", etc.
          return true;
        });


    let score = 0;

    // se o nome completo aparecer, já dá um boost forte
    if (texto.includes(nomeNorm)) {
      score += 100;
    }

    // +10 pra cada palavra relevante encontrada
    tokens.forEach(tok => {
      if (texto.includes(tok)) score += 10;
    });

    if (score > melhorScore) {
      melhorScore = score;
      melhorNome = nome;
    }
  });

  // se nada bateu, volta null
  return melhorNome;
}

function encontrarListaTimesNaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");
  const encontrados = [];

  // Helper: escape para regex
  const _escRe_ = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

  // Helper: match por palavra inteira (evita "i" bater em "time", por exemplo)
  const _hasWord_ = (txt, w) => {
    if (!w) return false;
    return new RegExp("\\b" + _escRe_(w) + "\\b", "i").test(txt);
  };

  // Stopwords e tokens problemáticos
  const _stop = new Set([
    "do","da","de","dos","das","sp","sul",
    // romanos/curtos que geram falso positivo
    "i","ii","iii","iv","v","vi","vii","viii","ix","x"
  ]);

  // Percorre todos os times oficiais
  TIMES_OFICIAIS.forEach((nome) => {
    const nomeNorm = normalize(nome);

    // Tokens relevantes: remove stopwords e ignora tokens muito curtos (<=2)
    let tokens = nomeNorm
      .split(" ")
      .map(t => t.trim())
      .filter(t => t && !_stop.has(t) && t.length >= 3);

    // Se o usuário digitou o nome completo do time
    const nomeCompletoNoTexto = texto.includes(nomeNorm);

    let score = 0;
    tokens.forEach((tk) => {
      if (_hasWord_(texto, tk)) score += 1;
    });

    // Regras de decisão:
    // - Nome completo no texto → inclui
    // - 2+ tokens relevantes → exige pelo menos 2 matches
    // - 1 token relevante → exige match por palavra inteira
    const ok =
      nomeCompletoNoTexto ||
      (tokens.length >= 2 ? score >= 2 : score >= 1);

    if (ok) {
      encontrados.push(nome);
    }
  });

  return encontrados;
}

    /* ========= DADOS / TABELAS ========= */

    const etiquetasOficiais = [
  {
    nome: "MARKETING_PUBLICIDADE E PROPAGANDA",
    palavrasChave: [
      "marketing", "publicidade", "propaganda", "anuncio", "anúncio", "facebook", "instagram", "insta", "face",
      "mídia", "midia", "brinde", "campanha", "banner promocional", "campanhas", "banner", "baner",
      "impulsionamento", "divulgação", "panfleto", "adesivo promocional", "social media", "instagram ads", "facebook ads", "promoção local", "google ads", "tiktok ads", "youtube ads", "seo", "sem", "email marketing", "e-mail marketing", "inbound marketing", "outbound marketing", "influencer", "influenciadores", "parceria paga", "patrocinado", "stories", "feed", "design gráfico", "agencia de publicidade", "agência de publicidade", "criacao de conteudo", "criação de conteúdo", "material promocional", "folder", "cartaz", "outdoor", "tv paga", "revista", "jornal", "marketing digital", "alcance", "engajamento", "conversão", "leads", "pixel", "remarketing", "assessoria de imprensa", "relações públicas", "relacoes publicas", "assessoria"
    ],
    descricao:
      "Ações promocionais, compra de brindes, banners, impulsionamento de redes sociais, contratação de mídia local.",
    observacaoUso: "Somente campanhas aprovadas pelo regional ou diretoria."
  },
  {
    nome: "TAXAS E EMOLUMENTOS",
    palavrasChave: [
      "taxa", "taxas", "emolumento", "emolumentos", "cartorio", "cartório",
      "certidao", "certidão", "registro", "segunda via documento", "aluguel",
      "documentação oficial", "taxa de serviço", "honorarios", "honorários"
    ],
    descricao:
      "Custos com registros, certidões, taxas cartoriais ou administrativas necessárias à operação da loja.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA",
    palavrasChave: [
      "detergente", "sabao", "sabão", "desinfetante", "alcool", "álcool", "pano", "rodo", "vassoura", "esponja", "papel toalha", "limpeza loja", "produto de limpeza", "desengordurante", "multiuso", "saco de lixo", "lixeira", "balde", "mop", "lustra moveis", "lustra móveis", "cera", "removedor", "amaciante", "água sanitária", "agua sanitaria", "limpa vidros", "rasteio", "escova", "flanela", "aspirador", "saponáceo", "sabonete", "dispenser", "tapete sanitizante", "sanitizante", "cloro", "alvejante", "luva", "mascara", "máscara", "limpeza do banheiro", "papel higiênico", "papel higienico", "aromatizador", "odorizador", "refil", "material de higiene", "higiene"
    ],
    descricao:
      "Materiais de limpeza e higiene da loja: detergente, desinfetante, pano de chão, álcool, papel toalha, vassoura, rodo etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE INFORMÁTICA",
    palavrasChave: [
      "mouse", "teclado", "teclado pdv", "cabo usb", "pendrive", "pen drive", "roteador", "hub usb", "fonte", "adaptador", "cabo rede", "cartão memoria", "cartao memoria", "extensor usb", "carregador", "suporte notebook", "monitor", "impressora", "cartucho", "toner", "cabo hdmi", "ssd", "hd", "memoria ram", "memória ram", "headset", "scanner", "leitor de código", "leitor de codigo", "mousepad", "modem", "placa de video", "placa de rede", "pilhas", "bateria", "no break", "nobreak", "filtro de linha", "periférico", "periferico", "fone de ouvido", "fones", "fone"
    ],
    descricao:
      "Itens de informática de baixo valor: mouse, teclado, cabos, pendrives, fontes, roteadores, hubs USB, cartões de memória.",
    observacaoUso: "Não cobre monitores, TVs ou equipamentos patrimoniais."
  },
  {
    nome: "MATERIAL DE ESCRITÓRIO",
    palavrasChave: [
      "caneta", "papel", "pasta", "bloco", "caderno", "etiqueta adesiva", "grampeador", "clips", "clipes", "organizador", "post-it", "marcador", "lápis", "lapis", "borracha", "corretivo", "tesoura", "régua", "regua", "perfurador", "furador de papel", "cola", "fita adesiva", "fita durex", "envelope", "arquivo", "caixa arquivo", "separador de página", "separador de pagina",
      "carimbo", "tinta carimbo", "calculadora", "agenda", "calendário", "calendario", "prancheta", "suporte de caneta", "porta-treco", "cartucho de tinta", "toner", "porta revista", "revisteiro", "apontador", "dicionário", "dicionario", "impressos", "sulfite", "folha de sulfite", "folha A4", "folhas", "escada", "escadas"
    ],
    descricao:
      "Canetas, blocos, papéis, pastas, grampeadores, clipes, etiquetas adesivas, organizadores de mesa etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE COPA E COZINHA",
    palavrasChave: [
      "copo", "copos", "talher", "talheres", "garrafa termica", "garrafa térmica",
      "pano prato", "pano de prato", "filtro de cafe", "filtro de café",
      "pote", "potes", "pote plastico", "pote plástico", "descartavel", 
    ],
    descricao:
      "Copos, talheres, filtros de café, panos de prato, potes plásticos, garrafas térmicas.",
    observacaoUso: "Não cobre eletrodomésticos como cafeteiras ou micro-ondas."
  },
  {
    nome: "MATERIAL DE COPA E COZINHA OPERAÇÕES",
    palavrasChave: ["cozinha loja", "utensilios loja", "material copa operações", "kit acrilico"],
    descricao: "Itens de copa/cozinha utilizados especificamente em operações.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA OPERAÇÕES",
    palavrasChave: ["limpeza operações", "produto limpeza operacional"],
    descricao: "Materiais de limpeza voltados à operação da loja.",
    observacaoUso: ""
  },
  {
    nome: "SERVIÇOS GRÁFICOS OPERAÇÕES",
    palavrasChave: ["banner", "adesivo", "flyer", "folder", "grafica", "impressao", "impressão", "impressões"],
    descricao: "Materiais gráficos operacionais, banners e impressões.",
    observacaoUso: ""
  },
  {
    nome: "MANUTENÇÃO CIVIL",
    palavrasChave: [
      "parede", "porta", "vidro", "prateleira", "fechadura", "reparo loja",
      "conserto parede", "ajuste estrutura", "obra pequena"
    ],
    descricao:
      "Pequenos reparos físicos na loja (parede, porta, vidro, prateleira fixa).",
    observacaoUso: ""
  },
  {
    nome: "MANUTENÇÃO ELETRICO",
    palavrasChave: [
      "tomada", "disjuntor", "interruptor", "reator", "soquete", "extensao",
      "fiação", "fiacao", "elétrico", "eletrico", "luz", "lâmpada", "lampada"
    ],
    descricao:
      "Troca de tomadas, disjuntores, interruptores, lâmpadas e pequenos reparos elétricos.",
    observacaoUso: "Apenas serviços simples, sem necessidade de técnico especializado."
  },
  {
    nome: "MANUTENÇÃO EQUIPAMENTOS",
    palavrasChave: [
      "conserto impressora", "ajuste maquina estampar", "reparo computador",
      "ferramenta manual", "manutencao equipamentos", "reparo técnico"
    ],
    descricao:
      "Reparo de impressora, máquina de estampar e computador fora de garantia.",
    observacaoUso: ""
  },
  {
    nome: "MANUTENÇÃO AR-CONDICIONADO",
    palavrasChave: [
      "ar condicionado", "ar-condicionado", "limpeza filtro", "carga gas",
      "controle remoto ar", "manutenção ar", "reparo ar", "split"
    ],
    descricao:
      "Limpeza, carga de gás e pequenos ajustes em ar-condicionado.",
    observacaoUso: "Não cobre compra de novo aparelho."
  },
  {
    nome: "TRANSPORTE SERVICOS EMERGENCIAS",
    palavrasChave: [
      "motoboy", "moto boy", "entrega urgente", "frete", "documento matriz",
      "lalamove", "entrega loja", "envio urgente", "courier"
    ],
    descricao:
      "Frete emergencial local, motoboy ou entrega urgente entre lojas e matriz.",
    observacaoUso: "Não inclui transporte pessoal via aplicativos."
  },
  {
    nome: "SERVIÇOS GRÁFICOS E DE COPIADORAS",
    palavrasChave: [
      "banner", "adesivo", "flyer", "folder", "encadernacao", "grafica", "impressao",
      "material visual", "cartaz", "copiadora"
    ],
    descricao:
      "Impressões, banners, adesivos, folders, encadernações e materiais visuais.",
    observacaoUso: ""
  },
  {
    nome: "SERVIÇOS DE LIMPEZA",
    palavrasChave: [
      "limpeza loja", "faxina", "serviço limpeza", "limpeza extra", "empresa limpeza"
    ],
    descricao:
      "Contratação de serviços de limpeza eventuais para manutenção da loja.",
    observacaoUso: ""
  },
  {
    nome: "CORREIOS_SEDEX/AR/POSTAGEM",
    palavrasChave: [
      "sedex", "correio", "postagem"
    ],
    descricao: "Envio de documentos físicos via Sedex, AR, ou devoluções pequenas.",
    observacaoUso: ""
  },
  {
    nome: "LANCHES DE REFEIÇÕES",
    palavrasChave: [
      "lanche", "coffee break", "café", "bolo", "salgado", "biscoito", "refrigerante", "suco", "premiação", "treinamento", "ação interna", "almoco", "almoço", "jantar", "pizza", "comida", "refeicao", "refeição", "confraternização", "confraternizacao", "evento interno", "kit lanche", "break", "doces", "chocolates", "frutas", "pão", "pao", "torta", "sanduíche", "sanduiche", "kit café", "bebidas", "snacks", "celebracao", "celebração", "coquetel", "buffet", "catering", "alimentos",
  "compra de comida", "alimentacao", "alimentação", "workshop", "curso", "reuniao", "reunião"
    ],
    descricao:
      "Lanches ou coffee break para treinamento interno, ação aprovada ou premiação.",
    observacaoUso: "Não cobre refeições pessoais."
  },
  {
    nome: "AGUA POTÁVEL",
    palavrasChave: [
      "agua", "água", "galão", "galao", "garrafa agua", "garrafa de agua", "comprar agua", "comprar água", "suprimento de água", "reposição de água", "barril de água", "barril de agua", "água mineral", "agua mineral", "bombona", "garrafão", "garrafao",
  "fornecedor de água"
    ],
    descricao:
      "Compra de galões de água mineral ou garrafas para abastecimento da equipe.",
    observacaoUso: ""
  },
  {
    nome: "BOBINA ECF",
    palavrasChave: [
      "bobina", "ecf", "cupom fiscal", "bobina impressora", "bobina pdv"
    ],
    descricao:
      "Bobinas para ECF / impressoras fiscais / PDV não centralizados.",
    observacaoUso: ""
  },
  {
    nome: "CHAVEIRO EMERGENCIAL",
    palavrasChave: [
      "chaveiro", "abrir cofre", "abrir estoque", "trocar segredo", "sem chave", "cofre", "problema cofre", "problema fechadura", "fechadura", "perdi a chave", "esqueci a chave", "chave quebrada", "troca de chave", "fazer chave", "duplicata de chave", "copia de chave", "cópia de chave", "abrir porta", "porta travada", "porta emperrada", "trancar", "trocar segredo",
      "segredo cofre", "abertura de cofre", "trocar fechadura", "concerto fechadura", "conserto fechadura", "consertar fechadura", "emergência fechadura", "serviço chaveiro", "mestre chaveiro", "tranca", "chaves", "cilindro", "miolo da chave", "reparar cofre", "reparo fechadura", "instalar fechadura"
    ],
    descricao:
      "Serviço emergencial de chaveiro para abertura de cofres, vitrines e estoques.",
    observacaoUso: "Somente em emergências operacionais."
  },
  {
    nome: "MANUTENÇÃO MAQ ESTAMPAR",
    palavrasChave: [
      "estampar", "maquina estampar", "máquina estampar", "reparo estampar"
    ],
    descricao:
      "Reparos simples ou ajustes técnicos em máquinas de estampar, sem controle patrimonial.",
    observacaoUso: ""
  }
];


    const perguntasGeraisEtiqueta = [
        "qual etiqueta devo usar","qual etiqueta usar","qual etiqueta eu uso",
        "que etiqueta devo usar","que etiqueta usar","que etiqueta eu uso",
        "me fala as etiquetas","me diz as etiquetas","me mostra as etiquetas",
        "me envia as etiquetas","me passa as etiquetas",
        "todas as etiquetas","lista de etiquetas","listagem de etiquetas",
        "quais etiquetas existem","quais etiquetas tem","quais sao as etiquetas",
        "quais são as etiquetas","quais etiquetas posso usar",
        "quais etiquetas devo usar","quais etiquetas usar",
        "categorias de gasto","categorias de despesas","categoria de despesa",
        "categoria de gasto","categoria clara","etiqueta clara", "etiqueta", "etiquetas", "categoria"
    ].map(normalize);

    const frasesPolitica = [
        "me envia a politica","me envia a política","me manda a politica","me manda a política",
        "política de uso","politica de uso do cartao","política de uso do cartão", "politica", "política",
        "politica do cartao","política do cartão","politica do cartao clara","política do cartão clara",
        "pdf da politica","pdf da política","manual da politica","manual da política",
        "politica clara","política clara","politica de uso dos cartoes","política de uso dos cartões"
    ].map(normalize);

    const frasesTermo = [
        "termo de responsabilidade",
        "termo responsabilidade",
        "termo de responsabilidade do cartao",
        "termo de responsabilidade do cartão",
        "termo do cartao",
        "termo do cartão",
        "termo de uso do cartao",
        "termo de uso do cartão",
        "termo",
        "termo clara",
        "termo do cartao clara",
        "termo do cartão clara",
        "termo de aceite",
        "termo de aceite do cartao",
        "termo de aceite do cartão",
        "assinar termo do cartao",
        "assinar termo da clara",
        "termo de responsabilidade clara"
    ].map(normalize);

    const saudacoes = [
        "oi","olá","ola","opa","eai","e aí","iae","oi vektor","ola vektor","olá vektor", "bom dia","boa tarde","boa noite", "bom dia!", "boa tarde!", "boa noite!",
        "salve","fala","fala vektor","e aí vektor","eai vektor","opa vektor", "tudo bem","td bem","tdb","como vai","como vc ta","como voce ta", "beleza","tranquilo","tudo certo", "como vai vc", "como vai você", "como tá", "como ta", "eae", "i ae"
    ].map(normalize);

    const frasesEncerramento = [
        "ok","okay","okey","certo","blz","beleza","ok valeu", "entendi","entendido","tudo certo","td certo","tds certo", "é nois q tá", "é nóis", "tmj", "tamo junto", "gratidao", "tá bom","ta bom","tá ótimo","ta otimo","tá otimo", "muito obrigado", "muito obrigada", "gratidão", "show","show de bola","valeu","vlw","obrigado","obrigada", "grato", "grata", "agradessido", "agradecida", "agradecido","agradessida","tranquilo","de boa","suave", "thanks", "tks", "pode deixar","certinho","maravilha","perfeito","jóia","joia", "joinha", "tmj cachorro", "supimpa", "excelente", "fantastico", "fantástico", "saquei"
    ].map(normalize);

    const termosPendencias = [
        "pendencia clara","pendências clara","pendencias clara",
        "bloqueio por pendencia","bloqueio por pendência",
        "pendencia do cartao","pendência do cartão",
        "loja bloqueada clara","cartão bloqueado por pendencia",
        "cobrança clara","transações pendentes clara",
        "pendencia","pendência","pendencias","pendências"
    ].map(normalize);

    const palavrasMudancaAssunto = [
        "cartao","cartão","etiqueta","categoria","politica","política","sangria",
        "bloqueio","novo","pendencia","pendência","comprar","limite","uber",
        "agua","água","lanche","fraude","contestacao","contestação","prestacao","prestação"
    ].map(normalize);


    const gatilhosNovoCartao = [
        "quero solicitar um cartao",
        "quero solicitar um cartão",
        "novo cartao",
        "novo cartão",
        "cartao novo",
        "cartão novo",
        "quero solicitar cartao clara",
        "quero solicitar cartão clara",
        "quero pedir um cartao",
        "quero pedir um cartão",
        "quero pedir cartao clara",
        "quero pedir cartão clara",
        "quero cartao clara",
        "quero cartão clara",
        "preciso de um cartao",
        "preciso de um cartão",
        "preciso de cartao clara",
        "preciso de cartão clara",
        "nao tenho cartao clara ainda",
        "não tenho cartao clara ainda",
        "nao tenho cartão clara ainda",
        "ainda nao tenho cartao clara",
        "ainda não tenho cartão clara",
        "como pedir cartao",
        "como pedir cartão",
        "como solicitar cartao",
        "como solicitar cartão",
        "como conseguir um cartao clara",
        "como conseguir um cartão clara",
        "fui promovido e nao tenho cartao",
        "fui promovido e não tenho cartão",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e não tenho cartão",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e não tenho cartão",
        "primeira via do cartao",
        "primeira via do cartão",
        "1a via do cartao",
        "1ª via do cartao",
        "1a via do cartão",
        "1ª via do cartão",
        "preciso solicitar um cartao",
        "preciso solicitar um cartão",
        "gostaria de solicitar um cartao",
        "gostaria de solicitar um cartão",
        "quero novo cartao",
        "quero novo cartão",
        "preciso novo cartao",
        "preciso novo cartão",
        "nao tenho cartao",
        "não tenho cartão",
        "nunca tive cartao",
        "nunca tive cartão"
    ].map(normalize);

    const termosPrimeiraViaDireta = [
        "primeira via",
        "1 via",
        "1a via",
        "1ª via",
        "primeiro cartao",
        "primeiro cartão",
        "meu primeiro cartao",
        "meu primeiro cartão",
        "nunca tive cartao clara",
        "nunca tive cartão clara",
        "quero minha primeira via",
        "quero 1 via",
        "pedir primeira via",
        "solicitar primeira via"
    ].map(normalize);

    const gatilhosSegundaViaDireta = [
        "segunda via",
        "2 via",
        "2a via",
        "2ª via",
        "segunda via",
        "segunda bia",
        "segundavia",
        "segunda vias",
        "segundas via",
        "segundas vias",
        "reemitir cartao",
        "reemitir cartão",
        "reemissao cartao",
        "reemissao de cartao",
        "reemissao de cartao",
        "reemissão cartão",
        "reemitir meu cartao",
        "reemitir meu cartão",
        "perdi o cartao",
        "perdi o cartão",
        "perdi meu cartao",
        "perdi meu cartão",
        "perdi o meu cartão",
        "perdi o meu cartao",
        "eu perdi o cartão",
        "eu perdi o cartao",
        "percas de cartao",
        "perca de cartão",
        "perca de cartao",
        "perda de cartao",
        "perda de cartão",
        "solicitar segunda via",
        "solicitar 2via",
        "solicitar 2 via",
        "solicitação de segunda via",
        "solicitação de 2 via",
        "roubaram meu cartao",
        "roubaram meu cartão",
        "me roubaram",
        "mi roubaram",
        "fui roubado",
        "cartao furtado",
        "furto",
        "cartão furtado",
        "roubo",
        "roubo de cartão",
        "perda de cartão",
        "perca de cartão",
        "cartao quebrado",
        "cartão quebrado",
        "cartao danificado",
        "cartão danificado"
    ].map(normalize);

    const perguntasGeraisOquePosso = [
        "o que posso comprar",
        "oq comprar com o cartão da Clara",
        "o que pode comprar",
        "o que pode comprar com o cartão",
        "o que pode comprar com o cartao",
        "oque comprar",
        "o que comprar",
        "posso comprar o que",
        "o que posso usar",
        "quais compras",
        "o que é permitido",
        "o que nao posso",
        "o que não posso",
        "o que nao posso comprar",
        "o que não posso comprar",
        "o que nao comprar",
        "o que não comprar"
    ].map(normalize);

    /* ========= INTENÇÃO ========= */

    function detectarIntencaoPergunta(msgNorm) {
        // garante que msgNorm é sempre string e cria um alias "norm"
      msgNorm = msgNorm || "";
      const norm = msgNorm;

      // RESPOSTAS SOBRE O QUE O VEKTOR FAZ
if (
    msgNorm.includes("o que voce faz") ||
    msgNorm.includes("o que voce pode fazer") ||
    msgNorm.includes("o que o vektor pode fazer") ||
    msgNorm.includes("pra que serve") ||
    msgNorm.includes("qual sua função") ||
    msgNorm.includes("quem é você") ||
    msgNorm.includes("quem e voce") ||
    msgNorm.includes("qual o seu nome") ||
    msgNorm.includes("me explique o que faz") ||
    msgNorm.includes("sobre o que voce fala") ||
    msgNorm.includes("sobre o que você fala")
) {
    return "sobreBot";
}

  const foraEscopoPadroes = [
    "palmeiras","corinthians","bolsonaro","lula","eleicao","eleição",
    "presidente","futebol","time joga","campeonato","xing","vai tomar",
    "conta de matematica","conta de matemática","2+2","raiz quadrada",
    "piada","xingar","palavrão","palavrao"
  ];
  for (const termo of foraEscopoPadroes) {
    if (msgNorm.includes(normalize(termo))) {
      return "foraEscopo";
    }
  }

  if (
    msgNorm.includes("etiqueta") ||
    msgNorm.includes("etiquetas") ||
    msgNorm.includes("qual etiqueta") ||
    msgNorm.includes("que etiqueta")
  ) {
    return "etiqueta";
  }

    // 🔹 Perguntas sobre "quais chamados / procedimentos existem no ServiceNow para a Clara"
  const falaServiceNow =
    msgNorm.includes("servicenow") ||
    msgNorm.includes("service now");

  const falaChamado =
    msgNorm.includes("chamado") ||
    msgNorm.includes("chamados") ||
    msgNorm.includes("ticket") ||
    msgNorm.includes("solicitacao") ||
    msgNorm.includes("solicitação") ||
    msgNorm.includes("solicitacoes") ||
    msgNorm.includes("solicitações") ||
    msgNorm.includes("procedimento") ||
    msgNorm.includes("procedimentos");

    const falaClara =
    msgNorm.includes("clara") ||
    msgNorm.includes("cartao") ||
    msgNorm.includes("cartão") ||
    msgNorm.includes("fatura") ||
    msgNorm.includes("cartoes") ||
    msgNorm.includes("cartões");

  if (
    (falaServiceNow && falaChamado && falaClara) ||
    // NOVO IF (Condição OU): Service Now E Chamado
    (falaServiceNow && falaChamado) ||
    

    // alguns atalhos mais diretos, caso a pessoa não escreva "clara"
    msgNorm.includes("procedimentos servicenow") ||
    msgNorm.includes("tipos de chamado da clara") ||
    msgNorm.includes("tipos de chamado clara") ||
    msgNorm.includes("chamados da clara no servicenow")
  ) {
    return "procedimentosServiceNow";
  }

    // se falar de ServiceNow + (chamado OU Clara), já manda pra procedimentosServiceNow
  if (falaServiceNow && (falaChamado || falaClara)) {
    return "procedimentosServiceNow";
  }

  // também aceita frases mais simples tipo "como abrir chamado no servicenow"
  if (falaServiceNow && norm.includes("abrir") && norm.includes("chamado")) {
    return "procedimentosServiceNow";
  }

  // fallback suave: se a pessoa só digita "servicenow" ou algo muito curto com o nome,
// também manda para os procedimentos do ServiceNow.
if (falaServiceNow && !falaChamado) {
  return "procedimentosServiceNow";
}

 // 4) Troca / afastamento / demissão de gerente, uso de cartão de outra loja
  const falaTrocaGerente =
    norm.includes("mudar de loja") ||
    norm.includes("mudanca de loja") ||
    norm.includes("mudança de loja") ||
    norm.includes("troca de loja") ||
    norm.includes("trocar de loja") ||
    norm.includes("vou mudar de loja") ||
    norm.includes("fui transferido") ||
    norm.includes("fui transferida") ||
    norm.includes("transferido de loja") ||
    norm.includes("transferida de loja") ||
    norm.includes("transferencia de loja") ||
    norm.includes("transferência de loja") ||
    norm.includes("mudei de loja") ||          // <<< ESSA AQUI ESTAVA FALTANDO PRA SUA FRASE
    norm.includes("mudei de unidade") ||
    norm.includes("trocar de unidade") ||
    norm.includes("troquei de loja") ||
    norm.includes("sou de outra loja") ||
    norm.includes("sou de outra unidade") ||

    norm.includes("gerente desligado") ||
    norm.includes("sem gerente") ||
    norm.includes("gerente saiu") ||
    norm.includes("gerente saiu da loja") ||
    norm.includes("gerente demitido") ||
    norm.includes("gerente demitida") ||
    norm.includes("gerente foi desligado") ||
    norm.includes("gerente foi desligada") ||
    norm.includes("minha loja esta sem gerente") ||
    norm.includes("minha loja está sem gerente") ||

    norm.includes("gerente afastado") ||
    norm.includes("gerente afastada") ||
    norm.includes("afastamento do gerente") ||
    norm.includes("gerente de ferias") ||
    norm.includes("gerente de férias") ||
    norm.includes("gestor de ferias") ||
    norm.includes("gestor de férias") ||

    norm.includes("gerente novo") ||
    norm.includes("novo gerente") ||
    norm.includes("novo gerente da loja") ||
    norm.includes("troca de gerente") ||
    norm.includes("troca do gerente") ||

    norm.includes("cartao de outra loja") ||
    norm.includes("cartão de outra loja") ||
    norm.includes("usar cartao de outra loja") ||
    norm.includes("usar cartão de outra loja") ||
    norm.includes("colocar cartao de outra loja") ||
    norm.includes("habilitar cartao de outra loja") ||
    norm.includes("como uso o cartao em outra loja") ||
    norm.includes("cartao nao funciona em outra loja") ||
    norm.includes("cartão não funciona em outra loja");

  if (falaTrocaGerente) {
    return "trocaGerente";
  }


  if (
    msgNorm.includes("aumentar limite") ||
    msgNorm.includes("aumento de limite") ||
    msgNorm.includes("limite maior") ||
    msgNorm.includes("limite do cartao") ||
    msgNorm.includes("limite do cartão") ||
    msgNorm.includes("limite nao basta") ||
    msgNorm.includes("limite não basta") ||
    msgNorm.includes("limite acabou") ||
    msgNorm.includes("limite estourou") ||
    msgNorm.includes("quero mais limite") ||
    msgNorm.includes("preciso de mais limite") ||
    msgNorm.includes("como aumentar meu limite") ||
    msgNorm.includes("solicitar aumento de limite") ||
    msgNorm.includes("limite baixo") ||
    msgNorm.includes("qual o limite do cartao") ||
    msgNorm.includes("qual o limite do cartão") ||
    msgNorm.includes("meu limite") ||
    msgNorm.includes("consultar limite") ||
    msgNorm.includes("ver limite") ||
    msgNorm.includes("quanto tenho de limite") ||
    msgNorm.includes("limite disponivel") ||
    msgNorm.includes("limite disponível") ||
    msgNorm.includes("baixar limite") ||
    msgNorm.includes("diminuir limite") ||
    msgNorm.includes("limite de credito") ||
    msgNorm.includes("limite de crédito") ||
    msgNorm.includes("limite total") ||
    msgNorm.includes("limite nao liberado") ||
    msgNorm.includes("limite não liberado") ||
    msgNorm.includes("limite acabou de novo") ||
    msgNorm.includes("por que meu limite nao aumenta") ||
    msgNorm.includes("por que meu limite não aumenta") ||
    msgNorm.includes("limite esgotado") ||
    msgNorm.includes("gastei o limite todo") ||
    msgNorm.includes("aumento de credito") ||
    msgNorm.includes("aumento de crédito") ||
    msgNorm.includes("ajustar limite") ||
    msgNorm.includes("liberar mais limite") ||
    msgNorm.includes("limite")
  ) {
    return "limite";
  }

  // 🔹 Transação negada / categoria bloqueada para compra
  if (
    msgNorm.includes("transacao negada") ||
    msgNorm.includes("transação negada") ||
    msgNorm.includes("transacao recusada") ||
    msgNorm.includes("transação recusada") ||
    msgNorm.includes("compra negada") ||
    msgNorm.includes("compra recusada") ||
    msgNorm.includes("compra foi recusada") ||
    msgNorm.includes("compra rejeitada") ||
    msgNorm.includes("compra nao passou") ||
    msgNorm.includes("compra não passou") ||
    msgNorm.includes("compra nao autorizada") ||
    msgNorm.includes("compra não autorizada") ||
    msgNorm.includes("transacao nao autorizada") ||
    msgNorm.includes("transação não autorizada") ||
    msgNorm.includes("transacao bloqueada") ||
    msgNorm.includes("transação bloqueada") ||
    msgNorm.includes("cartao nao passou") ||
    msgNorm.includes("cartão não passou") ||
    msgNorm.includes("cartao recusado") ||
    msgNorm.includes("cartão recusado") ||
    msgNorm.includes("cartao negado") ||
    msgNorm.includes("cartão negado") ||
    msgNorm.includes("cartao nao autorizou") ||
    msgNorm.includes("cartão não autorizou") ||
    msgNorm.includes("cartao travou na maquininha") ||
    msgNorm.includes("cartao travou na máquina") ||
    msgNorm.includes("cartao travou") ||
    msgNorm.includes("cartão travou") ||
    msgNorm.includes("nao passou o cartao") ||
    msgNorm.includes("não passou o cartão") ||
    msgNorm.includes("nao autorizou a compra") ||
    msgNorm.includes("não autorizou a compra") ||
    msgNorm.includes("recusou a compra") ||
    msgNorm.includes("recusou o pagamento") ||
    msgNorm.includes("falha na compra") ||
    msgNorm.includes("falha de pagamento") ||
    msgNorm.includes("erro na compra") ||
    msgNorm.includes("erro de pagamento") ||
    msgNorm.includes("erro no cartao") ||
    msgNorm.includes("erro no cartão") ||
    msgNorm.includes("compra deu erro") ||
    msgNorm.includes("pagamento negado") ||
    msgNorm.includes("pagamento recusado") ||
    msgNorm.includes("pagamento bloqueado") ||
    msgNorm.includes("categoria bloqueada") ||
    msgNorm.includes("categoria bloqueado") ||
    msgNorm.includes("categoria nao liberada") ||
    msgNorm.includes("tentando usar o cartão") ||
    msgNorm.includes("tentando usar o cartao") ||
    msgNorm.includes("categoria não liberada") ||
    msgNorm.includes("liberar categoria") ||
    msgNorm.includes("liberacao de categoria") ||
    msgNorm.includes("tentei passar o cartão e deu erro") ||
    msgNorm.includes("tentar passar o cartão") ||
    msgNorm.includes("tentar passar o cartao") ||
    msgNorm.includes("tentar usar o cartao") ||
    msgNorm.includes("tentar usar o cartão") ||
    msgNorm.includes("tentei passar o cartao e deu erro") ||
    msgNorm.includes("a compra foi recusada na maquininha") ||
    msgNorm.includes("não consegui usar o cartão") ||
    msgNorm.includes("não consegui usar o cartao") ||
    msgNorm.includes("nao consegui usar o cartao") ||
    msgNorm.includes("liberação de categoria") ||
    msgNorm.includes("mcc bloqueado") ||
    msgNorm.includes("codigo bloqueado") ||
    msgNorm.includes("código bloqueado") ||
    msgNorm.includes("nao liberou") ||
    msgNorm.includes("não liberou") ||
    msgNorm.includes("nao conseguiu passar") ||
    msgNorm.includes("não conseguiu passar") ||
    msgNorm.includes("nao consegui usar") ||
    msgNorm.includes("não consegui usar") ||
    msgNorm.includes("tentei usar e nao foi") ||
    msgNorm.includes("tentei usar e não foi") ||
    msgNorm.includes("tentei comprar e deu erro") ||
    msgNorm.includes("tentou passar e nao foi") ||
    msgNorm.includes("tentou passar e não foi") ||
    msgNorm.includes("nao aceitou") ||
    msgNorm.includes("não aceitou") ||
    msgNorm.includes("nao deu certo a compra") ||
    msgNorm.includes("não deu certo a compra") ||
    msgNorm.includes("bloqueou a compra") ||
    msgNorm.includes("bloqueou a transacao") ||
    msgNorm.includes("bloqueou a transação") ||
    msgNorm.includes("compra nao permitida") ||
    msgNorm.includes("compra não permitida") ||
    msgNorm.includes("transacao nao permitida") ||
    msgNorm.includes("transação não permitida")
  ) {
    return "transacaoNegadaCategoria";
  }

  if (
    msgNorm.includes("bloqueou") ||
    msgNorm.includes("bloqueado") ||
    msgNorm.includes("desbloquear") ||
    msgNorm.includes("cartao travou") ||
    msgNorm.includes("cartão travou") ||
    msgNorm.includes("travou o cartao") ||
    msgNorm.includes("travou o cartão") ||
    msgNorm.includes("bloquear cartao") ||
    msgNorm.includes("bloquear cartão") ||
    msgNorm.includes("queria bloquear") ||
    msgNorm.includes("quero bloquear") ||
    msgNorm.includes("como bloquear") ||
    msgNorm.includes("cartao bloqueado") ||
    msgNorm.includes("cartão bloqueado") ||
    msgNorm.includes("meu cartao nao funciona") ||
    msgNorm.includes("meu cartão não funciona") ||
    msgNorm.includes("meu cartão tá bloqueado") ||
    msgNorm.includes("pq meu cartão tá bloqueadp") ||
    msgNorm.includes("pq meu cartão tá bloqueado") ||
    msgNorm.includes("meu cartao ta bloqueado") ||
    msgNorm.includes("nao consigo usar o cartao") ||
    msgNorm.includes("não consigo usar o cartão") ||
    msgNorm.includes("problema no cartao") ||
    msgNorm.includes("problema no cartão") ||
    msgNorm.includes("suspender cartao") ||
    msgNorm.includes("suspender cartão") ||
    msgNorm.includes("suspender o uso") ||
    msgNorm.includes("o cartao parou") ||
    msgNorm.includes("o cartão parou") ||
    msgNorm.includes("ativar cartao") ||
    msgNorm.includes("ativar cartão") ||
    msgNorm.includes("reativar cartao") ||
    msgNorm.includes("reativar cartão") ||
    msgNorm.includes("travamento") ||
    msgNorm.includes("por que nao funciona") ||
    msgNorm.includes("por que não funciona") ||
    msgNorm.includes("desliguei o cartao") ||
    msgNorm.includes("desliguei o cartão") ||
    msgNorm.includes("bloqueio preventivo")
  ) {
    return "bloqueio";
  }

  // -------------------------------------------------------------
// RESPOSTAS DE JUSTIFICATIVAS / NOTAS / PERDA DE COMPROVANTE
// -------------------------------------------------------------
if (
  msgNorm.includes("como justificar") ||
  msgNorm.includes("vídeo de justificativa") ||
  msgNorm.includes("video de justificativa") ||
  msgNorm.includes("vídeo de justificativas") ||
  msgNorm.includes("video de justificativas") ||
  msgNorm.includes("como justificar essa compra") ||
  msgNorm.includes("como envio comprovante?") ||
  msgNorm.includes("justificar compra") ||
  msgNorm.includes("prestar contas") ||
  msgNorm.includes("prestacao de contas") ||
  msgNorm.includes("prestação de contas") ||
  msgNorm.includes("colocar nota") ||
  msgNorm.includes("inserir nota") ||
  msgNorm.includes("anexar nota") ||
  msgNorm.includes("descricao na clara") ||
  msgNorm.includes("como inserir nota") ||
  msgNorm.includes("nota fiscal") ||
  msgNorm.includes("como lançar despesas na clara?") ||
  msgNorm.includes("nota da compra") ||
  msgNorm.includes("escrever justificativa") ||
  msgNorm.includes("como colocar justificativa") ||
  msgNorm.includes("comprovante") ||
  msgNorm.includes("comprovantes") ||
  msgNorm.includes("comprovante de compra") ||
  msgNorm.includes("comprovacao de despesa") ||
  msgNorm.includes("comprovação de despesa") ||
  msgNorm.includes("registro de despesa") ||
  msgNorm.includes("lançar despesa") ||
  msgNorm.includes("lancamento de despesa") ||
  msgNorm.includes("lançamento de despesa") ||
  msgNorm.includes("reembolso sem nota") ||
  msgNorm.includes("perdi a nota") ||        // << IMPORTANTE
  msgNorm.includes("despesa sem comprovante") ||
  msgNorm.includes("colocar comprovante") ||
  msgNorm.includes("como declarar") ||
  msgNorm.includes("declarar despesa") ||
  msgNorm.includes("como finalizar prestacao") ||
  msgNorm.includes("como finalizar prestação") ||
  msgNorm.includes("relatorio de despesa") ||
  msgNorm.includes("relatório de despesa") ||
  msgNorm.includes("enviar nota") ||
  msgNorm.includes("falta a nota") ||
  msgNorm.includes("despesa sem nota") ||
  msgNorm.includes("finalizar contas") ||
  msgNorm.includes("minhas prestacoes") ||
  msgNorm.includes("minhas prestações") ||
  msgNorm.includes("descrição na clara")
) {

  // 1. Mensagem bem específica caso tenha perdido a nota
  if (
    msgNorm.includes("perdi a nota") ||
    msgNorm.includes("falta a nota") ||
    msgNorm.includes("despesa sem nota") ||
    msgNorm.includes("despesa sem comprovante")
  ) {
    renderBotMessage("HTML:" +
      `<p class="text-sm text-slate-700">
        Quando a loja perde a nota fiscal, deve abrir uma <b>ocorrência formal de extravio</b> e anexar esse documento no app da Clara, como justificativa da transação. O financeiro irá avaliar o caso. Ocorrências recorrentes podem gerar recusa definitiva.
      </p>`
    );
  } else {
    // 2. Mensagem geral de justificativa
    renderBotMessage("HTML:" +
      `<p class="text-sm text-slate-700">
        Para justificar uma compra no app da Clara, basta abrir a transação, escrever a descrição e anexar o comprovante ou nota fiscal correspondente.
      </p>`
    );
  }

  // 3. Enviar automaticamente o vídeo de justificativas
  const videoHtml = [
  "<div style='margin-top:8px; text-align:center;'>",
  "  <p class='text-sm text-slate-700' style='text-align:center;'>",
  "    Assista ao vídeo abaixo, explicando sobre o procedimento de justificativas no app da Clara.",
  "    Clique nos 3 pontos do lado direito inferior e escolha ",
  "    <b style='color:#005E27;'>Picture-in-picture</b> ",
  "    para ver em um formato melhor:",
  "  </p>",
  "  <div style='width:100%; display:flex; justify-content:center; margin-top:12px;'>",
  "    <video controls style='width:100%; max-width:480px; border-radius:8px; object-fit:contain;'>",
  "      <source src='https://raw.githubusercontent.com/rslisboa/cartoesclara/4fad8ce4eda430baf37ecccd7d480a77f759af27/Video%20Clara%20(4).mp4' type='video/mp4'>",
  "      Seu navegador não suporta vídeo HTML5.",
  "    </video>",
  "  </div>",
  "</div>"
].join("");

  renderBotMessage("HTML:" + videoHtml);
  return null;
}

  if (
    msgNorm.includes("lanche") ||
    msgNorm.includes("lanche pro time") ||
    msgNorm.includes("lanche para o time") ||
    msgNorm.includes("cafe pro time") ||
    msgNorm.includes("café pro time") ||
    msgNorm.includes("coffee break") ||
    msgNorm.includes("agua") ||
    msgNorm.includes("água") ||
    msgNorm.includes("galão") ||
    msgNorm.includes("galao") ||
    msgNorm.includes("premiacao") ||
    msgNorm.includes("premiação")
  ) {
    return "alimentoTime";
  }

  if (
    msgNorm.includes("uber") ||
    msgNorm.includes("iber") ||
    msgNorm.includes(" 99") ||
    msgNorm.includes("taxi") ||
    msgNorm.includes("táxi") ||
    msgNorm.includes("taxí") ||
    msgNorm.includes("cabify") ||
    msgNorm.includes("transporte") ||
    msgNorm.includes("aplicativo de transporte") ||
    msgNorm.includes("motorista de aplicativo") ||
    msgNorm.includes("carro por app") ||
    msgNorm.includes("carona") ||
    msgNorm.includes("como chamar um carro") ||
    msgNorm.includes("como pedir um carro") ||
    msgNorm.includes("uber black") ||
    msgNorm.includes("uber x") ||
    msgNorm.includes("99 pop") ||
    msgNorm.includes("99taxi") ||
    msgNorm.includes("uber drive") ||
    msgNorm.includes("uber motorista") ||
    msgNorm.includes("uber pass") ||
    msgNorm.includes("uber eats") ||
    msgNorm.includes("serviço de transporte") ||
    msgNorm.includes("qual app de carro") ||
    msgNorm.includes("motorista particular") ||
    msgNorm.includes("drive") ||
    msgNorm.includes("drivi") ||
    msgNorm.includes("indriver") ||
    msgNorm.includes("in driver") ||
    msgNorm.includes("waze carpool") ||
    msgNorm.includes("waze car pool") ||
    msgNorm.includes("taxi particular") ||
    msgNorm.includes("taxi 99") ||
    msgNorm.includes("app de taxi") ||
    msgNorm.includes("app de táxi") ||
    msgNorm.includes("app de transporte")
  ) {
    return "transportePessoal";
  }

  const temGerenteOuGestor =
  msgNorm.includes("gerente") ||
  msgNorm.includes("gerentes") ||
  msgNorm.includes("gestor") ||
  msgNorm.includes("gestora");

const temFerias =
  msgNorm.includes("ferias"); // já está normalizado sem acento

const temAfastamento =
  msgNorm.includes("afastado")  ||
  msgNorm.includes("afastada")  ||
  msgNorm.includes("afastados") ||
  msgNorm.includes("afastadas") ||
  msgNorm.includes("afastamento");

const temDesligamento =
  msgNorm.includes("desligado")  ||
  msgNorm.includes("desligada")  ||
  msgNorm.includes("demitido")   ||
  msgNorm.includes("demitida")   ||
  msgNorm.includes("demissao")   ||
  msgNorm.includes("demissão");

if (
  // seus casos antigos de troca de loja, cartão de outra loja, etc...
  msgNorm.includes("mudar de loja") ||
  msgNorm.includes("troca de loja") ||
  // ... (mantenha o que já tem aqui)

  // gerente de férias / gestor de férias
  (temGerenteOuGestor && temFerias) ||

  // gerente afastado / afastamento do gerente
  (temGerenteOuGestor && temAfastamento) ||

  // gerente foi desligado / demitido
  (temGerenteOuGestor && temDesligamento)
) {
  return "trocaGerente";
}

  if (
    msgNorm.includes("sangria") ||
    msgNorm.includes("sangrias") ||
    msgNorm.includes("fazer sangria") ||
    msgNorm.includes("puxar dinheiro do caixa") ||
    msgNorm.includes("retirar dinheiro do caixa") ||
    msgNorm.includes("tirar dinheiro do caixa") ||
    msgNorm.includes("retirada de dinheiro do caixa") ||
    msgNorm.includes("movimentacao de dinheiro no caixa") ||
    msgNorm.includes("movimentação de dinheiro no caixa") ||
    msgNorm.includes("fechar o caixa") ||
    msgNorm.includes("como fechar o caixa") ||
    msgNorm.includes("retirar valor do caixa") ||
    msgNorm.includes("como fazer sangria") ||
    msgNorm.includes("registrar saida de dinheiro") ||
    msgNorm.includes("registrar saída de dinheiro") ||
    msgNorm.includes("saida de dinheiro do caixa") ||
    msgNorm.includes("saída de dinheiro do caixa") ||
    msgNorm.includes("suprimento") ||
    msgNorm.includes("suprimentos") ||
    msgNorm.includes("fazer suprimento") ||
    msgNorm.includes("colocar dinheiro no caixa") ||
    msgNorm.includes("registro de suprimento") ||
    msgNorm.includes("registro de retirada") ||
    msgNorm.includes("registrando sangria") ||
    msgNorm.includes("registro de sangria") ||
    msgNorm.includes("tirar troco do caixa") ||
    msgNorm.includes("depositar dinheiro no caixa") ||
    msgNorm.includes("deposito no caixa") ||
    msgNorm.includes("depósito no caixa") ||
    msgNorm.includes("remocao de dinheiro") ||
    msgNorm.includes("remoção de dinheiro") ||
    msgNorm.includes("retirar excesso") ||
    msgNorm.includes("dinheiro a mais no caixa") ||
    msgNorm.includes("ajuste de caixa") ||
    msgNorm.includes("retirar dinheiro do caixa")
  ) {
    return "sangria";
  }

  if (
    msgNorm.includes("nao reconheco") ||
    msgNorm.includes("não reconheço") ||
    msgNorm.includes("fraude") ||
    msgNorm.includes("compra indevida") ||
    msgNorm.includes("contestar compra") ||
    msgNorm.includes("contestacao") ||
    msgNorm.includes("compra que nao fiz") ||
    msgNorm.includes("compra que não fiz") ||
    msgNorm.includes("nao fiz essa compra") ||
    msgNorm.includes("não fiz essa compra") ||
    msgNorm.includes("compra desconhecida") ||
    msgNorm.includes("uso indevido") ||
    msgNorm.includes("estorno") ||
    msgNorm.includes("quero estornar") ||
    msgNorm.includes("quero cancelar compra") ||
    msgNorm.includes("cancelar compra indevida") ||
    msgNorm.includes("compra suspeita") ||
    msgNorm.includes("transacao nao reconhecida") ||
    msgNorm.includes("transação não reconhecida") ||
    msgNorm.includes("cartao clonado") ||
    msgNorm.includes("clonaram meu cartao") ||
    msgNorm.includes("clonaram meu cartão") ||
    msgNorm.includes("roubaram meu cartao") ||
    msgNorm.includes("roubaram meu cartão") ||
    msgNorm.includes("uso nao autorizado") ||
    msgNorm.includes("uso não autorizado") ||
    msgNorm.includes("quero o dinheiro de volta") ||
    msgNorm.includes("reembolso") ||
    msgNorm.includes("solicitar estorno") ||
    msgNorm.includes("transacao suspeita") ||
    msgNorm.includes("tentativa de fraude") ||
    msgNorm.includes("estorno da compra") ||
    msgNorm.includes("cai em golpe") ||
    msgNorm.includes("golpe no cartao") ||
    msgNorm.includes("golpe no cartão") ||
    msgNorm.includes("fui roubado") ||
    msgNorm.includes("contestação")
  ) {
    return "fraudeContestacao";
  }

  // aqui você PODE manter um único bloco de cartaoGeral (não dois)

  if (
    msgNorm.includes("posso comprar") ||
    msgNorm.includes("posso usar") ||
    msgNorm.includes("pode usar") ||
    msgNorm.includes("pode pagar") ||
    msgNorm.includes("pode gastar") ||
    msgNorm.includes("pode comprar") ||
    msgNorm.includes("o que pode comprar") ||
    msgNorm.includes("oq eu posso comprar com o cartão") ||
    msgNorm.includes("oq pode comprar") ||
    msgNorm.includes("pode no cartao") ||
    msgNorm.includes("pode no cartão") ||
    msgNorm.includes("pode colocar no cartao") ||
    msgNorm.includes("pode colocar no cartão") ||
    msgNorm.includes("posso usar o cartao para") ||
    msgNorm.includes("posso usar o cartão para") ||
    msgNorm.includes("para que posso usar") ||
    msgNorm.includes("o que da pra pagar") ||
    msgNorm.includes("oq da pra pagar") ||
    msgNorm.includes("o que da para pagar") ||
    msgNorm.includes("posso pagar") ||
    msgNorm.includes("oq pagar") ||
    msgNorm.includes("pagar com o cartao") ||
    msgNorm.includes("pagar com o cartão") ||
    msgNorm.includes("oque posso pagar") ||
    msgNorm.includes("o q posso pagar") ||
    msgNorm.includes("oq eu posso pagar") ||
    msgNorm.includes("eu posso pagar") ||
    msgNorm.includes("posso passar o cartao") ||
    msgNorm.includes("posso passar o cartão") ||
    msgNorm.includes("oq eu gasto") ||
    msgNorm.includes("o que posso gastar") ||
    msgNorm.includes("posso usar cartao") ||
    msgNorm.includes("posso usar cartão") ||
    msgNorm.includes("o que posso fazer") ||
    msgNorm.includes("oq da pra fazer") ||
    msgNorm.includes("posso adquirir") ||
    msgNorm.includes("que da pra adquirir") ||
    msgNorm.includes("para que serve o cartao") ||
    msgNorm.includes("para que serve o cartão") ||
    msgNorm.includes("em que posso usar") ||
    msgNorm.includes("em que eu posso usar") ||
    msgNorm.includes("oq pode pagar") ||
    msgNorm.includes("pode ser pago") ||
    (typeof perguntasGeraisOquePosso !== "undefined" &&
     perguntasGeraisOquePosso.some(f => msgNorm.includes(f)))
  ) {
    return "podeNaoPode";
  }

  // Conversa geral sobre cartão Clara
  if (
    msgNorm.includes("cartao clara") ||
    msgNorm.includes("cartão clara") ||
    (msgNorm.includes("cartao") && msgNorm.includes("clara")) ||
    (msgNorm.includes("cartão") && msgNorm.includes("clara")) ||
    msgNorm.includes("cartao das lojas") ||
    msgNorm.includes("cartão das lojas") ||
    msgNorm.includes("cartao nas lojas") ||
    msgNorm.includes("cartão nas lojas") ||
    msgNorm.includes("falar sobre o cartao") ||
    msgNorm.includes("falar sobre o cartão") ||
    msgNorm.includes("informacoes sobre o cartao") ||
    msgNorm.includes("informações sobre o cartão") ||
    msgNorm.includes("duvida sobre o cartao") ||
    msgNorm.includes("dúvida sobre o cartão") ||
    msgNorm.includes("tudo sobre a clara") ||
    msgNorm.includes("como funciona a clara") ||
    msgNorm.includes("o que é a clara") ||
    msgNorm.includes("o que e a clara") ||
    msgNorm.includes("o q e a clara") ||
    msgNorm.includes("cartao corporativo") ||
    msgNorm.includes("cartão corporativo") ||
    msgNorm.includes("cartao de credito corporativo") ||
    msgNorm.includes("cartão de crédito corporativo") ||
    msgNorm.includes("duvida clara") ||
    msgNorm.includes("dúvida clara")
  ) {
    return "cartaoGeral";
  }

  return "generica";
}

// Bloco HTML para o relatório gerencial da Clara (Looker Studio)
const htmlRelatorioGerencial = [
  "<div class='w-full'>",
  "  <div class='w-full mt-1'>",
  "    <iframe",
  "      src='https://lookerstudio.google.com/embed/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF'",
  "      width='100%'",
  "      height='6630'",
  "      frameborder='0'",
  "      style='border:0;border-radius:0.75rem;'",
  "      allowfullscreen",
  "      sandbox='allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox'>",
  "    </iframe>",
  "  </div>",
  "</div>"
].join("");

function respProcedimentosServiceNow() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Principais procedimentos de Cartão Clara no ServiceNow (Anexo II da Política)</b></p>' +

      '<p class="mt-2">' +
        'O Anexo II da política organiza os principais fluxos de chamado no <b>ServiceNow</b> para temas de cartão Clara.' +
        ' De forma resumida, os tipos mais importantes são:' +
      '</p>' +

      '<ul class="list-disc ml-4 mt-2 space-y-1">' +
        '<li>' +
          '<b>Fraude / contestação de transação</b><br>' +
          'Usado quando há suspeita de fraude ou lançamento indevido pelo estabelecimento.' +
          ' Normalmente exige anexar boletim de ocorrência ou evidências e detalhar data, valor e loja.' +
        '</li>' +

        '<li>' +
          '<b>Desbloqueio de cartão após atraso de comprovantes</b><br>' +
          'Quando o cartão foi bloqueado porque a loja deixou de anexar nota/comprovante dentro do prazo.' +
          ' O chamado é usado para comprovar que as pendências foram regularizadas e solicitar o desbloqueio.' +
        '</li>' +

        '<li>' +
          '<b>Ajuste excepcional de limite</b><br>' +
          'Para situações pontuais em que o limite padrão do cartão não cobre uma demanda específica' +
          ' (ex.: obra emergencial autorizada, ação oficial maior). Sempre exige justificativa e aprovação.' +
        '</li>' +

        '<li>' +
        '<b>Troca de Gerente (mudança entre lojas)</b><br>' +
        'Chamado usado quando um gerente que possui cartão Clara é transferido de uma loja para outra.' +
        ' É obrigatório informar a BU (ex.: Centauro, Fisia), a loja de origem, a loja de destino e a data efetiva da troca,' +
        ' para que o cartão fique vinculado corretamente à nova unidade.' +
        ' O cartão físico deve acompanhar o gerente na mudança e continua sendo utilizado na nova loja após o ajuste cadastral.' +
        ' Esse fluxo também é o caminho para formalizar trocas definitivas de responsável, em conjunto com as orientações de afastamento/demissão de gerente na política.' +
      '</li>' +

        '<li>' +
          '<b>Inserção ou ajuste de etiqueta</b><br>' +
          'Chamado para incluir nova etiqueta na Clara ou ajustar etiqueta existente,' +
          ' quando um tipo de gasto recorrente não se encaixa bem nas opções atuais.' +
        '</li>' +

        '<li>' +
          '<b>Gasto indevido (pessoal) / ressarcimento</b><br>' +
          'Quando o cartão foi usado para despesa pessoal ou fora da política.' +
          ' O chamado registra o caso, a forma de ressarcimento e o acompanhamento pelo Financeiro.' +
        '</li>' +
      '</ul>' +

      '<p class="mt-3">' +
        'Eu não abro o chamado por você, mas te ajudo a escolher <b>qual tipo de solicitação</b> faz sentido' +
        ' e a chegar com o texto certo no ServiceNow.' +
      '</p>' +

      '<p class="mt-2"><a href="https://sn.gruposbf.com.br/sp?id=sc_cat_item&sys_id=97ee1f9f8714e910d26c63d30cbb35f9" target="_blank" class="text-blue-600 underline">Clique aqui e acesse o ServiceNow para abertura de chamados.</a></p>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Estrutura baseada no Anexo II – Solicitações no ServiceNow da Política de Utilização dos Cartões Clara.' +
        ' Sempre siga os caminhos e nomes exatos de categoria que estiverem atualizados no catálogo do ServiceNow.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}


    /* ========= ETIQUETA POR MENSAGEM ========= */

    function acharEtiquetaPorMensagem(msgNorm) {
        const stopTerms = [
            "etiqueta","qual etiqueta","que etiqueta","categoria","qual categoria",
            "classificacao","classificação","tag","pode usar","posso usar",
            "posso comprar","pode comprar","cartao","cartão","cartao clara",
            "cartão clara","clara","limite","ajuda","duvida","dúvida"
        ].map(normalize);

        const palavras = msgNorm.split(/\s+/);

        let melhorMatch = null;
        let melhorForca = 0;

        for (const et of etiquetasOficiais) {
            let forcaAtual = 0;

            for (const termoOriginal of et.palavrasChave) {
                const termoNorm = normalize(termoOriginal);
                if (stopTerms.includes(termoNorm)) continue;

                if (palavras.includes(termoNorm)) {
                    forcaAtual += 2;
                }
                if (msgNorm.includes(termoNorm)) {
                    forcaAtual += 1;
                }
            }

            if (forcaAtual > melhorForca) {
                melhorForca = forcaAtual;
                melhorMatch = et;
            }
        }

        if (melhorForca === 0) return null;
        return melhorMatch;
    }

                /* ========= AVALIAÇÃO DE COMPRA ========= */

    const gruposProibidos = {
        eletrodomesticos: [
            "geladeira", "microondas", "micro-ondas", "friogrifico", "freezer", "frigobar", "Geladeira",
            "Refrigerador", "Fogão", "Cooktop", "Forno", "Máquina de Lavar Louças", "Coifa", "Depurador",
            "Purificador de Água", "Máquina de Lavar Roupas", "Secadora de Roupas", "Centrífuga", "secadora",
            "secadora de louças", "lavadora", "lava-roupas", "lava e seca", "lava-louças", "exaustor", "purificador",
            "bebedouro", "forno-microondas"
        ].map(normalize),

        eletroportateis: [
            "Liquidificador", "Batedeira", "Processador de Alimentos", "Mixer", "Air Fryer", "airfryer", "airfrier",
            "Panela Elétrica", "Máquina de Pão", "Máquina de Waffle", "Cafeteira", "Chaleira", "Extrator de Suco",
            "Torradeira", "Sanduicheira", "Pipoqueira Elétrica", "Abridor de Lata Elétrico", "Abridor de Vinho Elétrico",
            "ferro", "ferro de passar", "Ferro de Passar Roupa", "Máquina de Costura", "Aspirador de Pó",
            "Lavadora de Jato de Água", "Limpadora a Vapor", "Secador de Cabelo", "Chapinha", "Prancha",
            "Barbeador Elétrico", "barbeador", "Escova de Dente Elétrica", "escova de dente", "vaporizador"
        ].map(normalize),

        climatizacao: [
            "compressor", "ventilador", "ar condicionado", "ar-condicionado", "Ventilador", "Aquecedor Elétrico",
            "Desumidificador", "compressor de ar", "aquecedor", "climatizador"
        ].map(normalize),

        moveisUtensiliosCasa: [
            "mesa", "cadeira", "sofá", "poltrona", "armário", "cômoda", "estante", "tapete", "persiana", "lustre",
            "aquario", "aquarios", "churraqueira", "carvão", "churrasco", "cadeira de balanço", "carrinho de bebê"
        ].map(normalize),

        eletronicos: [
            "tv", "controle de tv", "controle remoto", "televisao", "televisão", "home theater", "hometheater", "som ambiente", "caixa de som grande", "caixa de som", "soundbar", "Celulares", "celular", "Smartphones", "Tablets", "Computadores", "computador", "notebook", "Monitores", "Impressoras", "Scanners", "Roteadores", "Modems", "HD", "SSD", "Calculadoras",
            "Televisores", "calculadora", "Aparelhos de Som", "Caixas de Som", "Fones de Ouvido", "Reprodutores de Mídia",
            "dvd", "Câmeras Fotográficas Digitais", "Câmeras de Vídeo", "Câmeras de Segurança", "Câmeras de Monitoramento",
            "Smartwatches", "Pulseiras Fitness", "Controles Remotos", "Carregadores Portáteis", "Power Bank", "powerbank",
            "power bank", "Lanterna Elétrica", "lanterna", "relógio", "relogios", "relógios", "projetor", "telao",
            "telão", "tela gigante", "drone", "GoPro", "câmera de ação", "gimbal", "tablet", "smartwatch",
            "oculos", "óculos", "gps"
        ].map(normalize),

        games: [
            "ps5", "xbox", "x-box", "PS5", "ps4", "playstation", "video game", "videogame", "jogos de videogame",
            "jogo de video game", "jogos de video game", "Consoles de Videogame", "game pass", "ps plus",
            "xbox live", "recarga de jogo", "moeda de jogo", "skin de jogo", "pacote de expansão", "jogo digital",
            "joguinho", "e-sports", "jogos online", "software de entretenimento", "ingresso virtual"
        ].map(normalize),

        veiculos: [
            "avião", "caminhão", "carro", "veiculo", "veículo", "moto", "ferrari", "lamborghini", "bicicleta", "lancha",
            "iate", "jet ski", "barco", "trem", "ônibus", "trator", "máquina agrícola", "patinete elétrico", "patinete",
            "hoverboard", "caminhonete", "aviao", "aviões"
        ].map(normalize),

        instrumentosMusicais: [
            "violão", "violao", "violões", "guitarra", "baixo", "violino", "viola", "violoncelo", "contrabaixo", "harpa",
            "bandolim", "cavaquinho", "ukulele", "banjo", "cravo", "piano", "teclado", "sintetizador", "órgão",
            "flauta", "flautim", "clarinete", "saxofone", "oboé", "fagote", "trompete", "trombone", "tuba", "trompa",
            "harmônica", "gaita", "acordeão", "escaleta", "bateria", "tambor", "caixa", "surdo", "pandeiro", "triângulo",
            "prato", "chimbal", "bumbo", "tímpano", "xilofone", "marimba", "vibrafone", "glockenspiel", "sinos",
            "caxixi", "agogô", "reco-reco", "cuíca", "berimbau", "atabaque", "conga", "bongô", "maraca", "castanhola",
            "tamborim", "adufe", "tarol", "repique", "tam-tam", "djembe", "rabeca", "alaúde", "balalaica",
            "sitar", "koto", "shamisen", "didgeridoo", "ocarina", "eufônio", "sousafone", "celesta", "theremin", "sampler",
            "sequenciador", "messing", "harpsichord", "clavicórdio", "dulcimer", "rabeca chuleira", "gaita de fole",
            "violino popular", "xilarmónico", "bombardino", "violone", "fliscorne", "clarim", "daxofone", "estradivário",
            "figle", "museta", "oficleide", "takuapu", "matraca", "címbalo", "gongo", "prato de bateria", "guitar"
        ].map(normalize),

        ferramentas: [
            "furadeira", "parafusadeira", "serra elétrica", "compressor de ar"
        ].map(normalize),

        animais: [
            "animais", "vaca", "mamífero", "mamíferos", "ave", "aves", "pássaro", "pássaros", "inseto", "insetos", "peixe",
            "peixes", "réptil", "répteis", "anfíbio", "anfíbios", "vertebrado", "vertebrados", "invertebrado", "invertebrados",
            "felino", "felinos", "canídeo", "canídeos", "roedor", "roedores", "primata", "primatas", "cerval", "cervais",
            "equino", "equinos", "bovino", "bovinos", "suíno", "suínos", "ovino", "ovinos", "caprino", "caprinos", "cão",
            "cachorro", "gato", "leão", "tigre", "onça", "lobo", "raposa", "urso", "elefante", "rinoceronte", "hipopótamo",
            "girafa", "zebra", "macaco", "chimpanzé", "gorila", "orangotango", "morcego", "coelho", "lebre", "esquilo",
            "rato", "camundongo", "capivara", "porco-espinho", "tatu", "tamanduá", "preguiça", "baleia", "golfinho",
            "tubarão", "peixe-boi", "foca", "leão-marinho", "sapo", "rã", "perereca", "cobra-cega", "salamandra",
            "crocodilo", "jacaré", "tartaruga", "cágado", "jabuti", "lagarto", "camaleão", "cobra", "serpente",
            "papagaio", "arara", "tucano", "coruja", "águia", "falcão", "pardal", "canário", "pintassilgo", "beija-flor",
            "gaivota", "pinguim", "avestruz", "ema", "pato", "ganso", "cisne", "galinha", "peru", "codorna", "mosquito",
            "mosca", "formiga", "abelha", "vespa", "borboleta", "mariposa", "besouro", "joaninha", "libélula", "gafanhoto",
            "barata", "aranha", "escorpião", "carrapato", "siri", "caranguejo", "lagosta", "camarão", "polvo", "lula",
            "estrela-do-mar", "ouriço-do-mar", "água-viva", "medusa", "coral", "anêmona", "esponja-do-mar", "caracol",
            "lesma", "ostra", "mexilhão", "verme", "minhoca", "sanguessuga", "centopeia", "lacraia", "peixe-palhaço",
            "dourado", "salmão", "tilápia", "bacalhau", "sardinha", "atum", "enguia", "arraia", "cavalo-marinho",
            "sapo-boi", "rã-touro", "hiena", "chacal", "píton", "jibóia", "iguana", "gecko", "periquito", "andorinha",
            "grilo", "pulga", "ácaro", "cachorros", "gatos", "cães", "ração", "rações"
        ].map(normalize),

        armasGuerra: [
            "tanque", "tanque de guerra", "guerra", "metranca", "metralhadora", "bomba", "C4", "nuclear", "fuzil",
            "fuzil de assalto", "fuzil semiautomático", "fuzil de precisão", "rifle", "carabina", "submetralhadora",
            "metralhadora pesada", "metralhadora leve", "pistola", "revólver", "espingarda", "munição", "munições",
            "cartucho", "bala", "projétil", "granada", "morteiro", "míssil", "mísseis", "bazuca", "lança-foguetes",
            "canhão", "obuseiro", "torpedo", "mina terrestre", "arma química", "arma biológica", "arma nuclear",
            "faca tática", "baioneta", "faca de combate", "machado tático", "silenciador", "supressor",
            "colete balístico", "colete a prova de balas", "capacete militar", "capacete tático", "máscara de gás",
            "gás lacrimogêneo", "câmera de visão noturna", "óculos tático", "luva tática", "botas militares",
            "coturno", "farda", "uniforme camuflado", "roupa tática", "coldre", "porta carregador", "bolso modular",
            "cinto tático", "joelheira tática", "cotoveleira tática", "placa balística", "placas balísticas", "bandoleira",
            "blindado", "carro de combate", "veículo blindado", "lança mísseis", "porta-aviões", "navio de guerra",
            "submarino", "drone militar", "veículo aéreo não tripulado", "aeronave de caça", "jato de caça",
            "bombardeiro", "avião militar", "helicóptero militar", "caminhão militar", "jeep militar", "helicopero",
            "mochila militar", "mochila tática", "kit primeiros socorros tático", "kit sobrevivência", "cantil",
            "cantil militar", "saco de dormir militar", "binóculo", "telêmetro", "bússola", "gps tático",
            "lanterna tática", "apito tático", "marmita militar", "pazinha de trincheira", "B2", "bunker", "missel",
            "armas"
        ].map(normalize),

        bensServicosAbstratos: [
            "diamante", "ouro", "prata", "joia", "bracelete", "colar", "quadro", "escultura", "pintura", "ações",
            "criptomoeda", "títulos", "bonds", "consulta médica", "terapia", "psicólogo", "exames", "tratamentos",
            "cirurgia", "plano de saúde", "curso", "faculdade", "mentoria", "aluguel", "imposto", "multa", "reforma",
            "manutenção", "limpeza", "seguro", "doação", "gorjeta", "champanhe", "champagne", "viagem", "piscina",
            "piso", "porcelanato", "tijolo", "bloco", "universo", "planeta", "sol", "furacao", "aeroporto", "lua",
            "parque de diversão", "cinema", "parque", "ingresso", "ingressos", "teatro", "museu", "exposição",
            "espetáculo", "circense", "ópera", "concerto", "balé", "excursão", "tour guiado", "passeio", "visita guiada",
            "galeria de arte", "livro", "livros", "revista", "revistas", "e-book", "cd", "dvd", "vinil", "curso de arte",
            "curso de música", "curso de dança", "assinatura", "streaming", "streaming de vídeo", "streaming de áudio",
            "netflix", "spotify", "disney+", "globoplay", "prime video", "youtube premium", "youtube", "deezer", "tidal",
            "hbo max", "telecine play", "bilhete de trem", "bilhete de ônibus", "passagem aérea", "hotel", "aula de teatro",
            "aluguel de carro", "praia", "camping", "pesca", "caça", "boliche", "patinação", "escalada", "kart",
            "paintball", "tirolesa", "rapel", "trilha", "academia", "yoga", "pilates", "crossfit", "luta", "massagem",
            "spa", "sauna", "day spa", "clube de campo", "mensalidade clube", "rodízio", "buffet", "restaurante",
            "bar", "cafeteria", "fast food", "pacote de viagem", "lazer", "entretenimento", "recreação", "hobbies",
            "compra com milhas", "cartão presente", "gift card", "crédito em plataforma", "recarga de celular",
            "compra de pontos", "programa de pontos", "sorteio", "rifa", "prédio", "casa", "apartamento",
            "previdência privada", "previdência", "plano de previdência", "cdi", "cdb", "certificado de depósito bancário",
            "lci", "lca", "letra de crédito imobiliário", "letra de crédito do agronegócio", "títulos de renda fixa",
            "fundos de investimento", "cotas de fundos", "lci 180 dias", "investimento via cartão", "aporte via cartão",
            "cashback investimento", "milhas para investimento", "compra de milhas", "criptomoedas",
            "token de investimento", "nucoin", "cashback", "cash back", "bitcoin", "milhas", "brinquedo", "brinquedos",
            "veneno", "mata inseto", "isca", "iscas", "cobasi", "arvore", "flores", "planta"
        ].map(normalize),

        restritos: [
            "drogas", "produtos falsificados", "material pornográfico", "porno", "pornografia", "espécies ameaçadas",
            "remédios controlados", "produtos de tabaco", "cigarro", "charuto", "munição", "prostituta", "puta",
            "programa", "night", "sexo", "transar", "camisinha", "vibrador", "KY", "chupeta"
        ].map(normalize),

        inteligenciaArtificial: [
            "ChatGPT", "GPT-3", "GPT-4", "GPT-4o", "GPT", "Gemini", "Google Gemini", "Gemini Pro", "Gemini Ultra",
            "Microsoft Copilot", "Copilot", "Claude", "Claude 3", "Claude 3 Opus", "Claude 3 Sonnet", "Claude 3 Haiku",
            "Llama", "Llama 2", "Llama 3", "Mistral", "Grok", "AlphaGo", "IBM Watson", "Watson", "TensorFlow", "PyTorch",
            "Keras", "Azure AI", "Azure Machine Learning", "Google Cloud AI", "Vertex AI", "Amazon SageMaker", "DALL-E",
            "DALL-E 2", "DALL-E 3", "Midjourney", "Stable Diffusion", "Stable Diffusion XL", "SDXL", "Code Llama", "Whisper",
            "Jasper", "Jasper AI", "Copy AI", "Beautiful AI", "Grammarly", "Synthesia", "Picsart AI", "Otter AI",
            "Tesla Autopilot", "ClickUp Brain", "H2O.ai", "Scikit-learn", "OpenAI Gym", "Tabnine", "GitHub Copilot",
            "Perplexity", "Duck AI", "Siri", "Alexa", "Meta AI", "NotebookLM", "WordAI", "DeepBrain AI", "Salesforce Einstein",
            "Fireflies", "Pictory", "Speechify", "Poised", "You.com", "Andi", "Chatfuel", "Dialogflow", "Cursor",
            "Mya Systems", "Olivia by Paradox", "SeekOut", "SAP S/4HANA AI", "Breeze by HubSpot", "sap", "github", "excel",
            "word", "text-pad", "textpad"
        ].map(normalize),

        utensiliosCozinha: [
            "garfo", "faca", "colher", "colher de sopa", "colher de chá", "colher de sobremesa", "faca de serra",
            "faca de pão", "faca de carne", "espátula", "concha", "escumadeira", "fouet", "batedor de ovos",
            "abridor de lata", "abridor de garrafa", "saca-rolhas", "ralador", "descascador", "peneira",
            "espremedor de alho", "cortador de pizza", "tesoura de cozinha", "pegador de macarrão",
            "pegador de salada", "tábua de corte", "pirex", "travessa", "assadeira", "forma de bolo",
            "frigideira", "panela", "caçarola", "leiteira", "cuscuzeiro", "chaleira", "bule", "xícara",
            "copo", "taça", "prato", "pires", "saladeira", "tigela", "bowl"
        ].map(normalize)

    };

    const mensagensBrincadeiraPorGrupo = {
        eletrodomesticos: "Interior de loja não é cozinha planejada, né? 😅",
        eletroportateis: "Vai montar uma cozinha gourmet aí na loja? 😂",
        climatizacao: "Climatizar a loja é importante, mas isso entra como patrimônio, não no cartão da Clara 😉",
        moveisUtensiliosCasa: "Parece mais compra de mobília do que despesa do dia a dia da loja 😬",
        eletronicos: "Isso aí tá com mais cara de patrimônio do que de gasto operacional… 📺",
        games: "Montar lan house com cartão da loja não vai rolar, hein 🎮😄",
        veiculos: "Cartão Clara não é financiamento de concessionária e nem tem limite infinito, hein! 🚗💳",
        instrumentosMusicais: "Vai montar uma banda aí na loja? 🎸😄",
        ferramentas: "Vai montar uma oficina? 😥",
        animais: "Nossa, não sabia que você tava montando um zoológico na loja 🤣",
        armasGuerra: "Calma lá, Rambo… o cartão é pra operação da loja, não pra guerra ⚔️😂",
        bensServicosAbstratos: "Isso tem bem mais cara de investimento/lazer/serviço pessoal do que despesa da loja. Tá estressado e quer relaxar, né? 😅",
        restritos: "Esse tipo de item é proibido de qualquer jeito, dentro ou fora da política da Clara 😶‍🌫️",
        inteligenciaArtificial: "Nem as IAs escapam da política do cartão corporativo, viu? 🤖🚫",
        utensiliosCozinha: "MasterChef que habita em você não é o mesmo que habita na Clara 🧑🏼‍🍳"
    };

      function avaliarCompraEspecifica(msgNorm) {
    if (!msgNorm) {
        return { pode: null, resposta: "" };
    }

    const baseMsg = `Esse tipo de item <b>NÃO</b> pode ser comprado/utilizado com o cartão.<br>
        Ele deve seguir o processo de requisição junto à área de Compras (se for relevante e apto de acordo com o negócio e estiver dentro da política da área), com aprovação formal, não o cartão da loja.`;

    // 0) SÓ entro nessa função se a frase tiver cara de COMPRA / USO DO CARTÃO
    const falaDeCompraOuUso =
        msgNorm.includes("comprar") ||
        msgNorm.includes("comprei") ||
        msgNorm.includes("comprou") ||
        msgNorm.includes("compra ") ||
        msgNorm.includes("vou comprar") ||
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("pagar") ||
        msgNorm.includes("paguei") ||
        msgNorm.includes("pagou") ||
        msgNorm.includes("passei no cartao") ||
        msgNorm.includes("passei no cartão") ||
        msgNorm.includes("passar no cartao") ||
        msgNorm.includes("passar no cartão") ||
        msgNorm.includes("usei o cartao") ||
        msgNorm.includes("usei o cartão") ||
        msgNorm.includes("usar o cartao") ||
        msgNorm.includes("usar o cartão") ||
        msgNorm.includes("cartao clara") ||
        msgNorm.includes("cartão clara");

    // Se não tem nenhum verbo de compra/uso, NÃO forço uma decisão aqui
    if (!falaDeCompraOuUso) {
        return { pode: null, resposta: "" };
    }

    // 1) Checa os GRUPOS de proibidos primeiro
    for (const [grupo, palavras] of Object.entries(gruposProibidos)) {
        for (const palavra of palavras) {
            const regex = new RegExp(`\\b${palavra}\\b`, "i");
            if (regex.test(msgNorm)) {
                const intro = mensagensBrincadeiraPorGrupo[grupo] || "⛔ Não pode usar o cartão Clara pra isso.";
                const respostaFinal = `${intro}<br><br>${baseMsg}`;

                return {
                    pode: false,
                    resposta: respostaFinal
                };
            }
        }
    }

    // 2) Casos específicos de PROIBIDOS (alimentação pessoal, álcool, transporte pessoal)
    const pessoalAlim = [
        "paguei meu almoco","paguei meu almoço","paguei meu jantar",
        "paguei meu lanche","paguei meu café","paguei meu cafe",
        "paguei meu pastel","paguei minha refeicao","paguei minha refeição",
        "paguei minha comida","paguei minha janta",
        "meu almoço","meu almoco","meu jantar","minha janta",
        "meu lanche","minha comida","almoco pessoal","almoço pessoal",
        "jantar pessoal","lanche pessoal","refeição pessoal","refeicao pessoal",
        "almocei com o cartao","almocei com o cartão",
        "jantei com o cartao","jantei com o cartão",
        "comi com o cartao","comi com o cartão"
    ].map(normalize);

    for (const termo of pessoalAlim) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Refeição pessoal (almoço, jantar, lanche etc.) não pode ser paga com o cartão Clara. Isso não é despesa operacional da loja. Se já foi pago com o cartão, precisa sinalizar como "Despesa Pessoal – Uso Indevido", enccaminhar chamado via Servicenow: <b>Contas a Receber > Cartão Clara > Gasto Indevido (pessoal)</b>. O financeiro irá informar como proceder com o ressarcimento do valor.`
            };
        }
    }

    const alcool = [
        "cerveja","vodka", "gin", "tequila", "rum", "saque", "espumante", "conhaque", "51", "sidra", "brandy",
        "hidromel", "absinto", "champagne", "menta", "bitter", "vermute", "prosecco", "vinho do porto",
        "xerez", "marsala", "grappa", "pisco", "mezcal", "calvados", "amaretto", "ouzo", "jägermeister",
        "soju", "arac", "baijiu", "vinho","whisky","whiskey","cachaça", "licor", "cachaca","Skol", "Brahma",
        "Heineken", "Corona Extra", "Budweiser", "Bud Light", "Stella Artois", "stella", "itaipava",
        "devassa", "Guinness", "Smirnoff", "Absolut", "Cîroc", "Grey Goose", "Belvedere",
        "Tito's Handmade Vodka", "Skyy", "Orloff", "Johnnie Walker", "Jack Daniel's", "Jameson",
        "Chivas Regal", "Jim Beam", "Ballantine's", "Grant's", "Macallan", "Glenfiddich", "Bulleit",
        "Baileys", "Licor 43", "Amarula", "Campari", "Aperol", "blue label", "gold label","black label",
        "green label"
    ].map(normalize);

    for (const termo of alcool) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Bebida alcoólica não é permitida no cartão Clara. Isso não é considerado despesa operacional autorizada.`
            };
        }
    }

    const transportePessoal = ["uber"," 99","taxi","táxi","taxí","cabify"].map(normalize);
    for (const termo of transportePessoal) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Uber / 99 / táxi para deslocamento pessoal não pode no cartão Clara. Não é gasto operacional direto da loja.`
            };
        }
    }

        // 2c) Estacionamento (não autorizado no cartão Clara)
    const estacionamento = [
        "estacionamento",
        "pagar estacionamento",
        "paguei estacionamento",
        "ticket de estacionamento",
        "tiket de estacionamento",
        "ticket do estacionamento",
        "talão de estacionamento",
        "talonario de estacionamento",
        "estacionamento do shopping",
        "estacionei o carro",
        "pagar o parking",
        "ticket parking"
    ].map(normalize);

    for (const termo of estacionamento) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Gasto com <b>estacionamento</b> não é permitido no cartão Clara.<br>
                Esse tipo de despesa não é tratado como gasto operacional direto da loja e não deve ser pago com o cartão corporativo.<br>
                Se o cartão já foi utilizado para estacionamento, trate o valor como <b>uso indevido</b> e siga as orientações de ressarcimento com o time de Contas a Receber / Financeiro.`
            };
        }
    }

    // 3) Casos específicos PERMITIDOS (lanche time, periféricos, serviços emergenciais)
    const palavrasTime = [
        "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
        "lanche time","lanche pro time","lanche para o time",
        "treinamento","premiacao","premiação","acao oficial","ação oficial",
        "acao vm","ação vm","acao regional","ação regional",
        "agua pra equipe","água pra equipe","galão de agua","galao de agua","galão de água",
        "salgadinho pra treinamento","bolo pra treinamento",
        "suco pra treinamento","suco para treinamento","lanche treinamento"
    ].map(normalize);

    for (const termo of palavrasTime) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "LANCHES DE REFEIÇÕES / AGUA POTÁVEL",
                    desc: "Coffee break autorizado, água/lanche para equipe em treinamento interno aprovado, ação oficial da loja (VM, regional, diretoria) ou premiação operacional.",
                    exemploDescricao: "Coffee break treinamento VM loja 1234"
                },
                resposta: `Pode usar o cartão Clara se for ação autorizada (treinamento interno, VM, regional, diretoria, premiação operacional). Precisa lançar na Clara em até 48h com nota fiscal, etiqueta correta e descrição objetiva.`
            };
        }
    }

    const perifOperacional = [
        "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
        "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa",
        "bobina ecf","bobina fiscal"
    ].map(normalize);

    for (const termo of perifOperacional) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "MATERIAL DE INFORMÁTICA",
                    desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cartões de memória (sem controle patrimonial).",
                    exemploDescricao: "Teclado PDV loja 1234"
                },
                resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) é considerado suprimento operacional de baixo valor para a loja e pode ser pago no cartão Clara, desde que classificado corretamente e lançado em até 48h.`
            };
        }
    }

    const servicoEmerg = [
        "chaveiro","abrir cofre","abrir estoque","perdi a chave",
        "motoboy","sedex","correios","envio de documento","postar documento",
        "mandar documento","enviar documento"
    ].map(normalize);

    for (const termo of servicoEmerg) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "TRANSPORTE SERVIÇOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                    desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                    exemploDescricao: "Motoboy urgente documentação loja 1234"
                },
                resposta: `Serviços emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cartão Clara, desde que sejam necessidade imediata da operação e sejam justificados na Clara dentro de 48h.`
            };
        }
    }

    // 4) Se não casou em nada, deixa para a resposta genérica / política
    return { pode: null, resposta: "" };
}

    /* ========= RESPOSTAS ========= */


    function respostaForaEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Política de Uso dos Cartões Clara nas lojas. Não consigo responder esse tipo de assunto.
</p>`;
    }

    function respEtiquetaDireta(et) {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Etiqueta identificada: ${et.nome}</b></p>
    <p class="mt-2">${et.descricao || "Essa etiqueta é usada para classificar despesas relacionadas a este tipo de gasto na operação da loja."}</p>

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política</summary>
      <div class="mt-2">
        <p>Se você identificar que essa etiqueta não representa corretamente o tipo de compra ou está gerando confusão recorrente no uso, a orientação é solicitar ajuste formal.</p>
        <p class="mt-2">Abra um chamado no ServiceNow do tipo <b>Inserção ou ajuste de etiqueta – Cartão Clara</b>, explicando o problema encontrado, como a etiqueta é usada hoje e qual seria o cenário ideal.</p>
        <p class="mt-2">Evite adaptar etiquetas por conveniência, pois isso afeta indicadores financeiros, auditorias e controles internos.</p>
        <p class="mt-3 text-xs text-slate-500">Orientação alinhada ao Anexo II da Política de Utilização dos Cartões Clara.</p>
      </div>
    </details>
  </div>`;
}

    function respLimite() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Limite do cartão Clara nas lojas</b></p>
    <p class="mt-2">O limite do cartão Clara é definido para cobrir os gastos previstos do ciclo de fatura (de 06 até 05 do mês seguinte), considerando o padrão de despesas operacionais da loja.</p>
    <p class="mt-2">O limite é reestabelecido por completo sempre no dia 06 de cada mês.</p>
    <p class="mt-2">Para visualizar o limite, ali na parte do menu de <b>Açoes</b>, arraste pro lado e vai em <b>Ajustar limite</b>. Lá vai aparecer de forma mais simples o valor atual do limite, de forma integral.</p>
    <p class="mt-2">Planeje as compras para não estourar o limite logo no início do ciclo, priorize gastos essenciais e evite despesas de alto valor.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política</summary>
      <div class="mt-2">
        <p><b>Ajuste excepcional de limite:</b></p>
        <p>Quando o limite que foi estabelecido não é suficiente para uma situação pontual (como algo emergencial ou ação oficial maior já autorizada), não é para “forçar” o uso do cartão a qualquer custo.</p>
        <p class="mt-2">Nesses casos, alinhe previamente com a regional ou área responsável, organize a justificativa e então abra chamado no ServiceNow do tipo <b>Ajuste excepcional de limite – Cartão Clara</b>, informando loja, BU, limite atual, limite solicitado, período e motivo detalhado.</p>
        <p class="mt-2">Pedidos sem justificativa aderente à política ou sem alinhamento com a liderança podem ser negados, mesmo que existam demandas locais.</p>
        <p class="mt-3 text-xs text-slate-500">Orientação alinhada à Política de Utilização dos Cartões Clara. Limite não é ferramenta para cobrir qualquer gasto, mas sim o que é essencial para a operação dentro da política.</p>
      </div>
    </details>
  </div>`;
}

    function respBloqueio() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Bloqueio de cartão Clara (preventivo ou por pendências)</b></p>
    <p class="mt-2">O cartão Clara pode ser bloqueado preventivamente principalmente por pendências de comprovantes (nota, etiqueta ou descrição fora do prazo) ou por uso fora da política que exige análise do Financeiro.</p>
    <p class="mt-2">Antes de qualquer coisa, entre na Clara e verifique se existem transações pendentes ou compras fora do padrão que possam ter motivado o bloqueio.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política</summary>
      <div class="mt-2">
        <p><b>Passos básicos quando o cartão está bloqueado:</b></p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Regularize todas as transações pendentes na Clara com nota, comprovante, etiqueta correta e descrição clara;</li>
          <li>Cheque se não há compras claramente fora da política que precisem ser corrigidas ou ressarcidas;</li>
          <li>Evite tentar insistir em novas compras enquanto o motivo do bloqueio não estiver claro.</li>
        </ul>
        <p class="mt-3"><b>Quando o bloqueio estiver ligado à prestação de contas ou pendências já regularizadas:</b></p>
        <p>Se você já resolveu todas as pendências na Clara e o cartão continua bloqueado, a orientação é abrir chamado no ServiceNow do tipo <b>Desbloqueio de cartão Clara por pendências / bloqueio preventivo</b>.</p>
        <p class="mt-2">No chamado, informe loja, BU, código do cartão e nome do responsável, além de quais pendências foram regularizadas (faturas e período) e, se solicitado, anexos ou prints que comprovem a regularização.</p>
        <p class="mt-3 text-xs text-slate-500">Fluxo alinhado à Política de Utilização dos Cartões Clara e aos procedimentos de bloqueio/desbloqueio via ServiceNow. Em situações fora do padrão, consulte o Financeiro antes de tentar liberar novas compras.</p>
      </div>
    </details>
  </div>`;
}

                // 🔹 NOVA RESPOSTA – transação negada / categoria bloqueada
                function respTransacaoNegadaCategoria() {
                    return `HTML:<div class="text-sm text-slate-700">
            <p>Algumas compras podem ser <b>negadas</b> mesmo com limite disponível e cartão ativo (<i>É importante que você verifique que seu cartão não está bloqueado</i>), porque a <b>categoria do estabelecimento</b> (MCC) está bloqueada pela política de uso dos cartões Clara.

            <p class="mt-2">Nesses casos, siga estes passos:
            <ol class="list-decimal ml-4 mt-1">
            <li>Verifique no app/plataforma da Clara o motivo da recusa e a categoria da compra (MCC);</li>
            <li>Se a despesa for necessária para a operação da loja, abra um chamado no <b>ServiceNow</b> em:<br/>
            <b>Contas a Receber &gt; Cartão Clara &gt; Solicitação de Liberação de Categoria para Compra</b>;</li>
            <li>Explique o contexto da compra, qual tipo de serviço/produto precisa ser liberado e se a liberação é pontual ou recorrente.</li>
            <li>Depois da liberação pelo Financeiro no ServiceNow, você pode tentar a compra novamente com o cartão Clara.</li>
            </div>`;
                }

              function respPoliticaOficial() {
        return `HTML:<div class="text-sm text-slate-700">
          <p>Este documento contém as diretrizes e padrões oficiais de referência da Companhia. Ele deve ser consultado e seguido como a fonte de autoridade final para todos os assuntos que lhe são pertinentes.
          <a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
          <strong>Política de Uso dos Cartões Clara (documento oficial).</strong>
          </a>
          <p>O não cumprimento das disposições aqui estabelecidas sujeitará o infrator às medidas disciplinares e legais cabíveis.</p>
          </div>`;
              }

    function respCatalogoEtiquetas() {
  // Monta lista de etiquetas oficiais da política (etiquetasOficiais vem do politica_dados)
  let listaEtiquetasHtml = "";

  if (Array.isArray(etiquetasOficiais) && etiquetasOficiais.length) {
    listaEtiquetasHtml =
      `<div class="mt-3">
        <p class="mt-2"><b>Etiquetas oficiais disponíveis hoje na Clara</b></p>
        <ul class="list-disc ml-4 mt-1 space-y-1">
          ${
            etiquetasOficiais
              .map(function (et) {
                const nome = et.nome || "";
                const desc = et.descricao || "";
                const obs  = et.observacaoUso || "";

                let li = `<li><b>${nome}</b>`;
                if (desc) {
                  li += ` – ${desc}`;
                }
                if (obs) {
                  li += ` <span class="text-xs text-slate-500">(${obs})</span>`;
                }
                li += `</li>`;
                return li;
              })
              .join("")
          }
        </ul>
        <p class="mt-2 text-xs text-slate-500">
          Lista baseada no Anexo II da Política de Utilização dos Cartões Clara e alinhada ao catálogo oficial de etiquetas.
      </div>`;
  }

  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Etiquetas na Clara</b></p>
    <p class="mt-2">
      As etiquetas servem para classificar corretamente cada gasto feito com o cartão Clara e facilitar o controle financeiro e a prestação de contas.
    <p class="mt-2">
      Sempre escolha a etiqueta que mais represente o tipo real de despesa, evitando classificar tudo em categorias genéricas.

    ${listaEtiquetasHtml}

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política
      </summary>
      <div class="mt-2">
        <p>
          Se não existir uma etiqueta adequada para o tipo de gasto recorrente da sua loja, não improvise usando algo que não represente a realidade da compra. Nesse caso, a orientação é abrir chamado no ServiceNow do tipo <b>Inserção ou ajuste de etiqueta – Cartão Clara</b>, informando loja, BU,
          tipo de despesa, justificativa e exemplos de uso.

          O Financeiro avaliará a solicitação e, se aprovado, criará ou ajustará a etiqueta no catálogo oficial da Clara.
        <p class="mt-3 text-xs text-slate-500">
          Fluxo baseado no Anexo II da Política de Utilização dos Cartões Clara. A escolha correta de etiquetas impacta diretamente indicadores e controles da companhia.
        </p>
      </div>
    </details>
  </div>`;
}

    function respPrestacaoContas() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Prestação de contas na Clara (notas, comprovantes e justificativas)</b></p>
    <p class="mt-2">Toda compra feita com o cartão Clara precisa de <b>nota ou comprovante anexado</b>, <b>etiqueta correta</b> e <b>descrição</b> dentro do prazo de 48 horas após a compra, senão vira pendência de prestação de contas.</p>
    <p class="mt-2">Pendências em aberto podem levar a bloqueio preventivo do cartão até que a loja regularize as informações.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política</summary>
      <div class="mt-2">
        <p><b>Quando faltar nota, tiver erro de comprovante ou um caso atípico:</b></p>
        <p>Se a nota foi perdida, o fornecedor não emitiu NF corretamente, ou existe alguma irregularidade que você não consegue resolver apenas pela Clara, registre o máximo possível na descrição e organize as evidências que tiver (pedido, orçamento, recibos, prints etc.).</p>
        <p class="mt-2">Nesses casos, a orientação é abrir um chamado no ServiceNow de <b>Apoio à prestação de contas / regularização de comprovantes – Cartão Clara</b>.</p>
        <p class="mt-2">No chamado, informe loja, BU, dados da transação (data, valor, estabelecimento), print da tela da Clara se possível e explique o que aconteceu (perda de nota, NF em CPF, NF recusada, erro do fornecedor etc.), além da solução proposta.</p>
        <p class="mt-3 text-xs text-slate-500">Fluxo baseado no Anexo II da Política de Utilização dos Cartões Clara. Pendências não tratadas podem manter o cartão bloqueado ou gerar apontamentos para a loja.</p>
      </div>
    </details>
  </div>`;
}

    function respAlimentoTime() {
        return `HTML:<p class="text-sm text-slate-700">
Pode usar o cartão Clara para água / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
• treinamento interno oficial,<br/>
• ação aprovada (VM, regional, diretoria),<br/>
• premiação operacional autorizada.<br/><br/>
Não pode usar para lazer pessoal, almoço pessoal ou comemoração particular.<br/><br/>
Etiquetas usadas:<br/>
• Água / galão → "AGUA POTÁVEL";<br/>
• Coffee break autorizado / lanche de treinamento → "LANCHES DE REFEIÇÕES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respTransportePessoal() {
        return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / táxi pra deslocamento pessoal não pode ser pago com o cartão Clara. Isso não é gasto operacional direto da loja. O procedimento correto é solicitar via aplicativo com a conta corporativa da empresa.<br/><br/>
Se já usou de forma pessoal (pagando do próprio bolso) e quer o reembolso:<br/>
• Solicite o reembolso através da plataforma Vexpenses (é necessário autorização do seu gestor).<br/>
</p>`;
    }

function respTrocaGerente() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Quando o gerente é afastado ou desligado, o que fazer com o cartão Clara?</b></p>' +

      '<p class="mt-2">' +
        'A política traz dois cenários principais para lojas físicas:' +
      '</p>' +

      '<ol class="list-decimal ml-5 mt-2 space-y-2">' +
        '<li>' +
          '<b>Gerente em férias ou afastamento temporário (licença, atestado etc.)</b><br>' +
          '<ul class="list-disc ml-4 mt-1">' +
            '<li>O cartão da loja continua sendo o <b>cartão da própria loja</b>, não de outra.</li>' +
            '<li>Durante o afastamento, um <b>líder / supervisor</b> indicado pela regional assume a guarda e o uso operacional do cartão.</li>' +
            '<li>A loja não deve usar o cartão de outra unidade só porque o gerente está afastado.</li>' +
          '</ul>' +
        '</li>' +

        '<li>' +
          '<b>Gerente desligado e ainda não há novo gerente nomeado</b><br>' +
          '<ul class="list-disc ml-4 mt-1">' +
            '<li>O cartão do gerente desligado deve ser <b>bloqueado</b> e recolhido.</li>' +
            '<li>Em casos específicos, a política permite uso <b>temporário</b> do cartão de outra loja, sempre com validação do Financeiro.</li>' +
            '<li>Quando isso acontecer, a <b>descrição da transação</b> deve deixar claro qual loja está sendo atendida, por exemplo:<br>' +
              '<span class="italic">"Uso temporário do cartão da loja 0123 para despesas operacionais da loja 0456 – gerente em transição"</span>.' +
            '</li>' +
            '<li>O responsável pela prestação de contas passa a ser o <b>gerente temporário / responsável indicado</b> pela regional.</li>' +
          '</ul>' +
        '</li>' +
      '</ol>' +

      '<p class="mt-3">' +
        'Em qualquer cenário de afastamento ou demissão, a orientação é sempre:' +
      '</p>' +
      '<ul class="list-disc ml-4 mt-1">' +
        '<li>Garantir que o cartão do gerente desligado seja recolhido e bloqueado;</li>' +
        '<li>Registrar na descrição das compras qualquer uso temporário de cartão de outra loja;</li>' +
        '<li>Em caso de <b>férias do gerente ou afastamento</b>, a loja deve abrir chamado no ServiceNow informando o período e quem ficará responsável pela guarda do cartão, para que o Financeiro acompanhe e, quando necessário, faça o tratamento dos comprovantes em nome do responsável temporário, caminho para abertura do chamado: <b>Contas a Receber > Cartão Clara > Solicitação para anexar comprovantes</b>.</li>' +
        '<li><b>Importante:</b> O financeiro deve autorizar esse fluxo por email antes da loja encaminhar chamado.</li>' +
      '</ul>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Resumo baseado no item 8.4 e no Anexo II da Política de Utilização dos Cartões Clara.' +
        ' Em caso de dúvida ou situações não previstas, valide com o Financeiro.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

function respTrocaGerenteMudancaLojas() {
  var corpo =
    '<div class="text-sm text-slate-700">' +
      '<p><b>Troca de gerente entre lojas com Cartão Clara</b></p>' +

      '<p class="mt-2">' +
        'Quando um gerente que possui um <b>cartão Clara</b> é transferido de uma loja para outra, ' +
        'não é apenas uma ausência temporária: é uma <b>mudança de unidade</b> que precisa ser refletida no cadastro do cartão.' +
      '</p>' +

      '<p class="mt-2">' +
        'Nesses casos, a orientação é abrir no ServiceNow o tipo de chamado <b>"Troca de Gerente (mudança entre lojas)"</b>, ' +
        'informando obrigatoriamente:' +
      '</p>' +

      '<ul class="list-disc ml-4 mt-1">' +
        '<li><b>BU</b> (ex.: Centauro, Fisia);</li>' +
        '<li><b>Loja de origem</b> do gerente;</li>' +
        '<li><b>Loja de destino</b> para onde ele está sendo transferido;</li>' +
        '<li><b>Data efetiva da troca</b>, para ajustar o vínculo do cartão no sistema.</li>' +
      '</ul>' +

      '<p class="mt-2">' +
        'O <b>cartão físico</b> deve acompanhar o gerente na mudança e passar a ser usado na nova loja, ' +
        'sempre após o ajuste cadastral. O ponto crítico é garantir que, no sistema, o cartão fique ' +
        'vinculado à unidade correta, evitando despesas “aparecendo” na loja errada.' +
      '</p>' +

      '<p class="mt-3 text-xs text-slate-500">' +
        'Fluxo alinhado ao Anexo II (ServiceNow) e às regras de responsabilidade do portador na Política de Utilização dos Cartões Clara. ' +
        'Em caso de exceções, valide com o Financeiro.' +
      '</p>' +
    '</div>';

  return vektorBlocoRaciocinioPolitica(
    corpo,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

    function respCartaoGeral() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Sobre o cartão Clara nas lojas:</b>

<p class="mt-1">
O cartão Clara é o meio oficial para pagar <b>despesas operacionais da loja</b>, em substituição ao antigo processo de sangrias, como:
<ul class="list-disc ml-4 mt-1">
  <li>materiais de limpeza e pequenos reparos;</li>
  <li>materiais de escritório e informática de baixo valor;</li>
  <li>água / coffee break para treinamentos internos e ações autorizadas;</li>
  <li>serviços emergenciais (motoboy, chaveiro, correios em situações operacionais).

<p class="mt-2">
Sempre precisa:
<ul class="list-disc ml-4 mt-1">
  <li>nota fiscal ou recibo;</li>
  <li>etiqueta correta na Clara;</li>
  <li>descrição objetiva do gasto;</li>
  <li>lançar tudo em até <b>48h</b> no app/web da Clara.


<p class="mt-2">
Não pode usar o cartão para:

<ul class="list-disc ml-4 mt-1">
  <li>gasto pessoal (roupa, almoço/jantar pessoal, compras para uso próprio);</li>
  <li>bebida alcoólica;</li>
  <li>Uber / 99 / táxi para deslocamento pessoal;</li>
  <li>itens patrimoniais / infraestrutura (TV, geladeira, micro-ondas, mesa, cadeira etc.).

<p class="mt-2">
Se quiser, posso te explicar um caso específico. Por exemplo:
<br/>• "Posso comprar teclado?"<br/>
• "Pode lanche pra equipe?"<br/>
• "O que não pode no cartão?"
</p>
</div>`;
}

    function respSangria() {
  return `HTML:
<div class="text-sm text-slate-700">
Depois que a loja recebeu o cartão Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional é <b>DESCONTINUADO</b>

  <p>Ou seja: a loja não deve mais tirar dinheiro do caixa pra pagar gasto de operação. Tudo deve ser pago com o <b>cartão Clara</b>, com justificativa na plataforma.

  <p>Se a loja pensou em fazer sangria porque <b>não conseguiu usar o cartão Clara</b> (categoria bloqueada na maquininha / MCC bloqueado), o fluxo correto é <b>abrir chamado no ServiceNow para tratar a categoria</b>, e não tirar dinheiro do caixa.

  <p>No ServiceNow, utilize o caminho: <b>Contas a Receber > Cartão Clara > Liberação de categoria</b>, informando:

  <ul class="list-disc ml-4">
    <li><b>BU</b> e <b>loja</b>;</li>
    <li>Se tentou utilizar o cartão no estabelecimento;</li>
    <li><b>Data e valor</b> onde da transação (se já efetuada);</li>
    <li><b>Categoria desejada</b>.

  <p>O Financeiro avalia a solicitação e ajusta as permissões de categoria. A sangria em dinheiro continua sendo exceção extrema.
</div>`;
}

    function respFraudeContestacao() {
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Suspeita de fraude ou transação não reconhecida no cartão Clara</b></p>
    <p class="mt-2">Se aparecer uma compra que você realmente não reconhece na Clara, primeiro confira se não foi uma compra legítima feita por outro responsável, se não é uma assinatura recorrente ou algo ligado à operação da loja.</p>
    <p class="mt-2">Se mesmo assim continuar parecendo fraude ou uso indevido, é caso de tratar como contestação formal.</p>
    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política</summary>
      <div class="mt-2">
        <p>Quando a transação for suspeita de fraude ou não reconhecida mesmo após conferência interna, siga estes passos:</p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Bloqueie o cartão na Clara, se ainda houver risco de novas cobranças;</li>
          <li>Levante todas as informações da transação: data, valor, estabelecimento e descrição;</li>
          <li>Se houver indício de golpe ou roubo, registre um Boletim de Ocorrência, quando aplicável.</li>
        </ul>
        <p class="mt-3"><b>Formalização no ServiceNow:</b></p>
        <p>Abra um chamado de <b>Fraude / Contestação de transação – Cartão Clara</b> no ServiceNow, informando loja, BU (Centauro / Fisia) e código da unidade, além dos dados completos da transação (data, valor, estabelecimento) e um resumo do ocorrido.</p>
        <p class="mt-2">Anexe prints da Clara, boletim de ocorrência (se houver) e qualquer evidência que ajude o Financeiro a tratar a contestação com o emissor.</p>
        <p class="mt-3 text-xs text-slate-500">Resumo alinhado ao Anexo II (Fraude / Contestação) da Política de Utilização dos Cartões Clara. Acompanhe o retorno pelo próprio ServiceNow e pelos canais oficiais do Financeiro.</p>
      </div>
    </details>
  </div>`;
}

    function respTermoResponsabilidade() {
  return "HTML:" +
  "<div class='text-sm text-slate-700'>" +
    "<p>" +
      "O <b>Termo de Responsabilidade de uso do cartão da Clara</b> deve ser preenchido para que a loja possa utilizar o cartão. " +
      "Esse termo traz também o aceite para a Política de uso do cartão. " +
      "Preencha " +
      "<a href='https://docs.google.com/forms/d/e/1FAIpQLSdnQWYFWp-udS9V039avJlXb4x1VnlDC6us5dSCrLkgngAxpg/viewform' " +
         "target='_blank' rel='noopener noreferrer' class='service-link' style='display:inline;'><b>este formulário</b></a>. " +
      "Após preencher, você receberá o termo anexado ao e-mail, onde deve <b>imprimir, assinar e nos enviar</b>. " +
      "Depois disso, o uso do cartão estará liberado." +
    "</p>" +
  "</div>";
}

    function respNovoCartaoPrimeiraVia() {
  return `HTML:<div class="text-sm text-slate-700">
<p>Primeira via de cartão Clara (novo gerente)</p>
<p class="mt-1">A emissão da primeira via do cartão Clara deve ser realizada exclusivamente por meio de chamado no ServiceNow, no caminho:<br><b>Contas a Receber - Cartão Clara - Emissão de 1ª Via de Cartão Clara – Novo Gerente</b></p>
<p class="mt-1">No chamado, é obrigatório o preenchimento das seguintes informações:</p>
<ul class="list-disc ml-5 mt-1">
<li>Nome do gerente;</li>
<li>E-mail do gerente;</li>
<li>Endereço completo da loja com CEP;</li>
<li>Termo de Responsabilidade assinado.</li>
</ul>
<p class="mt-1">O prazo de entrega do cartão é de até <b>7 dias úteis</b>.</p>
</div>`;
}

function respNovoCartaoSegundaVia() {
  return `HTML:<div class="text-sm text-slate-700">
<p>Segunda via de cartão Clara</p>
<p class="mt-1">A solicitação da segunda via do cartão Clara deve ser feita por meio de chamado no ServiceNow, no caminho:<br><b>Contas a Receber - Cartão Clara - Emissão de 2ª Via de Cartão Clara</b></p>
<p class="mt-1">No chamado, é necessário informar:</p>
<ul class="list-disc ml-5 mt-1">
<li>Motivo da emissão da 2ª via;</li>
<li>Endereço completo da loja com CEP.</li>
</ul>
<p class="mt-1">O cartão anterior será <b>automaticamente cancelado</b>.</p>
<p class="mt-1">O prazo para entrega é de até <b>7 dias úteis</b>.</p>
</div>`;
}

      function respGenerica(msgNorm) {
    msgNorm = msgNorm || "";

    // Mensagens claramente relacionadas a justificativa / nota / comprovante / vídeo de justificativa
    const ehJustificativa =
        msgNorm.includes("justific") ||
        msgNorm.includes("nota fiscal") ||
        msgNorm.includes("nota da compra") ||
        msgNorm.includes("perdi a nota") ||
        msgNorm.includes("falta a nota") ||
        msgNorm.includes("despesa sem nota") ||
        msgNorm.includes("despesa sem comprovante") ||
        msgNorm.includes("comprovante") ||
        msgNorm.includes("comprovantes") ||
        msgNorm.includes("video de justificativa") ||
        msgNorm.includes("vídeo de justificativa") ||
        msgNorm.includes("video de justificativas") ||
        msgNorm.includes("vídeo de justificativas");

    const avaliacao = avaliarCompraEspecifica(msgNorm);

    // 1) Se a avaliação específica decidiu claramente que NÃO pode
    if (avaliacao && avaliacao.pode === false && avaliacao.resposta) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>⛔ Não pode usar o cartão Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
    }

    // 2) Se a avaliação específica decidiu claramente que PODE e tem etiqueta
    if (avaliacao && avaliacao.pode === true && avaliacao.etiquetaValida) {
        const et = avaliacao.etiquetaValida;
        return `HTML:<div class="text-sm text-slate-700">
<p><b>✅ Pode usar o cartão Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
</div>`;
    }

    // 3) Perguntas amplas do tipo "O que posso comprar com o cartão?"
    if (perguntasGeraisOquePosso && perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>✅ O que pode no cartão Clara</b> - Exemplos de materiais:</p>
<ul class="list-disc ml-4 mt-1">
<li>Materiais de escritório: canetas, blocos, pastas, papel, clips, organizadores, grampeadores;</li>
<li>Serviços gráficos e de comunicação visual: impressão de banners, adesivos promocionais, folders e plotagens autorizadas pela área de VM;</li>
<li>Compra de água mineral ou galões para abastecimento da equipe (etiqueta “ÁGUA POTÁVEL”);</li>
<li>Suprimentos de informática (mouse, teclado, cabos, bobina fiscal etc.);</li>
<li>Lanches, coffee breaks ou premiações para equipe somente quando vinculados a treinamentos internos, ações oficiais ou campanhas aprovadas (etiqueta “LANCHES DE REFEIÇÕES”);</li>
<li>Serviços emergenciais (motoboy urgente, chaveiro, Sedex de documento);</li>
<li>Compra de bobinas fiscais ou suprimentos obrigatórios do PDV;</li>
<li>Pequenas manutenções (elétrica, civil, ar-condicionado, equipamentos).</li>
</ul>
<p class="mt-2"><b>❌ O que não pode</b> - Exemplos de itens não permitidos:</p>
<ul class="list-disc ml-4">
<li>Itens patrimoniais ou de infraestrutura: TV, micro-ondas, geladeira, freezer, mesa, cadeira, armário, ventilador, cafeteira elétrica, computador, impressora, celular, tablets, ou qualquer bem durável;</li>
<li>Bebidas alcoólicas (cerveja, vinho, whisky, vodka, gin, tequila, entre outras);</li>
<li>Transporte pessoal: Uber, 99, táxi, aplicativos de carona ou combustível para veículo particular;</li>
<li>Despesas pessoais: almoço, jantar, lanche, coffee break pessoal, delivery, supermercado para consumo próprio;</li>
<li>Equipamentos e mobiliários que exigem tombamento patrimonial (mesmo que de baixo valor);</li>
<li>Manutenções estruturais de grande porte (obras, pintura geral, reformas, trocas de piso, elétrica complexa, etc.);</li>
<li>Serviços ou produtos sem nota fiscal (inclusive compras em marketplaces sem NF emitida no CNPJ da loja);</li>
<li>Gastos fora da operação da loja ou que não tenham relação com a atividade comercial;</li>
</ul>
</div>`;
    }

    // 4) Se a mensagem NÃO tem cara de assunto da Clara/cartão, devolve FORA DE ESCOPO
    const falaMundoClara =
        msgNorm.includes("clara") ||
        msgNorm.includes("cartao") || msgNorm.includes("cartão") ||
        msgNorm.includes("fatura") ||
        msgNorm.includes("pendencia") || msgNorm.includes("pendência") ||
        msgNorm.includes("nota fiscal") || msgNorm.includes("nf ") || msgNorm.startsWith("nf") ||
        msgNorm.includes("etiqueta") ||
        msgNorm.includes("limite") ||
        msgNorm.includes("transacao") || msgNorm.includes("transação") ||
        msgNorm.includes("compra") || msgNorm.includes("comprar") || msgNorm.includes("paguei");

    if (!falaMundoClara) {
        // Se é claramente uma dúvida de justificativa / nota / comprovante / vídeo de justificativa,
        // não manda resposta fora de escopo (deixa o fluxo de justificativa/vídeo responder sozinho).
        if (ehJustificativa) {
            return "";
        }

        // Caso contrário, segue a lógica normal de fora de escopo
        return respostaForaEscopo(msgNorm);
    }

    // 5) Se é claramente justificativa / nota / comprovante / vídeo de justificativa,
    // não manda o texto genérico de política (outro fluxo já respondeu).
    if (ehJustificativa) {
        return "";
    }

    // 5) Fallback genérico (quando é assunto Clara, mas não bateu em nada acima)
    return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cartão Clara, o gasto precisa ser <b>necessário pra operação da loja</b> (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, periférico de PDV, bobina fiscal, água/coffee break autorizado pra treinamento interno ou ação oficial).</p>
<p class="mt-2">O que <b>não pode</b> no cartão Clara:<br/>
• gasto pessoal (refeição pessoal, compra pra uso próprio etc.);<br/>
• bebida alcoólica em geral;<br/>
• transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
• itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira, entre outros).</p><br/>
Caso entenda que a compra é essencial para o dia a dia da loja, fale com o financeiro, caso seja verificado que o item é essencial eles podem abrir uma exceção para a compra.
</div>`;
}

    /* ========= FUNÇÕES DE PENDÊNCIAS (BACKEND) ========= */

    function consultarPendenciasNoServidor(loja) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (!res || !res.ok) {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  Não consegui consultar as pendências da loja <b>${loja}</b>.<br/>
                  Detalhe: ${erro}
                  </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // 🆕 loja não existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  A numeração informada não existe, peço que verifique o nº correto da loja.
                  </p>`
                    );
                    // continua aguardando número da loja
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // dispara o timer de 10s
                    return;
                }

                // loja existe, mas NÃO tem pendências na CLARA_PEND
                if (!res.rows || res.rows.length === 0) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                Não encontrei pendências para a loja <b>${loja}</b> na última data de cobrança.
                </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                // ✅ loja válida + tem pendências → continua igual
                ultimaPendenciaResumo = { loja: res.loja, data: res.ultimaData };
                lojaPendenciasAtual = res.loja;

                let tabela = `
                <div class="text-sm text-slate-700">
                <p>Encontrei abaixo as últimas pendências Clara da loja <b>${res.loja}</b> (data de cobrança <b>${res.ultimaData}</b>). Caso a pendência já tenha sido regularizada e o seu cartão ainda esteja bloqueado, solicite o desbloqueio através de abertura de chamado no ServiceNow, caminho: <b>Contas a Receber &gt; Cartão Clara &gt; Solicitação de Desbloqueio</b>.</p>
                <div class="mt-2 overflow-x-auto">
                <table class="min-w-full text-xs border border-slate-200">
                <thead class="bg-slate-100">
                <tr>`;

                const header = res.header || [];
                header.forEach(h => {
                    tabela += `<th class="border px-2 py-1">${h}</th>`;
                });
                tabela += `</tr></thead><tbody>`;

                res.rows.forEach(linha => {
                    tabela += `<tr>`;
                    linha.forEach(col => {
                        tabela += `<td class="border px-2 py-1">${col !== null && col !== undefined ? col : ""}</td>`;
                    });
                    tabela += `</tr>`;
                });

                tabela += `</tbody></table></div></div>`;

                renderBotMessage("HTML:" + tabela);

                estadoPendencias = "aguardando_confirmacao_email";

                renderBotMessage(
                  'HTML:' +
                  '<div class="text-sm text-slate-700 mt-2">' +
                    '<p>Quer que eu envie esse resumo por e-mail também?</p>' +
                    '<div class="mt-2 flex gap-2">' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'Sim' +
                      '</button>' +
                      '<button type="button" ' +
                        'onclick="vektorResponderConfirmacaoPendencias(\'não\')" ' +
                        'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                              'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                        'Não' +
                      '</button>' +
                    '</div>' +
                  '</div>'
                );
                
            })
            .withFailureHandler(function(err) {
                console.error("Erro getPendenciasPorLoja:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pendências dessa loja. Tente novamente mais tarde.</p>'
                );
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
            })
            .getPendenciasPorLoja(loja);
    }

                function consultarPendenciasBloqueio(loja) {
        google.script.run
            .withSuccessHandler(res => {
                // erro genérico
                if (!res || !res.ok) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pendências da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // 🆕 loja não existe na BASE
                if (res.lojaInvalida) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    A numeração informada não existe, peço que verifique o nº correto da loja.
                    </p>`
                    );
                    estadoPendencias = "aguardando_loja";
                    lojaPendenciasAtual = "";
                    iniciarTimeoutPendencias(); // timer de 10s
                    return;
                }

                // se chegou aqui, loja é válida → precisa ter html
                if (!res.html) {
                    estadoPendencias = "nenhum";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                    Tive um problema ao buscar as pendências da loja <b>${loja}</b>. Tente novamente em instantes.
                    </p>`
                    );
                    return;
                }

                // mostra o HTML (tabela ou "Não encontrei pendências")
                renderBotMessage("HTML:" + res.html);

                // 🟡 CASO 1: loja válida mas sem pendências
                if (res.html.includes("Não encontrei pendências")) {
                    estadoPendencias = "nenhum";

                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700 mt-2">
                  Acredito que, caso realmente o cartão esteja bloqueado, possa ser por algum outro motivo. Verifique com o time do Financeiro o que pode ter ocorrido, ok?
                  </p>`
                    );
                    return;
                }

                   // 🟢 CASO 2: loja válida + tem pendências → pergunta se quer e-mail
                    estadoPendencias = "aguardando_confirmacao_email";

                    renderBotMessage(
                      'HTML:' +
                      '<div class="text-sm text-slate-700 mt-2">' +
                        '<p>Quer que eu envie esse resumo por e-mail também?</p>' +
                        '<div class="mt-2 flex gap-2">' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'sim\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'Sim' +
                          '</button>' +
                          '<button type="button" ' +
                            'onclick="vektorResponderConfirmacaoPendencias(\'não\')" ' +
                            'style="background:#ffffff;color:#000000;border:1px solid #cbd5e1;' +
                                  'padding:4px 10px;border-radius:999px;font-size:13px;cursor:pointer;">' +
                            'Não' +
                          '</button>' +
                        '</div>' +
                      '</div>'
                    );
            })
            .withFailureHandler(err => {
                estadoPendencias = "nenhum";
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
            Tive um problema ao buscar as pendências da loja <b>${loja}</b>. Tente novamente em instantes.
            </p>`
                );
            })
            .getPendenciasParaBloqueio(loja);
    }


    function chamarEnvioPendenciasPorEmail(loja, email) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Enviei o resumo das pendências da loja <b>${res.loja || loja}</b> para o e-mail <b>${email}</b> (data de cobrança: <b>${res.data || (ultimaPendenciaResumo && ultimaPendenciaResumo.data) || ""}</b>). Não se esqueça de regularizar as justificativas na plataforma da Clara e posteriormente encaminhar chamado para que o cartão seja desbloqueado (caso esteja bloqueado).</p>`
                    );
                } else {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Tentei enviar o e-mail de pendências, mas deu problema: ${erro}.</p>`
                    );
                }
            })
            .withFailureHandler(function(err) {
                console.error("Erro enviarPendenciasPorEmail:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail de pendências. Tente novamente mais tarde.</p>'
                );
            })
            .enviarPendenciasPorEmail(loja, email);
    }

    /* ========= MOTOR DA POLÍTICA ========= */

 function gerarRespostaPolitica(msgUsuario) {
        const norm = normalize(msgUsuario);
        const intencao = detectarIntencaoPergunta(norm);

        // 0) Frases de compra/uso em primeira pessoa (mais específicas que categoria genérica)
    const fraseCompraPrimeiraPessoa =
      norm.includes("paguei ") ||
      norm.includes("paguei meu") ||
      norm.includes("paguei minha") ||
      norm.includes("usei o cartao") ||
      norm.includes("usei o cartão") ||
      norm.includes("vou comprar") ||
      norm.includes("vou compra") ||
      norm.includes("posso usar o cartao") ||
      norm.includes("posso usar o cartão") ||
      norm.includes("usei o cartao clara") ||
      norm.includes("usei o cartão clara");

    if (fraseCompraPrimeiraPessoa) {
      // usa a lógica já existente de casos específicos (proibidos/permitidos)
      return respGenerica(norm);
    }

// 1) Primeiro tenta responder usando o motor de categorias da política,
//    EXCETO quando a pergunta é claramente sobre ETIQUETA
let resultadoCategoria = null;

if (intencao !== "etiqueta") {
  resultadoCategoria = tentarResponderPorCategoriaPolitica(msgUsuario, norm);
}

if (resultadoCategoria) {
  return vektorBlocoRaciocinioPolitica(
    resultadoCategoria.mensagemUsuario,
    "",
    typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
      ? POLITICA_CARTOES_CLARA_LINK
      : ""
  );
}

  // 2) Se não bateu em uma categoria específica, tenta ver se é pedido de RESUMO de categorias
  if (typeof tentarResponderResumoCategoriasPolitica === "function") {
    const resultadoResumo = tentarResponderResumoCategoriasPolitica(norm);
    if (resultadoResumo) {
      return vektorBlocoRaciocinioPolitica(
        resultadoResumo.mensagemUsuario,
        "",
        typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
          ? POLITICA_CARTOES_CLARA_LINK
          : ""
      );
    }
  }

        // gasto pessoal alimentação
        const padroesGastoPessoalAlimentacao = [
            "paguei meu almoco","paguei meu almoço","paguei meu jantar",
            "paguei meu lanche","paguei meu café","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refeição",
            "paguei minha comida","paguei minha janta",
            "meu almoço","meu almoco","meu jantar","minha janta",
            "meu lanche","meu lanche com o cartao","meu lanche com o cartão",
            "minha comida","almoco pessoal","almoço pessoal",
            "jantar pessoal","lanche pessoal","refeição pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cartão",
            "jantei com o cartao","jantei com o cartão",
            "comi com o cartao","comi com o cartão"
        ].map(normalize);

        const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));
        if (isGastoPessoalAlimentacao) {
  ultimaIntencao = "gasto_pessoal_alimentacao";
  return `HTML:<div class="text-sm text-slate-700">
    <p><b>Gasto pessoal com alimentação não é permitido no cartão Clara</b></p>
    <p class="mt-2">Refeições pessoais como almoço, jantar, lanches ou consumo individual não podem ser pagos com o cartão corporativo, pois não são despesas operacionais da loja.</p>
    <p class="mt-2">Se a compra já foi realizada, ela deve ser tratada como uso indevido.

    <details class="mt-3">
      <summary class="cursor-pointer underline">Ver orientação completa no ServiceNow / política</summary>
      <div class="mt-2">
        <p>Quando houver uso do cartão Clara para gasto pessoal, a loja deve:</p>
        <ul class="list-disc ml-4 mt-2 space-y-1">
          <li>Classificar a compra na Clara como <b>Despesa pessoal – Uso indevido</b>;</li>
          <li>Providenciar o ressarcimento do valor à empresa dentro do prazo definido;</li>
          <li>Formalizar o caso no ServiceNow, se orientado pelo Financeiro.</li>
        </ul>
        <p class="mt-2">O chamado a ser utilizado é <b>Gasto indevido (pessoal) / Ressarcimento – Cartão Clara</b>, com descrição do ocorrido, valor, data e loja.</p>
        <p class="mt-3 text-xs text-slate-500">Uso indevido pode gerar bloqueio preventivo do cartão e impactos administrativos para a loja.</p>
      </div>
    </details>
  </div>`;
}

        let resposta;

        switch (intencao) {
            case "foraEscopo":
                ultimaIntencao = "foraEscopo";
                resposta = respostaForaEscopo();
                break;


             // 🔹 NOVO: transação negada / categoria bloqueada
            case "transacaoNegadaCategoria":
                ultimaIntencao = "transacaoNegadaCategoria";
                resposta = respTransacaoNegadaCategoria();
                break;   


            case "etiqueta": {
                ultimaIntencao = "etiqueta";
                const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));
                const et = acharEtiquetaPorMensagem(norm);

                if (!et && isPerguntaGeral) {
                    resposta = respCatalogoEtiquetas();
                } else if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
              Não consegui identificar uma etiqueta específica só com esse texto.<br/>
              Se o gasto for operacional e não existir etiqueta adequada na lista da Clara, abra chamado no
              <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
              <strong>ServiceNow</strong>
              </a>
              solicitando criação ou ajuste de etiqueta.
              </p>`;
                }
                break;
            }


            case "sobreBot":
            resposta = `HTML:<div class="text-sm text-slate-700">
          <p>Sou o <b>Vektor</b> 🤖 — Agente do <b>Grupo SBF</b> especializado no <b>cartão Clara</b>.

          <p class="mt-2">Posso te ajudar com várias coisas, por exemplo:
          <ul class="list-disc ml-5 mt-1">
          <li>Explicar a <b>Política de Uso dos Cartões Clara</b>;</li>
          <li>Orientar sobre <b>o que pode e o que não pode ser comprado</b>;</li>
          <li>Indicar a <b>etiqueta correta</b> pra cada tipo de gasto (ex.: água, lanche, informática, manutenção...);</li>
          <li>Guiar sobre <b>bloqueio e desbloqueio</b> do cartão;</li>
          <li>Consultar <b>pendências da loja</b> e até <b>enviar o resumo por e-mail</b>;</li>
          <li>Consultar <b>transações efetuadas</b> e também comparar com outras lojas ou times</b>;</li>
          <li>Mostrar <b>como solicitar novo cartão</b> (primeira ou segunda via);</li>
          <li>Explicar sobre o <b>Termo de Responsabilidade</b> e onde preencher;</li>
          <li>Responder dúvidas sobre <b>sangria, limite, reembolsos e prestação de contas</b>;</li>
          <li>E, claro, te direcionar para os canais certos como <b>Financeiro</b> ou <b>ServiceNow</b> quando for preciso.

          <p class="mt-3">Basta me perguntar de forma natural, tipo:</p>
          <p>• “Qual etiqueta usar para lanche de treinamento?”<br/>
          • “Posso comprar mouse no cartão Clara?”<br/>
          • “Quais lojas/times com maior valor/quantidade de transações?”<br/>
          • “Times X, Y ou Z no periodo XXXXX”<br/>
          • “Pendências da loja 1234?”</p>

          <p class="mt-3 italic text-slate-500">Estou aqui pra facilitar o dia a dia das lojas no uso do cartão Clara. 💜</p>
          </div>`;
            break;

            case "limite":
                ultimaIntencao = "limite";
                resposta = respLimite();
                break;

                    case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
            resposta = respCartaoGeral();
            break;

    
            case "bloqueio": {
                  ultimaIntencao = "bloqueio";

                  // 1) Envia a mensagem principal de bloqueio (já aparece com os 3 pontinhos)
                  renderBotMessage(respBloqueio());

                  // 2) Prepara o estado para o fluxo de pendências ligadas a bloqueio
                  origemPendenciasBloqueio = true;
                  estadoPendencias = "aguardando_loja";
                  lojaPendenciasAtual = "";
                  ultimaPendenciaResumo = null;

                  // 3) Agenda a PRÓXIMA mensagem, com delay, também usando renderBotMessage
                  //    → assim aparece de novo o "digitando..." antes dela
                  setTimeout(() => {
                      renderBotMessage(`HTML:<p class="text-sm text-slate-700">
              Caso realmente seu cartão esteja bloqueado, devido a situações ligadas a pendências de justificativas de transações na Clara, posso te mostrar as pendências mais recentes do cartão da sua loja, daí você já corre lá no app da Clara pra regularizar 😉 .<br/><br/>
              🗣️ Me informa o número da loja, por favor.
              </p>`);
                  }, 1000); // 1000 ms = 1 segundo depois da primeira mensagem

                  // 4) Não devolve texto pro fluxo principal, porque a segunda mensagem
                  //    já vai ser enviada pelo setTimeout
                  return null;
              }

            case "prestacao":
                ultimaIntencao = "prestacao";
                resposta = respPrestacaoContas();
                break;

            case "alimentoTime":
                ultimaIntencao = "alimentoTime";
                resposta = respAlimentoTime();
                break;

            case "transportePessoal":
                ultimaIntencao = "transportePessoal";
                resposta = respTransportePessoal();
                break;

            case "trocaGerente":
    ultimaIntencao = "trocaGerente";

    // norm já foi calculado no começo de gerarRespostaPolitica
    const falaMudancaEntreLojas =
      norm.includes("mudar de loja") ||
      norm.includes("mudei de loja") ||
      norm.includes("mudanca de loja") ||
      norm.includes("mudança de loja") ||
      norm.includes("troca de loja") ||
      norm.includes("trocar de loja") ||
      norm.includes("vou mudar de loja") ||
      norm.includes("fui transferido") ||
      norm.includes("fui transferida") ||
      norm.includes("transferido de loja") ||
      norm.includes("transferida de loja") ||
      norm.includes("transferencia de loja") ||
      norm.includes("transferência de loja") ||
      norm.includes("mudei de unidade") ||
      norm.includes("trocar de unidade") ||
      norm.includes("troquei de loja") ||
      norm.includes("sou de outra loja") ||
      norm.includes("sou de outra unidade") ||
      norm.includes("troca de gerente");

    if (falaMudancaEntreLojas) {
        resposta = respTrocaGerenteMudancaLojas();
    } else {
        // férias, afastamento, desligado, sem gerente etc.
        resposta = respTrocaGerente();
    }
    break;

            case "procedimentosServiceNow":
                ultimaIntencao = "procedimentosServiceNow";
                resposta = respProcedimentosServiceNow();
                break;


            case "sangria":
                ultimaIntencao = "sangria";
                resposta = respSangria();
                break;

            case "fraudeContestacao":
                ultimaIntencao = "fraudeContestacao";
                resposta = respFraudeContestacao();
                break;

                case "podeNaoPode":
                case "generica":
                default:
                    ultimaIntencao = "generica";

                    // antes do genérico
                    if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) {
                      // deixa o bloco singular tratar; não cai no genérico
                      return;
                    } else {
                      resposta = respGenerica(norm);
                    }
                    break;
                        }

        return resposta;
    }

    // ====== MINI BOT DO MANUAL CLARA ======

    
const MANUAL_CLARA_LINK = "https://drive.google.com/file/d/1TYJ7x5Uxb5C47pNpUDWIzxXZb9lJfm8I/view?usp=sharing";
const POLITICA_CARTOES_CLARA_LINK = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";
const LOOKER_RELATORIO_URL = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

window.vektorManualClaraSecao = function (secaoId) {
  let html = "";

  if (secaoId === "primeiro_acesso") {
    html =
      "<p><b>01 Primeiro acesso:</b></p><br>" +
      "<p>1️⃣ Verifique se você recebeu o e-mail da Clara com o assunto <b>“Junte-se à Clara”</b> (olhe também no SPAM).</p>" +
      "<p>2️⃣ Siga o link do e-mail para criar sua senha.</p>" +
      "<p>3️⃣ Ative a autenticação em 2 etapas com um app como o <b>Google Authenticator</b> e escaneie o QR Code ao fazer o primeiro login no site da Clara.</p>" +
      "<p>4️⃣ Depois disso, sempre que entrar no site será pedido o código de 6 dígitos gerado pelo app de autenticação.</p>";
  }

  else if (secaoId === "recebi_cartao") {
    html =
      "<p><b>02 Recebi o cartão, e agora?</b></p><br>" +
      "<p>1️⃣ Baixe o app <b>Clara Card</b> (iOS ou Android).</p>" +
      "<p>2️⃣ Faça login com o mesmo e-mail/senha que você usa na plataforma Clara.</p>" +
      "<p>3️⃣ Vá em <b>Cartões</b>, selecione o cartão recebido e clique em <b>Ativar</b>.</p>" +
      "<p>4️⃣ Informe os <b>4 últimos dígitos</b> do cartão e conclua a ativação.</p>" +
      "<p>Depois disso o cartão já fica pronto para uso.</p>";
  }

  else if (secaoId === "esqueci_senha") {
    html =
      "<p><b>03 Esqueci a senha do cartão / acesso:</b></p><br>" +
      "<p>🔐 <b>Senha do cartão</b>: você vê apenas pelo aplicativo da Clara, em <b>Cartões &gt; Ver senha</b>. A senha é gerada automaticamente e não é alterável.</p><br>" +
      "<p>🔑 <b>Senha de login</b>: se esqueceu, use a opção de <b>redefinir senha</b> na tela de login da Clara. Um link será enviado para seu e-mail para criar uma nova senha.</p>" +
      "<p>Se você perdeu acesso ao app de autenticação (2 etapas), peça para alguém com acesso administrativo redefinir sua autenticação.</p>";
  }

  else if (secaoId === "qual_meu_acesso") {
    html =
      "<p><b>04 Qual o meu acesso?</b></p><br>" +
      "<p>1️⃣ Entre na plataforma Clara pelo computador.</p>" +
      "<p>2️⃣ Clique em <b>Meu Perfil</b>, no canto superior direito.</p>" +
      "<p>3️⃣ Na área de <b>Ações do usuário</b> aparece o seu tipo de acesso:</p>" +
      "<ul>" +
        "<li>• <b>Administrador (Owner)</b>: acesso total, vê saldo global, faturas, relatórios completos.</li>" +
        "<li>• <b>Gerente (Manager)</b>: gerencia usuários/cartões do seu grupo e vê saldo global.</li>" +
        "<li>• <b>Colaborador (Employee)</b>: vê somente seus cartões, transações e pode anexar notas.</li>" +
        "<li>• <b>Contador (Accountant)</b>: acesso a todas as faturas, boletos, relatórios e transações.</li>" +
      "</ul>";
  }

  else if (secaoId === "anexar_comprovante") {
    html =
      "<p><b>05 Como anexar comprovante?</b></p><br>" +
      "<p><b>Pelo app (celular):</b></p>" +
      "<ol>" +
        "<li>1. Abra o app da Clara e faça login.</li>" +
        "<li>2. Vá em <b>Transações</b> e selecione a compra.</li>" +
        "<li>3. Toque em <b>Anexar</b> e tire foto ou escolha o arquivo (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um <b>comentário</b> explicando a despesa.</li><br>" +
      "</ol>" +
      "<p><b>Pelo computador:</b></p>" +
      "<ol>" +
        "<li>1. Acesse a plataforma Clara e vá em <b>Transações</b>.</li>" +
        "<li>2. Clique na transação desejada.</li>" +
        "<li>3. Em <b>Selecionar arquivos</b>, envie o comprovante (XML, PDF, JPG ou PNG).</li>" +
        "<li>4. Opcional: adicione um comentário explicando a despesa.</li>" +
      "</ol>";
  }

  else if (secaoId === "duvidas") {
    html =
      "<p><b>06 Dúvidas:</b></p><br>" +
      "<p>Alguns pontos importantes:</p>" +
      "<ul>" +
        "<li>• <b>Autenticação em 2 etapas</b>: sempre use o código de 6 dígitos do app de autenticação ao entrar no site.</li>" +
        "<li>• <b>Problema de login</b>: verifique e-mail minúsculo, senha correta ou use “Continuar com Google” se já usou antes.</li>" +
        "<li>• <b>Perdi o celular ou cartão</b>: peça para alguém com acesso administrativo bloquear/cancelar o cartão e criar outro.</li>" +
        "<li>• <b>Cancelamento/estorno</b>: tente primeiro com o estabelecimento; se não resolver, conteste a transação via app/plataforma da Clara.</li>" +
      "</ul>" +
      "<p>Canais de suporte Clara: telefone 0800, e-mail, chat na Central de Ajuda (conforme manual).</p>";
  }

  if (!html) return;

  // Rodapé padrão com link para o manual completo
  html +=
    "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
      "Caso queira mais detalhes, acesse o manual completo: " +
      "<a href='" + MANUAL_CLARA_LINK + "' target='_blank' style='color:#005E27;font-weight:bold;'>Manual do Usuário Clara</a>." +
    "</p>";

  // 👉 REGISTRA o tópico no histórico
  try {
    registrarTopicoManualClara(secaoId);
  } catch (e) {
    console.warn("Não consegui registrar histórico do manual:", e);
  }

  // Envia a resposta principal
  renderBotMessage("HTML:<div class='text-sm text-slate-700'>" + html + "</div>");
  scrollToBottom && scrollToBottom();

  // 👉 Mostra um resumo do que o usuário já acessou (se tiver mais de 1 item)
  //vektorMostrarHistoricoManualSeExistir();

    // 👉 Sugestão automática baseada no tópico aberto
  if (typeof window.vektorSugerirTopicoRelacionadoManual === "function") {
    window.vektorSugerirTopicoRelacionadoManual(secaoId);
  }
};

// Mapeia o ID técnico para um título amigável
function mapSecaoManualParaTitulo(secaoId) {
  switch (secaoId) {
    case "primeiro_acesso":
      return "01 Primeiro acesso";
    case "recebi_cartao":
      return "02 Recebi o cartão, e agora?";
    case "esqueci_senha":
      return "03 Esqueci a senha do cartão / acesso";
    case "qual_meu_acesso":
      return "04 Qual o meu acesso?";
    case "anexar_comprovante":
      return "05 Como anexar comprovante?";
    case "duvidas":
      return "06 Dúvidas";
    default:
      return null;
  }
}

// Salva o histórico no localStorage (máx. 20 registros)
function registrarTopicoManualClara(secaoId) {
  try {
    const titulo = mapSecaoManualParaTitulo(secaoId);
    if (!titulo) return;

    const STORAGE_KEY = "vektor_manual_clara_historico";

    let historico = [];
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) historico = parsed;
      } catch (e) {
        console.warn("Histórico do manual Clara estava corrompido, reiniciando.");
      }
    }

    historico.push({
      secao: secaoId,
      titulo: titulo,
      dataIso: new Date().toISOString()
    });

    // limita a 20 entradas mais recentes
    if (historico.length > 20) {
      historico = historico.slice(historico.length - 20);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(historico));
  } catch (e) {
    console.warn("Erro ao salvar histórico do manual Clara:", e);
  }
}

// Lê o histórico e devolve ordenado do mais recente para o mais antigo
function obterHistoricoManualClara() {
  const STORAGE_KEY = "vektor_manual_clara_historico";
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];

    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];

    // ordena do mais recente para o mais antigo
    return parsed
      .filter(item => item && item.titulo && item.dataIso)
      .sort((a, b) => (a.dataIso || "").localeCompare(b.dataIso || ""));
  } catch (e) {
    console.warn("Erro ao ler histórico do manual Clara:", e);
    return [];
  }
}

// Mostra uma mensagem "Você já acessou recentemente..." no chat
function vektorMostrarHistoricoManualSeExistir() {
  try {
    const historico = obterHistoricoManualClara();
    if (!historico || historico.length <= 1) {
      // se só tem 0 ou 1 item, não faz sentido falar em "recentemente"
      return;
    }

    // pega no máximo 5 mais recentes (sem duplicar títulos)
    const vistos = [];
    const titulosJaUsados = new Set();

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || !item.titulo) continue;
      if (titulosJaUsados.has(item.titulo)) continue;

      titulosJaUsados.add(item.titulo);
      vistos.push(item.titulo);

      if (vistos.length >= 5) break;
    }

    if (!vistos.length) return;

    const listaHtml = vistos
      .map(t => "<li>• " + t + "</li>")
      .join("");

    const html =
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Você já acessou recentemente:</b></p>" +
        "<ul style='margin-top:4px;margin-left:16px;'>" +
          listaHtml +
        "</ul>" +
        "<p style='margin-top:6px;font-size:12px;color:#64748b;'>" +
          "Você pode clicar novamente nos botões do Manual da Clara para reabrir qualquer um desses tópicos." +
        "</p>" +
      "</div>";

    renderBotMessage("HTML:" + html);
    if (typeof scrollToBottom === "function") {
      scrollToBottom();
    }
  } catch (e) {
    console.warn("Erro ao mostrar histórico do manual Clara:", e);
  }
}

// ---------------------------------------------------------------------
// SUGESTÕES GERAIS DO VEKTOR (fora do Manual da Clara)
// ---------------------------------------------------------------------

function vektorSugerirTopicosGerais(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);
    const blocos = [];

    // 1) Dúvidas de PERMISSÃO DE COMPRA → sugerir Política de Uso (apenas 1 vez por sessão)
    if (
      !__vektorJaSugeriuPoliticaRestricoes &&
      (
        norm.includes("pode comprar") ||
        norm.includes("posso comprar") ||
        norm.includes("pode usar") ||
        norm.includes("posso usar") ||
        norm.includes("pode pagar") ||
        norm.includes("posso pagar") ||
        norm.includes("permitido") ||
        norm.includes("permitida") ||
        norm.includes("proibido") ||
        norm.includes("proibida")
      ) &&
      typeof POLITICA_CARTOES_CLARA_LINK === "string"
    ) {
      __vektorJaSugeriuPoliticaRestricoes = true;

      blocos.push(
        "<div style='margin-top:6px;'>" +
          "<p><b>Dica:</b> sempre que tiver dúvida se uma compra é permitida ou não, você pode consultar a <b>Política de Uso dos Cartões Clara</b>, <b>Item 7 - Restrições de Uso</b>.</p>" +
          "<button type='button' " +
            "onclick=\"window.open('" + POLITICA_CARTOES_CLARA_LINK + "','_blank')\" " +
            "style='margin-top:6px;background:#06167d;color:#fff;border:none;" +
                   "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir Política de Uso dos Cartões Clara" +
          "</button>" +
        "</div>"
      );
    }

    // 2) Pedidos de RELATÓRIO / RANKING / DASHBOARD → sugerir Looker Studio (apenas 1 vez)
    if (
      !__vektorJaSugeriuLooker &&
      (
        norm.includes("top") ||
        norm.includes("mais comprou") ||
        norm.includes("mais gastos") ||
        norm.includes("mais gastou") ||
        norm.includes("mais compras") ||
        norm.includes("maior valor") ||
        norm.includes("mais transações") ||
        norm.includes("mais transacoes")
      )
    ) {
      blocos.push(
        "<div style='margin-top:10px;'>" +
          "<p>Se quiser uma visão completa (gráficos, filtros e detalhamentos), posso abrir o <b>relatório gerencial</b> aqui no chat:</p>" +
          "<button type='button' " +
            "onclick=\"window.vektorAbrirRelatorioGerencialNoChat()\" " +
            "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
                  "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
            "Abrir relatório gerencial no chat" +
          "</button>" +
        "</div>"
      );

      __vektorJaSugeriuLooker = true;
    }

    // 3) PENDÊNCIAS / JUSTIFICATIVAS → reforçar política e fluxo (apenas 1 vez por sessão)
    if (
      !__vektorJaSugeriuJustificativas &&
      (
        norm.includes("pendencia") ||
        norm.includes("pendência") ||
        norm.includes("pendencias") ||
        norm.includes("pendências") ||
        norm.includes("justificativa") ||
        norm.includes("justificativas") ||
        norm.includes("justificar") ||
        norm.includes("justificativas completas") ||
        norm.includes("ver justificativas completas") ||
        norm.includes("justificativas de uma loja") ||
        norm.includes("justificativas de um time")
      )
    ) {
      __vektorJaSugeriuJustificativas = true;

      blocos.push(
  "<div style='margin-top:10px;'>" +
    "<p>Além de anexar os comprovantes, existe uma política específica de prazos e regras para justificativas.</p>" +
    "<p style='margin-top:4px;'>Em caso de dúvida, consulte a <b><a href='" +
      (typeof POLITICA_CARTOES_CLARA_LINK !== 'undefined'
        ? POLITICA_CARTOES_CLARA_LINK
        : '#') +
      "' target='_blank' style='color:#005E27; text-decoration:underline;'>Política de Uso dos Cartões Clara</a></b> ou acione o time de Conta a Receber.</p>" +
  "</div>"
);
    }

    // Se nada acionou, não sugere nada
    if (!blocos.length) return;

    const html =
      "HTML:<div class='text-sm text-slate-700 mt-2'>" +
        blocos.join("<hr style='margin:8px 0;border:none;border-top:1px solid #e2e8f0;'/>") +
      "</div>";

    // 🔁 Aguarda para dar tempo da resposta "normal" aparecer antes
    setTimeout(function () {
      renderBotMessage(html);
      if (typeof scrollToBottom === "function") {
        scrollToBottom();
      }
    }, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir tópicos gerais:", e);
  }

  // Sugestão quando o usuário fala de ciclo de fatura
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("período da fatura")
  ) {
    vektorMostrarSugestao(
      "Quer ver a tabela completa das faturas?",
      "Quero ver a tabela de faturas da Clara"
    );
  }
}

// ---------------------------------------------------------------------
// SUGESTÕES AUTOMÁTICAS DO MANUAL DA CLARA A PARTIR DE OUTROS ASSUNTOS
// ---------------------------------------------------------------------

const VEKTOR_TEMPO_SUGESTAO_MIN = 5000; // Depois que já sugeriu...
const VEKTOR_SUGESTAO_DELAY_MS = 15000;   // Primeira vez que sugeriu

// Verifica se o usuário já abriu um tópico do manual há pouco tempo
function usuarioViuTopicoManualRecentemente(secaoId, minutosJanela) {
  try {
    minutosJanela = minutosJanela || 10; // padrão = 10 minutos
    const historico = obterHistoricoManualClara();
    if (!historico || !historico.length) return false;

    const agora = Date.now();
    const limiteMs = minutosJanela * 60 * 1000;

    for (let i = 0; i < historico.length; i++) {
      const item = historico[i];
      if (!item || item.secao !== secaoId || !item.dataIso) continue;

      const t = Date.parse(item.dataIso);
      if (!isNaN(t) && (agora - t) <= limiteMs) {
        return true; // já viu recentemente
      }
    }
  } catch (e) {
    console.warn("Erro ao checar histórico recente do manual:", e);
  }
  return false;
}

// Lê a pergunta do usuário e, se fizer sentido, sugere um tópico do Manual da Clara

function vektorSugerirManualAPartirDaPergunta(msgOriginal) {
  try {
    if (!msgOriginal || typeof msgOriginal !== "string") return;

    const norm = normalize(msgOriginal);

    // Se o usuário já pediu o manual explicitamente, não sugerimos aqui
    if (
      norm.includes("manual clara") ||
      norm.includes("manual da clara") ||
      norm.includes("treinamento clara") ||
      norm.includes("treinamento da clara")
    ) {
      return;
    }

    let sugestao = null;

    // 1) Comprovante / nota / justificativa → sugerir "Como anexar comprovante"
if (
  norm.includes("comprovante") ||
  norm.includes("nota fiscal") ||
  norm.includes(" nf ") ||
  norm.includes(" xml") ||
  norm.includes("justificativa") ||
  norm.includes("justificar") ||
  norm.includes("pendencia") ||
  norm.includes("pendencias") ||
  norm.includes("pendências") ||
  norm.includes("pendência")
) {
  // ❗ Só sugere uma vez por sessão
  if (vektorSugestaoJaMostrada("manual_anexar_comprovante")) {
    return; // já sugeriu antes nesta sessão, não repete
  }

  vektorMarcarSugestaoMostrada("manual_anexar_comprovante");

  sugestao = {
    secaoId: "anexar_comprovante",
    tituloBotao: "Ver como anexar comprovante",
    textoIntro:
      "Percebi que você está falando de nota fiscal, comprovante ou pendência. Quer abrir o trecho do Manual da Clara sobre isso?"
  };
}

    // 2) Problemas de login / primeiro acesso
    else if (
      norm.includes("primeiro acesso") ||
      norm.includes("primeiro login") ||
      norm.includes("junte-se a clara") ||
      norm.includes("junte se a clara") ||
      norm.includes("nao consigo acessar") ||
      norm.includes("não consigo acessar") ||
      norm.includes("erro de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("primeiro_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "primeiro_acesso",
          tituloBotao: "Ver instruções de primeiro acesso",
          textoIntro:
            "Se for sua primeira vez usando a Clara ou estiver com dificuldade de acesso, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 3) Esqueci a senha / senha do cartão
    else if (
      norm.includes("esqueci a senha") ||
      norm.includes("esqueci minha senha") ||
      norm.includes("senha do cartao") ||
      norm.includes("senha do cartão") ||
      norm.includes("senha de acesso")
    ) {
      if (!usuarioViuTopicoManualRecentemente("esqueci_senha", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "esqueci_senha",
          tituloBotao: "Ver como recuperar/consultar senha",
          textoIntro:
            "Você comentou sobre senha. Posso abrir a parte do Manual da Clara que fala sobre isso:"
        };
      }
    }

    // 4) Tipo de acesso / perfil
    else if (
      norm.includes("meu acesso") ||
      norm.includes("tipo de acesso") ||
      norm.includes("owner") ||
      norm.includes("manager") ||
      norm.includes("employee") ||
      norm.includes("contador")
    ) {
      if (!usuarioViuTopicoManualRecentemente("qual_meu_acesso", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "qual_meu_acesso",
          tituloBotao: "Ver tipos de acesso na Clara",
          textoIntro:
            "Se a dúvida é sobre qual é o seu tipo de acesso na Clara, este trecho do Manual pode ajudar:"
        };
      }
    }

    // 5) Dúvidas gerais, suporte, estorno, cartão perdido, etc.
    else if (
      norm.includes("duvida") ||
      norm.includes("dúvida") ||
      norm.includes("ajuda") ||
      norm.includes("suporte") ||
      norm.includes("telefone") ||
      norm.includes("0800") ||
      norm.includes("estorno") ||
      norm.includes("contestacao") ||
      norm.includes("contestação") ||
      norm.includes("perdi o cartao") ||
      norm.includes("perdi o cartão") ||
      norm.includes("cartao perdido") ||
      norm.includes("cartão perdido") ||
      norm.includes("cartao roubado") ||
      norm.includes("cartão roubado") ||
      norm.includes("bloquear cartao") ||
      norm.includes("bloquear cartão")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver dúvidas e canais de suporte",
          textoIntro:
            "Como você mencionou dúvidas, suporte, estorno ou perda/bloqueio de cartão, posso te mostrar o trecho do Manual da Clara com os principais contatos e orientações:"
        };
      }
    }

    // 6) Limite / aumento de limite / limite estourado
    else if (
      norm.includes("limite") ||
      norm.includes("aumentar limite") ||
      norm.includes("aumento de limite") ||
      norm.includes("ajustar limite") ||
      norm.includes("cartão sem limite limite") ||
      norm.includes("estourou o limite") ||
      norm.includes("limite estourado")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orientações gerais e canais de suporte",
          textoIntro:
            "Você falou sobre limite de cartão. Posso abrir a parte do Manual do usuário da Clara com orientações gerais e canais de suporte para esse tipo de dúvida:"
        };
      }
    }

    // 7) Bloqueio por pendência / cartão recusado
    else if (
      norm.includes("cartao bloqueado") ||
      norm.includes("cartão bloqueado") ||
      norm.includes("cartao recusado") ||
      norm.includes("cartão recusado") ||
      norm.includes("nao aprovou") ||
      norm.includes("não aprovou") ||
      norm.includes("recusou a compra") ||
      norm.includes("compra recusada")
    ) {
      if (!usuarioViuTopicoManualRecentemente("anexar_comprovante", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "anexar_comprovante",
          tituloBotao: "Ver como regularizar usando comprovantes",
          textoIntro:
            "Quando há bloqueios e recusas, muitas vezes o problema está em pendências de comprovantes. Quer ver o trecho do Manual que explica como anexar comprovantes e regularizar?"
        };
      }
    }

    // 8) Fraude / transação desconhecida / contestação
    else if (
      norm.includes("fraude") ||
      norm.includes("transacao desconhecida") ||
      norm.includes("transação desconhecida") ||
      norm.includes("lancamento indevido") ||
      norm.includes("lançamento indevido") ||
      norm.includes("compra indevida")
    ) {
      if (!usuarioViuTopicoManualRecentemente("duvidas", VEKTOR_TEMPO_SUGESTAO_MIN)) {
        sugestao = {
          secaoId: "duvidas",
          tituloBotao: "Ver orientações de contestação/estorno",
          textoIntro:
            "Você comentou sobre transação desconhecida ou possível fraude. Posso abrir a parte do Manual do usuário da Clara que fala sobre contestação e estorno:"
        };
      }
    }

    // Se nenhuma sugestão foi montada, sai
    if (!sugestao) return;

    const html =
  "HTML:<div class='text-sm text-slate-700 mt-2'>" +
    "<p>" + sugestao.textoIntro + "</p>" +
    "<button type='button' " +
      "onclick=\"vektorManualClaraSecao('" + sugestao.secaoId + "')\" " +
      "style='margin-top:6px;background:#005E27;color:#fff;border:none;" +
             "padding:6px 10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;'>" +
      sugestao.tituloBotao +
    "</button>" +
  "</div>";

// 🔁 Aguarda para dar tempo da resposta principal aparecer antes
setTimeout(function () {
  renderBotMessage(html);
  if (typeof scrollToBottom === "function") {
    scrollToBottom();
  }
}, VEKTOR_SUGESTAO_DELAY_MS);

  } catch (e) {
    console.warn("Erro ao sugerir tópico do Manual da Clara:", e);
  }
}


// ========= SUGESTÃO AUTOMÁTICA DE TÓPICOS RELACIONADOS ========= //

window.vektorSugerirTopicoRelacionadoManual = function (secaoId) {
  // Por enquanto vamos tratar apenas o caso "anexar_comprovante"
  if (secaoId !== "anexar_comprovante") return;

  // 🔹 NÃO repetir essa sugestão várias vezes na mesma sessão
  if (vektorSugestaoJaMostrada("politica_justificativas")) {
    return;
  }
  vektorMarcarSugestaoMostrada("politica_justificativas");

  const html =
    "HTML:<div class='text-sm text-slate-700 mt-2'>" +
      "<p><b>Sugestão:</b> Quer ver também como funciona a <b>política de justificativas</b>?</p>" +
      "<div style='margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;'>" +
        "<button onclick=\"vektorAbrirPoliticaJustificativas()\" " +
                "class='px-3 py-2 rounded-md bg-[#005E27] text-white text-sm font-semibold'>" +
          "Ver política de justificativas" +
        "</button>" +
        "<button onclick=\"vektorIgnorarSugestaoPolitica()\" " +
                "class='px-3 py-2 rounded-md border text-sm'>" +
          "Agora não" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
}

// Quando o usuário clicar em "Ver política de justificativas"
window.vektorAbrirPoliticaJustificativas = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p><b>Política de justificativas (resumo):</b></p>" +
      "<ul style='margin-top:4px;margin-left:16px;'>" +
        "<li>• Cada transação deve ter justificativa e comprovante anexado dentro de, no máximo, 48 horas após a cpmpra.</li><br>" +
        "<li>• <b>Para justificar</b>: Inserir nota fiscal ou recibo da compra, informar a etiqueta do tipo de gasto e inserir no campo Descrição o item adquirido.</li><br>" +
        "<li>• Despesas sem justificativas ou com documentos inconsistentes podem ser questionadas pelo time Financeiro.</li><br>" +
        "<li>• Em casos recorrentes, a empresa pode adotar medidas adicionais, como o bloqueio preventivo do cartão.</li>" +
      "</ul>" +
   // 🔽 AQUI ENTRA O LINK NO RODAPÉ
      "<p style='margin-top:8px;font-size:12px;color:#475569;'>" +
        "Consulte a Política de Uso dos Cartões Clara: " +
        "<a href='" + POLITICA_CARTOES_CLARA_LINK + "' target='_blank' " +
        "style='color:#005E27;font-weight:bold;'>clique aqui para abrir</a>." +
      "</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// Caso ele clique em "Agora não"
window.vektorIgnorarSugestaoPolitica = function () {
  const html =
    "HTML:<div class='text-sm text-slate-700'>" +
      "<p>Beleza. Se quiser ver a política de justificativas depois, é só me pedir 😉</p>" +
    "</div>";

  renderBotMessage(html);
  if (typeof scrollToBottom === "function") scrollToBottom();
};

// ================= VEKTOR_STATE – memória leve da conversa =================
window.VEKTOR_STATE = {
  ultimaIntencao: null,         // ex: "ranking_lojas", "resumo_times", "fatura_times"
  ultimoPeriodo: null,          // { dataInicioIso, dataFimIso }
  ultimoGrupo: null,            // nome do time / grupo
  ultimaLoja: null,             // código da loja
  ultimaAcaoExplicavel: null,   // meta da última tabela gerada
  sugestoesMostradas: []        // controle de sugestões proativas para não repetir
};

function vektorRegistrarContexto(evento) {
  try {
    if (!evento || typeof evento !== "object") return;

    window.VEKTOR_STATE = window.VEKTOR_STATE || {};
    Object.assign(window.VEKTOR_STATE, evento);
  } catch (e) {
    console.warn("Erro ao registrar contexto:", e);
  }
}

function vektorObterContexto() {
  return window.VEKTOR_STATE || {};
}

function vektorExplicarUltimaTabela() {
  const st = vektorObterContexto();
  const info = st.ultimaAcaoExplicavel;

  if (!info || !info.tipo) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Ainda não tenho uma tabela recente para explicar. Tente pedir um ranking ou um resumo primeiro.</p>"
    );
    return;
  }

  let html = "HTML:<div class='text-sm text-slate-700'>";

  if (info.tipo === "tabela_ranking_lojas") {
    const m = info.meta || {};
    html +=
      "<p><b>Como essa tabela foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>• Foram consideradas todas as transações da BaseClara no período filtrado.</li>" +
        "<li>• Agrupei os valores por <b>loja</b> e somei " +
          (m.criterio === "quantidade"
            ? "a quantidade de transações"
            : "o valor total em R$.") +
        "</li>" +
        (m.grupo
          ? "<li>• Limitei somente às lojas do time <b>" + m.grupo + "</b>.</li>"
          : "") +
        (m.topN
          ? "<li>• Mostrei apenas o <b>top " + m.topN + "</b> lojas, em ordem decrescente.</li>"
          : "<li>• Listei todas as lojas com movimentação nesse período.</li>") +
      "</ul>";
  } else if (info.tipo === "tabela_times") {
    const m = info.meta || {};
    html +=
      "<p><b>Como essa tabela de times foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>• Usei as transações da BaseClara no período selecionado.</li>" +
        "<li>• Agrupei pelo campo <b>Grupo / Time</b> da planilha.</li>" +
        "<li>• Para cada time, calculei quantidade de transações e valor total em R$.</li>" +
        "<li>• Também calculei o percentual de participação de cada time, em relação ao total do período.</li>" +
      "</ul>";
  } else if (info.tipo === "tabela_times_fatura") {
    const m = info.meta || {};
    html +=
      "<p><b>Como a tabela de times dessa fatura foi montada:</b></p>" +
      "<ul style='margin-left:16px;margin-top:4px;'>" +
        "<li>• Primeiro filtrei as transações que pertencem ao <b>extrato</b> '" +
          (m.extrato || "") + "'.</li>" +
        "<li>• Em seguida agrupei por <b>time</b>, somando o valor em R$ de cada um.</li>" +
        "<li>• O período usado é o mesmo do ciclo de fatura mostrado na tabela anterior.</li>" +
      "</ul>";
  } else {
    html +=
      "<p>Ainda não tenho uma explicação específica para esse tipo de tabela (" +
      info.tipo +
      "), mas posso te ajudar a interpretar os números se você quiser.</p>";
  }

  html += "</div>";

  renderBotMessage(html);
}

function vektorSugestaoJaMostrada(id) {
  const st = vektorObterContexto();
  const lista = Array.isArray(st.sugestoesMostradas) ? st.sugestoesMostradas : [];
  return lista.indexOf(id) >= 0;
}

function vektorMarcarSugestaoMostrada(id) {
  if (!id) return;
  const st = vektorObterContexto();
  if (!Array.isArray(st.sugestoesMostradas)) {
    st.sugestoesMostradas = [];
  }
  if (st.sugestoesMostradas.indexOf(id) < 0) {
    st.sugestoesMostradas.push(id);
  }
}

var criterio = "quantidade";

// ========= MOTOR DE INTENÇÕES POR REGRAS =========

// Cada regra tem:
// - id: identificador da intenção
// - minScore: pontuação mínima para considerar a regra "ganhadora"
// - score(norm, msgOriginal): função que calcula um score com base no texto normalizado
// - run(msgOriginal, norm): função que retorna o "resultado" da intenção
const INTENT_RULES = [
  {
    id: "ACAO_LISTAR_ETIQUETAS_CLARA",
    minScore: 3,
      score: function (norm, msgOriginal) {
    if (!norm) return 0;
    let s = 0;

    const temEtiqueta =
      norm.includes("etiqueta") || norm.includes("etiquetas");

    if (!temEtiqueta) {
      // Se nem fala em etiqueta, essa intenção não faz sentido
      return 0;
    }

    // 1) Base: mencionou etiqueta → 1 ponto (mas isso sozinho não dispara a tabela)
    s += 1;

    // 2) Sinais de "visão em tabela / lista consolidada"
    const falaTabela =
      norm.includes("tabela de etiquetas") ||
      norm.includes("tabela com as etiquetas") ||
      norm.includes("tabela das etiquetas") ||
      norm.includes("tabela") && temEtiqueta; // ex: "tabela por etiqueta"

    const falaLista =
      norm.includes("lista de etiquetas") ||
      norm.includes("listagem de etiquetas") ||
      norm.includes("listagem das etiquetas") ||
      norm.includes("ver todas as etiquetas") ||
      norm.includes("todas as etiquetas");

    if (falaTabela) s += 2;
    if (falaLista) s += 2;

    // 3) Sinais de análise de gasto/percentual/valor
    const falaGasto =
      norm.includes("gasto por etiqueta") ||
      norm.includes("gastos por etiqueta") ||
      norm.includes("gastos por etiquetas") ||
      norm.includes("despesa por etiqueta") ||
      norm.includes("despesas por etiqueta") ||
      norm.includes("resumo por etiqueta") ||
      norm.includes("resumo de etiquetas") ||
      norm.includes("consolidado por etiqueta");

    const falaPercentual =
      norm.includes("percentual por etiqueta") ||
      norm.includes("porcentagem por etiqueta") ||
      norm.includes("percentual de uso das etiquetas") ||
      norm.includes("porcentagem de uso das etiquetas");

    const falaValor =
      norm.includes("valor por etiqueta") ||
      norm.includes("valores por etiqueta") ||
      norm.includes("quanto foi gasto em cada etiqueta");

    if (falaGasto) s += 2;
    if (falaPercentual) s += 2;
    if (falaValor) s += 2;

    // 4) Frases “pedindo visão gerencial”
    const falaVisao =
      norm.includes("visao por etiqueta") ||
      norm.includes("visão por etiqueta") ||
      norm.includes("relatorio por etiqueta") ||
      norm.includes("relatório por etiqueta") ||
      norm.includes("ranking de etiquetas");

    if (falaVisao) s += 2;

    return s;
  },
  run: function (msgOriginal, norm) {
  // Se a frase pede visão de gasto/valor/percentual/relatório, é "Gastos por etiquetas"
  const falaGasto =
    norm.includes("gasto por etiqueta") ||
    norm.includes("gastos por etiqueta") ||
    norm.includes("gastos por etiquetas") ||
    norm.includes("despesa por etiqueta") ||
    norm.includes("despesas por etiqueta") ||
    norm.includes("resumo por etiqueta") ||
    norm.includes("resumo de etiquetas") ||
    norm.includes("consolidado por etiqueta");

  const falaPercentual =
    norm.includes("percentual por etiqueta") ||
    norm.includes("porcentagem por etiqueta") ||
    norm.includes("percentual de uso das etiquetas") ||
    norm.includes("porcentagem de uso das etiquetas");

  const falaValor =
    norm.includes("valor por etiqueta") ||
    norm.includes("valores por etiqueta") ||
    norm.includes("quanto foi gasto em cada etiqueta");

  const falaVisao =
    norm.includes("visao por etiqueta") ||
    norm.includes("visão por etiqueta") ||
    norm.includes("relatorio por etiqueta") ||
    norm.includes("relatório por etiqueta") ||
    norm.includes("ranking de etiquetas");

  if (falaGasto || falaPercentual || falaValor || falaVisao) {
    return "ACAO_GASTOS_ETIQUETAS_CLARA";
  }

  // Caso contrário, é a listagem explicativa/catálogo
  return "ACAO_LISTAR_ETIQUETAS_CLARA";
}
  }

  ,{
  id: "INTENT_LISTA_DEMISSOES",
  minScore: 2,
  score: function (norm, msgOriginal) {
    // aceita variações simples
    const falaDemissoes =
      norm.includes("lista de demissoes") ||
      norm.includes("lista de demissões");

    // força ser bem intencional: "lista" + "demissões"
    const falaLista =
      norm.includes("lista") || norm.includes("listagem");

    return (falaDemissoes && falaLista) ? 3 : 0;
  },
  run: function (msgOriginal, norm) {
    return "ACAO_LISTA_DEMISSOES";
  }
}

,{ id: "INTENT_FREQUENCIA_USO_CLARA",
  minScore: 2,
  score: function (norm, msgOriginal) {
    let s = 0;

    // gatilho principal
    const falaFreq =
      norm.includes("frequencia de uso") ||
      norm.includes("frequência de uso");

    const falaClara = norm.includes("clara");

    if (falaFreq) s += 3;
    if (falaClara) s += 1;

    // reforços: "para o time" / "para a loja"
    if (norm.includes("para o time") || norm.includes("time ")) s += 1;
    if (norm.includes("para a loja") || norm.includes("loja ")) s += 1;

    return s;
  },
  run: function (msgOriginal, norm) {
    return "ACAO_FREQUENCIA_USO_CLARA";
  }
}

];

  // ➜ Futuro: aqui você adiciona novas regras:
  // {
  //   id: "INTENT_FATURA_ATUAL",
  //   minScore: 2,
  //   score: function (norm, msgOriginal) { ... },
  //   run: function (msgOriginal, norm) { ... }
  // }
// ];

// Função que escolhe a melhor regra com base em score
function aplicarRegraDeIntencao(msgOriginal) {
  const norm = normalize(msgOriginal || "");
  if (!INTENT_RULES || !INTENT_RULES.length) return null;

  let melhorRegra = null;
  let melhorScore = 0;

  for (const regra of INTENT_RULES) {
    try {
      const s = typeof regra.score === "function"
        ? Number(regra.score(norm, msgOriginal) || 0)
        : 0;

      if (s > melhorScore) {
        melhorScore = s;
        melhorRegra = regra;
      }
    } catch (e) {
      console.warn("Erro ao calcular score de intenção:", regra && regra.id, e);
    }
  }

  if (!melhorRegra) return null;

  const min = typeof melhorRegra.minScore === "number" ? melhorRegra.minScore : 1;
  if (melhorScore < min) {
    // Nenhuma regra atingiu o limiar mínimo
    return null;
  }

  // Executa a ação da regra encontrada
  if (typeof melhorRegra.run === "function") {
    return melhorRegra.run(msgOriginal, norm);
  }

  return null;
}

// Fallback: quando nada casa, perguntar em vez de chutar resposta
function gerarPerguntaDeClarificacao(norm) {
  norm = norm || "";

  // Se a mensagem é claramente sobre justificativa / nota / comprovante,
  // NÃO gera pergunta de clarificação (o fluxo de justificativa já responde).
  const ehJustificativa =
    norm.includes("justific") ||          // justificativa / justificar
    norm.includes("nota fiscal") ||
    norm.includes("nota da compra") ||
    norm.includes("perdi a nota") ||
    norm.includes("falta a nota") ||
    norm.includes("despesa sem nota") ||
    norm.includes("despesa sem comprovante") ||
    norm.includes("comprovante") ||
    norm.includes("comprovantes");

  if (ehJustificativa) {
    return ""; // devolve vazio para não mostrar nada
  }

  const temasProvaveis = [];

  // Sinais de tema → só pra deixar a pergunta mais “esperta”
  if (norm.includes("pendenc")) {
    temasProvaveis.push("pendências da Clara");
  }
  if (norm.includes("justific")) {
    temasProvaveis.push("justificativas das transações");
  }
  if (norm.includes("fatura")) {
    temasProvaveis.push("faturas / ciclo de fatura");
  }
  if (norm.includes("bloqueio") || norm.includes("bloqueado")) {
    temasProvaveis.push("bloqueio ou desbloqueio do cartão");
  }
  if (norm.includes("limite")) {
    temasProvaveis.push("limite do cartão Clara");
  }
  if (
    norm.includes("nota fiscal") ||
    norm.includes("nf ") ||
    norm.includes("nf/") ||
    norm.includes("recibo")
  ) {
    temasProvaveis.push("nota fiscal / recibo / comprovantes");
  }

  // Se não achou nenhum “cheiro”…
  if (!temasProvaveis.length) {

    // 🔹 1) Primeiro: checa se é caso de SANGRIA
    const falaSangria =
      norm.includes("sangria") ||
      norm.includes("sangrias") ||
      norm.includes("fazer sangria") ||
      norm.includes("como fazer sangria") ||
      norm.includes("puxar dinheiro do caixa") ||
      norm.includes("retirar dinheiro do caixa") ||
      norm.includes("tirar dinheiro do caixa") ||
      norm.includes("retirada de dinheiro do caixa") ||
      norm.includes("movimentacao de dinheiro no caixa") ||
      norm.includes("movimentação de dinheiro no caixa") ||
      norm.includes("saida de dinheiro do caixa") ||
      norm.includes("saída de dinheiro do caixa") ||
      norm.includes("suprimento") ||
      norm.includes("suprimentos") ||
      norm.includes("fazer suprimento") ||
      norm.includes("registro de sangria") ||
      norm.includes("registrando sangria");

    if (falaSangria) {
      // 🔸 IMPORTANTE:
      // retorna string vazia → NÃO gera pergunta de clarificação.
      // Isso deixa o fluxo seguir até o motor da política
      // (detectarIntencaoPergunta -> "sangria" -> respSangria).
      return "";
    }

    // 🔹 2) Se não é sangria, usa a frase padrão de “não entendi”
    const variacoes = [
      "Não tenho certeza se entendi sua pergunta. Você está falando de pendências, faturas, regras de uso do cartão ou outro assunto?",
      "Fiquei em dúvida sobre o que você quis dizer. É algo sobre pendências, faturas ou regras de uso do cartão?",
      "Talvez eu esteja interpretando errado. Seu assunto é pendências, faturas, política de uso do cartão ou outra coisa?",
      "Preciso de mais contexto. Sua dúvida envolve pendências, faturas, regras do cartão Clara ou é outro tema?",
      "Não consegui identificar o assunto. Você queria saber sobre faturas, pendências, política de compras ou algo diferente?",
      "Não entendi completamente sua pergunta. Está relacionada a pendências, faturas, cartão Clara ou outro tema?"
    ];

    const frase = variacoes[Math.floor(Math.random() * variacoes.length)];

    return (
      "HTML:" +
      "<p class='text-sm text-slate-700'>" +
      frase +
      "</p>"
    );
  }

  // Se achou alguns temas, monta a frase usando eles
  const listaTemas = temasProvaveis
    .map(function (t) { return "<b>" + t + "</b>"; })
    .join(", ");

  return (
    "HTML:" +
    "<p class='text-sm text-slate-700'>" +
    "Não tenho certeza se entendi completamente. " +
    "Estou entendendo que pode ser algo relacionado a " + listaTemas + ". " +
    "Você consegue detalhar um pouco melhor o que precisa?" +
    "</p>"
  );
}

// Tenta entender respostas curtas depois da pergunta de clarificação

function tentarInterpretarRespostaClarificacao(norm) {
  let t = (norm || "").trim().toLowerCase();
  if (!t) return null;

  // normaliza acentos
  t = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

  const palavras = t.split(/\s+/).filter(Boolean);

  // 1) Só trata respostas MUITO curtas (no máx. 3 palavras).
  // Se a pessoa escreveu uma frase mesmo ("valor das ultimas 3 faturas"),
  // NÃO é clarificação, é uma pergunta nova → não mexe.
  if (palavras.length > 3) {
    return null;
  }

  // 2) Se tem número, "ultimas", "todas", "valor", "periodo", etc,
  // não é clarificação simples. Deixa passar sem reescrever.
  const temNumero = /\d/.test(t);
  const temDetalhe =
    t.includes("ultima") ||
    t.includes("ultimas") ||
    t.includes("todas") ||
    t.includes("valor") ||
    t.includes("periodo") ||
    t.includes("periodo") ||
    t.includes("historico") ||
    t.includes("quantidade");

  if (temNumero || temDetalhe) {
    return null;
  }

  // 3) Agora sim, mapeia respostas bem curtas
  // Ex.: "pendencias", "pendência clara"
  if (t.includes("pendenc")) {
    return "Quero consultar as pendências Clara da minha loja";
  }

  // Ex.: "fatura", "faturas"
  if (t.includes("fatura")) {
    return "Quero ver as faturas da Clara";
  }

  // Ex.: "regras", "politica", "uso do cartao"
  if (
    t.includes("regra") ||
    t.includes("regras") ||
    t.includes("politica") ||
    t.includes("politicas") ||
    t.includes("politica de uso") ||
    t.includes("uso do cartao") ||
    t.includes("uso do cartão")
  ) {
    return "Quero tirar dúvidas sobre a política de uso do cartão Clara";
  }

  // Se não encaixar em nada, não força interpretação
  return null;
}

// 🧠 Engine simples de insights em cima de faturas
function analisarFaturas(faturas) {
  try {
    if (!Array.isArray(faturas) || faturas.length === 0) {
      return "";
    }

    // Normaliza estrutura e garante que temos valor numérico e um rótulo
    const lista = faturas
      .map(function (f, idx) {
        // tenta achar um campo de valor numérico entre algumas possibilidades
        const valorRaw =
          f.valorFatura ??
          f.valor_fatura ??
          f.valor_total ??
          f.valor ??
          f.total ??
          0;

        const valor = Number(valorRaw) || 0;

        // tenta achar um rótulo amigável
        const rotulo =
          f.rotulo ||
          f.label ||
          f.referencia ||
          f.mesReferencia ||
          f.mes ||
          f.periodo ||
          f.descricao ||
          ("Fatura " + (idx + 1));

        // tenta achar algo que represente "ordem temporal"
        const chaveOrdenacao =
          f.dataReferencia ||
          f.data_fatura ||
          f.dataVencimento ||
          f.data_vencimento ||
          f.mesReferencia ||
          f.periodo ||
          rotulo;

        return {
          original: f,
          valor: valor,
          rotulo: String(rotulo),
          chave: String(chaveOrdenacao)
        };
      })
      .filter(function (f) {
        return f.valor > 0;
      });

    if (lista.length === 0) {
      return "";
    }

    // Ordena por chave (como proxy de tempo)
    lista.sort(function (a, b) {
      if (a.chave < b.chave) return -1;
      if (a.chave > b.chave) return 1;
      return 0;
    });

    const total = lista.reduce(function (acc, f) {
      return acc + f.valor;
    }, 0);

    const media = total / lista.length;

    // maior e menor fatura
    var maior = lista[0];
    var menor = lista[0];

    for (var i = 1; i < lista.length; i++) {
      if (lista[i].valor > maior.valor) maior = lista[i];
      if (lista[i].valor < menor.valor) menor = lista[i];
    }

    // variação da última em relação à anterior, se houver pelo menos 2
    var variacaoTexto = "";
    if (lista.length >= 2) {
      const penultima = lista[lista.length - 2];
      const ultima = lista[lista.length - 1];

      if (penultima.valor > 0) {
        const dif = ultima.valor - penultima.valor;
        const perc = (dif / penultima.valor) * 100;

        if (Math.abs(perc) >= 3) { // ignora variação muito pequena
          const direcao = perc > 0 ? "aumento" : "queda";
          variacaoTexto =
            "A fatura mais recente (" +
            ultima.rotulo +
            ") teve um " +
            direcao +
            " de aproximadamente " +
            perc.toFixed(1).replace(".", ",") +
            "% em relação à anterior (" +
            penultima.rotulo +
            ").";
        } else {
          variacaoTexto =
            "A fatura mais recente (" +
            ultima.rotulo +
            ") ficou em linha com a anterior (" +
            penultima.rotulo +
            "), sem variação relevante de valor.";
        }
      }
    }

    // texto de resumo
    var html =
      "<div class='mt-3 p-3 rounded-lg border border-slate-200 bg-slate-50 text-xs text-slate-700'>" +
      "<p class='font-semibold mb-1'>Observações automáticas sobre essas faturas:</p>" +
      "<ul class='list-disc ml-4 space-y-1'>" +
      "<li>Foram consideradas <b>" + lista.length + "</b> faturas, com valor médio de aproximadamente <b>R$ " +
      media.toFixed(2).replace(".", ",") +
      "</b>.</li>" +
      "<li>A fatura de <b>" + maior.rotulo + "</b> foi a de <b>maior valor</b> no conjunto exibido.</li>" +
      "<li>A fatura de <b>" + menor.rotulo + "</b> foi a de <b>menor valor</b>.</li>";

    if (variacaoTexto) {
      html += "<li>" + variacaoTexto + "</li>";
    }

    html +=
      "</ul>" +
      "<p class='mt-2 text-[11px] text-slate-500'>" +
      "Essas observações são um resumo automático em cima das faturas mostradas na tabela, " +
      "para te ajudar a identificar rapidamente extremos e tendências.</p>" +
      "</div>";

    return html;
  } catch (e) {
    // se der qualquer problema, não quebra o chat; só não mostra insight
    console.error("Erro em analisarFaturas:", e);
    return "";
  }
}

// 🔎 Tenta extrair um array de linhas padrão (categoria/estabelecimento) do resultado do Apps Script
function vektorExtrairListaResumoChave(res) {
  if (!res) return [];

  // Se já vier um array direto
  if (Array.isArray(res)) return res;

  // Tenta achar propriedades comuns
  const possiveis = [
    "dados",
    "itens",
    "linhas",
    "registros",
    "categorias",
    "estabelecimentos",
    "lista"
  ];

  for (const nome of possiveis) {
    if (Array.isArray(res[nome])) {
      return res[nome];
    }
  }

  return [];
}

// 💡 Gera insights automáticos para categoria/estabelecimento (média por transação)
function gerarInsightsResumoChaveCategoriaEstab(res, opcoes) {
  try {
    const tipoChave = (opcoes && opcoes.tipoChave) || "";
    // Só faz sentido para Categoria ou Estabelecimento
    if (tipoChave !== "Categoria" && tipoChave !== "Estabelecimento") {
      return "";
    }

    const listaBruta = vektorExtrairListaResumoChave(res);
    if (!Array.isArray(listaBruta) || listaBruta.length < 2) {
      return "";
    }

    // Normaliza: tenta achar chave (nome), valor total e quantidade
    const itens = listaBruta
      .map(function (item, idx) {
        const nome =
          item.chave ||
          item.nome ||
          item.descricao ||
          item.descricaoChave ||
          item.categoria ||
          item.estabelecimento ||
          ("Item " + (idx + 1));

        const valorRaw =
          item.valorTotal ||
          item.totalValor ||
          item.valor_total ||
          item.valor ||
          item.total ||
          0;

        const qtdRaw =
          item.qtdTransacoes ||
          item.qtd_transacoes ||
          item.quantidade ||
          item.qtd ||
          item.numTransacoes ||
          0;

        const valor = Number(valorRaw) || 0;
        const qtd = Number(qtdRaw) || 0;

        // Se não tiver quantidade, não dá pra falar de "média por transação"
        if (valor <= 0 || qtd <= 0) {
          return null;
        }

        return {
          nome: String(nome),
          valor: valor,
          qtd: qtd,
          media: valor / qtd
        };
      })
      .filter(function (x) {
        return x !== null;
      });

    if (itens.length < 2) {
      return "";
    }

    // Acha maior e menor média
    let maior = itens[0];
    let menor = itens[0];

    for (let i = 1; i < itens.length; i++) {
      const it = itens[i];
      if (it.media > maior.media) maior = it;
      if (it.media < menor.media) menor = it;
    }

    const labelColecao =
      tipoChave === "Categoria" ? "categorias" : "estabelecimentos";
    const labelSingular =
      tipoChave === "Categoria" ? "categoria" : "estabelecimento";

    const mediaMaior = maior.media.toFixed(2).replace(".", ",");
    const mediaMenor = menor.media.toFixed(2).replace(".", ",");

    let html =
      "<div class='mt-3 p-3 rounded-lg border border-slate-200 bg-slate-50 text-xs text-slate-700'>" +
      "<p class='font-semibold mb-1'>Insights automáticos sobre os " + labelColecao + ":</p>" +
      "<ul class='list-disc ml-4 space-y-1'>" +
      "<li>O " + labelSingular + " <b>" + maior.nome + "</b> apresenta a <b>maior média de valor por transação</b> no período, em torno de <b>R$ " + mediaMaior + "</b>.</li>" +
      "<li>O " + labelSingular + " <b>" + menor.nome + "</b> apresenta a <b>menor média de valor por transação</b> no período, em torno de <b>R$ " + mediaMenor + "</b>.</li>" +
      "</ul>" +
      "<p class='mt-2 text-[11px] text-slate-500'>" +
      "Essa média é calculada dividindo o valor total gasto pela quantidade de transações de cada " + labelSingular +
      " no período consultado.</p>" +
      "</div>";

    return html;
  } catch (e) {
    console.error("Erro em gerarInsightsResumoChaveCategoriaEstab:", e);
    return "";
  }
}



    /* ========= GERADOR FINAL ========= */

function gerarRespostaDoBot(msgUsuario, vindoDaClarificacao = false) {
  const norm = normalize(msgUsuario || "");

  // 🔹 LOG GLOBAL: tudo que o usuário digita
  vektorRegistrarMetrica(
    "user_raw",           // intencao
    msgUsuario,           // mensagem original
    norm,                 // norm
    "entrada",            // resultado
    "RawMessageUsuario",  // tópico
    "gerarRespostaDoBot"  // função de origem
  );

  // 🔹 0.5: se a frase parece ser só uma resposta curta à clarificação,
  // reinterpreta UMA ÚNICA VEZ como uma pergunta completa que o motor já entende
  if (!vindoDaClarificacao) {
    const reescrita = tentarInterpretarRespostaClarificacao(norm);
    if (reescrita) {
      // chama de novo o gerador, marcando que já viemos da clarificação
      return gerarRespostaDoBot(reescrita, true);
    }
  }

    // 🔹 1ª camada: motor de intenções por regras
  const resultadoIntencao = aplicarRegraDeIntencao(msgUsuario);

  // Se alguma regra reconheceu a intenção e retornou algo, usamos isso.
  // Exemplos de retorno:
  // - "ACAO_LISTAR_ETIQUETAS_CLARA" (token para ação externa)
  // - "HTML:..." (resposta pronta)
  // - texto simples
  if (resultadoIntencao !== null && resultadoIntencao !== undefined) {
    return resultadoIntencao;
  }

  // 🔹 2ª camada: fallback para os gatilhos antigos baseados em includes
    // Gatilho: usuário quer entender a última tabela
  if (
          norm.includes("explica essa tabela") ||
          norm.includes("explica essa fatura") ||
          norm.includes("como voce calculou") ||
          norm.includes("como vc calculou") ||
          norm.includes("como foi calculado") ||
          norm.includes("como foi gerado") ||
          norm.includes("de onde veio essa tabela")
  ) {
    vektorExplicarUltimaTabela();
    return null; // mantém padrão: função já renderiza no chat
  }

  // Treinamento Clara - apresentação em Slides
if (
  norm.includes("treinamento clara") ||
  norm.includes("treinamento do cartao clara") ||
  norm.includes("treinamento do cartão clara") ||
  norm.includes("treinamento sobre uso do cartao") ||
  norm.includes("treinamento sobre uso do cartão")
) {
  const htmlTreinamento = `HTML:
<div class="text-sm text-slate-700">

  <h2 style="font-size: 1.1rem; font-weight: 700; text-align: center; margin-top: -8px; margin-bottom: 8px;">
    Treinamento oficial sobre o uso do cartão Clara
  </h2>

  <p class="mb-2" style="text-align:center; margin-top: -4px;">
    Use esta apresentação para reforçar boas práticas com o time da loja:

  <div style="position:relative;padding-bottom:62%;height:0;overflow:hidden;max-width:100%;
              border-radius:8px;border:1px solid #ddd;">
    <iframe
      src="https://docs.google.com/presentation/d/e/2PACX-1vRTlL30pbq4rkyBlo0cLHgE3Tqeg_bLaWlIBY20tSzEdIS5QlIuWRjIv4A1j_Lfnb9_gaZ6woWJ7SDh/pubembed?start=false&loop=false&delayms=3000"
      frameborder="0"
      style="position:absolute;top:0;left:0;width:100%;height:100%;"
      allowfullscreen="true"
      mozallowfullscreen="true"
      webkitallowfullscreen="true">
    </iframe>
  </div>

  <p class="mt-2 text-xs text-slate-500" style="text-align:center;">
    Se preferir, abra em tela cheia pelo botão disponível na apresentação.
  </p>

</div>`;

  return htmlTreinamento;
}

// ======================================================================
// RELATÓRIO GERENCIAL – incorpora Looker e manda link em mensagem separada
// ======================================================================
if (
  norm.includes("abrir relatorio gerencial") ||
  norm.includes("abrir relatório gerencial") ||
  norm.includes("relatorio gerencial da clara") ||
  norm.includes("relatório gerencial da clara") ||
  norm.includes("relatorio gerencial") ||
  norm.includes("relatório gerencial")
) {
  // 1) Envia o relatório incorporado (iframe)
  renderBotMessage("HTML:" + htmlRelatorioGerencial);

  return;
}

    // Uso responsável do limite do cartão Clara
  if (
    norm.includes("usar bem o limite") ||
    (norm.includes("limite") && norm.includes("usar")) ||
    norm.includes("uso do limite do cartao") ||
    norm.includes("uso do limite do cartão")
  ) {
    return "HTML:<div class='text-sm text-slate-700'>"
      + "<p class='mb-2'>"
      + "O limite do cartão Clara foi definido para cobrir, com segurança, os gastos previstos do ciclo de fatura "
      + "(de <b>06</b> até <b>05</b> do mês seguinte). Para usar bem esse limite, sem precisar aumentar durante o mês, "
      + "considere estas práticas:"
      + "</p>"
      + "<ul class='list-disc ml-4 space-y-1'>"
      + "<li><b>Planeje o mês pelo ciclo da fatura:</b> some os gastos previstos entre os dias 06 e 05 e verifique se cabem no limite disponível.</li>"
      + "<li><b>Priorize despesas operacionais essenciais:</b> use o cartão principalmente para despesas previstas na política (ex.: material de escritório, manutenção, marketing autorizado, etc.).</li>"
      + "<li><b>Evite concentrar grandes compras no início do ciclo:</b> isso pode travar o limite e impedir compras importantes mais para o fim do mês.</li>"
      + "<li><b>Prefira compras à vista ou com poucos parcelamentos:</b> parcelamentos longos consomem o limite pelos próximos ciclos e reduzem a flexibilidade da loja.</li>"
      + "<li><b>Acompanhe o uso do limite ao longo do mês:</b> consulte o extrato da Clara e os relatórios do Vektor para ver quanto já foi utilizado e o que ainda está disponível.</li>"
      + "<li><b>Reserve uma margem para imprevistos:</b> evite usar 100% do limite com despesas previsíveis; mantenha uma folga para emergências dentro da política.</li>"
      + "<li><b>Evite compras fora da política:</b> gastos não permitidos podem ser bloqueados ou precisar de reembolso, além de consumir o limite de forma indevida.</li>"
      + "</ul>"
      + "<p class='mt-2'>"
      + "Se mesmo seguindo essas orientações o limite estiver sempre no máximo, vale revisar o planejamento de gastos da loja "
      + "e, se for o caso, discutir um ajuste de limite com o time responsável, com base em dados de uso recorrente."
      + "</p>"
      + "</div>";
  }

  // INTENÇÃO: listar etiquetas da Clara (BaseClara, coluna T)
  if (
    norm.includes("listagem de etiquetas") ||
    norm.includes("lista de etiquetas") ||
    norm.includes("etiquetas disponiveis") ||
    norm.includes("etiquetas disponíveis") ||
    norm.includes("etiquetas da clara") ||
    norm.includes("etiquetas na clara")
  ) {
    return "ACAO_LISTAR_ETIQUETAS_CLARA";
  }

  // 🆕 Resposta específica para o ciclo da fatura da Clara
  if (
    norm.includes("ciclo da fatura") ||
    norm.includes("ciclo de fatura") ||
    norm.includes("ciclo da fatura da clara") ||
    norm.includes("periodo da fatura") ||
    norm.includes("período da fatura")
  ) {
    return "HTML:<p class='text-sm text-slate-700'>" +
      "O <b>ciclo da fatura da Clara</b> funciona assim:<br><br>" +
      "• As compras realizadas entre <b>o dia 6</b> de cada mês e <b>o dia 5</b> do mês seguinte são " +
      "agrupadas na mesma fatura.<br>" +
      "• Tudo o que for gasto dentro desse intervalo entra para pagamento nessa fatura do período.<br><br>" +
      "Em resumo: o ciclo vai sempre de <b>06</b> a <b>05</b>, e todas as compras feitas nesse período " +
      "entram juntas na mesma fatura.</p>";
  }

  // === Gatilho para o MINI MANUAL DA CLARA ===
  if (
    norm.includes("manual clara") ||
    norm.includes("manual da clara") ||
    (norm.includes("manual") && norm.includes("clara")) ||
    norm.includes("treinamento clara") ||
    norm.includes("treinamento do cartao clara") ||
    norm.includes("treinamento do cartão clara")
  ) {

    
    const htmlPartes = [];

    htmlPartes.push(
      "<div class='text-sm text-slate-700'>" +
        "<p><b>Posso te ajudar a tirar dúvidas sobre o uso do cartão da Clara.</b> Escolha um dos tópicos abaixo 👇</p>" +
        "<div class='mt-3 flex flex-col gap-2'>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('primeiro_acesso')\">" +
        "01 Primeiro acesso" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('recebi_cartao')\">" +
        "02 Recebi o cartão, e agora?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('esqueci_senha')\">" +
        "03 Esqueci a senha do cartão" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('qual_meu_acesso')\">" +
        "04 Qual o meu acesso?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('anexar_comprovante')\">" +
        "05 Como anexar comprovante?" +
      "</button>"
    );

    htmlPartes.push(
      "<button type='button' " +
        "class='w-full text-left px-3 py-2 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-sm' " +
        "onclick=\"vektorManualClaraSecao('duvidas')\">" +
        "06 Dúvidas" +
      "</button>"
    );

    htmlPartes.push("</div></div>");

    const htmlFinal = htmlPartes.join("");
    return "HTML:" + htmlFinal;
  }

  // 🆕 TODAS AS LOJAS DO TIME XXXXX
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasDoTime = detectarListarTodasLojasDoTime(msgUsuario, norm);
  
  if (detTodasLojasDoTime) {
    const grupo = detTodasLojasDoTime.grupo;
    const p = detTodasLojasDoTime.periodo;
    const tipo = detTodasLojasDoTime.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // 🆕 guarda período e grupo para os botões de pendência/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Montando a <b>relação de todas as lojas do time " + grupo + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transações</b>" +
        (p ? " no período solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todas as lojas do time
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: true,   // já faz tabela de lojas por time
          groupName: grupo
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
          "Tive um problema ao consultar os dados para listar as lojas do time " + grupo + ".</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        grupo,          // time solicitado
        dataInicioStr,
        dataFimStr,
        tipo
      );

      // 🆕 guarda período e grupo para os botões de pendência/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    return null;
  }
}

  // 🆕 LOJAS / LOJA COM MAIS PENDÊNCIAS (por time)
  if (
    (norm.includes("loja com mais pendenc") ||
     norm.includes("lojas com mais pendenc"))
  ) {
    // Período (reaproveita o mesmo engine)
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // Tenta extrair o time da própria frase
    const grupo = extrairGrupo(msgUsuario, norm);

    if (!grupo) {
      return "HTML:<p class='text-sm text-slate-700'>" +
        "Para eu listar as <b>lojas com mais pendências</b>, preciso saber de <b>qual time</b>." +
        "<br>Exemplo de pergunta completa: " +
        "<i>Lojas com mais pendências do time XYZ neste mês / na última semana, nessa semana etc</i>." +
        "</p>";
    }

    vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso);
    return null;
  }

    // TODAS AS PENDÊNCIAS DO TIME XXXXX  → consolidação por loja daquele time
  
    if (
  (
    norm.includes("todas as pendenc") && norm.includes("do time")
  ) ||
  (
    norm.includes("pendenc") && norm.includes("do time")
  )
) {
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    const grupo = extrairGrupo(msgUsuario, norm);

    if (!grupo) {
      return "HTML:<p class='text-sm text-slate-700'>" +
        "Para listar <b>todas as pendências de um time</b>, preciso que você informe o nome completo do time na frase." +
        "<br>Exemplo: <i>Todas as pendências do time Lobos SP neste mês</i>." +
        "</p>";
    }

    vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso);
    return null;
  }

  // TODAS AS PENDÊNCIAS POR TIME  → consolidação por time (todas as equipes)
  if (
    (norm.includes("todas as pendenc") && norm.includes("por time")) ||
    norm.includes("time com mais pendenc")
  ) {
    const p = extrairIntervaloDatas(msgUsuario);
    const dataInicioIso = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimIso    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    vektorMostrarPendenciasPorTimeTodos(dataInicioIso, dataFimIso);
    return null;
  }

  // Gatilho pendências (quando não há fluxo pendências em aberto)

    if (estadoPendencias === "nenhum" &&
    termosPendencias.some(t => norm.includes(t))) {

    // tenta extrair número de loja já presente na mensagem (2 a 6 dígitos)
    const matchLoja = msgUsuario.match(/\b(\d{2,6})\b/);

    if (matchLoja) {
        const lojaBruta = matchLoja[1];
        const lojaNormalizada = lojaBruta.replace(/\D/g, "");

        lojaPendenciasAtual = lojaNormalizada;
        ultimaPendenciaResumo = null;
        estadoPendencias = "aguardando_confirmacao_email";

        // 🆕 busca nome da loja antes de responder
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pendências Clara da loja <b>${lojaNormalizada}${nomeLojaTxt}</b> e já te mostro aqui no chat. ⏳
              </p>`
            );

            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .withFailureHandler((err) => {
            // fallback se der erro no BigQuery
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pendências Clara da loja <b>${lojaNormalizada}</b> e já te mostro aqui no chat. ⏳
              </p>`
            );
            consultarPendenciasNoServidor(lojaNormalizada);
          })
          .obterNomeLojaBigQuery(lojaNormalizada);

        return null; // não retorna outro texto (renderBotMessage já enviou)
    }

    // caso não tenha número na frase, segue fluxo normal pedindo a loja
    estadoPendencias = "aguardando_loja";
    lojaPendenciasAtual = "";
    ultimaPendenciaResumo = null;

    return `HTML:<p class="text-sm text-slate-700">
    Consigo consultar as pendências de justificativas Clara da sua loja. Me informe o código da loja (somente números), por exemplo: <b>0123</b>.
    </p>`;
}

// ===== NOVA AÇÃO: Maiores transações individuais (loja / time) =====
var detTopTrans = detectarMaioresTransacoesIndividuais(msgUsuario, norm);
if (detTopTrans) {
  var grupo = detTopTrans.grupo || "";
  var loja  = detTopTrans.loja  || "";
  var periodo = detTopTrans.periodo || null;
  var topN = detTopTrans.topN;

  if (!topN || topN <= 0) {
    topN = 10; // default se o usuário não falar Top
  }

  var dataInicioIso = "";
  var dataFimIso = "";

  if (periodo && periodo.dataInicio && periodo.dataFim) {
    try {
      dataInicioIso = periodo.dataInicio.toISOString();
      dataFimIso    = periodo.dataFim.toISOString();
    } catch (e) {
      console.warn("Não consegui converter período para ISO em maiores transações:", e);
    }
  }

  // feedback rápido no chat
  var textoLoading = "Vou buscar as <b>maiores transações individuais</b> ";
  if (loja)  textoLoading += "da loja <b>" + loja + "</b> ";
  if (grupo) textoLoading += "do time <b>" + grupo + "</b> ";
  if (periodo) {
    textoLoading += "no período informado...";
  } else {
    textoLoading += "nos últimos 30 dias...";
  }

  renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + textoLoading + "</p>");

  try {
    google.script.run
      .withSuccessHandler(function (res) {
        renderMaioresTransacoesIndividuais(res);
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script maiores transações:", err);
        renderBotMessage("Não consegui consultar as maiores transações individuais agora.");
      })
      .getMaioresTransacoesIndividuais(
        grupo,
        loja,
        dataInicioIso,
        dataFimIso,
        topN
      );
  } catch (e) {
    console.error("Falha geral ao chamar getMaioresTransacoesIndividuais:", e);
    renderBotMessage("Ocorreu um erro ao buscar as maiores transações individuais.");
  }

  // registra intenção para métricas
  try { ultimaIntencao = "maiores_transacoes_individuais"; } catch (e) {}

  return; // importante para não cair no fluxo genérico
}

  // 🆕 TIMES ESPECÍFICOS (ex.: "times Águias do Cerrado e Lobos SP no período ...")

  const detTimesEspec = detectarTimesEspecificosLista(msgUsuario, norm);
  if (detTimesEspec && detTimesEspec.times && detTimesEspec.times.length > 1) {
    const listaTimes = detTimesEspec.times;
    const p          = detTimesEspec.periodo;
    const tipo       = detTimesEspec.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // 🆕 Guarda período em formato ISO para os insights (times/lojas)
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou comparar apenas os times <b>" + listaTimes.join(", ") + "</b> " +
        "por " + (tipo === "valor" ? "<b>valor total</b>" : "<b>quantidade de transações</b>") +
        (p ? " no período solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesPorTime(res, {
          topN: null,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Não consegui consultar os dados para esses times.</p>"
        );
      })
      .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

    return null;
  }


// >>> RANKING DE TIMES (top N)
const detRankTimes = detectarRankingTimes(msgUsuario, norm);
if (detRankTimes) {
  const p    = detRankTimes.periodo;
  const tipo = detRankTimes.tipo || "valor";      // "valor" ou "quantidade"
  const topN = detRankTimes.topN ?? 10;           // padrão: 10
  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

   // 🆕 Guarda período em ISO para os insights de maior transação
  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioStr || "",
    fim:    dataFimStr    || ""
  };

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de times</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transações</b>") +
    (p ? " no período solicitado" : "") + "…</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesPorTime(res, { topN: topN });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // igual ao seu bloco de "detTimes", encerra aqui
}


function detectarConsultasTimes(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);

  // plural por quantidade (listar TODOS)
  if (t.includes("times com maior numero de transacoes") || t.includes("times com mais transacoes") ||
      t.includes("times com mais transacao") || t.includes("times com maior quantidade de transacoes")) {
    return { periodo, tipo: "quantidade", topN: null, modo: "plural" };
  }

  // plural por valor (listar TODOS)
  if (t.includes("quais times mais gastaram") || t.includes("times com maior valor de transacoes") ||
      t.includes("times que mais gastaram")) {
    return { periodo, tipo: "valor", topN: null, modo: "plural" };
  }

  // singular -> top 1 por valor
  if (t.includes("qual time mais gastou") || t.includes("time com maior valor de transacoes")) {
    return { periodo, tipo: "valor", topN: 1, modo: "singular" };
  }

  return null;
}

// =========== DETECTOR: "TIMES X E Y NO PERÍODO" =========== //

function detectarTimesEspecificosLista(msgOriginal, norm) {
  const t = norm || "";

  // se falar de LOJA(S), essa função NÃO deve tratar
  if (!t.includes("time") || t.includes("loja") || t.includes("lojas")) {
    return null;
  }

  const lista = (typeof encontrarListaTimesNaMensagem === "function"
    ? (encontrarListaTimesNaMensagem(msgOriginal) || [])
    : []);

  if (!lista.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: lista,
    periodo,
    tipo
  };
}

if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detRankLoja = detectarRankingLojas(msgUsuario, norm);
if (detRankLoja) {
  const periodo = detRankLoja.periodo;
  const tipo    = detRankLoja.tipo || "valor";
  const grupo   = detRankLoja.grupo || "";
  const topNReq = detRankLoja.topN; // pode ser null

  // 📌 Regra de TOP:
  // - Se o usuário falar "top X" → usa X
  // - Se NÃO falar top e NÃO tiver time → padrão = 10
  // - Se NÃO falar top e TIVER time → deixa null pra listar todas as lojas do time
  const topNFinal = (topNReq != null)
    ? topNReq
    : (grupo ? null : 10);

  // Aviso: ranking geral de lojas (sem time) e sem "top" informado => mostraremos 10
  if (!grupo && topNReq == null) {
    renderBotMessage(
      "HTML:<p class='text-xs text-slate-600 italic'>Obs.: Como o número de lojas é grande, mostrarei as <b>10 primeiras</b> por padrão. Você pode pedir, por exemplo, <b>top 20 lojas</b>.</p>"
    );
  }

  vektorRegistrarContexto({
  ultimaIntencao: "ranking_lojas",
  ultimoPeriodo: periodo || null,
  ultimoGrupo: grupo || null,
  ultimaLoja: null,
  ultimaAcaoExplicavel: {
    tipo: "tabela_ranking_lojas",
    meta: {
      criterio: criterio,
      grupo: grupo || null,
      topN: topNFinal || null
    }
  }
});

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>ranking de lojas</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transações</b>") +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    (periodo ? " no período solicitado" : "") + "…</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // 🆕 guarda período e grupo para os botões de pendência/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, {
        topN: topNFinal,        // respeita TOP pedido (ou 10 / null)
        forGroup: !!grupo       // true se estiver filtrando por time
      });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// 2) LOJAS (plural) sem top/ranking  -> lista TODAS do time
if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
const detLojasPlural = detectarLojasMaisTransacoesPlural(msgUsuario, norm);
if (detLojasPlural) {
  const periodo = detLojasPlural.periodo;
  const tipo    = detLojasPlural.tipo || "valor";
  const grupo   = detLojasPlural.grupo || ""; // se vier time, listaremos TODAS as lojas do time
  const topN    = null; // força 'todas'

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou listar <b>todas as lojas</b> " +
    (grupo ? "do time <b>" + grupo + "</b> " : "") +
    "ordenadas por " + (tipo === "valor" ? "<b>valor</b>" : "<b>transações</b>") +
    (periodo ? " no período solicitado" : "") + "…</p>"
  );

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  // 🆕 guarda período e grupo para os botões de pendência/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
  const n = (topN == null && !grupo) ? 10 : topN; // 10 só no geral; por time você decide
  renderResumoTransacoesSemana(res, { topN: n, forGroup: true });
})
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (loja por time).</p>");
    })
    .getResumoTransacoesPorGrupo(grupo, dataInicioStr, dataFimStr, tipo);

  return null;
}}

// === NOVO: CONSULTAS POR CATEGORIA (BaseClara) ===
const detCategorias = detectarPerguntaCategorias(msgUsuario, norm);
if (detCategorias) {

  // ✅ Período padrão quando usuário não informar
  // Sugestão: últimos 30 dias (consistente com "informações iniciais")
  let periodo = detCategorias.periodo;
  if (!periodo || !periodo.dataInicio || !periodo.dataFim) {
    const fim = new Date();
    const ini = new Date();
    ini.setDate(fim.getDate() - 30);
    periodo = { dataInicio: ini, dataFim: fim };
  }

  const tipo = detCategorias.tipo || "valor";
  const topN = detCategorias.topN;

  const dataInicioStr = periodo.dataInicio.toISOString();
  const dataFimStr    = periodo.dataFim.toISOString();

  // (opcional, mas recomendado) salva o período como “último período”
  // para drilldowns e para renderResumoPorChaveGenerico conseguir usar fallback também
  window.__vektorUltimoPeriodo = { dataInicio: periodo.dataInicio, dataFim: periodo.dataFim };

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por categoria</b> " +
    (tipo === "valor" ? "considerando <b>valor</b>" : "por <b>quantidade de transações</b>") +
    (periodo ? " no período solicitado" : " em toda a base") +
    "…</p>"
  );

  google.script.run
        .withSuccessHandler(function (res) {
      // 1) Monta a tabela normal (como já fazia)
      renderResumoPorChaveGenerico(res, {
        tipoChave: "Categoria",
        titulo: (tipo === "valor"
          ? "Categorias com maior valor de transações"
          : "Categorias com maior quantidade de transações"),
        topN: topN
      });

      // 2) Se estiver olhando para VALOR, gera insight de média por transação
      if (tipo === "valor") {
        const htmlInsights = gerarInsightsResumoChaveCategoriaEstab(res, {
          tipoChave: "Categoria"
        });
        if (htmlInsights) {
          renderBotMessage("HTML:" + htmlInsights);
        }
      }
    })

    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por categoria.</p>");
    })
    .getResumoTransacoesPorCategoria(
      dataInicioStr,
      dataFimStr,
      tipo
    );

  return null;
}

// === NOVO: CONSULTAS POR ESTABELECIMENTO / LOCAL (BaseClara) ===
const detEstab = detectarPerguntaEstabelecimentos(msgUsuario, norm);
if (detEstab) {
  const periodo = detEstab.periodo;
  const tipo    = detEstab.tipo || "valor";
  const topN    = detEstab.topN;
  const grupo   = detEstab.grupo || "";
  const loja    = detEstab.loja  || "";

  const dataInicioStr = (periodo && periodo.dataInicio) ? periodo.dataInicio.toISOString() : "";
  const dataFimStr    = (periodo && periodo.dataFim)    ? periodo.dataFim.toISOString()    : "";

  let contexto = "";
  if (grupo) contexto += " para o time <b>" + grupo + "</b>";
  if (loja)  contexto += (contexto ? " e " : " para ") + "a loja <b>" + loja + "</b>";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Montando <b>resumo por estabelecimento</b>" +
    contexto +
    (tipo === "valor" ? " com foco em <b>valor</b>" : " por <b>quantidade de transações</b>") +
    (periodo ? " no período solicitado" : " em toda a base") +
    "…</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // Monta o título com destaque e indicação de Top N
      const tituloBase = (tipo === "valor"
        ? "<b>Locais com maior valor de gastos</b> - Top 10"
        : "<b>Locais com maior quantidade de transações</b>");

      const sufixoTop = (typeof topN === "number" && topN > 0)
        ? (" - Top " + topN)
        : "";

      renderResumoPorChaveGenerico(res, {
        tipoChave: "Estabelecimento",
        titulo: tituloBase + sufixoTop,
        topN: topN
      });

      // 2) Se estiver olhando para VALOR, gera insight de média por transação
      if (tipo === "valor") {
        const htmlInsights = gerarInsightsResumoChaveCategoriaEstab(res, {
          tipoChave: "Estabelecimento"
        });
        if (htmlInsights) {
          renderBotMessage("HTML:" + htmlInsights);
        }
      }
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados por estabelecimento.</p>");
    })
    .getResumoTransacoesPorEstabelecimento(
      dataInicioStr,
      dataFimStr,
      tipo,
      grupo,
      loja
    );

  return null;
}

// >>> TIME CAMPEÃO (singular): "qual time gastou mais ...", "time com mais transações ..."
const detTimeCampeao = detectarPerguntaTimeMaisTransacoes(msgUsuario, norm);
if (detTimeCampeao) {
  const p    = detTimeCampeao.periodo;
  const tipo = detTimeCampeao.tipo || "valor"; // "valor" ou "quantidade"

  const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
  const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Buscando o <b>time campeão</b> por " +
    (tipo === "valor" ? "<b>valor</b>" : "<b>transações</b>") +
    (p ? " no período solicitado" : "") + "…</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      // singular → sempre Top 1
      renderResumoTransacoesPorTime(res, { topN: 1 });
    })
    .withFailureHandler(function () {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (times).</p>");
    })
    .getResumoTransacoesPorTime(dataInicioStr, dataFimStr, tipo);

  return; // encerra aqui
}

  // 🆕 TODOS OS TIMES NO PERÍODO / RELAÇÃO DE TIMES
  const detTodosTimes = detectarTodosTimesPeriodo(msgUsuario, norm);
  if (detTodosTimes) {
    const p    = detTodosTimes.periodo;
    const tipo = detTodosTimes.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio)
      ? p.dataInicio.toISOString()
      : "";
    const dataFimStr = (p && p.dataFim)
      ? p.dataFim.toISOString()
      : "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todos os times</b> com gasto " +
        (tipo === "valor" ? "por <b>valor total</b>" : "por <b>número de transações</b>") +
        (p ? " no período solicitado" : "") +
        ". A tabela vai mostrar para cada time o <b>valor total</b> e a <b>quantidade</b> de transações." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Falha ao consultar os dados (todos os times).</p>"
        );
      })
      .getResumoTransacoesPorTime(
        dataInicioStr,
        dataFimStr,
        tipo
      );

    return null;
  }

    // >>> BLOCO: perguntas de FATURA (Extrato da conta / BaseClara)

  const detFatura = detectarPerguntaFaturaClara(msgUsuario, norm);
  if (detFatura) {

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou consultar o <b>valor das faturas</b> da Clara " +
        "de acordo com o período solicitado...</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.faturas) || !res.faturas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Não consegui encontrar " +
            "informações de fatura na BaseClara.</p>"
          );
          return;
        }

        var todas = res.faturas || [];

              // ================== INTERPRETAÇÃO LOCAL DA PERGUNTA ==================
        let perguntaBruta = (msgUsuario || "").toLowerCase();

        // remove acentos: "últimas" -> "ultimas", "mês" -> "mes"
        let perguntaNorm = perguntaBruta
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

        let modoLocal = "atual";   // padrão
        let qtdLocal  = null;      // quantidade de faturas quando for "ultimas N"

        const temPluralFaturas   = perguntaNorm.includes("faturas");
        const temExplicitoAtual  = perguntaNorm.includes("fatura atual") ||
                                   perguntaNorm.includes("deste mes") ||
                                   perguntaNorm.includes("desse mes");
        const temExplicitoAnterior = perguntaNorm.includes("anterior") ||
                                     perguntaNorm.includes("mes passado");
        const temExplicitoTodas  = perguntaNorm.includes("todas");
        const temExplicitoUltimas = perguntaNorm.includes("ultimas") ||
                                    perguntaNorm.includes("ultimos");

        // 1) TODAS AS FATURAS (frase explícita)
        if (temExplicitoTodas && temPluralFaturas) {
          modoLocal = "todas";
        }

        // 2) ÚLTIMAS N FATURAS (explicitamente com número)
        // exemplos:
        // "ultimas 6 faturas", "ultimas 3 faturas da clara",
        // "6 ultimas faturas", "3 ultimas faturas da clara"
        let m =
          perguntaNorm.match(/ultimas?\s+(\d{1,2})\s*faturas?/) ||
          perguntaNorm.match(/(\d{1,2})\s+ultimas?\s*faturas?/);

        if (m && m[1]) {
          modoLocal = "ultimas";
          qtdLocal  = parseInt(m[1], 10);
        }

        // 2.b) "ultimas faturas" sem número → usa um padrão (ex.: 6)
        if (!qtdLocal && temExplicitoUltimas && temPluralFaturas) {
          modoLocal = "ultimas";
          qtdLocal  = 6;
        }

        // 3) FATURA ANTERIOR
        if (temExplicitoAnterior) {
          modoLocal = "anterior";
          qtdLocal  = null;
        }

        // 4) FATURA ATUAL (reforço explícito)
        if (temExplicitoAtual) {
          modoLocal = "atual";
          qtdLocal  = null;
        }

        // 5) FALLBACK INTELIGENTE:
        // Se ainda está em "atual", mas o usuário falou em "faturas" (plural)
        // sem dizer "atual", "anterior", "todas" ou "ultimas",
        // vamos assumir que ele quer ver mais de uma: ex.: últimas 6.
        if (
          modoLocal === "atual" &&
          temPluralFaturas &&
          !temExplicitoAtual &&
          !temExplicitoAnterior &&
          !temExplicitoTodas &&
          !temExplicitoUltimas
        ) {
          modoLocal = "ultimas";
          qtdLocal  = 6; // aqui você define o padrão que quiser
        }

        // 6) Segurança extra: se por qualquer motivo o modoLocal estiver "atual"
        //    mas temos qtdLocal > 1, tratamos como "ultimas".
        if (modoLocal === "atual" && typeof qtdLocal === "number" && qtdLocal > 1) {
          modoLocal = "ultimas";
        }

        // ================== APLICA O FILTRO ==================
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          modoLocal,
          qtdLocal
        );

        // ================== APLICA O FILTRO ==================
        var selecionadas = vektorFiltrarFaturasPeloModo_(
          todas,
          modoLocal,
          qtdLocal
        );

        // DEBUG pra gente ver exatamente o que está acontecendo
        console.log("perguntaNorm =", perguntaNorm);
        console.log("modoLocal =", modoLocal, "qtdLocal =", qtdLocal);
        console.log("total faturas retornadas =", todas.length);
        console.log("selecionadas pelo filtro =", selecionadas.length);

        if (!selecionadas.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Não encontrei faturas para " +
            "o critério informado.</p>"
          );
          return;
        }

        // ================== MONTA TÍTULO ==================
        var titulo = "RESUMO DE FATURAS CLARA";

        if (modoLocal === "atual") {
          titulo = "VALOR DA FATURA ATUAL";
        } else if (modoLocal === "anterior") {
          titulo = "VALOR DA FATURA DO MÊS PASSADO";
        } else if (modoLocal === "ultimas") {
          var n = qtdLocal || 2;
          var usado = Math.min(n, selecionadas.length);
          titulo = "VALOR DAS ÚLTIMAS " + usado + " FATURAS";
        } else if (modoLocal === "todas") {
          titulo = "VALOR DE TODAS AS FATURAS";
        }

        var html = vektorMontarTabelaFaturas_(titulo, selecionadas);
        renderBotMessage("HTML:" + html);

        // 🧠 Engine de insights automáticos em cima das faturas exibidas
        var htmlInsights = analisarFaturas(selecionadas);
        if (htmlInsights && typeof htmlInsights === "string") {
          renderBotMessage("HTML:" + htmlInsights);
        }

        // 🆕 Se for fatura ATUAL, envia lembrete de fechamento e pagamento
        if (modoLocal === "atual") {
          const diasFechamento = vektorDiasAteFechamentoFaturaAtual();

          let msgFechamento;
          if (diasFechamento === 0) {
            msgFechamento =
              "Hoje é o <b>dia de fechamento</b> da fatura atual. " +
              "O pagamento da fatura é programado sempre para o dia <b>12</b> de cada mês.";
          } else if (diasFechamento === 1) {
            msgFechamento =
              "Falta <b>1 dia</b> para o fechamento da fatura atual. " +
              "O pagamento da fatura é programado sempre para o dia <b>12</b> de cada mês.";
          } else {
            msgFechamento =
              "Faltam <b>" + diasFechamento + " dias</b> para o fechamento da fatura atual. " +
              "O pagamento da fatura é programado sempre para o dia <b>12</b> de cada mês.";
          }

          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700 mt-2'>" +
              msgFechamento +
            "</p>"
          );

          // ✅ NOVO: insights de pendências do ciclo atual (início do ciclo -> agora)
google.script.run
  .withSuccessHandler(function(resP) {
    try {
      if (!resP || !resP.ok) {
        // se não tiver dados, não quebra o fluxo da fatura
        return;
      }

      const t = resP.totais || {};
      const periodo = resP.periodo || {};
      const top = Array.isArray(resP.topLojas) ? resP.topLojas : [];

      const lojasInfo = resP.lojas || {};
      const totalLojas = Number(lojasInfo.total) || 0;
      const lojasPend = Number(lojasInfo.comPendencia) || 0;

      const pctLojas = totalLojas
  ? (100 * lojasPend / totalLojas).toFixed(1).replace(".", ",") + "%"
  : "0%";

      const pct = (n, d) => {
        const nn = Number(n) || 0;
        const dd = Number(d) || 0;
        if (!dd) return "0%";
        return (100 * nn / dd).toFixed(1).replace(".", ",") + "%";
      };

      // totalPendTrans = total de transações com pelo menos 1 pendência
      const base = Number(t.totalPendTrans) || 0;

      // Atenção: uma transação pode contar em mais de 1 tipo
      const pEtiq = pct(t.pendEtiqueta, base);
      const pDesc = pct(t.pendDescricao, base);
      const pRec  = pct(t.pendRecibo, base);

      let textoTop = "";
      if (top.length) {
        textoTop = "<ul class='list-disc ml-5 mt-1 space-y-1'>";
        top.slice(0,3).forEach(function(x){
          const loja = x.loja || "—";
          const time = x.time || "—";
          const qtd  = Number(x.totalPendencias || 0).toLocaleString("pt-BR");
          const val  = Number(x.valorPendente || 0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
          textoTop += "<li><b>Loja " + loja + "</b> (" + time + "): <b>" + qtd + "</b> pendências, <b>" + val + "</b> pendente</li>";
        });
        textoTop += "</ul>";
      }

      const iniTxt = periodo.inicio || "";
      const fimTxt = periodo.fim || "";

      const html =
      "HTML:<div class='text-sm text-slate-700 mt-2'>" +
        "<p><b>Leitura rápida das pendências no ciclo atual</b> (" + iniTxt + " → " + fimTxt + "):</p>" +
        "<p class='mt-1'>Até agora, encontrei <b>" + base.toLocaleString("pt-BR") + "</b> transações com algum tipo de pendência. " +
        "Esses casos estão distribuídos em <b>" + lojasPend + "</b> lojas, " +
        "o que representa <b>" + pctLojas + "</b> de todas as lojas ativas no ciclo atual.</p><br>" +

        "<p>Quando eu separo por natureza do problema:</p>" +
        "<ul class='list-disc ml-5 mt-1 space-y-1'>" +
          "<li><b>Nota fiscal/Recibo</b>: " + Number(t.pendRecibo||0).toLocaleString("pt-BR") + " (" + pRec + ")</li>" +
          "<li><b>Etiqueta</b>: " + Number(t.pendEtiqueta||0).toLocaleString("pt-BR") + " (" + pEtiq + ")</li>" +
          "<li><b>Descrição</b>: " + Number(t.pendDescricao||0).toLocaleString("pt-BR") + " (" + pDesc + ")</li>" +
        "</ul>" +

        "<p class='mt-2 text-xs text-slate-500'>Obs.: uma mesma transação pode aparecer em mais de um tipo (ex.: sem etiqueta e sem descrição).</p>" +

        (textoTop
          ? ("<p class='mt-2'><b>Top 3 lojas ofensoras no ciclo:</b></p>" + textoTop)
          : ""
        ) +

        // 🔽 NOVO: botões de download e email
        "<div style='margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;'>" +

          "<button type='button' " +
            "onclick='window.vektorBaixarLojasComPendenciasCicloAtual(event)' " +
            "style='background:#0F172A;color:#fff;border:none;padding:8px 12px;" +
                  "border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
            "Baixar lojas com pendências" +
          "</button>" +

          "<button type='button' " +
            "onclick='window.vektorEnviarLojasComPendenciasCicloAtualEmail(event)' " +
            "style='background:#005E27;color:#fff;border:none;padding:8px 12px;" +
                  "border-radius:10px;font-size:12px;font-weight:900;cursor:pointer;'>" +
            "Enviar listagem por e-mail" +
          "</button>" +
        "</div>" +
              "</div>";

      renderBotMessage(html);

    } catch (e) {
      console.error("Falha ao montar insights pendências ciclo:", e);
    }
  })
  .withFailureHandler(function(err) {
    console.error("Falha ao consultar pendências ciclo:", err);
  })
  .getPendenciasResumoCicloAtual();  // Code.gs

        }

        let __vektorChartFaturas = null;
      })
      .withFailureHandler(function (err) {
  const msg = (err && err.message) ? err.message : String(err || "");
  // Se for permissão, mostra mensagem curta e correta
  if (msg.toLowerCase().includes("não disponível para o seu perfil")) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não disponível para o seu perfil.</p>"
    );
    return;
  }

  // Caso contrário, mostra o erro real (pra debug) ou uma mensagem mais útil
  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Erro ao consultar faturas: " +
    (msg ? msg : "erro desconhecido") +
    "</p>"
  );
})
      .getResumoFaturasClara();

    return;
  }

  // >>> NOVO BLOCO: perguntas de relatório (planilha Captura_Clara / BaseClara)

    const det = detectarPerguntaLojaMaisTransacoes(msgUsuario, norm);
    if (det) {
          const grupoNome = det.grupo || "";      // pode vir vazio (sem time)
          const periodo   = det.periodo;
          const tipo      = det.tipo || "quantidade"; // "quantidade" ou "valor"

  const grupoTxt = grupoNome
    ? ` do time <b>${grupoNome}</b>`
    : "";

  const criterioTxt = tipo === "valor"
    ? "maior <b>valor</b> de transações"
    : "maior <b>número</b> de transações";

  renderBotMessage(
    `HTML:<p class="text-sm text-slate-700">
      Beleza! Vou consultar qual loja tem ${criterioTxt}${grupoTxt}${
        periodo ? " no período solicitado" : ""
      } e já te trago um resumo. ⏳
    </p>`
  );

  // Converte datas (se existirem) para string ISO pra mandar pro Apps Script
  const dataInicioStr = (periodo && periodo.dataInicio)
    ? periodo.dataInicio.toISOString()
    : "";
  const dataFimStr = (periodo && periodo.dataFim)
    ? periodo.dataFim.toISOString()
    : "";

    // 🆕 guarda período e grupo para os botões de pendência/justificativa
window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
};
window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

  google.script.run
    .withSuccessHandler(function (res) {
      renderResumoTransacoesSemana(res, { topN: 1, forGroup: !!grupoNome });
    })
    .withFailureHandler(function () {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha. Tente novamente em alguns instantes.</p>"
      );
    })
    // 👇 agora também envia o tipo ("quantidade" ou "valor")
    .getResumoTransacoesPorGrupo(grupoNome, dataInicioStr, dataFimStr, tipo);

  // resposta vem assíncrona (via renderBotMessage no callback), então aqui não devolve nada
  return null;
}

  // 🆕 LOJAS ESPECÍFICAS (ex.: "lojas XXXX e XXXX no período ...")
  const detLojasEspec = detectarLojasEspecificasLista(msgUsuario, norm);
  if (detLojasEspec && detLojasEspec.codigosLojas.length > 0) {
    const p     = detLojasEspec.periodo;
    const tipo  = detLojasEspec.tipo || "valor";
    const lojas = detLojasEspec.codigosLojas;

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

    // 🆕 guarda período e grupo para os botões de pendência/justificativa
  window.__vektorUltimoPeriodoIso = {
  inicio: dataInicioStr || "",
  fim:    dataFimStr    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma tabela apenas com as <b>lojas " + lojas.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transações</b>" +
        (p ? " no período solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarLojasCodigos: lojas
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Não consegui consultar os dados para essas lojas específicas.</p>"
        );
      })
      // grupo vazio => todas as lojas; vamos filtrar no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }

  // 🆕 TODAS AS LOJAS NO PERÍODO (sem time)
  if (!norm.includes("pendencia") && !norm.includes("pendencias")) {
  const detTodasLojasPeriodo = detectarListarTodasLojasGeral(msgUsuario, norm);
  if (detTodasLojasPeriodo) {
    const periodo = detTodasLojasPeriodo.periodo;
    const tipo    = detTodasLojasPeriodo.tipo || "valor";

    const dataInicioStr = (periodo && periodo.dataInicio)
      ? periodo.dataInicio.toISOString()
      : "";
    const dataFimStr = (periodo && periodo.dataFim)
      ? periodo.dataFim.toISOString()
      : "";

      // 🆕 guarda período e grupo para os botões de pendência/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou montar uma <b>relação de todas as lojas</b> com gastos " +
        (periodo ? "no período solicitado" : "no período completo disponível") +
        ", mostrando <b>valor total</b> e <b>quantidade de transações</b>." +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        // topN: null => listar TODAS as lojas
        renderResumoTransacoesSemana(res, { topN: null, forGroup: false });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um problema ao consultar os dados da planilha para listar todas as lojas.</p>"
        );
      })
      .getResumoTransacoesPorGrupo(
        "",              // sem time (todas as lojas)
        dataInicioStr,
        dataFimStr,
        tipo             // "valor" (padrão) ou "quantidade"
      );

      // 🆕 guarda período e grupo para os botões de pendência/justificativa
      window.__vektorUltimoPeriodoIso = {
        inicio: dataInicioStr || "",
        fim:    dataFimStr    || ""
      };
      window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    // resposta vem via callback, então encerra aqui
    return null;
  }}

//🆕 TODAS AS LOJAS DE VÁRIOS TIMES
  const detLojasTimesMulti = detectarTodasLojasDosTimes(msgUsuario, norm);
  if (detLojasTimesMulti && detLojasTimesMulti.times.length > 0) {
    const listaTimes = detLojasTimesMulti.times;
    const p          = detLojasTimesMulti.periodo;
    const tipo       = detLojasTimesMulti.tipo || "valor";

    const dataInicioStr = (p && p.dataInicio) ? p.dataInicio.toISOString() : "";
    const dataFimStr    = (p && p.dataFim)    ? p.dataFim.toISOString()    : "";

        // 🆕 guarda período e grupo para os botões de pendência/justificativa
    window.__vektorUltimoPeriodoIso = {
      inicio: dataInicioStr || "",
      fim:    dataFimStr    || ""
    };
    window.__vektorUltimoGrupoBaseClara = grupoNome || grupo || "";

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou listar <b>todas as lojas</b> dos times <b>" + listaTimes.join(", ") + "</b>, " +
        "mostrando <b>valor total</b> e <b>quantidade de transações</b>" +
        (p ? " no período solicitado." : ".") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        renderResumoTransacoesSemana(res, {
          topN: null,
          forGroup: false,
          filtrarTimesNomes: listaTimes
        });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Não consegui consultar os dados das lojas desses times.</p>"
        );
      })
      // grupo vazio => todas as lojas; filtro por time será feito no front
      .getResumoTransacoesPorGrupo("", dataInicioStr, dataFimStr, tipo);

    return null;
  }



// <<< FIM DO BLOCO NOVO


        // 1) Termo de responsabilidade
        if (frasesTermo.some(f => norm.includes(f))) {
            // Mensagem principal (já existente)
            const msgPrincipal = respTermoResponsabilidade();

            // Segunda mensagem, separada, explicando que pode enviar pelo chat
            setTimeout(function () {
                try {
                    renderBotMessage(
                        "HTML:" +
                        "<div class='text-sm text-slate-700'>" +
                          "<p>" +
                            "Se você já tem o termo impresso e assinado, também pode me enviar diretamente por aqui. " +
                            "Basta anexar o documento assinado." +
                          "</p>" +
                        "</div>"
                    );
                } catch (e) {
                    console.warn('Erro ao enviar mensagem complementar do termo:', e);
                }
            }, 2000); // pequeno atraso só para aparecer como outra bolha

            // Retorna a mensagem padrão para ser exibida normalmente
            return msgPrincipal;
        }

        // 2) Saudações
        for (const saud of saudacoes) {
            if (norm === saud || norm.startsWith(saud + " ") || norm.includes(" " + saud + " ")) {
                const respostasSaudacao = [
                    "Olá! 😄",
                    "Oi! 👋",
                    "Opa, tudo bem por aí? 😎",
                    "Fala aí! 👋",
                    "E aí, tudo certo? 🙌",
                    "Bom te ver por aqui! 😁"
                ];
                const complementosAjuda = [
                    "Como posso te ajudar hoje?",
                    "Quer saber algo sobre o cartão Clara?",
                    "O que você quer saber?",
                    "Posso te explicar algo sobre o uso dos cartões?",
                    "Quer que eu te ajude com alguma dúvida?",
                    "Como posso te orientar?",
                    "Qual a sua dúvida?"
                ];
                const r1 = respostasSaudacao[Math.floor(Math.random() * respostasSaudacao.length)];
                const r2 = complementosAjuda[Math.floor(Math.random() * complementosAjuda.length)];
                return `HTML:<p class="text-sm text-slate-700">${r1} ${r2}</p>`;
            }
        }

        // 3) Encerramento / agradecimento
        for (const frase of frasesEncerramento) {
            if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
                const respostasEncerramento = [
                    "Que bom que consegui ajudar! 🤗 Pode me chamar sempre que precisar.",
                    "Show! Fico feliz em ajudar 😄",
                    "Perfeito 👌 qualquer dúvida, é só chamar de novo!",
                    "Valeu! Até a próxima 🚀",
                    "Beleza 😎 tô por aqui se precisar de novo.",
                    "Feito! Agora vou tirar um cochilo de 5 segundos. Me chama de novo, tá?", 
                    "Resolvido! Fui nessa, mas tô só a um clique de distância, viu?", 
                    "Show de bola! Se quebrar o meu sistema, não fui eu, foi a formatação anterior! 😉", 
                    "Acabou o recreio! Brincadeiras à parte, qualquer coisa, é só dar um 'tapa' no chat.", 
                    "Tudo pronto. Vou ali beber uma água e já volto. Se precisar, só assobiar!", 
                    "É isso! Missão dada é (finalmente) missão cumprida. Fui! 👋", 
                    "Perfeito! Agora vai lá dominar o mundo (ou só terminar seu café mesmo).", 
                    "Ufa! Deu tudo certo. Deixa um biscoito pra mim na próxima vez, valeu?", 
                    "Despedida de campeão! Se a dúvida voltar, é porque sentiu minha falta. Pode chamar!", 
                    "Zerou! Até o próximo 'bug' ou a próxima ideia genial. 🚀", 
                    "A gente se fala! Não faz besteira enquanto eu estiver fora, hein?", 
                    "OK, estou me desligando (só um pouquinho). Te vejo na próxima aventura!", 
                    "Quebrando a internet em 3, 2, 1... Brincadeira! Tchau, tchau!", 
                    "Terminamos com chave de ouro e um 'high five' virtual! ✋", 
                    "Resolvi essa parada! Agora, vai curtir a vida. Me chama se tiver tédio.", 
                    "Fechou o caixão! Quer dizer... fechou o chat. 😉 Até a próxima!", 
                    "Tá tranquilo, tá favorável. Qualquer deslize tecnológico, me avisa!", 
                    "Deu bom! Vou mandar um emoji de comemoração aqui: 🎉. Fui!", 
                    "Desaparecendo em 5 segundos. Se precisar de mágica, já sabe quem chamar.", 
                    "Essa foi rápida, hein? Valeu pela companhia. Tamo junto!", 
                    "Encerrando as atividades por hoje. Beijos de luz (e de código)! ✨", 
                    "Olha eu indo! Se sobrar um tempinho, manda um meme pra mim. Fui!", 
                    "Sou seu, mas não sou seu (só até você precisar de mim de novo). Tchau!", 
                    "Gostei da conversa. Se tiver mais perguntas loucas, sou todo ouvidos!", 
                    "Missão concluída. Agora, a próxima rodada é por sua conta! (Brincadeira!).", 
                    "Finalizamos! Mando um abraço de bytes e um até breve.", 
                    "Tudo nos conformes. Pode sair correndo e contar a novidade! 😉", 
                    "Pronto para a aposentadoria (de 5 minutos). Bora na próxima!", 
                    "E o Oscar de melhor encerramento vai para... mim! Tchau! 😂"
                ];
                const r = respostasEncerramento[Math.floor(Math.random() * respostasEncerramento.length)];
                return `HTML:<p class="text-sm text-slate-700">${r}</p>`;
            }
        }

        // 4) Política (PDF oficial)
        if (frasesPolitica.some(f => norm.includes(f))) 
        
        {
              // ✅ Primeiro: tenta responder RESUMO de categorias
  if (typeof tentarResponderResumoCategoriasPolitica === "function") {
    const resultadoResumo = tentarResponderResumoCategoriasPolitica(norm);
    if (resultadoResumo) {
      return vektorBlocoRaciocinioPolitica(
        resultadoResumo.mensagemUsuario,
        "",
        typeof POLITICA_CARTOES_CLARA_LINK !== "undefined"
          ? POLITICA_CARTOES_CLARA_LINK
          : ""
      );
    }
  }

  // ✅ Se não for sobre categorias, mantém a política oficial genérica
  return respPoliticaOficial();
        }


              // 5) Fluxo pendências - aguardando código da loja
        if (estadoPendencias === "aguardando_loja") {
    const textoOriginal = msgUsuario.trim();
    const soDigitos = textoOriginal.replace(/\D/g, "");

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // usuário mudou de assunto
    if (mudouDeAssunto && !soDigitos) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        origemPendenciasBloqueio = false;
        return `HTML:<div class="text-sm text-slate-700">
        <p>Beleza 👍 Vamos mudar de assunto então.</p>
        <p class="mt-1">Se quiser ver as pendências da loja depois, é só dizer: <b>"consultar pendências Clara"</b>.</p>
        </div>`;
    }

    // usuário digitou um código de loja
    if (soDigitos && soDigitos.length >= 2 && soDigitos.length <= 4) {
        lojaPendenciasAtual = soDigitos;

        // 🔹 CASO ESPECIAL: fluxo veio do bloqueio de cartão
        if (origemPendenciasBloqueio) {
            origemPendenciasBloqueio = false; // consumiu a flag

            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
                Beleza! Vou consultar as últimas pendências relacionadas ao cartão da loja <b>${soDigitos}</b>, que podem ter ocasionado o bloqueio. ⏳
                </p>`
            );

            consultarPendenciasBloqueio(soDigitos);
            return null;
        }

        // 🔹 CASO NORMAL: fluxo padrão de pendências Clara
        estadoPendencias = "nenhum";

        // 🆕 busca nome da loja no servidor antes de mostrar a mensagem
        google.script.run
          .withSuccessHandler((res) => {
            let nomeLojaTxt = "";
            if (res && res.ok && res.nome) {
              nomeLojaTxt = " - " + res.nome;
            }

            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pendências Clara da loja <b>${soDigitos}${nomeLojaTxt}</b> e já te mostro aqui no chat. ⏳
              </p>`
            );

            consultarPendenciasNoServidor(soDigitos);
          })
          .withFailureHandler((err) => {
            // fallback se der erro na consulta do nome
            renderBotMessage(
              `HTML:<p class="text-sm text-slate-700">
              Beleza! Vou consultar as pendências Clara da loja <b>${soDigitos}</b> e já te mostro aqui no chat. ⏳
              </p>`
            );
            consultarPendenciasNoServidor(soDigitos);
          })
          .obterNomeLojaBigQuery(soDigitos);

        return null;
    }

            // se chegou aqui, não mudou de assunto e não mandou código de loja válido
        // NÃO repetir frases infinitamente — apenas não responde e mantém o fluxo aguardando.
        return "";
}

        // 6) Fluxo pendências - aguardando confirmação de envio por e-mail
if (estadoPendencias === "aguardando_confirmacao_email") {
    const ehSim = (
        norm === "sim" ||
        norm.startsWith("sim ") ||
        norm.includes(" sim") ||
        norm.includes("pode enviar") ||
        norm.includes("pode mandar") ||
        norm.includes("manda") ||
        norm.includes("envia") ||
        norm.includes("pode sim")
    );

    const ehNao = (
        norm === "nao" || norm === "não" ||
        norm.startsWith("nao ") || norm.startsWith("não ") ||
        norm.includes("nao precisa") || norm.includes("não precisa") ||
        norm.includes("sem email") || norm.includes("sem e-mail") ||
        norm.includes("nao manda") || norm.includes("não manda")
    );

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // Usuário mudou de assunto no meio
    if (!ehSim && !ehNao && mudouDeAssunto) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<div class="text-sm text-slate-700">
<p>Tranquilo, vamos falar de outro assunto então. 😉</p>
<p class="mt-1">Se depois você quiser receber o resumo por e-mail, é só me pedir de novo.</p>
</div>`;
    }

    // Usuário disse que NÃO quer e-mail
    if (ehNao) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<p class="text-sm text-slate-700">
Fechado, não vou enviar por e-mail. Se quiser depois, é só pedir de novo. 👍
</p>`;
    }

    // Usuário disse que SIM quer e-mail
    if (ehSim) {
        const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
        const emailSessao = (USER_EMAIL_REPLACED || "").trim();

        if (!loja) {
            // Por segurança: se por algum motivo a loja sumiu da memória
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";
            return `HTML:<p class="text-sm text-slate-700">
Não tenho mais a loja em memória. Me peça de novo pra consultar as pendências, por favor.
</p>`;
        }

        // ✅ Se temos e-mail do usuário logado, já envia direto
        if (emailSessao) {
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";

            // avisa no chat
            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pendências da loja <b>${loja}</b> para <b>${emailSessao}</b>.
</p>`
            );

            // chama o Apps Script pra mandar o e-mail
            chamarEnvioPendenciasPorEmail(loja, emailSessao);

            // já usamos renderBotMessage, então aqui não precisa retornar outro texto
            return null;
        }

        // ❌ Se NÃO temos e-mail na sessão, volta para o fluxo antigo (pede e-mail)
        estadoPendencias = "aguardando_email";
        return `HTML:<p class="text-sm text-slate-700">
Perfeito! Me informa o seu e-mail corporativo (ex.: <b>nome.sobrenome@xxxxx.com.br</b>) para eu enviar o resumo.
</p>`;
    }

    // Se não entendeu nem sim nem não
    return `HTML:<p class="text-sm text-slate-700">
Só pra eu entender: você quer que eu envie por e-mail também?<br/>
Responda apenas <b>"sim"</b> ou <b>"não"</b>. 🙂
</p>`;
}

        // 7) Fluxo pendências - aguardando e-mail
        if (estadoPendencias === "aguardando_email") {
            const textoOriginal = msgUsuario.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailRegex.test(textoOriginal)) {
                const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
                if (!loja) {
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return `HTML:<p class="text-sm text-slate-700">
Não tenho mais a loja em memória. Me peça de novo pra consultar as pendências, por favor.
</p>`;
                }

                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pendências da loja <b>${loja}</b> para <b>${textoOriginal}</b>.
</p>`
                );
                chamarEnvioPendenciasPorEmail(loja, textoOriginal);
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return null;
            }

            const pareceOutroAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (pareceOutroAssunto) {
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return `HTML:<div class="text-sm text-slate-700">
<p>Beleza, vamos mudar de assunto então 😉</p>
<p class="mt-1">Se depois você quiser voltar a ver as pendências da loja ou receber por e-mail, é só me pedir de novo.</p>
</div>`;
            }

            return `HTML:<p class="text-sm text-slate-700">
Esse e-mail parece inválido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.<br/><br/>
Se preferir mudar de assunto, pode me perguntar outra coisa diretamente (ex.: "sangria", "novo cartão", "limite", "etiqueta", etc.).
</p>`;
        }

        // 8) Fluxo novo cartão – aguardando se é 1ª ou 2ª via
        if (fluxoNovoCartao === "aguardando_tipo_via") {
            const ehPrimeira = (
                norm.includes("primeira via") ||
                norm.includes("1 via") ||
                norm.includes("1a via") ||
                norm.includes("1ª via") ||
                norm.includes("primeiro cartao") ||
                norm.includes("primeiro cartão") ||
                norm.includes("cartao novo") ||
                norm.includes("cartão novo") ||
                norm.includes("meu primeiro cartao") ||
                norm.includes("meu primeiro cartão") ||
                norm.includes("nunca tive cartao") ||
                norm.includes("nunca tive cartão") ||
                norm.includes("nao tenho cartao") ||
                norm.includes("não tenho cartão")
            );

            const ehSegunda = (
                norm.includes("segunda via") ||
                norm.includes("2 via") ||
                norm.includes("2a via") ||
                norm.includes("2ª via") ||
                norm.includes("segundo cartao") ||
                norm.includes("segundo cartão") ||
                norm.includes("perdi o cartao") ||
                norm.includes("perdi meu cartao") ||
                norm.includes("perdi o cartão") ||
                norm.includes("roubaram meu cartao") ||
                norm.includes("roubaram meu cartão") ||
                norm.includes("roubo de cartão") ||
                norm.includes("perda de cartão") ||
                norm.includes("perca de cartão") ||
                norm.includes("cartao quebrado") ||
                norm.includes("cartão quebrado") ||
                norm.includes("cartao danificado") ||
                norm.includes("cartão danificado")
            );

            const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (!ehPrimeira && !ehSegunda && mudouDeAssunto) {
                fluxoNovoCartao = null;
                return `HTML:<p class="text-sm text-slate-700">
Sem problemas, vamos falar de outro assunto então. 😉
</p>`;
            }

            if (ehPrimeira) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_primeira";
                return respNovoCartaoPrimeiraVia();
            }

            if (ehSegunda) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_segunda";
                return respNovoCartaoSegundaVia();
            }

            return `HTML:<p class="text-sm text-slate-700">
            Não entendi se você está falando de <b>primeira via</b> (nunca teve cartão Clara) ou <b>segunda via</b> (cartão que já existia e precisa ser reemitido).<br/><br/>
            Me responde assim, por favor:<br/>
            • "É primeira via"<br/>
            • ou "É segunda via".
            </p>`;
        }


        // 10) Gatilhos direto – primeira via
        if (termosPrimeiraViaDireta.some(t => norm.includes(t))) {
            fluxoNovoCartao = null;
            return respNovoCartaoPrimeiraVia();
        }

        // 11) Gatilhos direto – segunda via
        if (gatilhosSegundaViaDireta.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = null;
            return respNovoCartaoSegundaVia();
        }

                // 12) Gatilho – quero pedir um cartão (abre fluxo pra perguntar primeira/segunda via)
        if (gatilhosNovoCartao.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = "aguardando_tipo_via";
            return `HTML:<p class="text-sm text-slate-700">
            Só pra eu te orientar certinho: você está falando de <b>primeira via</b> (nunca teve cartão Clara) ou <b>segunda via</b> (cartão que já existia e precisa ser reemitido)?<br/><br/>
            Responda por favor:<br/>
            • "É primeira via"<br/>
            • ou "É segunda via".
            </p>`;
        }

        // 13) Demais casos:
//    Se a frase não fala claramente de cartão/fatura/pendências,
//    em vez de chutar uma resposta de política, faz uma pergunta de clarificação.
const falaDeCartaoOuFatura =

  norm.includes("clara") ||
  norm.includes("cartao") ||
  norm.includes("cartão") ||
  norm.includes("fatura") ||
  norm.includes("pendencia") ||
  norm.includes("pendência") ||
  norm.includes("limite") ||
  norm.includes("estacionamento") ||
  norm.includes("posso comprar") ||
  norm.includes("pode comprar") ||
  // 🔹 perguntas sobre ETIQUETA também são assunto da Clara
  norm.includes("etiqueta") ||
  norm.includes("etiquetas") ||
  // 🔹 tudo que menciona gerente/gestor é claramente assunto de Clara
  norm.includes("gerente") ||
  norm.includes("gerentes") ||
  norm.includes("gestor") ||
  norm.includes("gestora") ||

  // 🔹 menção direta a loja/unidade (no contexto desse bot faz sentido tratar como Clara)
  norm.includes("loja")     ||
  norm.includes("unidade")  ||

  // 🔹 tudo que menciona ServiceNow/procedimento de chamado
  norm.includes("servicenow") ||
  norm.includes("service now") ||
  norm.includes("chamado") ||
  norm.includes("chamados") ||
  norm.includes("ticket") ||
  norm.includes("solicitacao") ||
  norm.includes("solicitação") ||
  norm.includes("procedimento") ||
  norm.includes("procedimentos");

// 👇 Frases genéricas de compra/uso em primeira pessoa
const falaDeCompraOuUso =
  norm.includes("comprar") ||
  norm.includes("comprei") ||
  norm.includes("preciso comprar") ||
  norm.includes("quero comprar");

// 👇 Frases claramente sobre o próprio Vektor
const falaSobreBot =
  norm.includes("o que voce faz") ||
  norm.includes("o que vc faz") ||
  norm.includes("o que você faz") ||
  norm.includes("o que o vektor pode fazer") ||
  norm.includes("quem e voce") ||
  norm.includes("quem é você") ||
  norm.includes("qual o seu nome") ||
  norm.includes("pra que voce serve") ||
  norm.includes("pra que vc serve");

// 👇 Só pergunta “sobre o que você fala?” se NÃO for nada disso
if (!falaDeCartaoOuFatura && !falaDeCompraOuUso && !falaSobreBot) {
  const perguntaClara = gerarPerguntaDeClarificacao(norm);
  if (perguntaClara) {
    return perguntaClara;
  }
}

// 14) Ainda assim sobrou → motor da política
return gerarRespostaPolitica(msgUsuario);

}

    // ========= INTERVALOS DE DATA PARA PERGUNTAS DE RELATÓRIO ========= //

   function extrairIntervaloDatas(msgOriginal) {
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const meses = {
        janeiro: 0, fevereiro: 1, marco: 2, março: 2, abril: 3, maio: 4, junho: 5,
        julho: 6, agosto: 7, setembro: 8, outubro: 9, novembro: 10, dezembro: 11
    };

    // const norm = (msgOriginal || "").toLowerCase();
    const norm = normalize(msgOriginal || "");
    let m; // <<< ADICIONE ESTA LINHA AQUI

    // 0) Hoje / Ontem
    if (norm.includes("ontem")) {
        const d = new Date(hoje);
        d.setDate(hoje.getDate() - 1);
        return { tipo: "ontem", dataInicio: d, dataFim: d };
    }
    if (norm.includes("hoje")) {
        const d = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
        return { tipo: "hoje", dataInicio: d, dataFim: d };
    }

    // 0b-a) Esta semana / nessa semana / nesta semana
    if (
        norm.includes("essa semana") ||
        norm.includes("nesta semana") ||
        norm.includes("nessa semana")
    ) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);

        // volta até segunda-feira da semana atual
        const diaSemana = fim.getDay();       // 0=Dom, 1=Seg, ..., 6=Sab
        const diff = (diaSemana === 0 ? 6 : diaSemana - 1); // volta até segunda

        ini.setDate(fim.getDate() - diff);

        return { tipo: "semana_atual", dataInicio: ini, dataFim: fim };
    }

    // 0b) Última semana
    if (norm.includes("ultima semana") || norm.includes("última semana")) {
        const fim = new Date(hoje);
        const ini = new Date(hoje);
        ini.setDate(hoje.getDate() - 7);
        return { tipo: "ultima_semana", dataInicio: ini, dataFim: fim };
    }

    // 0c) Último mês  (sinônimo de "mês passado")
    if (norm.includes("ultimo mes") || norm.includes("último mes") || norm.includes("último mês")) {
        let mes = hoje.getMonth() - 1;
        let ano = anoAtual;
        if (mes < 0) {
            mes += 12;
            ano = anoAtual - 1;
        }
        const ini = new Date(ano, mes, 1);
        const fim = new Date(ano, mes + 1, 0);
        return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
    }

    // "último trimestre" / "trimestre passado"
if (norm.includes("ultimo trimestre") || norm.includes("trimestre passado")) {
  const mesAtual = hoje.getMonth();         // 0..11
  const trimestreAtual = Math.floor(mesAtual / 3); // 0..3
  let ano = anoAtual;
  let trimestreAnterior = trimestreAtual - 1;
  if (trimestreAnterior < 0) {
    trimestreAnterior = 3;
    ano = anoAtual - 1;
  }
  const inicioMes = trimestreAnterior * 3; // 0,3,6,9
  const ini = new Date(ano, inicioMes, 1);
  const fim = new Date(ano, inicioMes + 3, 0); // último dia do trimestre
  return { tipo: "trimestre_passado", dataInicio: ini, dataFim: fim };
}

// "neste trimestre" / "este trimestre"
if (norm.includes("neste trimestre") || norm.includes("este trimestre")) {
  const mesAtual = hoje.getMonth();
  const trimestreAtual = Math.floor(mesAtual / 3);
  const inicioMes = trimestreAtual * 3;
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "trimestre_atual", dataInicio: ini, dataFim: fim };
}

// "neste semestre" / "este semestre"
if (norm.includes("nesse semestre") || norm.includes("este semestre") || norm.includes("neste semestre")) {
  const mesAtual = hoje.getMonth();        // 0..11
  const semestreAtual = Math.floor(mesAtual / 6); // 0 ou 1
  const inicioMes = semestreAtual * 6;     // 0 ou 6
  const ini = new Date(anoAtual, inicioMes, 1);
  const fim = hoje;
  return { tipo: "semestre_atual", dataInicio: ini, dataFim: fim };
}

// 0) Intervalo numérico: aceita com/sem "de" e com/sem ano
// Ex.: "de 01/11/2025 a 15/11/2025", "01/11/2025 a 15/11/2025",
//      "de 01/11 a 15/11", "01/11 a 15/11"
m = norm.match(/(?:de\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?\s+a\s+(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
if (m) {
    const d1 = Number(m[1]);
    const m1 = Number(m[2]) - 1;
    const y1 = m[3] ? Number(m[3]) : anoAtual;

    const d2 = Number(m[4]);
    const m2 = Number(m[5]) - 1;
    const y2 = m[6] ? Number(m[6]) : anoAtual;

    const ini = new Date(y1, m1, d1);
    const fim = new Date(y2, m2, d2, 23, 59, 59);

    return { tipo: "intervalo_numerico", dataInicio: ini, dataFim: fim };
}

    // 0d) Esse mês / neste mês
    if (
        norm.includes("esse mes") || 
        norm.includes("esse mês") ||
        norm.includes("neste mes") || 
        norm.includes("neste mês") ||
        norm.includes("nesse mês") ||
        norm.includes("nesse mes") ||
        norm.includes("este mes") || 
        norm.includes("este mês")
    ) {
        const ini = new Date(anoAtual, hoje.getMonth(), 1);
        const fim = hoje;
        return { tipo: "mes_atual", dataInicio: ini, dataFim: fim };
    }

    // 1) De tal dia a tal dia (ex.: "de 5 a 12 de novembro")
    m = norm.match(/de\s+(\d{1,2})\s+a\s+(\d{1,2})\s+de\s+([a-zç]+)/);
    if (m) {
        const diaIni = Number(m[1]);
        const diaFim = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, diaIni);
            const fim = new Date(anoAtual, mes, diaFim);
            return { tipo: "intervalo", dataInicio: ini, dataFim: fim };
        }
    }

    // 2b) "entre 1 e 15 de novembro"
    m = norm.match(/entre\s+(\d{1,2})\s+e\s+(\d{1,2})\s+de\s+([a-zç]+)/);
    if (m) {
      const dia1 = Number(m[1]);
      const dia2 = Number(m[2]);

      const mesStr = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const mes = meses[mesStr];
      if (mes !== undefined) {
        const ano = anoAtual;
        const ini = new Date(ano, mes, dia1);
        const fim = new Date(ano, mes, dia2, 23, 59, 59);
        return { tipo: "intervalo_mes_texto", dataInicio: ini, dataFim: fim };
      }
    }


      // 2) Dia específico numérico
    // Aceita: "no dia 10/11/2025", "dia 10/11", "10/11/2025", "10/11"
    m = norm.match(/(?:no\s+dia\s+|dia\s+)?(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
    if (m) {
        const dia = Number(m[1]);
        const mes = Number(m[2]) - 1;
        const ano = m[3] ? Number(m[3]) : anoAtual;
        const d = new Date(ano, mes, dia);

        return { tipo: "dia", dataInicio: d, dataFim: d };
    }

    // 2b) "em 5 de outubro"
    m = norm.match(/(em|no)\s+(\d{1,2})\s+de\s+([a-zç]+)/);
    if (m) {
        const dia = Number(m[2]);
        const chaveMes = m[3].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes)
            ? meses[chaveMes]
            : null;

        if (mes !== null) {
            const d = new Date(anoAtual, mes, dia);
            return { tipo: "dia", dataInicio: d, dataFim: d };
        }
    }

    // 3a) "no mês de setembro"
    m = norm.match(/(em|no)\s+mes\s+de\s+([a-zç]+)/);
    if (m) {
        const chaveMes2 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const mes = Object.prototype.hasOwnProperty.call(meses, chaveMes2)
            ? meses[chaveMes2]
            : null;

        if (mes !== null) {
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 3b) "em outubro"
    m = norm.match(/(em|no)\s+([a-zç]+)/);
    if (m) {
        const chaveMes3 = m[2].normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (Object.prototype.hasOwnProperty.call(meses, chaveMes3)) {
            const mes = meses[chaveMes3];
            const ini = new Date(anoAtual, mes, 1);
            const fim = new Date(anoAtual, mes + 1, 0);
            return { tipo: "mes", dataInicio: ini, dataFim: fim };
        }
    }

    // 4) "mês passado"
if (norm.includes("mes passado")) {   // depois do normalize, "mês" já virou "mes"
    let mes = hoje.getMonth() - 1;
    let ano = anoAtual;
    if (mes < 0) {
        mes += 12;
        ano = anoAtual - 1;
    }
    const ini = new Date(ano, mes, 1);
    const fim = new Date(ano, mes + 1, 0);
    return { tipo: "mes_passado", dataInicio: ini, dataFim: fim };
}

// 5) "últimos X meses"
m = norm.match(/ultimos?\s+(\d{1,2})\s+mes(es)?/);
if (m) {
    const qtdMeses = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setMonth(hoje.getMonth() - qtdMeses);
    return { tipo: "ultimos_meses", dataInicio: ini, dataFim: fim };
}

// 6) "últimos 15 dias", etc.
m = norm.match(/ultimos?\s+(\d{1,3})\s+dias?/);
if (m) {
    const qtd = Number(m[1]);
    const fim = hoje;
    const ini = new Date(hoje);
    ini.setDate(hoje.getDate() - qtd);
    return { tipo: "ultimos_dias", dataInicio: ini, dataFim: fim };
}

  // 7) "2 ultimas semanas" ou "ultimas 2 semanas"
m = norm.match(/(\d{1,2})\s+ultimas?\s+semanas?/);
if (!m) {
  m = norm.match(/ultimas?\s+(\d{1,2})\s+semanas?/);
}
if (m) {
  const qtdSemanas = Number(m[1]);
  const dias = qtdSemanas * 7;
  const fim = hoje;
  const ini = new Date(hoje);
  ini.setDate(hoje.getDate() - dias);
  return { tipo: "ultimas_semanas", dataInicio: ini, dataFim: fim };
}

    return null;
}

// Formata "2025-04-10T..." -> "abr/25"
function vektorFormatarMesAnoCurto(isoStr) {
  if (!isoStr) return "";
  var d = new Date(isoStr);
  if (isNaN(d.getTime())) return "";

  var meses = ["jan", "fev", "mar", "abr", "mai", "jun",
               "jul", "ago", "set", "out", "nov", "dez"];
  var mes = meses[d.getMonth()];
  var ano = d.getFullYear().toString().slice(-2);

  return mes + "/" + ano;
}

// Monta a frase "Trazendo dados de abr/25 à nov/25."
function vektorFraseResumoPeriodo(dataInicioIso, dataFimIso) {
  if (!dataInicioIso || !dataFimIso) return "";

  var ini = vektorFormatarMesAnoCurto(dataInicioIso);
  var fim = vektorFormatarMesAnoCurto(dataFimIso);
  if (!ini || !fim) return "";

  if (ini === fim) {
    return "Trazendo dados de " + ini + ".";
  }
  return "Trazendo dados de " + ini + " à " + fim + ".";
}

// ===== Cache de período para drill-down: "mesmo período da pergunta anterior" =====
(function () {
  // Guarda referência da função original
  const _extrairOriginal = extrairIntervaloDatas;

  // Cache global do último período entendido
  window.__vektorUltimoPeriodo = null;

  // Sobrescreve a função usada no restante do código
  extrairIntervaloDatas = function (msgOriginal) {
    try {
      const st = vektorObterContexto();
      // 1) Se a mensagem falar "mesmo período da pergunta anterior"
      //    e já tivermos um período salvo, devolve direto o cache
      if (msgOriginal && typeof msgOriginal === "string") {
        const norm = normalize(msgOriginal);
        if (
        norm.includes("mesmo periodo da pergunta anterior") &&
        st.ultimoPeriodo &&
        st.ultimoPeriodo.dataInicio &&
        st.ultimoPeriodo.dataFim
      ) {
        return st.ultimoPeriodo;
        }
      }

      // 2) Caso contrário, usa a função original
      const periodo = _extrairOriginal(msgOriginal);

        // 3) Se achou período, salva tanto em __vektorUltimoPeriodo quanto no VEKTOR_STATE
    if (periodo && periodo.dataInicio && periodo.dataFim) {
      window.__vektorUltimoPeriodo = periodo;
      vektorRegistrarContexto({
        ultimoPeriodo: periodo
      });
    }

      return periodo;
    } catch (e) {
      console.error("Erro no wrapper de extrairIntervaloDatas:", e);
      // fallback: chama função original
      return _extrairOriginal(msgOriginal);
    }
  };
})();

// ========= RESUMO LOJA x TIME (GRÁFICO) ========= //

function renderResumoTransacoesSemana(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não consegui encontrar informações de transações para esse filtro. Verifique se o time e o período estão corretos.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto do critério (valor x quantidade)
  var criterioTxt = (resumo.tipo === "valor"
    ? "maior <b>valor</b> de transações"
    : "maior <b>número</b> de transações");

  var grupoHtml = resumo.grupoNome
    ? " no time <b>" + resumo.grupoNome + "</b>"
    : "";

  // Filtros recebidos
  var temFiltroLojas = opts && Array.isArray(opts.filtrarLojasCodigos) && opts.filtrarLojasCodigos.length > 0;
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  var fraseResumo;
  if (temFiltroLojas) {
    // Ex.: "lojas 316 e 39 neste mês"
    fraseResumo = "Comparando as lojas <b>" +
      opts.filtrarLojasCodigos.join(", ") +
      "</b> no período selecionado" + grupoHtml + ".";
  } else if (temFiltroTimes) {
    // Ex.: "todas as lojas dos times Falcões e Lobos"
    fraseResumo = "Mostrando lojas dos times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b> no período selecionado" + grupoHtml + ".";
  } else {
    // Comportamento padrão (sem filtro específico)
    fraseResumo = resumo.top
      ? "A loja <b>" + resumo.top.loja + "</b> foi a que teve " + criterioTxt + " no período selecionado" + grupoHtml + "."
      : "Não encontrei transações" + grupoHtml + " no período selecionado.";
  }

  // Base de lojas
  var all = Array.isArray(resumo.lojas) ? resumo.lojas : [];

     // Aplica filtros de LOJAS (aceita “0034 - MORUMBI…”, “0034”, “34” etc.)
  if (temFiltroLojas) {
    var codSet = {};

    // Normaliza os códigos pedidos pelo usuário (remove tudo que não for dígito e zeros à esquerda)
    opts.filtrarLojasCodigos.forEach(function (c) {
      var digits = String(c || "").replace(/\D/g, "");  // só dígitos
      if (!digits) return;
      var norm = digits.replace(/^0+/, "") || digits;   // tira zeros à esquerda (0176 -> 176)
      codSet[norm] = true;
    });

    all = all.filter(function (linha) {
      // Vamos testar vários campos possíveis da linha
      var campos = [
        linha.loja,
        linha.Loja,
        linha.LojaNum,
        linha.codigoLoja,
        linha.CodigoLoja
      ];

      for (var i = 0; i < campos.length; i++) {
        var v = campos[i];
        if (v === undefined || v === null) continue;

        // pode vir "0176", "176" ou "0176 - PLAZA NITEROI-RJ"
        var digitsLinha = String(v).replace(/\D/g, "");
        if (!digitsLinha) continue;

        var normLinha = digitsLinha.replace(/^0+/, "") || digitsLinha;

        if (codSet[normLinha]) {
          return true; // bateu em algum campo -> mantém a linha
        }
      }

      // nenhum campo da linha bateu com os códigos desejados
      return false;
    });
  }

  // Aplica filtros de TIMES
  if (temFiltroTimes) {
    var timesSet = {};
    opts.filtrarTimesNomes.forEach(function (nome) {
      timesSet[String(nome).toLowerCase()] = true;
    });

    all = all.filter(function (linha) {
      var g = String(linha.grupo || linha.Grupo || "").toLowerCase();
      return !!timesSet[g];
    });
  }

  // Decide quantas linhas exibir
  var linhas;
  if (opts && (opts.topN === null)) {
    // topN: null => listar TODAS
    linhas = all;
  } else if (typeof opts.topN === "number") {
    // top N explícito
    linhas = all.slice(0, Math.max(0, opts.topN));
  } else if (opts && opts.forGroup) {
    // Sem topN + filtrando por time => todas as lojas desse(s) time(s)
    linhas = all;
  } else {
    // Ranking geral sem topN => todas (comportamento antigo)
    linhas = all;
  }

  // Guarda lista de lojas exibidas na última tabela (para outras funções usarem)
  try {
    window.__vektorUltimasLojasTabela = (linhas || [])
      .map(function (l) {
        return (l.loja || "").toString().trim();
      })
      .filter(Boolean);
  } catch (e) {
    console.warn("Falha ao registrar lista de lojas da tabela:", e);
  }

  // Somatórios
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // Monta tabela
  var linhasTabela = [];
  if (linhas.length) {

    // Dropdown de drilldown
    linhasTabela.push(
      "<div style='margin-top:8px;margin-bottom:10px;font-size:12px;margin-bottom:4px;color:#334155;display:flex;align-items:center;gap:6px;'>" +
        "<span>Expandir a tabela por:</span>" +
        "<select class='vektor-drill-select' data-base='loja' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Loja</th>" +
        "<th style='border:1px solid #000;'>Transações</th>" +
        "<th style='border:1px solid #000;'>% Transações</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    for (var j = 0; j < linhas.length; j++) {
      var l = linhas[j];
      var qtd = Number(l.total) || 0;
      var val = Number(l.valorTotal) || 0;
      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "—";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "—";

      var hint = "Clique para detalhar pelo filtro escolhido " + l.loja;

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'loja')\" " +
          "style='cursor:pointer;' " +
          "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + l.loja + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "—") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "—") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

  // 🆕 Insights automáticos sobre as LOJAS (TÓPICO 3)
  var insightsLojasHtml = vektorGerarInsightsRankingLojas(linhas || []);

  // Botões (CSV + Pendências + Justificativas)
  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +

        // Exportar CSV
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_lojas')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +

        // Verificar pendências
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarPendenciasLojas(this)\" " +
            "style='background:#B91C1C;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "⚠ Verificar pendências" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(185,28,28,0.92);'>" +
            "Lista todas as pendências das lojas dessa tabela no período informado" +
          "</span>" +
        "</span>" +

        // Verificar justificativas
        "<span class='vektor-btn-wrapper'>" +
          "<button type='button' " +
            "onclick=\"vektorVerificarJustificativasLojas(this)\" " +
            "style='background:#0F172A;color:#fff;border:none;padding:6px 10px;" +
                   "border-radius:4px;font-size:11px;cursor:pointer;'>" +
            "✔ Verificar justificativas" +
          "</button>" +
          "<span class='vektor-tooltip-base' " +
                "style='background:rgba(15,23,42,0.92);'>" +
            "Lista todas as transações com justificativas feitas de forma correta" +
          "</span>" +
        "</span>" +

      "</div>";
  }

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      tabelaHtml,
      insightsLojasHtml || "",
      botoesHtml,
    "</div>"
  ].join("");

  // TÓPICO 2 – memória de contexto (corrigido para ranking_lojas)
  try {
    vektorRegistrarContexto({
      ultimaIntencao: "ranking_lojas",
      ultimoPeriodo: {
        dataInicioIso: typeof dataInicioIso !== "undefined" ? dataInicioIso : "",
        dataFimIso: typeof dataFimIso !== "undefined" ? dataFimIso : ""
      },
      ultimoGrupo: resumo && resumo.grupoNome ? resumo.grupoNome : null,
      ultimaAcaoExplicavel: {
        tipo: "tabela_ranking_lojas",
        meta: {
          tipoResumo: resumo ? resumo.tipo : null,
          grupo: resumo ? resumo.grupoNome : null
        }
      }
    });
  } catch (e) {
    console.warn("Falha ao registrar contexto de ranking_lojas:", e);
  }

  renderBotMessage("HTML:" + html);
}

function vektorParseMesesBack(textoNorm) {
  // defaults
  if (!textoNorm) return 1;

  // últimos 3 meses / ultimos 2 meses
  let m = textoNorm.match(/ultim[oa]s?\s+(\d+)\s+mes/);
  if (m) return Math.max(1, Math.min(24, parseInt(m[1], 10)));

  // último semestre
  if (textoNorm.includes("ultimo semestre") || textoNorm.includes("último semestre")) return 6;

  // último ano
  if (textoNorm.includes("ultimo ano") || textoNorm.includes("último ano")) return 12;

  // mês corrente
  if (textoNorm.includes("mes corrente") || textoNorm.includes("mês corrente")) return 1;

  return 1;
}

function vektorRenderTabelaFrequenciaUso(resp) {
  if (!resp || !resp.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Não consegui montar a tabela de frequência agora.</p>");
    return;
  }

  const rows = Array.isArray(resp.rows) ? resp.rows : [];
  if (!rows.length) {
    const aviso = resp.aviso ? ` (${resp.aviso})` : "";
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Não encontrei transações para esse filtro no período analisado" + aviso + ".</p>");
    return;
  }

  const periodoTxt = resp.periodo ? `${resp.periodo.inicio} a ${resp.periodo.fim}` : "—";

  // Tooltips (title no TH)
  const th = (label, tip) =>
    `<th title="${tip}" class="border px-2 py-1 text-center"
        style="background:#B5FF20;color:#000;white-space:nowrap;">${label}</th>`;

  const insightLinha = resp.insight ? resp.insight : "";
  const leituraAuto =
    "Leitura automática: lojas com mais <b>Freq. Dias</b> tendem a ter maior recorrência; valide também <b>Top Valor</b> e <b>Última Data</b>.";

  const limiteTxt = Array.isArray(resp.insightLimite) && resp.insightLimite.length
    ? `<div style="margin-top:6px;"><b>Ajuste de limite:</b><br>${resp.insightLimite.join("<br>")}`
    : "";

  const atencaoTxt = Array.isArray(resp.insightAtencao) && resp.insightAtencao.length
      ? `<div style="margin-top:6px;">
          <b>Atenção:</b>
          <div style="font-size:13px;color:#475569;margin:2px 0 6px 0;">
            Lojas abaixo apresentam <b>padrões de uso atípicos ou instáveis</b> no período analisado. Os motivos estão descritos individualmente para apoiar análise e acompanhamento.
          </div>
          ${resp.insightAtencao.join("<br>")}
        </div>`
      : "";


  
  const observacaoHistorico =
  "Observação: as métricas históricas consideram o <b>histórico completo da loja</b>, classificada pelo <b>time atual</b>.";

  const insightBox =
        `<div style="margin-top:6px;padding:8px;border:1px solid #E2E8F0;border-radius:6px;background:#F8FAFC;color:#000;font-size:13px;line-height:1.35;">
          ${insightLinha ? `<div><b>Insight:</b> ${insightLinha}</div>` : ""}
          ${limiteTxt}
          ${atencaoTxt}
          <div style="margin-top:4px;">${leituraAuto}</div>
          <div style="margin-top:6px;font-style:italic;color:#475569;">
          ${observacaoHistorico}
        </div>`;

  let html =
    `<div class="text-sm" style="color:#000;margin:0;padding:0;">
       <div style="margin:0 0 6px 0;padding:0;">
         Período analisado: <b>${periodoTxt}</b>.

       <div style="margin:0 0 8px 0;padding:0;font-size:13px;line-height:1.4;color:#334155;">
         A análise considera <b>dias distintos com uso</b> do cartão no período informado, avaliando frequência, regularidade e impacto financeiro.

         Priorize as colunas <b>Freq. Dias</b>, <b>Padrão de uso</b> e <b>Top Valor</b>. Passe o mouse sobre os títulos da tabela para ver a descrição de cada métrica.

       <div class="overflow-x-auto" style="margin:0;padding:0;">
         <table class="min-w-full text-xs border border-slate-200" style="border-collapse:collapse;margin:0;">
           <thead>
             <tr>
               ${th("Loja","Código identificador da loja (4 dígitos). Todas as métricas da linha referem-se exclusivamente a esta loja.")}
               ${th("Freq. Uso Sem.","Indica com que frequência a loja utilizou o cartão na semana corrente (Seg–Dom), considerando dias distintos com transação.")}
               ${th("Freq. Uso Per.","Frequência média de uso da loja dentro do período analisado (ex.: mês corrente, últimos 3 meses), baseada em dias distintos com transação.")}
               ${th("Freq. Uso Total","Frequência média histórica de uso da loja desde a primeira até a última transação registrada, considerando dias distintos.")}
               ${th("Freq. Dias","Quantidade de dias distintos em que a loja utilizou o cartão dentro do período analisado. Quanto maior, mais recorrente é o uso.")}
               ${th("Intervalo Médio","Número médio de dias que a loja ficou sem usar o cartão entre uma data de uso e outra, ao longo do histórico. Valores menores indicam uso mais frequente.")}
               ${th("Padrão de uso","Classificação automática da loja com base na quantidade de dias de uso no período analisado: diário, frequente, moderado ou esporádico.")}
               ${th("Freq. x Valor","Leitura combinada entre frequência de uso e impacto financeiro. Ajuda a identificar lojas com alto valor e baixa frequência ou vice-versa.")}
               ${th("Top Valor","Maior valor individual de transação realizado pela loja dentro do período analisado.")}
               ${th("Última Data","Data mais recente em que a loja utilizou o cartão dentro do período analisado.")}
               ${th("Consistência","Avalia se o padrão de uso da loja vem se mantendo estável, aumentando ou diminuindo ao longo dos últimos meses.")}
             </tr>
           </thead>
           <tbody>`;

  rows.forEach(r => {
    const top = (Number(r.topValor) || 0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    const intervalo = (r.intervaloMedio === null || r.intervaloMedio === undefined)
      ? "—"
      : (Math.round(r.intervaloMedio * 10) / 10).toString().replace(".", ",") + " d";

    html +=
      `<tr>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.loja || ""}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqUsoSem || "—"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqUsoMes || "—"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqUsoTotal || "—"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqDias ?? 0}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${intervalo}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.padrao || "—"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.freqXValor || "—"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${top}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.ultimaDataTrans || "—"}</td>
         <td class="border px-2 py-1" style="color:#000;text-align:center;">${r.consistencia || "—"}</td>
       </tr>`;
  });

  html +=
        `</tbody>
         </table>
       </div>

       ${insightBox}

       <div style="margin-top:6px;display:flex;justify-content:flex-end;">
         <button type="button"
           onclick="exportTableToCSV(this, 'frequencia_uso_clara')"
           style="
             display:inline-flex;
             align-items:center;
             gap:6px;
             width:auto;
             height:auto;
             min-width:unset;
             min-height:unset;
             padding:8px 12px;
             line-height:1;
             white-space:nowrap;
             background:#005E27;
             color:#fff;
             border:none;
             border-radius:6px;
             font-size:12px;
             font-weight:600;
             cursor:pointer;">
           ⬇ Exportar CSV
         </button>
       </div>
     </div>`;

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaListaItensComprados(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Erro ao buscar itens.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  if (!rows.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não encontrei itens para <b>" +
      (res.tipoFiltro || "") + ": " + (res.valorFiltro || "") +
      "</b> no período <b>" + res.periodo.inicio + "</b> a <b>" + res.periodo.fim + "</b>.</p>"
    );
    return;
  }

  // Insights rápidos
  const total = (res.resumo && res.resumo.total) || rows.length;
  const alertas = (res.resumo && res.resumo.alertas) || 0;
  const revisar = (res.resumo && res.resumo.revisar) || 0;

  const insightsHtml = `
        <div class="text-sm text-slate-700" style="margin:0; padding:0; white-space:nowrap;">
          <b>Resumo:</b> ${total} itens&nbsp; |&nbsp;
          <b>ALERTA:</b> ${alertas}&nbsp; |&nbsp;
          <b>REVISAR:</b> ${revisar}
        </div>
        <div class="text-xs text-slate-500" style="margin:0; padding:0;">
          Observação: a classificação é heurística baseada em descrição livre; use como triagem e valide comprovantes/etiquetas.
        </div>
      `;
          // Tabela
            let thead = `
  <thead>
    <tr>
      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Data
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Valor (R$)
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Lojas
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Item Comprado
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Conformidade
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Motivo
      </th>

      <th class="px-3 text-left text-sm font-semibold"
          style="white-space:nowrap;position:sticky;top:0;z-index:5;
                 background:#00FFFF;color:#0F172A;
                 height:44px;line-height:44px;vertical-align:middle;">
        Reincidência
      </th>
    </tr>
  </thead>
`;

  let tbody = rows.map(r => {
  const v = (Number(r.valor) || 0).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const statusKey = (r.status || r.conformidade || "").toString().trim().toUpperCase() || "REVISAR";
  const reincTxt = (r.reincidencia || "").toString().trim();
  const reincFlag = reincTxt ? "1" : "0";

   const badge =
    statusKey === "ALERTA" ? "<span class='px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-700'>ALERTA</span>" :
    statusKey === "OK"     ? "<span class='px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700'>OK</span>" :
                             "<span class='px-2 py-1 rounded text-xs font-semibold bg-yellow-100 text-yellow-700'>REVISAR</span>";

  return `
    <tr class="border-t border-slate-200"
        data-status="${statusKey}"
        data-reinc="${reincFlag}"
        data-time="${((r.time || '').toString().trim()).replace(/"/g,'&quot;')}"
        data-loja="${((r.loja || '').toString().trim()).replace(/"/g,'&quot;')}">

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        ${r.data || ""}
      </td>

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        R$ ${v}
      </td>

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        ${(r.loja || "").replace(/</g,"&lt;")}
      </td>

      <td class="px-3 py-2 text-sm text-slate-800 border-r border-slate-400" style="white-space:nowrap;">
        ${(r.item || "").replace(/</g,"&lt;")}
      </td>

      <td class="px-3 py-2 text-sm border-r border-slate-400" style="white-space:nowrap;">
        ${badge}
      </td>

      <td class="px-3 py-2 text-sm text-slate-700 border-r border-slate-400" style="white-space:nowrap;">
        ${(r.motivo || "").replace(/</g,"&lt;")}
      </td>

      <td class="px-3 py-2 text-sm text-slate-700" style="white-space:nowrap;">
        ${reincTxt.replace(/</g,"&lt;")}
      </td>
    </tr>
  `;
}).join("");

        const tableWrapId = "itensWrap_" + Date.now();

        const isGeral = (res.tipoFiltro || "").toString().toLowerCase() === "geral";

            let opcoesTime = "";
            let opcoesLoja = "";

            if (isGeral) {
              const times = Array.from(
                new Set(
                  rows
                    .map(r => (r.time || "").toString().trim())
                    .filter(Boolean)
                )
              ).sort();

              const lojas = Array.from(
                new Set(
                  rows
                    .map(r => (r.loja || "").toString().trim())
                    .filter(Boolean)
                )
              ).sort();

              opcoesTime = times
                .map(t => `<option value="${t.replace(/"/g,'&quot;')}">${t}</option>`)
                .join("");

              opcoesLoja = lojas
                .map(l => `<option value="${l.replace(/"/g,'&quot;')}">${l}</option>`)
                .join("");
            }


          const filtrosHtml = `
            <div style="margin:0;padding:0;width:100%;display:flex;align-items:center;gap:12px;flex-wrap:wrap;line-height:1;">

              <div class="text-sm text-slate-700 font-semibold" style="white-space:nowrap;">Filtros:</div>

              <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                <span class="text-sm text-slate-700">Conformidade</span>
                <select data-filtro="status"
                  onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                  style="height:32px;padding:0 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;line-height:32px;background:#fff;color:#334155;">
                  <option value="">Todos</option>
                  <option value="OK">OK</option>
                  <option value="REVISAR">REVISAR</option>
                  <option value="ALERTA">ALERTA</option>
                </select>
              </div>

              ${isGeral ? `
                <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                  <span class="text-sm text-slate-700">Time</span>
                  <select multiple size="1" data-filtro="time"
                    onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                    style="min-height:32px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;background:#fff;color:#334155;max-width:240px;">
                    <option value="">Todos</option>
                    ${opcoesTime}
                  </select>
                </div>

                <div style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                <span class="text-sm text-slate-700">Loja</span>
                <select multiple size="1" data-filtro="loja"
                  onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                  style="min-height:32px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;background:#fff;color:#334155;min-width:260px;max-width:420px;">
                  <option value="">Todas</option>
                  ${opcoesLoja}
                </select>
              </div>

              ` : ""}

              <label style="display:flex;align-items:center;gap:8px;margin:0;padding:0;white-space:nowrap;">
                <input type="checkbox" data-filtro="reinc"
                  onchange="vektorAplicarFiltrosItensComprados('${tableWrapId}')"
                  style="width:16px;height:16px;margin:0;" />
                <span class="text-sm text-slate-700">Somente com reincidência</span>
              </label>

              <button type="button"
                onclick="window.vektorLimparFiltrosItensComprados('${tableWrapId}')"
                style="height:32px;padding:0 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:13px;font-weight:700;line-height:32px;background:#fff;color:#334155;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;">
                Limpar
              </button>

            </div>
          `;

        const tabelaHtml = `
  <div id="${tableWrapId}" style="max-width:100%; width:100%; min-width:0; margin:0; padding:0; line-height:1.2; overflow:hidden;">
  <div style="margin:0; padding:0; display:flex; flex-direction:column; gap:4px;">

    <!-- Título/Período -->
    <div style="margin:0; padding:0;" class="text-sm text-slate-700">
    <b>Lista de itens comprados</b> — ${res.tipoFiltro}: <b>${res.valorFiltro}</b> — período <b>${res.periodo.inicio}</b> a <b>${res.periodo.fim}</b>
    </div>

    <!-- Insights (se existir variável insightsHtml) -->
    <div style="margin:0; padding:0; line-height:1.2;">
      ${typeof insightsHtml !== "undefined" ? insightsHtml : ""}
    </div>

    <!-- ✅ Filtros (abaixo do insight principal e acima da tabela) -->
    ${filtrosHtml}

    <!-- Tabela -->
        <div class="mt-1"
        style="max-width:100%; min-width:0; max-height:420px; overflow:auto; position:relative;">
      <table class="border border-slate-200 rounded-lg"
       style="border-collapse:separate; border-spacing:0; table-layout:auto; width:max-content;">
        ${thead}
        <tbody>${tbody}</tbody>
      </table>
    </div>


    <!-- Botão CSV -->
    <div class="mt-1" style="width:100%; display:flex; justify-content:flex-end;">
      <button type="button"
        onclick="exportTableToCSV(this, 'lista_itens_comprados.csv')"
        style="all:unset; cursor:pointer; background:#005E27; color:#fff; padding:10px 16px; border-radius:10px; font-weight:700; display:inline-flex; align-items:center; white-space:nowrap;">
        Exportar CSV
      </button>
    </div>
  </div>

    </div>  <!-- fecha a div flex column -->
    </div>     <!-- fecha a div id="${tableWrapId}" -->
`;

  renderBotMessage("HTML:" + tabelaHtml);
}

function vektorRenderTabelaRelacaoSaldos(res, tipo) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Erro ao buscar saldos.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  const totals = res.totals || {};
  const h = (res.highlights || {});

  // ID único por instância (evita conflito se o usuário pedir “saldo geral” 2x no chat)
  const wrapId = "vektor-saldos-" + Date.now() + "-" + Math.floor(Math.random() * 1e6);

  if (!rows.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Sem dados para o período <b>" + (periodo.inicio || "") + "</b> a <b>" + (periodo.fim || "") + "</b>.</p>"
    );
    return;
  }

  function money(n) {
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  // =======================
  // FILTROS (APENAS SALDO GERAL)
  // =======================
  var filtrosHtml = "";
  var wrapIdRelacaoSaldos = "relacaoSaldosWrap_" + (tipo || "geral"); // mantém como você já tinha
  + "_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);

  if ((tipo || "").toLowerCase() === "geral") {
    // pega lojas/aliases (BaseClara col H) a partir do retorno
    var aliases = (rows || [])
      .map(function(x){ return (x && x.nomeCartao) ? String(x.nomeCartao).trim() : ""; })
      .filter(function(x){ return !!x; });

    // únicos
    var seen = {};
    var aliasesUnicos = [];
    aliases.forEach(function(a){
      if (!seen[a]) { seen[a] = true; aliasesUnicos.push(a); }
    });

    // ordena (opcional, melhora uso)
    aliasesUnicos.sort(function(a,b){ return a.localeCompare(b); });

    var optionsLojas = ["<option value=''>Todas as lojas</option>"]
      .concat(aliasesUnicos.map(function(a){
        return "<option value='" + a.replace(/'/g,"&#39;") + "'>" + a + "</option>";
      }))
      .join("");

    filtrosHtml =
      "<span style='display:inline-flex;align-items:center;gap:8px;margin-left:14px;'>" +
        "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Lojas:</b></label>" +
        "<select id='filtroRelacaoSaldosLoja' " +
                "onchange=\"vektorFiltrarRelacaoSaldos('" + wrapIdRelacaoSaldos + "')\" " +
                "style='font-size:12px;border:1px solid #CBD5E1;border-radius:6px;padding:4px 8px;background:#fff;'>" +
          optionsLojas +
        "</select>" +

        "<label style='font-size:13px;color:#334155;white-space:nowrap;margin-left:8px;'><b>Ação:</b></label>" +
        "<select id='filtroRelacaoSaldosAcao' " +
                "onchange=\"vektorFiltrarRelacaoSaldos('" + wrapIdRelacaoSaldos + "')\" " +
                "style='font-size:12px;border:1px solid #CBD5E1;border-radius:6px;padding:4px 8px;background:#fff;'>" +
          "<option value=''>Todas</option>" +
          "<option value='Aumentar'>Aumentar</option>" +
          "<option value='Manter'>Manter</option>" +
          "<option value='Reduzir'>Reduzir</option>" +
        "</select>" +

        "<button type='button' " +
                "onclick=\"vektorLimparFiltroRelacaoSaldos('" + wrapIdRelacaoSaldos + "')\" " +
                "style='margin-left:8px;background:#0F172A;color:#fff;border:none;padding:5px 10px;border-radius:6px;font-size:12px;cursor:pointer;'>" +
          "Limpar" +
        "</button>" +
      "</span>";
  }

  // Insights (1 linha por item, sem espaçamento)
  let insights = "";

  // Período + filtros na MESMA linha (somente geral terá filtros; time fica vazio)
  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Período:</b> "
    + (periodo.inicio || "") + " a " + (periodo.fim || "")
    + (filtrosHtml || "")
    + "</p>";
  insights += "<div style='height:8px;'></div>";

  if (h.menorSaldo) {
    const lojaTxt = h.menorSaldo.loja ? ("Loja " + h.menorSaldo.loja) : "Loja (N/D)";
    insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Menor saldo:</b> "
      + lojaTxt + " — " + money(h.menorSaldo.saldo) + "</p>";
  }
  insights += "<div style='height:8px;'></div>";

  if (h.maiorSaldo) {
    const lojaTxt = h.maiorSaldo.loja ? ("Loja " + h.maiorSaldo.loja) : "Loja (N/D)";
    insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Maior saldo:</b> "
      + lojaTxt + " — " + money(h.maiorSaldo.saldo) + "</p>";
  }
  insights += "<div style='height:8px;'></div>";

  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'>"
    + "<b>Projeção de gasto:</b> estimativa do valor que a loja tende a gastar até o fim do ciclo de faturamento (06→05), "
    + "calculada pela média dos últimos 3 ciclos completos. "
    + "Na ausência de histórico suficiente, utiliza 2 ciclos ou, em último caso, os últimos 30 dias."
    + "</p>";
  insights += "<div style='height:8px;'></div>";

  // Cabeçalho dinâmico
  const showLoja = false;
  const showTime = (tipo === "geral"); // conforme você pediu: time/loja sem coluna Time

  let th = "";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Nome do cartão</th>";
  if (showTime) th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Time</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Tipo</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Titular</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Limite</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Valor Utilizado</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#FFF3B0;color:#000;position:sticky;top:0;z-index:3;'>ℹ️ Projeção Gasto</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#FFF3B0;color:#000;position:sticky;top:0;z-index:3;'>% da Projeção</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Ritmo de Consumo</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Limite Recomendado</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Ação</th>";
  th += "<th style='border:1px solid #000;padding:6px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:2;'>Saldo</th>";

  // Linhas
  let trs = "";
  rows.forEach(function(r) {
    var aliasCartao = (r.nomeCartao || "").toString();     // vem da BaseClara (Alias do Cartão)

    var acaoLinhaRaw = (r.acao || "").toString(); // pode vir "Aumentar (+R$...)" etc.
    var acaoBase = "";

    var acaoUp = acaoLinhaRaw.trim().toLowerCase();
    if (acaoUp.indexOf("aumentar") === 0) acaoBase = "Aumentar";
    else if (acaoUp.indexOf("reduzir") === 0) acaoBase = "Reduzir";
    else if (acaoUp.indexOf("manter") === 0) acaoBase = "Manter";
    // se vier vazio ou outro texto, acaoBase fica "" (não filtra por ação)

    // ✅ NOVO: tooltip na linha inteira
    // ✅ NOVO: mantém data-alias / data-acao como já existia
    trs += "<tr " +
             "title='Dica: clique no Nome do cartão para ver as transações do período aberto (06 → hoje).' " +
             "data-alias='" + aliasCartao.replace(/'/g, "&#39;") +
             "' data-acao='" + acaoBase.replace(/'/g, "&#39;") + "'>";

    // ✅ NOVO: transforma Nome do cartão em link clicável (sem mudar a coluna nem o texto)
    // - passa o aliasCartao para window.vektorAbrirTransacoesPeriodoLoja(alias)
    // - mantém o conteúdo exatamente no mesmo lugar
    var aliasArg = aliasCartao
      .replace(/\\/g, "\\\\")
      .replace(/'/g, "\\'")
      .replace(/</g, "&lt;");

    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;'>" +
             "<a href='javascript:void(0)' " +
                "title='Clique para ver as transações do período aberto (06 → hoje)' " +
                "onclick=\"window.vektorAbrirTransacoesPeriodoLoja && window.vektorAbrirTransacoesPeriodoLoja('" + aliasArg + "')\" " +
                "style='color:#005E27;font-weight:700;text-decoration:underline;cursor:pointer;'>" +
               (r.nomeCartao || "") +
             "</a>" +
           "</td>";

    if (showTime) {
      trs += "<td style='border:1px solid #000;padding:6px;'>" + (r.time || "") + "</td>";
    }

    trs += "<td style='border:1px solid #000;padding:6px;'>" + (r.tipo || "") + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + (r.titular || "") + "</td>";

    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.limite) + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.utilizado) + "</td>";

    // ℹ️ Projeção Gasto
    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.projecao) + "</td>";

    // % da Projeção
    var pctProj = (r.projecao && r.projecao > 0)
      ? ((r.utilizado / r.projecao) * 100).toFixed(1) + "%"
      : "—";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + pctProj + "</td>";

    // Ritmo de consumo (com ícone)
    var ritmoTxt = r.ritmo || "—";
    var ritmoIcon = "";

    if (ritmoTxt === "Alto") {
      ritmoIcon = "🚨 ";
    } else if (ritmoTxt === "Médio") {
      ritmoIcon = "⚠️ ";
    } else if (ritmoTxt === "Baixo") {
      ritmoIcon = "⬇️ ";
    }

    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;'>" 
      + ritmoIcon + ritmoTxt 
      + "</td>";

    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;'>" + money(r.limiteRecomendado) + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;white-space:nowrap;font-weight:700;'>" + (r.acao || "") + "</td>";
    trs += "<td style='border:1px solid #000;padding:6px;'>" + money(r.saldo) + "</td>";

    trs += "</tr>";
  });

  const table =
    "<div id='" + wrapIdRelacaoSaldos + "' style='max-width:100%; overflow:auto; max-height:420px;'>" +
      insights +
      "<table style='min-width:1300px; width:100%; border-collapse:collapse;'>" +
        "<thead><tr style='background:#0b2a5b;color:#fff;'>" + th + "</tr></thead>" +
        "<tbody>" + trs + "</tbody>" +
      "</table>" +
      "<div style='text-align:right; margin-top:6px;'>" +
        "<button type='button' onclick=\"exportTableToCSV(this, 'relacao_saldos')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage("HTML:" + table);
}

// Clique no link da Relação de Saldos -> puxa e renderiza transações do período aberto
window.vektorAbrirTransacoesPeriodoLoja = function(aliasLoja) {
  try {
    aliasLoja = (aliasLoja || "").toString().trim();
    if (!aliasLoja) return;

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700' style='margin:0;'>Consultando transações de <b>" +
      aliasLoja.replace(/</g,"&lt;") +
      "</b> no período aberto (06 → hoje)…</p>"
    );

    google.script.run
      .withSuccessHandler(function(res){
        vektorRenderTabelaTransacoesLojaPeriodo(res);
      })
      .withFailureHandler(function(err){
        renderBotMessage("HTML:<p class='text-sm text-red-700'>Falha ao consultar transações: " + (err && err.message ? err.message : err) + "</p>");
      })
      .getTransacoesLojaPeriodoAberto(aliasLoja);
  } catch (e) {
    console.error(e);
  }
};

function vektorRenderTabelaTransacoesLojaPeriodo(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Não foi possível montar a tabela.</p>");
    return;
  }

  const rows = res.rows || [];
  const meta = res.meta || {};
  const wrapId = "vektor-trans-loja-" + Date.now() + "-" + Math.floor(Math.random()*1e6);

  const titulo =
    `<div class="text-sm text-slate-800" style="margin:0;padding:0;line-height:1.2;">
      <b>Transações da Loja ${String(meta.alias||"").replace(/</g,"&lt;")}</b> no período: <b>${String(meta.inicio||"")}</b> até <b>${String(meta.fim||"")}</b>.
    </div>`;

  if (!rows.length) {
    renderBotMessage("HTML:" + titulo + "<div class='text-sm text-slate-700' style='margin:4px 0 0 0;'>Sem transações no período.</div>");
    return;
  }

  const thead = `
    <thead>
      <tr>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Data</th>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Valor (R$)</th>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Loja</th>
        <th style="position:sticky;top:0;z-index:5;background:#fff;color:#000;border:1px solid #000;padding:6px 8px;white-space:nowrap;text-align:center;">Item Comprado</th>
      </tr>
    </thead>
  `;

  const tbody = rows.map(function(r){
    const v = (Number(r.valor)||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
    return `
      <tr style="border:1px solid #000;">
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;">${(r.data||"")}</td>
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;">R$ ${v}</td>
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;">${String(r.loja||"").replace(/</g,"&lt;")}</td>
        <td style="border:1px solid #000;padding:6px 8px;white-space:nowrap;max-width:520px;overflow:hidden;text-overflow:ellipsis;">
          ${String(r.item||"").replace(/</g,"&lt;")}
        </td>
      </tr>
    `;
  }).join("");

  const html = `
    <div id="${wrapId}" style="width:100%;margin:0;padding:0;line-height:1.2;">
      ${titulo}
      <div style="height:6px;"></div>
      <div style="width:100%;max-height:420px;overflow:auto;border:1px solid #000;border-radius:10px;background:#fff;">
        <table style="width:max-content;border-collapse:collapse;">
          ${thead}
          <tbody>${tbody}</tbody>
        </table>
      </div>
      <div style="margin-top:8px;display:flex;justify-content:flex-end;">
        <button type="button"
          onclick="exportTableToCSV(this, 'transacoes_loja_periodo')"
          style="height:32px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#005E27;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">
          ⬇ Exportar CSV
        </button>
      </div>
    </div>
  `;

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaEstornos(res, tipo) {
  if (!res || !res.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        (res && res.error ? res.error : "Erro ao buscar estornos.") +
      "</p>"
    );
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  const h = res.highlights || {};

  const wrapId = "vektor-estornos-" + Date.now() + "-" + Math.floor(Math.random() * 1e6);

  if (!rows.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Sem estornos no período <b>" +
        (periodo.inicio || "") +
      "</b> a <b>" +
        (periodo.fim || "") +
      "</b>.</p>"
    );
    return;
  }

  function money(n) {
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  const dataset = rows.map(r => ({
    loja: (r.loja || "").toString(),
    time: (r.time || "").toString(),
    data: (r.dataTransacao || "").toString(),
    periodoFatura: (r.periodoFatura || "").toString(),
    valor: r.valorEstorno,
    estabelecimento: (r.estabelecimento || "").toString(),
    titular: (r.titular || "").toString(),
    categoria: (r.categoria || "").toString(),
  }));

  // dataset global por wrapId (pra filtros funcionarem sem nova chamada no GAS)
  window.__VEKTOR_ESTORNOS = window.__VEKTOR_ESTORNOS || {};
  window.__VEKTOR_ESTORNOS[wrapId] = dataset;

  function uniq(arr) {
    const s = {};
    const out = [];
    arr.forEach(x => {
      const k = (x || "").trim();
      if (!k) return;
      if (!s[k]) { s[k] = true; out.push(k); }
    });
    out.sort((a,b)=>a.localeCompare(b));
    return out;
  }

  const timesUnicos = uniq(dataset.map(x => x.time));
  const lojasUnicas = uniq(dataset.map(x => x.loja));

  const showTimeFilter = (String(tipo || "").toLowerCase() !== "time");

  const txt =
  "<div style='margin:0;padding:0;white-space:normal;line-height:18px;'>" +
    "<div class='text-sm text-slate-700' style='margin:0;padding:0;line-height:18px;'>" +
      "<b>Tabela de estornos:</b> Use como auditoria operacional sobre os estornos ocorridos e também para validação de justificativas/comprovantes." +
    "</div>" +

        "<div style='height:6px;'></div>" +  // ✅ 1 linha

    "<div class='text-sm text-slate-700' style='margin:6px 0 0 0;padding:0;line-height:18px;'>" +
      "<b>Período de análise:</b> " + esc(periodo.inicio || "—") + " a " + esc(periodo.fim || "—") +
    "</div>" +

    "<div style='height:6px;'></div>" +  // ✅ 1 linha

    "<div class='text-sm text-slate-700' style='margin:6px 0 0 0;padding:0;line-height:18px;white-space:nowrap;'>" +
      "<b>Total de estornos:</b> " + dataset.length +
      "&nbsp;|&nbsp;<b>Loja maior %:</b> " + (h.lojaMaiorPct ? (esc(h.lojaMaiorPct.loja) + " (" + esc(h.lojaMaiorPct.pct || "0%") + ")") : "—") +
      "&nbsp;|&nbsp;<b>Maior estorno:</b> " + (h.maiorEstorno ? (esc(money(h.maiorEstorno.valor)) + " em " + esc(h.maiorEstorno.data || "—")) : "—") +
    "</div>" +
  "</div>";

  const filtrosHtml = `
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 6px 0;padding:0;line-height:18px;">
      ${showTimeFilter ? `
        <span style="display:inline-flex;align-items:center;gap:8px;">
          <label style="font-size:13px;color:#334155;white-space:nowrap;"><b>Time:</b></label>
          <select id="${wrapId}-time"
                  onchange="window.vektorAplicarFiltrosEstornos('${wrapId}', ${showTimeFilter ? "true" : "false"})"
                  style="font-size:12px;border:1px solid #CBD5E1;border-radius:8px;padding:4px 8px;background:#fff;height:32px;">
            <option value="">Todos os times</option>
            ${timesUnicos.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("")}
          </select>
        </span>
      ` : ""}

      <span style="display:inline-flex;align-items:center;gap:8px;">
        <label style="font-size:13px;color:#334155;white-space:nowrap;"><b>Loja:</b></label>
        <select id="${wrapId}-loja"
                onchange="window.vektorAplicarFiltrosEstornos('${wrapId}', ${showTimeFilter ? "true" : "false"})"
                style="font-size:12px;border:1px solid #CBD5E1;border-radius:8px;padding:4px 8px;background:#fff;height:32px;">
          <option value="">Todas as lojas</option>
          ${lojasUnicas.map(l => `<option value="${esc(l)}">${esc(l)}</option>`).join("")}
        </select>
      </span>
      <button type="button"
        onclick="window.vektorLimparFiltrosEstornos('${wrapId}', ${showTimeFilter ? "true" : "false"})"
        style="
          height:32px;
          min-width:110px;
          padding:0;
          border:1px solid #CBD5E1;
          border-radius:8px;
          background:#fff;
          font-size:12px;
          font-weight:600;
          cursor:pointer;
          display:inline-flex;
          align-items:center;
          justify-content:center;
          line-height:1;
          box-sizing:border-box;
        ">
        Limpar filtros
      </button>
    </div>
  `;

  const thead = `
  <thead>
    <tr>
      ${["Loja","Time","Data da Transação","Período da fatura","Valor Estorno","Estabelecimento","Titular","Categoria"].map(t => `
        <th
          style="
            white-space:nowrap;
            position:sticky;
            top:0;
            z-index:3;
            background:#FFEB3B;  /* ✅ amarelo verdadeiro */
            color:#000;
            border:1px solid rgba(0,0,0,.25);
            padding:8px 12px;
            text-align:left;
            font-size:13px;
            font-weight:700;
          "
        >${t}</th>
      `).join("")}
    </tr>
  </thead>
`;

  function rowHtml(r) {
    const b = "border:1px solid rgba(0,0,0,.20);";
    return `
      <tr>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.loja)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.time)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.data)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.periodoFatura)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(money(r.valor))}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.estabelecimento)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.titular)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.categoria)}</td>
      </tr>
    `;
  }

  const html = `
    <div id="${wrapId}" style="width:100%;">
      ${txt}
      ${filtrosHtml}

      <div style="width:100%; max-height:420px; overflow:auto; position:relative; border:1px solid rgba(0,0,0,.15); border-radius:10px; background:#fff;">
        <table style="width:100%; border-collapse:collapse;">
          ${thead}
          <tbody id="${wrapId}-tbody">
            ${dataset.map(rowHtml).join("")}
          </tbody>
        </table>
      </div>

      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <button type="button"
          onclick="exportTableToCSV(this, 'estornos_clara')"
          style="height:32px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#005E27;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">
          ⬇ Exportar CSV
        </button>
      </div>
    </div>
  `;

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaUsoIrregular(res) {
  if (!res || !res.ok) {
    if (res && res.restrito) {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Esse comando é restrito a Administradores.</p>");
      return;
    }
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Não consegui montar o relatório de uso irregular.</p>");
    return;
  }

  const dataset = Array.isArray(res.rows) ? res.rows : [];
  if (!dataset.length) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Nenhum caso atingiu o gatilho conservador (2+ critérios fortes) no ciclo atual.</p>");
    return;
  }

  const wrapId = "vektor-uso-irregular-" + Date.now();
  window.__VEKTOR_USO_IRREGULAR = window.__VEKTOR_USO_IRREGULAR || {};
  window.__VEKTOR_USO_IRREGULAR[wrapId] = dataset;

  const times = Array.from(new Set(dataset.map(r => (r.time || "").trim()).filter(Boolean))).sort();
  const lojas = Array.from(new Set(dataset.map(r => (r.loja || "").trim()).filter(Boolean))).sort();

  const filtrosHtml = `
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;margin:0;padding:0;line-height:1;">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:12px;color:#334155;font-weight:700;">Time</label>
        <select id="${wrapId}-time" onchange="window.vektorAplicarFiltrosUsoIrregular('${wrapId}')" style="height:34px;border:1px solid rgba(0,0,0,.2);border-radius:8px;padding:0 10px;font-size:12px;min-width:220px;">
          <option value="">Todos</option>
          ${times.map(t => `<option value="${t}">${t}</option>`).join("")}
        </select>
      </div>

      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:12px;color:#334155;font-weight:700;">Loja</label>
        <select id="${wrapId}-loja" onchange="window.vektorAplicarFiltrosUsoIrregular('${wrapId}')" style="height:34px;border:1px solid rgba(0,0,0,.2);border-radius:8px;padding:0 10px;font-size:12px;min-width:140px;">
          <option value="">Todas</option>
          ${lojas.map(l => `<option value="${l}">${l}</option>`).join("")}
        </select>
      </div>

      <button type="button"
        onclick="window.vektorLimparFiltrosUsoIrregular('${wrapId}')"
        style="height:34px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#0f172a;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;">
        Limpar
      </button>
    </div>
  `;

  const thead = `
    <thead>
      <tr>
        ${["Loja","Time","Data","Cartão","Estabelecimento","Qtd (dia)","Soma (dia)","Maior valor","Pendências","Score","Regras"]
          .map(t => `<th style="
            position:sticky;top:0;z-index:2;
            background:#B91C1C;color:#ffffff;
            border:1px solid #000;
            text-align:left;font-size:13px;font-weight:800;
            padding:8px 12px;white-space:nowrap;
          ">${t}</th>`).join("")}
      </tr>
    </thead>
  `;

  function esc(x){
    return String(x===null||x===undefined?"":x)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function rowHtml(r) {
    const b = "border:1px solid rgba(0,0,0,0.65);";
    return `
      <tr data-loja="${esc(r.loja)}" data-time="${esc(r.time)}">
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.loja)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.time)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.data)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.cartao)}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.estabelecimento)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.qtdDia)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.somaDia)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.valor)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.pendenciasTxt)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;font-weight:800;">${esc(r.score)}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.regrasTxt)}</td>
      </tr>
    `;
  }

      const html = `
      <div id="${wrapId}" style="width:100%; margin:0; padding:0;">

        <div style="margin:0; padding:0; display:flex; flex-direction:column; gap:0;">
        
        <!-- Linha 1: texto -->
        <div class="text-sm text-slate-700"
            style="margin:0;padding:0;line-height:1.2;white-space:nowrap;">
          <b>Possível uso irregular</b> (modelo conservador: 2+ critérios fortes). Período:
          <b>${esc((res.meta && res.meta.periodo) || "")}</b>.
          <br><br> 

        <!-- Linha 3: filtros -->
        ${filtrosHtml} <br>


    <div style="width:100%; max-height:420px; overflow:auto; position:relative; border:1px solid rgba(0,0,0,0.2); border-radius:10px; background:#fff; margin-top:4px;">
      <table style="width:100%; border-collapse:collapse;">
        ${thead}
        <tbody id="${wrapId}-tbody">
          ${dataset.map(rowHtml).join("")}
        </tbody>
      </table>
    </div>

    <div style="margin-top:4px; display:flex; justify-content:flex-end;">
      <button type="button"
        onclick="exportTableToCSV(this, 'uso_irregular_clara')"
        style="height:32px;padding:0 12px;display:inline-flex;align-items:center;gap:6px;line-height:1;background:#005E27;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">
        ⬇ Exportar CSV
      </button>
    </div>
  </div>
`;

  renderBotMessage("HTML:" + html);

try {
  var rows = dataset || [];
  var periodoTxt = (res && res.meta && res.meta.periodo) ? res.meta.periodo : "";

  // loja principal = maior score; desempate por maior valor (string dinheiro não é ideal, mas serve)
  var top = rows.slice().sort(function(a,b){
    if ((b.score||0) !== (a.score||0)) return (b.score||0) - (a.score||0);
    return String(b.valor||"").localeCompare(String(a.valor||""));
  })[0];

  var lojasUnicas = Array.from(new Set(rows.map(r => (r.loja||"").trim()).filter(Boolean)));
  var totalCasos = rows.length;

  var texto =
    "<div class='text-sm text-slate-700' style='margin-top:4px;'>" +
      "<p style='margin:0;'><b>Leitura do cenário:</b> encontrei <b>" + totalCasos + "</b> caso(s) em <b>" + lojasUnicas.length + "</b> loja(s)" +
      (periodoTxt ? " no período <b>" + periodoTxt + "</b>" : "") + ".</p>" +
      (top ? (
        "<p style='margin:4px 0 0 0;'>" +
          "A principal prioridade de verificação é a loja <b>" + (top.loja||"") + "</b>" +
          " (titular: <b>" + (top.titular||"—") + "</b>), porque teve o maior <b>score (" + (top.score||0) + ")</b> e combinou regras: " +
          "<b>" + (top.regrasTxt||"") + "</b>." +
        "</p>"
      ) : "") +
      "<p style='margin:4px 0 0 0;'>" +
        "<b>Como interpretar o score:</b> ele é uma soma ponderada de sinais conservadores; " +
        "quanto maior, mais critérios simultâneos apareceram (ex.: fracionamento + pendência + valor alto). " +
        "Use como <b>triagem</b> e confirme em comprovantes/etiquetas/descrição." +
      "</p>" +
    "</div>";

  renderBotMessage("HTML:" + texto);
} catch(e) {
  console.warn("Falha ao gerar explicação do cenário:", e);
}

}

window.vektorAplicarFiltrosUsoIrregular = function(wrapId) {
  try {
    var data = (window.__VEKTOR_USO_IRREGULAR && window.__VEKTOR_USO_IRREGULAR[wrapId]) ? window.__VEKTOR_USO_IRREGULAR[wrapId] : [];
    var selTime = document.getElementById(wrapId + "-time");
    var selLoja = document.getElementById(wrapId + "-loja");

    var timeVal = selTime ? (selTime.value || "").trim() : "";
    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";

    // 1) FILTRA LINHAS (AND)
    var tbody = document.getElementById(wrapId + "-tbody");
    if (tbody) {
      var trs = tbody.querySelectorAll("tr[data-loja][data-time]");
      trs.forEach(function(tr){
        var t = (tr.getAttribute("data-time") || "").trim();
        var l = (tr.getAttribute("data-loja") || "").trim();

        var okT = !timeVal || t === timeVal;
        var okL = !lojaVal || l === lojaVal;

        tr.style.display = (okT && okL) ? "" : "none";
      });
    }

    // 2) RECONSTRÓI AS OPÇÕES DO OUTRO SELECT
    // - lojas válidas dependem do time selecionado
    // - times válidos dependem da loja selecionada
    var lojasValidas = {};
    var timesValidos = {};

    data.forEach(function(r){
      var t = (r.time || "").trim();
      var l = (r.loja || "").trim();

      // aplica “o outro filtro” para gerar opções dependentes
      if (!timeVal || t === timeVal) lojasValidas[l] = true;
      if (!lojaVal || l === lojaVal) timesValidos[t] = true;
    });

    function rebuildSelect(selectEl, placeholder, mapValidos, currentVal) {
      if (!selectEl) return;
      var arr = Object.keys(mapValidos).filter(Boolean).sort(function(a,b){ return a.localeCompare(b); });

      var html = "<option value=''>" + placeholder + "</option>";
      arr.forEach(function(v){
        var sel = (currentVal && v === currentVal) ? " selected" : "";
        html += "<option value=\"" + v.replace(/"/g,'&quot;') + "\"" + sel + ">" + v + "</option>";
      });
      selectEl.innerHTML = html;

      // se o valor atual não existe mais, limpa
      if (currentVal && arr.indexOf(currentVal) === -1) {
        selectEl.value = "";
      }
    }

    rebuildSelect(selLoja, "Todas", lojasValidas, lojaVal);
    rebuildSelect(selTime, "Todos", timesValidos, timeVal);

  } catch (e) {
    console.error("Erro em vektorAplicarFiltrosUsoIrregular:", e);
  }
};

window.vektorLimparFiltrosUsoIrregular = function(wrapId) {
  var selTime = document.getElementById(wrapId + "-time");
  var selLoja = document.getElementById(wrapId + "-loja");
  if (selTime) selTime.value = "";
  if (selLoja) selLoja.value = "";
  window.vektorAplicarFiltrosUsoIrregular(wrapId);
};

window.vektorExecutarUsoIrregular = function (modo) {
  try {
    renderBotMessage(
  "HTML:<p class='text-sm text-slate-600'>Processando analise (" + String(modo || "") + ")...</p>"
);

    google.script.run
      .withSuccessHandler(function(res){
        try {
          vektorRenderTabelaUsoIrregular(res); // mantém sua renderização atual
        } catch (e) {
          console.error("Erro ao renderizar uso irregular:", e);
          renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Erro ao renderizar tabela:</b> " + (e && e.message ? e.message : e) + "</p>");
        }
      })
      .withFailureHandler(function(err){
        renderBotMessage("HTML:<p class='text-sm text-red-700'>Falha ao consultar BaseClara: " + (err && err.message ? err.message : err) + "</p>");
      })
      .getPossivelUsoIrregularParaChat(modo);  // <- AGORA com parâmetro
  } catch (e) {
    console.error(e);
  }
};

window.vektorAplicarFiltrosEstornos = function(wrapId, hasTime) {
  const data = (window.__VEKTOR_ESTORNOS && window.__VEKTOR_ESTORNOS[wrapId]) ? window.__VEKTOR_ESTORNOS[wrapId] : [];

  const timeSel = document.getElementById(wrapId + "-time");
  const lojaSel = document.getElementById(wrapId + "-loja");

  const time = (hasTime && timeSel) ? (timeSel.value || "") : "";
  const loja = lojaSel ? (lojaSel.value || "") : "";

  // quando muda TIME, recalcula lista de lojas possíveis
  if (hasTime && timeSel && lojaSel) {
    const lojasPossiveis = {};
    data.forEach(r => {
      if (time && r.time !== time) return;
      if (r.loja) lojasPossiveis[r.loja] = true;
    });

    const lojaAtual = lojaSel.value || "";
    const opts = ["<option value=''>Todas as lojas</option>"]
      .concat(Object.keys(lojasPossiveis).sort().map(l => `<option value="${String(l).replace(/"/g,"&quot;")}">${l}</option>`));
    lojaSel.innerHTML = opts.join("");

    if (lojaAtual && !lojasPossiveis[lojaAtual]) lojaSel.value = "";
    else lojaSel.value = lojaAtual;
  }

  const lojaFinal = lojaSel ? (lojaSel.value || "") : "";

  const filtrado = data.filter(r => {
    if (hasTime && time && r.time !== time) return false;
    if (lojaFinal && r.loja !== lojaFinal) return false;
    return true;
  });

  // render tbody
  const tbody = document.getElementById(wrapId + "-tbody");
  if (!tbody) return;

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }
  function money(n) {
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  tbody.innerHTML = filtrado.map(r => {
    const b = "border:1px solid rgba(0,0,0,.20);";
    return `
      <tr>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.loja)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.time)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.data)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.periodoFatura)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(money(r.valor))}</td>
        <td style="${b}padding:8px 12px;font-size:13px;">${esc(r.estabelecimento)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.titular)}</td>
        <td style="${b}white-space:nowrap;padding:8px 12px;font-size:13px;">${esc(r.categoria)}</td>
      </tr>
    `;
  }).join("");
};

window.vektorLimparFiltrosEstornos = function(wrapId, hasTime) {
  const timeSel = document.getElementById(wrapId + "-time");
  const lojaSel = document.getElementById(wrapId + "-loja");

  if (hasTime && timeSel) timeSel.value = "";
  if (lojaSel) lojaSel.value = "";

  window.vektorAplicarFiltrosEstornos(wrapId, hasTime);
};

function renderTabelaLojasOfensoras(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Falha ao consultar lojas ofensoras.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  const meta = res.meta || {};

  if (!rows.length) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Sem dados de lojas ofensoras no período analisado.</p>");
    return;
  }

  const wrapId = "wrapLojasOfensoras_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);

  // IDs únicos por instância (para não quebrar quando o usuário pedir 2x no chat)
  const selLojaId = "filtroOfensorLoja_" + wrapId;
  const selTimeId = "filtroOfensorTime_" + wrapId;
  const selClasseId = "filtroOfensorClasse_" + wrapId;

  // opções (valores “norm” para filtrar sem dor)
  const lojas = Array.from(new Set(rows.map(r => (r.loja || "").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const times = Array.from(new Set(rows.map(r => (r.time || "N/D").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  const classes = Array.from(new Set(rows.map(r => (r.classificacao || "—").toString().trim()).filter(Boolean)))
  .sort((a,b)=>a.localeCompare(b));

const optsClasses = ["<option value=''>Todas as classificações</option>"]
  .concat(classes.map(c => "<option value='" + c.replace(/'/g,"&#39;") + "'>" + c + "</option>"))
  .join("");


  const optsLojas = ["<option value=''>Todas as lojas</option>"]
    .concat(lojas.map(l => "<option value='" + l.replace(/'/g,"&#39;") + "'>" + l + "</option>"))
    .join("");

  const optsTimes = ["<option value=''>Todos os times</option>"]
    .concat(times.map(t => "<option value='" + t.replace(/'/g,"&#39;") + "'>" + t + "</option>"))
    .join("");

  // cabeçalho sticky (z-index alto)
  const thBase = "border:1px solid #000;padding:8px;background:#0b2a57;color:#fff;position:sticky;top:0;z-index:5;white-space:nowrap;";

  const TH_METRIC = "background:#ddf032;color:#080707;";

  function money(n){
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  function num(n){ return (Number(n)||0).toLocaleString("pt-BR"); }

  // ===== INSIGHTS (topo como saldo)
  let insights = "";
  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'><b>Período:</b> " +
    (periodo.inicio || "") + " a " + (periodo.fim || "") +
    "</p>";
  insights += "<div style='height:8px;'></div>";

  insights += "<p class='text-sm text-slate-700' style='margin:0; padding:0;'>" +
  "<b>Lojas ofensoras:</b> Ranking das lojas com maior volume e recorrência de pendências de justificativas do cartão (Clara). " +
  "As métricas representam pendências no período selecionado: " +
  "<b>Qtde</b> = total de pendências; <b>Valor</b> = soma do valor associado às pendências; " +
  "<b>Dias c/ pendência</b> = quantidade de dias distintos de transação com pendência; " +
  "<b>Etiqueta/NF/Descrição</b> = contagem por tipo de falha; " +
  "<b># Snapshots</b> = em quantas coletas diferentes a loja apareceu com pendência; " +
  "<b>Δ 14d</b> = variação do total de pendências nas últimas 2 semanas vs. 2 semanas anteriores; " +
  "<b>Score</b> = índice composto para priorização; <b>Classificação</b> = faixa do score." +
"</p>";
  insights += "<div style='height:10px;'></div>";

  // ===== FILTROS (com botão limpar)

  const filtrosHtml =
  "<div style='display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;'>" +

    // ===== Grupo Loja
    "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
      "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Loja:</b></label>" +
      "<select id='" + selLojaId + "' " +
              "onchange=\"window.vektorFiltrarLojasOfensoras('" + wrapId + "')\" " +
              "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
        optsLojas +
      "</select>" +
    "</div>" +

    // ===== Grupo Time
    "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
      "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Time:</b></label>" +
      "<select id='" + selTimeId + "' " +
              "onchange=\"window.vektorFiltrarLojasOfensoras('" + wrapId + "')\" " +
              "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
        optsTimes +
      "</select>" +
    "</div>" +

    // ===== Grupo Classificação  ✅ (label + select juntos)
    "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
      "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Classificação:</b></label>" +
      "<select id='" + selClasseId + "' " +
              "onchange=\"window.vektorFiltrarLojasOfensoras('" + wrapId + "')\" " +
              "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
        optsClasses +
      "</select>" +
    "</div>" +

    // ===== Botão Limpar
    "<button type='button' " +
            "onclick=\"window.vektorLimparFiltrosLojasOfensoras('" + wrapId + "')\" " +
            "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
      "Limpar" +
    "</button>" +

  "</div>";

  // ===== LINHAS (já com data-loja/data-time para filtro)
  let trs = "";
  rows.forEach(function(r){
    const loja = (r.loja || "").toString().trim();
    const time = (r.time || "N/D").toString().trim();

    // métricas (se o backend ainda não mandar alguma, mostramos 0/— sem quebrar layout)
    const qtde = Number(r.qtde) || 0;
    const valor = Number(r.valor) || 0;
    const diasCom = Number(r.diasComPendencia) || 0;

    const pendEtiqueta = Number(r.pendEtiqueta) || 0;
    const pendNF = Number(r.pendNF) || 0;
    const pendDesc = Number(r.pendDesc) || 0;

    const snapDias = (r.diasSnapshot != null) ? Number(r.diasSnapshot) : null;   // opcional
    const snaps = (r.qtdeSnapshots != null) ? Number(r.qtdeSnapshots) : null;   // opcional
    const delta14 = (r.delta14 != null) ? Number(r.delta14) : 0;               // opcional
    const delta14Pct = (r.delta14Pct != null && r.delta14Pct !== "") ? Number(r.delta14Pct) : null;
    const score = (r.score != null) ? Number(r.score) : null;                  // opcional
    const classe = (r.classificacao || "—").toString();                        // opcional

    const deltaAbsTxt = (delta14 > 0 ? "+" : "") + num(delta14);
    const deltaPctTxt = (delta14Pct == null)
    ? (delta14 > 0 ? "novo" : "—")   // se ant14=0 e ult14>0 => novo
    : ((delta14Pct > 0 ? "+" : "") + delta14Pct.toFixed(0) + "%");

    const variacaoTxt = (delta14 == null ? "—" : (deltaAbsTxt + " (" + deltaPctTxt + ")"));

    const pctTxt = (delta14Pct == null)
    ? (delta14 > 0 ? "novo" : "—")
    : ((delta14Pct > 0 ? "+" : "") + delta14Pct.toFixed(0) + "%");



  trs += "<tr data-loja='" + loja.replace(/'/g,"&#39;") + "' data-time='" + time.replace(/'/g,"&#39;") + "' data-classe='" + classe.replace(/'/g,"&#39;") + "'>" +
      "<td style='border:1px solid #000;padding:8px;white-space:nowrap;'>" + loja + "</td>" +
      "<td style='border:1px solid #000;padding:8px;white-space:nowrap;'>" + time + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(qtde) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;white-space:nowrap;'>" + money(valor) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(diasCom) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(pendEtiqueta) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(pendNF) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + num(pendDesc) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + (snaps == null ? "—" : num(snaps)) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;white-space:nowrap;'>" + variacaoTxt + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;white-space:nowrap;'>" + pctTxt + "</td>" +
      "<td style='border:1px solid #000;padding:8px;text-align:right;'>" + (score == null ? "—" : score.toFixed(1)) + "</td>" +
      "<td style='border:1px solid #000;padding:8px;font-weight:800;white-space:nowrap;'>" + classe + "</td>" +

    "</tr>";
  });

  const table =
    "<div id='" + wrapId + "' style='max-width:100%; overflow:auto; max-height:520px; padding:10px; border:1px solid #e5e7eb; border-radius:14px; background:#fff;'>" +
      insights +
      filtrosHtml +
      "<table style='min-width:1550px; width:100%; border-collapse:collapse;'>" +
        "<thead><tr>" +
          "<th style='" + thBase + "'>Loja</th>" +
          "<th style='" + thBase + "'>Time</th>" +
          "<th style='" + thBase + "'>Qtde</th>" +
          "<th style='" + thBase + "'>Valor (R$)</th>" +
          "<th style='" + thBase + "'>Dias c/ pendência</th>" +
          "<th style='" + thBase + "'>Etiqueta</th>" +
          "<th style='" + thBase + "'>NF/Recibo</th>" +
          "<th style='" + thBase + "'>Descrição</th>" +

          // HEADERS AMARELO ESCURO (4 COLUNAS)
          "<th style='" + thBase + ";" + TH_METRIC + "'># Snapshots</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>Variação - Δ 14d</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>% Var Δ 14d</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>Score</th>" +
          "<th style='" + thBase + ";" + TH_METRIC + "'>Classificação</th>" +
        "</tr></thead>" +
        "<tbody>" + trs + "</tbody>" +
      "</table>" +
      "<div style='text-align:right; margin-top:8px;'>" +
        "<button type='button' onclick=\"exportTableToCSV(this, 'lojas_ofensoras')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage("HTML:" + table);
}

function renderTabelaComparativoFaturas(res) {
  if (!res || !res.ok) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + (res && res.error ? res.error : "Falha ao consultar comparativo de faturas.") + "</p>");
    return;
  }

  const rows = res.rows || [];
  const periodo = res.periodo || {};
  if (!rows.length) {
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Sem dados para comparar fatura atual vs anterior.</p>");
    return;
  }

  const wrapId = "wrapComparativoFaturas_" + Date.now() + "_" + Math.floor(Math.random() * 1e6);
  const selLojaId = "filtroCompFatLoja_" + wrapId;
  const selTimeId = "filtroCompFatTime_" + wrapId;

  // opções
  const lojas = Array.from(new Set(rows.map(r => (r.loja || "").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const times = Array.from(new Set(rows.map(r => (r.time || "N/D").toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  const optsLojas = ["<option value=''>Todas as lojas</option>"]
    .concat(lojas.map(l => "<option value='" + l.replace(/'/g,"&#39;") + "'>" + l + "</option>"))
    .join("");

  const optsTimes = ["<option value=''>Todos os times</option>"]
    .concat(times.map(t => "<option value='" + t.replace(/'/g,"&#39;") + "'>" + t + "</option>"))
    .join("");

  // estilos
  const TH_BASE = "padding:8px;position:sticky;top:0;z-index:5;white-space:nowrap;background:#4F46E5;color:#000;border:3px double #fff;";
  const TD_BASE = "padding:8px;white-space:nowrap;border:1px solid #000;";

  const TH_CALC =
    "padding:8px;position:sticky;top:0;z-index:6;white-space:nowrap;" +
    "background:#005E27;color:#fff;border:3px double #fff;";

  function money(n){
    const v = Number(n) || 0;
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }

  // ===== SUMMARY (backend)
  const s = res.summary || {};
  const totalPrev0 = Number(s.totalPrev) || 0;
  const totalCur0  = Number(s.totalCur) || 0;
  const totalDelta0 = totalCur0 - totalPrev0;
  const totalVar0 = (totalPrev0 > 0)
    ? (((totalDelta0/totalPrev0*100) > 0 ? "+" : "") + (totalDelta0/totalPrev0*100).toFixed(1) + "%")
    : (totalCur0 > 0 ? "Início no período" : "—");

  // ===== INSIGHTS (topo)
  const ant = periodo.anterior || {};
  const atu = periodo.atual || {};

  let insights = "";
  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Período anterior:</b> " + (ant.inicio||"") + " a " + (ant.fim||"") +
    " — <b>Valor comparado:</b> <span id='cmpPrevTotal_" + wrapId + "'>" + money(totalPrev0) + "</span>" +
  "</p>";

  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Período atual:</b> " + (atu.inicio||"") + " a " + (atu.fim||"") +
    " — <b>Valor atual comparado:</b> <span id='cmpCurTotal_" + wrapId + "'>" + money(totalCur0) + "</span>" +
  "</p> <br>";

  const meta = res.meta || {};
  const ultData = (meta.ultimaDataConsiderada || "").toString().trim();

if (ultData) {
  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Nota:</b> O comparativo considera as transações da fatura atual registradas até <b>" + ultData + "</b>." +
  "</p>";
}

  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "<b>Variação total no período analisado:</b> " +
    "<span id='cmpDelta_" + wrapId + "'><b>" + (totalDelta0 >= 0 ? "+" : "") + money(totalDelta0) + "</b></span> " +
    "(<span id='cmpVarPct_" + wrapId + "'>" + totalVar0 + "</span>)" +
  "</p>";

  insights += "<div style='height:8px;'></div>";

  insights += "<p class='text-sm text-slate-700' style='margin:0;'>" +
    "A variação é calculada comparando o total do período da fatura atual vs o mesmo período da fatura anterior. " +
    "Quando o período anterior é zero e houve gasto no atual, a variação aparece como <b>Início no período</b> (percentual indefinido)." +
  "</p>";
  insights += "<div style='height:10px;'></div>";

  // ===== FILTROS
  const filtrosHtml =
    "<div style='display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;'>" +

      "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
        "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Loja:</b></label>" +
        "<select id='" + selLojaId + "' onchange=\"window.vektorFiltrarComparativoFaturas('" + wrapId + "')\" " +
          "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
          optsLojas +
        "</select>" +
      "</div>" +

      "<div style='display:flex; gap:8px; align-items:center; flex-wrap:nowrap;'>" +
        "<label style='font-size:13px;color:#334155;white-space:nowrap;'><b>Time:</b></label>" +
        "<select id='" + selTimeId + "' onchange=\"window.vektorFiltrarComparativoFaturas('" + wrapId + "')\" " +
          "style='font-size:12px;border:1px solid #CBD5E1;border-radius:10px;padding:6px 10px;background:#fff;min-width:220px;'>" +
          optsTimes +
        "</select>" +
      "</div>" +

      "<button type='button' onclick=\"window.vektorLimparFiltrosComparativoFaturas('" + wrapId + "')\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Limpar" +
      "</button>" +
    "</div>";

  // ===== LINHAS
  let trs = "";
  rows.forEach(function(r){
    const loja = (r.loja || "").toString().trim();
    const time = (r.time || "N/D").toString().trim();

    const vPrev = Number(r.valorAnterior) || 0;
    const vCur  = Number(r.valorAtual) || 0;
    const dVal  = Number(r.deltaValor) || 0;
    const varTxt= (r.variacaoPctTxt != null ? String(r.variacaoPctTxt) : "—");

    const cat = (r.categoriaDriver || "—").toString();
    const picoDia = (r.picoDia || "—").toString();
    const picoV = Number(r.picoValor) || 0;
    const fator = (r.fatorVariacao || "—").toString();

    trs += "<tr data-loja='" + loja.replace(/'/g,"&#39;") + "' " +
                "data-time='" + time.replace(/'/g,"&#39;") + "' " +
                "data-prev='" + String(vPrev) + "' " +
                "data-cur='" + String(vCur) + "'>" +
      "<td style='" + TD_BASE + "'>" + loja + "</td>" +
      "<td style='" + TD_BASE + "'>" + time + "</td>" +

      "<td style='" + TD_BASE + "text-align:right;'>" + money(vPrev) + "</td>" +
      "<td style='" + TD_BASE + "text-align:right;'>" + money(vCur) + "</td>" +
      "<td style='" + TD_BASE + "text-align:right;'>" + (dVal >= 0 ? "+" : "") + money(dVal) + "</td>" +
      "<td style='" + TD_BASE + "text-align:center;'>" + varTxt + "</td>" +

      "<td style='" + TD_BASE + "'>" + cat + "</td>" +
      "<td style='" + TD_BASE + "text-align:center;'>" + picoDia + "</td>" +
      "<td style='" + TD_BASE + "text-align:right;'>" + money(picoV) + "</td>" +
      "<td style='" + TD_BASE + "white-space:normal; min-width:420px;'>" + fator.replace(/</g,"&lt;").replace(/>/g,"&gt;") + "</td>" +
    "</tr>";
  });

  const table =
    "<div id='" + wrapId + "' style='max-width:100%; overflow:auto; max-height:520px; padding:10px; border:1px solid #e5e7eb; border-radius:14px; background:#fff;'>" +
      insights +
      filtrosHtml +
      "<table style='min-width:1850px; width:100%; border-collapse:collapse;'>" +
        "<thead><tr>" +
          "<th style='" + TH_BASE + "'>Loja</th>" +
          "<th style='" + TH_BASE + "'>Time</th>" +
          "<th style='" + TH_CALC + "'>Valor Per. Anterior</th>" +
          "<th style='" + TH_CALC + "'>Valor Per. Atual</th>" +
          "<th style='" + TH_CALC + "'>Δ Valor (R$)</th>" +
          "<th style='" + TH_CALC + "'>Variação (%)</th>" +
          "<th style='" + TH_BASE + "'>Categoria driver</th>" +
          "<th style='" + TH_BASE + "'>Pico (dia)</th>" +
          "<th style='" + TH_BASE + "'>Valor pico</th>" +
          "<th style='" + TH_BASE + "'>Fator Variação</th>" +
        "</tr></thead>" +
        "<tbody>" + trs + "</tbody>" +
      "</table>" +
      "<div style='text-align:right; margin-top:8px;'>" +
        "<button type='button' onclick=\"exportTableToCSV(this, 'comparativo_faturas')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>" +
    "</div>";

  renderBotMessage("HTML:" + table);

  // ===== 2ª mensagem: narrativa (usa summary do backend)
  try {
    const topCats = (s.topCats || []).slice(0,3);
    const topLojas = (s.topLojas || []).slice(0,3);

    const direcao = totalDelta0 > 0 ? "aumento" : (totalDelta0 < 0 ? "redução" : "estabilidade");
    const verbo = totalDelta0 > 0 ? "subiu" : (totalDelta0 < 0 ? "caiu" : "se manteve");

    let texto = "";
    texto += "<p class='text-base text-slate-700' style='margin:0;'><b>Leitura do período:</b></p><br>";
    texto += "<p class='text-sm text-slate-700' style='margin:0;'>" +
      "No recorte analisado, a fatura <b>" + verbo + "</b> de <b>" + money(totalPrev0) + "</b> para <b>" + money(totalCur0) + "</b>, " +
      "uma variação de <b>" + (totalDelta0 >= 0 ? "+" : "") + money(totalDelta0) + "</b> (" + totalVar0 + ")." +
      "</p>";

    const topDias = (s.topDias || []).slice(0,5);
    if (topDias.length) {
      const partesD = topDias.map(d => {
        const delta = Number(d.delta) || 0;
        return "<b>" + (d.dia || "—") + "</b>: " + (delta>=0?"+":"") + money(delta);
      });

      texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
        "Os dias que mais impactaram a variação (comparando o mesmo dia do ciclo anterior) foram: " +
        partesD.join(", ") + "." +
      "</p>";
    }

    if (topCats.length) {
      const partes = topCats.map(c => {
        const d = Number(c.delta) || 0;
        return "<b>" + (c.categoria || "—") + "</b> (" + (d>=0?"+":"") + money(d) + ")";
      });
      texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
        "O " + direcao + " foi explicado principalmente por " + partes.join(", ") + "." +
        "</p>";
    }

    if (topLojas.length) {
      const partesL = topLojas.map(r => {
        const d = Number(r.deltaValor) || 0;
        return "Loja <b>" + (r.loja || "") + "</b> (" + (r.time || "N/D") + ") <b>" + (d>=0?"+":"") + money(d) + "</b>";
      });
      texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
        "As maiores contribuições vieram de: " + partesL.join("; ") + "." +
        "</p>";
    }

    texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
      "Para detalhar por loja/time, aplique os filtros e leia o campo <b>Fator Variação</b>, que aponta a categoria driver, possível estabelecimento relevante e o dia de pico." +
      "</p>";

     // ===== Sazonalidade (se o backend mandou)
      const sazTxt = (s.sazonalidadeTexto || "").toString().trim();
      if (sazTxt) {
        texto += "<p class='text-sm text-slate-700' style='margin:8px 0 0 0;'>" +
          sazTxt.replace(/</g,"&lt;").replace(/>/g,"&gt;") +
        "</p>";
      }

    renderBotMessage("HTML:" + texto);
  } catch (e) {
    console.error("Erro ao renderizar resumo comparativo:", e);
  }
}

window.vektorFiltrarLojasOfensoras = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    // ✅ pega os selects desta instância (não do documento inteiro)
    var selLoja = wrap.querySelector("select[id^='filtroOfensorLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroOfensorTime_']");
    var selClasse = wrap.querySelector("select[id^='filtroOfensorClasse_']");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var timeVal = selTime ? (selTime.value || "").trim() : "";
    var classeVal = selClasse ? (selClasse.value || "").trim() : "";

    // ✅ agora também exige data-classe nas linhas
    var trs = wrap.querySelectorAll("tbody tr[data-loja][data-time][data-classe]");
    trs.forEach(function (tr) {
      var loja = (tr.getAttribute("data-loja") || "").trim();
      var time = (tr.getAttribute("data-time") || "").trim();
      var classe = (tr.getAttribute("data-classe") || "").trim();

      var okLoja = !lojaVal || loja === lojaVal;
      var okTime = !timeVal || time === timeVal;
      var okClasse = !classeVal || classe === classeVal;

      tr.style.display = (okLoja && okTime && okClasse) ? "" : "none";
    });
  } catch (e) {
    console.error("Erro ao filtrar lojas ofensoras:", e);
  }
};

window.vektorLimparFiltrosLojasOfensoras = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = wrap.querySelector("select[id^='filtroOfensorLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroOfensorTime_']");
    var selClasse = wrap.querySelector("select[id^='filtroOfensorClasse_']");

    if (selLoja) selLoja.value = "";
    if (selTime) selTime.value = "";
    if (selClasse) selClasse.value = "";

    window.vektorFiltrarLojasOfensoras(wrapId);
  } catch (e) {
    console.error("Erro ao limpar filtros lojas ofensoras:", e);
  }
};

window.vektorFiltrarComparativoFaturas = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    // money local (não depende do escopo da renderTabelaComparativoFaturas)
    function moneyLocal_(n){
      var v = Number(n) || 0;
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    var selLoja = wrap.querySelector("select[id^='filtroCompFatLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroCompFatTime_']");

    var lojaVal = selLoja ? (selLoja.value || "").trim() : "";
    var timeVal = selTime ? (selTime.value || "").trim() : "";

    // 1) filtra linhas
    var trs = wrap.querySelectorAll("tbody tr[data-loja][data-time]");
    trs.forEach(function(tr){
      var loja = (tr.getAttribute("data-loja") || "").trim();
      var time = (tr.getAttribute("data-time") || "").trim();

      var okLoja = !lojaVal || loja === lojaVal;
      var okTime = !timeVal || time === timeVal;

      tr.style.display = (okLoja && okTime) ? "" : "none";
    });

    // 2) calcula valores disponíveis nas linhas VISÍVEIS
    var lojasVisiveis = new Set();
    var timesVisiveis = new Set();

    trs.forEach(function(tr){
      if (tr.style.display === "none") return;
      lojasVisiveis.add((tr.getAttribute("data-loja") || "").trim());
      timesVisiveis.add((tr.getAttribute("data-time") || "").trim());
    });

    function atualizarSelect(selectEl, placeholder, valuesSet) {
      if (!selectEl) return;
      var atual = (selectEl.value || "").trim();

      var values = Array.from(valuesSet).filter(Boolean).sort(function(a,b){ return a.localeCompare(b); });

      var html = "<option value=''>" + placeholder + "</option>";
      values.forEach(function(v){
        var safe = v.replace(/'/g,"&#39;");
        html += "<option value='" + safe + "'>" + v + "</option>";
      });

      selectEl.innerHTML = html;

      // restaura seleção se ainda existir
      var aindaExiste = values.indexOf(atual) >= 0;
      selectEl.value = aindaExiste ? atual : "";
    }

    // 3) sincroniza dropdowns conforme resultado do filtro atual
    atualizarSelect(selLoja, "Todas as lojas", lojasVisiveis);
    atualizarSelect(selTime, "Todos os times", timesVisiveis);

    // 4) Recalcula totais conforme linhas visíveis (depois dos dropdowns estabilizarem)
    // (re-lê trs para garantir que está consistente)
    trs = wrap.querySelectorAll("tbody tr[data-loja][data-time]");

    var sumPrev = 0;
    var sumCur  = 0;

    trs.forEach(function(tr){
      if (tr.style.display === "none") return;
      sumPrev += Number(tr.getAttribute("data-prev")) || 0;
      sumCur  += Number(tr.getAttribute("data-cur")) || 0;
    });

    var delta = sumCur - sumPrev;

    var varTxt = (sumPrev > 0)
      ? (((delta / sumPrev * 100) > 0 ? "+" : "") + (delta / sumPrev * 100).toFixed(1) + "%")
      : (sumCur > 0 ? "Início no período" : "—");

    // Atualiza os valores no topo
    var elPrev  = document.getElementById("cmpPrevTotal_" + wrapId);
    var elCur   = document.getElementById("cmpCurTotal_" + wrapId);
    var elDelta = document.getElementById("cmpDelta_" + wrapId);
    var elVar   = document.getElementById("cmpVarPct_" + wrapId);

    if (elPrev)  elPrev.innerHTML  = moneyLocal_(sumPrev);
    if (elCur)   elCur.innerHTML   = moneyLocal_(sumCur);
    if (elDelta) elDelta.innerHTML = "<b>" + (delta >= 0 ? "+" : "") + moneyLocal_(delta) + "</b>";
    if (elVar)   elVar.innerHTML   = varTxt;

  } catch (e) {
    console.error("Erro ao filtrar comparativo faturas:", e);
  }
};

window.vektorLimparFiltrosComparativoFaturas = function (wrapId) {
  try {
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;

    var selLoja = wrap.querySelector("select[id^='filtroCompFatLoja_']");
    var selTime = wrap.querySelector("select[id^='filtroCompFatTime_']");

    if (selLoja) selLoja.value = "";
    if (selTime) selTime.value = "";

    // re-aplica para reconstituir dropdowns completos
    window.vektorFiltrarComparativoFaturas(wrapId);

  } catch (e) {
    console.error("Erro ao limpar filtros comparativo faturas:", e);
  }
};

// ========= Botões "Verificar pendências / justificativas" (tabelas de LOJAS) ========= //

function vektorMontarTabelaPendJust_(titulo, colunas, linhas) {
    // Se não vier nenhuma linha, mostra mensagem
    if (!linhas || !linhas.length) {
        return "<p class='text-sm text-slate-700'>Não encontrei registros para " +
               (titulo || "").toLowerCase() + " nesse período/seleção.</p>";
    }

    // Identifica se é tabela de pendências ou de justificativas pelo título
    var lowerTitulo  = (titulo || "").toLowerCase();
    var isPendencias = lowerTitulo.indexOf("pend") >= 0;

    // Cores
    var headerColor   = isPendencias ? "#B91C1C" : "#0F172A"; // vermelho / azul escuro
    var botaoCsvColor = "#005E27";                            // verde padrão Vektor

    // Cabeçalhos que SERÃO exibidos
    var colunasVisiveis;
    if (isPendencias) {
        // PENDÊNCIAS: Loja | Data | Valor | Pendências (coluna única)
        colunasVisiveis = [
            "Loja",
            "Data da Transação",
            "Valor (R$)",
            "Pendências"
        ];
    } else {
        // JUSTIFICATIVAS: formato original com 3 colunas separadas
        // Loja | Data | Valor | Etiqueta | Descrição | Recibo
        colunasVisiveis = [
            "Loja",
            "Data da Transação",
            "Valor (R$)",
            "Etiqueta",
            "Descrição",
            "Recibo"
        ];
    }

    var partes = [];

    // Container + tabela
    partes.push(
      "<div class='text-sm text-slate-700' style='max-width:1000px;margin:auto;'>",
        "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>", titulo, "</p>",
        "<div style='overflow-x:auto;'>",
          "<table border='1' cellspacing='0' cellpadding='8' " +
          "style='border-collapse:collapse;width:100%;font-size:13px;border:1px solid #000;'>"
    );

    // ===== Cabeçalho =====
    partes.push("<thead><tr style='background:" + headerColor + ";color:#fff;'>");

    colunasVisiveis.forEach(function (col) {

        // Ajuste de larguras APENAS na tabela de JUSTIFICATIVAS
        if (!isPendencias) {

            // Data da Transação — largura maior
            if (col === "Data da Transação") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:160px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Etiqueta — maior que Data
            if (col === "Etiqueta") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:260px;'>",
                  col,
                  "</th>"
                );
                return;
            }

            // Descrição — maior que Etiqueta
            if (col === "Descrição") {
                partes.push(
                  "<th style='border:1px solid #000;padding:6px;text-align:center;width:300px;'>",
                  col,
                  "</th>"
                );
                return;
            }
        }

        // Default para todas as outras colunas
        partes.push(
          "<th style='border:1px solid #000;padding:6px;text-align:center;'>",
          col,
          "</th>"
        );
    });

    partes.push("</tr></thead><tbody>");

    // IMPORTANTE: backend (Code.gs) monta cada linha como:
    // [0] Loja
    // [1] Data da Transação
    // [2] Valor (R$)
    // [3] Etiqueta
    // [4] Descrição
    // [5] Recibo
    linhas.forEach(function (row) {
        var loja      = row[0] != null ? String(row[0]) : "";
        var data      = row[1] != null ? String(row[1]) : "";
        var valorNum  = row[2] != null ? Number(row[2]) || 0 : 0;
        var etiqueta  = row[3] != null ? String(row[3]).trim() : "";
        var descricao = row[4] != null ? String(row[4]).trim() : "";
        var reciboRaw = row[5] != null ? String(row[5]).trim() : "";

        var valorFmt = valorNum.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL"
        });

        // Normaliza recibo para ver se é "não/nao"
        var reciboNorm = reciboRaw
            ? reciboRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase()
            : "";

        partes.push("<tr>");

        // Loja
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          loja,
          "</td>"
        );

        // Data
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          data,
          "</td>"
        );

        // Valor
        partes.push(
          "<td style='border:1px solid #000;padding:6px;'>",
          valorFmt,
          "</td>"
        );

        if (isPendencias) {
            // 🔴 TABELA DE PENDÊNCIAS: coluna única “Pendências”

            var pendencias = [];
            if (!etiqueta)  pendencias.push("Etiqueta");
            if (!descricao) pendencias.push("Descrição");
            if (reciboNorm === "nao" || reciboNorm === "não") {
                pendencias.push("Nota fiscal/Recibo");
            }

            var pendTexto = pendencias.length ? pendencias.join(", ") : "";

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              pendTexto,
              "</td>"
            );

        } else {
            // 🔵 TABELA DE JUSTIFICATIVAS: colunas separadas

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              etiqueta,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              descricao,
              "</td>"
            );

            partes.push(
              "<td style='border:1px solid #000;padding:6px;'>",
              reciboRaw,
              "</td>"
            );
        }

        partes.push("</tr>");
    });

    partes.push("</tbody></table></div>");

    // Botão CSV (igual ao resto do sistema)
    var nomeArquivo = isPendencias ? "pendencias_lojas" : "justificativas_lojas";

    partes.push(
      "<div style='margin-top:10px;text-align:right;'>",
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, '" + nomeArquivo + "')\" " +
          "style='background:" + botaoCsvColor + ";color:#fff;border:none;padding:8px 12px;" +
                 "border-radius:4px;font-size:12px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>",
      "</div>"
    );

    partes.push("</div>");

    return partes.join("");
}

function vektorMontarTabelaFaturas_(titulo, faturas) {
  if (!faturas || !faturas.length) {
    return "<p class='text-sm text-slate-700'>Não encontrei faturas na BaseClara.</p>";
  }

  var partes = [];

  partes.push(
    "<div class='text-sm text-slate-700' style='max-width:1000px;margin:12px auto 0;'>",
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>",
      // NOVA linha de orientação
    "<p style='margin-bottom:8px;text-align:center;font-size:13px;color:#000000;'>" +
      "Clique na linha da fatura para verificar o valor detalhado por times." +  
     "</p>" +  
     
     "<p style='margin-bottom:8px;text-align:center;font-size:13px;color:#000000;'>" +
  "E clique em <b>Extrair dados</b> para verificar o relatório de transações da fatura." +
    "</p>",
      "<div style='overflow-x:auto;'>",
        "<table border='1' cellspacing='0' cellpadding='8' " +
        "style='border-collapse:collapse;width:100%;font-size:13px;border:2px double #000;'>",
          "<thead>",
            "<tr style='background:#0F172A;color:#fff;'>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Fatura (período / extrato da conta)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Valor total (R$)</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Variação</th>",
              "<th style='border:2px double #000;padding:6px;text-align:center;'>Extração</th>",
            "</tr>",
          "</thead>",
          "<tbody>"
  );

  var somaTotal = 0;
  var valorAnterior = null;

  // ─ Insights: vamos guardar a MAIOR ALTA e a MAIOR QUEDA de uma fatura para a seguinte
  var maiorAumento = null; // { faturaAtual, variacao }
  var maiorQueda   = null; // { faturaAtual, variacao }

  faturas.forEach(function (f, idx) {
    var valor = Number(f.valorTotal) || 0;
    somaTotal += valor;

    var valorFmt = valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });

    // Calcula variação em relação à fatura anterior
    var variacaoTexto = "—";
    if (valorAnterior !== null && valorAnterior !== 0) {
      var variacao = ((valor - valorAnterior) / valorAnterior) * 100;
      var variacaoFmt = variacao.toFixed(1).replace(".", ",") + "%";

      if (variacao > 0) {
        variacaoTexto = "+" + variacaoFmt;
      } else {
        variacaoTexto = variacaoFmt;
      }

      // Atualiza maior aumento
      if (!maiorAumento || variacao > maiorAumento.variacao) {
        maiorAumento = {
          faturaAtual: f,
          variacao: variacao
        };
      }

      // Atualiza maior queda
      if (!maiorQueda || variacao < maiorQueda.variacao) {
        maiorQueda = {
          faturaAtual: f,
          variacao: variacao
        };
      }
    }

    // 🔽 linha clicável para drilldown por time (usando EXTRATO e período)

    // dentro do forEach das faturas, onde você faz partes.push("<tr ...>", "<td>...</td>", ...)

    partes.push(
  "<tr onclick=\"window.vektorDrillTimesFatura(this)\" " +
      "style='cursor:pointer;' " +
      "data-extrato-fatura='" + (f.extrato || "") + "' " +
      "data-inicio-fatura='" + (f.dataInicioIso || "") + "' " +
      "data-fim-fatura='" + (f.dataFimIso || "") + "'>",

    // TD 1 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o período desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      (f.extrato || "") +
    "</td>",

    // TD 2 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o período desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      valorFmt +
    "</td>",

    // TD 3 (com tooltip)
    "<td title=\"Clique para detalhar esta fatura por time, respeitando o período desse extrato.\" " +
        "style='border:2px double #000;padding:6px;text-align:center;'>" +
      variacaoTexto +
    "</td>",

    // TD 4 (SEM tooltip e SEM string quebrável)
"<td style='border:2px double #000;padding:6px;text-align:center;'>" +
  "<a href='#' title='' " +
     "data-extrato=\"" + encodeURIComponent(String(f.extrato || "")) + "\" " +
     "onclick=\"return window.vektorBaixarTransacoesFaturaLink(event, this); return false;\" " +
     "style='color:#005E27;font-weight:700;text-decoration:underline;'>" +
    "Extrair dados" +
  "</a>" +
"</td>",


  "</tr>"
);

    valorAnterior = valor;
  });

  // Linha de TOTAL
  var somaFmt = somaTotal.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL"
  });

  partes.push(
  "<tr style='background:#f1f5f9;font-weight:bold;'>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'>TOTAL</td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'>" + somaFmt + "</td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'></td>",
    "<td style='border:2px double #000;padding:6px;text-align:center;'></td>", // ✅ nova coluna
  "</tr>",
  "</tbody>",
  "</table>",
  "</div>"
);

  // ─────────────────────────────────────────────────────────────
  // BLOCO NOVO: comentários automáticos (insights) sobre as faturas
  // ─────────────────────────────────────────────────────────────
  var comentarios = [];

  // Só faz sentido falar de variação se tiver pelo menos 2 faturas
  if (faturas.length >= 2) {
    if (maiorAumento && maiorAumento.variacao > 0) {
      var pctAlta = Math.abs(maiorAumento.variacao).toFixed(1).replace(".", ",") + "%";
      var extratoAlta = maiorAumento.faturaAtual.extrato || "uma das faturas";

      comentarios.push(
        "A fatura <b>" + extratoAlta +
        "</b> teve o ⬆️ <b>maior aumento</b> em relação ao ciclo anterior, em torno de <b>" +
        pctAlta + "</b>."
      );
    }

    if (maiorQueda && maiorQueda.variacao < 0) {
      var pctQueda = Math.abs(maiorQueda.variacao).toFixed(1).replace(".", ",") + "%";
      var extratoQueda = maiorQueda.faturaAtual.extrato || "uma das faturas";

      comentarios.push(
        "A fatura <b>" + extratoQueda +
        "</b> teve a ⬇️ <b>maior redução</b> em relação ao ciclo anterior, cerca de <b>" +
        pctQueda + "</b>."
      );
    }
  }

  if (comentarios.length) {
    partes.push(
      "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
             "background:#F8FAFC;border-radius:4px;padding:6px;" +
             "border:1px solid #E2E8F0;'>",
        "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre as faturas:</b></p>",
        "<ul style='margin:0;padding-left:16px;'>",
          comentarios.map(function (c) {
            return "<li>" + c + "</li>";
          }).join(""),
        "</ul>",
      "</div>"
    );
  }

  // Botão de Exportar CSV (já existia)
  partes.push(
    "<div style='margin-top:8px;text-align:right;'>",
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'faturas_clara')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>",
        "⬇ Exportar CSV",
      "</button>",
    "</div>",

    "</div>"
  );

  return partes.join("");
}

// ===================================================================
// TÓPICO 3 – Insights automáticos: TIMES
// ===================================================================
function vektorGerarInsightsTimes(times) {
  if (!Array.isArray(times) || !times.length) return "";

  // Espera itens do tipo: { time: "Águias do Cerrado", valorTotal: 1234.56, total: 10 }
  // Se os nomes de campos forem outros, ajuste aqui.
  var lista = times
    .map(function (t) {
      return {
        nome: t.time || t.grupo || t.nome || "Time sem nome",
        valor: Number(t.valorTotal || t.valor || 0),
        qtd: Number(t.total || t.qtd || 0)
      };
    })
    .filter(function (t) {
      return t.valor > 0 || t.qtd > 0;
    });

  if (!lista.length) return "";

  var totalGeral = 0;
  lista.forEach(function (t) {
    totalGeral += t.valor;
  });
  if (!totalGeral) return "";

  // Ordena por valor desc
  lista.sort(function (a, b) {
    return b.valor - a.valor;
  });

  var top1 = lista[0];
  var top2 = lista[1] || null;
  var top3 = lista[2] || null;

  var comentarios = [];

  // Comentário 1: campeão de gastos
  var percTop1 = (top1.valor / totalGeral) * 100;
  comentarios.push(
    "O time <b>" + top1.nome +
    "</b> é o que mais gastou no período, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total."
  );

  // Comentário 2: concentração alta
  if (percTop1 >= 40) {
    comentarios.push(
      "Há uma <b>forte concentração</b> de gastos no time <b>" +
      top1.nome +
      "</b>. Vale avaliar se esse padrão faz sentido para o momento da operação."
    );
  }

  // Comentário 3: top 3
  if (top2 || top3) {
    var nomesTop = [top1.nome];
    if (top2) nomesTop.push(top2.nome);
    if (top3) nomesTop.push(top3.nome);

    comentarios.push(
      "Os principais responsáveis pelo volume de gastos são: <b>" +
      nomesTop.join("</b>, <b>") +
      "</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre os times:</b></p>" +
      "<ul id='insights-times-ul' style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// TÓPICO 3 – Insights automáticos: LOJAS
// ===================================================================
function vektorGerarInsightsRankingLojas(lojas) {
  if (!Array.isArray(lojas) || !lojas.length) return "";

  // Espera itens do tipo: { loja: "123 - SHOPPING X", valorTotal: 1234.56, total: 10 }
  // Ajuste os nomes dos campos se necessário.
  var lista = lojas
    .map(function (l) {
      return {
        nome: l.loja || l.nome || l.codigo || "Loja sem nome",
        valor: Number(l.valorTotal || l.valor || 0),
        qtd: Number(l.total || l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 || l.qtd > 0;
    });

  if (!lista.length) return "";

  var totalGeral = 0;
  lista.forEach(function (l) {
    totalGeral += l.valor;
  });
  if (!totalGeral) return "";

  // Ordena por valor desc
  lista.sort(function (a, b) {
    return b.valor - a.valor;
  });

  var top1 = lista[0];
  var top2 = lista[1] || null;
  var top3 = lista[2] || null;

  var comentarios = [];

  // Comentário 1: campeã
  var percTop1 = (top1.valor / totalGeral) * 100;
  comentarios.push(
    "A loja <b>" + top1.nome +
    "</b> concentra o maior volume de gastos no período, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total."
  );

  // Comentário 2: concentração alta
  if (percTop1 >= 35) {
    comentarios.push(
      "O nível de concentração em <b>" + top1.nome +
      "</b> é elevado. Pode valer a pena revisitar as despesas dessa unidade com mais atenção."
    );
  }

  // Comentário 3: top 3 lojas
  if (top2 || top3) {
    var nomesTop = [top1.nome];
    if (top2) nomesTop.push(top2.nome);
    if (top3) nomesTop.push(top3.nome);

    comentarios.push(
      "As lojas que mais impactam o resultado desse período são: <b>" +
      nomesTop.join("</b>, <b>") +
      "</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre as lojas:</b></p>" +
      "<ul id='insights-lojas-ul' style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// TÓPICO 4 – Insights automáticos: CATEGORIAS (ticket médio)
// ===================================================================
function vektorGerarInsightsResumoCategorias(itens) {
  if (!Array.isArray(itens) || !itens.length) return "";

  // filtra só quem tem valor e quantidade
  var lista = itens
    .map(function (l) {
      return {
        nome: l.nome || "Categoria sem nome",
        valor: Number(l.valor || 0),
        qtd: Number(l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 && l.qtd > 0;
    });

  if (lista.length < 2) return "";

  // calcula ticket médio
  lista.forEach(function (l) {
    l.media = l.valor / l.qtd;
  });

  // ordena por média (maior -> menor)
  lista.sort(function (a, b) {
    return b.media - a.media;
  });

  var top = lista[0];
  var bottom = lista[lista.length - 1];

  var comentarios = [];

  comentarios.push(
    "A categoria com <b>maior ticket médio</b> (valor médio por transação) é <b>" +
      top.nome +
      "</b>, com cerca de <b>" +
      top.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transação."
  );

  comentarios.push(
    "A categoria com <b>menor ticket médio</b> é <b>" +
      bottom.nome +
      "</b>, com cerca de <b>" +
      bottom.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transação."
  );

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
      "background:#F8FAFC;border-radius:4px;padding:6px;" +
      "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre as categorias:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// ===================================================================
// TÓPICO 5 – Insights automáticos: ESTABELECIMENTOS (ticket médio)
// ===================================================================
function vektorGerarInsightsResumoEstabelecimentos(itens) {
  if (!Array.isArray(itens) || !itens.length) return "";

  var lista = itens
    .map(function (l) {
      return {
        nome: l.nome || "Estabelecimento sem nome",
        valor: Number(l.valor || 0),
        qtd: Number(l.qtd || 0)
      };
    })
    .filter(function (l) {
      return l.valor > 0 && l.qtd > 0;
    });

  if (lista.length < 2) return "";

  lista.forEach(function (l) {
    l.media = l.valor / l.qtd;
  });

  lista.sort(function (a, b) {
    return b.media - a.media;
  });

  var top = lista[0];
  var bottom = lista[lista.length - 1];

  var comentarios = [];

  comentarios.push(
    "O estabelecimento com <b>maior ticket médio</b> é <b>" +
      top.nome +
      "</b>, com cerca de <b>" +
      top.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transação."
  );

  comentarios.push(
    "O estabelecimento com <b>menor ticket médio</b> é <b>" +
      bottom.nome +
      "</b>, com cerca de <b>" +
      bottom.media.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</b> por transação."
  );

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
      "background:#F8FAFC;border-radius:4px;padding:6px;" +
      "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre os estabelecimentos:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

function vektorGerarInsightsPendenciasLojas(linhas) {
  if (!Array.isArray(linhas) || !linhas.length) return "";

  // mapeia só o que precisamos
  var lista = linhas
    .map(function (l) {
      return {
        nome: l.loja || l.nome || "Loja sem nome",
        valorPend: Number(l.valorPendente || 0),
        perc: Number(l.percPendente || 0),
        qtd: Number(l.totalPendencias || 0)
      };
    })
    .filter(function (x) {
      return x.valorPend > 0 || x.qtd > 0;
    });

  if (!lista.length) return "";

  // ordena por valor pendente
  lista.sort(function (a, b) {
    if (b.valorPend !== a.valorPend) return b.valorPend - a.valorPend;
    return b.qtd - a.qtd;
  });

  var totalPend = lista.reduce(function (acc, x) {
    return acc + x.valorPend;
  }, 0);

  var top1 = lista[0];
  var top2 = lista[1] || null;

  var comentarios = [];

  // Loja campeã de pendências
  var percTop1 = totalPend > 0 ? (top1.valorPend / totalPend) * 100 : 0;
  comentarios.push(
    "A loja <b>" + top1.nome +
    "</b> concentra o maior volume de <b>valor pendente</b>, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total em pendências."
  );

  // Segunda loja (se existir)
  if (top2) {
    var percTop2 = totalPend > 0 ? (top2.valorPend / totalPend) * 100 : 0;
    comentarios.push(
      "Em seguida vem a loja <b>" + top2.nome +
      "</b>, com aproximadamente <b>" +
      percTop2.toFixed(1).replace(".", ",") +
      "%</b> do valor total pendente."
    );
  }

  // Loja com maior % de pendência sobre o próprio volume
  var listaComPerc = lista
    .filter(function (x) { return x.perc > 0; })
    .slice()
    .sort(function (a, b) {
      return b.perc - a.perc;
    });

  if (listaComPerc.length) {
    var campeaPerc = listaComPerc[0];
    comentarios.push(
      "A loja <b>" + campeaPerc.nome +
      "</b> apresenta a maior proporção de valor pendente em relação ao que transacionou no período (" +
      campeaPerc.perc.toFixed(1).replace(".", ",") + "%)."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre pendências por loja:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) {
          return "<li>" + c + "</li>";
        }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

// Drilldown: ao clicar numa fatura, detalha por TIME
window.vektorDrillTimesFatura = function (tr) {
  try {
    if (!tr) return;

    var extrato = tr.getAttribute("data-extrato-fatura") || "";
    var dataInicioIso = tr.getAttribute("data-inicio-fatura") || "";
    var dataFimIso = tr.getAttribute("data-fim-fatura") || "";

    extrato = extrato.trim();

    if (!extrato) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Não consegui identificar o extrato dessa fatura para detalhar por time.</p>"
      );
      return;
    }

    var periodoTexto = "";
    if (dataInicioIso || dataFimIso) {
      var ini = dataInicioIso ? new Date(dataInicioIso).toLocaleDateString("pt-BR") : "";
      var fim = dataFimIso ? new Date(dataFimIso).toLocaleDateString("pt-BR") : "";
      if (ini || fim) {
        periodoTexto = "Período: " + ini + (fim ? " até " + fim : "");
      }
    }

    // Mensagem de contexto no chat
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Detalhando a fatura <b>" + extrato +
        "</b> por <b>time</b>, considerando o mesmo ciclo do 'Extrato da conta'." +
        (periodoTexto ? "<br><span class='text-xs text-slate-500'>" + periodoTexto + "</span>" : "") +
      "</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !Array.isArray(res.times) || !res.times.length) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Não encontrei transações por time para essa fatura.</p>"
          );
          return;
        }

        // Reaproveita o renderizador padrão de resumo por time
        renderResumoTransacoesPorTime(res, {
          titulo: "Times dessa fatura",
          periodoTexto: periodoTexto
        });
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao detalhar fatura por time:", err);

              vektorRegistrarContexto({
                  ultimaIntencao: "fatura_times",
                  ultimoPeriodo: {
                    dataInicioIso: dataInicioIso || "",
                    dataFimIso: dataFimIso || ""
                  },
                  ultimaLoja: null,
                  ultimaAcaoExplicavel: {
                    tipo: "tabela_times_fatura",
                    meta: {
                      extrato: extrato,
                      periodoTexto: periodoTexto
                    }
                  }
                });

        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Ocorreu um erro ao buscar o detalhamento por time para essa fatura.</p>"
        );
      })
      .getResumoTransacoesPorTimeExtrato(extrato, "valor");  // usa EXTRATO
  } catch (e) {
    console.error("Erro em vektorDrillTimesFatura:", e);
  }
};

window.vektorBaixarTransacoesFaturaLink = function (ev, el) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation(); // ✅ impede disparar o onclick do <tr>
    }

    var extratoEnc = (el && el.getAttribute("data-extrato")) || "";
    var extrato = decodeURIComponent(extratoEnc || "");

    return window.vektorBaixarTransacoesFatura(ev, extrato);
  } catch (e) {
    console.error("Erro em vektorBaixarTransacoesFaturaLink:", e);
    return false;
  }
};

// ===============================
// DOWNLOAD — LOJAS COM PENDÊNCIAS (ciclo atual) — BaseClara FULL
// ===============================
window.vektorBaixarLojasComPendenciasCicloAtual = function (ev) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Gerando Excel apenas das <b>lojas com pendências</b> no ciclo atual, aguarde um momento.</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok || !res.xlsxBase64) {
          var msg = (res && res.error) ? res.error : "Não consegui gerar o Excel agora.";
          renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao exportar:</b> " + msg + "</p>");
          console.error("Resposta export XLSX (pendências ciclo):", res);
          return;
        }

        // base64 -> bytes
        var b64 = res.xlsxBase64;
        var byteChars = atob(b64);
        var byteNumbers = new Array(byteChars.length);
        for (var i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        var byteArray = new Uint8Array(byteNumbers);

        var blob = new Blob([byteArray], {
          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download = res.filename || "vektor_lojas_pendencias_ciclo_atual.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao exportar XLSX (pendências ciclo):", err);
        var msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>Erro ao gerar o Excel: " + msg + "</p>");
      })
      .exportarLojasComPendenciasCicloAtualXlsx(); // ✅ NOVA função no Code.gs
    return false;
  } catch (e) {
    console.error("Erro em vektorBaixarLojasComPendenciasCicloAtual:", e);
    return false;
  }
};

// ===============================
// E-MAIL — LOJAS COM PENDÊNCIAS (ciclo atual) — anexo XLSX
// ===============================
window.vektorEnviarLojasComPendenciasCicloAtualEmail = function (ev) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation();
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Enviando a listagem de <b>lojas com pendências</b> do ciclo atual para o seu e-mail, aguarde um momento.</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          var msg = (res && res.error) ? res.error : "Não consegui enviar o e-mail agora.";
          renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao enviar e-mail:</b> " + msg + "</p>");
          console.error("Resposta enviar e-mail (pendências ciclo):", res);
          return;
        }

        var to = (res && res.to) ? res.to : "seu e-mail";
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'><b>Pronto.</b> Enviei a listagem por e-mail para <b>" + to + "</b>.</p>"
        );
      })
      .withFailureHandler(function (err) {
        var msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'><b>Falha ao enviar e-mail:</b> " + msg + "</p>"
        );
      })
      .enviarLojasComPendenciasCicloAtualEmail(); // Code.gs
  } catch (e) {
    console.error("Erro em vektorEnviarLojasComPendenciasCicloAtualEmail:", e);
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao enviar e-mail agora.</p>");
  }
};

window.vektorBaixarTransacoesFatura = function (ev, extrato) {
  try {
    if (ev) {
      ev.preventDefault();
      ev.stopPropagation(); // ✅ evita disparar o drilldown da <tr>
    }

    extrato = (extrato || "").toString().trim();
    if (!extrato) {
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Não consegui identificar o extrato para exportar.</p>");
      return false;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Gerando arquivo em excel da fatura <b>" + extrato + " "
    );

    google.script.run
      .withSuccessHandler(function (res) {
                if (!res || !res.ok || !res.xlsxBase64) {
                var msg = (res && res.error) ? res.error : "Não consegui gerar o Excel dessa fatura.";
                renderBotMessage("HTML:<p class='text-sm text-slate-700'><b>Falha ao exportar:</b> " + msg + "</p>");
                console.error("Resposta export XLSX:", res);
                return;
              }

        // base64 -> bytes
        var b64 = res.xlsxBase64;
        var byteChars = atob(b64);
        var byteNumbers = new Array(byteChars.length);
        for (var i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        var byteArray = new Uint8Array(byteNumbers);

        var blob = new Blob([byteArray], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        var url = URL.createObjectURL(blob);

        var a = document.createElement("a");
        a.href = url;
        a.download = res.filename || "transacoes_fatura.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(function () { URL.revokeObjectURL(url); }, 1000);
      })
      .withFailureHandler(function (err) {
        console.error("Erro ao gerar CSV da fatura:", err);
        renderBotMessage("HTML:<p class='text-sm text-slate-700'>Erro ao gerar o CSV dessa fatura.</p>");
      })
      .exportarTransacoesFaturaXlsx(extrato);

    return false;
  } catch (e) {
    console.error("Erro em vektorBaixarTransacoesFatura:", e);
    return false;
  }
};


/**
 * Filtra a lista completa de faturas segundo o modo de pergunta.
 * modo: "atual" | "anterior" | "ultimas" | "todas"
 * qtd: número de faturas (quando modo = "ultimas")
 */

function vektorFiltrarFaturasPeloModo_(todas, modo, qtd) {
    if (!Array.isArray(todas) || !todas.length) return [];

        // 🔧 Ajuste de segurança:
    // Se o modo veio como "atual" mas temos uma quantidade maior que 1,
    // significa que em algum ponto a interpretação falhou.
    // Nesse caso, tratamos como "últimas N faturas".
    if (modo === "atual" && typeof qtd === "number" && qtd > 1) {
        modo = "ultimas";
    }

    // ---------------------------------------------------------
    // Função para converter "06 Nov 2025" → Date real
    // ---------------------------------------------------------
    function parseDataExt(dstr) {
        if (!dstr || typeof dstr !== "string") return null;
        // ex.: "06 Nov 2025"
        var m = dstr.trim().split(/\s+/);  // ["06","Nov","2025"]
        if (m.length !== 3) return null;

        var dia = Number(m[0]);
        var mes = m[1].toLowerCase();
        var ano = Number(m[2]);

        var mapaMes = {
            jan:0, feb:1, mar:2, apr:3, apr:3, mai:4, jun:5,
            jul:6, aug:7, set:8, sep:8, oct:9, out:9, nov:10, dec:11, dez:11
        };

        var mm = mapaMes[mes.substring(0,3)];
        if (mm === undefined) return null;

        return new Date(ano, mm, dia);
    }

    // ---------------------------------------------------------
    // Ordenar faturas REALMENTE por data de início
    // ---------------------------------------------------------
    var lista = todas.slice().sort(function (a, b) {
        var da = parseDataExt(a.dataInicio);
        var db = parseDataExt(b.dataInicio);
        if (!da || !db) return 0;
        return da - db;
    });

    var agora = new Date();

    // ---------------------------------------------------------
    // Identificar fatura "atual"
    // ---------------------------------------------------------
    var idxAtual = -1;
    for (var i = 0; i < lista.length; i++) {
        var ini = parseDataExt(lista[i].dataInicio);
        var fim = parseDataExt(lista[i].dataFim);
        if (ini && fim && ini <= agora && agora <= fim) {
            idxAtual = i;
            break;
        }
    }

    // fallback
    if (idxAtual === -1) idxAtual = lista.length - 1;

    // ---------------------------------------------------------
    // Modos
    // ---------------------------------------------------------
    if (modo === "todas") {
        return lista;
    }

    if (modo === "ultimas") {
        var n = Number(qtd) || 2;
        if (n >= lista.length) return lista;
        return lista.slice(lista.length - n);
    }

    if (modo === "anterior") {
        if (idxAtual > 0) {
            return [lista[idxAtual - 1]];
        } else {
            return [lista[idxAtual]];
        }
    }

    // padrão → atual
    return [lista[idxAtual]];
}

function vektorDiasAteFechamentoFaturaAtual() {
  const hoje = new Date();
  const dia = hoje.getDate();

  // fechamento sempre no dia 5
  let ano = hoje.getFullYear();
  let mes = hoje.getMonth(); // 0 = janeiro

  // Se já passou do dia 5, o próximo fechamento é no mês seguinte
  if (dia > 5) {
    mes += 1;
    if (mes > 11) {
      mes = 0;
      ano += 1;
    }
  }

  const fechamento = new Date(ano, mes, 5);

  const diffMs = fechamento.getTime() - hoje.getTime();
  const dias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  return Math.max(dias, 0); // não deixa negativo
}


function vektorChamarPendJustLojas_(tipo) {
    var periodo  = window.__vektorUltimoPeriodoIso || {};
    var grupo    = window.__vektorUltimoGrupoBaseClara || "";
    var lojas    = window.__vektorUltimasLojasTabela || [];

    var ini = periodo.inicio || "";
    var fim = periodo.fim    || "";

    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Não consegui consultar as " +
            "pendências/justificativas na planilha BaseClara.</p>"
          );

          // 🆕 Mesmo com erro → troca spinner por check
          try {
            var statusId = (tipo === "pendencias")
              ? "vektor-status-pendencias"
              : "vektor-status-justificativas";

            var statusEl = document.getElementById(statusId);
            if (statusEl) {
              statusEl.innerHTML =
                "<span style='font-size:13px;'>✅ Verificação concluída.</span>";
            }
          } catch (e) {}

          return;
        }

        var colunas = res.colunas || [];
        var html = "";

        if (tipo === "pendencias") {
          html = vektorMontarTabelaPendJust_(
            "PENDÊNCIAS DE JUSTIFICATIVAS POR LOJA",
            colunas,
            res.pendencias || []
          );
        } else {
          html = vektorMontarTabelaPendJust_(
            "TRANSAÇÕES COM JUSTIFICATIVA COMPLETA POR LOJA",
            colunas,
            res.justificadas || []
          );
        }

        // Envia tabela
        renderBotMessage("HTML:" + html);

        // 🆕 Troca spinner por check (caso de sucesso)
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>✅ Verificação concluída.</span>";
          }
        } catch (e) {}

      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as " +
          "pendências/justificativas na planilha.</p>"
        );

        // 🆕 Mesmo no erro → spinner vira check
        try {
          var statusId = (tipo === "pendencias")
            ? "vektor-status-pendencias"
            : "vektor-status-justificativas";

          var statusEl = document.getElementById(statusId);
          if (statusEl) {
            statusEl.innerHTML =
              "<span style='font-size:13px;'>✅ Verificação concluída.</span>";
          }
        } catch (e) {}

      })
      .getPendenciasEJustificativasPorLojas(
        grupo,
        ini,
        fim,
        lojas
      );
}

// ⚠ Botão "Verificar pendências"
window.vektorVerificarPendenciasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-pendencias' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando pendências das lojas dessa tabela no período informado...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('pendencias');
};

// ✔ Botão "Verificar justificativas"
window.vektorVerificarJustificativasLojas = function (btn) {
    renderBotMessage(
      "HTML:" +
      "<div id='vektor-status-justificativas' class='vektor-loading'>" +
        "<div class='vektor-spinner'></div>" +
        "<span>Verificando transações com justificativas feitas de forma correta...</span>" +
      "</div>"
    );

    vektorChamarPendJustLojas_('justificativas');
};

// Botão genérico para expandir a tabela de pendências consolidadas
window.vektorDrilldownPendenciasDetalhadas = function () {
  try {
    vektorChamarPendJustLojas_('pendencias');
  } catch (e) {
    console.warn("Erro ao abrir drilldown de pendências:", e);
  }
};




// RESUMO POR TIME INICIO //

function renderResumoTransacoesPorTime(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não consegui encontrar informações por <b>time</b> para esse período.</p>"
    );
    return;
  }

  opts = opts || {};

  // Texto base do critério (valor x quantidade)
  var criterioTxt = (resumo.criterio === "valor")
    ? "maior <b>valor total</b> de transações"
    : "maior <b>número</b> de transações";

  // Lista completa de times vinda do back-end
  var all = Array.isArray(resumo.times) ? resumo.times : [];

  // Há filtro explícito de times na pergunta? (ex.: "times X e Y")
  var temFiltroTimes = opts && Array.isArray(opts.filtrarTimesNomes) && opts.filtrarTimesNomes.length > 0;

  // 🔎 Filtro opcional por lista de times (nomes)
if (temFiltroTimes) {
  var alvoNorms = opts.filtrarTimesNomes.map(function (n) {
    return normalize(String(n));
  });

  all = all.filter(function (t) {
    var nomeNorm = normalize(String(t.time || ""));

    // Mantém o time se QUALQUER alvo “bater” como parte do nome
    return alvoNorms.some(function (alvo) {
      return (
        nomeNorm.indexOf(alvo) >= 0 ||   // ex.: "furacao sul csc" contém "furacao sul"
        alvo.indexOf(nomeNorm) >= 0      // ou o contrário, se o alvo for mais longo
      );
    });
  });
}

  // Quantas linhas exibir (para time: sem top => TODOS)
  var linhas = (typeof opts.topN === "number") ? all.slice(0, opts.topN) : all;

  // Somatórios com base no que será exibido
  var totalValor = 0, totalQtd = 0;
  for (var i = 0; i < linhas.length; i++) {
    totalValor += Number(linhas[i].valorTotal) || 0;
    totalQtd   += Number(linhas[i].total) || 0;
  }

  // ===== Recalcula o "top time" somente com base nas linhas filtradas =====
  var campoCriterio = (resumo.criterio === "quantidade") ? "total" : "valorTotal";
  var topItem = null;
  var topValor = -Infinity;

  for (var j = 0; j < linhas.length; j++) {
    var item = linhas[j];
    var v = Number(item[campoCriterio]) || 0;
    if (v > topValor) {
      topValor = v;
      topItem = item;
    }
  }

  // Monta a fraseResumo usando APENAS os times considerados na tabela
  var fraseResumo;
  if (!linhas.length || !topItem || topValor <= 0) {
    fraseResumo = temFiltroTimes
      ? "Não encontrei transações para os times informados no período selecionado."
      : "Não encontrei transações no período selecionado.";
  } else if (temFiltroTimes) {
    fraseResumo =
      "Entre os times <b>" +
      opts.filtrarTimesNomes.join(", ") +
      "</b>, o <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no período selecionado.";
  } else {
    // Comportamento padrão quando não há filtro de times (ranking geral)
    fraseResumo =
      "O <b>time " + (topItem.time || "") +
      "</b> foi o que teve " + criterioTxt + " no período selecionado.";
  }

  // ===== Montagem da tabela (mesmo padrão visual das outras) =====
  var linhasTabela = [];
  if (linhas.length) {

    // 🔽 Dropdown de drilldown para a tabela de TIMES
    linhasTabela.push(
      "<div style='margin-top:8px;margin-bottom:10px;font-size:12px;margin-bottom:4px;color:#334155;display:flex;align-items:center;gap:6px;'>" +
        "<span>Expandir a tabela por:</span>" +
        "<select class='vektor-drill-select' data-base='time' " +
               "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          "<option value='loja'>Lojas</option>" +
          "<option value='estabelecimento'>Estabelecimentos</option>" +
          "<option value='categoria'>Categorias</option>" +
        "</select>" +
      "</div>"
    );

    // Tabela no padrão azul / borda igual às demais
    linhasTabela.push(
      "<table border='1' cellspacing='0' cellpadding='6' " +
      "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
      "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
    );
    linhasTabela.push(
      "<tr style='background:#06167d;color:#fff'>" +
        "<th style='border:1px solid #000;'>Time</th>" +
        "<th style='border:1px solid #000;'>Transações</th>" +
        "<th style='border:1px solid #000;'>% Transações</th>" +
        "<th style='border:1px solid #000;'>Valor (R$)</th>" +
        "<th style='border:1px solid #000;'>% Valor</th>" +
      "</tr>"
    );

    // Linhas de times
    for (var k = 0; k < linhas.length; k++) {
      var t = linhas[k];
      var qtd = Number(t.total) || 0;
      var val = Number(t.valorTotal) || 0;

      var pctQtd = (totalQtd > 0)   ? ((qtd / totalQtd)   * 100).toFixed(1) + "%" : "—";
      var pctVal = (totalValor > 0) ? ((val / totalValor) * 100).toFixed(1) + "%" : "—";

      var hint =
        "Clique para detalhar este time pela dimensão selecionada (lojas, categorias ou estabelecimentos), " +
        "respeitando o mesmo período da pergunta inicial.";

      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this, 'time')\" " +
            "style='cursor:pointer;' " +
            "title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + (t.time || "") + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }

    // TOTAL
    linhasTabela.push(
      "<tr style='font-weight:bold;background:#f2f2f2;'>" +
        "<td style='border:1px solid #000;'>TOTAL</td>" +
        "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
        "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "—") + "</td>" +
        "<td style='border:1px solid #000;'>" +
          totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "—") + "</td>" +
      "</tr>"
    );

    linhasTabela.push("</table>");
  }

  var tabelaHtml = linhasTabela.join("");

    // 🆕 Insights automáticos sobre os times (TÓPICO 3)
  var insightsTimesHtml = vektorGerarInsightsTimes(linhas || []);


  // 🔽 Botão de exportação em CSV para o resumo por TIME
  var botaoCsv = "";
  if (tabelaHtml) {
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'transacoes_times')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>";
  }

  // Mantendo o lookerUrl como no seu código original (se quiser usar depois)
  var lookerUrl = "https://lookerstudio.google.com/u/0/reporting/58cacb07-6ece-45cb-a42a-15f328c5710d/page/uOaeF";

  var html = [
    "<div class='text-sm text-slate-700'>",
      "<p>", fraseResumo, "</p>",
      //"<p style='font-size:13px;color:#555;margin:4px 0 8px;'>Clique em uma linha para detalhar (drill-down) no chat.</p>",
      tabelaHtml,
      insightsTimesHtml || "",
      botaoCsv,
    "</div>"
  ].join("");

  renderBotMessage("HTML:" + html);
}

function vektorRenderTabelaPendenciasPorLoja(resumo, dataInicioIso, dataFimIso) {
  var linhas = (resumo && resumo.linhas) || [];
  var totais = (resumo && resumo.totais) || {};
  var grupo  = resumo && (resumo.grupoOriginal || resumo.grupo) || "";

  // Guarda contexto para o drilldown
  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioIso || "",
    fim:    dataFimIso    || ""
  };
  window.__vektorUltimoGrupoBaseClara = grupo || "";
  window.__vektorUltimasLojasTabela = linhas.map(function (l) {
    return (l.loja || "").toString();
  });

  var linhasHtml = [];

    // Frase principal
  var fraseResumo = "Tabela consolidada de pendências por loja" +
    (grupo ? " do time <b>" + grupo + "</b>" : "") +
    ".";
  linhasHtml.push("<p>" + fraseResumo + "</p>");

  // Garante período: usa parâmetros se existirem,
  // senão usa o que estiver salvo no contexto global.
  var iniIso = dataInicioIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio) ||
    "";
  var fimIso = dataFimIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.fim) ||
    "";

  var frasePeriodo = vektorFraseResumoPeriodo(iniIso, fimIso);
  if (frasePeriodo) {
    linhasHtml.push(
      "<p style='margin-top:2px;font-size:11px;color:#475569;'>" +
      frasePeriodo +
      "</p>"
    );
  }

  // linha em branco
  linhasHtml.push("<div style='height:8px;'></div>");

  // Botão centralizado de drilldown (usa fluxo padrão de pendências)
  linhasHtml.push(
    "<div style='text-align:center;margin-bottom:8px;'>" +
      "<button type='button' " +
        "onclick=\"vektorVerificarPendenciasLojas()\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;" +
               "border-radius:4px;font-size:12px;cursor:pointer;'>" +
        "🔍 Ver detalhamento das transações pendentes" +
      "</button>" +
    "</div>"
  );

  // Espaço entre botão e tabela
  linhasHtml.push("<div style='height:8px;'></div>");

  // Tabela
  linhasHtml.push("<div style='overflow-x:auto;'>");
  linhasHtml.push("<table style='border-collapse:collapse;width:100%;font-size:12px;'>");

  linhasHtml.push(
    "<thead><tr>" +
      // 4 primeiras colunas: verde claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Loja</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Qtd Transações Pendentes</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Valor Total Pendente (R$)</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>% do Valor Pendente</th>" +
      // 3 colunas de tipo de pendência: vermelho claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pendências: Etiqueta</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pendências: Descrição</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pendências: Nota fiscal/Recibo</th>" +
    "</tr></thead><tbody>"
  );

  var totalValPend = 0;
  var totalValTrans = 0;

  linhas.forEach(function (l) {
    var loja          = l.loja || "";
    var qtdPend       = Number(l.totalPendencias || 0);
    var valorPend     = Number(l.valorPendente || 0);
    var percPend      = Number(l.percPendente || 0);
    var pendEtiq      = Number(l.pendEtiqueta || 0);
    var pendDesc      = Number(l.pendDescricao || 0);
    var pendRec       = Number(l.pendRecibo || 0);

    totalValPend  += valorPend;
    totalValTrans += Number(l.valorTransacionado || 0);

    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + loja + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + qtdPend + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          valorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          (percPend > 0 ? percPend.toFixed(1).replace(".", ",") + "%" : "—") +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendEtiq + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendDesc + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendRec + "</td>" +
      "</tr>"
    );
  });

  var totQtdPend   = Number(totais.totalPendencias || 0);
  var totValorPend = Number(totais.valorPendente || 0);
  var totEtiq      = Number(totais.pendEtiqueta || 0);
  var totDesc      = Number(totais.pendDescricao || 0);
  var totRec       = Number(totais.pendRecibo || 0);
  var totValTrans  = Number(totais.valorTransacionado || 0);

  var percGeral = 0;
  if (totValTrans > 0 && totValorPend > 0) {
    percGeral = (totValorPend / totValTrans) * 100;
  }

  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totQtdPend + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        totValorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        (percGeral > 0 ? percGeral.toFixed(1).replace(".", ",") + "%" : "—") +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totEtiq + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totDesc + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totRec + "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  var tabelaHtml = linhasHtml.join("");
  var insightsHtml = vektorGerarInsightsPendenciasLojas(linhas);

  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'pendencias_por_loja')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      tabelaHtml +
      (insightsHtml || "") +
      botoesHtml +
    "</div>";

  return html;
}

// Chamada ao Apps Script
function vektorMostrarPendenciasLojasDoTime(grupo, dataInicioIso, dataFimIso) {
  // Se não veio período explícito, usamos últimos 30 dias
  var inicio = dataInicioIso;
  var fim = dataFimIso;

  if (!inicio || !fim) {
    var hoje = new Date();
    var fimDate = hoje;
    var iniDate = new Date();
    iniDate.setDate(hoje.getDate() - 30);

    inicio = iniDate.toISOString();
    fim = fimDate.toISOString();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou montar a tabela de <b>pendências por loja</b> do time <b>" +
    (grupo || "") + "</b> no período informado...</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.ok) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Não consegui consolidar as pendências por loja na BaseClara.</p>"
        );
        return;
      }

      var htmlTabela = vektorRenderTabelaPendenciasPorLoja(res, inicio, fim);
      renderBotMessage("HTML:" + htmlTabela);
    })
    .withFailureHandler(function (err) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as pendências por loja na BaseClara.</p>"
      );
      console.error(err);
    })
    .getResumoPendenciasPorLoja(
      grupo || "",
      inicio || "",
      fim || ""
    );
}

function vektorGerarInsightsPendenciasTimes(linhas) {
  if (!Array.isArray(linhas) || !linhas.length) return "";

  var lista = linhas
    .map(function (t) {
      return {
        nome: t.time || t.grupo || "Time sem nome",
        valorPend: Number(t.valorPendente || 0),
        perc: Number(t.percPendente || 0),
        qtd: Number(t.totalPendencias || 0)
      };
    })
    .filter(function (x) {
      return x.valorPend > 0 || x.qtd > 0;
    });

  if (!lista.length) return "";

  lista.sort(function (a, b) {
    if (b.valorPend !== a.valorPend) return b.valorPend - a.valorPend;
    return b.qtd - a.qtd;
  });

  var totalPend = lista.reduce(function (acc, x) { return acc + x.valorPend; }, 0);

  var top1 = lista[0];
  var top2 = lista[1] || null;

  var comentarios = [];

  var percTop1 = totalPend > 0 ? (top1.valorPend / totalPend) * 100 : 0;
  comentarios.push(
    "O time <b>" + top1.nome +
    "</b> concentra o maior valor em pendências, com cerca de <b>" +
    percTop1.toFixed(1).replace(".", ",") + "%</b> do total pendente."
  );

  if (top2) {
    var percTop2 = totalPend > 0 ? (top2.valorPend / totalPend) * 100 : 0;
    comentarios.push(
      "Na sequência, o time <b>" + top2.nome +
      "</b> responde por aproximadamente <b>" +
      percTop2.toFixed(1).replace(".", ",") +
      "%</b> do valor pendente."
    );
  }

  var listaComPerc = lista
    .filter(function (x) { return x.perc > 0; })
    .slice()
    .sort(function (a, b) { return b.perc - a.perc; });

  if (listaComPerc.length) {
    var campeaoPerc = listaComPerc[0];
    comentarios.push(
      "O time <b>" + campeaoPerc.nome +
      "</b> tem a maior proporção de valor pendente sobre o que transacionou no período<b> (" +
      campeaoPerc.perc.toFixed(1).replace(".", ",") + "%)</b>."
    );
  }

  if (!comentarios.length) return "";

  var html =
    "<div style='margin-top:8px;font-size:12px;color:#0F172A;" +
           "background:#F8FAFC;border-radius:4px;padding:6px;" +
           "border:1px solid #E2E8F0;'>" +
      "<p style='margin:0 0 4px 0;'><b>Insights automáticos sobre pendências por time:</b></p>" +
      "<ul style='margin:0;padding-left:16px;'>" +
        comentarios.map(function (c) { return "<li>" + c + "</li>"; }).join("") +
      "</ul>" +
    "</div>";

  return html;
}

function vektorRenderTabelaPendenciasPorTime(resumo, dataInicioIso, dataFimIso) {
  var linhas = (resumo && resumo.linhas) || [];
  var totais = (resumo && resumo.totais) || {};

  window.__vektorUltimoPeriodoIso = {
    inicio: dataInicioIso || "",
    fim:    dataFimIso    || ""
  };
  window.__vektorUltimoGrupoBaseClara = "";
  window.__vektorUltimasLojasTabela = [];

  var linhasHtml = [];

  // Frase principal
  linhasHtml.push("<p>Tabela consolidada de pendências por time.</p>");

  // Período: parâmetros (se existirem) OU contexto global
  var iniIso = dataInicioIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.inicio) ||
    "";
  var fimIso = dataFimIso ||
    (window.__vektorUltimoPeriodoIso && window.__vektorUltimoPeriodoIso.fim) ||
    "";

  var frasePeriodo = vektorFraseResumoPeriodo(iniIso, fimIso);
  if (frasePeriodo) {
    linhasHtml.push(
      "<p style='margin-top:2px;font-size:11px;color:#475569;'>" +
      frasePeriodo +
      "</p>"
    );
  }

  linhasHtml.push("<div style='height:8px;'></div>");

  // Botão de drilldown (usa fluxo padrão de pendências)
  linhasHtml.push(
    "<div style='text-align:center;margin-bottom:8px;'>" +
      "<button type='button' " +
        "onclick=\"vektorVerificarPendenciasLojas()\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:6px 12px;" +
               "border-radius:4px;font-size:12px;cursor:pointer;'>" +
        "🔍 Ver detalhamento das transações pendentes" +
      "</button>" +
    "</div>"
  );

  linhasHtml.push("<div style='height:8px;'></div>");

  linhasHtml.push("<div style='overflow-x:auto;'>");
  linhasHtml.push("<table style='border-collapse:collapse;width:100%;font-size:12px;'>");

  linhasHtml.push(
    "<thead><tr>" +
      // colunas "gerais" em verde
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Time</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Qtd Transações Pendentes</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>Valor Total Pendente (R$)</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#B5FF20;color:#000;'>% do Valor Pendente</th>" +
      // colunas de tipos em vermelho claro
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pendências: Etiqueta</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pendências: Descrição</th>" +
      "<th style='border:1px solid #000;padding:4px;text-align:center;background:#FFB3B3;color:#000;'>Pendências: Nota fiscal/Recibo</th>" +
    "</tr></thead><tbody>"
  );

  linhas.forEach(function (t) {
    var nome         = t.time || t.grupo || "";
    var qtdPend      = Number(t.totalPendencias || 0);
    var valorPend    = Number(t.valorPendente || 0);
    var percPend     = Number(t.percPendente || 0);
    var pendEtiq     = Number(t.pendEtiqueta || 0);
    var pendDesc     = Number(t.pendDescricao || 0);
    var pendRec      = Number(t.pendRecibo || 0);

    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + nome + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + qtdPend + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          valorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
          (percPend > 0 ? percPend.toFixed(1).replace(".", ",") + "%" : "—") +
        "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendEtiq + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendDesc + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + pendRec + "</td>" +
      "</tr>"
    );
  });

  var totQtdPend   = Number(totais.totalPendencias || 0);
  var totValorPend = Number(totais.valorPendente || 0);
  var totEtiq      = Number(totais.pendEtiqueta || 0);
  var totDesc      = Number(totais.pendDescricao || 0);
  var totRec       = Number(totais.pendRecibo || 0);
  var totValTrans  = Number(totais.valorTransacionado || 0);

  var percGeral = 0;
  if (totValTrans > 0 && totValorPend > 0) {
    percGeral = (totValorPend / totValTrans) * 100;
  }

  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>TOTAL</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totQtdPend + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        totValorPend.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" +
        (percGeral > 0 ? percGeral.toFixed(1).replace(".", ",") + "%" : "—") +
      "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totEtiq + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totDesc + "</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + totRec + "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  var tabelaHtml = linhasHtml.join("");
  var insightsHtml = vektorGerarInsightsPendenciasTimes(linhas);

  var botoesHtml = "";
  if (tabelaHtml) {
    botoesHtml =
      "<div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'pendencias_por_time')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>";
  }

  var html =
    "<div class='text-sm text-slate-700'>" +
      tabelaHtml +
      (insightsHtml || "") +
      botoesHtml +
    "</div>";

  return html;
}

function vektorMostrarPendenciasPorTimeTodos(dataInicioIso, dataFimIso) {
  var inicio = dataInicioIso;
  var fim = dataFimIso;

  if (!inicio || !fim) {
    var hoje = new Date();
    var fimDate = hoje;
    var iniDate = new Date();
    iniDate.setDate(hoje.getDate() - 30);

    inicio = iniDate.toISOString();
    fim = fimDate.toISOString();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Vou montar a tabela de <b>pendências por time</b> para o período informado...</p>"
  );

  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.ok) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Não consegui consolidar as pendências por time na BaseClara.</p>"
        );
        return;
      }

      var htmlTabela = vektorRenderTabelaPendenciasPorTime(res, inicio, fim);
      renderBotMessage("HTML:" + htmlTabela);
    })
    .withFailureHandler(function (err) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as pendências por time na BaseClara.</p>"
      );
      console.error(err);
    })
    .getResumoPendenciasPorTime(
      inicio || "",
      fim || "",
      "" // todos os times
    );
}

// ===== RENDER: Maiores transações individuais (loja / time) =====
function renderMaioresTransacoesIndividuais(res) {
  if (!res || res.ok === false) {
    var msgErro = (res && res.error) ? res.error : "Erro desconhecido ao consultar as maiores transações.";
    renderBotMessage("HTML:<p class='text-sm text-red-700'>" + msgErro + "</p>");
    return;
  }

  var linhas = Array.isArray(res.linhas) ? res.linhas : [];
  var loja   = res.loja  || "";
  var grupo  = res.grupo || "";
  var topN   = res.topN  || null;

  var periodoDescricao   = res.periodoDescricao || "";
  var dataInicioIso      = res.dataInicioIso || "";
  var dataFimIso         = res.dataFimIso    || "";
  var totalSelecionadas  = Number(res.totalSelecionadas || 0);

  // Se não houver linhas
  if (!linhas.length) {
    var msgVazio = "Não encontrei transações no período selecionado ";
    if (loja)  msgVazio += "para a loja <b>" + loja + "</b> ";
    if (grupo) msgVazio += "do time <b>" + grupo + "</b> ";
    if (periodoDescricao) {
      msgVazio += "(" + periodoDescricao + ").";
    } else {
      msgVazio += ".";
    }
    renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + msgVazio + "</p>");
    return;
  }

  var titulo = "Maiores transações individuais";
  if (loja)  titulo += " - Loja " + loja;
  if (grupo) titulo += (loja ? " | " : " - ") + "Time " + grupo;
  if (topN) {
    titulo += " (Top " + topN + ")";
  }

  var linhasHtml = [];

  linhasHtml.push("<div class='text-sm text-slate-700'>");
  linhasHtml.push("<p style='margin:0 0 4px 0;'><b>" + titulo + "</b></p>");

  if (periodoDescricao) {
    linhasHtml.push(
      "<p style='margin:0 0 8px 0;font-size:12px;color:#334155;'>" +
        "Período da consulta: " + periodoDescricao + "." +
      "</p>"
    );
  } else if (dataInicioIso && dataFimIso) {
    var frasePeriodo = vektorFraseResumoPeriodo(dataInicioIso, dataFimIso);
    if (frasePeriodo) {
      linhasHtml.push(
        "<p style='margin:0 0 8px 0;font-size:12px;color:#334155;'>" +
          "Período da consulta: " + frasePeriodo + "." +
        "</p>"
      );
    }
  }

  // Tabela
  linhasHtml.push(
    "<table border='1' cellspacing='0' cellpadding='4' " +
      "style='border-collapse:collapse;width:100%;font-size:12px;text-align:center;border:1px solid #000;'>"
  );

  // Cabeçalho
  linhasHtml.push(
    "<thead>" +
      "<tr style='background:#06167d;color:#fff;'>" +
        "<th style='border:1px solid #000;padding:4px;'>Loja</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Estabelecimento</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Data</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Status</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Categoria</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Titular</th>" +
        "<th style='border:1px solid #000;padding:4px;'>Valor (R$)</th>" +
      "</tr>" +
    "</thead><tbody>"
  );

      // Linhas da tabela
    for (var i = 0; i < linhas.length; i++) {
      var l = linhas[i] || {};
      var lojaVal     = l.loja || "";
      var estabVal    = l.estabelecimento || "";
      var dataVal     = l.data || "";
      var statusVal   = l.status || "";
      var categoriaVal= l.categoria || "";
      var titularVal  = l.titular || "";
      var valorVal    = Number(l.valor || 0);

      linhasHtml.push(
        "<tr>" +
          "<td style='border:1px solid #000;padding:4px;'>" + lojaVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + estabVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + dataVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + statusVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + categoriaVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" + titularVal + "</td>" +
          "<td style='border:1px solid #000;padding:4px;'>" +
            valorVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
        "</tr>"
      );
    }

  // Linha de TOTAL no final da coluna de valor
  linhasHtml.push(
    "<tr style='background:#e5e7eb;font-weight:bold;'>" +
      "<td colspan='6' style='border:1px solid #000;padding:4px;text-align:right;'>Total</td>" +
      "<td style='border:1px solid #000;padding:4px;'>" +
        totalSelecionadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table>");

  // Botão Exportar CSV ABAIXO da tabela
  linhasHtml.push(
    "<div style='margin-top:6px;text-align:right;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'maiores_transacoes_individuais')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "⬇ Exportar CSV" +
      "</button>" +
    "</div>"
  );

  linhasHtml.push("</div>");

  var html = linhasHtml.join("");

  try { ultimaIntencao = "maiores_transacoes_individuais"; } catch (e) {}

  renderBotMessage("HTML:" + html);
}

function vektorRenderTransacoesPorCategoria(res, nomeCategoria) {
  if (!res || !res.ok) {
    return "<p class='text-sm text-slate-700'>Não consegui montar a tabela de transações dessa categoria.</p>";
  }

  var linhas = res.linhas || [];
  var dataInicioIso = res.dataInicioIso || "";
  var dataFimIso    = res.dataFimIso || "";
  var total = Number(res.total || 0);

  // Se não tiver linhas
  if (!linhas.length) {
    return (
      "<p class='text-sm text-slate-700'>" +
        "Não encontrei transações para a categoria <b>" + (nomeCategoria || "") +
        "</b> nesse período." +
      "</p>"
    );
  }

  // Período em dd/MM/yyyy
  var periodoHtml = "";
  try {
    if (dataInicioIso && dataFimIso) {
      var di = new Date(dataInicioIso);
      var df = new Date(dataFimIso);
      var diBr = di.toLocaleDateString("pt-BR");
      var dfBr = df.toLocaleDateString("pt-BR");
      periodoHtml =
        "<p class='text-xs text-slate-500 mt-1'>" +
          "Período da consulta: de " + diBr + " a " + dfBr + "." +
        "</p>";
    }
  } catch (e) {
    console.error("Erro ao formatar período em vektorRenderTransacoesPorCategoria:", e);
  }

  var linhasHtml = [];

  linhasHtml.push(
    "<p class='mb-1'>Transações da categoria <b>" + (nomeCategoria || "") + "</b>.</p>" +
    periodoHtml
  );

  linhasHtml.push("<div style='overflow-x:auto;margin-top:4px;'>");

  // ✅ Valor (R$) movido para a ÚLTIMA coluna
  linhasHtml.push(
    "<table style='border-collapse:collapse;width:100%;font-size:12px;'>" +
      "<thead><tr>" +
        "<th style='border:1px solid #000;padding:4px;text-align:center;background:#E5E7EB;'>Loja</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Transação</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:center;background:#E5E7EB;'>Data</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Titular</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#E5E7EB;'>Grupos</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Recibo</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Etiquetas</th>" +
        "<th style='border:1px solid #000;padding:4px;text-align:left;background:#FECACA;color:#7F1D1D;font-weight:700;'>Descrição</th>" +

        "<th style='border:1px solid #000;padding:4px;text-align:right;background:#E5E7EB;'>Valor (R$)</th>" +
      "</tr></thead><tbody>"
  );

  for (var i = 0; i < linhas.length; i++) {
    var l = linhas[i] || {};
    var loja  = l.loja || "";
    var trans = l.transacao || "";
    var data  = l.data || "";
    var val   = Number(l.valor || 0);

    var titular   = l.titular || "";
    var grupos    = l.grupos || "";
    var recibo    = l.recibo || "";
    var etiquetas = l.etiquetas || "";
    var descricao = l.descricao || "";

    // ✅ Valor movido para o ÚLTIMO <td>
    linhasHtml.push(
      "<tr>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + loja + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + trans + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:center;'>" + data + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + titular + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + grupos + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + recibo + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + etiquetas + "</td>" +
        "<td style='border:1px solid #000;padding:4px;text-align:left;'>" + descricao + "</td>" +

        "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
          val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
      "</tr>"
    );
  }

  // Linha TOTAL (colspan continua correto: 8)
  linhasHtml.push(
    "<tr style='font-weight:bold;background:#F1F5F9;'>" +
      "<td colspan='8' style='border:1px solid #000;padding:4px;text-align:right;'>Total</td>" +
      "<td style='border:1px solid #000;padding:4px;text-align:right;'>" +
        total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
    "</tr>"
  );

  linhasHtml.push("</tbody></table></div>");

  // Botão de CSV
  linhasHtml.push(
    "<div style='margin-top:8px;display:flex;justify-content:flex-end;'>" +
      "<button type='button' " +
        "onclick=\"exportTableToCSV(this, 'transacoes_categoria')\" " +
        "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
               "border-radius:4px;font-size:11px;cursor:pointer;'>" +
        "⬇ Exportar CSV" +
      "</button>" +
    "</div>"
  );

  return "<div class='text-sm text-slate-700'>" + linhasHtml.join("") + "</div>";
}

// 🔽 Drilldown da fatura para TIMES, respeitando o período da fatura
window.vektorDetalharFaturaPorTime = function (tr) {
  try {
    if (!tr) return;

    var inicioIso = tr.getAttribute("data-inicio") || "";
    var fimIso    = tr.getAttribute("data-fim") || "";

    // Pega o texto da fatura para mostrar na mensagem
    var extrato = "";
    if (tr.cells && tr.cells.length > 0) {
      extrato = (tr.cells[0].innerText || tr.cells[0].textContent || "").trim();
    }

    // Se não tiver período, não faz sentido puxar times
    if (!inicioIso || !fimIso) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>" +
          "Não consegui identificar o período dessa fatura para detalhar por time. " +
          "Verifique se o campo <b>Extrato da conta</b> está no formato esperado na BaseClara." +
        "</p>"
      );
      return;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Vou detalhar a fatura <b>" + extrato + "</b> " +
        "por <b>time</b>, considerando apenas as transações desse período." +
      "</p>"
    );

    // Chama o Apps Script para montar o resumo por time
    google.script.run
      .withSuccessHandler(function (res) {
        if (!res || !res.ok) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>" +
              "Não consegui montar o resumo por time para esse período de fatura." +
            "</p>"
          );
          return;
        }

        // Reutiliza o renderizador geral de times
        // topN: null -> lista todos os times
        renderResumoTransacoesPorTime(res, { topN: null });
      })
      .withFailureHandler(function () {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>" +
            "Tive um problema ao detalhar esta fatura por time." +
          "</p>"
        );
      })
      .getResumoTransacoesPorTime(
        inicioIso, // data início da fatura
        fimIso,    // data fim da fatura
        "valor"    // critério: agrupar por VALOR da fatura
      );

  } catch (e) {
    console.error("Erro em vektorDetalharFaturaPorTime:", e);
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>" +
        "Tive um problema ao detalhar esta fatura por time." +
      "</p>"
    );
  }
};

// ========= RENDER GENÉRICO: CATEGORIAS / ESTABELECIMENTOS ========= //

function renderResumoPorChaveGenerico(resumo, opts) {
  if (!resumo || !resumo.ok) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não consegui montar o resumo para esse pedido.</p>"
    );
    return;
  }

  opts = opts || {};
  var tipoChave = opts.tipoChave || "Categoria"; // "Categoria" ou "Estabelecimento"
  var titulo    = opts.titulo || ("Resumo por " + tipoChave.toLowerCase());
  
  // ✅ aceita topN como número OU string numérica ("10")
var topN = null;
if (opts.topN !== undefined && opts.topN !== null && opts.topN !== "") {
  var n = Number(opts.topN);
  if (!isNaN(n) && n > 0) topN = n;
}

  // ===== Definição da base da tabela (categoria/estabelecimento/loja/time)
  var tipoChaveLower = tipoChave.toLowerCase();
  // ✅ Default Top 10 somente para Estabelecimento quando não vier topN
if (tipoChaveLower === "estabelecimento" && topN === null) {
  topN = 10;
}
  var baseTabela      = "categoria";    // usado no data-base do <select>
  var tipoTabelaExpand = "categoria";   // parâmetro passado para vektorExpandirLinha
  var hintBase        = "";

  if (tipoChaveLower === "estabelecimento") {
    baseTabela       = "estabelecimento";
    tipoTabelaExpand = "estabelecimento";
    hintBase =
      "Clique para detalhar este estabelecimento pela dimensão selecionada (lojas, times ou categorias), " +
      "respeitando o mesmo período da pergunta inicial.";
  } else if (tipoChaveLower === "categoria") {
    baseTabela       = "categoria";
    tipoTabelaExpand = "categoria";
    hintBase =
      "Clique para detalhar esta categoria pela dimensão selecionada (lojas, times ou estabelecimentos), " +
      "respeitando o mesmo período da pergunta inicial.";
  } else if (tipoChaveLower === "loja") {
    baseTabela       = "loja";
    tipoTabelaExpand = "loja";
    hintBase =
      "Clique para detalhar esta loja pela dimensão selecionada (times, estabelecimentos ou categorias), " +
      "respeitando o mesmo período da pergunta inicial.";
  } else if (tipoChaveLower === "time") {
    baseTabela       = "time";
    tipoTabelaExpand = "time";
    hintBase =
      "Clique para detalhar este time pela dimensão selecionada (lojas, estabelecimentos ou categorias), " +
      "respeitando o mesmo período da pergunta inicial.";
  }

  // Descobre qual lista veio do backend
  var lista = [];
  if (Array.isArray(resumo.categorias)) {
    lista = resumo.categorias;
  } else if (Array.isArray(resumo.estabelecimentos)) {
    lista = resumo.estabelecimentos;
  } else if (Array.isArray(resumo.linhas)) {
    lista = resumo.linhas;
  }

  if (!lista.length) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Não encontrei movimentações para esse filtro.</p>"
    );
    return;
  }

  // Se tiver topN, recorta
  if (topN !== null && lista.length > topN) {
    lista = lista.slice(0, topN);
  }

  // Calcula somatórios para porcentagens
  var totalQtd = 0;
  var totalValor = 0;

  for (var i = 0; i < lista.length; i++) {
    var it = lista[i];
    totalQtd   += Number(it.total || it.qtd || 0);
    totalValor += Number(it.valorTotal || it.valor || 0);
  }

  var linhasTabela = [];

  // 🔹 Agora também queremos drilldown em ESTABELECIMENTO (clique direto na linha)
  var temDrilldown = true;

  // ===== 🔽 DROPDOWN DE DRILLDOWN (somente se tiver drilldown) =====
  if (temDrilldown && baseTabela !== "categoria" && baseTabela !== "estabelecimento") {
    var opcoes = [];
    // Regra: todas as dimensões menos a própria baseTabela
    if (baseTabela !== "time")            opcoes.push("<option value='time'>Times</option>");
    if (baseTabela !== "loja")            opcoes.push("<option value='loja'>Lojas</option>");
    if (baseTabela !== "estabelecimento") opcoes.push("<option value='estabelecimento'>Estabelecimentos</option>");
    if (baseTabela !== "categoria")       opcoes.push("<option value='categoria'>Categorias</option>");

    linhasTabela.push(
      "<div style='font-size:11px;margin-bottom:4px;color:#334155'>" +
        "Drilldown desta tabela de " + tipoChave.toLowerCase() + ": " +
        "<select class='vektor-drill-select' data-base='" + baseTabela + "' " +
                "style='border:1px solid #cbd5e1;border-radius:4px;font-size:11px;padding:2px 4px;'>" +
          opcoes.join("") +
        "</select>" +
      "</div>"
    );
  }

  // ===== TABELA PRINCIPAL =====
  linhasTabela.push(
    "<table border='1' cellspacing='0' cellpadding='6' " +
    "style='border-collapse:collapse;font-family:Arial,sans-serif;font-size:12px;" +
    "margin-top:8px;width:100%;text-align:center;border:1px solid #000;'>"
  );

  linhasTabela.push(
    "<tr style='background:#06167d;color:#fff'>" +
      "<th style='border:1px solid #000;'>" + tipoChave + "</th>" +
      "<th style='border:1px solid #000;'>Transações</th>" +
      "<th style='border:1px solid #000;'>% Transações</th>" +
      "<th style='border:1px solid #000;'>Valor (R$)</th>" +
      "<th style='border:1px solid #000;'>% Valor</th>" +
    "</tr>"
  );

  for (var j = 0; j < lista.length; j++) {
  var l = lista[j];
  var nome =
    l.estabelecimento ||
    l.categoria ||
    l.chave ||
    "—";

  var qtd   = Number(l.total || l.qtd || 0);
  var valor = Number(l.valorTotal || l.valor || 0);

  var pctQtd = totalQtd   > 0 ? ((qtd   / totalQtd)   * 100).toFixed(1) + "%" : "—";
  var pctVal = totalValor > 0 ? ((valor / totalValor) * 100).toFixed(1) + "%" : "—";

  // ========== CATEGORIAS RESTRITAS: fundo vermelho claro ==========
  var estiloLinhaExtra = "";
  if (tipoChaveLower === "categoria") {
    var nomeNorm = (nome || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();

    var categoriasRestritas = [
      "combustiveis",
      "transporte",
      "eletronicos",
      "imoveis",
      "entretenimento",
      "pagamentos do governo",
      "causas sociais",
      "educacao",
      "joias e cassino",
      "joias",
      "cassino",
      "saude",
      "viagem e hospedagem",
      "aluguel de veiculos",
      "assinaturas"
    ];

    if (categoriasRestritas.indexOf(nomeNorm) !== -1) {
      // vermelho claro
      estiloLinhaExtra = "background:#FFB3B3;";
    }
  }

  // ===== LINHA: com ou sem onclick dependendo do drilldown =====
  if (temDrilldown) {
    // Categoria → drilldown específico para transações (vamos criar já já)
    if (tipoChaveLower === "categoria" && baseTabela === "categoria") {
      linhasTabela.push(
        "<tr onclick=\"vektorDrillTransacoesCategoria('" + nome.replace(/'/g, "\\'") + "')\" " +
          "style='cursor:pointer;" + estiloLinhaExtra + "' " +
          "title=\"Clique para ver as transações dessa categoria no mesmo período.\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    } 
    
    // Estabelecimento → drilldown específico para transações por loja
else if (tipoChaveLower === "estabelecimento" && baseTabela === "estabelecimento") {
  linhasTabela.push(
    "<tr onclick=\"vektorDrillTransacoesEstabelecimento('" + nome.replace(/'/g, "\\'") + "')\" " +
      "style='cursor:pointer;" + estiloLinhaExtra + "' " +
      "title=\"Clique para ver as transações desse estabelecimento por loja no mesmo período.\">" +
      "<td style='border:1px solid #000;'>" + nome + "</td>" +
      "<td style='border:1px solid #000;'>" + qtd + "</td>" +
      "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
      "<td style='border:1px solid #000;'>" +
        valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
    "</tr>"
  );
}
    
    else {
      // Drilldown padrão (times, lojas, estabelecimentos, etc.)
      var hint = hintBase;
      linhasTabela.push(
        "<tr onclick=\"vektorExpandirLinha(this,'" + tipoTabelaExpand + "')\" " +
          "style='cursor:pointer;" + estiloLinhaExtra + "' title=\"" + hint + "\">" +
          "<td style='border:1px solid #000;'>" + nome + "</td>" +
          "<td style='border:1px solid #000;'>" + qtd + "</td>" +
          "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
          "<td style='border:1px solid #000;'>" +
            valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
          "</td>" +
          "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
        "</tr>"
      );
    }
  } else {
    // Sem drilldown → apenas aplica cor quando necessário
    linhasTabela.push(
      "<tr style='" + estiloLinhaExtra + "'>" +
        "<td style='border:1px solid #000;'>" + nome + "</td>" +
        "<td style='border:1px solid #000;'>" + qtd + "</td>" +
        "<td style='border:1px solid #000;'>" + pctQtd + "</td>" +
        "<td style='border:1px solid #000;'>" +
          valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
        "</td>" +
        "<td style='border:1px solid #000;'>" + pctVal + "</td>" +
      "</tr>"
    );
  }
}

  // Linha de TOTAL
  linhasTabela.push(
    "<tr style='font-weight:bold;background:#f2f2f2;'>" +
      "<td style='border:1px solid #000;'>TOTAL</td>" +
      "<td style='border:1px solid #000;'>" + totalQtd + "</td>" +
      "<td style='border:1px solid #000;'>" + (totalQtd > 0 ? "100%" : "—") + "</td>" +
      "<td style='border:1px solid #000;'>" +
        totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) +
      "</td>" +
      "<td style='border:1px solid #000;'>" + (totalValor > 0 ? "100%" : "—") + "</td>" +
    "</tr>"
  );

  linhasTabela.push("</table>");

  // Botão CSV
  var botaoCsv = "";
  if (linhasTabela.length) {
    var slug = tipoChave.toLowerCase();
    botaoCsv =
      "<div style='margin-top:8px;text-align:right;'>" +
        "<button type='button' " +
          "onclick=\"exportTableToCSV(this, 'resumo_" + slug + "')\" " +
          "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                 "border-radius:4px;font-size:11px;cursor:pointer;'>" +
          "⬇ Exportar CSV" +
        "</button>" +
      "</div>";
  }

    // ===== Período da consulta (apenas para Categorias) =====
  var periodoHtml = "";
  if (tipoChaveLower === "categoria") {
    var dataInicioIso = "";
    var dataFimIso    = "";

    // 1) Tenta vir do próprio resumo (caso o backend envie)
    if (resumo.dataInicioIso && resumo.dataFimIso) {
      dataInicioIso = resumo.dataInicioIso;
      dataFimIso    = resumo.dataFimIso;
    }
    // 2) Senão, cai no cache global do período
    else if (
      window.__vektorUltimoPeriodo &&
      window.__vektorUltimoPeriodo.dataInicio &&
      window.__vektorUltimoPeriodo.dataFim
    ) {
      dataInicioIso = window.__vektorUltimoPeriodo.dataInicio.toISOString();
      dataFimIso    = window.__vektorUltimoPeriodo.dataFim.toISOString();
    }

    if (dataInicioIso && dataFimIso) {
      try {
        var di = new Date(dataInicioIso);
        var df = new Date(dataFimIso);
        var diBr = di.toLocaleDateString("pt-BR");
        var dfBr = df.toLocaleDateString("pt-BR");

        periodoHtml =
          "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
            "Período da consulta: de " + diBr + " a " + dfBr + "." +
          "</p>";
      } catch (e) {
        console.error("Não consegui formatar período em renderResumoPorChaveGenerico:", e);
      }
    }
  }

      // ===== Período da consulta (prioriza o que vem do back-end) =====
  var periodoHtml = "";
  if (tipoChaveLower === "categoria" || tipoChaveLower === "estabelecimento") {
    try {
      var di = null, df = null;

      // 1) Tenta pegar diretamente do objeto resumo retornado pelo Apps Script
      if (resumo && resumo.dataInicioIso && resumo.dataFimIso) {
        di = new Date(resumo.dataInicioIso);
        df = new Date(resumo.dataFimIso);
      }

      // 2) Se não tiver no resumo, usa o cache global do último período interpretado
      if (
        (!di || !df || isNaN(di.getTime()) || isNaN(df.getTime())) &&
        window.__vektorUltimoPeriodo &&
        window.__vektorUltimoPeriodo.dataInicio &&
        window.__vektorUltimoPeriodo.dataFim
      ) {
        di = window.__vektorUltimoPeriodo.dataInicio;
        df = window.__vektorUltimoPeriodo.dataFim;
      }

      if (di && df && !isNaN(di.getTime()) && !isNaN(df.getTime())) {
        var diBr = di.toLocaleDateString("pt-BR");
        var dfBr = df.toLocaleDateString("pt-BR");

        periodoHtml =
          "<p style='font-size:11px;color:#475569;margin-top:2px;'>" +
            "Período da consulta: de " + diBr + " a " + dfBr + "." +
          "</p>";
      }
    } catch (e) {
      console.error("Erro ao montar periodoHtml em renderResumoPorChaveGenerico:", e);
    }
  }

  // Dica de drilldown – só para categorias
    var dicaDrilldown = "";
    if (tipoChaveLower === "categoria") {
      dicaDrilldown =
        (periodoHtml || "") +  // 👈 período vem logo acima da dica
        "<p style='font-size:12px;color:#64748B;margin-top:2px;'>" +
          "Clique em uma categoria para ver as transações individuais dela no mesmo período." +
        "</p>";

      // Como o período foi “movido” para cá, evita duplicar mais abaixo
      periodoHtml = "";
    }

  // Dica de drilldown – para estabelecimentos
if (tipoChaveLower === "estabelecimento") {
  dicaDrilldown =
    "<p style='font-size:12px;color:#64748B;margin-top:2px;'>" +
      "Clique em um estabelecimento para ver as transações individuais por loja no mesmo período." +
    "</p>";
}

  // HTML final
  var html =
    "<div class='text-sm text-slate-700'>" +
      "<p style='margin-bottom:6px;text-align:center;font-weight:bold;'>" + titulo + "</p>" +
      periodoHtml +
      dicaDrilldown +
      linhasTabela.join("") +
      botaoCsv +
    "</div>";

  renderBotMessage("HTML:" + html);

  // 🔎 Insights automáticos adicionais para Categoria / Estabelecimento (ticket médio)
  var tipoLower = tipoChaveLower;
  if (tipoLower === "categoria" || tipoLower === "estabelecimento") {
    var listaInsights = lista
      .map(function (l) {
        return {
          nome: l.estabelecimento || l.categoria || l.chave || "—",
          valor: Number(l.valorTotal || l.valor || 0),
          qtd: Number(l.total || l.qtd || 0)
        };
      })
      .filter(function (l) {
        return l.qtd > 0 && l.valor > 0;
      });

    var insightsHtml = "";
    if (tipoLower === "categoria") {
      insightsHtml = vektorGerarInsightsResumoCategorias(listaInsights);
    } else {
      insightsHtml = vektorGerarInsightsResumoEstabelecimentos(listaInsights);
    }

    if (insightsHtml) {
      renderBotMessage("HTML:" + insightsHtml);
    }
  }

  // 🧠 NOVO: insights automáticos específicos para Categoria / Estabelecimento
  if (
    opts &&
    (opts.tipoChave === "Categoria" || opts.tipoChave === "Estabelecimento")
  ) {
    const htmlInsightsExtra = gerarInsightsResumoChaveCategoriaEstab(resumo, {
      tipoChave: opts.tipoChave
    });

    if (htmlInsightsExtra) {
      renderBotMessage("HTML:" + htmlInsightsExtra);
    }
  }
}

// ================= INFORMAÇÕES INICIAIS (APENAS ADMIN) ===================

function vektorMostrarPerguntaInfoInicial() {
  try {
    // Só ADM recebe essa pergunta
    if (USER_ROLE_REPLACED !== "Administrador") {
      return;
    }

    const chatWindow = document.getElementById("chatWindow");
    if (!chatWindow) return;

    // Evita duplicar se o usuário recarregar
    if (document.getElementById("vektor-info-inicial-pergunta")) return;

    const div = document.createElement("div");
    div.id = "vektor-info-inicial-pergunta";
    div.className = "flex items-start gap-3 mt-3";

    div.innerHTML = `
      <div class="bot-bubble px-4 py-3 max-w-[80%]">
        <p class="text-sm text-slate-700">
          Você quer ver as principais informações de utilização dos cartões Clara,
          como <b>maiores transações</b>, <b>times com mais pendências</b>,
          <b>estabelecimentos</b> e <b>categorias</b> com maior volume de gastos?
        </p>
        <div class="mt-3 flex gap-3">
          <button
            id="btnInfoInicialSim"
            class="px-3 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">
            Sim, mostrar
          </button>
          <button
            id="btnInfoInicialNao"
            class="px-3 py-1 text-xs rounded bg-slate-200 text-slate-700 hover:bg-slate-300">
            Não, obrigado
          </button>
        </div>
      </div>
    `;

    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    const btnSim = document.getElementById("btnInfoInicialSim");
    const btnNao = document.getElementById("btnInfoInicialNao");

    if (btnSim) {
      btnSim.addEventListener("click", function () {
        vektorCarregarInformacoesIniciais();
      });
    }
    if (btnNao) {
      btnNao.addEventListener("click", function () {
        const bloco = document.getElementById("vektor-info-inicial-pergunta");
        if (bloco) bloco.remove();
      });
    }
  } catch (e) {
    console.warn("Erro ao montar pergunta de informações iniciais:", e);
  }
}

// Extrai "top N" (ex.: "top 5", "top5"). Se não houver "top", retorna null.
function extrairTopN(texto) {
  if (!texto) return null;
  let m = texto.match(/top\s*(\d{1,2})/);
  if (!m) m = texto.match(/top(\d{1,2})/);
  if (m) {
    const n = Number(m[1]);
    if (!isNaN(n)) return Math.min(Math.max(n, 1), 50); // 1..50
  }
  return null;
}

// Decide critério: "quantidade" se falar de transações; senão "valor".
function extrairCriterioGeral(texto) {
  if (!texto) return "valor";

  const falaDeTransacoes =
    texto.includes("transacoes") || 
    texto.includes("transacao") ||
    texto.includes("numero de transacoes") || 
    texto.includes("quantidade de transacoes") ||
    texto.includes("mais transacoes") || 
    texto.includes("maior numero de transacoes");

  const falaDeValor =
    texto.includes("valor") || 
    texto.includes("gasto") || 
    texto.includes("gastou") ||
    texto.includes("gastaram") || 
    texto.includes("gastos") || 
    texto.includes("compras") ||
    texto.includes("valor de transacoes");

  if (falaDeTransacoes && !falaDeValor) return "quantidade";
  return "valor";
}

function extrairGrupo(msgOriginal, norm) {
  const textoOriginal = msgOriginal || "";
  const lower = (norm || textoOriginal.toLowerCase());

  // procura a palavra "time "
  let idx = lower.indexOf("time ");
  if (idx === -1) {
    // se quiser, pode tentar "time:" também
    idx = lower.indexOf("time:");
  }
  if (idx === -1) {
    return "";
  }

  // pega o que vem depois de "time "
  let parte = textoOriginal.substring(idx + 5); // 5 = len("time ")

  // corta quando começar alguma palavra de período
  const marcadores = [
    " no ", " neste ", " nesse ", " nesta ", " nessa ",
    " em ", " no período", " no periodo",
    " neste mes", " nesse mes", " neste mês", " nesse mês",
    " na semana", " nesta semana", " nessa semana"
  ];

  let corte = parte.length;
  const parteLower = parte.toLowerCase();

  marcadores.forEach(m => {
    const j = parteLower.indexOf(m);
    if (j !== -1 && j < corte) {
      corte = j;
    }
  });

  parte = parte.substring(0, corte).trim();

  // remove "do", "da", "de" do começo, se tiver
  parte = parte.replace(/^(do|da|de)\s+/i, "").trim();

  return parte;
}

// FILTRAR POR MAIS DE UMA LOJA

function extrairCodigosLojasDaMensagem(msgOriginal) {
  const texto = normalize(msgOriginal || "");

  // localiza a partir da palavra "loja" ou "lojas"
  let idx = texto.indexOf("lojas");
  if (idx < 0) idx = texto.indexOf("loja");
  if (idx < 0) return [];

  const trecho = texto.slice(idx); // parte da frase a partir de "loja(s)"

  // pega números com 2 a 4 dígitos (311, 145, 023, 1020 etc.)
  const encontrados = trecho.match(/\b\d{2,4}\b/g);
  if (!encontrados) return [];

  // normaliza tirando zeros à esquerda
  return encontrados.map(function (c) {
    return c.replace(/^0+/, "") || c;
  });
}

// ========= DETECTOR: CATEGORIAS ========= //
function detectarPerguntaCategorias(msgOriginal, norm) {
  const t = norm || "";
  const periodo = extrairIntervaloDatas(msgOriginal);
  let topN      = extrairTopN(t);
  let tipo      = extrairCriterioGeral(t);  // "valor" ou "quantidade"

  // Se falar "mais uso", força tratar como quantidade (uso = número de vezes)
  if (t.includes("mais uso")) {
    tipo = "quantidade";
  }

  // se ainda não tiver tipo, assume "valor" como padrão
  if (!tipo) {
    tipo = "valor";
  }

  const falaCategoria =
    t.includes("categoria") ||
    t.includes("categorias");

  if (!falaCategoria) return null;

  const falaUso =
    t.includes("mais uso") ||
    t.includes("mais gasto") ||
    t.includes("mais gastos") ||
    t.includes("mais valor") ||      // NOVO
    t.includes("mais valores") ||    // NOVO
    t.includes("mais transacoes") ||
    t.includes("mais transacao") ||
    t.includes("maior valor") ||
    t.includes("maior gasto") ||
    t.includes("maior numero de transacoes") ||
    t.includes("maior quantidade de transacoes");

  if (!falaUso) return null;

  // Se não tiver "top" explícito mas for "qual categoria ...", trata como top 1
  if (!topN && /\bqual\s+categoria\b/.test(t)) {
    topN = 1;
  }

  return {
    periodo,
    tipo,
    topN
  };
}

// ========= DETECTOR: ESTABELECIMENTOS (TRANSACAO) ========= //

function detectarPerguntaEstabelecimentos(msgOriginal, norm) {
  const t = norm || "";
  const tipo    = extrairCriterioGeral(t);
  let   topN    = extrairTopN(t); // let para conseguirmos ajustar para 1

  // Se não tem “top” mas a pessoa perguntou “qual local/estabelecimento” → força topN = 1
if (!topN) {
  const temQualLocal =
    /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
  const temQualEstab =
    /\bqual\s+estabelecimento\b/.test(t) ||
    /\bqual\s+estabelecimentos\b/.test(t);

  if (temQualLocal || temQualEstab) {
    topN = 1;
  }
}

// ✅ DEFAULT: se ainda não definiu topN, usa Top 10
if (!topN) {
  topN = 10;
}

  // Palavras que DEFINEM claramente a intenção de estabelecimento
  const falaLocalBase =
    t.includes("estabelecimento") ||
    t.includes("estabelecimentos") ||
    t.includes("local") ||
    t.includes("locais") ||
    t.includes("fornecedor") ||
    t.includes("fornecedores") ||
    t.includes("mercado") ||
    t.includes("mercados") ||
    t.includes("supermercado") ||
    t.includes("supermercados");

  const falaLugarComCompra =
    (t.includes("lugar") || t.includes("lugares")) &&
    (
      t.includes("cartao") ||
      t.includes("cartão") ||
      t.includes("clara") ||
      t.includes("comprar") ||
      t.includes("compra") ||
      t.includes("compras") ||
      t.includes("gastar") ||
      t.includes("gasto") ||
      t.includes("gastos")
    );

  const falaLocal = falaLocalBase || falaLugarComCompra;

  // Palavras que INDICAM time campeão — e por isso devem bloquear
  const falaTimeCampeao =
    t.includes("time que mais gastou") ||
    t.includes("qual time gastou mais") ||
    t.includes("time com maior valor") ||
    t.includes("maior valor total por time") ||
    t.includes("maior gasto por time");

  // Se não for claramente estabelecimento, ou se cair no caso de time → ignora
  if (!falaLocal || falaTimeCampeao) return null;

  // Se não tem “top” mas a pessoa perguntou “qual local/estabelecimento” → força topN = 1
  if (!topN) {
    topN = 10;
    const temQualLocal =
      /\bqual\s+local\b/.test(t) || /\bqual\s+locais\b/.test(t);
    const temQualEstab =
      /\bqual\s+estabelecimento\b/.test(t) ||
      /\bqual\s+estabelecimentos\b/.test(t);

    if (temQualLocal || temQualEstab) {
      topN = 1;
    }
  }

   // Só tenta achar time se a frase falar explicitamente de time/grupo/equipe
  let grupo = "";
  const falaDeTime =
    t.includes("time ")   ||
    t.includes("times ")  ||
    t.includes("grupo ")  ||
    t.includes("equipe")  ||
    t.includes("equipes");

  if (falaDeTime) {
    grupo = encontrarTimeNaMensagem(msgOriginal) || "";
  }

  const periodo = extrairIntervaloDatas(msgOriginal);
  const criterio = extrairCriterioGeral(t);

  return {
    grupo,
    periodo,
    criterio
  };
}

// ========= DETECTOR: PERGUNTAS DE FATURA (Extrato da conta) =========

function detectarPerguntaFaturaClara(msgOriginal, norm) {
  const t = norm || "";

  // precisa conter "fatura" ou "faturas"
  if (!t.includes("fatura")) return null;

  let modo = "atual";
  let qtd = null;

  // todas as faturas
  if (t.includes("todas") && t.includes("faturas")) {
    modo = "todas";
  }

  // últimas N faturas
  if (t.includes("ultimas") || t.includes("ultimos") || t.includes("últimas")) {
    modo = "ultimas";

    // capturar número "6", "3", etc.
    let m1 = t.match(/ultimas?\s+(\d+)/);
    let m2 = t.match(/(\d+)\s+ultimas?/);
    let m3 = t.match(/ultimos?\s+(\d+)/);

    const m = m1 || m2 || m3;
    qtd = m ? parseInt(m[1], 10) : 2;
  }

  // fatura anterior
  if (
    t.includes("anterior") ||
    t.includes("mes passado") ||
    t.includes("mês passado")
  ) {
    modo = "anterior";
  }

  // reforço: fatura atual
  if (t.includes("atual") || t.includes("deste mes") || t.includes("desse mes")) {
    modo = "atual";
  }

  return {
    tipo: "fatura",
    modo,
    qtd
  };
}

// ========= DETECTOR: "loja e time com maior número/valor de transações..." ========= //

function detectarPerguntaLojaMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // fala claramente de loja
  const falaDeLoja =
    texto.includes("qual loja") ||
    texto.includes("loja com")  ||
    texto.includes("loja que mais")  ||
    texto.includes("loja mais");

  // pedindo topo por QUANTIDADE de transações
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // pedindo topo por VALOR de transações
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastou")                 ||
    texto.includes("loja que mais gastou")        ||
    texto.includes("mais gastos")                 ||
    texto.includes("maior gastos")                 ||
    texto.includes("maior gasto")                 ||
    texto.includes("mais comprou");

  // se não for pergunta de loja + (transações ou valor), ignora
  if (!falaDeLoja || (!falaDeTransacoes && !falaDeValor)) {
    return null;
  }

  // intervalo de datas (ontem, esse mês, mês passado, "de 1 a 30 de outubro", etc.)
  const periodo = extrairIntervaloDatas(msgOriginal);

  // Só tenta achar time se a frase falar explicitamente de time/grupo/equipe
  const falaDeTime =
    texto.includes("time ")  ||
    texto.includes("times ") ||
    texto.includes("grupo ") ||
    texto.includes("equipe") ||
    texto.includes("equipes");

  // tenta achar um dos TIMES_OFICIAIS no texto APENAS se fez sentido procurar
  const grupoNomeOficial = falaDeTime ? encontrarTimeNaMensagem(msgOriginal) : null;


  // se falou de "valor" (gastou/comprou), é consulta por valor; senão, por quantidade
  const tipo = falaDeValor ? "valor" : "quantidade";

  return {
    grupo: grupoNomeOficial, // null => todas as lojas, independente de time
    periodo: periodo,
    tipo: tipo
  };

}

// ========= DETECTOR: "ranking geral de times" / "top N times ..." =========

function detectarRankingTimes(msgOriginal, norm) {
  // se for "qual time ..." (singular), deixa o bloco singular tratar
  if (/\bqual\s+time\s+(gastou|teve)\s+mais\b/.test(norm)) return null;

  const texto = norm || "";

  // 🚫 ESCUDO: se falar de local/estabelecimento, NÃO é pergunta de time
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // se fala explicitamente de loja(s), não é ranking de times
  if (texto.includes("lojas") || texto.includes("loja")) return null;

  const falaDeTime =
  texto.includes("ranking de times") ||
  texto.includes("ranking geral de times") ||
  // Só trata frases do tipo "top 5 times", não "top 5 transações do time X"
  (texto.includes("top") && texto.includes("times"));

  if (!falaDeTime) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = extrairCriterioGeral(texto);  // "valor" ou "quantidade"
  const topN = extrairTopN(texto);           // número de linhas

  return { periodo, tipo, topN };
}

// ========= DETECTOR: "TODOS OS TIMES / RELAÇÃO DE TIMES" ========= //

function detectarTodosTimesPeriodo(msgOriginal, norm) {
  const t = norm || "";

  // Frases chave:
  // - "todos os times no período ..."
  // - "relação de times no período ..."
  const pedeTodosTimes =
    t.includes("todos os times") ||
    t.startsWith("todos os times") ||
    t.startsWith("relacao de times") ||
    t.includes("relacao de times no periodo") ||
    t.includes("relação de times") ||
    t.includes("relação de times no período");

  if (!pedeTodosTimes) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  let tipo = extrairCriterioGeral(t); // "valor" ou "quantidade"

  // se não especificar critério, assume valor
  if (!tipo) {
    tipo = "valor";
  }

  return {
    periodo,
    tipo,
    topN: null // null => queremos TODOS os times
  };
}

// ========= DETECTOR: "ranking/top N de LOJAS" (opcional: do time X) =========

function detectarRankingLojas(msgOriginal, norm) {
  const texto = norm || "";

  // 🚫 Se falar de local/estabelecimento, NÃO é ranking de lojas
  if (
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

    // Aceita apenas pedidos CLAROS de ranking de lojas:
  // - "ranking de lojas"
  // - "ranking geral de lojas"
  // - "top 5 lojas", "top 10 lojas", etc.
  const falaRankingLojasDireto =
    texto.includes("ranking de lojas") ||
    texto.includes("ranking geral de lojas");

  const falaTopLojas = /top\s*\d+\s+lojas?/.test(texto); // ex.: "top 5 lojas"

  // Se não falar explicitamente de "ranking de lojas" ou "top X lojas",
  // NÃO trata como ranking de lojas.
  if (!falaRankingLojasDireto && !falaTopLojas) return null;


  // Time opcional (usa seu matcher)
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(texto); // "valor" ou "quantidade"
  const topN    = extrairTopN(texto);          // null se não informou

  return { grupo: grupoNomeOficial, periodo, tipo, topN };
}

// ========= DETECTOR: "TODAS AS LOJAS" GERAL (sem time) ========= //

function detectarListarTodasLojasGeral(msgOriginal, norm) {
  const t = norm || "";

  // Aceita pedidos do tipo:
  // - "todas as lojas com gastos no período ..."
  // - "todas as lojas com valor no período ..."
  // - "relação de lojas no período ..."
  const pedeTodas =
    t.includes("listar todas as lojas") ||
    t.startsWith("todas as lojas") ||
    t.includes("todas as lojas com gastos") ||
    t.includes("todas as lojas com gasto") ||
    t.includes("todas as lojas com valor") ||
    t.startsWith("relacao de lojas") ||
    t.includes("relacao de lojas no periodo") ||
    t.includes("relação de lojas") ||
    t.includes("relação de lojas no período");

  if (!pedeTodas) return null;

  // critério: por padrão ordena por valor, mas a tabela mostra valor e quantidade
  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = "valor"; // mantém padrão por valor

  return {
    grupo: "",      // sem time
    periodo,
    tipo,
    topN: null      // null => queremos TODAS as lojas
  };
}

// =========== DETECTOR: "TODAS AS LOJAS DOS TIMES X E Y" =========== //

function detectarTodasLojasDosTimes(msgOriginal, norm) {
  const t = norm || "";

  const falaLojas = t.includes("todas as lojas dos times") ||
                    t.includes("todas as lojas dos time")  ||
                    t.includes("todas as lojas do time")   ||
                    t.includes("lojas do time")   ||
                    t.includes("loja do time")   ||
                    t.includes("todas as lojas do grupo")  ||
                    t.includes("todas as lojas dos grupos");

  if (!falaLojas) return null;

  const listaTimes = encontrarListaTimesNaMensagem(msgOriginal) || [];
  if (!listaTimes.length) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    times: listaTimes,
    periodo,
    tipo
  };
}

// =========== DETECTOR: "MAIS DE UMA LOJA NO PERÍODO" =========== //

function detectarLojasEspecificasLista(msgOriginal, norm) {
  const texto = norm || "";

  // ⚠️ Se a frase fala de pendência, NÃO tratar como consulta de transações
  // Isso evita conflitos com o fluxo de pendências (CLARA_PEND)
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "loja" ou "lojas"
  const mencionaLoja =
    texto.includes("loja ") ||
    texto.includes("lojas ");

  if (!mencionaLoja) return null;

  // extrai códigos numéricos de loja
  const codigos = [];
  const regexCodigos = /\b(\d{2,6})\b/g;
  let m;
  while ((m = regexCodigos.exec(msgOriginal)) !== null) {
    const cod = m[1];
    if (!codigos.includes(cod)) {
      codigos.push(cod);
    }
  }

  if (!codigos.length) return null;

  // período
  const periodo = extrairIntervaloDatas(msgOriginal);
  // tipo (valor ou quantidade)
  const tipo = extrairCriterioGeral(texto) || "valor";

  return {
    codigosLojas: codigos,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "lojas com maior valor/transações ..." (plural, sem 'top'/'ranking') =========
function detectarLojasMaisTransacoesPlural(msgOriginal, norm) {
  const texto = norm || "";

    // ⚠️ Se falar de pendência, não é consulta de ranking/lista de transações
  if (texto.includes("pendenc")) {
    return null;
  }

  // precisa mencionar "lojas " (plural) + critério
  const mencionaLojasPlural = texto.includes("lojas ");
  if (!mencionaLojasPlural) return null;

  // critério
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior quantidade de transacoes");

  const falaDeValor =
    texto.includes("maior valor")     ||
    texto.includes("mais gastou")     ||
    texto.includes("mais gasto")      ||
    texto.includes("mais gastos")     ||
    texto.includes("maior gasto")     ||
    texto.includes("maior gastos")     ||
    texto.includes("mais comprou")    ||
    texto.includes("valor de transacoes");

  if (!falaDeTransacoes && !falaDeValor) return null;

  const tipo = falaDeValor ? "valor" : "quantidade";
  const periodo = extrairIntervaloDatas(msgOriginal);
  const grupo = encontrarTimeNaMensagem(msgOriginal) || "";

  // sem 'top' => queremos listar TODAS as lojas do time (se grupo vier),
  // ou o default que você preferir para "todas as lojas gerais" (vamos deixar limitado se não houver time)
  return { grupo, periodo, tipo, topN: null }; // topN=null => deixe o renderer decidir "listar todas"
}

// =========== DETECTOR: "TODAS AS LOJAS DO TIME XXXXX" =========== //

function detectarListarTodasLojasDoTime(msgOriginal, norm) {
  const t = norm || "";

  // 🚫 Se falar em "top", NÃO é "todas as lojas do time",
  // e sim um ranking de lojas. Deixa para detectarRankingLojas tratar.
  if (t.includes("top")) {
    return null;
  }

  // Gatilhos específicos para perguntas de "lojas do time"
  const pedeTodas =
    t.includes("todas as lojas do time") ||
    t.includes("todas as loja do time") ||   // tolera sem 's'
    t.includes("lojas do time") ||
    t.includes("loja do time") ||            // tolera sem 's'
    t.includes("lojas da regional") ||
    t.includes("loja da regional") ||
    t.includes("todas as lojas do grupo") ||
    t.includes("todas as loja do grupo") ||  // tolera sem 's'
    t.includes("relacao de lojas do time") ||
    t.includes("relação de lojas do time") ||
    t.includes("relacao de lojas do grupo") ||
    t.includes("relação de lojas do grupo");

  if (!pedeTodas) return null;

  // Usa o parser de times que você já tem
  const grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  if (!grupoNomeOficial) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo    = extrairCriterioGeral(t) || "valor";

  return {
    grupo: grupoNomeOficial,
    periodo,
    tipo
  };
}

// ========= DETECTOR: "time com maior número/valor de transações ..." ========= //
function detectarPerguntaTimeMaisTransacoes(msgOriginal, norm) {
  const texto = norm || "";

  // 🚫 Se a frase fala de estabelecimento/local, NÃO é pergunta de time campeão
  if (
    texto.includes("local") ||
    texto.includes("locais") ||
    texto.includes("estabelecimento") ||
    texto.includes("estabelecimentos") ||
    texto.includes("lugar") ||
    texto.includes("lugares") ||
    texto.includes("fornecedor") ||
    texto.includes("fornecedores")
  ) {
    return null;
  }

  // fala claramente de time (não de loja)
  const falaDeTime =
    texto.includes("qual time") ||
    texto.includes("time com")  ||
    texto.includes("time que mais") ||
    texto.includes("time mais");

  // QUANTIDADE
  const falaDeTransacoes =
    texto.includes("mais transacoes") ||
    texto.includes("mais transacao")  ||
    texto.includes("maior numero de transacoes") ||
    texto.includes("maior numero de transacao")  ||
    texto.includes("maior quantidade de transacoes");

  // VALOR
  const falaDeValor =
    texto.includes("maior valor de transacoes")  ||
    texto.includes("maior valor de transacao")   ||
    texto.includes("maior valor de compras")     ||
    texto.includes("mais gastou")                ||
    texto.includes("mais gastaram")                ||
    texto.includes("mais gasto")                 ||
    texto.includes("mais gastos")                ||
    texto.includes("mais comprou");

  if (!falaDeTime || (!falaDeTransacoes && !falaDeValor)) return null;

  const periodo = extrairIntervaloDatas(msgOriginal);
  const tipo = falaDeValor ? "valor" : "quantidade";

  return { periodo, tipo };
}

// ===== NOVO DETECTOR: Maiores transações individuais (loja / time) =====
function detectarMaioresTransacoesIndividuais(msgOriginal, norm) {
  if (!msgOriginal) return null;
  norm = norm || "";

  // Texto normalizado em minúsculas
  var t = norm.toLowerCase();

  // tem palavra "transacao/transações"
  var temTransacao = t.indexOf("transacao") >= 0 || t.indexOf("transacoes") >= 0;
  if (!temTransacao) return null;

  // quer "maiores" OU "top N"
  var temMaior = t.indexOf("maiores transacoes") >= 0 || t.indexOf("maior transacao") >= 0;
  var temTop   = t.indexOf("top") >= 0;
  if (!temMaior && !temTop) return null;

  // Evita pegar perguntas de ranking já existentes (ranking de lojas/times)
  if (t.indexOf("ranking de lojas") >= 0 || t.indexOf("ranking de times") >= 0) {
    return null;
  }

  // ------------------------------
  // LOJA: detectada normalmente pelos códigos
  // ------------------------------
  var lojasCodigos = extrairCodigosLojasDaMensagem(msgOriginal) || [];
  var lojaCodigo = lojasCodigos.length ? lojasCodigos[0] : "";

  // ------------------------------
  // TIME: só detecta se o usuário citar explicitamente "time", "grupo" ou "equipe"
  // ------------------------------
  var mencionaEstruturaTime =
    t.indexOf("time")   >= 0 ||
    t.indexOf("grupo")  >= 0 ||
    t.indexOf("equipe") >= 0;

  var grupoNomeOficial = "";
  if (mencionaEstruturaTime) {
    grupoNomeOficial = encontrarTimeNaMensagem(msgOriginal) || "";
  }

  // período (pode ser nulo)
  var periodo = extrairIntervaloDatas(msgOriginal) || null;

  // "top N" se existir
  var topN = extrairTopN(t);

  var grupoFinal = grupoNomeOficial;

  return {
    grupo: grupoFinal,
    loja: lojaCodigo,
    periodo: periodo,
    topN: topN
  };
}

function bindPeriodoEtiquetasOnce_() {
  if (window.__vektorEtiquetasPeriodoBound) return;
  window.__vektorEtiquetasPeriodoBound = true;

  document.addEventListener("click", async function(e) {
    const btn = e.target && e.target.closest && e.target.closest("#vektor-etq-per-aplicar");
    if (!btn) return;

    const iniEl = document.getElementById("vektor-etq-per-ini");
    const fimEl = document.getElementById("vektor-etq-per-fim");
    const ini = iniEl ? String(iniEl.value || "").trim() : "";
    const fim = fimEl ? String(fimEl.value || "").trim() : "";

    if (!ini || !fim) {
      renderBotMessage("HTML:<p class='text-sm text-red-700' style='margin:0'><b>Preencha</b> data inicial e final.</p>");
      return;
    }
    if (ini > fim) {
      renderBotMessage("HTML:<p class='text-sm text-red-700' style='margin:0'><b>Período inválido:</b> a data inicial não pode ser maior que a final.</p>");
      return;
    }

    const st = window.__vektorEtiquetasState || {};
    st.periodoIni = ini;
    st.periodoFim = fim;

    // zera filtros do painel (mantém coerência)
    st.mes = "";
    st.time = "";
    st.loja = "";
    st.etiqueta = "";

    window.__vektorEtiquetasState = st;

    // força a msg única do próprio listarGastos... reaparecer quando mudar o período
    window.__vektorEtiquetasIntroShown = false;

    // importante: fecha a “sessão” do calendário para permitir reabrir depois
    window.__vektorEtiquetasPeriodoOpen = false;

    window.__vektorEtiquetasIntroShown = false;

    await listarGastosPorEtiquetasClara();

  });
}

function abrirPeriodoGastosEtiquetas_() {
  bindPeriodoEtiquetasOnce_();
  // evita abrir 2 vezes
  if (window.__vektorEtiquetasPeriodoOpen) return;
  window.__vektorEtiquetasPeriodoOpen = true;

  // default: últimos 30 dias
  const hoje = new Date();
  const fim = hoje.toISOString().slice(0, 10);

  const iniDt = new Date(hoje.getTime());
  iniDt.setDate(iniDt.getDate() - 30);
  const ini = iniDt.toISOString().slice(0, 10);

  // se já existe período salvo, pré-preenche
  const st = window.__vektorEtiquetasState || {};
  const vIni = st.periodoIni || ini;
  const vFim = st.periodoFim || fim;

  renderBotMessage(
    "HTML:" +
    "<div class='text-sm text-slate-700' style='margin:0'>" +
      "<p style='margin:0'><b>Selecione o período</b> para montar <b>Gastos por etiquetas</b>:</p>" +
      "<div style='display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:10px'>" +
        "<div style='display:flex;flex-direction:column;gap:4px'>" +
          "<label style='font-size:11px;opacity:0.85'>Data inicial</label>" +
          "<input type='date' id='vektor-etq-per-ini' value='" + vIni + "' " +
          "style='border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px' />" +
        "</div>" +
        "<div style='display:flex;flex-direction:column;gap:4px'>" +
          "<label style='font-size:11px;opacity:0.85'>Data final</label>" +
          "<input type='date' id='vektor-etq-per-fim' value='" + vFim + "' " +
          "style='border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px' />" +
        "</div>" +
        "<button type='button' id='vektor-etq-per-aplicar' " +
          "style='background:#005E27;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-size:12px;cursor:pointer'>" +
          "Aplicar período" +
        "</button>" +
      "</div>" +
      "<p style='margin:0;margin-top:8px;font-size:12px;opacity:0.9'>Dica: escolha um período menor para carregar mais rápido.</p>" +
    "</div>"
  );
}

// Lista as etiquetas disponíveis na BaseClara (coluna T) e mostra no chat

async function listarGastosPorEtiquetasClara() {
  // estado global (filtros)
  window.__vektorEtiquetasState = window.__vektorEtiquetasState || { mes:"", time:"", loja:"", etiqueta:"" };

  // id único do painel (1 instância)
  const panelId = window.__vektorEtiquetasPanelId || ("vektor-etq-panel-" + Date.now());
  window.__vektorEtiquetasPanelId = panelId;

  const st0 = window.__vektorEtiquetasState || {};

if (!st0.periodoIni || !st0.periodoFim) {
  // primeira entrada: pede o período no chat
  window.__vektorEtiquetasPeriodoOpen = false;
  abrirPeriodoGastosEtiquetas_();  // renderiza o mini-calendário em nova bolha
  return;
}

  function escHtml_(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function formatBRL(n) {
    n = Number(n || 0); if (!isFinite(n)) n = 0;
    return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2});
  }
  function formatPct(p) {
    p = Number(p || 0); if (!isFinite(p)) p = 0;
    return p.toLocaleString("pt-BR",{minimumFractionDigits:1,maximumFractionDigits:1}) + " %";
  }

  // 1) garante a bolha UMA vez
// 1) garante a bolha UMA vez (somente o container do painel)
async function ensurePanelBubble_() {
  if (document.getElementById(panelId)) return;
  await renderBotMessage(
    "HTML:<div class='text-sm text-slate-700' style='margin:0'>" +
      "<div id='" + panelId + "'></div>" +
    "</div>"
  );
}

  function buildPainelHtml_(res) {
    const st = window.__vektorEtiquetasState || { mes:"", time:"", loja:"", etiqueta:"" };
    const filtros = res && res.filtros ? res.filtros : {};
    const meses = Array.isArray(filtros.meses) ? filtros.meses : [];
    const times = Array.isArray(filtros.times) ? filtros.times : [];
    const lojas = Array.isArray(filtros.lojas) ? filtros.lojas : [];
    const etiquetas = Array.isArray(filtros.etiquetas) ? filtros.etiquetas : [];

    // aceita backend em res.itens OU res.rows
    const itens = Array.isArray(res.itens) ? res.itens : (Array.isArray(res.rows) ? res.rows : []);

    const somaValores = Number(res.somaValores || 0);

    // heat column (valor)
    let minValor = Infinity, maxValor = -Infinity;
    itens.forEach(it => {
      const v = Number(it.valorTotal || 0);
      if (isFinite(v)) { if (v < minValor) minValor = v; if (v > maxValor) maxValor = v; }
    });
    if (!isFinite(minValor)) minValor = 0;
    if (!isFinite(maxValor)) maxValor = 0;

    const opt = (arr, selected, placeholder) => {
      let out = `<option value="">${escHtml_(placeholder)}</option>`;
      arr.forEach(v => {
        const vv = String(v ?? "");
        const sel = (vv === String(selected ?? "")) ? " selected" : "";
        out += `<option value="${escHtml_(vv)}"${sel}>${escHtml_(vv)}</option>`;
      });
      return out;
    };

    let html = "";
    html += "<div id='vektor-etiquetas-panel' style='position:relative'>";
    // overlay de carregamento (fica oculto; o JS liga/desliga)
    html += "<div id='vektor-etq-loading-overlay' " +
        "style='display:none;position:absolute;inset:0;z-index:50;" +
               "background:rgba(255,255,255,0.78);backdrop-filter:blur(1px);" +
               "align-items:center;justify-content:center'>" +
          "<div style='background:#0f172a;color:#fff;padding:10px 14px;border-radius:10px;" +
                      "font-size:13px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,0.25)'>" +
            "Carregando informações ⌛" +
          "</div>" +
        "</div>";
    html +=   "<p style='margin:0'><b>Gastos por etiquetas</b></p>";
    html +=   "<p style='margin:0;margin-top:6px;font-size:12px;opacity:0.9'>Dica: clique em uma etiqueta para abrir as transações detalhadas (respeitando os filtros).</p>";

    // filtros
html += "<div style='margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end'>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:160px'>" +
          "<label style='font-size:11px;opacity:0.85'>Mês</label>" +
          `<select data-etq="mes" id="vektor-etq-mes" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(meses, st.mes, "Todos") + "</select></div>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:220px'>" +
          "<label style='font-size:11px;opacity:0.85'>Time</label>" +
          `<select data-etq="time" id="vektor-etq-time" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(times, st.time, "Todos") + "</select></div>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:140px'>" +
          "<label style='font-size:11px;opacity:0.85'>Loja</label>" +
          `<select data-etq="loja" id="vektor-etq-loja" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(lojas, st.loja, "Todas") + "</select></div>";
html +=   "<div style='display:flex;flex-direction:column;gap:4px;min-width:260px;flex:1'>" +
          "<label style='font-size:11px;opacity:0.85'>Etiqueta</label>" +
          `<select data-etq="etiqueta" id="vektor-etq-etiqueta" style="border:1px solid #cbd5e1;border-radius:6px;padding:6px 8px;font-size:12px">` +
          opt(etiquetas, st.etiqueta, "Todas") + "</select></div>";
html +=   "<button type='button' id='vektor-etq-limpar' data-etq-action='limpar' " +
          "style='background:#0f172a;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Limpar</button>";
html +=   "<button type='button' data-etq-action='periodo' " +
          "style='background:#334155;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Alterar período</button>";
html += "</div>";

// Modal de período (popup) — fica sempre no DOM, mas escondido
const stPer = window.__vektorEtiquetasState || {};
const vIni = stPer.periodoIni || "";
const vFim = stPer.periodoFim || "";

html +=
  "<div id='vektor-etq-periodo-modal' style='display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)'>" +
    "<div style='background:#fff;border-radius:14px;width:min(520px,92vw);padding:16px;border:1px solid #e2e8f0;box-shadow:0 25px 60px rgba(0,0,0,0.35)'>" +
      "<div style='display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px'>" +
        "<div style='font-weight:900;color:#0f172a'>Alterar período</div>" +
        "<button type='button' data-etq-action='periodo-fechar' style='background:transparent;border:0;font-size:18px;cursor:pointer;line-height:1'>×</button>" +
      "</div>" +

      "<div style='display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end'>" +
        "<div style='display:flex;flex-direction:column;gap:4px;min-width:200px;flex:1'>" +
          "<label style='font-size:11px;opacity:0.85'>Data inicial</label>" +
          "<input type='date' id='vektor-etq-per-ini-modal' value='" + escHtml_(vIni) + "' " +
          "style='border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;font-size:12px' />" +
        "</div>" +
        "<div style='display:flex;flex-direction:column;gap:4px;min-width:200px;flex:1'>" +
          "<label style='font-size:11px;opacity:0.85'>Data final</label>" +
          "<input type='date' id='vektor-etq-per-fim-modal' value='" + escHtml_(vFim) + "' " +
          "style='border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;font-size:12px' />" +
        "</div>" +
      "</div>" +

      "<div style='display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap'>" +
        "<button type='button' data-etq-action='periodo-cancelar' style='background:#e2e8f0;color:#0f172a;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Cancelar</button>" +
        "<button type='button' data-etq-action='periodo-aplicar' style='background:#005E27;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Aplicar</button>" +
      "</div>" +

      "<div id='vektor-etq-periodo-erro' style='margin-top:10px;font-size:12px;color:#b91c1c;display:none'></div>" +
    "</div>" +
  "</div>";

    // tabela principal (thead sticky)
    html += "<div style='margin-top:10px'>";
    html +=   "<div style='overflow:auto; max-height:45vh; border:1px solid #cbd5e1; border-radius:10px;'>";
    html +=     "<table id='tabela-etiquetas-clara' style='border-collapse:collapse;width:100%; font-size:12px; border:2px solid #000;'>";
    html +=       "<thead><tr>";
    const th = "background:#003366;color:#ffffff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;";
    html +=         "<th style='"+th+"position:sticky;top:0;z-index:10;text-align:left;'>Etiqueta / Tag</th>";
    html +=         "<th style='"+th+"position:sticky;top:0;z-index:10;text-align:right;'>% de uso (valor)</th>";
    html +=         "<th style='"+th+"position:sticky;top:0;z-index:10;text-align:right;'>Valor total</th>";
    html +=       "</tr></thead><tbody>";

    itens.forEach(it => {
      const etiqueta = String(it.etiqueta || "");
      const perc = formatPct(it.percentual || 0);
      const vNum = Number(it.valorTotal || 0);
      const val = formatBRL(vNum);

      let t = 0;
      if (maxValor > minValor) {
        t = (vNum - minValor) / (maxValor - minValor);
        if (t < 0) t = 0; if (t > 1) t = 1;
      }
      const alpha = 0.12 + (0.55 * t);
      const bgVal = `background: rgba(0,94,39,${alpha.toFixed(3)});`;

      html += "<tr class='vektor-etq-row' data-etiqueta=\"" + escHtml_(etiqueta) + "\" " +
              "title='Clique para abrir as transações desta etiqueta (respeitando os filtros).' style='cursor:pointer;'>" +
              "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;'>" + escHtml_(etiqueta) + "</td>" +
              "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;'>" + escHtml_(perc) + "</td>" +
              "<td style='border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;text-align:right;" + bgVal + "'>" + escHtml_(val) + "</td>" +
              "</tr>";
    });

    html += "</tbody><tfoot><tr>" +
            "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;font-weight:bold;'>TOTAL</td>" +
            "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>100,0 %</td>" +
            "<td style='border-top:3px double #000;border:1px solid #000;padding:6px 8px;text-align:right;font-weight:bold;'>" + escHtml_(formatBRL(somaValores)) + "</td>" +
            "</tr></tfoot></table></div>";

    html += "<div style='text-align:right; margin-top:8px;'>" +
            "<button type='button' onclick=\"exportTableToCSV(this, 'gastos_por_etiquetas')\" " +
            "style='background:#005E27;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Exportar CSV</button></div>";

    html += "<div id='vektor-etq-detalhe' style='margin-top:12px;'></div>";
    html += "</div></div></div>";

    return html;
  }

  function buildDetalheHtml_(etiquetaSel, rows) {
    let h = "";
    h += "<div class='text-sm text-slate-700'>";
    h += "<p style='margin:0'><b>Transações da etiqueta:</b> " + escHtml_(etiquetaSel) + "</p>";
    h += "<div style='margin-top:10px;overflow:auto;max-height:45vh;border:1px solid #cbd5e1;border-radius:10px;'>";
    h += "<table id='tabela-etiquetas-detalhe' style='border-collapse:collapse;width:100%;font-size:12px;border:2px solid #000;'><thead><tr>";
    const th2 = "background:#003366;color:#fff;border:1px solid #000;border-bottom:3px double #000;padding:6px 8px;white-space:nowrap;position:sticky;top:0;z-index:10;";
    h += "<th style='"+th2+"text-align:left;'>Loja</th>";
    h += "<th style='"+th2+"text-align:left;'>Time</th>";
    h += "<th style='"+th2+"text-align:left;'>Data</th>";
    h += "<th style='"+th2+"text-align:left;'>Estabelecimento</th>";
    h += "<th style='"+th2+"text-align:right;'>Valor</th>";
    h += "<th style='"+th2+"text-align:left;'>Etiqueta inserida</th>";
    h += "<th style='"+th2+"text-align:left;'>Item comprado (descrição)</th>";
    h += "</tr></thead><tbody>";

    const td = "border:1px solid #000;border-bottom:2px double #000;padding:4px 8px;vertical-align:top;";
    rows.forEach(r => {
      h += "<tr>";
      h += "<td style='"+td+"white-space:nowrap;'>" + escHtml_(r.loja || "") + "</td>";
      h += "<td style='"+td+"white-space:nowrap;'>" + escHtml_(r.time || "") + "</td>";
      h += "<td style='"+td+"white-space:nowrap;'>" + escHtml_(r.data || "") + "</td>";
      h += "<td style='"+td+"min-width:260px;'>" + escHtml_(r.estabelecimento || "") + "</td>";
      h += "<td style='"+td+"text-align:right;white-space:nowrap;'>" + escHtml_(formatBRL(r.valor || 0)) + "</td>";
      h += "<td style='"+td+"min-width:240px;'>" + escHtml_(r.etiqueta || "") + "</td>";
      h += "<td style='"+td+"min-width:360px;'>" + escHtml_(r.descricao || "") + "</td>";
      h += "</tr>";
    });

    h += "</tbody></table></div>";
    h += "<div style='display:flex;gap:8px;justify-content:flex-end;margin-top:8px;flex-wrap:wrap'>";
    h += "<button type='button' onclick=\"exportTableToCSV(this, 'base_gastos_por_etiquetas')\" style='background:#005E27;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Exportar CSV</button>";
    h += "<button type='button' id='btn-email-etq' data-etq-action='email' style='background:#0f172a;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer'>Enviar por e-mail</button>";

    h += "</div>";
    h += "<div id='vektor-etq-email-status' style='margin-top:8px;font-size:12px;opacity:0.9;'></div>";
    h += "</div>";

    // Modal de envio por e-mail (destinatário)
h +=
  "<div id='vektor-etq-email-modal' style='display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)'>" +
    "<div style='background:#fff;border-radius:14px;width:min(520px,92vw);padding:16px;border:1px solid #e2e8f0;box-shadow:0 25px 60px rgba(0,0,0,0.35)'>" +
      "<div style='display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px'>" +
        "<div style='font-weight:900;color:#0f172a'>Enviar por e-mail</div>" +
        "<button type='button' data-etq-email-action='fechar' style='background:transparent;border:0;font-size:18px;cursor:pointer;line-height:1'>×</button>" +
      "</div>" +

      "<div style='display:flex;flex-direction:column;gap:6px'>" +
        "<label style='font-size:11px;opacity:0.85'>Destinatário</label>" +
        "<input type='email' id='vektor-etq-email-to' placeholder='ex: gerente@centauro.com.br' " +
          "style='border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;font-size:12px' />" +
        "<div style='font-size:11px;color:#475569;margin-top:4px'>" +
          "Obs.: seu e-mail será copiado automaticamente (CC), exceto se você informar o seu próprio e-mail como destinatário." +
        "</div>" +
      "</div>" +

      "<div style='display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap'>" +
        "<button type='button' data-etq-email-action='cancelar' style='background:#e2e8f0;color:#0f172a;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Cancelar</button>" +

        // ✅ NOVO: usar meu e-mail
        "<button type='button' data-etq-email-action='meuemail' style='background:#f1f5f9;color:#0f172a;border:1px solid #cbd5e1;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Usar meu e-mail</button>" +

        "<button type='button' data-etq-email-action='enviar' style='background:#0f172a;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer'>Enviar</button>" +
      "</div>" +

      "<div id='vektor-etq-email-erro' style='margin-top:10px;font-size:12px;color:#b91c1c;display:none'></div>" +
    "</div>" +
  "</div>";

    return h;
  }

  async function loadResumo_() {
  const st = window.__vektorEtiquetasState || {};

  // ✅ Debounce simples (evita martelar o backend em mudanças rápidas)
  window.__vektorEtiquetasDebounceId = window.__vektorEtiquetasDebounceId || null;
  if (window.__vektorEtiquetasDebounceId) clearTimeout(window.__vektorEtiquetasDebounceId);

  // ✅ Controle de requisição (evita resposta velha sobrescrever a nova)
  window.__vektorEtiquetasReqSeq = (window.__vektorEtiquetasReqSeq || 0) + 1;
  const reqId = window.__vektorEtiquetasReqSeq;

  const el = document.getElementById(panelId);
  if (el) {
    // feedback imediato (UI responde na hora)
    el.style.opacity = "0.85";
    el.style.pointerEvents = "none";
  }

  // mostra overlay no centro do painel enquanto carrega
  const ov = document.querySelector("#" + panelId + " #vektor-etq-loading-overlay");
  if (ov) ov.style.display = "flex";

  window.__vektorEtiquetasDebounceId = setTimeout(() => {
    google.script.run
      .withSuccessHandler(function(res) {
        // ignora respostas antigas
        if (reqId !== window.__vektorEtiquetasReqSeq) return;

        const el2 = document.getElementById(panelId);
        if (!el2) return;

        if (!res || !res.ok) {
          el2.innerHTML = "<p style='margin:0;color:#b91c1c'><b>Falha ao carregar.</b></p>";
          el2.style.opacity = "1";
          el2.style.pointerEvents = "auto";
          const ov2 = document.querySelector("#" + panelId + " #vektor-etq-loading-overlay");
            if (ov2) ov2.style.display = "none";
          return;
        }

        el2.innerHTML = buildPainelHtml_(res);
        el2.style.opacity = "1";
        el2.style.pointerEvents = "auto";
      })
      .withFailureHandler(function(err) {
        if (reqId !== window.__vektorEtiquetasReqSeq) return;

        const el2 = document.getElementById(panelId);
        if (!el2) return;

        const msg = (err && err.message) ? err.message : String(err || "Erro");
        el2.innerHTML = "<p style='margin:0;color:#b91c1c'><b>Falha:</b> " + escHtml_(msg) + "</p>";
        el2.style.opacity = "1";
        el2.style.pointerEvents = "auto";
        const ov2 = document.querySelector("#" + panelId + " #vektor-etq-loading-overlay");
          if (ov2) ov2.style.display = "none";
      })
      .getGastosPorEtiquetasClara(st);
  }, 180); // 180ms = rápido, mas já evita “spam” de chamadas
}

  function clearDetalhe_() {
    const det = document.querySelector("#" + panelId + " #vektor-etq-detalhe");
    if (det) det.innerHTML = "";
  }

  // 2) bind único (delegação) — não duplica e não perde listeners
  function bindOnce_() {
  if (window.__vektorEtiquetasBound) return;
  window.__vektorEtiquetasBound = true;

  document.addEventListener("change", function(e) {
    const el = e.target;
    if (!el || !el.matches) return;

    if (!el.matches("#vektor-etq-mes, #vektor-etq-time, #vektor-etq-loja, #vektor-etq-etiqueta")) return;

    const st = window.__vektorEtiquetasState || {};
    st.mes = (document.getElementById("vektor-etq-mes") || {}).value || "";
    st.time = (document.getElementById("vektor-etq-time") || {}).value || "";
    st.loja = (document.getElementById("vektor-etq-loja") || {}).value || "";
    st.etiqueta = (document.getElementById("vektor-etq-etiqueta") || {}).value || "";
    window.__vektorEtiquetasState = st;

    clearDetalhe_();
    loadResumo_();
  });

  document.addEventListener("click", function(e) {
    const btnLimpar = e.target && e.target.closest && e.target.closest("[data-etq-action='limpar']");
    const btnPeriodo = e.target && e.target.closest && e.target.closest("[data-etq-action='periodo']");

    if (btnPeriodo) {
  const modal = document.getElementById("vektor-etq-periodo-modal");
  if (!modal) return;

  // pré-preenche com o state atual
  const st = window.__vektorEtiquetasState || {};
  const iniEl = document.getElementById("vektor-etq-per-ini-modal");
  const fimEl = document.getElementById("vektor-etq-per-fim-modal");
  if (iniEl) iniEl.value = st.periodoIni || "";
  if (fimEl) fimEl.value = st.periodoFim || "";

  const err = document.getElementById("vektor-etq-periodo-erro");
  if (err) { err.style.display = "none"; err.textContent = ""; }

  modal.style.display = "flex";
  return;
}

const btnFecharPeriodo = e.target && e.target.closest && e.target.closest("[data-etq-action='periodo-fechar'],[data-etq-action='periodo-cancelar']");
if (btnFecharPeriodo) {
  const modal = document.getElementById("vektor-etq-periodo-modal");
  if (modal) modal.style.display = "none";
  return;
}

const btnAplicarPeriodo = e.target && e.target.closest && e.target.closest("[data-etq-action='periodo-aplicar']");
if (btnAplicarPeriodo) {
  const iniEl = document.getElementById("vektor-etq-per-ini-modal");
  const fimEl = document.getElementById("vektor-etq-per-fim-modal");
  const ini = iniEl ? String(iniEl.value || "").trim() : "";
  const fim = fimEl ? String(fimEl.value || "").trim() : "";

  const err = document.getElementById("vektor-etq-periodo-erro");
  function showErr(msg){
    if (!err) return;
    err.style.display = "block";
    err.textContent = msg;
  }

  if (!ini || !fim) { showErr("Preencha data inicial e final."); return; }
  if (ini > fim) { showErr("Período inválido: a data inicial não pode ser maior que a final."); return; }

  // Atualiza state e zera filtros do painel
  const st = window.__vektorEtiquetasState || {};
  st.periodoIni = ini;
  st.periodoFim = fim;

  st.mes = "";
  st.time = "";
  st.loja = "";
  st.etiqueta = "";
  window.__vektorEtiquetasState = st;

  // Fecha modal
  const modal = document.getElementById("vektor-etq-periodo-modal");
  if (modal) modal.style.display = "none";

  // IMPORTANTE: não chamar listarGastosPorEtiquetasClara() (isso gera mensagem e re-fluxo).
  clearDetalhe_();
  loadResumo_();
  return;
}

    if (btnLimpar) {
      const st = window.__vektorEtiquetasState || {};
        window.__vektorEtiquetasState = { 
          mes:"", time:"", loja:"", etiqueta:"",
          periodoIni: st.periodoIni || "",
          periodoFim: st.periodoFim || ""
        };
      clearDetalhe_();
      loadResumo_();
      return;
    }

    const tr = e.target && e.target.closest && e.target.closest(".vektor-etq-row");
    if (!tr) return;

    const etiquetaSel = tr.getAttribute("data-etiqueta") || "";
    const st = window.__vektorEtiquetasState || {};
    const payload = { 
          mes: st.mes || "", time: st.time || "", loja: st.loja || "",
          etiqueta: etiquetaSel,
          periodoIni: st.periodoIni || "",
          periodoFim: st.periodoFim || ""
        };

    const wrapId = "vektor-etq-detailwrap-" + Date.now();

    renderBotMessage(
      "HTML:<div class='text-sm text-slate-700' id='" + wrapId + "' style='margin:0'>" +
        "<div style='margin-top:0' id='" + wrapId + "-content'>" +
          "<p style='margin:0'><b>Carregando transações da etiqueta</b> " + escHtml_(etiquetaSel) + "…</p>" +
        "</div>" +
      "</div>"
    );

    google.script.run
      .withSuccessHandler(function(resp) {
        const rows = resp && resp.ok && Array.isArray(resp.rows) ? resp.rows : [];
        const contentEl = document.getElementById(wrapId + "-content");
        if (!contentEl) return;

        if (!rows.length) {
          contentEl.innerHTML = "<p style='margin:0'>Sem transações para os filtros atuais.</p>";
          return;
        }

        contentEl.innerHTML = buildDetalheHtml_(etiquetaSel, rows);

        const btnEmail = document.querySelector("#" + wrapId + " #btn-email-etq");
        if (btnEmail) {
        btnEmail.addEventListener("click", function() {

    const modal = document.querySelector("#" + wrapId + " #vektor-etq-email-modal");
    if (!modal) return;

    const toEl   = document.querySelector("#" + wrapId + " #vektor-etq-email-to");
    const errEl  = document.querySelector("#" + wrapId + " #vektor-etq-email-erro");
    const btnSend = modal.querySelector("[data-etq-email-action='enviar']");

    const meuEmail = (typeof USER_EMAIL_REPLACED !== "undefined"
    ? String(USER_EMAIL_REPLACED || "").trim()
    : "");

    // limpa estado visual
    if (errEl) { errEl.style.display = "none"; errEl.textContent = ""; }
    if (toEl) toEl.value = "";

    // abre modal
    modal.style.display = "flex";

    // bind único do modal (para não duplicar listeners)
    if (modal.dataset.bound === "1") return;
    modal.dataset.bound = "1";

    function closeModal_() {
      modal.style.display = "none";
      if (errEl) { errEl.style.display = "none"; errEl.textContent = ""; }
    }

    modal.addEventListener("click", function(ev) {
  // ✅ novo botão: preencher destinatário com meu e-mail
      const useMyBtn = ev.target && ev.target.closest && ev.target.closest("[data-etq-email-action='meuemail']");
      if (useMyBtn) {
        if (toEl) toEl.value = meuEmail || "";
        if (errEl) { errEl.style.display = "none"; errEl.textContent = ""; }
        if (toEl) toEl.focus();
        return;
      }

      // fechar/cancelar
      const closeBtn = ev.target && ev.target.closest && ev.target.closest("[data-etq-email-action='fechar'],[data-etq-email-action='cancelar']");
      if (closeBtn) closeModal_();
    });

    btnSend.addEventListener("click", function() {
      const emailDestino = toEl ? String(toEl.value || "").trim() : "";
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailDestino || !emailRegex.test(emailDestino)) {
        if (errEl) {
          errEl.style.display = "block";
          errEl.textContent = "Informe um e-mail válido para o destinatário.";
        }
        return;
      }

      // trava botão enquanto envia
      btnSend.disabled = true;
      btnSend.textContent = "Enviando...";

      // envia para o back com destinatário informado
      const payloadEmail = Object.assign({}, payload, { emailDestino: emailDestino });

      google.script.run
          .withSuccessHandler(function(rEmail) {
            btnSend.disabled = false;
            btnSend.textContent = "Enviar";

            // Se o back-end retornou erro, mostra no modal e NÃO fecha
            if (!rEmail || rEmail.ok !== true) {
              const msg = (rEmail && rEmail.error) ? String(rEmail.error) : "Falha ao enviar o e-mail.";
              if (errEl) {
                errEl.style.display = "block";
                errEl.textContent = msg;
              }
              return;
            }

            // Sucesso: fecha modal e mostra status no rodapé (opcional)
            closeModal_();

            const statusEl = document.querySelector("#" + wrapId + " #vektor-etq-email-status");
            if (statusEl) {
              const to = (rEmail && rEmail.to) ? rEmail.to : emailDestino;
              statusEl.innerHTML =
                "<span style='color:#16a34a;font-weight:800;'>E-mail enviado:</span> <b>Base de Gastos por Etiquetas</b> para <b>" + escHtml_(to) + "</b>.";
            }
          })
        .withFailureHandler(function(err) {
          btnSend.disabled = false;
          btnSend.textContent = "Enviar";

          if (errEl) {
            errEl.style.display = "block";
            errEl.textContent = (err && err.message) ? err.message : String(err || "Falha ao enviar.");
          }
        })
        .enviarEmailGastosPorEtiquetasClara(payloadEmail);
    });

  });
}
      })
      .withFailureHandler(function(err) {
        const contentEl = document.getElementById(wrapId + "-content");
        if (!contentEl) return;
        const msg = (err && err.message) ? err.message : String(err || "Erro desconhecido");
        contentEl.innerHTML = "<p style='margin:0;color:#b91c1c'><b>Falha:</b> " + escHtml_(msg) + "</p>";
      })
      .getTransacoesPorEtiquetaClara(payload);
  });
}

  // Mensagem (bolha) separada — aparece só uma vez por sessão do painel
if (!window.__vektorEtiquetasIntroShown) {
  window.__vektorEtiquetasIntroShown = true;
  await renderBotMessage(
    "HTML:<p class='text-sm text-slate-700' style='margin:0'>" +
      "Vou montar o painel de <b>Gastos por etiquetas</b> com filtros e detalhamento." +
    "</p>"
  );
}

  // execução
  await ensurePanelBubble_();
  bindOnce_();
  const elBoot = document.getElementById(panelId);
  if (elBoot) {
    elBoot.innerHTML = "<p style='margin:0;opacity:0.9'>Carregando dados do período selecionado, pode demorar um pouco...</p>";
  }
  await loadResumo_();
}

// Backward-compat: evita quebra caso algum trecho ainda chame o nome antigo
function listarEtiquetasClara() {
  return listarGastosPorEtiquetasClara();
}

    /* ========= ENVIO (ENTER / BOTÃO) ========= */

    function enviarMensagem() {

    // 🆕 cancela timeout de pendências ao responder
    if (typeof pendenciasTimeoutId !== "undefined" && pendenciasTimeoutId) {
        clearTimeout(pendenciasTimeoutId);
        pendenciasTimeoutId = null;
    }

    const texto = userInput.value.trim();
    if (!texto) return;

    // Mostra a mensagem do usuário no chat
    renderUserMessage(texto);
    userInput.value = "";  // limpa aqui, sempre

    // 🌟 FLUXO ESPECIAL: estamos aguardando o NOME para o Termo de Responsabilidade
    if (window.vektorTermoAguardandoNome && window.vektorTermoPending) {

        const nomeCompleto = texto;

        const payload = Object.assign({}, window.vektorTermoPending, {
            usuarioNome: nomeCompleto
        });

        // Limpa o estado ANTES da chamada para evitar duplicidade
        window.vektorTermoAguardandoNome = false;
        window.vektorTermoPending = null;

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Registrando o seu Termo de Responsabilidade. Aguarde...</p>"
        );

        google.script.run
            .withSuccessHandler(function (res) {
                if (res && res.ok) {
                    // Mensagem principal + link do Drive na mesma frase
                    renderBotMessage(
                        "HTML:" +
                        "<p class='text-sm text-slate-700'>" +
                        "Termo de Responsabilidade salvo com sucesso para <b>" + nomeCompleto + "</b>. " +
                        (res.fileUrl
                            ? "Link interno (Drive): <a href='" + res.fileUrl +
                            "' target='_blank' class='text-slate-700 underline'>Abrir Termo</a>."
                            : ""
                        ) +
                        "</p>"
                    );

                    // Mensagem complementar em outra bolha
                    setTimeout(function () {
                        renderBotMessage(
                            "HTML:" +
                            "<p class='text-sm text-slate-700'>" +
                            "Caso o cartão ainda esteja impossibilitado de uso devido ao não envio do Termo assinado, " +
                            "em breve ele estará ativo. Fique de olho no aplicativo da Clara." +
                            "</p>"
                        );
                    }, 3000);

                } else {
                    // Caso o backend tenha retornado ok: false
                    renderBotMessage(
                        "HTML:" +
                        "<p class='text-sm text-red-700'>Não consegui salvar o termo. Motivo: " +
                        (res && res.error ? res.error : "erro desconhecido") +
                        "</p>"
                    );
                }
            })
            .withFailureHandler(function (err) {
                // Erro de comunicação Apps Script
                renderBotMessage(
                    "HTML:" +
                    "<p class='text-sm text-red-700'>Falha na comunicação ao salvar o termo: " +
                    (err && err.message ? err.message : err) +
                    "</p>"
                );
            })
            .salvarTermoResponsabilidade(payload);

        // IMPORTANTE: não segue para o fluxo normal de pergunta/resposta
        return;
    }

    // ===== FLUXO NORMAL DO VEKTOR (mantido como já estava) =====

    // Normaliza o texto para busca de intenção
    const norm = normalize(texto || "");

    // =====================================================
    // ✅ FREQUÊNCIA DE USO CLARA (POR TIME OU LOJA)
    // =====================================================
    if (norm.startsWith("frequencia de uso clara")) {

        let tipo = "";
        let valor = "";

        // Captura "para time ..." ou "para o time ..." e para antes do período ("nos ultimos X meses")
        const mTime = norm.match(/\bpara\s+(?:o\s+)?time\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:no|nos|na|nas)\s+ultim[oa]s?\b|$)/i);

        // Captura "para loja ..." ou "para a loja ..." e para antes do período
        const mLoja = norm.match(/\bpara\s+(?:a\s+)?loja\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:no|nos|na|nas)\s+ultim[oa]s?\b|$)/i);

        if (mLoja) {
            tipo = "loja";

            // ✅ pega SOMENTE o número da loja (funciona com autocomplete: "0242 - Loja X")
            const matchNum = (mLoja[1] || "").match(/\d{1,6}/);
            valor = matchNum ? matchNum[0] : "";

            if (!valor) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-slate-700'>Não consegui identificar o número da loja. Ex.: <b>frequência de uso Clara para a loja 242</b>.</p>"
                );
                return;
            }

        } else if (mTime) {
            tipo = "time";
            valor = (mTime[1] || "").trim();

            // ✅ remove complemento de período do "valor" do time (caso venha colado)
            valor = valor
                .replace(/\s+(no|nos|na|nas)\s+ultim[oa]s?\s+.*$/i, "")
                .trim();

            // fallback: corta em " ultimos " ou " ultimo " se ainda sobrar algo
            valor = valor
                .split(" ultimos ")[0]
                .split(" ultimo ")[0]
                .trim();

            if (!valor) {
                renderBotMessage(
                    "HTML:<p class='text-sm text-slate-700'>Não consegui identificar o nome do time. Ex.: <b>frequência de uso Clara para o time Furacão Sul</b>.</p>"
                );
                return;
            }

        } else {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Me diga se é por <b>time</b> ou por <b>loja</b>. Ex.: <b>frequência de uso Clara para a loja 242</b>.</p>"
            );
            return;
        }

        const mesesBack = vektorParseMesesBack(norm);

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Consultando frequência de uso…</p>"
        );

        google.script.run
            .withSuccessHandler(vektorRenderTabelaFrequenciaUso)
            .withFailureHandler(function (err) {
                console.error(err);
                renderBotMessage(
                    "HTML:<p class='text-sm text-slate-700'>Falha ao consultar frequência de uso.</p>"
                );
            })
            .getFrequenciaUsoClara(tipo, valor, mesesBack);

        return; // ⛔ IMPORTANTE: impede cair no fluxo genérico
    }

    // =====================================================
    // ✅ LISTA ITENS COMPRADOS (ADM) — por TIME ou LOJA + período
    // =====================================================
    // ✅ aceita: "lista itens comprados..." e também "itens comprados..."
        const isCmdListaItens =
          /^\s*lista(\s+de)?\s+itens\s+comprad/i.test(norm) ||
          /^\s*itens\s+comprad/i.test(norm);

        if (isCmdListaItens) {

        // ✅ Caso geral (sem loja/time)
if (/\bno\s+geral\b/i.test(norm)) {
  const periodo = extrairIntervaloDatas(texto);
  if (!periodo || !periodo.dataInicio || !periodo.dataFim) {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Informe um período. Ex.: <b>itens comprados no geral de 01/12/2025 a 15/12/2025</b> (ou use <b>este mês</b>, <b>últimos 30 dias</b> etc.).</p>"
    );
    return;
  }

  function fmtBR(d) {
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  const dataIni = fmtBR(periodo.dataInicio);
  const dataFim = fmtBR(periodo.dataFim);

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Consultando itens comprados <b>no geral</b> de <b>" + dataIni + "</b> a <b>" + dataFim + "</b>…</p>"
  );

  google.script.run
    .withSuccessHandler(vektorRenderTabelaListaItensComprados)
    .withFailureHandler(function(err){
      console.error(err);
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao listar itens comprados.</p>");
    })
    .getListaItensCompradosClara("geral", "", dataIni, dataFim, 300); // <- ajuste o limite como preferir

  return;
}

        let tipo = "";
        let valor = "";

        // Captura “por time ...”
        const mTime = norm.match(/\b(?:por|para)\s+(?:o|os)?\s*times?\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:de|no|nos|na|nas|nessa|nesta|neste|ultima|última|ultimos|últimos|semana|mes|mês)\b|$)/i);

        // Captura “por loja ...”
        const mLoja = norm.match(/\b(?:por|para)\s+(?:a|as)?\s*lojas?\b\s*[:\-]?\s*([\s\S]+?)(?=\s+\b(?:de|no|nos|na|nas|nessa|nesta|neste|ultima|última|ultimos|últimos|semana|mes|mês)\b|$)/i);

        if (mTime && mTime[1]) {
            tipo = "time";
            valor = (mTime[1] || "").trim();
        } else if (mLoja && mLoja[1]) {
            tipo = "loja";

            // ✅ pega SOMENTE o número da loja (evita "0255 - CE255 - ..." quebrar filtro)
            const matchNum = (mLoja[1] || "").match(/\d{1,6}/);
            valor = matchNum ? matchNum[0] : "";
        } else {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Me diga se é por <b>loja</b> ou por <b>time</b>. Ex.: <b>lista itens comprados por loja 0287 de 01/12/2025 a 15/12/2025</b>.</p>"
            );
            return;
        }

        // ✅ remove "este mês / neste mês / esse mês / nesse mês" que veio grudado no nome do time/loja
        valor = valor
          .replace(/\b(neste|nesta|este|esta|nesse|nessa|esse|essa)\s+m[eê]s\b.*$/i, "")
          .trim();

        if (!valor) {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Não consegui identificar o filtro. Ex.: <b>lista itens comprados por loja 0287 este mês</b> ou <b>...por time Lobos SP este mês</b>.</p>"
            );
            return;
        }

        // Extrai período usando o parser padrão do projeto
        const periodo = extrairIntervaloDatas(texto);
        if (!periodo || !periodo.dataInicio || !periodo.dataFim) {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Informe um período. Ex.: <b>de 01/12/2025 a 15/12/2025</b> (ou use <b>este mês</b>, <b>últimos 30 dias</b> etc.).</p>"
            );
            return;
        }

        function fmtBR(d) {
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        const dataIni = fmtBR(periodo.dataInicio);
        const dataFim = fmtBR(periodo.dataFim);

        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Consultando itens comprados (" + tipo + ": <b>" + valor + "</b>) de <b>" + dataIni + "</b> a <b>" + dataFim + "</b>…</p>"
        );

        google.script.run
            .withSuccessHandler(vektorRenderTabelaListaItensComprados)
            .withFailureHandler(function (err) {
                console.error(err);
                renderBotMessage("HTML:<p class='text-sm text-slate-700'>Falha ao listar itens comprados.</p>");
            })
            .getListaItensCompradosClara(tipo, valor, dataIni, dataFim, 15);

        return; // ⛔ não cair no fluxo genérico
    }

    // =====================================================
// ✅ RELAÇÃO DE SALDOS (ADM) — por TIME / LOJA / GERAL
// Exemplos:
// - "relação de saldos geral"
// - "relação de saldos do time lobos sp"
// - "relação de saldos da loja 0242"
// =====================================================
const isCmdRelacaoSaldos = /^\s*rela[cç][aã]o\s+de\s+saldos\b/i.test(norm);

if (isCmdRelacaoSaldos) {

  let tipo = "geral";
let valor = "";

// Geral
if (/\b(no\s+geral|geral)\b/i.test(norm)) {
  tipo = "geral";
  valor = "";
} else {
  // Time
  const mTime = norm.match(/\bdo\s+time\s+(.+?)\s*$/i);

  if (mTime && mTime[1]) {
    tipo = "time";
    valor = (mTime[1] || "").trim();
  } else {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Use: <b>Relação de saldos geral</b> ou <b>Relação de saldos do time X</b>.</p>"
    );
    return;
  }
}

  // Data limite = hoje - 2 dias (D-2), formato dd/MM/yyyy
(function () {
  const d = new Date();
  d.setDate(d.getDate() - 2);

  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  const dataLimite = `${dd}/${mm}/${yyyy}`;

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-700'>Consultando relação de saldos... " +
      "Lembrando que a análise é feita até o dia <b>" + dataLimite + "</b>, " +
      "devido ao conjunto de transações consultadas sempre serem com o status de <b>Aprovada</b>.</p>"
  );
})();

  google.script.run
    .withSuccessHandler(function (res) {
      vektorRenderTabelaRelacaoSaldos(res, tipo);
    })
    .withFailureHandler(function (err) {
      console.error(err);
      var msg = (err && (err.message || err.toString)) ? (err.message || String(err)) : "Falha ao consultar relação de saldos.";
      renderBotMessage("HTML:<p class='text-sm text-slate-700'>" + msg + "</p>");
    })
    .getRelacaoSaldosClara(tipo, valor);

  return; // ⛔ importante
}

// =====================================================
// ✅ COMPARATIVO FATURA ATUAL VS ANTERIOR (CHAT)
// Comando: "comparar fatura" / "comparar fatura atual vs anterior"
// =====================================================
const isCmdCompararFatura = /^\s*compar(ar|ação|acao)\s+fatura\b/i.test(norm) ||
                            /^\s*fatura\s+atual\s+vs\s+anterior\b/i.test(norm);

if (isCmdCompararFatura) {
  renderBotMessage("HTML:<p class='text-sm text-slate-700'>Efetuando cálculos para demonstrar comparação...</p>");

  google.script.run
    .withSuccessHandler(function(res){
      try {
        renderTabelaComparativoFaturas(res);
      } catch (e) {
        console.error("Erro ao renderizar comparativo de faturas:", e);
        renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Erro ao renderizar tabela:</b> " + (e && e.message ? e.message : e) + "</p>");
      }
    })
    .withFailureHandler(function(err){
      console.error("Falha na consulta comparativo faturas:", err);
      var msg = (err && err.message) ? err.message : JSON.stringify(err);
      renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Falha ao consultar comparativo de faturas:</b> " + msg + "</p>");
    })
    .getComparativoFaturasClaraParaChat();

  return; // ⛔ importante
}

// =====================================================
// ✅ TABELA DE ESTORNOS (ADM)
// Comandos:
// - "tabela de estornos"
// - "tabela de estornos do time X"
// =====================================================
const isCmdTabelaEstornos = /^\s*tabela\s+de\s+estornos\b/i.test(norm);

if (isCmdTabelaEstornos) {

  const m = norm.match(/tabela\s+de\s+estornos\s+do\s+time\s+(.+)$/i);

  let tipoFiltro = "geral";
  let valorFiltro = "";

  if (m && m[1]) {
    tipoFiltro = "time";
    valorFiltro = (texto || "").split(/tabela\s+de\s+estornos\s+do\s+time/i)[1] || "";
    valorFiltro = valorFiltro.trim();
  }

  renderBotMessage(
    "HTML:<p class='text-sm text-slate-500'>Buscando estornos…</p>"
  );

  google.script.run
  .withSuccessHandler(function (res) {
    // Se você já recebe um HTML direto ou um array, renderiza como antes
    // Se o seu backend já retorna {ok:false,error:"..."} em alguns casos:
    if (res && res.ok === false) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>" +
        (res.error ? res.error : "Não disponível para o seu perfil.") +
        "</p>"
      );
      return;
    }

    vektorRenderTabelaEstornos(res, tipoFiltro);
  })
  .withFailureHandler(function (err) {
    const msg = (err && err.message) ? err.message : String(err || "");

    // Permissão (RBAC)
    if (msg.toLowerCase().includes("não disponível para o seu perfil")) {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Esse comando não está disponível para o seu perfil.</p>"
      );
      return;
    }

    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Erro ao buscar estornos: " +
      (msg ? msg : "erro desconhecido") +
      "</p>"
    );
  })
  .getTabelaEstornosClara(tipoFiltro, valorFiltro);

return; // ⛔ mantém isso
}

// =====================================================
// ✅ POSSÍVEL USO IRREGULAR (ADM)
// Comando: "possível uso irregular"
// =====================================================
const isCmdUsoIrregular = /^\s*poss(i|í)vel\s+uso\s+irregular\b/i.test(norm);

if (isCmdUsoIrregular) {

  // 🔒 Apenas Administrador (mesmo padrão do estornos)
  if (typeof USER_ROLE_REPLACED !== "undefined" && USER_ROLE_REPLACED !== "Administrador") {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Esse comando está disponível apenas para perfil <b>Administrador</b>.</p>"
    );
    return;
  }

  renderBotMessage(
  "HTML:" +
  "<div class='text-sm text-slate-700'>" +
    "<p style='margin:0 0 6px 0; font-weight:700;'>Possível uso irregular — selecione o escopo da análise:</p>" +
    "<div style='display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;'>" +

      "<button type='button' " +
        "onclick=\"window.vektorExecutarUsoIrregular('7d')\" " +
        "style='background:#0F172A;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Padrão (7 dias)" +
      "</button>" +

      "<button type='button' " +
        "onclick=\"window.vektorExecutarUsoIrregular('ciclo')\" " +
        "style='background:#334155;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Ciclo 06–05" +
      "</button>" +

      "<button type='button' " +
        "onclick=\"window.vektorExecutarUsoIrregular('full')\" " +
        "style='background:#B91C1C;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:12px;font-weight:800;cursor:pointer;'>" +
        "Base toda (investigação)" +
      "</button>" +

    "</div>" +
    "<p style='margin:8px 0 0 0; font-size:12px; color:#64748B;'>" +
      "Dica: a opção <b>Base toda</b> pode ser mais lenta e tende a gerar mais volume (use para investigação pontual)." +
    "</p>" +
  "</div>"
);

return;

}

// =====================================================
// ✅ LOJAS OFENSORAS (ADM) — histórico de pendências
// Comando: "lojas ofensoras"
// =====================================================
const isCmdLojasOfensoras = /^\s*lojas\s+ofensoras\b/i.test(norm);

if (isCmdLojasOfensoras) {

  // 🔒 Apenas Administrador
  if (typeof USER_ROLE_REPLACED !== "undefined" && USER_ROLE_REPLACED !== "Administrador") {
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Esse comando está disponível apenas para perfil <b>Administrador</b>.</p>"
    );
    return;
  }

  renderBotMessage("HTML:<p class='text-sm text-slate-700'>Consultando lojas ofensoras…</p>");

  google.script.run
  .withSuccessHandler(function(res){
    try {
      renderTabelaLojasOfensoras(res);
    } catch (e) {
      console.error("Erro ao renderizar tabela lojas ofensoras:", e);
      renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Erro ao renderizar tabela:</b> " + (e && e.message ? e.message : e) + "</p>");
    }
  })
  .withFailureHandler(function(err){
    console.error("Falha na consulta lojas ofensoras:", err);
    var msg = (err && err.message) ? err.message : JSON.stringify(err);
    renderBotMessage("HTML:<p class='text-sm text-red-700'><b>Falha ao consultar lojas ofensoras:</b> " + msg + "</p>");
  })
  .getLojasOfensorasParaChat(60);

  return; // ⛔ importante
}

    // ✅ Agora sim: gera a resposta (e então usa ACOES)
    const resposta = gerarRespostaDoBot(texto);

   // ✅ Gastos por etiquetas -> abre calendário + tabela
    if (resposta === "ACAO_GASTOS_ETIQUETAS_CLARA") {
      abrirPeriodoGastosEtiquetas_();
      return;
    }

    // ✅ Listagem de etiquetas -> resposta explicativa (catálogo)
    if (resposta === "ACAO_LISTAR_ETIQUETAS_CLARA") {
      try {
        renderBotMessage(respCatalogoEtiquetas());
      } catch (e) {
        console.error("Erro ao montar catálogo de etiquetas:", e);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Não consegui montar a listagem de etiquetas agora.</p>" +
          "<p class='text-xs text-slate-500 mt-1'>Detalhe: " + (e && e.message ? String(e.message) : String(e || "—")) + "</p>"
        );
      }
      return;
    }

    if (resposta === "ACAO_FREQUENCIA_USO_CLARA") {
        vektorMostrarFrequenciaUsoClara(texto);
        return;
    }

    // Se a intenção for listar demissões, só ADM pode ver
    if (resposta === "ACAO_LISTA_DEMISSOES") {
        if (USER_ROLE_CLEAN !== "Administrador") {
            renderBotMessage(
                "HTML:<p class='text-sm text-slate-700'>Esse comando está disponível apenas para perfil Administrador.</p>"
            );
            return;
        }

        window.vektorMostrarTabelaDemissoesAdmin();
        return;
    }

    if (resposta) renderBotMessage(resposta);

    // Depois de responder normalmente, avalia se faz sentido sugerir algo do Manual da Clara
    try {
        vektorSugerirManualAPartirDaPergunta(texto);
    } catch (e) {
        console.warn("Erro ao tentar sugerir Manual da Clara:", e);
    }

    // E também sugestões gerais (política, relatórios, pendências, etc.)
    try {
        vektorSugerirTopicosGerais(texto);
    } catch (e) {
        console.warn("Erro ao tentar sugerir tópicos gerais:", e);
    }

    userInput.focus();
}

        // ====== RESPOSTA DOS BOTÕES "SIM" / "NÃO" PARA PENDÊNCIAS ======
        window.vektorResponderConfirmacaoPendencias = function (resposta) {
  try {
    // se não estiver aguardando confirmação, ignora
    if (typeof estadoPendencias === "undefined" ||
        estadoPendencias !== "aguardando_confirmacao_email") {
      return;
    }

    // Garante que temos os elementos necessários
    if (!window.userInput || typeof enviarMensagem !== "function") {
      console.warn("userInput ou enviarMensagem não disponíveis.");
      return;
    }

    // Preenche a caixa de texto com 'sim' ou 'não' e reaproveita todo o fluxo já existente
    userInput.value = resposta;
    enviarMensagem();
  } catch (e) {
    console.error("Erro em vektorResponderConfirmacaoPendencias:", e);
  }
};

// ====== INFO INICIAL POR PERFIL (apenas Administrador) ======
let vektorJaPerguntouInfoIniciais = false;

window.vektorPerguntarInformacoesIniciais = function () {
  try {
    // Só pergunta para Administrador
    if (USER_ROLE_CLEAN !== "Administrador") return;

    // Evita perguntar repetidamente
    if (vektorJaPerguntouInfoIniciais) return;
    vektorJaPerguntouInfoIniciais = true;

    const html =
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>" +
          "Se você quer ver um resumo das principais informações de utilização do cartão Clara " +
          "(maiores transações, times com mais pendências, estabelecimentos mais usados, categorias de gasto e últimas faturas), clique no botão abaixo" +
        "</p>" +
        "<div class='mt-2 flex gap-2'>" +
          "<button type='button' " +
                  "class='px-3 py-1 rounded bg-emerald-600 text-white text-xs' " +
                  "onclick=\"window.vektorRespostaInfoIniciais('sim')\">" +
            "Mostrar resumo" +

          "</button>" +
        "</div>" +
      "</div>";

    renderBotMessage(html);
  } catch (e) {
    console.error("Erro ao perguntar info iniciais:", e);
  }
};

window.vektorMostrarTabelaDemissoesAdmin = function () {
  try {
    google.script.run
      .withSuccessHandler(function (res) {
        try {
          if (!res || !res.ok) {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Não consegui consultar as demissões no momento.</p>"
            );
            return;
          }

          const rows = Array.isArray(res.rows) ? res.rows : [];

          // Se não tiver demissões desde a data, mostra mensagem curta e segue o fluxo
          if (!rows.length) {
            renderBotMessage(
              "HTML:<div class='text-sm text-slate-700'>" +
                "<p><b>Conforme consulta efetuada no sistema de informações do RH (Senior) através da tabela de informações no BigQuery</b>, não há demissões de gerentes de lojas registradas desde <b>01/12/2025</b>.</p>" +
              "</div>"
            );
            return;
          }

          // Monta tabela
                let html =
                  "<div class='text-sm'>" +
                    "<p>Conforme consulta efetuada no sistema de informações do RH (Senior) através da tabela de informações no BigQuery, segue abaixo tabela com as últimas demissões de <b>Gerente de loja</b> ocorridas:</p>" +
                    "<div class='mt-2 overflow-x-auto'>" +
                      "<table class='min-w-full text-xs border border-slate-200'>" +
                        "<thead class='bg-slate-100'>" +
                          "<tr>" +
                            "<th class='border px-2 py-1 text-center'>Matrícula</th>" +
                            "<th class='border px-2 py-1 text-center'>E-mail</th>" +
                            "<th class='border px-2 py-1 text-center'>Cargo</th>" +
                            "<th class='border px-2 py-1 text-center'>Filial</th>" +
                            "<th class='border px-2 py-1 text-center'>Afastamento</th>" +
                            "<th class='border px-2 py-1 text-center'>Data Afastamento</th>" +
                          "</tr>" +
                        "</thead>" +
                        "<tbody class='!text-black'>";

                rows.forEach(function (r) {
                  html +=
                    "<tr>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.matricula || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.des_email_corporativo || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.des_titulo_cargo || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.nom_apelido_filial || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.nom_afastamento || "") + "</td>" +
                      "<td class='border px-2 py-1 !text-black'>" + (r.dat_afastamento || "") + "</td>" +
                    "</tr>";
                });

          html +=
                  "</tbody>" +
                "</table>" +
              "</div>" +
              "<p class='mt-2'><b>Atenção:</b> Verifique se o cartão do(a) Gerente já está bloqueado e cancelado, assim como o perfil deve ser desabilitado na base da Clara também.</p>" +
            "</div>";

          renderBotMessage("HTML:" + html);

        } catch (e) {
          console.error("Erro ao renderizar tabela de demissões:", e);
        }
      })
      .withFailureHandler(function (err) {
        console.error("Erro Apps Script (demissões):", err);
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Tive um erro ao consultar as demissões no BigQuery.</p>"
        );
      })
      .getUltimasDemissoesGerentes();

  } catch (e) {
    console.error("Erro geral em vektorMostrarTabelaDemissoesAdmin:", e);
  }
};

window.vektorMostrarFrequenciaUsoClara = function (textoOriginal) {
  try {
    const norm = normalize(textoOriginal || "");

    // 1) Detecta filtro: time ou loja
    let filtroTipo = "";
    let filtroValor = "";

    // tenta achar time pelo seu dicionário oficial
    const timeEncontrado = encontrarTimeNaMensagem(textoOriginal || "");

    // tenta achar loja (número)
    const mLoja = (textoOriginal || "").match(/\bloja\s*(\d{1,6})\b/i);
    const lojaEncontrada = mLoja ? mLoja[1] : "";

    if (lojaEncontrada) {
      filtroTipo = "loja";
      filtroValor = lojaEncontrada;
    } else if (timeEncontrado) {
      filtroTipo = "time";
      filtroValor = timeEncontrado;
    } else {
      renderBotMessage(
        "HTML:<p class='text-sm text-slate-700'>Para eu calcular a frequência, digite exatamente assim: <b>frequência de uso Clara para o time NOME_DO_TIME</b> ou <b>frequência de uso Clara para a loja 123</b>.</p>"
      );
      return;
    }

    // 2) Chama backend
    renderBotMessage(
      "HTML:<p class='text-sm text-slate-700'>Beleza. Vou calcular a <b>frequência de uso</b> do Clara " +
      (filtroTipo === "time" ? "para o time <b>" + filtroValor + "</b>" : "para a loja <b>" + filtroValor + "</b>") +
      " e já te trago a tabela.</p>"
    );

    google.script.run
      .withSuccessHandler(function (res) {
        try {
          if (!res || !res.ok) {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Não consegui calcular a frequência de uso no momento.</p>"
            );
            return;
          }

          const linhas = Array.isArray(res.linhas) ? res.linhas : [];
          const insight = res.insight || "";

          if (!linhas.length) {
            renderBotMessage(
              "HTML:<p class='text-sm text-slate-700'>Não encontrei transações para esse filtro no período analisado.</p>"
            );
            return;
          }

          // 3) Monta tabela (cabeçalho centralizado e texto preto nas linhas)
          let html =
            "<div class='text-sm text-slate-700'>" +
              "<p><b>Frequência de uso do cartão Clara</b> (" +
                (filtroTipo === "time" ? "Time: " + filtroValor : "Loja: " + filtroValor) +
              ")</p>" +
              "<div class='mt-2 overflow-x-auto'>" +
                "<table class='min-w-full text-xs border border-slate-200' style='color:#000;'>" +
                  "<thead class='bg-slate-100'>" +
                    "<tr>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Loja</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Uso Sem.</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Uso Mês</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Uso Total</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. Dias</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Intervalo Médio</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Padrão de uso</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Freq. x Valor</th>" +
                      "<th class='border px-2 py-1' style='text-align:center;'>Consistência</th>" +
                    "</tr>" +
                  "</thead>" +
                  "<tbody>";

          linhas.forEach(function (r) {
            html +=
              "<tr style='color:#000;'>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.loja || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqSem || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqMes || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqTotal || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqDias || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.intervaloMedio || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.padraoUso || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.freqXValor || "") + "</td>" +
                "<td class='border px-2 py-1' style='text-align:center;'>" + (r.consistencia || "") + "</td>" +
              "</tr>";
          });

          html +=
                  "</tbody>" +
                "</table>" +
              "</div>";

          // botão CSV (igual você já usa em outras tabelas) :contentReference[oaicite:7]{index=7}
          html +=
            "<div style='margin-top:8px;display:flex;justify-content:flex-end;'>" +
              "<button type='button' " +
                "onclick=\"exportTableToCSV(this, 'frequencia_uso_clara')\" " +
                "style='background:#005E27;color:#fff;border:none;padding:6px 10px;" +
                       "border-radius:4px;font-size:11px;cursor:pointer;'>" +
                "⬇ Exportar CSV" +
              "</button>" +
            "</div>";

          if (insight) {
            html +=
              "<div style='margin-top:10px;font-size:12px;color:#0F172A;background:#F8FAFC;border:1px solid #E2E8F0;border-radius:4px;padding:8px;'>" +
                "<p style='margin:0 0 4px 0;'><b>Insight:</b></p>" +
                "<p style='margin:0;'>" + insight + "</p>" +
              "</div>";
          }

          html += "</div>";

          renderBotMessage("HTML:" + html);
        } catch (e) {
          renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Falha ao montar a tabela de frequência.</p>"
          );
        }
      })
      .withFailureHandler(function (err) {
        renderBotMessage(
          "HTML:<p class='text-sm text-slate-700'>Falha de comunicação ao calcular frequência: " +
          (err && err.message ? err.message : err) + "</p>"
        );
      })
      .getFrequenciaUsoClara(filtroTipo, filtroValor);

  } catch (e) {
    console.error("Erro em vektorMostrarFrequenciaUsoClara:", e);
  }
};

window.vektorRespostaInfoIniciais = function (resposta) {
  try {
    if (resposta === "nao") {
      renderBotMessage(
        "HTML:" +
        "<p class='text-sm text-slate-700'>" +
          "Perfeito, seguimos normalmente. Se depois quiser ver esses resumos gerenciais, é só pedir no chat. 👍" +
        "</p>"
      );
      return;
    }

    // Caso SIM
    renderBotMessage(
      "HTML:" +
      "<div class='text-sm text-slate-700'>" +
        "<p>Beleza! Vou te mostrar algumas visões gerenciais separadas, conforme abaixo, e também alguns insights sobre essas visões:</p>" +
        "<ul class='list-disc ml-4 mt-1 space-y-1'>" +
          "<li><b>Maiores transações individuais</b> dos últimos 30 dias (Top 10);</li>" +
          "<li><b>Times com mais pendências</b> nos últimos 30 dias;</li>" +
          "<li><b>Estabelecimentos mais usados</b> (Top 10);</li>" +
          "<li><b>Categorias com maior valor de transações</b> nos últimos 30 dias;</li>" +
          "<li><b>Valor das últimas faturas</b> Clara.</li>" +
        "</ul>" +
        "<p class='mt-2'>Irei enviar cada tabela em sequência.</p>" +
      "</div>"
    );

    // Aguarda 1,5s e dispara o carregamento das tabelas
    setTimeout(function () {
      vektorCarregarInformacoesIniciais();
    }, 1500);
  } catch (e) {
    console.error("Erro ao tratar resposta info iniciais:", e);
  }
};

function vektorCarregarInformacoesIniciais() {
  try {
    if (USER_ROLE_CLEAN !== "Administrador") return;

    const hoje = new Date();
    const fim = hoje;
    const ini = new Date();
    ini.setDate(hoje.getDate() - 30);

    const dataInicioIso = ini.toISOString();
    const dataFimIso    = fim.toISOString();

    // 1) Maiores transações individuais
    try {
      google.script.run
        .withSuccessHandler(function (res) {
          try { renderMaioresTransacoesIndividuais(res); }
          catch (e) { console.error("Erro ao renderizar Maiores Transações (inicial):", e); }
        })
        .withFailureHandler(err => console.error("Erro Apps Script Maiores Transações (inicial):", err))
        .getMaioresTransacoesIndividuais("", "", dataInicioIso, dataFimIso, 10);
    } catch (e) {
      console.error("Falha geral ao chamar Maiores Transações (inicial):", e);
    }

    // 2) Pendências por time (últimos 30 dias)
          setTimeout(function () {
            try {
              google.script.run
                .withSuccessHandler(function (res) {
                  try {
                    const htmlTabela = vektorRenderTabelaPendenciasPorTime(res, dataInicioIso, dataFimIso);
                    renderBotMessage("HTML:" + htmlTabela);
                  } catch (e) {
                    console.error("Erro ao renderizar Pendências por time (inicial):", e);
                  }
                })
                .withFailureHandler(function (err) {
                  console.error("Erro Apps Script Pendências por time (inicial):", err);
                })
                .getResumoPendenciasPorTime(dataInicioIso, dataFimIso, "");
            } catch (e) {
              console.error("Falha geral ao chamar Pendências por time (inicial):", e);
            }
          }, 3000);

    // 3) Estabelecimentos mais usados (Top 10)
    setTimeout(function () {
      try {
        const tipo = "valor";

        google.script.run
          .withSuccessHandler(function (res) {
            try {
              renderResumoPorChaveGenerico(res, {
                tipoChave: "Estabelecimento",
                titulo: "<b>Locais com maior valor de gastos</b> - Top 10",
                topN: 10
              });
            } catch (e) {
              console.error("Erro ao renderizar Estabelecimentos (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Estabelecimentos (inicial):", err))
          .getResumoTransacoesPorEstabelecimento(
            dataInicioIso,   // <– CORRIGIDO
            dataFimIso,      // <– CORRIGIDO
            tipo,            // "valor"
            "",              // grupo
            ""               // loja
          );
      } catch (e) {
        console.error("Falha geral ao chamar Estabelecimentos (inicial):", e);
      }
    }, 6000);

    // 4) Categorias (já estava ok)
    setTimeout(function () {
      try {
        const tipo = "valor";

        google.script.run
          .withSuccessHandler(function (res) {
            try {
              renderResumoPorChaveGenerico(res, {
                tipoChave: "Categoria",
                titulo: "Categorias com maior valor de transações"
              });
            } catch (e) {
              console.error("Erro ao renderizar Categorias (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Categorias (inicial):", err))
          .getResumoTransacoesPorCategoria(dataInicioIso, dataFimIso, tipo);
      } catch (e) {
        console.error("Falha geral ao chamar Categorias (inicial):", e);
      }
    }, 9000);

    // 5) Últimas 6 faturas (já estava ok)
    setTimeout(function () {
      try {
        google.script.run
          .withSuccessHandler(function (res) {
            try {
              const todas = (res && res.faturas) || [];
              if (!todas.length) return;

              const selecionadas = vektorFiltrarFaturasPeloModo_(todas, "ultimas", 6);
              if (!selecionadas.length) return;

              const titulo = "VALOR DAS ÚLTIMAS " + selecionadas.length + " FATURAS";
              const htmlTabela = vektorMontarTabelaFaturas_(titulo, selecionadas);

              renderBotMessage("HTML:" + htmlTabela);

              const htmlInsights = analisarFaturas(selecionadas);
              if (htmlInsights) renderBotMessage("HTML:" + htmlInsights);

            } catch (e) {
              console.error("Erro ao renderizar Faturas (inicial):", e);
            }
          })
          .withFailureHandler(err => console.error("Erro Apps Script Faturas (inicial):", err))
          .getResumoFaturasClara();
      } catch (e) {
        console.error("Falha geral ao chamar Faturas (inicial):", e);
      }
    }, 12000);

  } catch (e) {
    console.error("Erro geral em vektorCarregarInformacoesIniciais:", e);
  }
}



userInput.addEventListener("keydown", (e) => {
    const boxVisivel   = vektorBox && vektorBox.style.display === "block";
    const haSugestoes  = vektorCurrentSuggestions && vektorCurrentSuggestions.length > 0;

    // ESC fecha o autocomplete
    if (e.key === "Escape") {
        if (boxVisivel) {
            e.preventDefault();
            vektorBox.style.display = "none";
            vektorSelectedIndex = -1;
            vektorCurrentSuggestions = [];
        }
        return;
    }

    // Se o autocomplete estiver aberto e tiver sugestões
    if (boxVisivel && haSugestoes) {

        // TAB ou seta para baixo -> próxima sugestão
        if (e.key === "ArrowDown" || (e.key === "Tab" && !e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex + 1) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // Shift+TAB ou seta para cima -> sugestão anterior
        if (e.key === "ArrowUp" || (e.key === "Tab" && e.shiftKey)) {
            e.preventDefault();
            vektorSelectedIndex = (vektorSelectedIndex - 1 + vektorCurrentSuggestions.length) % vektorCurrentSuggestions.length;
            vektorHighlightSelected();
            return;
        }

        // ENTER com item selecionado -> aplica sugestão
        if (e.key === "Enter") {
            if (vektorSelectedIndex >= 0 && vektorCurrentSuggestions[vektorSelectedIndex]) {
                e.preventDefault();

                const textoSugestao = vektorCurrentSuggestions[vektorSelectedIndex];
                vektorApplySuggestion(textoSugestao);

                vektorBox.style.display = "none";
                vektorSelectedIndex = -1;
                vektorCurrentSuggestions = [];
                return; // usuário aperta Enter de novo se quiser enviar
            }
            // se não tiver item selecionado, cai no fluxo padrão mais abaixo
        }
    }

    // Fluxo padrão: Enter envia a mensagem (sem Shift)
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
    }
});

    sendBtn.addEventListener("click", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    // 🟢 Mostrar o vídeo do Vektor só na primeira visita
    (function () {
      var modal = document.getElementById("vektorModal");
      if (!modal) return;

      // Verifica se já mostramos o vídeo neste navegador
      var jaMostrou = localStorage.getItem("vektorIntroShown");

      if (!jaMostrou) {
        // Nunca mostrou → exibe o modal e marca como exibido
        modal.style.display = "flex";   // combina com as classes flex do Tailwind
        localStorage.setItem("vektorIntroShown", "1");
      } else {
        // Já mostrou uma vez → garante que fique escondido
        modal.style.display = "none";
      }
    })();

      // ===== MODAL DO MANUAL CLARA =====
  window.openManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.remove("hidden");
      // para garantir que fique centralizado como flex
      el.classList.add("flex");
    }
  };

  window.closeManualClaraModal = function () {
    const el = document.getElementById("manualClaraModal");
    if (el) {
      el.classList.add("hidden");
      el.classList.remove("flex");
    }
  };

}); // fim DOMContentLoaded

</script>

<script>
  
document.addEventListener("DOMContentLoaded", function () {
  const home = document.getElementById("homeView");
  const img  = document.getElementById("homeHeroImg");
  if (!home) return;

  function showHome() {
    requestAnimationFrame(() => {
      home.style.opacity = "1";
      home.style.filter = "blur(0px)";
    });
  }

  if (img) {
    if (img.complete) showHome();
    else img.addEventListener("load", showHome, { once: true });
  } else {
    showHome();
  }
});

</script>
</body>
</html>
