<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Agente Clara</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:800px;
        margin:2rem auto;
        display:flex;
        flex-direction:column;
        height:90vh;
    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        background-color:#005E27;
        color:#B5FF20;
        margin-bottom:0.5rem;
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:78px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex:1 1 auto;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
    }
    .chat-window {
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
    }

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digita√ß√£o menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do hist√≥rico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links nas respostas do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }
</style>

<style>
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      height: 24px;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background-color: #94a3b8;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>

</head>
<body class="text-slate-800">

<div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Grupo SBF | Vektor</h1>

                <p>Pergunte sobre o uso do cart√£o Clara nas lojas.</p>

                <div class="examples"></div>
                <div class="policy-note text-[12px] mt-2"></div>
            </div>

            <div class="chat-header-avatar">
                <img
                    src="https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png"
                    alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

            <!-- Mensagem inicial do bot -->
            <div class="flex items-start gap-3">
                <img
                    src="https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png"
                    alt="Assistente Clara (rob√¥)"
                    class="h-16 w-auto object-contain flex-shrink-0"
                />
                <div class="bot-bubble px-4 py-3 max-w-[80%] text-sm text-slate-700">
                    <p class="font-semibold text-slate-800 text-base">
                        Ol√°! üëã Eu sou o Vektor, agente do <b>Grupo SBF</b> especializado na Clara.<br/>
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar direto, tipo:<br/><br>
                        ‚Ä¢ Posso comprar mouse?<br/>
                        ‚Ä¢ Como aumento o limite?<br/>
                        ‚Ä¢ Qual a pend√™ncia de justificativas da minha loja??<br/>
                        ‚Ä¢ Vou trocar de loja, o que fa√ßo com o cart√£o?<br/>
                        ‚Ä¢ Qual etiqueta pra √°gua/mineral?<br/>
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Se o assunto n√£o tiver rela√ß√£o com a Pol√≠tica de Uso dos Cart√µes da Clara nas lojas eu n√£o estarei apto para responder.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Quer o documento oficial completo?
                        <a class="policy-link"
                           href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing"
                           target="_blank" rel="noopener noreferrer">
                            Segue a Pol√≠tica de Uso dos Cart√µes Clara
                        </a>.
                    </p>

                             
                    </div> <!-- fecha .bot-bubble -->
                  </div>   <!-- fecha .flex -->
                  
                </div>     <!-- fecha #chatWindow -->
              </main>      <!-- fecha .chat-body -->

                  <!-- FOOTER / INPUT -->
                  <footer class="chat-footer">
                      <form id="chatForm" class="w-full">
                          <div class="input-shell">
                              <textarea id="userInput" placeholder="Digite aqui..."></textarea>
                              <button type="submit" id="sendBtn">Enviar</button>
                          </div>
                      </form>
                  </footer>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const ROBOT_IMG_URL = "https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png";

        // Nome vindo do template Apps Script (Code.gs ‚Üí tmpl.userName)
    const userName = <?= JSON.stringify(userName || "") ?>;
    const displayName = userName.replace(/^"+|"+$/g, "").trim();

    // E-mail vindo do Apps Script (Code.gs ‚Üí template.userEmail)
    const USER_EMAIL = <?= JSON.stringify(userEmail || "") ?>;
    const USER_EMAIL_REPLACED = USER_EMAIL.replace(/^"+|"+$/g, "").trim();

// üîî Sauda√ßao em outra mensagem, depois da mensagem inicial
setTimeout(() => {
    if (displayName) {
        // Vers√£o com nome
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'><b>" +
            displayName +
            "</b>, como posso te ajudar agora?</p>"
        );
    } else {
        // Vers√£o sem nome (fallback)
        renderBotMessage(
            "HTML:<p class='text-sm text-slate-700'>Como posso te ajudar agora?</p>"
        );
    }
}, 2000);

    /* ========= ESTADOS ========= */
    let estadoPendencias = "nenhum"; // "nenhum" | "aguardando_loja" | "aguardando_confirmacao_email" | "aguardando_email"
    let lojaPendenciasAtual = "";
    let ultimaPendenciaResumo = null; // { loja, data }
    let fluxoNovoCartao = null; // null | "aguardando_tipo_via"
    let ultimaIntencao = null;
    let origemPendenciasBloqueio = false;


    /* ========= ELEMENTOS UI ========= */
    const chatWindow = document.getElementById("chatWindow");
    const chatForm   = document.getElementById("chatForm");
    const userInput  = document.getElementById("userInput");
    const sendBtn    = document.getElementById("sendBtn");

    /* ========= FUN√á√ïES DE UI ========= */
    function scrollToBottom() {
        requestAnimationFrame(() => {
            const body = document.querySelector(".chat-body");
            if (body) {
                body.scrollTop = body.scrollHeight;
                setTimeout(() => {
                    body.scrollTop = body.scrollHeight;
                }, 150);
            }
        });
    }

    function renderUserMessage(text) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex items-start justify-end gap-3";

        const bubble = document.createElement("div");
        bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
        bubble.innerText = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        scrollToBottom();
    }

        // üëá Cole AQUI, logo abaixo de scrollToBottom()
  // Adiciona indicador de "digitando..."
  function showTypingIndicator() {
    const chatWindow = document.getElementById('chatWindow');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'flex items-start gap-3 mt-3';
    typingDiv.innerHTML = `
      <img src="https://raw.githubusercontent.com/rslisboa/cartoesclara/df8a11a559812686406837aafcae70759e9c73a8/Gemini_Generated_Image_nzni5znzni5znzni.png" alt="Vektor" class="w-8 h-8 rounded-full">
      <div class="bot-bubble px-4 py-3 max-w-[80%]">
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    `;
    chatWindow.appendChild(typingDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function hideTypingIndicator() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) typingDiv.remove();
  }


            async function renderBotMessage(text) {
          if (!text) return;

          // üëá Mostra o indicador de "digitando..."
          showTypingIndicator();

          // Aguarda 1 segundo (simulando digita√ß√£o)
          await new Promise(r => setTimeout(r, 800));

          // Remove o indicador
          hideTypingIndicator();

          // --- Parte original do seu c√≥digo ---
          const wrapper = document.createElement("div");
          wrapper.className = "flex items-start gap-3";

          const avatar = document.createElement("img");
          avatar.src = ROBOT_IMG_URL;
          avatar.alt = "Assistente Clara (rob√¥)";
          avatar.className = "h-16 w-auto object-contain flex-shrink-0";

          const bubble = document.createElement("div");
          bubble.className =
            "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

          if (typeof text === "string" && text.startsWith("HTML:")) {
            bubble.innerHTML = text.replace(/^HTML:/, "").trim();
          } else {
            bubble.innerText = text;
          }

          wrapper.appendChild(avatar);
          wrapper.appendChild(bubble);
          chatWindow.appendChild(wrapper);
          scrollToBottom();
          // üëá dispara notifica√ß√£o de nova mensagem do bot
          notificarNovaMensagem(text);
        }

    /* ========= NORMALIZA√á√ÉO ========= */
    function normalize(str) {
        return (str || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    /* ========= DADOS / TABELAS ========= */

    const etiquetasOficiais = [
  {
    nome: "MARKETING_PUBLICIDADE E PROPAGANDA",
    palavrasChave: [
      "marketing", "publicidade", "propaganda", "anuncio", "an√∫ncio", "facebook", "instagram", "insta", "face",
      "m√≠dia", "midia", "brinde", "campanha", "banner promocional", "campanhas", "banner", "baner",
      "impulsionamento", "divulga√ß√£o", "panfleto", "adesivo promocional", "social media", "instagram ads", "facebook ads", "promo√ß√£o local", "google ads", "tiktok ads", "youtube ads", "seo", "sem", "email marketing", "e-mail marketing", "inbound marketing", "outbound marketing", "influencer", "influenciadores", "parceria paga", "patrocinado", "stories", "feed", "design gr√°fico", "agencia de publicidade", "ag√™ncia de publicidade", "criacao de conteudo", "cria√ß√£o de conte√∫do", "material promocional", "folder", "cartaz", "outdoor", "tv paga", "revista", "jornal", "marketing digital", "alcance", "engajamento", "convers√£o", "leads", "pixel", "remarketing", "assessoria de imprensa", "rela√ß√µes p√∫blicas", "relacoes publicas", "assessoria"
    ],
    descricao:
      "A√ß√µes promocionais, compra de brindes, banners, impulsionamento de redes sociais, contrata√ß√£o de m√≠dia local.",
    observacaoUso: "Somente campanhas aprovadas pelo regional ou diretoria."
  },
  {
    nome: "TAXAS E EMOLUMENTOS",
    palavrasChave: [
      "taxa", "taxas", "emolumento", "emolumentos", "cartorio", "cart√≥rio",
      "certidao", "certid√£o", "registro", "segunda via documento", "aluguel",
      "documenta√ß√£o oficial", "taxa de servi√ßo", "honorarios", "honor√°rios"
    ],
    descricao:
      "Custos com registros, certid√µes, taxas cartoriais ou administrativas necess√°rias √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA",
    palavrasChave: [
      "detergente", "sabao", "sab√£o", "desinfetante", "alcool", "√°lcool", "pano", "rodo", "vassoura", "esponja", "papel toalha", "limpeza loja", "produto de limpeza", "desengordurante", "multiuso", "saco de lixo", "lixeira", "balde", "mop", "lustra moveis", "lustra m√≥veis", "cera", "removedor", "amaciante", "√°gua sanit√°ria", "agua sanitaria", "limpa vidros", "rasteio", "escova", "flanela", "aspirador", "sapon√°ceo", "sabonete", "dispenser", "tapete sanitizante", "sanitizante", "cloro", "alvejante", "luva", "mascara", "m√°scara", "limpeza do banheiro", "papel higi√™nico", "papel higienico", "aromatizador", "odorizador", "refil", "material de higiene", "higiene"
    ],
    descricao:
      "Materiais de limpeza e higiene da loja: detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE INFORM√ÅTICA",
    palavrasChave: [
      "mouse", "teclado", "teclado pdv", "cabo usb", "pendrive", "pen drive", "roteador", "hub usb", "fonte", "adaptador", "cabo rede", "cart√£o memoria", "cartao memoria", "extensor usb", "carregador", "suporte notebook", "monitor", "impressora", "cartucho", "toner", "cabo hdmi", "ssd", "hd", "memoria ram", "mem√≥ria ram", "headset", "scanner", "leitor de c√≥digo", "leitor de codigo", "mousepad", "modem", "placa de video", "placa de rede", "pilhas", "bateria", "no break", "nobreak", "filtro de linha", "perif√©rico", "periferico", "fone de ouvido", "fones", "fone"
    ],
    descricao:
      "Itens de inform√°tica de baixo valor: mouse, teclado, cabos, pendrives, fontes, roteadores, hubs USB, cart√µes de mem√≥ria.",
    observacaoUso: "N√£o cobre monitores, TVs ou equipamentos patrimoniais."
  },
  {
    nome: "MATERIAL DE ESCRIT√ìRIO",
    palavrasChave: [
      "caneta", "papel", "pasta", "bloco", "caderno", "etiqueta adesiva", "grampeador", "clips", "clipes", "organizador", "post-it", "marcador", "l√°pis", "lapis", "borracha", "corretivo", "tesoura", "r√©gua", "regua", "perfurador", "furador de papel", "cola", "fita adesiva", "fita durex", "envelope", "arquivo", "caixa arquivo", "separador de p√°gina", "separador de pagina",
      "carimbo", "tinta carimbo", "calculadora", "agenda", "calend√°rio", "calendario", "prancheta", "suporte de caneta", "porta-treco", "cartucho de tinta", "toner", "porta revista", "revisteiro", "apontador", "dicion√°rio", "dicionario", "impressos", "sulfite", "folha de sulfite", "folha A4", "folhas", "escada", "escadas"
    ],
    descricao:
      "Canetas, blocos, pap√©is, pastas, grampeadores, clipes, etiquetas adesivas, organizadores de mesa etc.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE COPA E COZINHA",
    palavrasChave: [
      "copo", "copos", "talher", "talheres", "garrafa termica", "garrafa t√©rmica",
      "pano prato", "pano de prato", "filtro de cafe", "filtro de caf√©",
      "pote", "potes", "pote plastico", "pote pl√°stico", "descartavel", 
    ],
    descricao:
      "Copos, talheres, filtros de caf√©, panos de prato, potes pl√°sticos, garrafas t√©rmicas.",
    observacaoUso: "N√£o cobre eletrodom√©sticos como cafeteiras ou micro-ondas."
  },
  {
    nome: "MATERIAL DE COPA E COZINHA OPERA√á√ïES",
    palavrasChave: ["cozinha loja", "utensilios loja", "material copa opera√ß√µes", "kit acrilico"],
    descricao: "Itens de copa/cozinha utilizados especificamente em opera√ß√µes.",
    observacaoUso: ""
  },
  {
    nome: "MATERIAL DE LIMPEZA OPERA√á√ïES",
    palavrasChave: ["limpeza opera√ß√µes", "produto limpeza operacional"],
    descricao: "Materiais de limpeza voltados √† opera√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS OPERA√á√ïES",
    palavrasChave: ["banner", "adesivo", "flyer", "folder", "grafica", "impressao", "impress√£o"],
    descricao: "Materiais gr√°ficos operacionais, banners e impress√µes.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO CIVIL",
    palavrasChave: [
      "parede", "porta", "vidro", "prateleira", "fechadura", "reparo loja",
      "conserto parede", "ajuste estrutura", "obra pequena"
    ],
    descricao:
      "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa).",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO ELETRICO",
    palavrasChave: [
      "tomada", "disjuntor", "interruptor", "reator", "soquete", "extensao",
      "fia√ß√£o", "fiacao", "el√©trico", "eletrico", "luz", "l√¢mpada", "lampada"
    ],
    descricao:
      "Troca de tomadas, disjuntores, interruptores, l√¢mpadas e pequenos reparos el√©tricos.",
    observacaoUso: "Apenas servi√ßos simples, sem necessidade de t√©cnico especializado."
  },
  {
    nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
    palavrasChave: [
      "conserto impressora", "ajuste maquina estampar", "reparo computador",
      "ferramenta manual", "manutencao equipamentos", "reparo t√©cnico"
    ],
    descricao:
      "Reparo de impressora, m√°quina de estampar e computador fora de garantia.",
    observacaoUso: ""
  },
  {
    nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
    palavrasChave: [
      "ar condicionado", "ar-condicionado", "limpeza filtro", "carga gas",
      "controle remoto ar", "manuten√ß√£o ar", "reparo ar", "split"
    ],
    descricao:
      "Limpeza, carga de g√°s e pequenos ajustes em ar-condicionado.",
    observacaoUso: "N√£o cobre compra de novo aparelho."
  },
  {
    nome: "TRANSPORTE SERVICOS EMERGENCIAS",
    palavrasChave: [
      "motoboy", "moto boy", "entrega urgente", "frete", "documento matriz",
      "lalamove", "entrega loja", "envio urgente", "courier"
    ],
    descricao:
      "Frete emergencial local, motoboy ou entrega urgente entre lojas e matriz.",
    observacaoUso: "N√£o inclui transporte pessoal via aplicativos."
  },
  {
    nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
    palavrasChave: [
      "banner", "adesivo", "flyer", "folder", "encadernacao", "grafica", "impressao",
      "material visual", "cartaz", "copiadora"
    ],
    descricao:
      "Impress√µes, banners, adesivos, folders, encaderna√ß√µes e materiais visuais.",
    observacaoUso: ""
  },
  {
    nome: "SERVI√áOS DE LIMPEZA",
    palavrasChave: [
      "limpeza loja", "faxina", "servi√ßo limpeza", "limpeza extra", "empresa limpeza"
    ],
    descricao:
      "Contrata√ß√£o de servi√ßos de limpeza eventuais para manuten√ß√£o da loja.",
    observacaoUso: ""
  },
  {
    nome: "CORREIOS_SEDEX/AR/POSTAGEM",
    palavrasChave: [
      "sedex", "correio", "postagem"
    ],
    descricao: "Envio de documentos f√≠sicos via Sedex, AR, ou devolu√ß√µes pequenas.",
    observacaoUso: ""
  },
  {
    nome: "LANCHES DE REFEI√á√ïES",
    palavrasChave: [
      "lanche", "coffee break", "caf√©", "bolo", "salgado", "biscoito", "refrigerante", "suco", "premia√ß√£o", "treinamento", "a√ß√£o interna", "almoco", "almo√ßo", "jantar", "pizza", "comida", "refeicao", "refei√ß√£o", "confraterniza√ß√£o", "confraternizacao", "evento interno", "kit lanche", "break", "agua", "√°gua", "doces", "chocolates", "frutas", "p√£o", "pao", "torta", "sandu√≠che", "sanduiche", "kit caf√©", "bebidas", "snacks", "celebracao", "celebra√ß√£o", "coquetel", "buffet", "catering", "alimentos",
  "compra de comida", "alimentacao", "alimenta√ß√£o", "workshop", "curso", "reuniao", "reuni√£o"
    ],
    descricao:
      "Lanches ou coffee break para treinamento interno, a√ß√£o aprovada ou premia√ß√£o.",
    observacaoUso: "N√£o cobre refei√ß√µes pessoais."
  },
  {
    nome: "AGUA POT√ÅVEL",
    palavrasChave: [
      "agua", "√°gua", "gal√£o", "galao", "garrafa agua", "garrafa de agua", "comprar agua", "comprar √°gua", "suprimento de √°gua", "reposi√ß√£o de √°gua", "barril de √°gua", "barril de agua", "√°gua mineral", "agua mineral", "bombona", "garraf√£o", "garrafao",
  "fornecedor de √°gua"
    ],
    descricao:
      "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe.",
    observacaoUso: ""
  },
  {
    nome: "BOBINA ECF",
    palavrasChave: [
      "bobina", "ecf", "cupom fiscal", "bobina impressora", "bobina pdv"
    ],
    descricao:
      "Bobinas para ECF / impressoras fiscais / PDV n√£o centralizados.",
    observacaoUso: ""
  },
  {
    nome: "CHAVEIRO EMERGENCIAL",
    palavrasChave: [
      "chaveiro", "abrir cofre", "abrir estoque", "trocar segredo", "sem chave", "cofre", "problema cofre", "problema fechadura", "fechadura", "perdi a chave", "esqueci a chave", "chave quebrada", "troca de chave", "fazer chave", "duplicata de chave", "copia de chave", "c√≥pia de chave", "abrir porta", "porta travada", "porta emperrada", "trancar", "trocar segredo",
      "segredo cofre", "abertura de cofre", "trocar fechadura", "concerto fechadura", "conserto fechadura", "consertar fechadura", "emerg√™ncia fechadura", "servi√ßo chaveiro", "mestre chaveiro", "tranca", "chaves", "cilindro", "miolo da chave", "reparar cofre", "reparo fechadura", "instalar fechadura"
    ],
    descricao:
      "Servi√ßo emergencial de chaveiro para abertura de cofres, vitrines e estoques.",
    observacaoUso: "Somente em emerg√™ncias operacionais."
  },
  {
    nome: "MANUTEN√á√ÉO MAQ ESTAMPAR",
    palavrasChave: [
      "estampar", "maquina estampar", "m√°quina estampar", "reparo estampar"
    ],
    descricao:
      "Reparos simples ou ajustes t√©cnicos em m√°quinas de estampar, sem controle patrimonial.",
    observacaoUso: ""
  }
];


    const perguntasGeraisEtiqueta = [
        "qual etiqueta devo usar","qual etiqueta usar","qual etiqueta eu uso",
        "que etiqueta devo usar","que etiqueta usar","que etiqueta eu uso",
        "me fala as etiquetas","me diz as etiquetas","me mostra as etiquetas",
        "me envia as etiquetas","me passa as etiquetas",
        "todas as etiquetas","lista de etiquetas","listagem de etiquetas",
        "quais etiquetas existem","quais etiquetas tem","quais sao as etiquetas",
        "quais s√£o as etiquetas","quais etiquetas posso usar",
        "quais etiquetas devo usar","quais etiquetas usar",
        "categorias de gasto","categorias de despesas","categoria de despesa",
        "categoria de gasto","categoria clara","etiqueta clara", "etiqueta", "etiquetas", "categoria"
    ].map(normalize);

    const frasesPolitica = [
        "me envia a politica","me envia a pol√≠tica","me manda a politica","me manda a pol√≠tica",
        "pol√≠tica de uso","politica de uso do cartao","pol√≠tica de uso do cart√£o", "politica", "pol√≠tica",
        "politica do cartao","pol√≠tica do cart√£o","politica do cartao clara","pol√≠tica do cart√£o clara",
        "pdf da politica","pdf da pol√≠tica","manual da politica","manual da pol√≠tica",
        "politica clara","pol√≠tica clara","politica de uso dos cartoes","pol√≠tica de uso dos cart√µes"
    ].map(normalize);

    const frasesTermo = [
        "termo de responsabilidade",
        "termo responsabilidade",
        "termo de responsabilidade do cartao",
        "termo de responsabilidade do cart√£o",
        "termo do cartao",
        "termo do cart√£o",
        "termo de uso do cartao",
        "termo de uso do cart√£o",
        "termo",
        "termo clara",
        "termo do cartao clara",
        "termo do cart√£o clara",
        "termo de aceite",
        "termo de aceite do cartao",
        "termo de aceite do cart√£o",
        "assinar termo do cartao",
        "assinar termo da clara",
        "termo de responsabilidade clara"
    ].map(normalize);

    const saudacoes = [
        "oi","ol√°","ola","opa","eai","e a√≠","iae","oi vektor","ola vektor","ol√° vektor", "bom dia","boa tarde","boa noite", "bom dia!", "boa tarde!", "boa noite!",
        "salve","fala","fala vektor","e a√≠ vektor","eai vektor","opa vektor", "tudo bem","td bem","tdb","como vai","como vc ta","como voce ta", "beleza","tranquilo","tudo certo", "como vai vc", "como vai voc√™", "como t√°", "como ta", "eae", "i ae"
    ].map(normalize);

    const frasesEncerramento = [
        "ok","okay","okey","certo","blz","beleza","ok valeu", "entendi","entendido","tudo certo","td certo","tds certo", "√© nois q t√°", "√© n√≥is", "tmj", "tamo junto", "gratidao", "t√° bom","ta bom","t√° √≥timo","ta otimo","t√° otimo", "muito obrigado", "muito obrigada", "gratid√£o", "show","show de bola","valeu","vlw","obrigado","obrigada", "grato", "grata", "agradessido", "agradecida", "agradecido","agradessida","tranquilo","de boa","suave", "thanks", "tks", "pode deixar","certinho","maravilha","perfeito","j√≥ia","joia", "joinha", "tmj cachorro", "supimpa", "excelente", "fantastico", "fant√°stico"
    ].map(normalize);

    const termosPendencias = [
        "pendencia clara","pend√™ncias clara","pendencias clara",
        "bloqueio por pendencia","bloqueio por pend√™ncia",
        "pendencia do cartao","pend√™ncia do cart√£o",
        "loja bloqueada clara","cart√£o bloqueado por pendencia",
        "cobran√ßa clara","transa√ß√µes pendentes clara",
        "pendencia","pend√™ncia","pendencias","pend√™ncias"
    ].map(normalize);

    const palavrasMudancaAssunto = [
        "cartao","cart√£o","etiqueta","categoria","politica","pol√≠tica","sangria",
        "bloqueio","novo","pendencia","pend√™ncia","comprar","limite","uber",
        "agua","√°gua","lanche","fraude","contestacao","contesta√ß√£o","prestacao","presta√ß√£o"
    ].map(normalize);


    const gatilhosNovoCartao = [
        "quero solicitar um cartao",
        "quero solicitar um cart√£o",
        "novo cartao",
        "novo cart√£o",
        "cartao novo",
        "cart√£o novo",
        "quero solicitar cartao clara",
        "quero solicitar cart√£o clara",
        "quero pedir um cartao",
        "quero pedir um cart√£o",
        "quero pedir cartao clara",
        "quero pedir cart√£o clara",
        "quero cartao clara",
        "quero cart√£o clara",
        "preciso de um cartao",
        "preciso de um cart√£o",
        "preciso de cartao clara",
        "preciso de cart√£o clara",
        "nao tenho cartao clara ainda",
        "n√£o tenho cartao clara ainda",
        "nao tenho cart√£o clara ainda",
        "ainda nao tenho cartao clara",
        "ainda n√£o tenho cart√£o clara",
        "como pedir cartao",
        "como pedir cart√£o",
        "como solicitar cartao",
        "como solicitar cart√£o",
        "como conseguir um cartao clara",
        "como conseguir um cart√£o clara",
        "fui promovido e nao tenho cartao",
        "fui promovido e n√£o tenho cart√£o",
        "sou novo gerente e nao tenho cartao",
        "sou novo gerente e n√£o tenho cart√£o",
        "assumi a loja e nao tenho cartao",
        "assumi a loja e n√£o tenho cart√£o",
        "primeira via do cartao",
        "primeira via do cart√£o",
        "1a via do cartao",
        "1¬™ via do cartao",
        "1a via do cart√£o",
        "1¬™ via do cart√£o",
        "preciso solicitar um cartao",
        "preciso solicitar um cart√£o",
        "gostaria de solicitar um cartao",
        "gostaria de solicitar um cart√£o",
        "quero novo cartao",
        "quero novo cart√£o",
        "preciso novo cartao",
        "preciso novo cart√£o",
        "nao tenho cartao",
        "n√£o tenho cart√£o",
        "nunca tive cartao",
        "nunca tive cart√£o"
    ].map(normalize);

    const termosPrimeiraViaDireta = [
        "primeira via",
        "1 via",
        "1a via",
        "1¬™ via",
        "primeiro cartao",
        "primeiro cart√£o",
        "meu primeiro cartao",
        "meu primeiro cart√£o",
        "nunca tive cartao clara",
        "nunca tive cart√£o clara",
        "quero minha primeira via",
        "quero 1 via",
        "pedir primeira via",
        "solicitar primeira via"
    ].map(normalize);

    const gatilhosSegundaViaDireta = [
        "segunda via",
        "2 via",
        "2a via",
        "2¬™ via",
        "segunda via",
        "segunda bia",
        "segundavia",
        "segunda vias",
        "segundas via",
        "segundas vias",
        "reemitir cartao",
        "reemitir cart√£o",
        "reemissao cartao",
        "reemissao de cartao",
        "reemissao de cartao",
        "reemiss√£o cart√£o",
        "reemitir meu cartao",
        "reemitir meu cart√£o",
        "perdi o cartao",
        "perdi o cart√£o",
        "perdi meu cartao",
        "perdi meu cart√£o",
        "perdi o meu cart√£o",
        "perdi o meu cartao",
        "eu perdi o cart√£o",
        "eu perdi o cartao",
        "percas de cartao",
        "perca de cart√£o",
        "perca de cartao",
        "perda de cartao",
        "perda de cart√£o",
        "solicitar segunda via",
        "solicitar 2via",
        "solicitar 2 via",
        "solicita√ß√£o de segunda via",
        "solicita√ß√£o de 2 via",
        "roubaram meu cartao",
        "roubaram meu cart√£o",
        "me roubaram",
        "mi roubaram",
        "fui roubado",
        "cartao furtado",
        "furto",
        "cart√£o furtado",
        "roubo",
        "roubo de cart√£o",
        "perda de cart√£o",
        "perca de cart√£o",
        "cartao quebrado",
        "cart√£o quebrado",
        "cartao danificado",
        "cart√£o danificado"
    ].map(normalize);

    const perguntasGeraisOquePosso = [
        "o que posso comprar",
        "oq comprar com o cart√£o da Clara",
        "o que pode comprar",
        "o que pode comprar com o cart√£o",
        "o que pode comprar com o cartao",
        "oque comprar",
        "o que comprar",
        "posso comprar o que",
        "o que posso usar",
        "quais compras",
        "o que √© permitido",
        "o que nao posso",
        "o que n√£o posso",
        "o que nao posso comprar",
        "o que n√£o posso comprar",
        "o que nao comprar",
        "o que n√£o comprar"
    ].map(normalize);


    // Pede permiss√£o pro navegador mostrar notifica√ß√µes
            function solicitarPermissaoNotificacao() {
              if (!("Notification" in window)) {
                console.log("Navegador n√£o suporta Notification API.");
                return;
              }

              if (Notification.permission === "default") {
                // S√≥ pede se ainda n√£o tiver "granted" nem "denied"
                Notification.requestPermission().then((result) => {
                  console.log("Permiss√£o de notifica√ß√£o:", result);
                });
              }
            }

            // Dispara notifica√ß√£o quando chega mensagem nova do bot
            function notificarNovaMensagem(text) {
              if (!("Notification" in window)) return;
              if (Notification.permission !== "granted") return;

              // Opcional: s√≥ notificar se o usu√°rio N√ÉO estiver olhando pro chat
              if (document.hasFocus()) return;

              let conteudo = "";

              if (typeof text === "string") {
                // Se vier no formato "HTML:..."
                if (text.startsWith("HTML:")) {
                  const semPrefixo = text.replace(/^HTML:/, "");
                  // remove tags HTML pra n√£o aparecer tudo <p> na notifica√ß√£o
                  conteudo = semPrefixo.replace(/<[^>]+>/g, " ");
                } else {
                  conteudo = text;
                }
              }

              conteudo = conteudo.trim();
              if (!conteudo) return;

              // Limita o tamanho da mensagem na notifica√ß√£o
              if (conteudo.length > 140) {
                conteudo = conteudo.slice(0, 137) + "...";
              }

              new Notification("Vektor - nova resposta", {
                body: conteudo,
                icon: ROBOT_IMG_URL // mesma imagem que voc√™ usa pro avatar do bot
              });
            }


    /* ========= INTEN√á√ÉO ========= */

    function detectarIntencaoPergunta(msgNorm) {
        const foraEscopoPadroes = [
            "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
            "presidente","futebol","time joga","campeonato","xing","vai tomar",
            "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
            "piada","xingar","palavr√£o","palavrao"
        ];
        for (const termo of foraEscopoPadroes) {
            if (msgNorm.includes(normalize(termo))) {
                return "foraEscopo";
            }
        }

        if (msgNorm.includes("etiqueta") ||
            msgNorm.includes("etiquetas") ||
            msgNorm.includes("qual etiqueta") ||
            msgNorm.includes("que etiqueta")) {
            return "etiqueta";
        }

        if (msgNorm.includes("aumentar limite") ||
            msgNorm.includes("aumento de limite") ||
            msgNorm.includes("limite maior") ||
            msgNorm.includes("limite do cartao") ||
            msgNorm.includes("limite do cart√£o") ||
            msgNorm.includes("limite nao basta") ||
            msgNorm.includes("limite n√£o basta") ||
            msgNorm.includes("limite acabou") ||
            msgNorm.includes("limite estourou") ||
            msgNorm.includes("quero mais limite") ||
            msgNorm.includes("preciso de mais limite") ||
            msgNorm.includes("como aumentar meu limite") ||
            msgNorm.includes("solicitar aumento de limite") ||
            msgNorm.includes("limite baixo") ||
            msgNorm.includes("qual o limite do cartao") ||
            msgNorm.includes("qual o limite do cart√£o") ||
            msgNorm.includes("meu limite") ||
            msgNorm.includes("consultar limite") ||
            msgNorm.includes("ver limite") ||
            msgNorm.includes("quanto tenho de limite") ||
            msgNorm.includes("limite disponivel") ||
            msgNorm.includes("limite dispon√≠vel") ||
            msgNorm.includes("baixar limite") ||
            msgNorm.includes("diminuir limite") ||
            msgNorm.includes("limite de credito") ||
            msgNorm.includes("limite de cr√©dito") ||
            msgNorm.includes("limite total") ||
            msgNorm.includes("limite nao liberado") ||
            msgNorm.includes("limite n√£o liberado") ||
            msgNorm.includes("limite acabou de novo") ||
            msgNorm.includes("por que meu limite nao aumenta") ||
            msgNorm.includes("por que meu limite n√£o aumenta") ||
            msgNorm.includes("limite esgotado") ||
            msgNorm.includes("gastei o limite todo") ||
            msgNorm.includes("aumento de credito") ||
            msgNorm.includes("aumento de cr√©dito") ||
            msgNorm.includes("ajustar limite") ||
            msgNorm.includes("liberar mais limite") ||
            msgNorm.includes("limite")) {
            return "limite";
        }

        if (msgNorm.includes("bloqueou") ||
            msgNorm.includes("bloqueado") ||
            msgNorm.includes("desbloquear") ||
            msgNorm.includes("cartao travou") ||
            msgNorm.includes("cart√£o travou") ||
            msgNorm.includes("travou o cartao") ||
            msgNorm.includes("travou o cart√£o") ||
            msgNorm.includes("bloquear cartao") ||
            msgNorm.includes("bloquear cart√£o") ||
            msgNorm.includes("queria bloquear") ||
            msgNorm.includes("quero bloquear") ||
            msgNorm.includes("como bloquear") ||
            msgNorm.includes("cartao bloqueado") ||
            msgNorm.includes("cart√£o bloqueado") ||
            msgNorm.includes("meu cartao nao funciona") ||
            msgNorm.includes("meu cart√£o n√£o funciona") ||
            msgNorm.includes("meu cart√£o t√° bloqueado") ||
            msgNorm.includes("meu cartao ta bloqueado") ||
            msgNorm.includes("nao consigo usar o cartao") ||
            msgNorm.includes("n√£o consigo usar o cart√£o") ||
            msgNorm.includes("problema no cartao") ||
            msgNorm.includes("problema no cart√£o") ||
            msgNorm.includes("suspender cartao") ||
            msgNorm.includes("suspender cart√£o") ||
            msgNorm.includes("suspender o uso") ||
            msgNorm.includes("o cartao parou") ||
            msgNorm.includes("o cart√£o parou") ||
            msgNorm.includes("ativar cartao") ||
            msgNorm.includes("ativar cart√£o") ||
            msgNorm.includes("reativar cartao") ||
            msgNorm.includes("reativar cart√£o") ||
            msgNorm.includes("travamento") ||
            msgNorm.includes("cartao recusado") ||
            msgNorm.includes("cart√£o recusado") ||
            msgNorm.includes("recusou a compra") ||
            msgNorm.includes("por que nao funciona") ||
            msgNorm.includes("por que n√£o funciona") ||
            msgNorm.includes("desliguei o cartao") ||
            msgNorm.includes("desliguei o cart√£o") ||
            msgNorm.includes("bloqueio preventivo")) {
            return "bloqueio";
        }

        if (msgNorm.includes("como justificar") ||
            msgNorm.includes("justificar compra") ||
            msgNorm.includes("prestar contas") ||
            msgNorm.includes("prestacao de contas") ||
            msgNorm.includes("presta√ß√£o de contas") ||
            msgNorm.includes("colocar nota") ||
            msgNorm.includes("inserir nota") ||
            msgNorm.includes("anexar nota") ||
            msgNorm.includes("descricao na clara") ||
            msgNorm.includes("como inserir nota") ||
            msgNorm.includes("nota fiscal") ||
            msgNorm.includes("nota da compra") ||
            msgNorm.includes("escrever justificativa") ||
            msgNorm.includes("como colocar justificativa") ||
            msgNorm.includes("comprovante") ||
            msgNorm.includes("comprovantes") ||
            msgNorm.includes("comprovante de compra") ||
            msgNorm.includes("comprovacao de despesa") ||
            msgNorm.includes("comprova√ß√£o de despesa") ||
            msgNorm.includes("registro de despesa") ||
            msgNorm.includes("lan√ßar despesa") ||
            msgNorm.includes("lancamento de despesa") ||
            msgNorm.includes("lan√ßamento de despesa") ||
            msgNorm.includes("reembolso sem nota") ||
            msgNorm.includes("perdi a nota") ||
            msgNorm.includes("despesa sem comprovante") ||
            msgNorm.includes("colocar comprovante") ||
            msgNorm.includes("como declarar") ||
            msgNorm.includes("declarar despesa") ||
            msgNorm.includes("como finalizar prestacao") ||
            msgNorm.includes("como finalizar presta√ß√£o") ||
            msgNorm.includes("relatorio de despesa") ||
            msgNorm.includes("relat√≥rio de despesa") ||
            msgNorm.includes("enviar nota") ||
            msgNorm.includes("falta a nota") ||
            msgNorm.includes("despesa sem nota") ||
            msgNorm.includes("finalizar contas") ||
            msgNorm.includes("minhas prestacoes") ||
            msgNorm.includes("minhas presta√ß√µes") ||
            msgNorm.includes("descri√ß√£o na clara")) {
            return "prestacao";
        }

        if (msgNorm.includes("lanche") ||
            msgNorm.includes("lanche pro time") ||
            msgNorm.includes("lanche para o time") ||
            msgNorm.includes("cafe pro time") ||
            msgNorm.includes("caf√© pro time") ||
            msgNorm.includes("coffee break") ||
            msgNorm.includes("agua") ||
            msgNorm.includes("√°gua") ||
            msgNorm.includes("gal√£o") ||
            msgNorm.includes("galao") ||
            msgNorm.includes("premiacao") ||
            msgNorm.includes("premia√ß√£o")) {
            return "alimentoTime";
        }

        if (msgNorm.includes("uber") ||
            msgNorm.includes("iber") ||
            msgNorm.includes(" 99") ||
            msgNorm.includes("taxi") ||
            msgNorm.includes("t√°xi") ||
            msgNorm.includes("tax√≠") ||
            msgNorm.includes("cabify") ||
            msgNorm.includes("transporte") ||
            msgNorm.includes("aplicativo de transporte") ||
            msgNorm.includes("motorista de aplicativo") ||
            msgNorm.includes("carro por app") ||
            msgNorm.includes("carona") ||
            msgNorm.includes("como chamar um carro") ||
            msgNorm.includes("como pedir um carro") ||
            msgNorm.includes("uber black") ||
            msgNorm.includes("uber x") ||
            msgNorm.includes("99 pop") ||
            msgNorm.includes("99taxi") ||
            msgNorm.includes("uber drive") ||
            msgNorm.includes("uber motorista") ||
            msgNorm.includes("uber pass") ||
            msgNorm.includes("uber eats") ||
            msgNorm.includes("servi√ßo de transporte") ||
            msgNorm.includes("qual app de carro") ||
            msgNorm.includes("motorista particular") ||
            msgNorm.includes("drive") ||
            msgNorm.includes("drivi") ||
            msgNorm.includes("indriver") ||
            msgNorm.includes("in driver") ||
            msgNorm.includes("waze carpool") ||
            msgNorm.includes("waze car pool") ||
            msgNorm.includes("taxi particular") ||
            msgNorm.includes("taxi 99") ||
            msgNorm.includes("app de taxi") ||
            msgNorm.includes("app de t√°xi") ||
            msgNorm.includes("app de transporte")) {
            return "transportePessoal";
        }

        if (msgNorm.includes("mudar de loja") ||
            msgNorm.includes("troca de loja") ||
            msgNorm.includes("trocar de loja") ||
            msgNorm.includes("mudan√ßa de loja") ||
            msgNorm.includes("mudanca de loja") ||
            msgNorm.includes("vou mudar de loja") ||
            msgNorm.includes("fui transferido") ||
            msgNorm.includes("transferido de loja") ||
            msgNorm.includes("transferencia de loja") ||
            msgNorm.includes("transfer√™ncia de loja") ||
            msgNorm.includes("gerente desligado") ||
            msgNorm.includes("sem gerente") ||
            msgNorm.includes("gerente saiu") ||
            msgNorm.includes("gerente saiu da loja") ||
            msgNorm.includes("cartao de outra loja") ||
            msgNorm.includes("cart√£o de outra loja") ||
            msgNorm.includes("usar cartao de outra loja") ||
            msgNorm.includes("trocar minha loja") ||
            msgNorm.includes("mudar minha loja") ||
            msgNorm.includes("sair da loja") ||
            msgNorm.includes("qual minha loja") ||
            msgNorm.includes("quero mudar a loja") ||
            msgNorm.includes("mudei de unidade") ||
            msgNorm.includes("trocar de unidade") ||
            msgNorm.includes("como troco de loja") ||
            msgNorm.includes("troquei de loja") ||
            msgNorm.includes("sou de outra loja") ||
            msgNorm.includes("sou de outra unidade") ||
            msgNorm.includes("cartao de loja diferente") ||
            msgNorm.includes("cart√£o de loja diferente") ||
            msgNorm.includes("gerente novo") ||
            msgNorm.includes("novo gerente") ||
            msgNorm.includes("cadastro de gerente") ||
            msgNorm.includes("tirar gerente") ||
            msgNorm.includes("excluir gerente") ||
            msgNorm.includes("quem e o gerente") ||
            msgNorm.includes("quem √© o gerente") ||
            msgNorm.includes("problema com gerente") ||
            msgNorm.includes("gerente nao esta na loja") ||
            msgNorm.includes("gerente n√£o est√° na loja") ||
            msgNorm.includes("minha loja esta sem gerente") ||
            msgNorm.includes("gerente demitido") ||
            msgNorm.includes("colocar cartao de outra loja") ||
            msgNorm.includes("habilitar cartao de outra loja") ||
            msgNorm.includes("como uso o cartao em outra loja") ||
            msgNorm.includes("cartao nao funciona em outra loja") ||
            msgNorm.includes("cart√£o n√£o funciona em outra loja") ||
            msgNorm.includes("usar cart√£o de outra loja")) {
            return "trocaGerente";
        }

        if (msgNorm.includes("sangria") ||
            msgNorm.includes("sangrias") ||
            msgNorm.includes("fazer sangria") ||
            msgNorm.includes("puxar dinheiro do caixa") ||
            msgNorm.includes("retirar dinheiro do caixa") ||
            msgNorm.includes("tirar dinheiro do caixa") ||
            msgNorm.includes("retirada de dinheiro do caixa") ||
            msgNorm.includes("movimentacao de dinheiro no caixa") ||
            msgNorm.includes("movimenta√ß√£o de dinheiro no caixa") ||
            msgNorm.includes("fechar o caixa") ||
            msgNorm.includes("como fechar o caixa") ||
            msgNorm.includes("retirar valor do caixa") ||
            msgNorm.includes("como fazer sangria") ||
            msgNorm.includes("registrar saida de dinheiro") ||
            msgNorm.includes("registrar sa√≠da de dinheiro") ||
            msgNorm.includes("saida de dinheiro do caixa") ||
            msgNorm.includes("sa√≠da de dinheiro do caixa") ||
            msgNorm.includes("suprimento") ||
            msgNorm.includes("suprimentos") ||
            msgNorm.includes("fazer suprimento") ||
            msgNorm.includes("colocar dinheiro no caixa") ||
            msgNorm.includes("registro de suprimento") ||
            msgNorm.includes("registro de retirada") ||
            msgNorm.includes("registrando sangria") ||
            msgNorm.includes("registro de sangria") ||
            msgNorm.includes("tirar troco do caixa") ||
            msgNorm.includes("depositar dinheiro no caixa") ||
            msgNorm.includes("deposito no caixa") ||
            msgNorm.includes("dep√≥sito no caixa") ||
            msgNorm.includes("remocao de dinheiro") ||
            msgNorm.includes("remo√ß√£o de dinheiro") ||
            msgNorm.includes("retirar excesso") ||
            msgNorm.includes("dinheiro a mais no caixa") ||
            msgNorm.includes("ajuste de caixa") ||
            msgNorm.includes("retirar dinheiro do caixa")) {
            return "sangria";
        }

        if (msgNorm.includes("nao reconheco") ||
            msgNorm.includes("n√£o reconhe√ßo") ||
            msgNorm.includes("fraude") ||
            msgNorm.includes("compra indevida") ||
            msgNorm.includes("contestar compra") ||
            msgNorm.includes("contestacao") ||
            msgNorm.includes("compra que nao fiz") ||
            msgNorm.includes("compra que n√£o fiz") ||
            msgNorm.includes("nao fiz essa compra") ||
            msgNorm.includes("n√£o fiz essa compra") ||
            msgNorm.includes("compra desconhecida") ||
            msgNorm.includes("uso indevido") ||
            msgNorm.includes("estorno") ||
            msgNorm.includes("quero estornar") ||
            msgNorm.includes("quero cancelar compra") ||
            msgNorm.includes("cancelar compra indevida") ||
            msgNorm.includes("compra suspeita") ||
            msgNorm.includes("transacao nao reconhecida") ||
            msgNorm.includes("transa√ß√£o n√£o reconhecida") ||
            msgNorm.includes("cartao clonado") ||
            msgNorm.includes("clonaram meu cartao") ||
            msgNorm.includes("clonaram meu cart√£o") ||
            msgNorm.includes("roubaram meu cartao") ||
            msgNorm.includes("roubaram meu cart√£o") ||
            msgNorm.includes("uso nao autorizado") ||
            msgNorm.includes("uso n√£o autorizado") ||
            msgNorm.includes("quero o dinheiro de volta") ||
            msgNorm.includes("reembolso") ||
            msgNorm.includes("solicitar estorno") ||
            msgNorm.includes("transacao suspeita") ||
            msgNorm.includes("tentativa de fraude") ||
            msgNorm.includes("estorno da compra") ||
            msgNorm.includes("cai em golpe") ||
            msgNorm.includes("golpe no cartao") ||
            msgNorm.includes("golpe no cart√£o") ||
            msgNorm.includes("fui roubado") ||
            msgNorm.includes("contesta√ß√£o")) {
            return "fraudeContestacao";
        }


        // assunto geral sobre o cart√£o
        if (
          msgNorm.includes("cartao clara") ||
          msgNorm.includes("cart√£o clara") ||
          msgNorm.includes("cartao") && msgNorm.includes("clara") ||
          msgNorm.includes("cartao das lojas") ||
          msgNorm.includes("cartao nas lojas") ||
          msgNorm.includes("cart√£o das lojas") ||
          msgNorm.includes("detalhe cart√£o clara") ||
          msgNorm.includes("detalhes cartao clara") ||
          msgNorm.includes("como funciona a clara") ||
          msgNorm.includes("oq √© a clara") ||
          msgNorm.includes("falar sobre o cartao") ||
          msgNorm.includes("falar sobre o cart√£o") ||
          msgNorm.includes("cartao corporativo") ||
          msgNorm.includes("cart√£o nas lojas") ||
          msgNorm.includes("informa√ß√µes sobre o cartao") ||
          msgNorm.includes("informa√ß√µes sobre o cart√£o") ||
          msgNorm.includes("duvida sobre o cartao") ||
          msgNorm.includes("d√∫vida sobre o cart√£o") ||
          msgNorm.includes("tudo sobre a clara") ||
          msgNorm.includes("o que √© a clara") ||
          msgNorm.includes("como funciona o cartao") ||
          msgNorm.includes("como funciona o cart√£o") ||
          msgNorm.includes("cartao das lojas") ||
          msgNorm.includes("cart√£o das lojas") ||
          msgNorm.includes("regras do cartao") ||
          msgNorm.includes("regras do cart√£o") ||
          msgNorm.includes("detalhes sobre a clara") ||
          msgNorm.includes("como usar o cartao") ||
          msgNorm.includes("como usar o cart√£o") ||
          msgNorm.includes("duvidas sobre a clara") ||
          msgNorm.includes("d√∫vidas sobre a clara") ||
          msgNorm.includes("detalhes do cartao") ||
          msgNorm.includes("detalhes do cart√£o") ||
          msgNorm.includes("tudo sobre o cartao") ||
          msgNorm.includes("tudo sobre o cart√£o") ||
          msgNorm.includes("o que e a clara") ||
          msgNorm.includes("o q e a clara") ||
          msgNorm.includes("cartao de credito corporativo") ||
          msgNorm.includes("cart√£o de cr√©dito corporativo") ||
          msgNorm.includes("informacao cartao") ||
          msgNorm.includes("informa√ß√£o cart√£o") ||
          msgNorm.includes("duvida clara") ||
          msgNorm.includes("d√∫vida clara") ||
          msgNorm.includes("cart√£o corporativo")
        ) {
          return "cartaoGeral";
        }


        if (msgNorm.includes("posso comprar") ||
            msgNorm.includes("posso usar") ||
            msgNorm.includes("pode usar") ||
            msgNorm.includes("pode pagar") ||
            msgNorm.includes("pode gastar") ||
            msgNorm.includes("pode comprar") ||
            msgNorm.includes("o que pode comprar") ||
            msgNorm.includes("oq eu posso comprar com o cart√£o") ||
            msgNorm.includes("oq pode comprar") ||
            msgNorm.includes("pode no cartao") ||
            msgNorm.includes("pode no cart√£o") ||
            msgNorm.includes("pode colocar no cartao") ||
            msgNorm.includes("pode colocar no cart√£o") ||
            msgNorm.includes("posso usar o cartao para") ||
            msgNorm.includes("posso usar o cart√£o para") ||
            msgNorm.includes("para que posso usar") ||
            msgNorm.includes("o que da pra pagar") ||
            msgNorm.includes("oq da pra pagar") ||
            msgNorm.includes("o que da para pagar") ||
            msgNorm.includes("posso pagar") ||
            msgNorm.includes("oq pagar") ||
            msgNorm.includes("pagar com o cartao") ||
            msgNorm.includes("pagar com o cart√£o") ||
            msgNorm.includes("oque posso pagar") ||
            msgNorm.includes("o q posso pagar") ||
            msgNorm.includes("oq eu posso pagar") ||
            msgNorm.includes("eu posso pagar") ||
            msgNorm.includes("posso passar o cartao") ||
            msgNorm.includes("posso passar o cart√£o") ||
            msgNorm.includes("oq eu gasto") ||
            msgNorm.includes("o que posso gastar") ||
            msgNorm.includes("posso usar cartao") ||
            msgNorm.includes("posso usar cart√£o") ||
            msgNorm.includes("o que posso fazer") ||
            msgNorm.includes("oq da pra fazer") ||
            msgNorm.includes("posso adquirir") ||
            msgNorm.includes("que da pra adquirir") ||
            msgNorm.includes("para que serve o cartao") ||
            msgNorm.includes("para que serve o cart√£o") ||
            msgNorm.includes("em que posso usar") ||
            msgNorm.includes("em que eu posso usar") ||
            msgNorm.includes("oq pode pagar") ||
            msgNorm.includes("pode ser pago") ||
            perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
            return "podeNaoPode";
        }

        // BOT: SOBRE O QUE ELE PODE FAZER
        if (
            msgNorm.includes("o que voce faz") ||
            msgNorm.includes("qual o seu nome") ||
            msgNorm.includes("qual √© o seu nome") ||
            msgNorm.includes("qual eh o seu nome") ||
            msgNorm.includes("qual eh seu nome") ||
            msgNorm.includes("como vc se chama") ||
            msgNorm.includes("como voce se chama") ||
            msgNorm.includes("como voc√™ se chama") ||
            msgNorm.includes("como vc chama") ||
            msgNorm.includes("como voce chama") ||
            msgNorm.includes("como voc√™ chama") ||
            msgNorm.includes("o que voc√™ faz") ||
            msgNorm.includes("o que vc faz") ||
            msgNorm.includes("pra que serve") ||
            msgNorm.includes("qual sua fun√ß√£o") ||
            msgNorm.includes("qual √© sua fun√ß√£o") ||
            msgNorm.includes("qual e sua fun√ß√£o") ||
            msgNorm.includes("qual sua funcao") ||
            msgNorm.includes("qual √© sua funcao") ||
            msgNorm.includes("quem √© voc√™") ||
            msgNorm.includes("quem e voce") ||
            msgNorm.includes("quem √© vc") ||
            msgNorm.includes("qm √© vc") ||
            msgNorm.includes("qm e vc") ||
            msgNorm.includes("qm eh vc") ||
            msgNorm.includes("qm eh voce") ||
            msgNorm.includes("qm eh voc√™") ||
            msgNorm.includes("quem e vc") ||
            msgNorm.includes("quem √© voc√™ clara") ||
            msgNorm.includes("quem √© o vektor") ||
            msgNorm.includes("quem √© voc√™ vektor") ||
            msgNorm.includes("qual seu papel") ||
            msgNorm.includes("como pode me ajudar") ||
            msgNorm.includes("o que pode fazer") ||
            msgNorm.includes("o que voce pode fazer") ||
            msgNorm.includes("o que voc√™ pode fazer") ||
            msgNorm.includes("sobre o que voce fala") ||
            msgNorm.includes("sobre o que voc√™ fala") ||
            msgNorm.includes("o que pode me orientar")||
            msgNorm.includes("pra que fui criado") ||
            msgNorm.includes("qual e meu proposito") ||
            msgNorm.includes("qual √© o seu proposito") ||
            msgNorm.includes("qual eh o seu proposito") ||
            msgNorm.includes("qual eh o seu fim") ||
            msgNorm.includes("meu proposito") ||  
            msgNorm.includes("diga o que sabe")	||  
            msgNorm.includes("me fale sobre voce") ||
            msgNorm.includes("me fale o que faz") ||	  
            msgNorm.includes("qual a sua utilidade") ||  
            msgNorm.includes("fun√ß√£o") ||
            msgNorm.includes("sua fun√ß√£o") ||
            msgNorm.includes("utilidade") ||
            msgNorm.includes("quais suas funcoes") ||
            msgNorm.includes("o q c faz") ||
            msgNorm.includes("o q faz") ||
            msgNorm.includes("o que √© isso") ||
            msgNorm.includes("oque √© isso") ||
            msgNorm.includes("oq √© isso") ||
            msgNorm.includes("oq eh isso") ||
            msgNorm.includes("o que voc√™ pode responder") ||
            msgNorm.includes("o que voc√™ pode responde") ||
            msgNorm.includes("oq vc faz?") ||
            msgNorm.includes("oq vc faz") ||
            msgNorm.includes("oq vc pode fazer") ||
            msgNorm.includes("o que vc pode fazer") ||
            msgNorm.includes("oque vc pode fazer") ||
            msgNorm.includes("oq voc√™ pode fazer") ||
            msgNorm.includes("oq voce pode fazer") ||
            msgNorm.includes("oq voce faz?") ||
            msgNorm.includes("o que voce faz?") ||
            msgNorm.includes("o que vc faz?") ||
            msgNorm.includes("o que vc pode fazer") ||
            msgNorm.includes("o que vc sabe fazer") ||
            msgNorm.includes("pra que voce serve") ||
            msgNorm.includes("pra que voc√™ serve") ||
            msgNorm.includes("pra que vc serve") ||
            msgNorm.includes("me explica o que faz") ||
            msgNorm.includes("me diga o que faz") ||
            msgNorm.includes("explica sua fun√ß√£o")
    ) 
    {
        return "sobreBot";
    }

            // ‚úÖ Inten√ß√£o: conversa geral sobre o cart√£o Clara
    if (
        msgNorm.includes("cartao clara") ||
        msgNorm.includes("cart√£o clara") ||
        (msgNorm.includes("cartao") && msgNorm.includes("clara")) ||
        (msgNorm.includes("cart√£o") && msgNorm.includes("clara")) ||
        msgNorm.includes("cartao das lojas") ||
        msgNorm.includes("cart√£o das lojas") ||
        msgNorm.includes("cartao nas lojas") ||
        msgNorm.includes("cart√£o nas lojas") ||
        msgNorm.includes("falar sobre o cartao") ||
        msgNorm.includes("falar sobre o cart√£o") ||
        msgNorm.includes("informacoes sobre o cartao") ||
        msgNorm.includes("informa√ß√µes sobre o cart√£o") ||
        msgNorm.includes("duvida sobre o cartao") ||
        msgNorm.includes("d√∫vida sobre o cart√£o") ||
        msgNorm.includes("tudo sobre a clara") ||
        msgNorm.includes("como funciona a clara") ||
        msgNorm.includes("o que √© a clara") ||
        msgNorm.includes("o que e a clara") ||
        msgNorm.includes("o q e a clara") ||
        msgNorm.includes("cartao corporativo") ||
        msgNorm.includes("cart√£o corporativo") ||
        msgNorm.includes("cartao de credito corporativo") ||
        msgNorm.includes("cart√£o de cr√©dito corporativo") ||
        msgNorm.includes("duvida clara") ||
        msgNorm.includes("d√∫vida clara")
    ) {
        return "cartaoGeral";
    }

    return "generica";
}


    /* ========= ETIQUETA POR MENSAGEM ========= */

    function acharEtiquetaPorMensagem(msgNorm) {
        const stopTerms = [
            "etiqueta","qual etiqueta","que etiqueta","categoria","qual categoria",
            "classificacao","classifica√ß√£o","tag","pode usar","posso usar",
            "posso comprar","pode comprar","cartao","cart√£o","cartao clara",
            "cart√£o clara","clara","limite","ajuda","duvida","d√∫vida"
        ].map(normalize);

        const palavras = msgNorm.split(/\s+/);

        let melhorMatch = null;
        let melhorForca = 0;

        for (const et of etiquetasOficiais) {
            let forcaAtual = 0;

            for (const termoOriginal of et.palavrasChave) {
                const termoNorm = normalize(termoOriginal);
                if (stopTerms.includes(termoNorm)) continue;

                if (palavras.includes(termoNorm)) {
                    forcaAtual += 2;
                }
                if (msgNorm.includes(termoNorm)) {
                    forcaAtual += 1;
                }
            }

            if (forcaAtual > melhorForca) {
                melhorForca = forcaAtual;
                melhorMatch = et;
            }
        }

        if (melhorForca === 0) return null;
        return melhorMatch;
    }

                /* ========= AVALIA√á√ÉO DE COMPRA ========= */

    const gruposProibidos = {
        eletrodomesticos: [
            "geladeira", "microondas", "micro-ondas", "friogrifico", "freezer", "frigobar", "Geladeira",
            "Refrigerador", "Fog√£o", "Cooktop", "Forno", "M√°quina de Lavar Lou√ßas", "Coifa", "Depurador",
            "Purificador de √Ågua", "M√°quina de Lavar Roupas", "Secadora de Roupas", "Centr√≠fuga", "secadora",
            "secadora de lou√ßas", "lavadora", "lava-roupas", "lava e seca", "lava-lou√ßas", "exaustor", "purificador",
            "bebedouro", "forno-microondas"
        ].map(normalize),

        eletroportateis: [
            "Liquidificador", "Batedeira", "Processador de Alimentos", "Mixer", "Air Fryer", "airfryer", "airfrier",
            "Panela El√©trica", "M√°quina de P√£o", "M√°quina de Waffle", "Cafeteira", "Chaleira", "Extrator de Suco",
            "Torradeira", "Sanduicheira", "Pipoqueira El√©trica", "Abridor de Lata El√©trico", "Abridor de Vinho El√©trico",
            "ferro", "ferro de passar", "Ferro de Passar Roupa", "M√°quina de Costura", "Aspirador de P√≥",
            "Lavadora de Jato de √Ågua", "Limpadora a Vapor", "Secador de Cabelo", "Chapinha", "Prancha",
            "Barbeador El√©trico", "barbeador", "Escova de Dente El√©trica", "escova de dente", "vaporizador"
        ].map(normalize),

        climatizacao: [
            "compressor", "ventilador", "ar condicionado", "ar-condicionado", "Ventilador", "Aquecedor El√©trico",
            "Desumidificador", "compressor de ar", "aquecedor", "climatizador"
        ].map(normalize),

        moveisUtensiliosCasa: [
            "mesa", "cadeira", "sof√°", "poltrona", "arm√°rio", "c√¥moda", "estante", "tapete", "persiana", "lustre",
            "aquario", "aquarios", "churraqueira", "carv√£o", "churrasco", "cadeira de balan√ßo"
        ].map(normalize),

        eletronicos: [
            "tv", "controle de tv", "controle remoto", "televisao", "televis√£o", "home theater", "hometheater", "som ambiente", "caixa de som grande", "caixa de som", "soundbar", "Celulares", "celular", "Smartphones", "Tablets", "Computadores", "computador", "notebook", "Monitores", "Impressoras", "Scanners", "Roteadores", "Modems", "HD", "SSD", "Calculadoras",
            "Televisores", "calculadora", "Aparelhos de Som", "Caixas de Som", "Fones de Ouvido", "Reprodutores de M√≠dia",
            "dvd", "C√¢meras Fotogr√°ficas Digitais", "C√¢meras de V√≠deo", "C√¢meras de Seguran√ßa", "C√¢meras de Monitoramento",
            "Smartwatches", "Pulseiras Fitness", "Controles Remotos", "Carregadores Port√°teis", "Power Bank", "powerbank",
            "power bank", "Lanterna El√©trica", "lanterna", "rel√≥gio", "relogios", "rel√≥gios", "projetor", "telao",
            "tel√£o", "tela gigante", "drone", "GoPro", "c√¢mera de a√ß√£o", "gimbal", "tablet", "smartwatch",
            "oculos", "√≥culos", "pen-drive", "pendrive", "gps"
        ].map(normalize),

        games: [
            "ps5", "xbox", "x-box", "PS5", "ps4", "playstation", "video game", "videogame", "jogos de videogame",
            "jogo de video game", "jogos de video game", "Consoles de Videogame", "game pass", "ps plus",
            "xbox live", "recarga de jogo", "moeda de jogo", "skin de jogo", "pacote de expans√£o", "jogo digital",
            "joguinho", "e-sports", "jogos online", "software de entretenimento", "ingresso virtual"
        ].map(normalize),

        veiculos: [
            "avi√£o", "caminh√£o", "carro", "veiculo", "ve√≠culo", "moto", "ferrari", "lamborghini", "bicicleta", "lancha",
            "iate", "jet ski", "barco", "trem", "√¥nibus", "trator", "m√°quina agr√≠cola", "patinete el√©trico", "patinete",
            "hoverboard", "caminhonete", "aviao", "avi√µes"
        ].map(normalize),

        instrumentosMusicais: [
            "viol√£o", "violao", "viol√µes", "guitarra", "baixo", "violino", "viola", "violoncelo", "contrabaixo", "harpa",
            "bandolim", "cavaquinho", "ukulele", "banjo", "cravo", "piano", "teclado", "sintetizador", "√≥rg√£o",
            "flauta", "flautim", "clarinete", "saxofone", "obo√©", "fagote", "trompete", "trombone", "tuba", "trompa",
            "harm√¥nica", "gaita", "acorde√£o", "escaleta", "bateria", "tambor", "caixa", "surdo", "pandeiro", "tri√¢ngulo",
            "prato", "chimbal", "bumbo", "t√≠mpano", "xilofone", "marimba", "vibrafone", "glockenspiel", "sinos",
            "caxixi", "agog√¥", "reco-reco", "cu√≠ca", "berimbau", "atabaque", "conga", "bong√¥", "maraca", "castanhola",
            "tamborim", "adufe", "tarol", "repique", "tam-tam", "djembe", "rabeca", "ala√∫de", "balalaica",
            "sitar", "koto", "shamisen", "didgeridoo", "ocarina", "euf√¥nio", "sousafone", "celesta", "theremin", "sampler",
            "sequenciador", "messing", "harpsichord", "clavic√≥rdio", "dulcimer", "rabeca chuleira", "gaita de fole",
            "violino popular", "xilarm√≥nico", "bombardino", "violone", "fliscorne", "clarim", "daxofone", "estradiv√°rio",
            "figle", "museta", "oficleide", "takuapu", "matraca", "c√≠mbalo", "gongo", "prato de bateria", "guitar"
        ].map(normalize),

        ferramentas: [
            "furadeira", "parafusadeira", "serra el√©trica", "compressor de ar"
        ].map(normalize),

        animais: [
            "animais", "vaca", "mam√≠fero", "mam√≠feros", "ave", "aves", "p√°ssaro", "p√°ssaros", "inseto", "insetos", "peixe",
            "peixes", "r√©ptil", "r√©pteis", "anf√≠bio", "anf√≠bios", "vertebrado", "vertebrados", "invertebrado", "invertebrados",
            "felino", "felinos", "can√≠deo", "can√≠deos", "roedor", "roedores", "primata", "primatas", "cerval", "cervais",
            "equino", "equinos", "bovino", "bovinos", "su√≠no", "su√≠nos", "ovino", "ovinos", "caprino", "caprinos", "c√£o",
            "cachorro", "gato", "le√£o", "tigre", "on√ßa", "lobo", "raposa", "urso", "elefante", "rinoceronte", "hipop√≥tamo",
            "girafa", "zebra", "macaco", "chimpanz√©", "gorila", "orangotango", "morcego", "coelho", "lebre", "esquilo",
            "rato", "camundongo", "capivara", "porco-espinho", "tatu", "tamandu√°", "pregui√ßa", "baleia", "golfinho",
            "tubar√£o", "peixe-boi", "foca", "le√£o-marinho", "sapo", "r√£", "perereca", "cobra-cega", "salamandra",
            "crocodilo", "jacar√©", "tartaruga", "c√°gado", "jabuti", "lagarto", "camale√£o", "cobra", "serpente",
            "papagaio", "arara", "tucano", "coruja", "√°guia", "falc√£o", "pardal", "can√°rio", "pintassilgo", "beija-flor",
            "gaivota", "pinguim", "avestruz", "ema", "pato", "ganso", "cisne", "galinha", "peru", "codorna", "mosquito",
            "mosca", "formiga", "abelha", "vespa", "borboleta", "mariposa", "besouro", "joaninha", "lib√©lula", "gafanhoto",
            "barata", "aranha", "escorpi√£o", "carrapato", "siri", "caranguejo", "lagosta", "camar√£o", "polvo", "lula",
            "estrela-do-mar", "ouri√ßo-do-mar", "√°gua-viva", "medusa", "coral", "an√™mona", "esponja-do-mar", "caracol",
            "lesma", "ostra", "mexilh√£o", "verme", "minhoca", "sanguessuga", "centopeia", "lacraia", "peixe-palha√ßo",
            "dourado", "salm√£o", "til√°pia", "bacalhau", "sardinha", "atum", "enguia", "arraia", "cavalo-marinho",
            "sapo-boi", "r√£-touro", "hiena", "chacal", "p√≠ton", "jib√≥ia", "iguana", "gecko", "periquito", "andorinha",
            "grilo", "pulga", "√°caro", "cachorros", "gatos", "c√£es", "ra√ß√£o", "ra√ß√µes"
        ].map(normalize),

        armasGuerra: [
            "tanque", "tanque de guerra", "guerra", "metranca", "metralhadora", "bomba", "C4", "nuclear", "fuzil",
            "fuzil de assalto", "fuzil semiautom√°tico", "fuzil de precis√£o", "rifle", "carabina", "submetralhadora",
            "metralhadora pesada", "metralhadora leve", "pistola", "rev√≥lver", "espingarda", "muni√ß√£o", "muni√ß√µes",
            "cartucho", "bala", "proj√©til", "granada", "morteiro", "m√≠ssil", "m√≠sseis", "bazuca", "lan√ßa-foguetes",
            "canh√£o", "obuseiro", "torpedo", "mina terrestre", "arma qu√≠mica", "arma biol√≥gica", "arma nuclear",
            "faca t√°tica", "baioneta", "faca de combate", "machado t√°tico", "silenciador", "supressor",
            "colete bal√≠stico", "colete a prova de balas", "capacete militar", "capacete t√°tico", "m√°scara de g√°s",
            "g√°s lacrimog√™neo", "c√¢mera de vis√£o noturna", "√≥culos t√°tico", "luva t√°tica", "botas militares",
            "coturno", "farda", "uniforme camuflado", "roupa t√°tica", "coldre", "porta carregador", "bolso modular",
            "cinto t√°tico", "joelheira t√°tica", "cotoveleira t√°tica", "placa bal√≠stica", "placas bal√≠sticas", "bandoleira",
            "blindado", "carro de combate", "ve√≠culo blindado", "lan√ßa m√≠sseis", "porta-avi√µes", "navio de guerra",
            "submarino", "drone militar", "ve√≠culo a√©reo n√£o tripulado", "aeronave de ca√ßa", "jato de ca√ßa",
            "bombardeiro", "avi√£o militar", "helic√≥ptero militar", "caminh√£o militar", "jeep militar", "helicopero",
            "mochila militar", "mochila t√°tica", "kit primeiros socorros t√°tico", "kit sobreviv√™ncia", "cantil",
            "cantil militar", "saco de dormir militar", "bin√≥culo", "tel√™metro", "b√∫ssola", "gps t√°tico",
            "lanterna t√°tica", "apito t√°tico", "marmita militar", "pazinha de trincheira", "B2", "bunker", "missel",
            "armas"
        ].map(normalize),

        bensServicosAbstratos: [
            "diamante", "ouro", "prata", "joia", "bracelete", "colar", "quadro", "escultura", "pintura", "a√ß√µes",
            "criptomoeda", "t√≠tulos", "bonds", "consulta m√©dica", "terapia", "psic√≥logo", "exames", "tratamentos",
            "cirurgia", "plano de sa√∫de", "curso", "faculdade", "mentoria", "aluguel", "imposto", "multa", "reforma",
            "manuten√ß√£o", "limpeza", "seguro", "doa√ß√£o", "gorjeta", "champanhe", "champagne", "viagem", "piscina",
            "piso", "porcelanato", "tijolo", "bloco", "universo", "planeta", "sol", "furacao", "aeroporto", "lua",
            "parque de divers√£o", "cinema", "parque", "ingresso", "ingressos", "teatro", "museu", "exposi√ß√£o",
            "espet√°culo", "circense", "√≥pera", "concerto", "bal√©", "excurs√£o", "tour guiado", "passeio", "visita guiada",
            "galeria de arte", "livro", "livros", "revista", "revistas", "e-book", "cd", "dvd", "vinil", "curso de arte",
            "curso de m√∫sica", "curso de dan√ßa", "assinatura", "streaming", "streaming de v√≠deo", "streaming de √°udio",
            "netflix", "spotify", "disney+", "globoplay", "prime video", "youtube premium", "youtube", "deezer", "tidal",
            "hbo max", "telecine play", "bilhete de trem", "bilhete de √¥nibus", "passagem a√©rea", "hotel", "aula de teatro",
            "aluguel de carro", "praia", "camping", "pesca", "ca√ßa", "boliche", "patina√ß√£o", "escalada", "kart",
            "paintball", "tirolesa", "rapel", "trilha", "academia", "yoga", "pilates", "crossfit", "luta", "massagem",
            "spa", "sauna", "day spa", "clube de campo", "mensalidade clube", "rod√≠zio", "buffet", "restaurante",
            "bar", "cafeteria", "fast food", "pacote de viagem", "lazer", "entretenimento", "recrea√ß√£o", "hobbies",
            "compra com milhas", "cart√£o presente", "gift card", "cr√©dito em plataforma", "recarga de celular",
            "compra de pontos", "programa de pontos", "sorteio", "rifa", "pr√©dio", "casa", "apartamento",
            "previd√™ncia privada", "previd√™ncia", "plano de previd√™ncia", "cdi", "cdb", "certificado de dep√≥sito banc√°rio",
            "lci", "lca", "letra de cr√©dito imobili√°rio", "letra de cr√©dito do agroneg√≥cio", "t√≠tulos de renda fixa",
            "fundos de investimento", "cotas de fundos", "lci 180 dias", "investimento via cart√£o", "aporte via cart√£o",
            "cashback investimento", "milhas para investimento", "compra de milhas", "criptomoedas",
            "token de investimento", "nucoin", "cashback", "cash back", "bitcoin", "milhas", "brinquedo", "brinquedos",
            "veneno", "mata inseto", "isca", "iscas", "cobasi", "arvore", "flores", "planta"
        ].map(normalize),

        restritos: [
            "drogas", "produtos falsificados", "material pornogr√°fico", "porno", "pornografia", "esp√©cies amea√ßadas",
            "rem√©dios controlados", "produtos de tabaco", "cigarro", "charuto", "muni√ß√£o", "prostituta", "puta",
            "programa", "night", "sexo", "transar", "camisinha", "vibrador", "KY", "chupeta"
        ].map(normalize),

        inteligenciaArtificial: [
            "ChatGPT", "GPT-3", "GPT-4", "GPT-4o", "GPT", "Gemini", "Google Gemini", "Gemini Pro", "Gemini Ultra",
            "Microsoft Copilot", "Copilot", "Claude", "Claude 3", "Claude 3 Opus", "Claude 3 Sonnet", "Claude 3 Haiku",
            "Llama", "Llama 2", "Llama 3", "Mistral", "Grok", "AlphaGo", "IBM Watson", "Watson", "TensorFlow", "PyTorch",
            "Keras", "Azure AI", "Azure Machine Learning", "Google Cloud AI", "Vertex AI", "Amazon SageMaker", "DALL-E",
            "DALL-E 2", "DALL-E 3", "Midjourney", "Stable Diffusion", "Stable Diffusion XL", "SDXL", "Code Llama", "Whisper",
            "Jasper", "Jasper AI", "Copy AI", "Beautiful AI", "Grammarly", "Synthesia", "Picsart AI", "Otter AI",
            "Tesla Autopilot", "ClickUp Brain", "H2O.ai", "Scikit-learn", "OpenAI Gym", "Tabnine", "GitHub Copilot",
            "Perplexity", "Duck AI", "Siri", "Alexa", "Meta AI", "NotebookLM", "WordAI", "DeepBrain AI", "Salesforce Einstein",
            "Fireflies", "Pictory", "Speechify", "Poised", "You.com", "Andi", "Chatfuel", "Dialogflow", "Cursor",
            "Mya Systems", "Olivia by Paradox", "SeekOut", "SAP S/4HANA AI", "Breeze by HubSpot", "sap", "github", "excel",
            "word", "text-pad", "textpad"
        ].map(normalize),

        utensiliosCozinha: [
            "garfo", "faca", "colher", "colher de sopa", "colher de ch√°", "colher de sobremesa", "faca de serra",
            "faca de p√£o", "faca de carne", "esp√°tula", "concha", "escumadeira", "fouet", "batedor de ovos",
            "abridor de lata", "abridor de garrafa", "saca-rolhas", "ralador", "descascador", "peneira",
            "espremedor de alho", "cortador de pizza", "tesoura de cozinha", "pegador de macarr√£o",
            "pegador de salada", "t√°bua de corte", "pirex", "travessa", "assadeira", "forma de bolo",
            "frigideira", "panela", "ca√ßarola", "leiteira", "cuscuzeiro", "chaleira", "bule", "x√≠cara",
            "copo", "ta√ßa", "prato", "pires", "saladeira", "tigela", "bowl"
        ].map(normalize)

    };

    const mensagensBrincadeiraPorGrupo = {
        eletrodomesticos: "Front de loja n√£o √© cozinha planejada, n√©? üòÖ",
        eletroportateis: "Vai montar uma cozinha gourmet a√≠ na loja? üòÇ",
        climatizacao: "Climatizar a loja √© importante, mas isso entra como patrim√¥nio, n√£o no cart√£o da Clara üòâ",
        moveisUtensiliosCasa: "Parece mais compra de mob√≠lia do que despesa do dia a dia da loja üò¨",
        eletronicos: "Isso a√≠ t√° com mais cara de patrim√¥nio do que de gasto operacional‚Ä¶ üì∫",
        games: "Montar lan house com cart√£o da loja n√£o vai rolar, hein üéÆüòÑ",
        veiculos: "Cart√£o Clara n√£o √© financiamento de concession√°ria e nem tem limite infinito, hein! üöóüí≥",
        instrumentosMusicais: "Vai montar uma banda a√≠ na loja? üé∏üòÑ",
        ferramentas: "Vai montar uma oficina? üò•",
        animais: "Nossa, n√£o sabia que voc√™ tava montando um zool√≥gico na loja ü§£",
        armasGuerra: "Calma l√°, Rambo‚Ä¶ o cart√£o √© pra opera√ß√£o da loja, n√£o pra guerra ‚öîÔ∏èüòÇ",
        bensServicosAbstratos: "Isso tem bem mais cara de investimento/lazer/servi√ßo pessoal do que despesa da loja. T√° estressado e quer relaxar, n√©? üòÖ",
        restritos: "Esse tipo de item √© proibido de qualquer jeito, dentro ou fora da pol√≠tica da Clara üò∂‚Äçüå´Ô∏è",
        inteligenciaArtificial: "Nem as IAs escapam da pol√≠tica do cart√£o corporativo, viu? ü§ñüö´",
        utensiliosCozinha: "MasterChef que habita em voc√™ n√£o √© o mesmo que habita na Clara üßëüèº‚Äçüç≥"
    };

    function avaliarCompraEspecifica(msgNorm) {
        const baseMsg = `Esse tipo de item <b>N√ÉO</b> pode ser comprado com o cart√£o.<br>
Ele deve seguir o processo de requisi√ß√£o junto √† √°rea de Compras (se for relevante e apto de acordo com o neg√≥cio e estiver dentro da pol√≠tica da √°rea), com aprova√ß√£o formal, n√£o o cart√£o da loja.`;

        // 1) Checa os GRUPOS de proibidos primeiro
        for (const [grupo, palavras] of Object.entries(gruposProibidos)) {
            for (const palavra of palavras) {
                const regex = new RegExp(`\\b${palavra}\\b`, "i");
                    if (regex.test(msgNorm)) {
                    const intro = mensagensBrincadeiraPorGrupo[grupo] || "‚õî N√£o pode usar o cart√£o Clara pra isso.";
                    const respostaFinal = `${intro}<br><br>${baseMsg}`;

                    return {
                        pode: false,
                        resposta: respostaFinal
                    };
                }
            }
        }

        // 2) Casos espec√≠ficos de PROIBIDOS (alimenta√ß√£o pessoal, √°lcool, transporte pessoal)
        const pessoalAlim = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        for (const termo of pessoalAlim) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja. Se j√° foi pago com o cart√£o, precisa sinalizar como "Despesa Pessoal ‚Äì Uso Indevido", avisar o Financeiro e ressarcir em at√© 2 dias √∫teis.`
                };
            }
        }

        const alcool = ["cerveja","vodka","vinho","whisky","whiskey","cacha√ßa","cachaca","gin","tequila"].map(normalize);
        for (const termo of alcool) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Bebida alco√≥lica n√£o √© permitida no cart√£o Clara. Isso n√£o √© considerado despesa operacional autorizada.`
                };
            }
        }

        const transportePessoal = ["uber"," 99","taxi","t√°xi","tax√≠","cabify"].map(normalize);
        for (const termo of transportePessoal) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: false,
                    resposta: `Uber / 99 / t√°xi para deslocamento pessoal n√£o pode no cart√£o Clara. N√£o √© gasto operacional direto da loja.`
                };
            }
        }

        // 3) Casos espec√≠ficos PERMITIDOS (lanche time, perif√©ricos, servi√ßos emergenciais)
        const palavrasTime = [
            "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
            "lanche time","lanche pro time","lanche para o time",
            "treinamento","premiacao","premia√ß√£o","acao oficial","a√ß√£o oficial",
            "acao vm","a√ß√£o vm","acao regional","a√ß√£o regional",
            "agua pra equipe","√°gua pra equipe","gal√£o de agua","galao de agua","gal√£o de √°gua",
            "salgadinho pra treinamento","bolo pra treinamento",
            "suco pra treinamento","suco para treinamento","lanche treinamento"
        ].map(normalize);

        for (const termo of palavrasTime) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "LANCHES DE REFEI√á√ïES / AGUA POT√ÅVEL",
                        desc: "Coffee break autorizado, √°gua/lanche para equipe em treinamento interno aprovado, a√ß√£o oficial da loja (VM, regional, diretoria) ou premia√ß√£o operacional.",
                        exemploDescricao: "Coffee break treinamento VM loja 1234"
                    },
                    resposta: `Pode usar o cart√£o Clara se for a√ß√£o autorizada (treinamento interno, VM, regional, diretoria, premia√ß√£o operacional). Precisa lan√ßar na Clara em at√© 48h com nota fiscal, etiqueta correta e descri√ß√£o objetiva.`
                };
            }
        }

        const perifOperacional = [
            "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
            "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa",
            "bobina ecf","bobina fiscal"
        ].map(normalize);

        for (const termo of perifOperacional) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "MATERIAL DE INFORM√ÅTICA",
                        desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                        exemploDescricao: "Teclado PDV loja 1234"
                    },
                    resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) √© considerado suprimento operacional de baixo valor para a loja e pode ser pago no cart√£o Clara, desde que classificado corretamente e lan√ßado em at√© 48h.`
                };
            }
        }

        const servicoEmerg = [
            "chaveiro","abrir cofre","abrir estoque","perdi a chave",
            "motoboy","sedex","correios","envio de documento","postar documento",
            "mandar documento","enviar documento"
        ].map(normalize);

        for (const termo of servicoEmerg) {
            if (msgNorm.includes(termo)) {
                return {
                    pode: true,
                    etiquetaValida: {
                        nome: "TRANSPORTE SERVI√áOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                        desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                        exemploDescricao: "Motoboy urgente documenta√ß√£o loja 1234"
                    },
                    resposta: `Servi√ßos emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cart√£o Clara, desde que sejam necessidade imediata da opera√ß√£o e sejam justificados na Clara dentro de 48h.`
                };
            }
        }

        // 4) Se n√£o casou em nada, deixa para a resposta gen√©rica
        return { pode: null, resposta: "" };
    }

    /* ========= RESPOSTAS ========= */


    function respostaForaEscopo() {
        return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
    }

    function respEtiquetaDireta(et) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nome}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.descricao}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}

<p class="mt-2">
<b>Como lan√ßar na Clara (at√© 48h):</b><br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar a etiqueta: "${et.nome}";<br/>
3. Descrever objetivamente o gasto no campo <b>Coment√°rio</b> (ex.: "Compra de xxxx para ____");<br/>
4. Guardar o documento f√≠sico na loja pelo prazo indicado pela pol√≠tica.
</p>
</div>`;
    }

    function respLimite() {
        return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br><br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende,<br>‚Ä¢ Novo limite requerido.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.<br><br>Lembrando que o limite foi definido conforme o hist√≥rico de gastos de cada loja, √© um valor individual e diferente para cada uma. <b>O limite √© reestabelecido todo dia 06 de cada m√™s</b>, fique atento! üòâ';
    }

    function respBloqueio() {
        return `HTML:<p class="text-sm text-slate-700">
Geralmente quando voc√™ n√£o consegue usar o cart√£o pode ser devido ao bloqueio preventivo, que acontece quando tem alguma compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
‚Ä¢ faltou nota fiscal/recibo;<br/>
‚Ä¢ n√£o colocou etiqueta correta;<br/>
‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
Passos pra desbloquear:<br/>
1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolher etiqueta certa, descrever o motivo real).<br/>
2. Encaminhar chamado via <b>ServiceNow</b> para desbloqueio, caminho: <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Desbloqueio</b>.<br/><br/>
</p>`;
    }

    function respPoliticaOficial() {
        return `HTML:<div class="text-sm text-slate-700">
<p>Seguem as regras oficiais de refer√™ncia da empresa.</p>
<p>
<a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
<strong>Pol√≠tica de Uso dos Cart√µes Clara (documento oficial)</strong>
</a>.
</p>
<p>Use sempre esse documento como fonte final.</p>
</div>`;
    }

    function respCatalogoEtiquetas() {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiquetas oficiais e quando usar:</b></p>

<p class="mt-2"><b>MATERIAL DE INFORM√ÅTICA</b><br/>
Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (baixo valor, sem controle patrimonial).<br/>
Exemplo de descri√ß√£o: "Teclado PDV loja 1234".</p>

<p class="mt-2"><b>MATERIAL DE ESCRIT√ìRIO</b><br/>
Caneta, pasta, bloco de anota√ß√£o, grampeador, etiqueta adesiva, organizador de mesa, papelaria b√°sica da opera√ß√£o administrativa da loja.</p>

<p class="mt-2"><b>AGUA POT√ÅVEL</b><br/>
Gal√£o de √°gua mineral / garrafas de √°gua para abastecimento da equipe ou uso da loja, quando previsto e autorizado operacionalmente.</p>

<p class="mt-2"><b>LANCHES DE REFEI√á√ïES</b><br/>
Coffee break ou lanche para treinamento interno autorizado, a√ß√£o oficial da √°rea (VM, regional, diretoria) ou premia√ß√£o operacional da equipe (n√£o vale refei√ß√£o pessoal).</p>

<p class="mt-2"><b>TRANSPORTE SERVI√áOS EMERGENCIAS</b><br/>
Motoboy emergencial / frete local urgente para levar ou buscar material importante entre lojas ou matriz.</p>

<p class="mt-2"><b>CORREIOS_SEDEX/AR/POSTAGEM</b><br/>
Envio de documentos oficiais da loja via Sedex/AR/postagem. Tamb√©m serve para devolu√ß√µes pequenas quando for processo formal.</p>

<p class="mt-2"><b>CHAVEIRO EMERGENCIAL</b><br/>
Abertura urgente de cofre / estoque / sala administrativa quando houve perda de chave ou travamento, s√≥ em situa√ß√£o emergencial.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO CIVIL</b><br/>
Pequenos reparos estruturais internos de baixa complexidade: ajuste em porta, troca de vidro quebrado, fixar prateleira, ajuste de revestimento etc.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO EL√âTRICA</b><br/>
Troca de tomada, disjuntor, interruptor, soquete, reator, extens√£o, pequenos reparos de baixa tens√£o necess√°rios pro funcionamento da loja.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO AR-CONDICIONADO</b><br/>
Limpeza de filtro, troca de controle remoto, carga de g√°s simples, pequenos ajustes que mantenham o ar funcionando.</p>

<p class="mt-2"><b>BOBINA ECF</b><br/>
Bobina fiscal / bobina de impressora obrigat√≥ria pro PDV, quando n√£o h√° fornecimento centralizado.</p>

<p class="mt-2"><b>SERVI√áOS GR√ÅFICOS E DE COPIADORAS</b><br/>
Impress√£o de banner, adesivo de campanha, plotagem promocional, encaderna√ß√£o de material de comunica√ß√£o da loja.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO EQUIPAMENTOS</b><br/>
Ajustes/reparos em m√°quinas de estampar, impressoras de etiqueta, computadores fora de garantia e de baixo valor etc. (nada de compra de equipamento grande).</p>

<p class="mt-4">Se voc√™ n√£o encontrou nada que encaixa no seu caso, abra chamado no<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer"><strong>ServiceNow</strong></a>pedindo cria√ß√£o ou libera√ß√£o de etiqueta.</p>
</div>`;
    }

    function respPrestacaoContas() {
        return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 180 dias corridos. N√£o justificar no prazo =&gt; risco de bloqueio preventivo.
</p>`;
    }

    function respAlimentoTime() {
        return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
    }

    function respTransportePessoal() {
        return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja. O procedimento correto √© solicitar via aplicativo com a conta corporativa da empresa.<br/><br/>
Se j√° usou de forma pessoal (pagando do pr√≥prio bolso) e quer o reembolso:<br/>
‚Ä¢ Solicite o reembolso atrav√©s da plataforma Vexpenses (√© necess√°rio autoriza√ß√£o do seu gestor).<br/>
</p>`;
    }

    function respTrocaGerente() {
        return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja segue assim:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja;<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234";<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado;<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Se tiver caso especial, fale com o Financeiro e, se preciso, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow.
</a>.
</p>`;
    }

    function respCartaoGeral() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Sobre o cart√£o Clara nas lojas:</b></p>

<p class="mt-1">
O cart√£o Clara √© o meio oficial para pagar <b>despesas operacionais da loja</b>, em substitui√ß√£o ao antigo processo de sangrias, como:
</p>
<ul class="list-disc ml-4 mt-1">
  <li>materiais de limpeza e pequenos reparos;</li>
  <li>materiais de escrit√≥rio e inform√°tica de baixo valor;</li>
  <li>√°gua / coffee break para treinamentos internos e a√ß√µes autorizadas;</li>
  <li>servi√ßos emergenciais (motoboy, chaveiro, correios em situa√ß√µes operacionais).</li>
</ul>

<p class="mt-2">
Sempre precisa:
</p>
<ul class="list-disc ml-4 mt-1">
  <li>nota fiscal ou recibo;</li>
  <li>etiqueta correta na Clara;</li>
  <li>descri√ß√£o objetiva do gasto;</li>
  <li>lan√ßar tudo em at√© <b>48h</b> no app/web da Clara.</li>
</ul>

<p class="mt-2">
N√£o pode usar o cart√£o para:
</p>
<ul class="list-disc ml-4 mt-1">
  <li>gasto pessoal (roupa, almo√ßo/jantar pessoal, compras para uso pr√≥prio);</li>
  <li>bebida alco√≥lica;</li>
  <li>Uber / 99 / t√°xi para deslocamento pessoal;</li>
  <li>itens patrimoniais / infraestrutura (TV, geladeira, micro-ondas, mesa, cadeira etc.).</li>
</ul>

<p class="mt-2">
Se quiser, posso te explicar um caso espec√≠fico. Por exemplo:
<br/>‚Ä¢ "Posso comprar teclado?"<br/>
‚Ä¢ "Pode lanche pra equipe?"<br/>
‚Ä¢ "O que n√£o pode no cart√£o?"
</p>
</div>`;
}

    function respSangria() {
        return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© <b>DESCONTINUADO</b>.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
    }

    function respFraudeContestacao() {
        return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente;<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o;<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal, a√≠ precisa ressarcir em at√© 2 dias √∫teis; n√£o √© contesta√ß√£o.
</p>`;
    }

    function respTermoResponsabilidade() {
        return `HTML:<div class="text-sm text-slate-700">
<p>
O <b>Termo de Responsabilidade de uso do cart√£o da Clara</b> deve ser preenchido para que a loja possa utilizar o cart√£o. Esse termo traz tamb√©m o aceite para a Pol√≠tica de uso do cart√£o.
<p class="mt-2">
Preencha <a class="service-link" href="https://docs.google.com/forms/d/e/1FAIpQLSdnQWYFWp-udS9V039avJlXb4x1VnlDC6us5dSCrLkgngAxpg/alreadyresponded" target="_blank" rel="noopener noreferrer"><b>este formul√°rio</b></a>. Ap√≥s preencher voc√™ receber√° o termo anexado ao e-mail, onde deve <b>imprimir, assinar e nos enviar</b>. Ap√≥s isso, o uso do cart√£o estar√° liberado.
</p>
</div>`;
    }

    function respNovoCartaoPrimeiraVia() {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Primeira via de cart√£o Clara (novo cart√£o)</b></p>
<p class="mt-1">
Para solicitar a <b>primeira via</b> do cart√£o Clara, siga estes passos:
</p>
<ol class="list-decimal ml-5 mt-1">
  <li>Preencha o formul√°rio: <a href="https://docs.google.com/forms/d/1vGAsFHuDQ6y5ydJMuE7W9ThJFjsLma_1I6yw92OLHh4/viewform"
       target="_blank" rel="noopener noreferrer"><b>Formul√°rio de Solicita√ß√£o de Cart√£o Clara</b></a>.
  
  <li class="mt-1">Depois de preencher o formul√°rio, envie um e-mail para o Financeiro informando que j√° preencheu, para que o cart√£o seja emitido: <b>contasareceber@gruposbf.com.br</b>
<p class="mt-2">
O prazo de entrega do cart√£o √© de at√© <b>7 dias √∫teis</b>, conforme a pol√≠tica interna.
</p>
</div>`;
    }

    function respNovoCartaoSegundaVia() {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Segunda via de cart√£o Clara (cart√£o j√° existia)</b></p>
<p class="mt-1">
A solicita√ß√£o de <b>segunda via</b> (perda, roubo, dano ou troca de portador) deve seguir o fluxo previsto na Pol√≠tica de Uso dos Cart√µes Clara:
</p>
<ul class="list-disc ml-5 mt-1">
  <li>Bloquear imediatamente o cart√£o antigo na plataforma / app da Clara atrav√©s da funcionalidade de <b>"Congelar"</b>;</li>
  <li>Registrar o motivo (perda, roubo, quebra, etc.) conforme orienta√ß√µes internas;</li>
  <li>Abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6"target="_blank" rel="noopener noreferrer"><b>ServiceNow</b></a> solicitando a emiss√£o de segunda via do cart√£o Clara.
<p class="mt-2">
Sempre siga as orienta√ß√µes detalhadas na <b>Pol√≠tica de Uso dos Cart√µes Clara</b> para casos de reemiss√£o/segunda via.
</p>
</div>`;
    }

    function respGenerica(msgNorm) {
        const avaliacao = avaliarCompraEspecifica(msgNorm);

        if (avaliacao.pode === false) {
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
        }

        if (avaliacao.pode === true && avaliacao.etiquetaValida) {
            const et = avaliacao.etiquetaValida;
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
</div>`;
        }

        if (perguntasGeraisOquePosso.some(f => msgNorm.includes(f))) {
            return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ O que pode no cart√£o Clara</b> - Exemplos de materiais:</p>
<ul class="list-disc ml-4 mt-1">
<li>Materiais de escrit√≥rio: canetas, blocos, pastas, papel, clips, organizadores, grampeadores;</li>
<li>Servi√ßos gr√°ficos e de comunica√ß√£o visual: impress√£o de banners, adesivos promocionais, folders e plotagens autorizadas pela √°rea de VM;</li>
<li>Compra de √°gua mineral ou gal√µes para abastecimento da equipe (etiqueta ‚Äú√ÅGUA POT√ÅVEL‚Äù);</li>
<li>Suprimentos de inform√°tica (mouse, teclado, cabos, bobina fiscal etc.);</li>
<li>Lanches, coffee breaks ou premia√ß√µes para equipe somente quando vinculados a treinamentos internos, a√ß√µes oficiais ou campanhas aprovadas (etiqueta ‚ÄúLANCHES DE REFEI√á√ïES‚Äù);</li>
<li>Servi√ßos emergenciais (motoboy urgente, chaveiro, Sedex de documento);</li>
<li>Compra de bobinas fiscais ou suprimentos obrigat√≥rios do PDV;</li>
<li>Pequenas manuten√ß√µes (el√©trica, civil, ar-condicionado, equipamentos).</li>
</ul>
<p class="mt-2"><b>‚ùå O que n√£o pode</b> - Exemplos de itens n√£o permitidos:</p>
<ul class="list-disc ml-4">
<li>Itens patrimoniais ou de infraestrutura: TV, micro-ondas, geladeira, freezer, mesa, cadeira, arm√°rio, ventilador, cafeteira el√©trica, computador, impressora, celular, tablets, ou qualquer bem dur√°vel;</li>
<li>Bebidas alco√≥licas (cerveja, vinho, whisky, vodka, gin, tequila, entre outras);</li>
<li>Transporte pessoal: Uber, 99, t√°xi, aplicativos de carona ou combust√≠vel para ve√≠culo particular;</li>
<li>Despesas pessoais: almo√ßo, jantar, lanche, coffee break pessoal, delivery, supermercado para consumo pr√≥prio;</li>
<li>Equipamentos e mobili√°rios que exigem tombamento patrimonial (mesmo que de baixo valor);</li>
<li>Manuten√ß√µes estruturais de grande porte (obras, pintura geral, reformas, trocas de piso, el√©trica complexa, etc.);</li>
<li>Servi√ßos ou produtos sem nota fiscal (inclusive compras em marketplaces sem NF emitida no CNPJ da loja);</li>
<li>Gastos fora da opera√ß√£o da loja ou que n√£o tenham rela√ß√£o com a atividade comercial;</li>
</ul>
</div>`;
        }

        return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cart√£o Clara, o gasto precisa ser <b>necess√°rio pra opera√ß√£o da loja</b> (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal, √°gua/coffee break autorizado pra treinamento interno ou a√ß√£o oficial).</p>
<p class="mt-2">O que <b>n√£o pode</b> no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (refei√ß√£o pessoal, compra pra uso pr√≥prio etc.);<br/>
‚Ä¢ bebida alco√≥lica em geral;<br/>
‚Ä¢ transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira, entre outros).</p><br/>
Caso entenda que a compra √© essencial para o dia a dia da loja, fale com o financeiro, caso seja verificado que o item √© essencial eles podem abrir uma exce√ß√£o para a compra.
</div>`;
    }

    /* ========= FUN√á√ïES DE PEND√äNCIAS (BACKEND) ========= */

    function consultarPendenciasNoServidor(loja) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (!res || !res.ok) {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
N√£o consegui consultar as pend√™ncias da loja <b>${loja}</b>.<br/>
Detalhe: ${erro}
</p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                if (!res.rows || res.rows.length === 0) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
                  N√£o encontrei pend√™ncias para a loja <b>${loja}</b> na √∫ltima data de cobran√ßa.
                  </p>`
                    );
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return;
                }

                ultimaPendenciaResumo = { loja: res.loja, data: res.ultimaData };
                lojaPendenciasAtual = res.loja;

                let tabela = `
                <div class="text-sm text-slate-700">
                <p>Encontrei abaixo as √∫ltimas pend√™ncias Clara da loja <b>${res.loja}</b> (data de cobran√ßa <b>${res.ultimaData}</b>). Caso a pend√™ncia j√° tenha sido regularizada e o seu cart√£o ainda esteja bloqueado, solicite o desbloqueio atrav√©s de abertura de chamado no ServiceNow, caminho: <b>Contas a Receber &gt; Cart√£o Clara &gt; Solicita√ß√£o de Desbloqueio</b>.</p>
                <div class="mt-2 overflow-x-auto">
                <table class="min-w-full text-xs border border-slate-200">
                <thead class="bg-slate-100">
                <tr>`;

                const header = res.header || [];
                header.forEach(h => {
                    tabela += `<th class="border px-2 py-1">${h}</th>`;
                });
                tabela += `</tr></thead><tbody>`;

                res.rows.forEach(linha => {
                    tabela += `<tr>`;
                    linha.forEach(col => {
                        tabela += `<td class="border px-2 py-1">${col !== null && col !== undefined ? col : ""}</td>`;
                    });
                    tabela += `</tr>`;
                });

                tabela += `</tbody></table></div></div>`;

                renderBotMessage("HTML:" + tabela);

                // pergunta se quer e-mail
                estadoPendencias = "aguardando_confirmacao_email";
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700 mt-2">Quer que eu envie esse resumo por e-mail tamb√©m? (responda <b>"sim"</b> ou <b>"n√£o"</b>).</p>'
                );
            })
            .withFailureHandler(function(err) {
                console.error("Erro getPendenciasPorLoja:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pend√™ncias dessa loja. Tente novamente mais tarde.</p>'
                );
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
            })
            .getPendenciasPorLoja(loja);
    }

            function consultarPendenciasBloqueio(loja) {
                google.script.run
                .withSuccessHandler(res => {
                // algum erro ou resposta estranha
                if (!res || !res.ok || !res.html) {
                estadoPendencias = "nenhum";
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
                Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
                </p>`
                            );
                            return;
                        }

                        // mostra o HTML que veio do .gs (tabela ou mensagem de "n√£o encontrei")
                        renderBotMessage("HTML:" + res.html);

                        // üü° CASO 1: n√£o h√° pend√™ncias para essa loja
                        // (detectamos pela mensagem de "N√£o encontrei pend√™ncias")
                        if (res.html.includes("N√£o encontrei pend√™ncias")) {
                            estadoPendencias = "nenhum"; // n√£o faz sentido perguntar de e-mail

                            renderBotMessage(
                                `HTML:<p class="text-sm text-slate-700 mt-2">
                    Acredito que, caso realmente o cart√£o esteja bloqueado, possa ser por algum outro motivo. Verifique com o time do Financeiro o que pode ter ocorrido, ok?
                    </p>`
                                    );

                            return; // encerra aqui
                        }

                        // üü¢ CASO 2: h√° pend√™ncias (tabela com dados) ‚Üí pergunta se quer enviar por e-mail
                        estadoPendencias = "aguardando_confirmacao_email";

                        renderBotMessage(
                            `HTML:<p class="text-sm text-slate-700 mt-2">
                    Quer que eu envie esse resumo por e-mail tamb√©m? (responda <b>"sim"</b> ou <b>"n√£o"</b>).
                    </p>`
                        );
                    })
                    .withFailureHandler(err => {
                        estadoPendencias = "nenhum";
                        renderBotMessage(
                            `HTML:<p class="text-sm text-slate-700">
            Tive um problema ao buscar as pend√™ncias da loja <b>${loja}</b>. Tente novamente em instantes.
            </p>`
                        );
                    })
                    .getPendenciasParaBloqueio(loja);
            }



    function chamarEnvioPendenciasPorEmail(loja, email) {
        google.script.run
            .withSuccessHandler(function(res) {
                if (res && res.ok) {
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Enviei o resumo das pend√™ncias da loja <b>${res.loja || loja}</b> para o e-mail <b>${email}</b> (data de cobran√ßa: <b>${res.data || (ultimaPendenciaResumo && ultimaPendenciaResumo.data) || ""}</b>). N√£o se esque√ßa de regularizar as justificativas na plataforma da Clara e posteriormente encaminhar chamado para que o cart√£o seja desbloqueado (caso esteja bloqueado).</p>`
                    );
                } else {
                    const erro = (res && res.error) ? res.error : "erro desconhecido";
                    renderBotMessage(
                        `HTML:<p class="text-sm text-slate-700">
          Tentei enviar o e-mail de pend√™ncias, mas deu problema: ${erro}.</p>`
                    );
                }
            })
            .withFailureHandler(function(err) {
                console.error("Erro enviarPendenciasPorEmail:", err);
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail de pend√™ncias. Tente novamente mais tarde.</p>'
                );
            })
            .enviarPendenciasPorEmail(loja, email);
    }

    /* ========= MOTOR DA POL√çTICA ========= */

    function gerarRespostaPolitica(msgUsuario) {
        const norm = normalize(msgUsuario);
        const intencao = detectarIntencaoPergunta(norm);

        // gasto pessoal alimenta√ß√£o
        const padroesGastoPessoalAlimentacao = [
            "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
            "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
            "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
            "paguei minha comida","paguei minha janta",
            "meu almo√ßo","meu almoco","meu jantar","minha janta",
            "meu lanche","meu lanche com o cartao","meu lanche com o cart√£o",
            "minha comida","almoco pessoal","almo√ßo pessoal",
            "jantar pessoal","lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",
            "almocei com o cartao","almocei com o cart√£o",
            "jantei com o cartao","jantei com o cart√£o",
            "comi com o cartao","comi com o cart√£o"
        ].map(normalize);

        const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));
        if (isGastoPessoalAlimentacao) {
            ultimaIntencao = "gasto_pessoal_alimentacao";
            return `HTML:<div class="text-sm text-slate-700">
<p>‚õî Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.</p>
<p class="mt-2">Se j√° foi pago com o cart√£o:</p>
<ul class="list-disc ml-4">
<li>Avise o Financeiro e abra chamado no ServiceNow (Contas a Receber &gt; Cart√£o Clara &gt; Gasto Indevido - pessoal);</li>
<li>Classifique na Clara como "Despesa Pessoal ‚Äì Uso Indevido";</li>
<li>Ressar√ßa o valor √† empresa em at√© 2 dias √∫teis.</li>
</ul>
<p class="mt-2">Se n√£o regularizar, o cart√£o pode ficar bloqueado preventivamente.</p>
</div>`;
        }

        let resposta;

        switch (intencao) {
            case "foraEscopo":
                ultimaIntencao = "foraEscopo";
                resposta = respostaForaEscopo();
                break;

            case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
                resposta = `HTML:<div class="text-sm text-slate-700">
            <p>O <b>cart√£o Clara</b> √© o meio oficial de pagamento das despesas operacionais das lojas.</p>
            <p class="mt-1">Com ele, voc√™ pode pagar itens de uso di√°rio como materiais de limpeza, escrit√≥rio, inform√°tica, √°gua e lanches para a√ß√µes internas autorizadas.</p>
            <p class="mt-1">Todas as compras devem ser justificadas na plataforma Clara em at√© 48 horas, com etiqueta, nota e descri√ß√£o correta.</p>
            <p class="mt-1">Quer ver a <b>Pol√≠tica completa de uso</b>?<a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer"> Clique aqui.
            </a></p>
            </div>`;
                break;


            case "etiqueta": {
                ultimaIntencao = "etiqueta";
                const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));
                const et = acharEtiquetaPorMensagem(norm);

                if (!et && isPerguntaGeral) {
                    resposta = respCatalogoEtiquetas();
                } else if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
              N√£o consegui identificar uma etiqueta espec√≠fica s√≥ com esse texto.<br/>
              Se o gasto for operacional e n√£o existir etiqueta adequada na lista da Clara, abra chamado no
              <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
              <strong>ServiceNow</strong>
              </a>
              solicitando cria√ß√£o ou ajuste de etiqueta.
              </p>`;
                }
                break;
            }

            case "sobreBot":
            resposta = `HTML:<div class="text-sm text-slate-700">
          <p>Sou o <b>Vektor</b> ü§ñ ‚Äî Agente do <b>Grupo SBF</b> especializado no <b>cart√£o Clara</b>.

          <p class="mt-2">Posso te ajudar com v√°rias coisas, por exemplo:</p>
          <ul class="list-disc ml-5 mt-1">
          <li>Explicar a <b>Pol√≠tica de Uso dos Cart√µes Clara</b>;</li>
          <li>Orientar sobre <b>o que pode e o que n√£o pode ser comprado</b>;</li>
          <li>Indicar a <b>etiqueta correta</b> pra cada tipo de gasto (ex.: √°gua, lanche, inform√°tica, manuten√ß√£o...);</li>
          <li>Guiar sobre <b>bloqueio e desbloqueio</b> do cart√£o;</li>
          <li>Consultar <b>pend√™ncias da loja</b> e at√© <b>enviar o resumo por e-mail</b>;</li>
          <li>Mostrar <b>como solicitar novo cart√£o</b> (primeira ou segunda via);</li>
          <li>Explicar sobre o <b>Termo de Responsabilidade</b> e onde preencher;</li>
          <li>Responder d√∫vidas sobre <b>sangria, limite, reembolsos e presta√ß√£o de contas</b>;</li>
          <li>E, claro, te direcionar para os canais certos como <b>Financeiro</b> ou <b>ServiceNow</b> quando for preciso.

          <p class="mt-3">Basta me perguntar de forma natural, tipo:</p>
          <p>‚Ä¢ ‚ÄúQual etiqueta usar para lanche de treinamento?‚Äù<br/>
          ‚Ä¢ ‚ÄúPosso comprar mouse no cart√£o Clara?‚Äù<br/>
          ‚Ä¢ ‚ÄúQuais pend√™ncias tem na loja 1234?‚Äù</p>

          <p class="mt-3 italic text-slate-500">Estou aqui pra facilitar o dia a dia das lojas no uso do cart√£o Clara. üíú</p>
          </div>`;
            break;

            case "limite":
                ultimaIntencao = "limite";
                resposta = respLimite();
                break;

                    case "cartaoGeral":
            ultimaIntencao = "cartaoGeral";
            resposta = respCartaoGeral();
            break;


            case "bloqueio": {
                  ultimaIntencao = "bloqueio";

                  // 1) Envia a mensagem principal de bloqueio (j√° aparece com os 3 pontinhos)
                  renderBotMessage(respBloqueio());

                  // 2) Prepara o estado para o fluxo de pend√™ncias ligadas a bloqueio
                  origemPendenciasBloqueio = true;
                  estadoPendencias = "aguardando_loja";
                  lojaPendenciasAtual = "";
                  ultimaPendenciaResumo = null;

                  // 3) Agenda a PR√ìXIMA mensagem, com delay, tamb√©m usando renderBotMessage
                  //    ‚Üí assim aparece de novo o "digitando..." antes dela
                  setTimeout(() => {
                      renderBotMessage(`HTML:<p class="text-sm text-slate-700">
              Caso realmente seu cart√£o esteja bloqueado, devido a situa√ß√µes ligadas a pend√™ncias de justificativas de transa√ß√µes na Clara, posso te mostrar as pend√™ncias mais recentes do cart√£o da sua loja, da√≠ voc√™ j√° corre l√° no app da Clara pra regularizar üòâ .<br/><br/>
              üó£Ô∏è Me informa o n√∫mero da loja, por favor.
              </p>`);
                  }, 1000); // 1000 ms = 1 segundo depois da primeira mensagem

                  // 4) N√£o devolve texto pro fluxo principal, porque a segunda mensagem
                  //    j√° vai ser enviada pelo setTimeout
                  return null;
              }

            case "prestacao":
                ultimaIntencao = "prestacao";
                resposta = respPrestacaoContas();
                break;

            case "alimentoTime":
                ultimaIntencao = "alimentoTime";
                resposta = respAlimentoTime();
                break;

            case "transportePessoal":
                ultimaIntencao = "transportePessoal";
                resposta = respTransportePessoal();
                break;

            case "trocaGerente":
                ultimaIntencao = "trocaGerente";
                resposta = respTrocaGerente();
                break;

            case "sangria":
                ultimaIntencao = "sangria";
                resposta = respSangria();
                break;

            case "fraudeContestacao":
                ultimaIntencao = "fraudeContestacao";
                resposta = respFraudeContestacao();
                break;

            case "podeNaoPode":
            case "generica":
            default:
                ultimaIntencao = "generica";
                resposta = respGenerica(norm);
                break;
        }

        return resposta;
    }

    /* ========= GERADOR FINAL ========= */

    function gerarRespostaDoBot(msgUsuario) {
        const norm = normalize(msgUsuario);

        // 1) Termo de responsabilidade
        if (frasesTermo.some(f => norm.includes(f))) {
            return respTermoResponsabilidade();
        }

        // 2) Sauda√ß√µes
        for (const saud of saudacoes) {
            if (norm === saud || norm.startsWith(saud + " ") || norm.includes(" " + saud + " ")) {
                const respostasSaudacao = [
                    "Ol√°! üòÑ",
                    "Oi! üëã",
                    "Opa, tudo bem por a√≠? üòé",
                    "Fala a√≠! üëã",
                    "E a√≠, tudo certo? üôå",
                    "Bom te ver por aqui! üòÅ"
                ];
                const complementosAjuda = [
                    "Como posso te ajudar hoje?",
                    "Quer saber algo sobre o cart√£o Clara?",
                    "O que voc√™ quer saber?",
                    "Posso te explicar algo sobre o uso dos cart√µes?",
                    "Quer que eu te ajude com alguma d√∫vida?",
                    "Como posso te orientar?",
                    "Qual a sua d√∫vida?"
                ];
                const r1 = respostasSaudacao[Math.floor(Math.random() * respostasSaudacao.length)];
                const r2 = complementosAjuda[Math.floor(Math.random() * complementosAjuda.length)];
                return `HTML:<p class="text-sm text-slate-700">${r1} ${r2}</p>`;
            }
        }

        // 3) Encerramento / agradecimento
        for (const frase of frasesEncerramento) {
            if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
                const respostasEncerramento = [
                    "Que bom que consegui ajudar! ü§ó Pode me chamar sempre que precisar.",
                    "Show! Fico feliz em ajudar üòÑ",
                    "Perfeito üëå qualquer d√∫vida, √© s√≥ chamar de novo!",
                    "Valeu! At√© a pr√≥xima üöÄ",
                    "Beleza üòé t√¥ por aqui se precisar de novo.",
                    "Feito! Agora vou tirar um cochilo de 5 segundos. Me chama de novo, t√°?", 
                    "Resolvido! Fui nessa, mas t√¥ s√≥ a um clique de dist√¢ncia, viu?", 
                    "Show de bola! Se quebrar o meu sistema, n√£o fui eu, foi a formata√ß√£o anterior! üòâ", 
                    "Acabou o recreio! Brincadeiras √† parte, qualquer coisa, √© s√≥ dar um 'tapa' no chat.", 
                    "Tudo pronto. Vou ali beber uma √°gua e j√° volto. Se precisar, s√≥ assobiar!", 
                    "√â isso! Miss√£o dada √© (finalmente) miss√£o cumprida. Fui! üëã", 
                    "Perfeito! Agora vai l√° dominar o mundo (ou s√≥ terminar seu caf√© mesmo).", 
                    "Ufa! Deu tudo certo. Deixa um biscoito pra mim na pr√≥xima vez, valeu?", 
                    "Despedida de campe√£o! Se a d√∫vida voltar, √© porque sentiu minha falta. Pode chamar!", 
                    "Zerou! At√© o pr√≥ximo 'bug' ou a pr√≥xima ideia genial. üöÄ", 
                    "A gente se fala! N√£o faz besteira enquanto eu estiver fora, hein?", 
                    "OK, estou me desligando (s√≥ um pouquinho). Te vejo na pr√≥xima aventura!", 
                    "Quebrando a internet em 3, 2, 1... Brincadeira! Tchau, tchau!", 
                    "Terminamos com chave de ouro e um 'high five' virtual! ‚úã", 
                    "Resolvi essa parada! Agora, vai curtir a vida. Me chama se tiver t√©dio.", 
                    "Fechou o caix√£o! Quer dizer... fechou o chat. üòâ At√© a pr√≥xima!", 
                    "T√° tranquilo, t√° favor√°vel. Qualquer deslize tecnol√≥gico, me avisa!", 
                    "Deu bom! Vou mandar um emoji de comemora√ß√£o aqui: üéâ. Fui!", 
                    "Desaparecendo em 5 segundos. Se precisar de m√°gica, j√° sabe quem chamar.", 
                    "Essa foi r√°pida, hein? Valeu pela companhia. Tamo junto!", 
                    "Encerrando as atividades por hoje. Beijos de luz (e de c√≥digo)! ‚ú®", 
                    "Olha eu indo! Se sobrar um tempinho, manda um meme pra mim. Fui!", 
                    "Sou seu, mas n√£o sou seu (s√≥ at√© voc√™ precisar de mim de novo). Tchau!", 
                    "Gostei da conversa. Se tiver mais perguntas loucas, sou todo ouvidos!", 
                    "Miss√£o conclu√≠da. Agora, a pr√≥xima rodada √© por sua conta! (Brincadeira!).", 
                    "Finalizamos! Mando um abra√ßo de bytes e um at√© breve.", 
                    "Tudo nos conformes. Pode sair correndo e contar a novidade! üòâ", 
                    "Pronto para a aposentadoria (de 5 minutos). Bora na pr√≥xima!", 
                    "E o Oscar de melhor encerramento vai para... mim! Tchau! üòÇ"
                ];
                const r = respostasEncerramento[Math.floor(Math.random() * respostasEncerramento.length)];
                return `HTML:<p class="text-sm text-slate-700">${r}</p>`;
            }
        }

        // 4) Pol√≠tica (PDF oficial)
        if (frasesPolitica.some(f => norm.includes(f))) {
            return respPoliticaOficial();
        }

              // 5) Fluxo pend√™ncias - aguardando c√≥digo da loja
if (estadoPendencias === "aguardando_loja") {
    const textoOriginal = msgUsuario.trim();
    const soDigitos = textoOriginal.replace(/\D/g, "");

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    if (mudouDeAssunto && !soDigitos) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        origemPendenciasBloqueio = false;
        return `HTML:<div class="text-sm text-slate-700">
        <p>Beleza üëç Vamos mudar de assunto ent√£o.</p>
        <p class="mt-1">Se quiser ver as pend√™ncias da loja depois, √© s√≥ dizer: <b>"consultar pend√™ncias Clara"</b>.</p>
        </div>`;
    }

    if (soDigitos && soDigitos.length >= 2 && soDigitos.length <= 4) {
        lojaPendenciasAtual = soDigitos;

        // üîπ CASO ESPECIAL: fluxo veio do bloqueio de cart√£o
        if (origemPendenciasBloqueio) {
            origemPendenciasBloqueio = false; // consumiu a flag

            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Beleza! Vou consultar as √∫ltimas pend√™ncias relacionadas ao cart√£o da loja <b>${soDigitos}</b>, que podem ter ocasionado o bloqueio. ‚è≥
</p>`
            );

            // aqui a gente N√ÉO coloca estadoPendencias = "nenhum"
            // porque a fun√ß√£o consultarPendenciasBloqueio √© que vai
            // colocar estadoPendencias = "aguardando_confirmacao_email"
            consultarPendenciasBloqueio(soDigitos);
            return null;
        }

        // üîπ CASO NORMAL: fluxo padr√£o de pend√™ncias Clara
        estadoPendencias = "nenhum";

        renderBotMessage(
            `HTML:<p class="text-sm text-slate-700">
        Beleza! Vou consultar as pend√™ncias Clara da loja <b>${soDigitos}</b> e j√° te mostro aqui no chat. ‚è≥
        </p>`
        );
        consultarPendenciasNoServidor(soDigitos);
        return null;
    }

    return `HTML:<p class="text-sm text-slate-700">
        Pra eu consultar as pend√™ncias, preciso do c√≥digo num√©rico da loja (ex.: <b>0999</b>).<br/>
        Se quiser tratar de outro assunto, √© s√≥ me perguntar diretamente. üòâ
        </p>`;
}

        // 6) Fluxo pend√™ncias - aguardando confirma√ß√£o de envio por e-mail
if (estadoPendencias === "aguardando_confirmacao_email") {
    const ehSim = (
        norm === "sim" ||
        norm.startsWith("sim ") ||
        norm.includes(" sim") ||
        norm.includes("pode enviar") ||
        norm.includes("pode mandar") ||
        norm.includes("manda") ||
        norm.includes("envia") ||
        norm.includes("pode sim")
    );

    const ehNao = (
        norm === "nao" || norm === "n√£o" ||
        norm.startsWith("nao ") || norm.startsWith("n√£o ") ||
        norm.includes("nao precisa") || norm.includes("n√£o precisa") ||
        norm.includes("sem email") || norm.includes("sem e-mail") ||
        norm.includes("nao manda") || norm.includes("n√£o manda")
    );

    const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

    // Usu√°rio mudou de assunto no meio
    if (!ehSim && !ehNao && mudouDeAssunto) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<div class="text-sm text-slate-700">
<p>Tranquilo, vamos falar de outro assunto ent√£o. üòâ</p>
<p class="mt-1">Se depois voc√™ quiser receber o resumo por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
    }

    // Usu√°rio disse que N√ÉO quer e-mail
    if (ehNao) {
        estadoPendencias = "nenhum";
        lojaPendenciasAtual = "";
        return `HTML:<p class="text-sm text-slate-700">
Fechado, n√£o vou enviar por e-mail. Se quiser depois, √© s√≥ pedir de novo. üëç
</p>`;
    }

    // Usu√°rio disse que SIM quer e-mail
    if (ehSim) {
        const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
        const emailSessao = (USER_EMAIL_REPLACED || "").trim();

        if (!loja) {
            // Por seguran√ßa: se por algum motivo a loja sumiu da mem√≥ria
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";
            return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
        }

        // ‚úÖ Se temos e-mail do usu√°rio logado, j√° envia direto
        if (emailSessao) {
            estadoPendencias = "nenhum";
            lojaPendenciasAtual = "";

            // avisa no chat
            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${emailSessao}</b>.
</p>`
            );

            // chama o Apps Script pra mandar o e-mail
            chamarEnvioPendenciasPorEmail(loja, emailSessao);

            // j√° usamos renderBotMessage, ent√£o aqui n√£o precisa retornar outro texto
            return null;
        }

        // ‚ùå Se N√ÉO temos e-mail na sess√£o, volta para o fluxo antigo (pede e-mail)
        estadoPendencias = "aguardando_email";
        return `HTML:<p class="text-sm text-slate-700">
Perfeito! Me informa o seu e-mail corporativo (ex.: <b>nome.sobrenome@xxxxx.com.br</b>) para eu enviar o resumo.
</p>`;
    }

    // Se n√£o entendeu nem sim nem n√£o
    return `HTML:<p class="text-sm text-slate-700">
S√≥ pra eu entender: voc√™ quer que eu envie por e-mail tamb√©m?<br/>
Responda apenas <b>"sim"</b> ou <b>"n√£o"</b>. üôÇ
</p>`;
}

        // 7) Fluxo pend√™ncias - aguardando e-mail
        if (estadoPendencias === "aguardando_email") {
            const textoOriginal = msgUsuario.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailRegex.test(textoOriginal)) {
                const loja = lojaPendenciasAtual || (ultimaPendenciaResumo && ultimaPendenciaResumo.loja) || "";
                if (!loja) {
                    estadoPendencias = "nenhum";
                    lojaPendenciasAtual = "";
                    return `HTML:<p class="text-sm text-slate-700">
N√£o tenho mais a loja em mem√≥ria. Me pe√ßa de novo pra consultar as pend√™ncias, por favor.
</p>`;
                }

                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">
Perfeito! Vou enviar o resumo das pend√™ncias da loja <b>${loja}</b> para <b>${textoOriginal}</b>.
</p>`
                );
                chamarEnvioPendenciasPorEmail(loja, textoOriginal);
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return null;
            }

            const pareceOutroAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (pareceOutroAssunto) {
                estadoPendencias = "nenhum";
                lojaPendenciasAtual = "";
                return `HTML:<div class="text-sm text-slate-700">
<p>Beleza, vamos mudar de assunto ent√£o üòâ</p>
<p class="mt-1">Se depois voc√™ quiser voltar a ver as pend√™ncias da loja ou receber por e-mail, √© s√≥ me pedir de novo.</p>
</div>`;
            }

            return `HTML:<p class="text-sm text-slate-700">
Esse e-mail parece inv√°lido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.<br/><br/>
Se preferir mudar de assunto, pode me perguntar outra coisa diretamente (ex.: "sangria", "novo cart√£o", "limite", "etiqueta", etc.).
</p>`;
        }

        // 8) Fluxo novo cart√£o ‚Äì aguardando se √© 1¬™ ou 2¬™ via
        if (fluxoNovoCartao === "aguardando_tipo_via") {
            const ehPrimeira = (
                norm.includes("primeira via") ||
                norm.includes("1 via") ||
                norm.includes("1a via") ||
                norm.includes("1¬™ via") ||
                norm.includes("primeiro cartao") ||
                norm.includes("primeiro cart√£o") ||
                norm.includes("cartao novo") ||
                norm.includes("cart√£o novo") ||
                norm.includes("meu primeiro cartao") ||
                norm.includes("meu primeiro cart√£o") ||
                norm.includes("nunca tive cartao") ||
                norm.includes("nunca tive cart√£o") ||
                norm.includes("nao tenho cartao") ||
                norm.includes("n√£o tenho cart√£o")
            );

            const ehSegunda = (
                norm.includes("segunda via") ||
                norm.includes("2 via") ||
                norm.includes("2a via") ||
                norm.includes("2¬™ via") ||
                norm.includes("segundo cartao") ||
                norm.includes("segundo cart√£o") ||
                norm.includes("perdi o cartao") ||
                norm.includes("perdi meu cartao") ||
                norm.includes("perdi o cart√£o") ||
                norm.includes("roubaram meu cartao") ||
                norm.includes("roubaram meu cart√£o") ||
                norm.includes("roubo de cart√£o") ||
                norm.includes("perda de cart√£o") ||
                norm.includes("perca de cart√£o") ||
                norm.includes("cartao quebrado") ||
                norm.includes("cart√£o quebrado") ||
                norm.includes("cartao danificado") ||
                norm.includes("cart√£o danificado")
            );

            const mudouDeAssunto = palavrasMudancaAssunto.some(p => norm.includes(p));

            if (!ehPrimeira && !ehSegunda && mudouDeAssunto) {
                fluxoNovoCartao = null;
                return `HTML:<p class="text-sm text-slate-700">
Sem problemas, vamos falar de outro assunto ent√£o. üòâ
</p>`;
            }

            if (ehPrimeira) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_primeira";
                return respNovoCartaoPrimeiraVia();
            }

            if (ehSegunda) {
                fluxoNovoCartao = null;
                ultimaIntencao = "novoCartao_segunda";
                return respNovoCartaoSegundaVia();
            }

            return `HTML:<p class="text-sm text-slate-700">
            N√£o entendi se voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido).<br/><br/>
            Me responde assim, por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }

        // 9) Gatilho pend√™ncias (quando n√£o h√° fluxo pend√™ncias em aberto)
            if (estadoPendencias === "nenhum" &&
                termosPendencias.some(t => norm.includes(t))) {

          // tenta extrair n√∫mero de loja j√° presente na mensagem (2 a 6 d√≠gitos)
          const matchLoja = msgUsuario.match(/\b(\d{2,6})\b/);

          if (matchLoja) {
              const lojaBruta = matchLoja[1];
              const lojaNormalizada = lojaBruta.replace(/\D/g, "");

        lojaPendenciasAtual = lojaNormalizada;
        ultimaPendenciaResumo = null;
        estadoPendencias = "aguardando_confirmacao_email";

        renderBotMessage(
            `HTML:<p class="text-sm text-slate-700">
          Beleza! Vou consultar as pend√™ncias Clara da loja <b>${lojaNormalizada}</b> e j√° te mostro aqui no chat. ‚è≥
          </p>`
                  );

                  consultarPendenciasNoServidor(lojaNormalizada);
                  return null; // n√£o retorna outro texto (renderBotMessage j√° enviou)
              }

              // caso n√£o tenha n√∫mero na frase, segue fluxo normal
              estadoPendencias = "aguardando_loja";
              lojaPendenciasAtual = "";
              ultimaPendenciaResumo = null;

              return `HTML:<p class="text-sm text-slate-700">
              Consigo consultar as pend√™ncias Clara da sua loja.<br/>
              Me informe o c√≥digo da loja (somente n√∫meros), por exemplo: <b>0123</b>.
              </p>`;
          }

        // 10) Gatilhos direto ‚Äì primeira via
        if (termosPrimeiraViaDireta.some(t => norm.includes(t))) {
            fluxoNovoCartao = null;
            return respNovoCartaoPrimeiraVia();
        }

        // 11) Gatilhos direto ‚Äì segunda via
        if (gatilhosSegundaViaDireta.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = null;
            return respNovoCartaoSegundaVia();
        }

        // 12) Gatilho ‚Äì quero pedir um cart√£o (abre fluxo pra perguntar primeira/segunda via)
        if (gatilhosNovoCartao.some(fr => norm.includes(fr))) {
            fluxoNovoCartao = "aguardando_tipo_via";
            return `HTML:<p class="text-sm text-slate-700">
            S√≥ pra eu te orientar certinho: voc√™ est√° falando de <b>primeira via</b> (nunca teve cart√£o Clara) ou <b>segunda via</b> (cart√£o que j√° existia e precisa ser reemitido)?<br/><br/>
            Responda por favor:<br/>
            ‚Ä¢ "√â primeira via"<br/>
            ‚Ä¢ ou "√â segunda via".
            </p>`;
        }

        // 13) Demais casos -> motor da pol√≠tica
        return gerarRespostaPolitica(msgUsuario);
    }

    /* ========= ENVIO (ENTER / BOT√ÉO) ========= */

    function enviarMensagem() {

      // üëá pede permiss√£o de notifica√ß√£o logo na primeira intera√ß√£o
        solicitarPermissaoNotificacao();
        const texto = userInput.value.trim();
        if (!texto) return;

        renderUserMessage(texto);

        const resposta = gerarRespostaDoBot(texto);
        if (resposta) renderBotMessage(resposta);

        userInput.value = "";
        userInput.focus();
        scrollToBottom();
    }

    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            enviarMensagem();
        }
    });

    sendBtn.addEventListener("click", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

    chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        enviarMensagem();
    });

}); // fim DOMContentLoaded
</script>
</body>
</html>
