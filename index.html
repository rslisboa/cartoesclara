<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistente Clara | Uso do Cart√£o na Loja</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet"
    />

    <style>
        :root {
            --brand-main: #005E27; /* verde escuro */
        }

        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: #f8fafc;
        }

        /* bolhas */
        .user-bubble {
            background-color: var(--brand-main);
            color: #fff;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.25);
        }
        .bot-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1); /* slate-200 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
        }

        /* avatar Clara */
        .bot-avatar {
            background-color: var(--brand-main);
            color: #fff;
        }

        /* bot√£o enviar */
        .send-button {
            background-color: var(--brand-main);
        }
        .send-button:hover {
            filter: brightness(1.1);
        }

        /* focus do input */
        .user-input:focus {
            --tw-ring-color: var(--brand-main);
            --tw-ring-offset-shadow: 0 0 #0000;
            --tw-ring-shadow: 0 0 #0000;
            outline: 2px solid var(--brand-main);
            border-color: var(--brand-main);
        }

        /* "digitando..." */
        .typing-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
            font-size: 13px;
            color: #475569;
        }
        .dot {
            width: 6px;
            height: 6px;
            background-color: #475569;
            border-radius: 9999px;
            display: inline-block;
            animation: bounce 1.2s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.15s; }
        .dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-4px); opacity: 1; }
        }

        /* scrollbar da janela de chat */
        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }
        #chatWindow::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 9999px;
        }
        #chatWindow::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 9999px;
        }

        /* links clic√°veis nas respostas */
        .bot-link {
            color: var(--brand-main);
            font-weight: 600;
            text-decoration: underline;
            word-break: break-all;
        }
    </style>
</head>
<body class="text-slate-800 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col max-h-[90vh]">
        <!-- Header (centrado agora) -->
        <header class="px-5 py-6 border-b border-slate-200 text-center">
            <div class="flex flex-col items-center gap-3">
                <div class="w-12 h-12 rounded-xl bot-avatar flex items-center justify-center font-bold text-lg shadow-md">
                    C
                </div>
                <div class="leading-tight">
                    <p class="font-semibold text-slate-800 text-base md:text-lg">
                        Assistente Clara | Grupo SBF
                    </p>
                    <p class="text-[13px] text-slate-600 mt-2">
                        Pergunte sobre o uso do cart√£o Clara nas lojas.
                    </p>
                    <p class="text-[12px] text-slate-500 mt-1">
                        Ex: "Posso comprar micro-ondas?" ‚Ä¢ "Uber pode?" ‚Ä¢ "Travou o cart√£o, fa√ßo o qu√™?"
                    </p>
                    <p class="text-[11px] text-slate-400 italic mt-3">
                        Minhas respostas seguem a Pol√≠tica de Uso dos Cart√µes Clara.
                        Em conflito, vale sempre o documento oficial da empresa.
                    </p>
                </div>
            </div>
        </header>

        <!-- Chat window -->
        <section id="chatWindow" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 text-[15px] leading-relaxed bg-slate-50/40">

            <!-- Mensagem inicial da Clara -->
            <div class="flex items-start gap-3">
                <div class="w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0">
                    C
                </div>
                <div class="bot-bubble px-4 py-3 max-w-[80%]">
                    <p class="font-semibold text-slate-800">
                        Ol√°! üëã Eu sou a Clara.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Me pergunta coisas tipo:
                        <br>‚Ä¢ "Posso pagar Uber?"
                        <br>‚Ä¢ "Como justificar a compra?"
                        <br>‚Ä¢ "Meu cart√£o bloqueou, e agora?"
                        <br>‚Ä¢ "Qual etiqueta usar pra √°gua?"
                        <br>‚Ä¢ "Me manda a pol√≠tica em PDF."
                    </p>
                    <p class="text-[11px] text-slate-400 italic mt-3">
                        Se eu pedir ServiceNow, √© porque precisa abrir chamado formal pra Financeiro / Contas a Receber.
                    </p>
                </div>
            </div>
        </section>

        <!-- √Årea de input -->
        <section class="border-t border-slate-200 bg-white rounded-b-2xl px-4 py-4 flex flex-col gap-3">
            <form id="chatForm" class="flex w-full gap-3">
                <input
                    id="userInput"
                    type="text"
                    class="user-input flex-1 text-[15px] border border-slate-300 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-[var(--brand-main)] focus:border-[var(--brand-main)]"
                    placeholder="Escreve sua d√∫vida (ex: Qual etiqueta pra √°gua?)"
                    autocomplete="off"
                />
                <button
                    class="send-button text-white font-semibold text-sm rounded-xl px-4 py-3 shadow-md transition"
                    type="submit"
                >
                    Enviar
                </button>
            </form>

            <div class="text-[11px] text-slate-500 text-center leading-snug">
                Uso pessoal = proibido. Se acontecer, informe o Financeiro, marque como ‚ÄúDespesa Pessoal ‚Äì Uso Indevido‚Äù e ressar√ßa em at√© 2 dias √∫teis.
            </div>
        </section>
    </main>

    <script>
        //
        // CONFIG FIXA
        //
        const SERVICE_NOW_URL = "https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6"; 
        const POLITICA_PDF_URL = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";

        // Guardar contexto da √∫ltima inten√ß√£o respondida
        let ultimaIntencaoRespondida = null;


        //
        // MAPA DE ETIQUETAS (simplificado baseado no Anexo I)
        // chave -> { etiqueta, exemploDescricao }
        //
        const mapaEtiquetas = [
            {
                termos: ["agua","√°gua","gal√£o","galao","garrafa de agua","garrafa de √°gua","agua potavel","√°gua pot√°vel","beber √°gua","hidratacao"],
                etiqueta: "√ÅGUA POT√ÅVEL",
                exemploDescricao: "Compra de gal√µes de √°gua mineral / abastecimento loja"
            },
            {
                termos: ["lanche","cafe","caf√©","coffee break","salgado","refrigerante","treinamento","visita","vm","diretoria","regional","lanchinho","alimento equipe"],
                etiqueta: "LANCHES DE REFEI√á√ïES",
                exemploDescricao: "Coffee break para treinamento interno / a√ß√£o VM autorizada"
            },
            {
                termos: ["chaveiro","fechadura","abrir porta","abrir cofre","troca de fechadura","cofre"],
                etiqueta: "CHAVEIRO EMERGENCIAL",
                exemploDescricao: "Servi√ßo emergencial de chaveiro para estoque/cofre/vitrine"
            },
            {
                termos: ["motoboy","frete","entrega urgente","courier","transportar pe√ßa","levar pe√ßa","pegar pe√ßa","buscar pe√ßa","envio urgente","sedex","correios","postagem"],
                etiqueta: "TRANSPORTE / SERVI√áO EMERGENCIAL",
                exemploDescricao: "Motoboy/frete emergencial entre lojas / envio urgente de documento"
            },
            {
                termos: ["material de limpeza","detergente","desinfetante","papel toalha","limpeza loja","higiene"],
                etiqueta: "MATERIAL DE LIMPEZA",
                exemploDescricao: "Materiais de higiene e limpeza da loja"
            },
            {
                termos: ["tomada","troca de tomada","interruptor","disjuntor","extensao","ar condicionado","ar-condicionado","manuten√ß√£o ar","manutencao ar","reparo ar"],
                etiqueta: "MANUTEN√á√ÉO (EL√âTRICA / AR)",
                exemploDescricao: "Pequeno reparo el√©trico / ajuste simples de ar condicionado"
            },
            {
                termos: ["impressao","banner","adesivo","flyer","grafica","servi√ßo gr√°fico","grafico","plotagem","adesivagem"],
                etiqueta: "SERVI√áOS GR√ÅFICOS / DIVULGA√á√ÉO",
                exemploDescricao: "Impress√£o de banner/adesivo promocional autorizado"
            }
        ];

        function descobrirEtiqueta(msgNorm) {
            for (const item of mapaEtiquetas) {
                const bateu = item.termos.some(t => msgNorm.includes(normalize(t)));
                if (bateu) return item;
            }
            return null;
        }


        //
        // INTEN√á√ïES / PALAVRAS-CHAVE
        //
        const categorias = {
            eletronicos: [
                "ps5","playstation","play station","xbox",
                "tv","televisao","televis√£o","monitor","som","r√°dio","radio",
                "caixa de som","soundbar","notebook","laptop","tablet","fone","headset"
            ],
            eletrodomesticos: [
                "micro-ondas","microondas","micro ondas",
                "geladeira","frigobar","cafeteira","cafeteria","cafeteirinha",
                "bebedouro","airfryer","aspirador"
            ],
            alimentosEquipe: [
                "lanche","cafe","caf√©","refei√ß√£o","refeicao","almo√ßo","almoco","pizza","refrigerante",
                "√°gua","agua","gal√£o","galao","garrafa de agua","garrafa de √°gua",
                "coffee break","lanche do time","lanche da equipe",
                "time vm","vm","treinamento","treinamento interno","visita diretor","visita regional"
            ],
            transporte: [
                "uber","99","app de transporte","corrida","taxi","t√°xi","taxi99","taxi 99",
                "viagem","passagem","passagens"
            ],
            manutencaoLoja: [
                "chaveiro","fechadura","troca de tomada","tomada","manuten√ß√£o ar",
                "manutencao ar","ar condicionado","ar-condicionado","conserto geladeira da loja",
                "arrumar porta","arrumar vitrine","motoboy","frete","frete urgente","entrega urgente","courier"
            ],
            bloqueio: [
                "bloqueou","bloqueio","bloqueada","cart√£o bloqueado","cartao bloqueado",
                "desbloquear","desbloqueia","desbloqueio","como desbloquear",
                "travou","cart√£o travou","cartao travou","preventivo","meu cart√£o travou","meu cartao travou"
            ],
            prazo: [
                "48h","48 horas","prazo","quanto tempo","deadline",
                "quando preciso lan√ßar","ate quando lan√ßo","at√© quando lan√ßo"
            ],
            justificar: [
                "como justificar","justificar compra","justificar transa√ß√£o","justificar a transa√ß√£o",
                "prestar conta","presta√ß√£o de contas","prestacao de contas",
                "o que eu coloco na descri√ß√£o","o que tenho que anexar","o que precisa lan√ßar na clara",
                "o que tenho que lan√ßar","como lan√ßo","como lan√ßar","como justifico"
            ],
            emergencial: [
                "emerg√™ncia","emergencia","urgente","sangria",
                "tirar dinheiro do caixa","pegar dinheiro do caixa","sem limite","acabou limite","limite acabou","estourou limite"
            ],
            pessoal: [
                "usei pra mim","pra mim","comprei pra mim",
                "gasto pessoal","despesa pessoal","roupa pro meu filho","comprei um body pro meu filho","pessoal"
            ],
            outraLoja: [
                "cart√£o de outra loja","cartao de outra loja","emprestado",
                "usar cart√£o da outra loja","usar cartao da outra loja",
                "gerente desligado","sem gerente","sem cart√£o","sem cartao",
                "mudan√ßa de gerente","mudanca de gerente","troca de gerente"
            ],
            notaFiscal: [
                "guardar nota","nota fisica","nota fiscal fisica","nota fiscal f√≠sica",
                "comprovante fisico","comprovante f√≠sico","auditoria","180 dias","guardar comprovante"
            ],
            servicenow: [
                "servicenow","service now","abre chamado","abrir chamado","abrir um chamado",
                "chamado de aumento de limite","chamado de limite","chamado desbloqueio",
                "desbloqueio no servicenow","categoria nova","nova etiqueta","nova categoria",
                "troca de gerente","mudan√ßa de gerente","mudanca de gerente","transferir gerente",
                "cart√£o bloqueado preciso abrir chamado","cartao bloqueado preciso abrir chamado",
                "o que posso abrir no servicenow","quais chamados posso abrir"
            ],
            politicaPdf: [
                "me manda a pol√≠tica","me manda a politica","manda a pol√≠tica","manda a politica",
                "pdf da politica","pdf da pol√≠tica","politica clara","pol√≠tica clara",
                "documento oficial","politica completa","politica em pdf","politica de uso"
            ]
        };

        // inten√ß√£o espec√≠fica pra etiqueta
        const termosEtiquetaDireta = [
            "qual etiqueta","que etiqueta","etiqueta usar","etiqueta devo usar","etiqueta pra","etiqueta para",
            "qual conta","qual categoria","qual classifica√ß√£o","qual classificacao"
        ];


        //
        // RESPOSTAS PRINCIPAIS
        //
        function respostaEletronicos() {
            return (
`N√£o, esse tipo de compra n√£o pode ser feito com o cart√£o Clara. üò¨

Eletr√¥nicos (TV, notebook, som, etc.) s√£o bens patrimoniais / equipamento e precisam seguir fluxo de Compras, n√£o o cart√£o da loja.

Caminho certo:
‚Üí Solicitar via Compras / ServiceNow, n√£o passar direto no cart√£o Clara.`
            );
        }

        function respostaEletrodomesticos() {
            return (
`Micro-ondas, geladeira, frigobar, cafeteira, bebedouro... n√£o entram no cart√£o Clara.

S√£o itens de infraestrutura fixa da loja, ent√£o entram pelo fluxo de Compras, n√£o pelo cart√£o.

Se j√° passou no cart√£o:
1. avisa o Financeiro,
2. classifica na plataforma como "Despesa Pessoal ‚Äì Uso Indevido",
3. ressarce em at√© 2 dias √∫teis.`
            );
        }

        function respostaTransporte() {
            return (
`Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode no cart√£o Clara.

Isso n√£o √© despesa operacional direta da loja.

Se j√° pagou com o cart√£o:
‚Üí avisa Financeiro,
‚Üí marca a transa√ß√£o como "Despesa Pessoal ‚Äì Uso Indevido",
‚Üí devolve o valor em at√© 2 dias √∫teis.`
            );
        }

        function respostaTransporteFollowup() {
            return (
`Como ressarcir um Uber que voc√™ j√° passou no cart√£o:

1. Entra na plataforma Clara e edita aquela transa√ß√£o.
2. Na descri√ß√£o, deixa claro que foi uso pessoal.
3. Classifica como "Despesa Pessoal ‚Äì Uso Indevido".
4. Avisa o Financeiro.
5. Faz o reembolso do valor pra empresa (prazo m√°ximo: 2 dias √∫teis).

Se voc√™ N√ÉO ressarcir:
‚Üí a empresa pode descontar em folha (art. 462 CLT)
‚Üí e o cart√£o pode ser bloqueado pra voc√™.`
            );
        }

        function respostaAlimentosEquipe() {
            return (
`Depende üëá

‚úî Pode:
√Ågua / lanche / coffee break para treinamento interno autorizado, a√ß√£o oficial de VM, visita regional/diretoria ou evento operacional aprovado.

‚ùå N√£o pode:
Almo√ßo pessoal, lazer (pipoca no cinema, etc.).

Quando pode, voc√™ lan√ßa:
‚Ä¢ Nota fiscal anexada
‚Ä¢ Etiqueta correta (ex.: "√ÅGUA POT√ÅVEL" ou "LANCHES DE REFEI√á√ïES")
‚Ä¢ Descri√ß√£o clara: "Coffee break treinamento VM loja 1234".`
            );
        }

        function respostaAlimentosEquipeFollowupAgua(msgNorm) {
            const etiquetaInfo = descobrirEtiqueta(msgNorm);
            if (etiquetaInfo) {
                return (
`Para esse tipo de gasto use a etiqueta: "${etiquetaInfo.etiqueta}".

Descri√ß√£o recomendada:
"${etiquetaInfo.exemploDescricao}"

Obrigat√≥rio:
‚Ä¢ Anexar a nota fiscal/recibo
‚Ä¢ Lan√ßar em at√© 48h na plataforma Clara
‚Ä¢ Manter o comprovante f√≠sico guardado na loja por 180 dias`
                );
            }

            // fallback se n√£o achou etiqueta espec√≠fica
            return (
`√Ågua para consumo interno da equipe/loja normalmente entra como despesa operacional da loja.

Registre na Clara:
‚Ä¢ Etiqueta relacionada a √°gua pot√°vel / consumo interno
‚Ä¢ Anexe a nota fiscal
‚Ä¢ Descreva algo como "Gal√£o de √°gua para abastecimento loja XXXX"`

            );
        }

        function respostaManutencao() {
            return (
`Esse tipo de gasto normalmente PODE ir no cart√£o Clara porque √© custo operacional direto da loja. üí°

Exemplos aceitos:
‚Ä¢ chaveiro emergencial (abrir/trocar fechadura de estoque/cofre/vitrine),
‚Ä¢ troca de tomada simples,
‚Ä¢ ajuste leve de ar-condicionado,
‚Ä¢ motoboy / frete urgente entre lojas.

Mas SEMPRE:
- Anexa a nota fiscal,
- Usa a etiqueta certa (ex.: "CHAVEIRO EMERGENCIAL", "MANUTEN√á√ÉO (EL√âTRICA / AR)", "TRANSPORTE / SERVI√áO EMERGENCIAL"),
- Descreve claramente: "Chaveiro emergencial - troca fechadura estoque loja 1234".`
            );
        }

        function respostaManutencaoFollowup(msgNorm) {
            const etiquetaInfo = descobrirEtiqueta(msgNorm);
            if (etiquetaInfo) {
                return (
`Usa a etiqueta: "${etiquetaInfo.etiqueta}"

Descri√ß√£o:
"${etiquetaInfo.exemploDescricao}"

Passos obrigat√≥rios:
1. Anexar nota fiscal / recibo
2. Lan√ßar em at√© 48h
3. Descrever o que aconteceu e onde ("troca de fechadura estoque loja 1234")`
                );
            }

            return (
`Para manuten√ß√£o emergencial de loja:
1. Anexa a nota fiscal
2. Usa etiqueta de manuten√ß√£o / servi√ßo emergencial
3. Explica na descri√ß√£o o que foi feito e em qual √°rea da loja

Se for algo grande (equipamento patrimonial), n√£o usa o cart√£o: aciona Compras.`
            );
        }

        function respostaBloqueio() {
            return (
`Isso √© bloqueio preventivo. üîí

O cart√£o pode travar se a compra N√ÉO foi justificada dentro do prazo.

"Justificar" = anexar nota fiscal/recibo + escolher a etiqueta correta + escrever a descri√ß√£o objetiva.

Como desbloquear:
1. Corrige tudo na plataforma Clara.
2. Abre chamado no ServiceNow para Financeiro / Contas a Receber pedindo desbloqueio.

Mensagem sugerida no chamado:
"Cart√£o bloqueado preventivamente. Presta√ß√£o de contas regularizada. Solicito desbloqueio."

Link:
${SERVICE_NOW_URL}

Obs:
‚Üí Pode bloquear independente do valor.
‚Üí Reincid√™ncia pode fazer a loja perder o cart√£o.`
            );
        }

        function respostaBloqueioFollowup() {
            return (
`Resumo do passo a passo pra desbloquear:

1. Vai na transa√ß√£o que gerou o problema.
2. Sobe a nota fiscal ou recibo.
3. Escolhe a etiqueta certa.
4. Escreve a descri√ß√£o do gasto (ex.: "Chaveiro emergencial - troca fechadura estoque 1234").
5. Depois abre chamado no ServiceNow informando que j√° regularizou e precisa do desbloqueio preventivo.

Sem esse chamado o Financeiro n√£o libera.`
            );
        }

        function respostaPrazo() {
            return (
`Prazo oficial ‚è±

Voc√™ tem at√© 48 horas depois da compra para:
1. anexar a nota fiscal/recibo,
2. escolher a etiqueta correta,
3. escrever a descri√ß√£o do gasto.

Se isso n√£o estiver feito, o cart√£o pode ser bloqueado preventivamente at√© regularizar.`
            );
        }

        function respostaJustificar() {
            return (
`Pra justificar / prestar contas de uma compra na Clara voc√™ precisa fazer 3 coisas em at√© 48h depois da compra:

1. Anexar o comprovante fiscal
   - nota fiscal ou recibo.

2. Escolher a etiqueta certa
   - √© a categoria da despesa (ex.: "√ÅGUA POT√ÅVEL", "CHAVEIRO EMERGENCIAL", "TRANSPORTE / SERVI√áO EMERGENCIAL").
   - Se a etiqueta n√£o existir ainda, voc√™ pede cria√ß√£o via chamado no ServiceNow.

3. Preencher a descri√ß√£o
   - escrever rapidamente o que √© e o motivo.
   - exemplo bom: "Chaveiro emergencial - troca fechadura estoque loja 1234".
   - exemplo ruim: "servi√ßo".

Se n√£o justificar, seu cart√£o pode ser bloqueado preventivamente at√© acertar.`
            );
        }

        function respostaJustificarFollowup() {
            return (
`Modo turbo pra justificar certo:

‚Ä¢ Nota fiscal anexada (foto ou PDF leg√≠vel)
‚Ä¢ Etiqueta coerente com o gasto
  - √°gua ‚Üí "√ÅGUA POT√ÅVEL"
  - lanche/coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"
  - motoboy urgente ‚Üí "TRANSPORTE / SERVI√áO EMERGENCIAL"
  - chaveiro ‚Üí "CHAVEIRO EMERGENCIAL"
‚Ä¢ Descri√ß√£o clara: "Coffee break treinamento VM loja 1234"

Isso evita bloqueio e reduz cobran√ßa por e-mail.`
            );
        }

        function respostaEmergencia() {
            return (
`"Emerg√™ncia" N√ÉO √© "acabou o limite". üòÖ

√â emerg√™ncia real quando:
1. a loja n√£o consegue operar sem aquele gasto AGORA,
E
2. n√£o d√° pra usar o cart√£o Clara (ex.: falha t√©cnica).

O que fazer:
‚Üí Antes de tirar dinheiro do caixa ou improvisar,
   abre chamado no ServiceNow pedindo autoriza√ß√£o excepcional do Financeiro.

Mensagem no chamado:
"Solicita√ß√£o de exce√ß√£o emergencial para despesa operacional imediata. Motivo: ____."

Sem autoriza√ß√£o PR√âVIA, n√£o pode tirar dinheiro do caixa e 'depois eu acerto'.`
            );
        }

        function respostaPessoal() {
            return (
`Uso pessoal do cart√£o √© proibido.

Como corrigir:
1. avisa o Financeiro,
2. marca a transa√ß√£o na Clara como "Despesa Pessoal ‚Äì Uso Indevido",
3. devolve o valor em at√© 2 dias √∫teis.

Se n√£o ressarcir:
‚Ä¢ pode ter desconto em folha,
‚Ä¢ pode gerar medida disciplinar,
‚Ä¢ e o cart√£o pode ser bloqueado definitivamente pra voc√™.`
            );
        }

        function respostaOutraLoja() {
            return (
`Usar cart√£o de outra loja s√≥ √© permitido em cen√°rio bem espec√≠fico:

‚Ä¢ gerente titular saiu e ainda n√£o criaram cart√£o novo pra loja,
‚Ä¢ Financeiro autorizou esse uso tempor√°rio,
‚Ä¢ voc√™ est√° cobrindo formalmente.

Obrigat√≥rio:
Na descri√ß√£o da compra voc√™ escreve:
"Uso tempor√°rio do cart√£o na loja XXXX".

Mudan√ßa de gerente / troca de respons√°vel precisa ser formalizada:
‚Üí abre chamado no ServiceNow pra atualizar quem responde pelo cart√£o.`
            );
        }

        function respostaNotaFiscal() {
            return (
`Mesmo depois de subir a nota fiscal/recibo na plataforma Clara, a loja precisa guardar o documento f√≠sico original.

Prazo: manter guardado por 180 dias corridos.
A √°rea financeira pode pedir esse comprovante f√≠sico em auditoria.`
            );
        }

        function respostaServiceNowGeral() {
            return (
`Casos que exigem chamado no ServiceNow üëá

‚Ä¢ Desbloqueio do cart√£o
  ‚Üí Financeiro / Contas a Receber
  ‚Üí Mensagem: "Cart√£o bloqueado preventivamente. Presta√ß√£o de contas regularizada. Solicito desbloqueio."

‚Ä¢ Aumento de limite
  ‚Üí Financeiro
  ‚Üí Mensagem: "Solicita√ß√£o de aumento de limite para despesas operacionais da loja XXXX. Justificativa: ____."

‚Ä¢ Troca de gerente / mudan√ßa de respons√°vel pelo cart√£o
  ‚Üí Cadastro / Financeiro
  ‚Üí Mensagem: "Atualiza√ß√£o de respons√°vel pelo cart√£o Clara: gerente anterior desligado / novo respons√°vel assumindo a loja XXXX."

‚Ä¢ Criar nova etiqueta/categoria de gasto
  ‚Üí Financeiro / Cont√°bil
  ‚Üí Mensagem: "Solicitar inclus√£o de etiqueta para despesa operacional da loja. Descri√ß√£o: ____."

‚Ä¢ Emerg√™ncia real (n√£o consigo operar sem isso AGORA e o cart√£o n√£o funciona)
  ‚Üí Financeiro
  ‚Üí Mensagem: "Solicita√ß√£o de exce√ß√£o emergencial para despesa operacional imediata."

Link:
${SERVICE_NOW_URL}

Abra o chamado ANTES de improvisar tipo 'pegar dinheiro do caixa'.`
            );
        }

        function respostaServiceNowContextual(msgNorm) {
            if (
                msgNorm.includes("desbloque") ||
                msgNorm.includes("bloqueou") ||
                msgNorm.includes("bloqueio") ||
                msgNorm.includes("cartao travou") ||
                msgNorm.includes("cartao bloqueado") ||
                msgNorm.includes("como desbloquear")
            ) {
                return respostaBloqueio();
            }

            if (
                msgNorm.includes("etiqueta") ||
                msgNorm.includes("categoria nova") ||
                msgNorm.includes("nova categoria")
            ) {
                return (
`Quer usar uma categoria/etiqueta que n√£o existe na Clara?

‚Üí Abre chamado no ServiceNow para Financeiro / Cont√°bil pedindo cria√ß√£o de etiqueta.

Mensagem sugerida:
"Solicitar inclus√£o de etiqueta para despesa operacional da loja. Descri√ß√£o: ____."

Link:
${SERVICE_NOW_URL}`
                );
            }

            if (
                msgNorm.includes("troca de gerente") ||
                msgNorm.includes("mudanca de gerente") ||
                msgNorm.includes("mudan√ßa de gerente") ||
                msgNorm.includes("gerente desligado") ||
                msgNorm.includes("sem gerente")
            ) {
                return (
`Mudou o respons√°vel pelo cart√£o da loja?

‚Üí Precisa abrir chamado no ServiceNow pra atualizar oficialmente quem responde pelo cart√£o.

Mensagem sugerida:
"Atualiza√ß√£o de respons√°vel pelo cart√£o Clara: gerente anterior desligado / novo respons√°vel assumindo a loja XXXX."

Isso garante controle e auditoria.

Link:
${SERVICE_NOW_URL}`
                );
            }

            if (
                msgNorm.includes("limite") ||
                msgNorm.includes("aumento de limite") ||
                msgNorm.includes("limite maior")
            ) {
                return (
`Precisa de aumento de limite do cart√£o?

‚Üí Abre chamado no ServiceNow para Financeiro.

Mensagem sugerida:
"Solicita√ß√£o de aumento de limite para despesas operacionais da loja XXXX. Justificativa: ____."

Link:
${SERVICE_NOW_URL}

Lembrando: limite √© pra despesa operacional, n√£o uso pessoal.`
                );
            }

            if (
                msgNorm.includes("emergencia") ||
                msgNorm.includes("emerg√™ncia") ||
                msgNorm.includes("urgente") ||
                msgNorm.includes("sangria") ||
                msgNorm.includes("tirar dinheiro do caixa") ||
                msgNorm.includes("pegar dinheiro do caixa")
            ) {
                return (
`Emerg√™ncia real = loja n√£o consegue operar sem o gasto AGORA e o cart√£o Clara n√£o resolve.

Antes de tirar dinheiro do caixa:
‚Üí Abre chamado no ServiceNow pedindo autoriza√ß√£o excepcional do Financeiro.

Mensagem sugerida:
"Solicita√ß√£o de exce√ß√£o emergencial para despesa operacional imediata. Motivo: ____."

Link:
${SERVICE_NOW_URL}

Sem autoriza√ß√£o PR√âVIA, n√£o pode usar caixa f√≠sico.`
                );
            }

            return respostaServiceNowGeral();
        }

        function respostaPoliticaPDF() {
            return (
`HTML:<p>Segue a <strong>Pol√≠tica de Uso dos Cart√µes Clara</strong> (documento oficial atual):<br>
<a class="bot-link" href="${POLITICA_PDF_URL}" target="_blank" rel="noopener noreferrer">${POLITICA_PDF_URL}</a>
</p>
<p class="mt-2 text-[13px] text-slate-500">
O documento traz: categorias permitidas, prazo de 48h pra presta√ß√£o de contas, bloqueio preventivo, responsabilidades e fluxo em caso de uso pessoal do cart√£o.
</p>`
            );
        }

        function respostaEtiquetaEspecifica(msgNorm) {
            // tenta achar etiqueta via palavras
            const et = descobrirEtiqueta(msgNorm);
            if (et) {
                return (
`Para esse tipo de gasto, use a etiqueta: "${et.etiqueta}".

Descri√ß√£o recomendada:
"${et.exemploDescricao}"

Regras:
‚Ä¢ Anexe a nota fiscal / recibo na Clara
‚Ä¢ Lance em at√© 48h ap√≥s a compra
‚Ä¢ Guarde o comprovante f√≠sico na loja por 180 dias

Se a etiqueta n√£o existir na Clara ainda:
‚Üí abra chamado no ServiceNow pedindo cria√ß√£o dessa etiqueta.`
                );
            }

            // fallback se n√£o achou nenhuma etiqueta mapeada
            return (
`Voc√™ deve usar a etiqueta que melhor descreve o tipo de gasto operacional da loja.

Exemplos comuns:
‚Ä¢ √Ågua ‚Üí "√ÅGUA POT√ÅVEL"
‚Ä¢ Coffee break / lanche autorizado ‚Üí "LANCHES DE REFEI√á√ïES"
‚Ä¢ Motoboy urgente ‚Üí "TRANSPORTE / SERVI√áO EMERGENCIAL"
‚Ä¢ Chaveiro emergencial ‚Üí "CHAVEIRO EMERGENCIAL"

Se voc√™ n√£o encontrar a etiqueta certa na Clara:
‚Üí abre chamado no ServiceNow pedindo cria√ß√£o de etiqueta espec√≠fica.`
            );
        }

        function respostaGenerica() {
            return (
`Pra saber se pode usar o cart√£o Clara, olha isso:

1. √â despesa operacional da loja (necess√°ria pro funcionamento)?
2. Voc√™ tem nota fiscal ou recibo?
3. Voc√™ consegue anexar a nota, escolher etiqueta e descrever o motivo em at√© 48h?

Se sim ‚Üí normalmente pode.
Se for item patrimonial / infraestrutura grande ou gasto pessoal ‚Üí n√£o pode no cart√£o Clara (vai via Compras ou precisa ressarcir).`
            );
        }

        function respostaFollowupGenerico() {
            return (
`Se voc√™ quiser, me fala especificamente:
‚Ä¢ √â manuten√ß√£o emergencial?
‚Ä¢ √â alimento/√°gua pro time em a√ß√£o autorizada?
‚Ä¢ √â transporte tipo Uber pessoal?
‚Ä¢ √â compra de equipamento f√≠sico tipo geladeira?

Assim eu consigo dizer etiqueta e caminho (Clara / Compras / ressarcimento / ServiceNow).`
            );
        }


        //
        // NORMALIZA√á√ÉO / CLASSIFICA√á√ÉO
        //
        function normalize(text) {
            return text
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        function hit(msgNorm, arr) {
            return arr.some(k => msgNorm.includes(normalize(k)));
        }

        function ehPerguntaFollowupCurta(msgNorm) {
            // perguntas tipo "como?", "e agora?", "qual etiqueta?", "explica melhor", "e fa√ßo o que?"
            if (msgNorm.length <= 40) {
                const gatilhos = [
                    "como", "e agora", "e fa√ßo o que", "e faco o que",
                    "qual etiqueta", "que etiqueta", "qual categoria",
                    "explica melhor", "me explica", "me ajuda",
                    "o que eu fa√ßo", "o que eu faco", "e depois", "e ai", "e a√≠"
                ];
                return gatilhos.some(g => msgNorm.includes(g));
            }
            return false;
        }

        function classificarPergunta(msg) {
            const m = normalize(msg);

            // inten√ß√£o especial: etiqueta
            if (
                termosEtiquetaDireta.some(t => m.includes(normalize(t))) ||
                descobrirEtiqueta(m) // se ele j√° mencionou "√°gua", "chaveiro", "motoboy" etc.
            ) {
                return "etiqueta";
            }

            if (hit(m, categorias.politicaPdf))   return "politicaPdf";
            if (hit(m, categorias.servicenow))    return "servicenow";

            if (hit(m, categorias.bloqueio))      return "bloqueio";
            if (hit(m, categorias.justificar))    return "justificar";

            if (hit(m, categorias.eletronicos))      return "eletronicos";
            if (hit(m, categorias.eletrodomesticos)) return "eletrodomesticos";
            if (hit(m, categorias.alimentosEquipe))  return "alimentosEquipe";
            if (hit(m, categorias.transporte))       return "transporte";
            if (hit(m, categorias.manutencaoLoja))   return "manutencaoLoja";
            if (hit(m, categorias.prazo))            return "prazo";
            if (hit(m, categorias.emergencial))      return "emergencia";
            if (hit(m, categorias.pessoal))          return "pessoal";
            if (hit(m, categorias.outraLoja))        return "outraLoja";
            if (hit(m, categorias.notaFiscal))       return "notaFiscal";

            return "generica";
        }

        function gerarResposta(msg) {
            const msgNorm = normalize(msg);

            // 1. follow-up curto?
            if (ehPerguntaFollowupCurta(msgNorm) && ultimaIntencaoRespondida) {
                switch (ultimaIntencaoRespondida) {
                    case "transporte":     return respostaTransporteFollowup();
                    case "bloqueio":       return respostaBloqueioFollowup();
                    case "justificar":     return respostaJustificarFollowup();
                    case "alimentosEquipe":return respostaAlimentosEquipeFollowupAgua(msgNorm);
                    case "manutencaoLoja": return respostaManutencaoFollowup(msgNorm);
                    case "etiqueta":       return respostaEtiquetaEspecifica(msgNorm);
                    default:               return respostaFollowupGenerico();
                }
            }

            // 2. pergunta normal
            const tipo = classificarPergunta(msg);

            // guarda a inten√ß√£o pra poss√≠vel follow-up
            ultimaIntencaoRespondida = tipo;

            switch (tipo) {
                case "eletronicos":      return respostaEletronicos();
                case "eletrodomesticos": return respostaEletrodomesticos();
                case "alimentosEquipe":  return respostaAlimentosEquipe();
                case "transporte":       return respostaTransporte();
                case "manutencaoLoja":   return respostaManutencao();
                case "bloqueio":         return respostaBloqueio();
                case "prazo":            return respostaPrazo();
                case "justificar":       return respostaJustificar();
                case "emergencia":       return respostaEmergencia();
                case "pessoal":          return respostaPessoal();
                case "outraLoja":        return respostaOutraLoja();
                case "notaFiscal":       return respostaNotaFiscal();
                case "servicenow":       return respostaServiceNowContextual(msgNorm);
                case "politicaPdf":      return respostaPoliticaPDF();
                case "etiqueta":         return respostaEtiquetaEspecifica(msgNorm);
                default:                 return respostaGenerica();
            }
        }


        //
        // RENDER DO CHAT
        //
        const chatWindow = document.getElementById("chatWindow");
        const chatForm = document.getElementById("chatForm");
        const userInput = document.getElementById("userInput");

        function renderUserMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 justify-end";

            const bubble = document.createElement("div");
            bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line";
            bubble.innerText = text;

            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
        }

        function renderTyping() {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 clara-typing";

            const avatar = document.createElement("div");
            avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
            avatar.innerText = "C";

            const bubble = document.createElement("div");
            bubble.className = "typing-bubble px-4 py-3 max-w-[80%] text-[13px]";
            bubble.innerHTML = `
                <span class="dot"></span>
                <span class="dot ml-1"></span>
                <span class="dot ml-1"></span>
                <span class="ml-2 text-slate-500">digitando...</span>
            `;

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);

            chatWindow.appendChild(wrapper);
            scrollToBottom();

            return wrapper;
        }

        // suporta HTML (pra link do PDF)
        function renderBotMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3";

            const avatar = document.createElement("div");
            avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
            avatar.innerText = "C";

            const bubble = document.createElement("div");
            bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

            if (text.startsWith("HTML:")) {
                bubble.innerHTML = text.replace(/^HTML:/, "").trim();
            } else {
                bubble.innerText = text;
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);

            chatWindow.appendChild(wrapper);
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        chatForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            renderUserMessage(text);
            userInput.value = "";

            const typingEl = renderTyping();

            const answer = gerarResposta(text);

            setTimeout(() => {
                typingEl.remove();
                renderBotMessage(answer);
                scrollToBottom();
            }, 400);
        });
    </script>
</body>
</html>
