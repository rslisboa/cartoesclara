<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistente Clara | Uso do Cart√£o na Loja</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet"
    />

    <style>
        :root {
            --brand-main: #005E27; /* verde escuro */
        }

        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: #f8fafc;
        }

        /* bolhas */
        .user-bubble {
            background-color: var(--brand-main);
            color: #fff;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.25);
        }
        .bot-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1); /* slate-200 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
        }

        /* avatar Clara (nas mensagens) */
        .bot-avatar {
            background-color: var(--brand-main);
            color: #fff;
        }

        /* bot√£o enviar */
        .send-button {
            background-color: var(--brand-main);
        }
        .send-button:hover {
            filter: brightness(1.1);
        }

        /* focus do input */
        .user-input:focus {
            --tw-ring-color: var(--brand-main);
            outline: 2px solid var(--brand-main);
            border-color: var(--brand-main);
        }

        /* "digitando..." */
        .typing-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
            font-size: 13px;
            color: #475569;
        }
        .dot {
            width: 6px;
            height: 6px;
            background-color: #475569;
            border-radius: 9999px;
            display: inline-block;
            animation: bounce 1.2s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.15s; }
        .dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-4px); opacity: 1; }
        }

        /* scrollbar da janela de chat */
        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }
        #chatWindow::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 9999px;
        }
        #chatWindow::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 9999px;
        }

        /* links clic√°veis nas respostas */
        .bot-link {
            color: var(--brand-main);
            font-weight: 600;
            text-decoration: underline;
            word-break: break-word;
        }
    </style>
</head>
<body class="text-slate-800 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col min-h-[600px] max-h-[90vh]">
        <!-- Header (centralizado e sem avatar inicial "C") -->
        <header class="px-5 py-6 border-b border-slate-200 text-center">
            <div class="flex flex-col items-center gap-3">
                <div class="leading-tight">
                    <p class="font-semibold text-slate-800 text-base md:text-lg">
                        Assistente Clara | Grupo SBF
                    </p>
                    <p class="text-[13px] text-slate-600 mt-2">
                        Pergunte sobre o uso do cart√£o Clara nas lojas.
                    </p>
                    <p class="text-[12px] text-slate-500 mt-1">
                        Ex: "Posso comprar micro-ondas?" ‚Ä¢ "Uber pode?" ‚Ä¢ "Travou o cart√£o, fa√ßo o qu√™?"
                    </p>
                    <p class="text-[11px] text-slate-400 italic mt-3">
                        Minhas respostas seguem a Pol√≠tica de Uso dos Cart√µes Clara.
                        Em conflito, vale sempre o documento oficial da empresa.
                    </p>
                </div>
            </div>
        </header>

        <!-- Chat window (altura m√≠nima maior) -->
        <section id="chatWindow" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 text-[15px] leading-relaxed bg-slate-50/40 min-h-[360px]">

            <!-- Mensagem inicial da Clara -->
            <div class="flex items-start gap-3">
                <div class="w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0">
                    C
                </div>
                <div class="bot-bubble px-4 py-3 max-w-[80%]">
                    <p class="font-semibold text-slate-800">
                        Ol√°! üëã Eu sou a Clara.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar:
                        <br>‚Ä¢ "Posso pagar Uber?"
                        <br>‚Ä¢ "Qual etiqueta pra √°gua?"
                        <br>‚Ä¢ "Meu cart√£o bloqueou, e agora?"
                        <br>‚Ä¢ "O que fa√ßo com compra pessoal?"
                        <br>‚Ä¢ "Me manda a pol√≠tica em PDF."
                    </p>
                    <p class="text-[11px] text-slate-400 italic mt-3">
                        Se eu mandar abrir chamado, vou te dar o link do ServiceNow j√° prontinho üëá
                    </p>
                </div>
            </div>
        </section>

        <!-- √Årea de input -->
        <section class="border-t border-slate-200 bg-white rounded-b-2xl px-4 py-4 flex flex-col gap-3">
            <form id="chatForm" class="flex w-full gap-3">
                <input
                    id="userInput"
                    type="text"
                    class="user-input flex-1 text-[15px] border border-slate-300 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-[var(--brand-main)] focus:border-[var(--brand-main)]"
                    placeholder="Escreve sua d√∫vida (ex: qual etiqueta pro teclado?)"
                    autocomplete="off"
                />
                <button
                    class="send-button text-white font-semibold text-sm rounded-xl px-4 py-3 shadow-md transition"
                    type="submit"
                >
                    Enviar
                </button>
            </form>

            <div class="text-[11px] text-slate-500 text-center leading-snug">
                Uso pessoal = proibido. Se acontecer, voc√™ precisa declarar e ressarcir em at√© 2 dias √∫teis.
            </div>
        </section>
    </main>

    <script>
        //
        // CONFIG FIXA
        //
        const SERVICE_NOW_URL = "https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6";
        const POLITICA_PDF_URL = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";

        // Guardar contexto da √∫ltima inten√ß√£o respondida
        let ultimaIntencaoRespondida = null;


        //
        // MAPA DE ETIQUETAS (baseado no Anexo I)
        //
        const mapaEtiquetas = [
            {
                termos: ["agua","√°gua","gal√£o","galao","garrafa de agua","garrafa de √°gua","agua potavel","√°gua pot√°vel","beber √°gua","hidratacao","hidrata√ß√£o","filtro de agua","filtro de √°gua"],
                etiqueta: "√ÅGUA POT√ÅVEL",
                exemploDescricao: "Gal√µes de √°gua / abastecimento da equipe e loja"
            },
            {
                termos: ["lanche","cafe","caf√©","coffee break","salgado","refrigerante","treinamento","visita regional","visita diretor","vm","time vm","a√ß√£o vm","acao vm","evento interno","premiacao","premia√ß√£o"],
                etiqueta: "LANCHES DE REFEI√á√ïES",
                exemploDescricao: "Coffee break / lanche para treinamento interno autorizado / a√ß√£o oficial de loja"
            },
            {
                termos: ["chaveiro","fechadura","abrir porta","abrir cofre","troca de fechadura","cofre","vitrine trancada","estoque trancado"],
                etiqueta: "CHAVEIRO EMERGENCIAL",
                exemploDescricao: "Servi√ßo emergencial de chaveiro para estoque/cofre/vitrine da loja"
            },
            {
                termos: ["motoboy","frete","entrega urgente","courier","transportar pe√ßa","levar pe√ßa","buscar pe√ßa","envio urgente","sedex","correios","postagem","envio documento"],
                etiqueta: "TRANSPORTE / SERVI√áO EMERGENCIAL",
                exemploDescricao: "Motoboy/frete urgente entre lojas / envio urgente de documento ou material cr√≠tico"
            },
            {
                termos: ["limpeza","detergente","desinfetante","papel toalha","√°lcool","alcool","desengordurante","panos de ch√£o","pano de chao","vassoura","rodo","esponja"],
                etiqueta: "MATERIAL DE LIMPEZA",
                exemploDescricao: "Materiais de higiene e limpeza para opera√ß√£o da loja"
            },
            {
                termos: ["tomada","troca de tomada","interruptor","disjuntor","extensao","extens√£o","cabo eletrico","cabo el√©trico","ar condicionado","ar-condicionado","manuten√ß√£o ar","manutencao ar","reparo ar","controle remoto do ar","carregar gas","carga de gas"],
                etiqueta: "MANUTEN√á√ÉO (EL√âTRICA / AR)",
                exemploDescricao: "Pequeno reparo el√©trico / ajuste simples de ar condicionado na loja"
            },
            {
                termos: ["impressao","impress√£o","banner","adesivo","adesivagem","flyer","grafica","gr√°fica","plotagem","plotter","folder","comunicado promocional","visual de campanha"],
                etiqueta: "SERVI√áOS GR√ÅFICOS / DIVULGA√á√ÉO",
                exemploDescricao: "Impress√£o de banner/adesivo/folder promocional autorizado para a loja"
            },
            {
                termos: ["teclado","mouse","cabo usb","pendrive","fonte de notebook","carregador notebook","hub usb","roteador","roteadorzinho","suporte notebook","cartao de memoria","cart√£o de mem√≥ria","teclado pdv","mouse pdv"],
                etiqueta: "MATERIAL DE INFORM√ÅTICA",
                exemploDescricao: "Teclado / mouse / cabos / pendrive usados na opera√ß√£o da loja (PDV, caixa, etc.)"
            },
            {
                termos: ["caneta","canetas","pasta","pastas","bloco","blocos","post-it","postit","grampeador","etiqueta adesiva","organizador de mesa","caderno","papel sulfite","sulfite","clips"],
                etiqueta: "MATERIAL DE ESCRIT√ìRIO",
                exemploDescricao: "Materiais de escrit√≥rio para uso administrativo interno da loja"
            }
        ];

        function descobrirEtiqueta(msgNorm) {
            for (const item of mapaEtiquetas) {
                const bateu = item.termos.some(t => msgNorm.includes(normalize(t)));
                if (bateu) return item;
            }
            return null;
        }


        //
        // INTEN√á√ïES / PALAVRAS-CHAVE
        //
        const categorias = {
            bebidaAlcoolica: [
                "cerveja","cervejinha","latinha","vodka","whisky","whiskey","whisky","whiskyzin",
                "vinho","champagne","espumante","bebida alcoolica","bebida alco√≥lica","alcool","√°lcool","chopp","chope"
            ],
            eletronicos: [
                "ps5","playstation","play station","xbox",
                "tv","televisao","televis√£o","monitor","som","r√°dio","radio",
                "caixa de som","soundbar","notebook","laptop","tablet","fone","headset"
            ],
            eletrodomesticos: [
                "micro-ondas","microondas","micro ondas",
                "geladeira","frigobar","cafeteira","cafeteria","cafeteirinha",
                "bebedouro","airfryer","aspirador"
            ],
            alimentosEquipe: [
                "lanche","cafe","caf√©","refei√ß√£o","refeicao","almo√ßo","almoco","pizza","refrigerante",
                "√°gua","agua","gal√£o","galao","garrafa de agua","garrafa de √°gua",
                "coffee break","lanche do time","lanche da equipe",
                "time vm","vm","treinamento","treinamento interno","visita diretor","visita regional"
            ],
            transporte: [
                "uber","99","app de transporte","corrida","taxi","t√°xi","taxi99","taxi 99",
                "viagem","passagem","passagens"
            ],
            manutencaoLoja: [
                "chaveiro","fechadura","troca de tomada","tomada","manuten√ß√£o ar",
                "manutencao ar","ar condicionado","ar-condicionado","conserto geladeira da loja",
                "arrumar porta","arrumar vitrine","motoboy","frete","frete urgente","entrega urgente","courier"
            ],
            bloqueio: [
                "bloqueou","bloqueio","bloqueada","cart√£o bloqueado","cartao bloqueado",
                "desbloquear","desbloqueia","desbloqueio","como desbloquear",
                "travou","cart√£o travou","cartao travou","preventivo","meu cart√£o travou","meu cartao travou"
            ],
            prazo: [
                "48h","48 horas","prazo","quanto tempo","deadline",
                "quando preciso lan√ßar","ate quando lan√ßo","at√© quando lan√ßo"
            ],
            justificar: [
                "como justificar","justificar compra","justificar transa√ß√£o","justificar a transa√ß√£o",
                "prestar conta","presta√ß√£o de contas","prestacao de contas",
                "o que eu coloco na descri√ß√£o","o que tenho que anexar","o que precisa lan√ßar na clara",
                "o que tenho que lan√ßar","como lan√ßo","como lan√ßar","como justifico"
            ],
            emergencial: [
                "emerg√™ncia","emergencia","urgente","sangria",
                "tirar dinheiro do caixa","pegar dinheiro do caixa","sem limite","acabou limite","limite acabou","estourou limite"
            ],
            pessoal: [
                "usei pra mim","pra mim","comprei pra mim",
                "gasto pessoal","despesa pessoal","roupa pro meu filho","comprei um body pro meu filho","pessoal"
            ],
            outraLoja: [
                "cart√£o de outra loja","cartao de outra loja","emprestado",
                "usar cart√£o da outra loja","usar cartao da outra loja",
                "gerente desligado","sem gerente","sem cart√£o","sem cartao",
                "mudan√ßa de gerente","mudanca de gerente","troca de gerente"
            ],
            notaFiscal: [
                "guardar nota","nota fisica","nota fiscal fisica","nota fiscal f√≠sica",
                "comprovante fisico","comprovante f√≠sico","auditoria","180 dias","guardar comprovante"
            ],
            servicenow: [
                "servicenow","service now","abre chamado","abrir chamado","abrir um chamado",
                "chamado de aumento de limite","chamado de limite","chamado desbloqueio",
                "desbloqueio no servicenow","categoria nova","nova etiqueta","nova categoria",
                "troca de gerente","mudan√ßa de gerente","mudanca de gerente","transferir gerente",
                "cart√£o bloqueado preciso abrir chamado","cartao bloqueado preciso abrir chamado",
                "o que posso abrir no servicenow","quais chamados posso abrir"
            ],
            politicaPdf: [
                "me manda a pol√≠tica","me manda a politica","manda a pol√≠tica","manda a politica",
                "pdf da politica","pdf da pol√≠tica","politica clara","pol√≠tica clara",
                "documento oficial","politica completa","politica em pdf","politica de uso"
            ]
        };

        // inten√ß√£o espec√≠fica pra etiqueta
        const termosEtiquetaDireta = [
            "qual etiqueta","que etiqueta","etiqueta usar","etiqueta devo usar","etiqueta pra","etiqueta para",
            "qual conta","qual categoria","qual classifica√ß√£o","qual classificacao"
        ];


        //
        // RESPOSTAS PRINCIPAIS
        //
        function respostaBebidaAlcoolica() {
            return (
`N√£o pode. üö´

Bebida alco√≥lica (cerveja, vinho, whisky, etc.) N√ÉO √© despesa operacional da loja e N√ÉO pode ser paga com o cart√£o Clara ‚Äî nem pra comemorar, nem pra ‚Äútime‚Äù, nem pra visita.

Se j√° passou no cart√£o:
1. avisa o Financeiro imediatamente,
2. classifica na plataforma como "Despesa Pessoal ‚Äì Uso Indevido",
3. ressarce o valor em at√© 2 dias √∫teis.

Se n√£o ressarcir no prazo, pode ter desconto em folha e bloqueio do cart√£o.`
            );
        }

        function respostaEletronicos() {
            return (
`N√£o, esse tipo de compra n√£o pode ser feito com o cart√£o Clara. üò¨

Eletr√¥nicos (TV, monitor, notebook, som etc.) s√£o bens patrimoniais / equipamento. Isso segue o fluxo de Compras, n√£o o cart√£o da loja.

Caminho correto:
‚Üí Solicitar via Compras / abertura de chamado, N√ÉO passar direto no cart√£o Clara.`
            );
        }

        function respostaEletrodomesticos() {
            return (
`Micro-ondas, geladeira, frigobar, cafeteira, bebedouro etc. N√ÉO entram no cart√£o Clara.

Eles s√£o infraestrutura fixa da loja, classificados como bem patrimonial / ativo f√≠sico.  
Devem ir pelo fluxo de Compras.

Se j√° passou no cart√£o:
1. avisa o Financeiro,
2. marca como "Despesa Pessoal ‚Äì Uso Indevido",
3. ressarce em at√© 2 dias √∫teis.`
            );
        }

        function respostaTransporte() {
            return (
`Uber / 99 / t√°xi pra deslocamento pessoal N√ÉO pode no cart√£o Clara.

Isso n√£o √© despesa operacional direta da loja.

Se j√° pagou com o cart√£o:
‚Üí avisa Financeiro,
‚Üí marca a transa√ß√£o na Clara como "Despesa Pessoal ‚Äì Uso Indevido",
‚Üí ressarce o valor em at√© 2 dias √∫teis.`
            );
        }

        function respostaTransporteFollowup() {
            return (
`Pra corrigir o Uber que caiu no cart√£o:

1. Abra a transa√ß√£o na Clara.
2. Na descri√ß√£o, deixe claro que foi uso pessoal.
3. Classifique como "Despesa Pessoal ‚Äì Uso Indevido".
4. Avisa o Financeiro.
5. Ressa√ßa o valor pra empresa em at√© 2 dias √∫teis.

Sem ressarcimento:
‚Üí pode ter desconto em folha
‚Üí pode bloquear seu cart√£o de vez.`
            );
        }

        function respostaAlimentosEquipe() {
            return (
`Depende üëá

‚úî Pode:
√Ågua, lanche, coffee break, refrigerante etc. para:
‚Ä¢ treinamento interno autorizado
‚Ä¢ a√ß√£o oficial de VM / regional / diretoria
‚Ä¢ evento operacional aprovado

‚ùå N√£o pode:
Lazer pessoal (almo√ßo pessoal, pipoca no cinema, ‚Äúvamos brindar‚Äù, etc.).

Quando √© permitido:
‚Ä¢ Anexa nota fiscal
‚Ä¢ Usa a etiqueta correta (ex.: "√ÅGUA POT√ÅVEL" ou "LANCHES DE REFEI√á√ïES")
‚Ä¢ Descreve: "Coffee break treinamento VM loja 1234"`
            );
        }

        function respostaAlimentosEquipeFollowupAgua(msgNorm) {
            const etiquetaInfo = descobrirEtiqueta(msgNorm);
            if (etiquetaInfo) {
                return (
`Para esse tipo de gasto use a etiqueta: "${etiquetaInfo.etiqueta}".

Descri√ß√£o na Clara:
"${etiquetaInfo.exemploDescricao}"

Obrigat√≥rio:
‚Ä¢ Anexar a nota fiscal/recibo
‚Ä¢ Lan√ßar em at√© 48h
‚Ä¢ Guardar o documento f√≠sico na loja por 180 dias`
                );
            }

            return (
`Para √°gua / coffee break autorizado:
1. Usa a etiqueta adequada (por ex. "√ÅGUA POT√ÅVEL" ou "LANCHES DE REFEI√á√ïES")
2. Anexa nota fiscal
3. Descreve o motivo operacional (ex.: "Coffee break para treinamento VM loja 1234")`
            );
        }

        function respostaManutencao() {
            return (
`Esse tipo de gasto normalmente PODE ir no cart√£o Clara porque √© custo operacional direto da loja. üí°

Exemplos aceitos:
‚Ä¢ chaveiro emergencial (abrir/trocar fechadura do estoque, cofre, vitrine),
‚Ä¢ troca de tomada, interruptor,
‚Ä¢ ajuste leve em ar-condicionado,
‚Ä¢ motoboy / frete urgente entre lojas.

Sempre:
- Anexa a nota fiscal,
- Usa a etiqueta certa (ex.: "CHAVEIRO EMERGENCIAL", "MANUTEN√á√ÉO (EL√âTRICA / AR)", "TRANSPORTE / SERVI√áO EMERGENCIAL"),
- Descri√ß√£o clara: "Chaveiro emergencial - troca fechadura estoque loja 1234".`
            );
        }

        function respostaManutencaoFollowup(msgNorm) {
            const etiquetaInfo = descobrirEtiqueta(msgNorm);
            if (etiquetaInfo) {
                return (
`Use a etiqueta: "${etiquetaInfo.etiqueta}"

Descri√ß√£o sugerida:
"${etiquetaInfo.exemploDescricao}"

Passos obrigat√≥rios:
1. Anexar nota fiscal / recibo
2. Lan√ßar em at√© 48h
3. Escrever o que foi feito e onde ("Troca fechadura estoque loja 1234")`
                );
            }

            return (
`Para manuten√ß√£o emergencial de loja:
1. Anexa a nota fiscal
2. Usa etiqueta de manuten√ß√£o / servi√ßo emergencial
3. Explica na descri√ß√£o o que aconteceu e em qual √°rea da loja

Se for compra de equipamento grande/fixo (ex.: geladeira nova), a√≠ N√ÉO √© cart√£o, √© Compras.`
            );
        }

        function respostaBloqueio() {
            return (
`Isso √© bloqueio preventivo. üîí

O cart√£o pode travar se a compra n√£o foi justificada dentro do prazo.

Justificar = anexar nota fiscal/recibo + escolher etiqueta correta + escrever a descri√ß√£o objetiva.

Como desbloquear:
1. Corrige tudo na plataforma Clara.
2. Depois abre chamado no ServiceNow pedindo desbloqueio, informando que j√° regularizou.

HTML:<p class="mt-2 text-sm text-slate-700">Use este link para abrir o chamado:<br>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a></p>

Obs:
‚Üí Pode bloquear independente do valor.
‚Üí Reincid√™ncia pode fazer a loja perder o cart√£o.`
            );
        }

        function respostaBloqueioFollowup() {
            return (
`Passo a passo pra liberar o cart√£o:

1. Vai na transa√ß√£o que gerou o bloqueio.
2. Anexa a nota fiscal/recibo.
3. Escolhe a etiqueta correta.
4. Escreve a descri√ß√£o clara ("Chaveiro emergencial - troca fechadura estoque 1234").
5. Depois abre chamado informando que est√° tudo regularizado e pede o desbloqueio.

HTML:<p class="mt-2 text-sm text-slate-700">Link direto:<br>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a></p>`
            );
        }

        function respostaPrazo() {
            return (
`Prazo oficial ‚è±

Voc√™ tem at√© 48 horas depois da compra para:
1. anexar a nota fiscal/recibo,
2. escolher a etiqueta correta,
3. escrever a descri√ß√£o do gasto.

Se isso n√£o estiver feito, o cart√£o pode ser bloqueado preventivamente at√© voc√™ ajustar.`
            );
        }

        function respostaJustificar() {
            return (
`Pra justificar / prestar contas de uma compra na Clara voc√™ precisa fazer 3 coisas em at√© 48h:

1. Anexar o comprovante fiscal
   - Nota fiscal ou recibo.

2. Escolher a etiqueta certa
   - Ex.: "√ÅGUA POT√ÅVEL", "MATERIAL DE INFORM√ÅTICA", "CHAVEIRO EMERGENCIAL", etc.
   - Se a etiqueta n√£o existir ainda, voc√™ pede cria√ß√£o via chamado no ServiceNow.

3. Preencher a descri√ß√£o
   - Explicar objetivamente o gasto ("Teclado PDV loja 1234", "Motoboy urgente pe√ßa vitrine loja 5678").

Sem isso, o cart√£o pode ser bloqueado preventivamente.`
            );
        }

        function respostaJustificarFollowup() {
            return (
`Checklist r√°pido pra justificar certo:

‚Ä¢ Nota fiscal anexada (foto leg√≠vel)
‚Ä¢ Etiqueta coerente:
  - √Ågua ‚Üí "√ÅGUA POT√ÅVEL"
  - Coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"
  - Motoboy urgente ‚Üí "TRANSPORTE / SERVI√áO EMERGENCIAL"
  - Teclado/mouse/cabos ‚Üí "MATERIAL DE INFORM√ÅTICA"
  - Chaveiro emerg√™ncia ‚Üí "CHAVEIRO EMERGENCIAL"

‚Ä¢ Descri√ß√£o clara: "Teclado PDV loja 1234", "Coffee break treinamento VM loja 1234"

Isso evita cobran√ßa e bloqueio.`
            );
        }

        function respostaEmergencia() {
            return (
`"Emerg√™ncia" N√ÉO √© "acabou o limite". üòÖ

√â emerg√™ncia real quando:
1. a loja n√£o consegue operar sem aquele gasto agora
E
2. n√£o d√° pra usar o cart√£o Clara (ex.: falha t√©cnica).

O que fazer ANTES de tirar dinheiro do caixa:
‚Üí abrir chamado no ServiceNow pedindo autoriza√ß√£o excepcional do Financeiro.

HTML:<p class="mt-2 text-sm text-slate-700">Use:<br>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a></p>

Sem autoriza√ß√£o PR√âVIA, n√£o pode tirar dinheiro do caixa e ‚Äúdepois eu acerto‚Äù.`
            );
        }

        function respostaPessoal() {
            return (
`Uso pessoal do cart√£o √© proibido. üö´

Pra corrigir:
1. avisa o Financeiro,
2. marca a transa√ß√£o na Clara como "Despesa Pessoal ‚Äì Uso Indevido",
3. ressarce o valor em at√© 2 dias √∫teis.

Se voc√™ n√£o ressarcir:
‚Ä¢ pode ter desconto em folha,
‚Ä¢ pode gerar medida disciplinar,
‚Ä¢ e o cart√£o pode ser bloqueado definitivamente pra voc√™.`
            );
        }

        function respostaOutraLoja() {
            return (
`Usar cart√£o de outra loja s√≥ pode em situa√ß√£o espec√≠fica:

‚Ä¢ gerente titular saiu / loja ficou sem cart√£o ainda,
‚Ä¢ Financeiro autorizou uso tempor√°rio,
‚Ä¢ voc√™ est√° oficialmente cobrindo.

Obrigat√≥rio:
Na descri√ß√£o da compra escrever:
"Uso tempor√°rio do cart√£o na loja XXXX".

Mudan√ßa de gerente / troca de respons√°vel precisa ser formalizada por chamado para atualizar quem responde pelo cart√£o.

HTML:<p class="mt-2 text-sm text-slate-700">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado de atualiza√ß√£o no ServiceNow</a>
</p>`
            );
        }

        function respostaNotaFiscal() {
            return (
`Mesmo depois de subir a nota fiscal/recibo na plataforma Clara, a loja precisa guardar o documento f√≠sico original.

Prazo: manter guardado por 180 dias corridos.
A √°rea financeira pode pedir esse documento f√≠sico em auditoria.`
            );
        }

        function respostaServiceNowGeral() {
            return (
`HTML:<p class="text-slate-700 text-sm">Esses casos precisam de chamado no ServiceNow üëá</p>

<p class="text-slate-700 text-sm mt-2"><strong>Desbloqueio do cart√£o</strong><br>
‚Üí Financeiro / Contas a Receber<br>
Mensagem sugerida: "Cart√£o bloqueado preventivamente. Presta√ß√£o de contas regularizada. Solicito desbloqueio."</p>

<p class="text-slate-700 text-sm mt-2"><strong>Aumento de limite</strong><br>
‚Üí Financeiro<br>
Mensagem: "Solicita√ß√£o de aumento de limite para despesas operacionais da loja XXXX. Justificativa: ____."</p>

<p class="text-slate-700 text-sm mt-2"><strong>Troca de gerente / respons√°vel</strong><br>
‚Üí Cadastro / Financeiro<br>
Mensagem: "Atualiza√ß√£o de respons√°vel pelo cart√£o Clara: gerente anterior desligado / novo respons√°vel assumindo a loja XXXX."</p>

<p class="text-slate-700 text-sm mt-2"><strong>Criar nova etiqueta/categoria</strong><br>
‚Üí Financeiro / Cont√°bil<br>
Mensagem: "Solicitar inclus√£o de etiqueta para despesa operacional da loja. Descri√ß√£o: ____."</p>

<p class="text-slate-700 text-sm mt-2"><strong>Emerg√™ncia operacional real</strong><br>
Antes de tirar dinheiro do caixa: pedir autoriza√ß√£o excepcional do Financeiro.</p>

<p class="text-slate-700 text-sm mt-4">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a>
</p>

<p class="text-[11px] text-slate-400 italic mt-3">
Abra o chamado ANTES de improvisar tipo "pegar dinheiro do caixa".
</p>`
            );
        }

        function respostaServiceNowContextual(msgNorm) {
            if (
                msgNorm.includes("desbloque") ||
                msgNorm.includes("bloqueou") ||
                msgNorm.includes("bloqueio") ||
                msgNorm.includes("cartao travou") ||
                msgNorm.includes("cartao bloqueado") ||
                msgNorm.includes("como desbloquear")
            ) {
                return respostaBloqueio();
            }

            if (
                msgNorm.includes("etiqueta") ||
                msgNorm.includes("categoria nova") ||
                msgNorm.includes("nova categoria")
            ) {
                return (
`HTML:<p class="text-slate-700 text-sm">Quer usar uma etiqueta que n√£o existe ainda na Clara?</p>

<p class="text-slate-700 text-sm mt-2">
‚Üí Abra chamado no ServiceNow para Financeiro / Cont√°bil pedindo cria√ß√£o de etiqueta.
</p>

<p class="text-slate-700 text-sm mt-2">
Mensagem sugerida:<br>
"Solicitar inclus√£o de etiqueta para despesa operacional da loja. Descri√ß√£o: ____."
</p>

<p class="text-slate-700 text-sm mt-4">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a>
</p>`
                );
            }

            if (
                msgNorm.includes("troca de gerente") ||
                msgNorm.includes("mudanca de gerente") ||
                msgNorm.includes("mudan√ßa de gerente") ||
                msgNorm.includes("gerente desligado") ||
                msgNorm.includes("sem gerente")
            ) {
                return (
`HTML:<p class="text-slate-700 text-sm">Mudou o respons√°vel pelo cart√£o da loja?</p>

<p class="text-slate-700 text-sm mt-2">
Voc√™ precisa abrir chamado no ServiceNow pra atualizar oficialmente quem responde pelo cart√£o.
</p>

<p class="text-slate-700 text-sm mt-2">
Mensagem sugerida:<br>
"Atualiza√ß√£o de respons√°vel pelo cart√£o Clara: gerente anterior desligado / novo respons√°vel assumindo a loja XXXX."
</p>

<p class="text-slate-700 text-sm mt-4">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a>
</p>`
                );
            }

            if (
                msgNorm.includes("limite") ||
                msgNorm.includes("aumento de limite") ||
                msgNorm.includes("limite maior")
            ) {
                return (
`HTML:<p class="text-slate-700 text-sm">Precisa de aumento de limite do cart√£o?</p>

<p class="text-slate-700 text-sm mt-2">
‚Üí Abre chamado no ServiceNow para Financeiro.
</p>

<p class="text-slate-700 text-sm mt-2">
Mensagem sugerida:<br>
"Solicita√ß√£o de aumento de limite para despesas operacionais da loja XXXX. Justificativa: ____."
</p>

<p class="text-slate-700 text-sm mt-4">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a>
</p>

<p class="text-[11px] text-slate-400 italic mt-3">
Importante: limite √© pra despesa operacional, n√£o pra gasto pessoal.
</p>`
                );
            }

            if (
                msgNorm.includes("emergencia") ||
                msgNorm.includes("emerg√™ncia") ||
                msgNorm.includes("urgente") ||
                msgNorm.includes("sangria") ||
                msgNorm.includes("tirar dinheiro do caixa") ||
                msgNorm.includes("pegar dinheiro do caixa")
            ) {
                return (
`HTML:<p class="text-slate-700 text-sm">Emerg√™ncia REAL √©:</p>

<p class="text-slate-700 text-sm mt-2">
1. a loja n√£o consegue operar sem aquele gasto agora<br>
2. o cart√£o Clara n√£o resolve (ex.: falha t√©cnica)
</p>

<p class="text-slate-700 text-sm mt-2">
Antes de tirar dinheiro do caixa:<br>
‚Üí Abre chamado no ServiceNow pedindo autoriza√ß√£o excepcional do Financeiro.
</p>

<p class="text-slate-700 text-sm mt-4">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a>
</p>

<p class="text-[11px] text-slate-400 italic mt-3">
Sem autoriza√ß√£o PR√âVIA, n√£o pode usar dinheiro do caixa.
</p>`
                );
            }

            return respostaServiceNowGeral();
        }

        function respostaPoliticaPDF() {
            return (
`HTML:<p>Segue a <strong>Pol√≠tica de Uso dos Cart√µes Clara</strong> (documento oficial):<br>
<a class="bot-link" href="${POLITICA_PDF_URL}" target="_blank" rel="noopener noreferrer">Abrir Pol√≠tica de Uso dos Cart√µes Clara (PDF)</a>
</p>

<p class="mt-2 text-[13px] text-slate-500">
Esse documento define o que pode, o que n√£o pode, prazos de 48h, bloqueio preventivo, uso pessoal e necessidade de ressarcimento.
</p>`
            );
        }

        function respostaEtiquetaEspecifica(msgNorm) {
            const et = descobrirEtiqueta(msgNorm);
            if (et) {
                return (
`Para esse tipo de gasto use a etiqueta: "${et.etiqueta}".

Descri√ß√£o sugerida:
"${et.exemploDescricao}"

Regras:
‚Ä¢ Anexar a nota fiscal / recibo na Clara
‚Ä¢ Lan√ßar em at√© 48h
‚Ä¢ Guardar o documento f√≠sico na loja por 180 dias

Se essa etiqueta N√ÉO existir ainda na sua lista:
‚Üí Abra chamado pedindo cria√ß√£o de etiqueta.

HTML:<p class="mt-2 text-sm text-slate-700">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow para criar etiqueta</a>
</p>`
                );
            }

            // Se ele perguntou "qual etiqueta", mas n√£o achei nada nos termos:
            return (
`Pra eu indicar etiqueta certinha eu preciso entender o tipo de gasto operacional.

Exemplos que j√° existem:
‚Ä¢ √Ågua / gal√£o ‚Üí "√ÅGUA POT√ÅVEL"
‚Ä¢ Coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"
‚Ä¢ Teclado / mouse / cabo USB / pendrive ‚Üí "MATERIAL DE INFORM√ÅTICA"
‚Ä¢ Materiais tipo caneta / pasta / bloco ‚Üí "MATERIAL DE ESCRIT√ìRIO"
‚Ä¢ Motoboy urgente / sedex ‚Üí "TRANSPORTE / SERVI√áO EMERGENCIAL"
‚Ä¢ Chaveiro pra abrir estoque/cofre ‚Üí "CHAVEIRO EMERGENCIAL"
‚Ä¢ Troca de tomada / reparo simples em ar-condicionado ‚Üí "MANUTEN√á√ÉO (EL√âTRICA / AR)"

Se n√£o tiver nenhuma etiqueta que encaixa, voc√™ abre chamado pedindo cria√ß√£o.

HTML:<p class="mt-2 text-sm text-slate-700">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow para criar etiqueta</a>
</p>`
            );
        }

        function respostaGenerica() {
            return (
`Vamos validar juntos üëá

1. Esse gasto √© realmente operacional da LOJA (necess√°rio pra loja funcionar agora) ‚Äî tipo chaveiro emergencial, √°gua pra equipe, motoboy urgente, material de limpeza, teclado do PDV?

2. Voc√™ consegue nota fiscal/recibo e vai anexar em at√© 48h com a etiqueta correta e descri√ß√£o objetiva?

‚õî N√ÉO pode no cart√£o Clara:
‚Ä¢ gasto pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal etc.)
‚Ä¢ bebida alco√≥lica / comemora√ß√£o / lazer
‚Ä¢ bens patrimoniais / equipamentos grandes (geladeira, micro-ondas, TV etc.)

Se estiver na lista de "n√£o pode", precisa ressarcir (ou nem usar). Se estiver em ‚Äúpode operacional‚Äù, registra certo e dentro do prazo.`
            );
        }

        function respostaFollowupGenerico() {
            return (
`Certo. Me diz qual tipo de gasto voc√™ quer classificar agora üëá

‚Ä¢ √Ågua / lanche pro time em a√ß√£o autorizada?
‚Ä¢ Teclado / mouse / cabo USB / pendrive?
‚Ä¢ Motoboy / sedex urgente?
‚Ä¢ Chaveiro / manuten√ß√£o simples?
‚Ä¢ Uber pessoal?
‚Ä¢ Bebida alco√≥lica?

Assim eu j√° te devolvo etiqueta, se pode usar o cart√£o, e se precisa abrir chamado.`
            );
        }


        //
        // NORMALIZA√á√ÉO / CLASSIFICA√á√ÉO
        //
        function normalize(text) {
            return text
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        function hit(msgNorm, arr) {
            return arr.some(k => msgNorm.includes(normalize(k)));
        }

        function ehPerguntaFollowupCurta(msgNorm) {
            if (msgNorm.length <= 60) {
                const gatilhos = [
                    "como", "e agora", "e fa√ßo o que", "e faco o que",
                    "qual etiqueta", "que etiqueta", "qual categoria",
                    "explica melhor", "me explica", "me ajuda",
                    "o que eu fa√ßo", "o que eu faco", "e depois", "e ai", "e a√≠",
                    "e qual seria", "qual usar", "qual devo usar"
                ];
                return gatilhos.some(g => msgNorm.includes(g));
            }
            return false;
        }

        function classificarPergunta(msg) {
            const m = normalize(msg);

            // inten√ß√£o especial: etiqueta direta
            if (
                termosEtiquetaDireta.some(t => m.includes(normalize(t))) ||
                descobrirEtiqueta(m) // j√° achou mapeamento?
            ) {
                return "etiqueta";
            }

            if (hit(m, categorias.politicaPdf))    return "politicaPdf";
            if (hit(m, categorias.servicenow))     return "servicenow";

            if (hit(m, categorias.bebidaAlcoolica)) return "bebidaAlcoolica";
            if (hit(m, categorias.bloqueio))       return "bloqueio";
            if (hit(m, categorias.justificar))     return "justificar";

            if (hit(m, categorias.eletronicos))      return "eletronicos";
            if (hit(m, categorias.eletrodomesticos)) return "eletrodomesticos";
            if (hit(m, categorias.alimentosEquipe))  return "alimentosEquipe";
            if (hit(m, categorias.transporte))       return "transporte";
            if (hit(m, categorias.manutencaoLoja))   return "manutencaoLoja";
            if (hit(m, categorias.prazo))            return "prazo";
            if (hit(m, categorias.emergencial))      return "emergencia";
            if (hit(m, categorias.pessoal))          return "pessoal";
            if (hit(m, categorias.outraLoja))        return "outraLoja";
            if (hit(m, categorias.notaFiscal))       return "notaFiscal";

            return "generica";
        }

        function gerarResposta(msg) {
            const msgNorm = normalize(msg);

            // 1. follow-up curto? (contexto da √∫ltima inten√ß√£o)
            if (ehPerguntaFollowupCurta(msgNorm) && ultimaIntencaoRespondida) {
                switch (ultimaIntencaoRespondida) {
                    case "transporte":        return respostaTransporteFollowup();
                    case "bloqueio":          return respostaBloqueioFollowup();
                    case "justificar":        return respostaJustificarFollowup();
                    case "alimentosEquipe":   return respostaAlimentosEquipeFollowupAgua(msgNorm);
                    case "manutencaoLoja":    return respostaManutencaoFollowup(msgNorm);
                    case "etiqueta":          return respostaEtiquetaEspecifica(msgNorm);
                    default:                  return respostaFollowupGenerico();
                }
            }

            // 2. pergunta normal
            const tipo = classificarPergunta(msg);

            // guarda a inten√ß√£o pra poss√≠vel follow-up
            ultimaIntencaoRespondida = tipo;

            switch (tipo) {
                case "bebidaAlcoolica":   return respostaBebidaAlcoolica();
                case "eletronicos":       return respostaEletronicos();
                case "eletrodomesticos":  return respostaEletrodomesticos();
                case "alimentosEquipe":   return respostaAlimentosEquipe();
                case "transporte":        return respostaTransporte();
                case "manutencaoLoja":    return respostaManutencao();
                case "bloqueio":          return respostaBloqueio();
                case "prazo":             return respostaPrazo();
                case "justificar":        return respostaJustificar();
                case "emergencia":        return respostaEmergencia();
                case "pessoal":           return respostaPessoal();
                case "outraLoja":         return respostaOutraLoja();
                case "notaFiscal":        return respostaNotaFiscal();
                case "servicenow":        return respostaServiceNowContextual(msgNorm);
                case "politicaPdf":       return respostaPoliticaPDF();
                case "etiqueta":          return respostaEtiquetaEspecifica(msgNorm);
                default:                  return respostaGenerica();
            }
        }


        //
        // RENDER DO CHAT
        //
        const chatWindow = document.getElementById("chatWindow");
        const chatForm = document.getElementById("chatForm");
        const userInput = document.getElementById("userInput");

        function renderUserMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 justify-end";

            const bubble = document.createElement("div");
            bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line";
            bubble.innerText = text;

            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
        }

        function renderTyping() {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 clara-typing";

            const avatar = document.createElement("div");
            avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
            avatar.innerText = "C";

            const bubble = document.createElement("div");
            bubble.className = "typing-bubble px-4 py-3 max-w-[80%] text-[13px]";
            bubble.innerHTML = `
                <span class="dot"></span>
                <span class="dot ml-1"></span>
                <span class="dot ml-1"></span>
                <span class="ml-2 text-slate-500">digitando...</span>
            `;

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);

            chatWindow.appendChild(wrapper);
            scrollToBottom();

            return wrapper;
        }

        // suporta HTML nas respostas do bot
        function renderBotMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3";

            const avatar = document.createElement("div");
            avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
            avatar.innerText = "C";

            const bubble = document.createElement("div");
            bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

            if (text.startsWith("HTML:")) {
                bubble.innerHTML = text.replace(/^HTML:/, "").trim();
            } else {
                bubble.innerText = text;
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);

            chatWindow.appendChild(wrapper);
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        chatForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;

            renderUserMessage(text);
            userInput.value = "";

            const typingEl = renderTyping();

            const answer = gerarResposta(text);

            setTimeout(() => {
                typingEl.remove();
                renderBotMessage(answer);
                scrollToBottom();
            }, 400);
        });
    </script>
</body>
</html>
