<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Assistente Clara | Grupo SBF</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:800px;
        margin:2rem auto;
        display:flex;
        flex-direction:column;
        height:90vh;
    }
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
    }
    .chat-header-inner {
        display:flex;
        flex-direction:row;
        align-items:flex-start;
        justify-content:space-between;
        flex-wrap:wrap;
        row-gap:1rem;
    }

    .chat-header-area {
    background-color: #FFFFFF; /* fundo branco */
    border-top-left-radius: 1rem;
    border-top-right-radius: 1rem;
    border-bottom: 1px solid rgba(0,0,0,.08);
    padding: 1rem 1.25rem;
}

.chat-header-inner {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    position: relative;
}

.chat-header-left {
    width: 100%;
    text-align: center;
    color: #005E27; /* texto verde escuro */
}

.chat-header-left h1 {
    font-size: 1.5rem;
    font-weight: 800;
    color: #005E27; /* texto verde escuro */
    margin-bottom: 0.5rem;
}

.chat-header-left p,
.chat-header-left .examples,
.chat-header-left .policy-note {
    color: #1e293b;
    text-align: center;
    margin-top: 0.5rem;
}

.chat-header-avatar {
    position: absolute;
    top: 0.5rem;
    right: 1rem;
}

.chat-header-avatar img {
    height: 72px;
    width: auto;
    object-fit: contain;
    filter: none; /* remove sombra */
}

    .chat-body {
        flex:1 1 auto;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
    }
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .chat-window {
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
    }

    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;     /* caixa de digita√ß√£o pequena */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbars mais discretos */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links dentro da resposta HTML do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }
</style>
</head>
<body class="text-slate-800">

<div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Assistente Clara | Grupo SBF</h1>
                <p>Pergunte sobre o uso do cart√£o Clara nas lojas.</p>
                <div class="examples">
                </p>
            </div>
            <div class="chat-header-avatar">
                <img src="Gemini_Generated_Image_nzni5znzni5znzni.png" alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

            <!-- Mensagem inicial do bot -->
            <div class="flex items-start gap-3">
                <img
                    src="Gemini_Generated_Image_nzni5znzni5znzni.png"
                    alt="Assistente Clara (rob√¥)"
                    class="h-14 w-auto object-contain flex-shrink-0"
                />
                <div class="bot-bubble px-4 py-3 max-w-[80%] text-sm text-slate-700">
                    <p class="font-semibold text-slate-800 text-base">
                        Ol√°! üëã Eu sou o agente do <b>Grupo SBF</b>.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar direto, tipo:<br/>
                        ‚Ä¢ "Posso comprar mouse?"<br/>
                        ‚Ä¢ "Como aumento o limite?"<br/>
                        ‚Ä¢ "Vou trocar de loja, o que fa√ßo com o cart√£o?"<br/>
                        ‚Ä¢ "Qual etiqueta pra √°gua/mineral?"<br/>
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Se o assunto n√£o tiver rela√ß√£o com a Pol√≠tica de Uso dos Cart√µes da Clara nas lojas eu n√£o estarei apto para responder.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Quer o documento oficial completo?
                        <a class="policy-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
                            Segue a Pol√≠tica de Uso dos Cart√µes Clara
                        </a>.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER / INPUT -->
    <footer class="chat-footer">
        <form id="chatForm" class="w-full">
            <div class="input-shell">
                <textarea id="userInput" placeholder="Digite sua d√∫vida sobre o cart√£o Clara..."></textarea>
                <button type="submit" id="sendBtn">Enviar</button>
            </div>
        </form>
    </footer>

</div>

<script>
// =====================================================
// POL√çTICA (resumo orientador)
// =====================================================
const POLITICA_COMPLETA = `
1. O cart√£o Clara √© o meio oficial para despesas operacionais das lojas.
2. Toda compra tem que ser justificada na plataforma Clara em at√© 48h:
   - etiqueta correta,
   - nota fiscal/recibo anexado,
   - descri√ß√£o objetiva.
3. Despesa pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal, cinema, bebida alco√≥lica etc.) √© proibida.
   - Se acontecer, avisar Financeiro, classificar como "Despesa Pessoal ‚Äì Uso Indevido" e ressarcir em at√© 2 dias √∫teis.
4. Itens patrimoniais/infraestrutura (geladeira, micro-ondas, cafeteira el√©trica, TV, home theater, mesa, cadeira etc.) n√£o entram no cart√£o Clara. Isso segue fluxo de Compras / patrim√¥nio.
5. Lanches/√°gua podem ser pagos pelo cart√£o SOMENTE se forem ligados a opera√ß√£o autorizada:
   - treinamento oficial,
   - a√ß√£o aprovada (VM, regional, diretoria),
   - premia√ß√£o operacional autorizada.
   Usa etiqueta correta e descreve o motivo.
6. Se o gerente saiu e ainda n√£o existe novo gerente, o Financeiro pode autorizar uso tempor√°rio do cart√£o de outra loja.
   - Cada transa√ß√£o precisa ter descri√ß√£o tipo: "Uso tempor√°rio do cart√£o na loja 1234".
7. Aumento de limite: abrir chamado no ServiceNow explicando necessidade operacional e urg√™ncia.
8. Se bloqueou por falta de justificativa, precisa regularizar (nota, etiqueta, descri√ß√£o) para avaliar desbloqueio.
9. Contesta√ß√£o de compra n√£o reconhecida deve ser aberta em at√© 2 dias √∫teis via suporte da Clara, com envolvimento do Financeiro.
10. Sangria de caixa deixa de existir depois que a loja recebe o cart√£o Clara, s√≥ pode ser liberada como exce√ß√£o com autoriza√ß√£o financeira pr√©via.
`;

// =====================================================
// Etiquetas oficiais padronizadas
// Cada item agora tem sempre as mesmas chaves:
// nome, palavrasChave, descricao, observacaoUso
// =====================================================
const etiquetasOficiais = [
    {
        nome: "AGUA POT√ÅVEL",
        palavrasChave: [
            "agua","√°gua","gal√£o","galao","garrafa de agua","garrafa de √°gua",
            "galao de agua","garrafa de √°gua","garrafa de agua"
        ],
        descricao: "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe/loja, quando previsto operacionalmente.",
        observacaoUso: ""
    },
    {
        nome: "LANCHES DE REFEI√á√ïES",
        palavrasChave: [
            "lanche","lanche equipe","lanche da equipe","coffee break","cafe","caf√©",
            "pao","p√£o","bolo","salgado","biscoito","biscoitos","refrigerante",
            "refris","suco","suco natural","suquinho","lanchinho","kit lanche",
            "croissant","torta","doces treinamento","premia√ß√£o","premiacao"
        ],
        descricao: "Lanche / coffee break ligado a treinamento interno oficial, a√ß√£o aprovada (VM, regional, diretoria) ou premia√ß√£o operacional autorizada.",
        observacaoUso: "N√£o cobre almo√ßo pessoal ou lazer particular."
    },
    {
        nome: "MATERIAL DE INFORM√ÅTICA",
        palavrasChave: [
            "mouse","teclado","teclado pdv","cabo usb","cabos","pendrive","pen drive",
            "roteador","hub usb","fonte notebook","fonte","adaptador","cabo rede"
        ],
        descricao: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hub USB, cart√µes de mem√≥ria de baixo valor.",
        observacaoUso: "Serve para manter PDV/opera√ß√£o rodando. N√£o cobre TV, monitor grande, console etc."
    },
    {
        nome: "MATERIAL DE ESCRIT√ìRIO",
        palavrasChave: [
            "caneta","canetas","pasta","pastas","papel","bloco","blocos","caderno",
            "cadernos","etiqueta adesiva","grampeador","organizador de mesa","clips","clipes"
        ],
        descricao: "Canetas, clips, pastas, blocos de anota√ß√£o, grampeadores, etiquetas, organizadores de mesa.",
        observacaoUso: ""
    },
    {
        nome: "MATERIAL DE LIMPEZA",
        palavrasChave: [
            "detergente","desinfetante","sabonete","pano de ch√£o","pano de chao","pano",
            "alcool","√°lcool","papel toalha","vassoura","rodo","limpeza loja"
        ],
        descricao: "Detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc. para uso da loja.",
        observacaoUso: "Materiais para manuten√ß√£o da limpeza da loja."
    },
    {
        nome: "MATERIAL DE COPA E COZINHA",
        palavrasChave: [
            "copo descartavel","copo","talher","talheres","garrafa t√©rmica","garrafa termica",
            "pano de prato","pano prato","filtro de cafe","filtro de caf√©","pote plastico",
            "pote pl√°stico","potes"
        ],
        descricao: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, potes pl√°sticos.",
        observacaoUso: "N√ÉO inclui eletrodom√©stico (cafeteira el√©trica, micro-ondas, etc.)."
    },
    {
        nome: "MANUTEN√á√ÉO EL√âTRICO",
        palavrasChave: [
            "tomada","tomadas","disjuntor","disjuntores","interruptor","interruptores",
            "reator","soquete","soquetes","extensao","extens√£o","fia√ß√£o","fiacao",
            "eletrico","el√©trico"
        ],
        descricao: "Troca de tomadas, disjuntores, interruptores, pequenos reparos de fia√ß√£o de baixa tens√£o.",
        observacaoUso: "Servi√ßos simples e pontuais, baixo valor, para manter a loja operando."
    },
    {
        nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
        palavrasChave: [
            "ar condicionado","ar-condicionado","arcondicionado","limpeza filtro ar",
            "carga de gas ar","controle remoto ar","manutencao ar","manuten√ß√£o ar",
            "controle ar"
        ],
        descricao: "Limpeza de filtro, carga de g√°s, troca de controle remoto ou ajuste simples de ar-condicionado.",
        observacaoUso: "Compra de um ar-condicionado novo n√£o entra."
    },
    {
        nome: "MANUTEN√á√ÉO CIVIL",
        palavrasChave: [
            "parafusar prateleira","arrumar porta","trocar fechadura loja","reparo parede",
            "trocar vidro","ajuste prateleira fixa","conserto parede","manuten√ß√£o civil",
            "manutencao civil"
        ],
        descricao: "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa), exceto chaveiro emergencial.",
        observacaoUso: ""
    },
    {
        nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
        palavrasChave: [
            "conserto impressora etiqueta","manutencao impressora","ajuste maquina estampar",
            "maquina estampar","reparo computador loja","ferramenta manual",
            "manuten√ß√£o equipamentos","manutencao equipamentos"
        ],
        descricao: "Reparo de impressora de etiqueta, m√°quina de estampar, computador fora de garantia, ferramenta manual pequena.",
        observacaoUso: "Equipamento grande/patrimonial n√£o."
    },
    {
        nome: "CHAVEIRO EMERGENCIAL",
        palavrasChave: [
            "chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar segredo",
            "perdi a chave","sem chave cofre"
        ],
        descricao: "Servi√ßo emergencial de chaveiro para abrir cofre, estoque, vitrine.",
        observacaoUso: "Somente emerg√™ncia operacional real."
    },
    {
        nome: "TRANSPORTE SERVI√áOS EMERGENCIAS",
        palavrasChave: [
            "motoboy","moto boy","moto-boy","frete urgente","entrega urgente",
            "pegar documento na matriz","levar documento","sedex urgente","courier",
            "lalamove","lala move","frete local","frete local emergencial"
        ],
        descricao: "Frete local emergencial / motoboy para levar/pegar item ou documento cr√≠tico entre loja e matriz.",
        observacaoUso: "Uber / 99 pessoal n√£o entra aqui. Uber pessoal n√£o pode no cart√£o Clara."
    },
    {
        nome: "CORREIOS_SEDEX/AR/POSTAGEM",
        palavrasChave: [
            "sedex","correios","ar","postagem","envio documento",
            "carta registrada","devolucao correios","devolu√ß√£o correios"
        ],
        descricao: "Envio de documentos f√≠sicos via Sedex/AR/postagem oficial; devolu√ß√µes pequenas.",
        observacaoUso: ""
    },
    {
        nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
        palavrasChave: [
            "banner","adesivo promocional","adesivo","flyer","folder",
            "encadernacao","encaderna√ß√£o","material visual loja",
            "impressao grafica","impress√£o gr√°fica"
        ],
        descricao: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√µes, material visual da loja.",
        observacaoUso: ""
    },
    {
        nome: "BOBINA ECF",
        palavrasChave: [
            "bobina","bobina ecf","bobina fiscal","bobina impressora fiscal",
            "ecf","cupom fiscal","bobina pdv","bobina caixa"
        ],
        descricao: "Bobina para ECF / impressora fiscal / PDV onde n√£o h√° fornecimento centralizado.",
        observacaoUso: ""
    }
];

// =====================================================
// Normaliza√ß√£o
// =====================================================
function normalize(str) {
    return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

// =====================================================
// Inten√ß√£o
// =====================================================
function detectarIntencaoPergunta(msgNorm) {

    // fora de escopo
    const foraEscopoPadroes = [
        "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
        "presidente","futebol","time joga","campeonato","xing","vai tomar",
        "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
        "piada","xingar","palavr√£o","palavrao"
    ];
    for (const termo of foraEscopoPadroes) {
        if (msgNorm.includes(normalize(termo))) {
            return "foraEscopo";
        }
    }

    // etiqueta direta
    if (msgNorm.includes("etiqueta") || msgNorm.includes("qual etiqueta") || msgNorm.includes("que etiqueta")) {
        return "etiqueta";
    }

    // limite
    if (
        msgNorm.includes("aumentar limite") ||
        msgNorm.includes("aumento de limite") ||
        msgNorm.includes("limite maior") ||
        msgNorm.includes("limite do cartao") ||
        msgNorm.includes("limite do cart√£o") ||
        msgNorm.includes("limite nao basta") ||
        msgNorm.includes("limite n√£o basta") ||
        msgNorm.includes("limite acabou") ||
        msgNorm.includes("limite estourou")
    ) {
        return "limite";
    }

    // bloqueio
    if (
        msgNorm.includes("bloqueou") ||
        msgNorm.includes("bloqueado") ||
        msgNorm.includes("desbloquear") ||
        msgNorm.includes("cartao travou") ||
        msgNorm.includes("cart√£o travou") ||
        msgNorm.includes("travou o cartao") ||
        msgNorm.includes("travou o cart√£o") ||
        msgNorm.includes("bloqueio preventivo")
    ) {
        return "bloqueio";
    }

    // presta√ß√£o de contas
    if (
        msgNorm.includes("como justificar") ||
        msgNorm.includes("justificar compra") ||
        msgNorm.includes("prestar contas") ||
        msgNorm.includes("prestacao de contas") ||
        msgNorm.includes("presta√ß√£o de contas") ||
        msgNorm.includes("colocar nota") ||
        msgNorm.includes("anexar nota") ||
        msgNorm.includes("descricao na clara") ||
        msgNorm.includes("descri√ß√£o na clara")
    ) {
        return "prestacao";
    }

    // lanche / √°gua / equipe
    if (
        msgNorm.includes("lanche") ||
        msgNorm.includes("lanche pro time") ||
        msgNorm.includes("lanche para o time") ||
        msgNorm.includes("cafe pro time") ||
        msgNorm.includes("caf√© pro time") ||
        msgNorm.includes("coffee break") ||
        msgNorm.includes("agua") ||
        msgNorm.includes("√°gua") ||
        msgNorm.includes("gal√£o") ||
        msgNorm.includes("galao") ||
        msgNorm.includes("premiacao") ||
        msgNorm.includes("premia√ß√£o")
    ) {
        return "alimentoTime";
    }

    // uber / transporte pessoal
    if (
        msgNorm.includes("uber") ||
        msgNorm.includes("99") ||
        msgNorm.includes("taxi") ||
        msgNorm.includes("t√°xi") ||
        msgNorm.includes("app de transporte")
    ) {
        return "transportePessoal";
    }

    // troca de gerente / transfer√™ncia de loja
    if (
        msgNorm.includes("mudar de loja") ||
        msgNorm.includes("trocar de loja") ||
        msgNorm.includes("vou mudar de loja") ||
        msgNorm.includes("fui transferido") ||
        msgNorm.includes("transferido de loja") ||
        msgNorm.includes("gerente desligado") ||
        msgNorm.includes("sem gerente") ||
        msgNorm.includes("gerente saiu") ||
        msgNorm.includes("gerente saiu da loja") ||
        msgNorm.includes("cartao de outra loja") ||
        msgNorm.includes("cart√£o de outra loja") ||
        msgNorm.includes("usar cartao de outra loja") ||
        msgNorm.includes("usar cart√£o de outra loja")
    ) {
        return "trocaGerente";
    }

    // sangria
    if (
        msgNorm.includes("sangria") ||
        msgNorm.includes("fazer sangria") ||
        msgNorm.includes("puxar dinheiro do caixa") ||
        msgNorm.includes("retirar dinheiro do caixa")
    ) {
        return "sangria";
    }

    // fraude / contesta√ß√£o
    if (
        msgNorm.includes("nao reconheco") ||
        msgNorm.includes("n√£o reconhe√ßo") ||
        msgNorm.includes("fraude") ||
        msgNorm.includes("compra indevida") ||
        msgNorm.includes("compra indevida no cartao") ||
        msgNorm.includes("compra indevida no cart√£o") ||
        msgNorm.includes("contestar compra") ||
        msgNorm.includes("contestacao") ||
        msgNorm.includes("contesta√ß√£o")
    ) {
        return "fraudeContestacao";
    }

    // posso comprar...? posso usar...?
    if (
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("posso usar") ||
        msgNorm.includes("pode usar") ||
        msgNorm.includes("pode pagar") ||
        msgNorm.includes("pode gastar") ||
        msgNorm.includes("pode comprar") ||
        msgNorm.includes("pode no cartao") ||
        msgNorm.includes("pode no cart√£o") ||
        msgNorm.includes("pode colocar no cartao") ||
        msgNorm.includes("pode colocar no cart√£o")
    ) {
        return "podeNaoPode";
    }

    return "generica";
}

// =====================================================
// Achar etiqueta mais aderente
// (ajustada: procura termo inteiro dentro da mensagem normalizada)
// =====================================================
function acharEtiquetaPorMensagem(msgNorm) {
    const palavras = msgNorm.split(/\s+/);
    for (const et of etiquetasOficiais) {
        for (const termo of et.palavrasChave) {
            const termoNorm = normalize(termo);
            if (palavras.includes(termoNorm)) {
                return et;
            }
            // tamb√©m tenta includes simples pra termos compostos tipo "coffee break"
            if (msgNorm.includes(termoNorm)) {
                return et;
            }
        }
    }
    return null;
}

// =====================================================
// Avaliar compra espec√≠fica
// =====================================================
function avaliarCompraEspecifica(msgNorm) {
    // proibidos patrimoniais / infraestrutura
    const itensPatrimoniaisGrandes = [
        "geladeira","frigobar","microondas","micro-ondas","micro ondas",
        "cafeteira","cafeteira eletrica","cafeteira el√©trica","bebedouro",
        "ar condicionado novo","ar-condicionado novo","tv","televisao","televis√£o",
        "monitor","home theater","soundbar","som", "fogao", "fog√£o",
        "console ps5","ps5","playstation",
        "mesa","mesa escritorio","mesa de escritorio",
        "cadeira","cadeira escritorio","cadeira de escritorio",
        "estacao de trabalho","esta√ß√£o de trabalho",
        "movel","m√≥vel","mobilia","mob√≠lia","mobiliario","mobili√°rio",
        "armario","arm√°rio","balcao","balc√£o"
    ];
    for (const proib of itensPatrimoniaisGrandes) {
        if (msgNorm.includes(normalize(proib))) {
            return {
                pode: false,
                tipo: "PATRIMONIAL",
                resposta: `‚ùå N√£o pode usar o cart√£o Clara. Itens como TV, home theater, geladeira, micro-ondas, mesa, cadeira etc. s√£o considerados patrim√¥nio / infraestrutura. Isso n√£o entra como despesa operacional imediata da loja. Deve seguir o fluxo de Compras / patrim√¥nio, n√£o o cart√£o Clara.`
            };
        }
    }

    // uso pessoal / lazer pessoal
    if (
        msgNorm.includes("uber") ||
        msgNorm.includes("99") ||
        msgNorm.includes("taxi") ||
        msgNorm.includes("t√°xi") ||
        msgNorm.includes("cinema") ||
        msgNorm.includes("pipoca") ||
        msgNorm.includes("roupa pro meu filho") ||
        msgNorm.includes("pro meu filho") ||
        msgNorm.includes("pra mim") ||
        msgNorm.includes("pessoal")
    ) {
        return {
            pode: false,
            tipo: "PESSOAL",
            resposta: `‚ùå N√£o pode. Transporte pessoal, refei√ß√£o pessoal, lazer (cinema, pipoca), compra pra uso pr√≥prio ou pra fam√≠lia n√£o √© despesa operacional da loja. Se j√° usou o cart√£o, precisa avisar o Financeiro e ressarcir em at√© 2 dias √∫teis. Pode haver bloqueio do cart√£o se n√£o regularizar.`
        };
    }

    // bebida alco√≥lica
    if (
        msgNorm.includes("cerveja") ||
        msgNorm.includes("vinho") ||
        msgNorm.includes("whisky") ||
        msgNorm.includes("vodka") ||
        msgNorm.includes("cacha√ßa") ||
        msgNorm.includes("alcool") ||
        msgNorm.includes("√°lcool")
    ) {
        return {
            pode: false,
            tipo: "ALCOOL",
            resposta: `‚ùå N√£o pode comprar bebida alco√≥lica com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.`
        };
    }

    // lanche / suco / p√£o -> pol√≠tica de lanche autorizado
    const termosLancheOperacional = [
        "lanche","pao","p√£o","bolo","salgado","biscoito","biscoitos","cafe","caf√©",
        "suco","refrigerante","agua","√°gua","coffee break","lanchinho","kit lanche",
        "croissant","torta","doces treinamento","premia√ß√£o","premiacao"
    ];
    for (const t of termosLancheOperacional) {
        if (msgNorm.includes(normalize(t))) {
            return {
                pode: true,
                tipo: "LANCHES DE REFEI√á√ïES",
                resposta:
`‚úÖ Pode usar o cart√£o Clara SE for lanche/coffee break ligado a uma atividade operacional autorizada da loja (treinamento oficial, a√ß√£o aprovada pela regional/VM/diretoria ou premia√ß√£o operacional autorizada).
Etiqueta: "LANCHES DE REFEI√á√ïES".
Como lan√ßar:
‚Ä¢ Anexar a nota fiscal (leg√≠vel);
‚Ä¢ Selecionar "LANCHES DE REFEI√á√ïES";
‚Ä¢ Descrever: "Coffee break treinamento VM loja 1234";
‚Ä¢ Lan√ßar na Clara em at√© 48h.
‚ùå N√£o pode para consumo pessoal/lazer particular (almo√ßo pessoal, lanche pra casa etc.).`
            };
        }
    }

    // tenta mapear etiqueta autorizada tipo mouse/teclado/motoboy/etc
    const etiquetaDetectada = acharEtiquetaPorMensagem(msgNorm);
    if (etiquetaDetectada) {
        return {
            pode: true,
            tipo: etiquetaDetectada.nome,
            resposta:
`‚úÖ Pode usar o cart√£o Clara, porque √© uma despesa operacional da loja.
Etiqueta: "${etiquetaDetectada.nome}".
O que cobre: ${etiquetaDetectada.descricao}
${etiquetaDetectada.observacaoUso ? `Obs: ${etiquetaDetectada.observacaoUso}` : ""}
Como lan√ßar (at√© 48h):
‚Ä¢ Anexar a nota fiscal/recibo;
‚Ä¢ Selecionar "${etiquetaDetectada.nome}";
‚Ä¢ Descrever de forma objetiva (ex.: "Teclado PDV loja 1234");
‚Ä¢ Guardar o documento f√≠sico na loja por pelo menos 180 dias.`
        };
    }

    // n√£o mapeado
    return {
        pode: null,
        tipo: "NAO_MAPEADO",
        resposta:
`Preciso entender melhor o contexto:
‚Ä¢ Isso √© algo necess√°rio pro funcionamento imediato da loja (manuten√ß√£o emergencial, material de limpeza, perif√©rico de PDV, √°gua/equipe autorizada, motoboy urgente)?
‚Ä¢ Ou √© algo pessoal / patrim√¥nio / mobili√°rio?
Se for despesa operacional imediata da loja, com nota fiscal e justificativa em at√© 48h na Clara, normalmente pode.
Se for uso pessoal, bebida alco√≥lica ou patrim√¥nio (mesa, cadeira, TV, geladeira etc.), n√£o pode.`
    };
}

// =====================================================
// Respostas por inten√ß√£o
// =====================================================
function respostaForaEscopo() {
    return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
}

function respEtiquetaDireta(et) {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nome}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.descricao}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}
<p class="mt-2">
Lan√ßar na Clara em at√© 48h:<br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar "${et.nome}";<br/>
3. Descrever objetivamente o gasto (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar o documento f√≠sico na loja por pelo menos 180 dias.
</p>
</div>`;
}

function respLimite() {
    return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ qual gasto precisa fazer,<br>‚Ä¢ urg√™ncia,<br>‚Ä¢ por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
}

function respBloqueio() {
    return `HTML:<p class="text-sm text-slate-700">
Bloqueio preventivo acontece quando tem compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
‚Ä¢ faltou nota fiscal/recibo,<br/>
‚Ä¢ n√£o colocou etiqueta correta,<br/>
‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
Passos pra desbloquear:<br/>
1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolhe etiqueta certa, descreve o motivo real).<br/>
2. Avise o Financeiro que j√° foi ajustado.<br/><br/>
Reincid√™ncia pode fazer a loja perder permiss√£o de uso do cart√£o.
</p>`;
}

function respPrestacaoContas() {
    return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 180 dias corridos. N√£o justificar no prazo => risco de bloqueio preventivo.
</p>`;
}

function respAlimentoTime() {
    return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
}

function respTransportePessoal() {
    return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja.<br/><br/>
Se j√° usou:<br/>
‚Ä¢ comunicar o Financeiro imediatamente,<br/>
‚Ä¢ classificar como "Despesa Pessoal ‚Äì Uso Indevido" na plataforma,<br/>
‚Ä¢ ressarcir o valor √† empresa em at√© 2 dias √∫teis.<br/><br/>
Falta de regulariza√ß√£o pode gerar bloqueio e at√© desconto em folha.
</p>`;
}

function respTrocaGerente() {
    return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja segue assim:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja.<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234".<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado,<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Se tiver caso especial, fale com o Financeiro e, se preciso, abra chamado no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>.
</p>`;
}

function respSangria() {
    return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© DESCONTINUADO.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
}

function respFraudeContestacao() {
    return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente.<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o.<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal, a√≠ precisa ressarcir em at√© 2 dias √∫teis; n√£o √© contesta√ß√£o.
</p>`;
}

// fallback contextual
function respGenerica(msgNorm) {
    const avaliacao = avaliarCompraEspecifica(msgNorm);

    // se √© claramente proibido
    if (avaliacao.pode === false) {
        return `HTML:<p class="text-sm text-slate-700">
<b>N√£o pode usar o cart√£o Clara pra isso.</b><br/>
${avaliacao.resposta}<br/><br/>
Se j√° caiu no cart√£o, precisa avisar o Financeiro, marcar como "Despesa Pessoal ‚Äì Uso Indevido" e ressarcir em at√© 2 dias √∫teis. Falta de regulariza√ß√£o pode manter o cart√£o bloqueado.
</p>`;
    }

    // se √© claramente permitido e temos etiqueta
    if (avaliacao.pode === true) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p class="mt-1">${avaliacao.resposta}</p>
</div>`;
    }

    // n√£o deu pra classificar com precis√£o
    return `HTML:<p class="text-sm text-slate-700">
Para poder usar o cart√£o Clara, o gasto precisa ser algo operacional imediato da loja (chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal etc.) e voc√™ precisa lan√ßar na Clara em at√© 48h (nota fiscal, etiqueta correta e descri√ß√£o objetiva).<br/><br/>
N√£o pode ser gasto pessoal, bebida alco√≥lica, Uber pessoal ou item patrimonial/infraestrutura (geladeira, micro-ondas, TV, mesa, cadeira etc.). Isso segue Compras ou precisa ressarcir.
</p>`;
}

// =====================================================
// Follow-up inteligente
// =====================================================
let ultimaIntencao = null;

function respFollowup(msgNorm) {
    if (ultimaIntencao === "limite") return respLimite();
    if (ultimaIntencao === "bloqueio") return respBloqueio();
    if (ultimaIntencao === "prestacao") return respPrestacaoContas();
    if (ultimaIntencao === "alimentoTime") return respAlimentoTime();
    if (ultimaIntencao === "transportePessoal") return respTransportePessoal();
    if (ultimaIntencao === "trocaGerente") return respTrocaGerente();
    if (ultimaIntencao === "sangria") return respSangria();
    if (ultimaIntencao === "fraudeContestacao") return respFraudeContestacao();
    return respGenerica(msgNorm);
}

// =====================================================
// Motor principal de resposta
// =====================================================
function gerarRespostaDoBot(msgUsuario) {
    const norm = normalize(msgUsuario);
    const intencao = detectarIntencaoPergunta(norm);
    let resposta;

     // üéØ INTEN√á√ÉO: LIMITE DO CART√ÉO
if (norm.includes("limite")) {
    return `HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.`;
}

    switch (intencao) {
        case "foraEscopo":
            ultimaIntencao = "foraEscopo";
            resposta = respostaForaEscopo();
            break;

        case "etiqueta":
            ultimaIntencao = "etiqueta";
            {
                const et = acharEtiquetaPorMensagem(norm);
                if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
N√£o achei uma etiqueta √≥bvia s√≥ pelo texto. Se realmente n√£o existir nenhuma etiqueta adequada na Clara para esse gasto operacional, voc√™ deve abrir um chamado solicitando cria√ß√£o de etiqueta no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>.
</p>`;
                }
            }
            break;

        case "limite":
            ultimaIntencao = "limite";
            resposta = respLimite();
            break;

        case "bloqueio":
            ultimaIntencao = "bloqueio";
            resposta = respBloqueio();
            break;

        case "prestacao":
            ultimaIntencao = "prestacao";
            resposta = respPrestacaoContas();
            break;

        case "alimentoTime":
            ultimaIntencao = "alimentoTime";
            resposta = respAlimentoTime();
            break;

        case "transportePessoal":
            ultimaIntencao = "transportePessoal";
            resposta = respTransportePessoal();
            break;

        case "trocaGerente":
            ultimaIntencao = "trocaGerente";
            resposta = respTrocaGerente();
            break;

        case "sangria":
            ultimaIntencao = "sangria";
            resposta = respSangria();
            break;

        case "fraudeContestacao":
            ultimaIntencao = "fraudeContestacao";
            resposta = respFraudeContestacao();
            break;

        case "podeNaoPode":
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;

        case "generica":
        default:
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;
    }

    return resposta;
}

// =====================================================
// Renderiza√ß√£o das mensagens no chat
// =====================================================
const chatWindow = document.getElementById("chatWindow");
const chatForm = document.getElementById("chatForm");
const userInput = document.getElementById("userInput");

function scrollToBottom() {
    requestAnimationFrame(() => {
        chatWindow.scrollTop = chatWindow.scrollHeight;
        // garante 100% que desce at√© o fim
        setTimeout(() => {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }, 150);
    });
}

function renderUserMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start justify-end gap-3";

    const bubble = document.createElement("div");
    bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
    bubble.innerText = text;

    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

function renderBotMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start gap-3";

    const avatar = document.createElement("img");
    avatar.src = "Gemini_Generated_Image_nzni5znzni5znzni.png";
    avatar.alt = "Assistente Clara (rob√¥)";
    avatar.className = "h-14 w-auto object-contain flex-shrink-0";

    const bubble = document.createElement("div");
    bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

    if (text.startsWith("HTML:")) {
        bubble.innerHTML = text.replace(/^HTML:/, "").trim();
    } else {
        bubble.innerText = text;
    }

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

// =====================================================
// Envio de mensagem
// =====================================================
function enviarMensagem() {
    const pergunta = userInput.value.trim();
    if (!pergunta) return;

    renderUserMessage(pergunta);

    const resposta = gerarRespostaDoBot(pergunta);
    renderBotMessage(resposta);

    userInput.value = "";
    userInput.focus();
}

// Enter (sem Shift) envia; Shift+Enter quebra linha
userInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
        if (e.shiftKey) {
            return; // deixa quebrar linha
        }
        e.preventDefault();
        enviarMensagem();
    }
});

// bot√£o Enviar (submit do form)
chatForm.addEventListener("submit", function (e) {
    e.preventDefault();
    enviarMensagem();
});
</script>

</body>
</html>










