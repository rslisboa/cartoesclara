<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Assistente Clara | Grupo SBF</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background-color:#f4f7fa; }
    .chat-wrapper { background:white; border-radius:1rem; box-shadow:0 25px 50px -12px rgba(0,0,0,.25); border:1px solid rgba(0,0,0,.05); max-width:800px; margin:2rem auto; display:flex; flex-direction:column; height:80vh; }
    .chat-header-area { background-color:#FFFFFF; border-top-left-radius:1rem; border-top-right-radius:1rem; border-bottom:1px solid rgba(0,0,0,.08); padding:1rem 1.25rem; }
    .chat-header-inner { display:flex; flex-direction:row; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; row-gap:1rem; }
    .chat-header-left { color:#005E27; max-width:560px; }
    .chat-header-left h1 { font-size:1rem; font-weight:700; line-height:1.4; color:#005E27; text-transform:none; text-align:left; }
    .chat-header-left p { font-size:.8rem; line-height:1.4; color:#005E27; margin-top:.5rem; text-align:left; }
    .chat-header-left .examples { font-size:.75rem; line-height:1.4; font-weight:500; background-color:rgba(0,0,0,0.05); color:#005E27; display:inline-block; padding:.5rem .75rem; border-radius:.5rem; margin-top:.75rem; }
    .chat-header-left .policy-note { font-size:.7rem; line-height:1.4; color:#005E27; margin-top:.75rem; font-style:italic; }
    .chat-header-avatar { display:flex; align-items:flex-start; justify-content:flex-end; min-width:96px; }
    .chat-header-avatar img { height:72px; width:auto; object-fit:contain; filter:drop-shadow(0 8px 8px rgba(0,0,0,0.25)); }

    .chat-body { flex:1 1 auto; overflow-y:auto; padding:1rem 1.25rem; background-color:#fff; }
    .chat-footer { border-top:1px solid rgba(0,0,0,.08); padding:1rem 1.25rem; background-color:#f8fafc; border-bottom-left-radius:1rem; border-bottom-right-radius:1rem; }

    .chat-window { display:flex; flex-direction:column; gap:1rem; font-size:.9rem; line-height:1.4; color:#1e293b; }

    .bot-bubble { background-color:#f1f5f9; border:1px solid rgba(0,0,0,.05); border-radius:.75rem; color:#1e293b; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); }
    .user-bubble { background-color:#005E27; color:#fff; border-radius:.75rem; border:1px solid rgba(0,0,0,.2); box-shadow:0 10px 15px -3px rgba(0,0,0,0.2); }

    .service-link { color:#005E27; font-weight:600; text-decoration:underline; }
    .policy-link { color:#005E27; font-weight:600; text-decoration:underline; }

    .input-shell { background-color:#fff;border:1px solid rgba(0,0,0,.12);border-radius:.75rem;display:flex;align-items:flex-start;gap:.75rem;padding:.75rem 1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.08); }
    .input-shell textarea {
    flex:1 1 auto;
    resize:none;
    min-height:80px;      /* antes era 48px */
    max-height:200px;     /* antes era 120px */
    font-size:1rem;       /* um pouquinho maior */
    line-height:1.5;
    color:#1e293b;
    outline:none;
    border:none;
}
    .input-shell button { background-color:#005E27;color:#fff;border:none;border-radius:.5rem;font-size:.8rem;font-weight:600;padding:.6rem .9rem;line-height:1.2;white-space:nowrap;cursor:pointer; }

    /* scrollbars mais discretos */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* link format inside bot HTML answer */
    .bot-bubble a { color:#005E27; font-weight:600; text-decoration:underline; }

    @media (max-width:640px){
        .chat-wrapper{height:90vh;border-radius:0;box-shadow:none;border:0;max-width:none;margin:0;}
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }
</style>
</head>
<body class="text-slate-800">

<div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Assistente Clara | Grupo SBF</h1>
                <p>Pergunte sobre o uso do cart√£o Clara nas lojas.</p>
                <div class="examples">
                    Ex: "Posso comprar micro-ondas?" ‚Ä¢ "Uber pode?" ‚Ä¢ "Travou o cart√£o, fa√ßo o qu√™?"
                </div>
                <p class="policy-note">
                    Minhas respostas seguem a Pol√≠tica de Uso dos Cart√µes Clara.
                    Em conflito, vale sempre o documento oficial da empresa.
                </p>
            </div>
            <div class="chat-header-avatar">
                <img src="Gemini_Generated_Image_nzni5znzni5znzni.png" alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

            <!-- Mensagem inicial do bot -->
            <div class="flex items-start gap-3">
                <img
                    src="Gemini_Generated_Image_nzni5znzni5znzni.png"
                    alt="Assistente Clara (rob√¥)"
                    class="h-10 w-auto object-contain flex-shrink-0"
                />
                <div class="bot-bubble px-4 py-3 max-w-[80%] text-sm text-slate-700">
                    <p class="font-semibold text-slate-800 text-base">
                        Ol√°! üëã Eu sou o agente do <b>Grupo SBF</b>.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar direto, tipo:<br/>
                        ‚Ä¢ "Posso comprar mouse?"<br/>
                        ‚Ä¢ "Como aumento o limite?"<br/>
                        ‚Ä¢ "Vou trocar de loja, o que fa√ßo com o cart√£o?"<br/>
                        ‚Ä¢ "Qual etiqueta pra √°gua/mineral?"<br/>
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Se o assunto n√£o tiver rela√ß√£o com a Pol√≠tica de Uso dos Cart√µes Clara nas lojas
                        (ex.: futebol, xingamento, pol√≠tica, matem√°tica geral), eu n√£o respondo.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Quer o documento oficial completo?
                        <a class="policy-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
                            Segue a Pol√≠tica de Uso dos Cart√µes Clara
                        </a>.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER / INPUT -->
    <footer class="chat-footer">
        <form id="chatForm" class="w-full">
            <div class="input-shell">
                <textarea id="userInput" placeholder="Digite sua d√∫vida sobre o cart√£o Clara..." ></textarea>
                <button type="submit" id="sendBtn">Enviar</button>
            </div>
        </form>
    </footer>

</div>

<script>
// =====================================================
// üîÅ POL√çTICA COMPLETA (base de conhecimento interna)
// Observa√ß√£o: Texto consolidado da pol√≠tica fornecida.
// Esse conte√∫do alimenta respostas de procedimento.
// =====================================================

const POLITICA_COMPLETA = `
Pol√≠tica de Uso dos Cart√µes Clara nas Lojas
[...RESUMO ESTRUTURADO DA POL√çTICA BASEADO NO DOCUMENTO QUE VOC√ä FORNECEU...]

1. Objetivo
O cart√£o Clara √© o meio oficial para despesas operacionais das lojas do Grupo SBF (Centauro e Fisia). A pol√≠tica define limites, obriga√ß√µes de presta√ß√£o de contas, itens permitidos e proibidos, e consequ√™ncias de uso indevido.

2. Substitui√ß√£o da sangria
Ap√≥s implanta√ß√£o do cart√£o Clara e treinamento, a loja deixa de usar sangria em dinheiro para pagar despesas operacionais. O PDV e o fluxo de sangria na intranet s√£o bloqueados. S√≥ em caso excepcional (falha t√©cnica no cart√£o ou impossibilidade real de uso imediato) e com autoriza√ß√£o pr√©via do Financeiro √© que pode haver libera√ß√£o pontual de sangria. Isso √© exce√ß√£o e precisa ser justificado.

3. Presta√ß√£o de contas
Toda transa√ß√£o no cart√£o tem que ser justificada na plataforma Clara em at√© 48h:
- escolher a etiqueta correta (ver Anexo / Tabela de Etiquetas),
- anexar nota fiscal ou recibo,
- descrever objetivamente o gasto.
N√£o entregar a justificativa no prazo pode levar ao bloqueio preventivo do cart√£o, at√© a regulariza√ß√£o. A documenta√ß√£o f√≠sica (notas/recibos) deve ficar guardada na loja por, no m√≠nimo, 90 dias corridos.

4. Bloqueio preventivo
O financeiro monitora as compras diariamente. Se houver compra sem justificativa adequada (sem nota, sem etiqueta correta, sem descri√ß√£o coerente), o cart√£o pode ser bloqueado preventivamente at√© regularizar. A reincid√™ncia pode fazer a loja perder elegibilidade de uso do cart√£o.

5. Uso pessoal / despesa proibida
√â proibido usar o cart√£o para despesas pessoais, lazer, alimenta√ß√£o pessoal, bebidas alco√≥licas, presentes pessoais, transporte pessoal (Uber/99 para deslocamento pessoal), etc. Se acontecer:
- o portador deve avisar imediatamente o Financeiro,
- classificar a transa√ß√£o como ‚ÄúDespesa Pessoal ‚Äì Uso Indevido‚Äù,
- ressarcir o valor √† empresa em at√© 2 dias √∫teis.
Se n√£o reconhecer e n√£o ressarcir, a empresa pode aplicar medidas disciplinares, desconto em folha, bloquear definitivamente o cart√£o dessa loja e abrir procedimento interno.

6. Itens patrimoniais / bens de infraestrutura
Compra de itens como geladeira, micro-ondas, cafeteira el√©trica, TV, mobili√°rio fixo (mesa, cadeira, balc√£o, arm√°rio), equipamentos de grande porte ou bens que configuram patrim√¥nio n√£o deve ser feita com o cart√£o Clara. Isso segue fluxo de Compras / patrim√¥nio, n√£o √© gasto operacional emergencial.

7. Limite do cart√£o
O cart√£o tem limite mensal definido pela √°rea financeira com base na opera√ß√£o da loja. Se precisar de aumento de limite (por necessidade operacional real), o respons√°vel deve abrir chamado no ServiceNow explicando a justificativa e urg√™ncia. A aprova√ß√£o √© financeira.

8. Troca de gerente / uso provis√≥rio de cart√£o de outra loja
Se o gerente titular foi desligado e ainda n√£o h√° um novo gerente para a loja, o Financeiro pode autorizar temporariamente o uso do cart√£o de outra loja.
Obrigat√≥rio: em cada transa√ß√£o, no campo de descri√ß√£o da plataforma Clara, escrever claramente qual loja est√° sendo beneficiada. Exemplo:
"Uso tempor√°rio do cart√£o na loja 1234."
Isso garante a aloca√ß√£o correta do custo.
Em caso de f√©rias/afastamento tempor√°rio do gerente, normalmente o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der ou supervisor autorizado; n√£o √© para circular cart√£o entre lojas sem autoriza√ß√£o financeira.

9. Situa√ß√µes excepcionais
- Cart√£o bloqueado preventivamente por falta de justificativa: precisa regularizar nota/etiqueta/descri√ß√£o na Clara. Depois de regularizado, o financeiro avalia o desbloqueio.
- Falha t√©cnica do cart√£o: comunicar o Financeiro antes de assumir qualquer despesa por outro meio. Pode haver libera√ß√£o pontual e tempor√°ria (ex.: sangria excepcional em Centauro) somente ap√≥s aprova√ß√£o.
- Contesta√ß√£o de compra n√£o reconhecida (suspeita de fraude): deve ser aberta imediatamente via suporte da Clara em at√© 2 dias √∫teis. Durante an√°lise, o cart√£o pode ficar bloqueado.

10. Responsabilidade
O portador do cart√£o responde por:
- uso correto,
- justificar todas as transa√ß√µes em at√© 48h,
- anexar comprovantes,
- guardar documentos f√≠sicos,
- n√£o usar o cart√£o para despesas pessoais.
O Financeiro acompanha diariamente, cobra regulariza√ß√£o e pode bloquear.

11. Etiquetas (Anexo I)
Cada compra precisa ser lan√ßada com a etiqueta correta. Exemplos:
- "AGUA POT√ÅVEL": gal√µes de √°gua mineral para equipe / loja, quando previsto e autorizado.
- "LANCHES DE REFEI√á√ïES": coffee break autorizado, lanche de treinamento oficial, a√ß√£o aprovada pela regional/diretoria.
- "MATERIAL DE INFORM√ÅTICA": mouse, teclado, cabo USB, pendrive, roteador de baixo valor, hub USB, etc. (sem controle patrimonial).
- "MATERIAL DE ESCRIT√ìRIO": caneta, pasta, bloquinho, grampeador etc.
- "MATERIAL DE LIMPEZA": desinfetante, pano de ch√£o, detergente, papel-toalha para uso da loja etc.
- "MANUTEN√á√ÉO EL√âTRICO": tomada, disjuntor, interruptor, ajuste simples de fia√ß√£o baixa tens√£o.
- "CHAVEIRO EMERGENCIAL": abrir cofre, estoque, vitrine em caso emergencial.
- "TRANSPORTE SERVI√áOS EMERGENCIAS": motoboy / frete emergencial para levar/pegar item cr√≠tico entre loja e matriz.
- "SERVI√áOS GR√ÅFICOS E DE COPIADORAS": impress√£o de banners, adesivos promocionais, folders, etc.
- "CORREIOS_SEDEX/AR/POSTAGEM": envios urgentes ou devolu√ß√µes via Correios.
- "MANUTEN√á√ÉO AR-CONDICIONADO": limpeza simples de filtro, carga de g√°s, troca de controle remoto etc.

12. Prazos
Regra central: justificativa completa (etiqueta + nota fiscal/recibo + descri√ß√£o objetiva) em at√© 48h depois da compra. N√£o justificar ‚Üí risco de bloqueio preventivo.

13. ServiceNow
ServiceNow √© o canal oficial para:
- pedir aumento de limite,
- solicitar cria√ß√£o de nova etiqueta quando n√£o existir etiqueta adequada,
- reportar caso emergencial que necessite exce√ß√£o operacional aprovada pelo Financeiro.
Abrir via:
https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6
`;

// =====================================================
// üè∑Ô∏è Etiquetas oficiais / categorias permitidas
// =====================================================

const etiquetasOficiais = [
    {
        nomeEtiqueta: "AGUA POT√ÅVEL",
        palavrasChave: ["agua", "√°gua", "gal√£o", "galao", "garrafa", "√°gua mineral", "agua mineral", "bebedouro"],
        gastosAtrelados: "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe ou clientes, quando previsto e autorizado operacionalmente.",
        observacaoUso: "Uso pessoal/lazer n√£o entra aqui. √â para abastecimento da loja/treinamento autorizado."
    },
    {
        nomeEtiqueta: "LANCHES DE REFEI√á√ïES",
        palavrasChave: ["lanche", "coffee break", "cafe", "caf√©", "refei√ß√£o equipe", "lanchinho", "premia√ß√£o", "premiacao", "a√ß√£o vm", "acao vm", "treinamento", "treinamento interno", "time vm"],
        gastosAtrelados: "Coffee break autorizado, lanche de treinamento interno oficial, premia√ß√£o operacional aprovada, a√ß√£o autorizada pela regional/diretoria.",
        observacaoUso: "Alimenta√ß√£o pessoal, lazer, pipoca cinema, comemora√ß√£o particular N√ÉO pode no cart√£o."
    },
    {
        nomeEtiqueta: "MATERIAL DE INFORM√ÅTICA",
        palavrasChave: ["mouse","teclado","teclado pdv","cabo usb","cabos","pendrive","pen drive","roteador","hub usb","fonte notebook","fonte","adaptador","cabo rede"],
        gastosAtrelados: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria de baixo valor (sem controle patrimonial).",
        observacaoUso: "√â para manter o PDV / opera√ß√£o rodando. N√£o cobre compra de TV, monitor grande, console etc."
    },
    {
        nomeEtiqueta: "MATERIAL DE ESCRIT√ìRIO",
        palavrasChave: ["caneta","canetas","pasta","pastas","papel","bloco","blocos","caderno","cadernos","etiqueta adesiva","grampeador","organizador de mesa"],
        gastosAtrelados: "Canetas, clips, pastas, blocos de anota√ß√£o, grampeadores, etiquetas, organizadores de mesa.",
        observacaoUso: ""
    },
    {
        nomeEtiqueta: "MATERIAL DE LIMPEZA",
        palavrasChave: ["detergente","desinfetante","sabonete","pano de ch√£o","pano de chao","pano","alcool","√°lcool","papel toalha","vassoura","rodo","limpeza loja"],
        gastosAtrelados: "Detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc. para uso da loja.",
        observacaoUso: ""
    },
    {
        nomeEtiqueta: "MATERIAL DE COPA E COZINHA",
        palavrasChave: ["copo descartavel","copo","talher","talheres","garrafa t√©rmica","garrafa termica","pano de prato","pano prato","filtro de cafe","filtro de caf√©","pote plastico","pote pl√°stico","potes"],
        gastosAtrelados: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, potes pl√°sticos. (N√£o inclui eletrodom√©stico como cafeteira el√©trica, micro-ondas etc.)",
        observacaoUso: "Eletrodom√©stico √© patrim√¥nio/infraestrutura -> n√£o entra no cart√£o."
    },
    {
        nomeEtiqueta: "MANUTEN√á√ÉO EL√âTRICO",
        palavrasChave: ["tomada","tomadas","disjuntor","disjuntores","interruptor","interruptores","reator","soquete","soquetes","extensao","extens√£o","fia√ß√£o","fiacao","eletrico","el√©trico"],
        gastosAtrelados: "Troca de tomadas, disjuntores, interruptores, pequenos reparos de fia√ß√£o de baixa tens√£o.",
        observacaoUso: "Servi√ßos simples e pontuais, baixo valor, para manter a loja operando."
    },
    {
        nomeEtiqueta: "MANUTEN√á√ÉO AR-CONDICIONADO",
        palavrasChave: ["ar condicionado","ar-condicionado","arcondicionado","limpeza filtro ar","carga de gas ar","controle remoto ar","manutencao ar","manuten√ß√£o ar"],
        gastosAtrelados: "Limpeza de filtro, carga de g√°s, troca de controle remoto ou ajuste simples de ar-condicionado.",
        observacaoUso: "Compra de um novo equipamento grande n√£o entra."
    },
    {
        nomeEtiqueta: "MANUTEN√á√ÉO CIVIL",
        palavrasChave: ["parafusar prateleira","arrumar porta","trocar fechadura loja","reparo parede","trocar vidro","ajuste prateleira fixa","conserto parede","manuten√ß√£o civil","manutencao civil"],
        gastosAtrelados: "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa), exceto chaveiro emergencial.",
        observacaoUso: ""
    },
    {
        nomeEtiqueta: "MANUTEN√á√ÉO EQUIPAMENTOS",
        palavrasChave: ["conserto impressora etiqueta","manutencao impressora","ajuste maquina estampar","maquina estampar","reparo computador loja","ferramenta manual"],
        gastosAtrelados: "Reparos em impressora de etiqueta, m√°quina de estampar, computador fora de garantia, ferramenta manual pequena.",
        observacaoUso: "Equipamento grande/patrimonial n√£o."
    },
    {
        nomeEtiqueta: "CHAVEIRO EMERGENCIAL",
        palavrasChave: ["chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar segredo","perdi a chave","sem chave cofre"],
        gastosAtrelados: "Servi√ßo emergencial de chaveiro para abrir cofre, estoque, vitrine.",
        observacaoUso: "Somente emerg√™ncia operacional real."
    },
    {
        nomeEtiqueta: "TRANSPORTE SERVI√áOS EMERGENCIAS",
        palavrasChave: ["motoboy","moto boy","moto-boy","frete urgente","entrega urgente","pegar documento na matriz","levar documento","sedex urgente","courier"],
        gastosAtrelados: "Frete local emergencial, motoboy, transporte urgente de item/documento cr√≠tico entre loja e matriz.",
        observacaoUso: "Uber/99 pessoal N√ÉO √© isso."
    },
    {
        nomeEtiqueta: "CORREIOS_SEDEX/AR/POSTAGEM",
        palavrasChave: ["sedex","correios","ar","postagem","envio documento","carta registrada","devolucao correios","devolu√ß√£o correios"],
        gastosAtrelados: "Envio de documentos f√≠sicos via Sedex/AR/postagem oficial, devolu√ß√µes pequenas.",
        observacaoUso: ""
    },
    {
        nomeEtiqueta: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
        palavrasChave: ["banner","adesivo promocional","adesivo","flyer","folder","encadernacao","encaderna√ß√£o","material visual loja","impressao grafica","impress√£o gr√°fica"],
        gastosAtrelados: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√µes, materiais visuais da loja.",
        observacaoUso: ""
    },
    {
        nomeEtiqueta: "BOBINA ECF",
        palavrasChave: ["bobina","bobina ecf","bobina fiscal","bobina impressora fiscal","ecf","cupom fiscal","bobina pdv","bobina caixa"],
        gastosAtrelados: "Bobina para ECF / impressora fiscal / PDV onde n√£o h√° fornecimento centralizado obrigat√≥rio.",
        observacaoUso: ""
    }
];

// =====================================================
// üß† Normaliza√ß√£o b√°sica
// =====================================================

function normalize(str) {
    return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

// =====================================================
// üîé Detectar inten√ß√£o do usu√°rio
// =====================================================

function detectarIntencaoPergunta(msgNorm) {

    // fora de escopo (futebol, xingamento, pol√≠tica etc.) -> rejeita
    const foraEscopoPadroes = [
        "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
        "presidente","futebol","time joga","campeonato","xing", "vai tomar",
        "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
        "piada","xingar","palavr√£o","palavrao"
    ];
    for (const termo of foraEscopoPadroes) {
        if (msgNorm.includes(normalize(termo))) {
            return "foraEscopo";
        }
    }

    // etiqueta direta (qual etiqueta / que etiqueta / etiqueta pra X)
    if (msgNorm.includes("etiqueta") || msgNorm.includes("qual etiqueta") || msgNorm.includes("que etiqueta")) {
        return "etiqueta";
    }

    // aumento de limite
    if (msgNorm.includes("aumentar limite") ||
        msgNorm.includes("aumento de limite") ||
        msgNorm.includes("limite maior") ||
        msgNorm.includes("limite do cartao") ||
        msgNorm.includes("limite do cart√£o") ||
        msgNorm.includes("limite nao basta") ||
        msgNorm.includes("limite n√£o basta") ||
        msgNorm.includes("limite acabou") ||
        msgNorm.includes("limite estourou")) {
        return "limite";
    }

    // cart√£o bloqueado / desbloqueio
    if (msgNorm.includes("bloqueou") ||
        msgNorm.includes("bloqueado") ||
        msgNorm.includes("desbloquear") ||
        msgNorm.includes("cartao travou") ||
        msgNorm.includes("cart√£o travou") ||
        msgNorm.includes("travou o cartao") ||
        msgNorm.includes("travou o cart√£o") ||
        msgNorm.includes("bloqueio preventivo")) {
        return "bloqueio";
    }

    // justificativa / presta√ß√£o de contas
    if (msgNorm.includes("como justificar") ||
        msgNorm.includes("justificar compra") ||
        msgNorm.includes("prestar contas") ||
        msgNorm.includes("prestacao de contas") ||
        msgNorm.includes("presta√ß√£o de contas") ||
        msgNorm.includes("colocar nota") ||
        msgNorm.includes("anexar nota") ||
        msgNorm.includes("descricao na clara") ||
        msgNorm.includes("descri√ß√£o na clara")) {
        return "prestacao";
    }

    // alimento/time/lanche/agua
    if (
        msgNorm.includes("lanche") ||
        msgNorm.includes("lanche pro time") ||
        msgNorm.includes("lanche para o time") ||
        msgNorm.includes("cafe pro time") ||
        msgNorm.includes("caf√© pro time") ||
        msgNorm.includes("coffee break") ||
        msgNorm.includes("agua") ||
        msgNorm.includes("√°gua") ||
        msgNorm.includes("gal√£o") ||
        msgNorm.includes("galao") ||
        msgNorm.includes("premiacao") ||
        msgNorm.includes("premia√ß√£o")
    ) {
        return "alimentoTime";
    }

    // uber / transporte pessoal
    if (msgNorm.includes("uber") || msgNorm.includes("99") || msgNorm.includes("taxi") || msgNorm.includes("t√°xi") || msgNorm.includes("app de transporte")) {
        return "transportePessoal";
    }

    // mudan√ßa de gerente / troca de loja / estou indo pra outra loja / vou mudar de loja
    if (
        msgNorm.includes("mudar de loja") ||
        msgNorm.includes("trocar de loja") ||
        msgNorm.includes("vou mudar de loja") ||
        msgNorm.includes("fui transferido") ||
        msgNorm.includes("transferido de loja") ||
        msgNorm.includes("gerente desligado") ||
        msgNorm.includes("sem gerente") ||
        msgNorm.includes("gerente saiu") ||
        msgNorm.includes("gerente saiu da loja") ||
        msgNorm.includes("cartao de outra loja") ||
        msgNorm.includes("cart√£o de outra loja") ||
        msgNorm.includes("usar cartao de outra loja") ||
        msgNorm.includes("usar cart√£o de outra loja")
    ) {
        return "trocaGerente";
    }

    // sangria
    if (
        msgNorm.includes("sangria") ||
        msgNorm.includes("fazer sangria") ||
        msgNorm.includes("puxar dinheiro do caixa") ||
        msgNorm.includes("retirar dinheiro do caixa")
    ) {
        return "sangria";
    }

    // fraude/contesta√ß√£o
    if (
        msgNorm.includes("nao reconheco") ||
        msgNorm.includes("n√£o reconhe√ßo") ||
        msgNorm.includes("fraude") ||
        msgNorm.includes("compra indevida") ||
        msgNorm.includes("compra indevida no cartao") ||
        msgNorm.includes("compra indevida no cart√£o") ||
        msgNorm.includes("contestar compra") ||
        msgNorm.includes("contestacao") ||
        msgNorm.includes("contesta√ß√£o")
    ) {
        return "fraudeContestacao";
    }

    // pergunta gen√©rica "posso comprar X?" / "pode gastar com Y?"
    if (
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("posso usar") ||
        msgNorm.includes("pode usar") ||
        msgNorm.includes("pode pagar") ||
        msgNorm.includes("pode gastar") ||
        msgNorm.includes("pode comprar") ||
        msgNorm.includes("pode no cartao") ||
        msgNorm.includes("pode no cart√£o") ||
        msgNorm.includes("pode colocar no cartao") ||
        msgNorm.includes("pode colocar no cart√£o")
    ) {
        return "podeNaoPode";
    }

    // fallback
    return "generica";
}

// =====================================================
// üîç Encontrar etiqueta mais aderente ao texto
// =====================================================

function acharEtiquetaPorMensagem(msgNorm) {
    for (const et of etiquetasOficiais) {
        for (const termo of et.palavrasChave) {
            if (msgNorm.includes(normalize(termo))) {
                return et;
            }
        }
    }
    return null;
}

// =====================================================
// üßÆ Avaliar se pode comprar um item espec√≠fico
// =====================================================

function avaliarCompraEspecifica(msgNorm) {
    // proibidos / patrim√¥nio / uso pessoal / √°lcool / transporte pessoal
    const itensPatrimoniaisGrandes = [
        "geladeira","frigobar","microondas","micro-ondas","micro ondas","cafeteira","cafeteira eletrica","cafeteira el√©trica",
        "bebedouro","ar condicionado novo","ar-condicionado novo","tv","televisao","televis√£o","monitor","console ps5","ps5","playstation",
        "mesa","mesa escritorio","mesa de escritorio","cadeira","cadeira escritorio","cadeira de escritorio","estacao de trabalho","esta√ß√£o de trabalho",
        "movel","m√≥vel","mobilia","mob√≠lia","mobiliario","mobili√°rio","armario","arm√°rio","balcao","balc√£o"
    ];
    for (const termo of itensPatrimoniaisGrandes) {
        if (msgNorm.includes(normalize(termo))) {
            return {
                status: "naoPode",
                mensagemCustom:
                    "N√£o pode. Itens como mesa, cadeira, geladeira, micro-ondas, TV, cafeteira el√©trica, mobili√°rio ou estrutura fixa s√£o considerados patrim√¥nio/infraestrutura da loja. Isso n√£o entra no cart√£o Clara. Esse tipo de gasto segue fluxo de Compras / patrim√¥nio.",
                etiqueta: null
            };
        }
    }

    const bebidasAlcool = [
        "cerveja","vinho","whisky","whiskey","vodka","gin","bebida alcoolica","bebida alco√≥lica","chopp","chope"
    ];
    for (const termo of bebidasAlcool) {
        if (msgNorm.includes(normalize(termo))) {
            return {
                status: "naoPode",
                mensagemCustom:
                    "N√£o pode. Bebida alco√≥lica n√£o √© despesa operacional da loja e n√£o pode ser paga com o cart√£o Clara. Se j√° passou no cart√£o, o respons√°vel deve avisar Financeiro, marcar como 'Despesa Pessoal ‚Äì Uso Indevido' e ressarcir em at√© 2 dias √∫teis.",
                etiqueta: null
            };
        }
    }

    const transportePessoal = [
        "uber","99","app de transporte","taxi","t√°xi","transporte pessoal","uber pra casa","uber para casa","uber pessoal"
    ];
    for (const termo of transportePessoal) {
        if (msgNorm.includes(normalize(termo))) {
            return {
                status: "naoPode",
                mensagemCustom:
                    "Uber / 99 / t√°xi para deslocamento pessoal n√£o pode ser pago com o cart√£o Clara, pois n√£o √© gasto operacional direto da loja. Se j√° usou, precisa avisar o Financeiro e ressarcir.",
                etiqueta: null
            };
        }
    }

    // permitidos via etiqueta clara
    const etiquetaEncontrada = acharEtiquetaPorMensagem(msgNorm);
    if (etiquetaEncontrada) {
        return {
            status: "pode",
            mensagemCustom: null,
            etiqueta: etiquetaEncontrada
        };
    }

    // n√£o classificado
    return { status: "desconhecido" };
}

// =====================================================
// üìö Constru√ß√£o de respostas por inten√ß√£o
// =====================================================

function respostaForaEscopo() {
    return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
}

function respEtiquetaDireta(et) {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nomeEtiqueta}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.gastosAtrelados}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}
<p class="mt-2">
Lan√ßar na Clara em at√© 48h:<br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar "${et.nomeEtiqueta}";<br/>
3. Descrever objetivamente o gasto (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar o documento f√≠sico na loja (90+ dias).
</p>
</div>`;
}

function respLimite() {
    return `HTML:<p class="text-sm text-slate-700">
Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>
explicando:<br/>
‚Ä¢ qual gasto precisa fazer,<br/>
‚Ä¢ urg√™ncia,<br/>
‚Ä¢ por que o limite atual n√£o atende.<br/><br/>
A aprova√ß√£o/ajuste de limite √© feita pelo Financeiro, conforme a pol√≠tica.
</p>`;
}

function respBloqueio() {
    return `HTML:<p class="text-sm text-slate-700">
Bloqueio preventivo acontece quando tem compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
‚Ä¢ faltou nota fiscal/recibo,<br/>
‚Ä¢ n√£o colocou etiqueta correta,<br/>
‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
Passos pra desbloquear:<br/>
1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolhe etiqueta certa, descreve o motivo real).<br/>
2. Avise o Financeiro que j√° foi ajustado.<br/><br/>
Reincid√™ncia pode fazer a loja perder permiss√£o de uso do cart√£o.
</p>`;
}

function respPrestacaoContas() {
    return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 90 dias corridos. N√£o justificar no prazo => risco de bloqueio preventivo.
</p>`;
}

function respAlimentoTime() {
    return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas nesses casos:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
}

function respTransportePessoal() {
    return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja.<br/><br/>
Se j√° usou:<br/>
‚Ä¢ comunicar o Financeiro imediatamente,<br/>
‚Ä¢ classificar como "Despesa Pessoal ‚Äì Uso Indevido" na plataforma,<br/>
‚Ä¢ ressarcir o valor √† empresa em at√© 2 dias √∫teis.<br/><br/>
Falta de regulariza√ß√£o pode gerar bloqueio e at√© desconto em folha.
</p>`;
}

function respTrocaGerente() {
    return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja funciona assim pela pol√≠tica:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja.<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234".<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado,<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Qualquer caso fora disso ‚Üí falar com o Financeiro antes e, se preciso, abrir chamado no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>.
</p>`;
}

function respSangria() {
    return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro para pagar despesa operacional √© DESCONTINUADO.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
}

function respFraudeContestacao() {
    return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente.<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o.<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal mas feita no cart√£o, a√≠ precisa ressarcir em at√© 2 dias √∫teis, n√£o √© contesta√ß√£o.
</p>`;
}

// resposta gen√©rica / fallback, levando em conta avalia√ß√£o de compra
function respGenerica(msgNorm) {
    const avaliacao = avaliarCompraEspecifica(msgNorm);

    if (avaliacao.status === "naoPode") {
        return `HTML:<p class="text-sm text-slate-700">
<b>N√£o pode usar o cart√£o Clara pra isso.</b><br/>
${avaliacao.mensagemCustom}<br/><br/>
Se isso j√° caiu no cart√£o, precisa avisar o Financeiro, marcar como "Despesa Pessoal ‚Äì Uso Indevido" e ressarcir em at√© 2 dias √∫teis. Falta de regulariza√ß√£o pode manter o cart√£o bloqueado.
</p>`;
    }

    if (avaliacao.status === "pode" && avaliacao.etiqueta) {
        const et = avaliacao.etiqueta;
        return `HTML:<div class="text-sm text-slate-700">
<p><b>Pode usar o cart√£o Clara, pois √© despesa operacional da loja.</b></p>
<p class="mt-1"><b>Etiqueta:</b> "${et.nomeEtiqueta}"</p>
<p class="mt-1"><b>O que cobre:</b> ${et.gastosAtrelados}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}
<p class="mt-2">
Como lan√ßar na Clara (at√© 48h):<br/>
1. Anexar nota fiscal/recibo;<br/>
2. Selecionar "${et.nomeEtiqueta}";<br/>
3. Descrever o uso (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar documento f√≠sico na loja por pelo menos 90 dias.
</p>
</div>`;
    }

    // fallback neutro orientado pela pol√≠tica
    return `HTML:<p class="text-sm text-slate-700">
Para poder usar o cart√£o Clara, o gasto precisa ser algo operacional imediato da loja (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal etc.), com nota fiscal e lan√ßamento na Clara em at√© 48h (etiqueta certa + descri√ß√£o objetiva).<br/><br/>
N√£o pode ser gasto pessoal, bebida alco√≥lica, Uber pessoal ou item patrimonial/infraestrutura (geladeira, micro-ondas, TV, mesa, cadeira, etc.). Isso precisa ir por Compras ou ser ressarcido.
</p>`;
}

// =====================================================
// üßµ Follow-up inteligente (continua√ß√£o de conversa)
// =====================================================

let ultimaIntencao = null;

function respFollowup(msgNorm) {
    // se a √∫ltima inten√ß√£o foi clara, tenta detalhar melhor
    if (ultimaIntencao === "limite") return respLimite();
    if (ultimaIntencao === "bloqueio") return respBloqueio();
    if (ultimaIntencao === "prestacao") return respPrestacaoContas();
    if (ultimaIntencao === "alimentoTime") return respAlimentoTime();
    if (ultimaIntencao === "transportePessoal") return respTransportePessoal();
    if (ultimaIntencao === "trocaGerente") return respTrocaGerente();
    if (ultimaIntencao === "sangria") return respSangria();
    if (ultimaIntencao === "fraudeContestacao") return respFraudeContestacao();

    // fallback -> reaproveita generica j√° contextual
    return respGenerica(msgNorm);
}

// =====================================================
// üßæ Motor principal de resposta
// =====================================================

function gerarRespostaDoBot(msgUsuario) {
    const norm = normalize(msgUsuario);

    // inten√ß√£o
    const intencao = detectarIntencaoPergunta(norm);

    let resposta;

    switch (intencao) {
        case "foraEscopo":
            ultimaIntencao = "foraEscopo";
            resposta = respostaForaEscopo();
            break;

        case "etiqueta":
            ultimaIntencao = "etiqueta";
            {
                const et = acharEtiquetaPorMensagem(norm);
                if (et) {
                    resposta = respEtiquetaDireta(et);
                } else {
                    resposta = `HTML:<p class="text-sm text-slate-700">
N√£o achei uma etiqueta √≥bvia s√≥ pelo texto. Se realmente n√£o existir nenhuma etiqueta adequada na Clara para esse gasto operacional, voc√™ deve abrir um chamado solicitando cria√ß√£o de etiqueta no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>.
</p>`;
                }
            }
            break;

        case "limite":
            ultimaIntencao = "limite";
            resposta = respLimite();
            break;

        case "bloqueio":
            ultimaIntencao = "bloqueio";
            resposta = respBloqueio();
            break;

        case "prestacao":
            ultimaIntencao = "prestacao";
            resposta = respPrestacaoContas();
            break;

        case "alimentoTime":
            ultimaIntencao = "alimentoTime";
            resposta = respAlimentoTime();
            break;

        case "transportePessoal":
            ultimaIntencao = "transportePessoal";
            resposta = respTransportePessoal();
            break;

        case "trocaGerente":
            ultimaIntencao = "trocaGerente";
            resposta = respTrocaGerente();
            break;

        case "sangria":
            ultimaIntencao = "sangria";
            resposta = respSangria();
            break;

        case "fraudeContestacao":
            ultimaIntencao = "fraudeContestacao";
            resposta = respFraudeContestacao();
            break;

        case "podeNaoPode":
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;

        case "generica":
        default:
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;
    }

    return resposta;
}

// =====================================================
// üí¨ Renderiza√ß√£o visual das mensagens no chat
// =====================================================

const chatWindow = document.getElementById("chatWindow");
const chatForm = document.getElementById("chatForm");
const userInput = document.getElementById("userInput");

// Enviar com Enter, e Shift+Enter = quebra de linha
userInput.addEventListener("keydown", function (e) {
    // Se apertou Enter...
    if (e.key === "Enter") {
        // ... segurando Shift => vira s√≥ quebra de linha normal
        if (e.shiftKey) {
            return; // deixa o Enter+Shift funcionar como quebra de linha
        }
        // ... sem Shift => envia
        e.preventDefault(); // impede pular linha
        enviarMensagem();
    }
});

function renderUserMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start justify-end gap-3";

    const bubble = document.createElement("div");
    bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
    bubble.innerText = text;

    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// render bot message com avatar do rob√¥ √† esquerda
function renderBotMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start gap-3";

    const avatar = document.createElement("img");
    avatar.src = "Gemini_Generated_Image_nzni5znzni5znzni.png";
    avatar.alt = "Assistente Clara (rob√¥)";
    avatar.className = "h-10 w-auto object-contain flex-shrink-0";

    const bubble = document.createElement("div");
    bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

    if (text.startsWith("HTML:")) {
        bubble.innerHTML = text.replace(/^HTML:/, "").trim();
    } else {
        bubble.innerText = text;
    }

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);

    chatWindow.appendChild(wrapper);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

// =====================================================
// üì§ Envio do formul√°rio
// =====================================================

function enviarMensagem() {
    const pergunta = userInput.value.trim();
    if (!pergunta) return;

    // render user
    renderUserMessage(pergunta);

    // gerar resposta
    const resposta = gerarRespostaDoBot(pergunta);
    renderBotMessage(resposta);

    // limpar input
    userInput.value = "";
    userInput.focus();
}

// envio pelo bot√£o / submit do form
chatForm.addEventListener("submit", function (e) {
    e.preventDefault();
    enviarMensagem();
});

</script>

</body>
</html>


