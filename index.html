<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistente Clara | Uso do Cart√£o na Loja</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonte -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet"
    />

    <style>
        :root {
            --brand-main: #005E27; /* verde escuro */
            --brand-highlight: #B5FF20; /* verde claro do header */
        }

        body {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: #f8fafc;
        }

        /* bolhas */
        .user-bubble {
            background-color: var(--brand-main);
            color: #fff;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.25);
        }
        .bot-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1); /* slate-200 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
        }

        /* avatar Clara (nas mensagens) */
        .bot-avatar {
            background-color: var(--brand-main);
            color: #fff;
        }

        /* bot√£o enviar */
        .send-button {
            background-color: var(--brand-main);
        }
        .send-button:hover {
            filter: brightness(1.1);
        }

        /* focus do input */
        .user-input:focus {
            --tw-ring-color: var(--brand-main);
            outline: 2px solid var(--brand-main);
            border-color: var(--brand-main);
        }

        /* "digitando..." */
        .typing-bubble {
            background-color: #ffffff;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgb(226 232 240 / 1);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07);
            font-size: 13px;
            color: #475569;
        }
        .dot {
            width: 6px;
            height: 6px;
            background-color: #475569;
            border-radius: 9999px;
            display: inline-block;
            animation: bounce 1.2s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.15s; }
        .dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-4px); opacity: 1; }
        }

        /* scrollbar da janela de chat */
        #chatWindow::-webkit-scrollbar {
            width: 6px;
        }
        #chatWindow::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 9999px;
        }
        #chatWindow::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 9999px;
        }

        /* links clic√°veis nas respostas */
        .bot-link {
            color: var(--brand-main);
            font-weight: 600;
            text-decoration: underline;
            word-break: break-word;
        }
    </style>
</head>
<body class="text-slate-800 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col min-h-[600px] max-h-[90vh]">

        <!-- HEADER DESTACADO (fundo verde claro + robo mascote) -->
        <header class="px-5 py-6 border-b border-slate-200 relative" style="background-color: var(--brand-highlight);">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="leading-tight text-slate-900 pr-24 md:pr-0">
                    <p class="font-extrabold text-slate-900 text-base md:text-lg uppercase tracking-tight">
                        Assistente Clara | Grupo SBF
                    </p>
                    <p class="text-[13px] text-slate-800 mt-2 font-medium">
                        Pergunte sobre o uso do cart√£o Clara nas lojas.
                    </p>
                    <p class="text-[12px] text-slate-800 mt-1">
                        üí¨ Exemplos:
                        ‚ÄúPosso comprar micro-ondas?‚Äù ‚Ä¢
                        ‚ÄúUber pode?‚Äù ‚Ä¢
                        ‚ÄúTravou o cart√£o, fa√ßo o qu√™?‚Äù
                    </p>
                    <p class="text-[11px] text-slate-700 italic mt-3 font-medium">
                        ‚ö† Minhas respostas seguem a Pol√≠tica de Uso dos Cart√µes Clara.
                        Em conflito, vale sempre o documento oficial da empresa.
                    </p>
                </div>

                <!-- avatar rob√¥ -->
                <div class="flex-shrink-0 flex justify-center md:justify-end w-full md:w-auto">
                    <img
                        src="Gemini_Generated_Image_e9xsase9xsase9xs.png"
                        alt="Assistente Clara (rob√¥)"
                        class="h-24 object-contain drop-shadow-[0_8px_8px_rgba(0,0,0,0.25)]"
                        style="max-width:96px;"
                    />
                </div>
            </div>
        </header>

        <!-- Janela de chat -->
        <section id="chatWindow" class="flex-1 overflow-y-auto px-5 py-4 space-y-4 text-[15px] leading-relaxed bg-slate-50/40 min-h-[360px]">
            <!-- Mensagem inicial da Clara -->
            <div class="flex items-start gap-3">
                <div class="w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0">
                    C
                </div>
                <div class="bot-bubble px-4 py-3 max-w-[80%]">
                    <p class="font-semibold text-slate-800">
                        Ol√°! üëã Eu sou a Clara.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pergunte se um gasto pode no cart√£o, como justificar, prazos, bloqueio,
                        etiquetas, aumento de limite, emerg√™ncia, etc.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-3">
                        Se eu falar pra abrir chamado, vou mandar o link do ServiceNow clic√°vel.
                    </p>
                </div>
            </div>
        </section>

        <!-- Input -->
        <section class="border-t border-slate-200 bg-white rounded-b-2xl px-4 py-4 flex flex-col gap-3">
            <form id="chatForm" class="flex w-full gap-3">
                <input
                    id="userInput"
                    type="text"
                    class="user-input flex-1 text-[15px] border border-slate-300 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-[var(--brand-main)] focus:border-[var(--brand-main)]"
                    placeholder="Escreve sua d√∫vida (ex: 'qual etiqueta pro teclado?' ou 'como aumentar limite?')"
                    autocomplete="off"
                />
                <button
                    class="send-button text-white font-semibold text-sm rounded-xl px-4 py-3 shadow-md transition"
                    type="submit"
                >
                    Enviar
                </button>
            </form>

            <div class="text-[11px] text-slate-500 text-center leading-snug">
                Uso pessoal = proibido. Se acontecer, voc√™ precisa declarar e ressarcir em at√© 2 dias √∫teis.
            </div>
        </section>
    </main>

    <script>
        // -----------------------
        // CONFIG FIXA
        // -----------------------
        const SERVICE_NOW_URL = "https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6";
        const POLITICA_PDF_URL = "https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing";

        // contexto de inten√ß√£o da √∫ltima resposta, pra follow-up
        let ultimaIntencao = null;

        // -----------------------
        // TABELA DE ETIQUETAS
        // -----------------------
        // Cada item:
        // nomeEtiqueta: Nome apresentado ao usu√°rio
        // gastosAtrelados: descri√ß√£o do que entra nessa etiqueta
        // termosChave: palavras que disparam essa etiqueta
        const tabelaEtiquetas = [
            {
                nomeEtiqueta: "MARKETING_PUBLICIDADE E PROPAGANDA",
                gastosAtrelados: "A√ß√µes promocionais, compra de brindes para campanha, contrata√ß√£o de m√≠dia local, impulsionamento de redes sociais, banners promocionais.",
                termosChave: ["marketing","publicidade","propaganda","brinde","brindes","banner","divulga√ß√£o","divulgacao","promo√ß√£o","promocao","m√≠dia local","midia local","impulsionar rede","impulsionar post"]
            },
            {
                nomeEtiqueta: "MATERIAL DE LIMPEZA",
                gastosAtrelados: "Detergente, sab√£o, desinfetante, papel toalha, pano de ch√£o, esponja, rodo, vassoura, √°lcool, produtos de higiene ambiental.",
                termosChave: ["limpeza","detergente","desinfetante","pano de chao","pano de ch√£o","rodo","vassoura","papel toalha","esponja","alcool","√°lcool","higiene"]
            },
            {
                nomeEtiqueta: "MATERIAL DE INFORM√ÅTICA",
                gastosAtrelados: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                termosChave: ["teclado","mouse","cabo usb","cabo","pendrive","hub usb","roteador","fonte notebook","fonte de notebook","cartao de memoria","cart√£o de mem√≥ria","suporte notebook","teclado pdv","mouse pdv","cabo pdv"]
            },
            {
                nomeEtiqueta: "MATERIAL DE ESCRIT√ìRIO",
                gastosAtrelados: "Canetas, clips, cadernos, pastas, blocos de anota√ß√£o, grampeadores, etiquetas, organizadores de mesa.",
                termosChave: ["caneta","canetas","caderno","pasta","pastas","bloco","blocos","post-it","postit","grampeador","grampeadores","etiqueta adesiva","organizador de mesa","clips","clip","papel sulfite","sulfite"]
            },
            {
                nomeEtiqueta: "MATERIAL DE COPA E COZINHA",
                gastosAtrelados: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, esponjas, potes pl√°sticos (sem el√©tricos).",
                termosChave: ["copo descartavel","copo descart√°vel","talher","talheres","prato","pratos","pano de prato","filtro de caf√©","filtro de cafe","garrafa t√©rmica","garrafa termica","pote plastico","pote pl√°stico"]
            },
            {
                nomeEtiqueta: "MANUTEN√á√ÉO CIVIL",
                gastosAtrelados: "Pequenos reparos em paredes, troca de revestimentos, consertos em portas ou fechaduras (exceto chaveiro), troca de vidros, ajustes em prateleiras fixas.",
                termosChave: ["reparo parede","reparo parede loja","prateleira","prateleiras","revestimento","troca de vidro","conserto porta","ajuste porta","ajuste prateleira","paredes"]
            },
            {
                nomeEtiqueta: "MANUTEN√á√ÉO ELETRICO",
                gastosAtrelados: "Troca de tomadas, disjuntores, interruptores, reatores, soquetes, extens√µes el√©tricas, pequenos reparos de fia√ß√£o de baixa tens√£o.",
                termosChave: ["tomada","trocar tomada","disjuntor","disjuntores","interruptor","reator","soquete","extens√£o","extensao","fio eletrico","fia√ß√£o","fia√ß√£o baixa tens√£o","fiacao baixa tensao"]
            },
            {
                nomeEtiqueta: "MANUTEN√á√ÉO EQUIPAMENTOS",
                gastosAtrelados: "Reparos em impressoras de etiqueta, m√°quinas de estampar, computadores (fora de garantia e baixo valor), ferramentas manuais.",
                termosChave: ["manutencao impressora","manuten√ß√£o impressora","manutencao maquina estampar","maquina de estampar","computador conserto","ajuste equipamento","ferramenta manual","reparo equipamento loja"]
            },
            {
                nomeEtiqueta: "MANUTEN√á√ÉO AR-CONDICIONADO",
                gastosAtrelados: "Manuten√ß√£o corretiva/preventiva simples de ar-condicionado (limpeza de filtro, carga de g√°s, troca de controle remoto ou pe√ßas simples).",
                termosChave: ["ar condicionado","ar-condicionado","carga de gas","carga de g√°s","limpeza filtro ar","controle remoto ar","manutencao ar","manuten√ß√£o ar"]
            },
            {
                nomeEtiqueta: "TRANSPORTE SERVI√áOS EMERGENCIAS",
                gastosAtrelados: "Frete local emergencial, motoboy para transporte de documentos ou itens urgentes entre lojas ou matriz, entrega de materiais cr√≠ticos.",
                termosChave: ["motoboy","moto boy","frete rapido","frete urgente","entrega urgente","transporte urgente","courier","levar pe√ßa","levar peca","trazer pe√ßa","trazer peca","mandar documento","enviar documento","entrega matriz","levar pra matriz"]
            },
            {
                nomeEtiqueta: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
                gastosAtrelados: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√µes, produ√ß√£o de manuais impressos.",
                termosChave: ["banner impresso","adesivo promocional","adesivagem","flyer","folder","plotagem","grafica","gr√°fica","copiadora","encaderna√ß√£o","encadernacao","manual impresso"]
            },
            {
                nomeEtiqueta: "CORREIOS_SEDEX/AR/POSTAGEM",
                gastosAtrelados: "Envio de documentos f√≠sicos via Sedex, AR, carta registrada, pacotes pequenos, devolu√ß√µes via Correios.",
                termosChave: ["sedex","correios","postagem","ar correios","carta registrada","enviar documento","devolucao correios","devolu√ß√£o correios","pacote pequeno","remessa loja"]
            },
            {
                nomeEtiqueta: "LANCHES DE REFEI√á√ïES",
                gastosAtrelados: "Compra de coffee break para a√ß√µes internas, lanches para treinamentos, premia√ß√µes, eventos internos autorizados.",
                termosChave: ["lanche time","lanche equipe","coffee break","cafe da manha time","caf√© da manh√£ time","treinamento interno","premiacao","premia√ß√£o","evento interno","visita regional","visita diretor","vm na loja"]
            },
            {
                nomeEtiqueta: "AGUA POT√ÅVEL",
                gastosAtrelados: "Compra de gal√µes de √°gua mineral, garrafas para abastecimento da equipe ou clientes em loja (se previsto).",
                termosChave: ["gal√£o de agua","gal√£o de √°gua","galao de agua","agua potavel","√°gua pot√°vel","garrafa de agua","garrafa de √°gua","repor agua","repor √°gua"]
            },
            {
                nomeEtiqueta: "BOBINA ECF",
                gastosAtrelados: "Compra de bobinas para ECF ou impressoras fiscais (uso obrigat√≥rio nas lojas que n√£o t√™m fornecimento centralizado).",
                termosChave: ["bobina ecf","bobina fiscal","bobina impressora fiscal","bobina pdv","bobina cupom"]
            },
            {
                nomeEtiqueta: "CHAVEIRO EMERGENCIAL",
                gastosAtrelados: "Servi√ßos de abertura ou troca de fechadura de cofres, salas administrativas, estoques, vitrines ‚Äì exclusivamente em situa√ß√µes emergenciais.",
                termosChave: ["chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar fechadura","perdi a chave","sem chave do cofre","sem chave do estoque"]
            },
            {
                nomeEtiqueta: "MANUTEN√á√ÉO MAQ ESTAMPAR",
                gastosAtrelados: "Reparos simples ou ajustes t√©cnicos em m√°quinas de estampar produtos promocionais nas lojas ‚Äì sem controle patrimonial e com nota fiscal do prestador.",
                termosChave: ["maquina estampar","m√°quina estampar","estamparia","manutencao estampar","ajuste estampar","conserto estampar","estampa produto promocional"]
            }
        ];

        // tenta achar etiqueta por palavras-chave do usu√°rio
        function acharEtiquetaPorMensagem(msgNorm) {
            for (const cat of tabelaEtiquetas) {
                for (const termo of cat.termosChave) {
                    if (msgNorm.includes(normalize(termo))) {
                        return cat;
                    }
                }
            }
            return null;
        }

        // -----------------------
        // INTEN√á√ïES
        // -----------------------
        function normalize(text) {
            return text
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        function contemAlgum(msgNorm, lista) {
            return lista.some(k => msgNorm.includes(normalize(k)));
        }

        const intents = {
            bebidaAlcoolica: ["cerveja","cervejinha","whisky","whiskey","vodka","vinho","champagne","espumante","bebida alcoolica","bebida alco√≥lica","alcool","√°lcool","chopp","chope"],
            eletronicos: ["ps5","playstation","play station","xbox","tv","televisao","televis√£o","monitor","som","r√°dio","radio","caixa de som","soundbar","notebook","laptop","tablet","fone","headset"],
            eletrodomesticos: ["micro-ondas","microondas","micro ondas","geladeira","frigobar","cafeteira","bebedouro","airfryer","air fryer","aspirador"],
            transportePessoal: ["uber","99","app de transporte","app 99","app99","corrida","taxi","t√°xi","taxi99","viagem","passagem","passagens","uber pessoal","uber pra casa","uber para casa"],
            alimentoTime: ["lanche","lanche time","lanche equipe","cafe time","caf√© time","coffee break","refrigerante","treinamento interno","visita regional","visita diretor","vm na loja","vm da loja","√°gua","agua","gal√£o","galao"],
            manutencao: ["chaveiro","fechadura","troca de tomada","tomada","manuten√ß√£o ar","manutencao ar","ar condicionado","ar-condicionado","motoboy","frete urgente","entrega urgente","courier","prateleira","quebrou parede","quebrou porta"],
            bloqueio: ["bloqueou","bloqueio","bloqueada","bloquearam","cart√£o bloqueado","cartao bloqueado","desbloquear","desbloqueia","desbloqueio","travou","cart√£o travou","cartao travou","preventivo","bloqueio preventivo"],
            prazo48h: ["48h","48 h","48 horas","prazo","quanto tempo","deadline","quando preciso lan√ßar","ate quando lan√ßo","at√© quando lan√ßo","qual prazo pra lan√ßar","prazo pra justificar","prazo pra justificativa"],
            justificar: ["como justificar","justificar compra","justificar transa√ß√£o","justificar a transa√ß√£o","prestar conta","presta√ß√£o de contas","prestacao de contas","o que eu coloco na descri√ß√£o","o que tenho que anexar","o que precisa lan√ßar na clara","como lan√ßo","como lan√ßar","como justifico"],
            emergenciaSangria: ["emerg√™ncia","emergencia","urgente","sangria","tirar dinheiro do caixa","pegar dinheiro do caixa","sem limite","acabou limite","limite acabou","estourou limite","sem cart√£o","sem cartao","cartao nao passa","cart√£o nao passa","cartao n√£o passa","cart√£o n√£o passa"],
            usoPessoal: ["usei pra mim","usei para mim","pra mim","para mim","gasto pessoal","despesa pessoal","comprei pro meu filho","body pro meu filho","roupa pro meu filho","pessoal","uso pessoal","coisa minha","minha necessidade"],
            outraLoja: ["cart√£o de outra loja","cartao de outra loja","emprestado","usar cart√£o da outra loja","usar cartao da outra loja","gerente desligado","sem gerente","gerente saiu","mudan√ßa de gerente","mudanca de gerente","troca de gerente","respons√°vel mudou","responsavel mudou"],
            notaFiscalRetencao: ["guardar nota","nota fisica","nota f√≠sica","nota fiscal fisica","nota fiscal f√≠sica","comprovante fisico","comprovante f√≠sico","auditoria","180 dias","90 dias","guardar comprovante","guardar recibo"],
            servicenow: ["servicenow","service now","abre chamado","abrir chamado","abrir um chamado","chamado de aumento de limite","chamado de limite","chamado desbloqueio","desbloqueio no servicenow","categoria nova","nova etiqueta","nova categoria","troca de gerente","mudan√ßa de gerente","mudanca de gerente","transferir gerente","cart√£o bloqueado preciso abrir chamado","cartao bloqueado preciso abrir chamado","o que posso abrir no servicenow","quais chamados posso abrir","aumentar o limite","aumento de limite","limite maior"],
            politicaPdf: ["me manda a pol√≠tica","me manda a politica","manda a pol√≠tica","manda a politica","pdf da politica","pdf da pol√≠tica","politica clara","pol√≠tica clara","documento oficial","politica completa","politica em pdf","pol√≠tica em pdf","politica de uso"],
            etiqueta: ["qual etiqueta","que etiqueta","etiqueta usar","etiqueta devo usar","etiqueta pra","etiqueta para","qual categoria","qual classificacao","qual classifica√ß√£o","classificar gasto","classificar compra","em qual categoria entra isso","qual etiqueta pro teclado","qual etiqueta para teclado"]
        };

        // inten√ß√£o de follow-up tipo "como?", "e agora?", "e fa√ßo o qu√™?"
        function ehFollowUpCurto(msgNorm) {
            if (msgNorm.length <= 80) {
                const chaves = [
                    "como","e agora","e fa√ßo o que","e faco o que","e fa√ßo o qu√™","e fa√ßo oq","e fa√ßo oq?",
                    "o que eu fa√ßo","o que eu faco","o que fa√ßo","o que faco",
                    "qual etiqueta","que etiqueta","qual categoria",
                    "explica melhor","me explica","me ajuda",
                    "e depois","e ai","e a√≠","e ai?",
                    "e qual seria","qual usar","qual devo usar","como regularizo","como regularizar"
                ];
                return chaves.some(k => msgNorm.includes(normalize(k)));
            }
            return false;
        }

        function classificarMensagem(msg) {
            const norm = normalize(msg);

            // fora do escopo?
            // se mencionar futebol, pol√≠tica externa, xingamentos gen√©ricos, conta matem√°tica etc.
            // Heur√≠stica simples: se n√£o bater em NENHUMA inten√ß√£o conhecida E contiver palavras t√≠picas fora
            const termosFora = ["palmeiras","spfc","sao paulo fc","s√£o paulo fc","presidente do brasil","elei√ß√£o","eleicao","voto","imposto de renda","quanto √©","quanto e","qto √©","qto e","2+2","2 + 2","vacina","covid","lula","bolsonaro","puta","merda","caralho"];
            // mas antes vamos tentar bater nas inten√ß√µes internas:
            if (contemAlgum(norm, intents.politicaPdf))      return "politicaPdf";
            if (contemAlgum(norm, intents.servicenow))       return "servicenow";
            if (contemAlgum(norm, intents.bloqueio))         return "bloqueio";
            if (contemAlgum(norm, intents.justificar))       return "justificar";
            if (contemAlgum(norm, intents.prazo48h))         return "prazo48h";
            if (contemAlgum(norm, intents.bebidaAlcoolica))  return "bebidaAlcoolica";
            if (contemAlgum(norm, intents.eletronicos))      return "eletronicos";
            if (contemAlgum(norm, intents.eletrodomesticos)) return "eletrodomesticos";
            if (contemAlgum(norm, intents.transportePessoal))return "transportePessoal";
            if (contemAlgum(norm, intents.alimentoTime))     return "alimentoTime";
            if (contemAlgum(norm, intents.manutencao))       return "manutencao";
            if (contemAlgum(norm, intents.emergenciaSangria))return "emergenciaSangria";
            if (contemAlgum(norm, intents.usoPessoal))       return "usoPessoal";
            if (contemAlgum(norm, intents.outraLoja))        return "outraLoja";
            if (contemAlgum(norm, intents.notaFiscalRetencao))return "notaFiscalRetencao";
            if (contemAlgum(norm, intents.etiqueta) || acharEtiquetaPorMensagem(norm)) return "etiqueta";

            // aumento de limite √© uma sub-inten√ß√£o que cai em servicenow, mas vamos tratar direto
            if (norm.includes("aumento de limite") || norm.includes("aumentar o limite") || norm.includes("limite maior")) {
                return "aumentoLimite";
            }
            if (norm.includes("limite") && norm.includes("aument")) {
                return "aumentoLimite";
            }

            // se chegou aqui e bate em palavras fora ‚Üí foraDoEscopo
            if (contemAlgum(norm, termosFora)) {
                return "foraDoEscopo";
            }

            // fallback gen√©rico
            return "generica";
        }

        // -----------------------
        // RESPOSTAS
        // -----------------------

        function respForaDoEscopo() {
            return `HTML:<p class="text-sm text-slate-700">
N√£o consigo responder sobre esse contexto.
<br/>Sou um agente especializado na <strong>Pol√≠tica de Uso dos Cart√µes Clara nas lojas</strong>.
</p>`;
        }

        function respPoliticaPDF() {
            return `HTML:<p class="text-sm text-slate-700">
Segue a <strong>Pol√≠tica de Uso dos Cart√µes Clara</strong> (documento oficial):<br/>
<a class="bot-link" href="${POLITICA_PDF_URL}" target="_blank" rel="noopener noreferrer">Abrir Pol√≠tica de Uso dos Cart√µes Clara (PDF)</a>
</p>
<p class="mt-2 text-[13px] text-slate-500">
Esse documento define o que pode, o que n√£o pode, prazo de 48h pra justificar, bloqueio preventivo, uso pessoal e ressarcimento.
</p>`;
        }

        function respBebidaAlcoolica() {
            return `HTML:<p class="text-sm text-slate-700">
<b>N√£o pode. üö´</b><br/><br/>
Bebida alco√≥lica (cerveja, vinho, whisky etc.) <b>n√£o √© despesa operacional da loja</b> e
<b>n√£o pode ser paga com o cart√£o Clara</b> ‚Äî nem pra comemorar, nem ‚Äúpro time‚Äù.
<br/><br/>
Se j√° passou no cart√£o:<br/>
1. avisa o Financeiro;<br/>
2. classifica na Clara como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce o valor em at√© 2 dias √∫teis.<br/><br/>
Se n√£o ressarcir, pode ter desconto em folha e bloqueio definitivo do cart√£o.
</p>`;
        }

        function respEletronicos() {
            return `HTML:<p class="text-sm text-slate-700">
<b>N√£o pode comprar esse tipo de item no cart√£o Clara.</b><br/><br/>
Eletr√¥nicos tipo TV, monitor, notebook, caixinha de som, videogame etc. s√£o considerados
<b>bens patrimoniais / equipamento</b> e devem seguir fluxo de Compras.
<br/><br/>
Se comprou no cart√£o:<br/>
‚Ä¢ avisa o Financeiro;<br/>
‚Ä¢ marca como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
‚Ä¢ faz o ressarcimento em at√© 2 dias √∫teis.
</p>`;
        }

        function respEletrodomesticos() {
            return `HTML:<p class="text-sm text-slate-700">
Itens como micro-ondas, geladeira, frigobar, cafeteira, bebedouro etc.
<b>n√£o entram no cart√£o Clara</b>.<br/><br/>
Isso √© infraestrutura fixa da loja (patrimonial) e precisa seguir <b>fluxo de Compras</b>,
n√£o despesa direta da loja via cart√£o.
<br/><br/>
Se j√° passou no cart√£o:<br/>
1. avisa o Financeiro;<br/>
2. classifica como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce em at√© 2 dias √∫teis.
</p>`;
        }

        function respTransportePessoal() {
            ultimaIntencao = "transportePessoal";
            return `HTML:<p class="text-sm text-slate-700">
<b>Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode no cart√£o Clara.</b><br/><br/>
Isso n√£o √© despesa operacional direta da loja.<br/><br/>
Se j√° pagou com o cart√£o:<br/>
1. avisa o Financeiro;<br/>
2. classifica como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce o valor em at√© 2 dias √∫teis.<br/><br/>
Se n√£o ressarcir, pode ter desconto em folha e bloqueio definitivo.
</p>`;
        }

        function respTransportePessoalFollowup() {
            return `HTML:<p class="text-sm text-slate-700">
Passo a passo pra corrigir o Uber que caiu no cart√£o:<br/><br/>
1. Abra a transa√ß√£o na Clara;<br/>
2. Na descri√ß√£o, deixe claro que foi uso pessoal;<br/>
3. Classifique como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
4. Avise o Financeiro;<br/>
5. Ressa√ßa o valor em at√© 2 dias √∫teis.<br/><br/>
N√£o regularizar = risco de bloqueio definitivo do cart√£o.
</p>`;
        }

        function respAlimentoTime() {
            ultimaIntencao = "alimentoTime";
            return `HTML:<p class="text-sm text-slate-700">
<b>Depende.</b><br/><br/>
‚úî Pode usar o cart√£o Clara para:<br/>
‚Ä¢ √°gua / lanche / coffee break para <b>treinamento interno autorizado</b>,<br/>
‚Ä¢ a√ß√£o oficial de VM / regional / diretoria,<br/>
‚Ä¢ evento interno autorizado / premia√ß√£o operacional.<br/><br/>
‚ùå N√£o pode:<br/>
‚Ä¢ lazer pessoal (almo√ßo pessoal, pipoca no cinema, ‚Äúcomemorar o resultado do jogo‚Äù, etc.).<br/><br/>
Quando for permitido:<br/>
‚Ä¢ anexa nota fiscal;<br/>
‚Ä¢ usa a etiqueta certa (ex.: "AGUA POT√ÅVEL" ou "LANCHES DE REFEI√á√ïES");<br/>
‚Ä¢ descreve: "Coffee break treinamento VM loja 1234".
</p>`;
        }

        function respAlimentoTimeFollowup(msgNorm) {
            // tenta casar etiqueta espec√≠fica (√°gua, lanche autorizado etc.)
            const e = acharEtiquetaPorMensagem(msgNorm);
            if (e) {
                return respEtiquetaDireta(e);
            }
            return `HTML:<p class="text-sm text-slate-700">
Para √°gua / lanche autorizado em contexto operacional:<br/><br/>
1. Usa a etiqueta adequada (ex.: "AGUA POT√ÅVEL" ou "LANCHES DE REFEI√á√ïES")<br/>
2. Anexa a nota fiscal<br/>
3. Descreve o motivo operacional (ex.: "Coffee break treinamento VM loja 1234")<br/><br/>
Importante: refei√ß√£o pessoal / lazer n√£o entra.
</p>`;
        }

        function respManutencao() {
            ultimaIntencao = "manutencao";
            return `HTML:<p class="text-sm text-slate-700">
Gastos operacionais emergenciais / manuten√ß√£o simples da loja <b>podem</b> entrar no cart√£o Clara, por exemplo:<br/><br/>
‚Ä¢ chaveiro emergencial pra abrir estoque/cofre/vitrine;<br/>
‚Ä¢ troca de tomada, interruptor, disjuntor;<br/>
‚Ä¢ ajuste simples em ar-condicionado (filtro, controle, carga de g√°s);<br/>
‚Ä¢ motoboy / frete urgente pra levar/pegar item cr√≠tico;<br/>
‚Ä¢ pequeno reparo civil tipo prateleira, porta, vidro, parede;<br/><br/>
Sempre fa√ßa:<br/>
1. anexa a nota fiscal/recibo;<br/>
2. usa a etiqueta certa ("CHAVEIRO EMERGENCIAL", "MANUTEN√á√ÉO ELETRICO", "MANUTEN√á√ÉO AR-CONDICIONADO", "TRANSPORTE SERVI√áOS EMERGENCIAS"...);<br/>
3. descreve claro: "Chaveiro emergencial - troca fechadura estoque loja 1234".<br/><br/>
<b>Importante:</b> compra de equipamento grande/fixo (ex.: geladeira nova) N√ÉO √© cart√£o, √© Compras.
</p>`;
        }

        function respManutencaoFollowup(msgNorm) {
            const e = acharEtiquetaPorMensagem(msgNorm);
            if (e) {
                return respEtiquetaDireta(e);
            }
            return `HTML:<p class="text-sm text-slate-700">
Use a etiqueta de manuten√ß√£o/servi√ßo emergencial correspondente (ex.: "CHAVEIRO EMERGENCIAL", "MANUTEN√á√ÉO ELETRICO", "TRANSPORTE SERVI√áOS EMERGENCIAS").<br/><br/>
Descreve o que foi feito e onde:
"Troca de fechadura estoque loja 1234", "Motoboy urgente pe√ßa vitrine loja 5678".<br/><br/>
Compra patrimonial grande (geladeira, frigobar, micro-ondas) N√ÉO entra no cart√£o.
</p>`;
        }

        function respBloqueio() {
            ultimaIntencao = "bloqueio";
            return `HTML:<p class="text-sm text-slate-700">
Isso √© bloqueio preventivo. üîí<br/><br/>
O cart√£o pode ser travado se a compra n√£o foi justificada no prazo.<br/><br/>
Justificar = anexar nota fiscal/recibo + escolher etiqueta correta + escrever descri√ß√£o objetiva.<br/><br/>
<b>Como desbloquear:</b><br/>
1. Corrige tudo na plataforma Clara;<br/>
2. Depois abre chamado no ServiceNow pedindo desbloqueio (informa que j√° regularizou).<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a><br/><br/>
Obs: pode bloquear independente do valor. Reincid√™ncia pode fazer a loja perder o cart√£o.
</p>`;
        }

        function respBloqueioFollowup() {
            return `HTML:<p class="text-sm text-slate-700">
Passo a passo pra liberar o cart√£o:<br/><br/>
1. Vai na transa√ß√£o que gerou o bloqueio;<br/>
2. Anexa a nota fiscal/recibo;<br/>
3. Escolhe a etiqueta correta;<br/>
4. Escreve descri√ß√£o clara ("Chaveiro emergencial - troca fechadura estoque 1234");<br/>
5. Depois abre chamado avisando que regularizou e pede desbloqueio.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a>
</p>`;
        }

        function respPrazo48h() {
            ultimaIntencao = "prazo48h";
            return `HTML:<p class="text-sm text-slate-700">
<b>Prazo oficial:</b><br/>
Voc√™ tem at√© <b>48 horas depois da compra</b> pra:<br/>
1. anexar a nota fiscal/recibo,<br/>
2. escolher a etiqueta correta,<br/>
3. escrever a descri√ß√£o do gasto.<br/><br/>
Se n√£o fizer isso no prazo, o cart√£o pode ser <b>bloqueado preventivamente</b> at√© voc√™ ajustar.
</p>`;
        }

        function respJustificar() {
            ultimaIntencao = "justificar";
            return `HTML:<p class="text-sm text-slate-700">
Pra justificar / prestar contas na Clara voc√™ faz 3 coisas (at√© 48h):<br/><br/>
1. <b>Anexar o comprovante fiscal</b><br/>
   Nota fiscal ou recibo.<br/><br/>
2. <b>Escolher a etiqueta certa</b><br/>
   Ex.: "AGUA POT√ÅVEL", "LANCHES DE REFEI√á√ïES",
   "MATERIAL DE INFORM√ÅTICA", "CHAVEIRO EMERGENCIAL", etc.<br/>
   Se a etiqueta n√£o existir ainda, abre chamado pedindo cria√ß√£o.<br/><br/>
3. <b>Preencher a descri√ß√£o</b><br/>
   Explicar objetivamente o gasto:
   "Teclado PDV loja 1234", "Motoboy urgente pe√ßa vitrine loja 5678".<br/><br/>
Sem isso, o cart√£o pode ser bloqueado preventivamente.
</p>`;
        }

        function respJustificarFollowup() {
            return `HTML:<p class="text-sm text-slate-700">
Checklist r√°pido pra justificar certo:<br/><br/>
‚Ä¢ Nota fiscal anexada (foto leg√≠vel);<br/>
‚Ä¢ Etiqueta coerente:<br/>
&nbsp;&nbsp;- √Ågua ‚Üí "AGUA POT√ÅVEL"<br/>
&nbsp;&nbsp;- Coffee break autorizado ‚Üí "LANCHES DE REFEI√á√ïES"<br/>
&nbsp;&nbsp;- Teclado/mouse/cabo ‚Üí "MATERIAL DE INFORM√ÅTICA"<br/>
&nbsp;&nbsp;- Motoboy urgente ‚Üí "TRANSPORTE SERVI√áOS EMERGENCIAS"<br/>
&nbsp;&nbsp;- Chaveiro emerg√™ncia ‚Üí "CHAVEIRO EMERGENCIAL"<br/><br/>
‚Ä¢ Descri√ß√£o clara:
"Teclado PDV loja 1234", "Coffee break treinamento VM loja 1234".<br/><br/>
Isso evita cobran√ßa e bloqueio.
</p>`;
        }

        function respEmergenciaSangria() {
            ultimaIntencao = "emergenciaSangria";
            return `HTML:<p class="text-sm text-slate-700">
"Emerg√™ncia" N√ÉO √© "acabou meu limite".<br/><br/>
√â emerg√™ncia real quando:<br/>
1. a loja n√£o consegue operar sem aquele gasto agora;<br/>
2. n√£o d√° pra usar o cart√£o Clara (falha t√©cnica etc.).<br/><br/>
<b>ANTES</b> de tirar dinheiro do caixa, voc√™ precisa autoriza√ß√£o do Financeiro via chamado.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">Abrir chamado no ServiceNow</a><br/><br/>
Sem autoriza√ß√£o PR√âVIA, n√£o pode usar dinheiro do caixa e depois ‚Äúeu reembolso‚Äù.
</p>`;
        }

        function respUsoPessoal() {
            ultimaIntencao = "usoPessoal";
            return `HTML:<p class="text-sm text-slate-700">
Uso pessoal do cart√£o √© <b>proibido</b>.<br/><br/>
Para corrigir:<br/>
1. avisa o Financeiro;<br/>
2. marca a transa√ß√£o na Clara como "Despesa Pessoal ‚Äì Uso Indevido";<br/>
3. ressarce o valor em at√© 2 dias √∫teis.<br/><br/>
Se voc√™ n√£o ressarcir:<br/>
‚Ä¢ pode ter desconto em folha,<br/>
‚Ä¢ pode rolar medida disciplinar,<br/>
‚Ä¢ e o cart√£o pode ser bloqueado definitivamente pra voc√™.
</p>`;
        }

        function respOutraLoja() {
            ultimaIntencao = "outraLoja";
            return `HTML:<p class="text-sm text-slate-700">
Usar cart√£o de outra loja s√≥ pode em situa√ß√£o MUITO espec√≠fica:<br/><br/>
‚Ä¢ o gerente titular saiu / desligado,<br/>
‚Ä¢ ainda n√£o emitiram cart√£o novo pra loja,<br/>
‚Ä¢ Financeiro autorizou uso tempor√°rio.<br/><br/>
Obrigat√≥rio:<br/>
Na descri√ß√£o da compra na Clara escrever:
"Uso tempor√°rio do cart√£o na loja XXXX".<br/><br/>
Mudan√ßa de gerente / respons√°vel precisa ser formalizada por chamado pra atualizar quem responde pelo cart√£o.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow (troca de respons√°vel)
</a>
</p>`;
        }

        function respNotaFiscalRetencao() {
            ultimaIntencao = "notaFiscalRetencao";
            return `HTML:<p class="text-sm text-slate-700">
Mesmo depois de subir a nota fiscal/recibo na Clara, a loja precisa <b>guardar o documento f√≠sico original</b>.<br/><br/>
Prazo: manter guardado por <b>180 dias corridos</b>.<br/><br/>
A √°rea financeira pode pedir esses comprovantes f√≠sicos em auditoria.
</p>`;
        }

        function respAumentoLimite() {
            ultimaIntencao = "aumentoLimite";
            return `HTML:<p class="text-sm text-slate-700">
Sobre aumento de limite do cart√£o Clara üëá<br/><br/>
‚Ä¢ O limite √© definido por loja, √© mensal (pode ser ajustado pelo Financeiro).<br/>
‚Ä¢ Se voc√™ precisa gastar acima do limite padr√£o, isso tem que estar
  <b>justificado como necessidade operacional real</b> (n√£o uso pessoal).<br/><br/>
Como pedir:<br/>
1. Abra um chamado no ServiceNow para o Financeiro / Contas a Receber;<br/>
2. Informe a loja, a urg√™ncia e o motivo do aumento;<br/>
3. Deixe claro que √© despesa operacional da loja, n√£o gasto pessoal.<br/><br/>
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow (Aumento de limite)
</a><br/><br/>
Obs: Se for algo patrimonial (geladeira, TV, etc.) n√£o √© caso de aumentar limite. Vai pra Compras.
</p>`;
        }

        // etiqueta direta
        function respEtiquetaDireta(et) {
            // Resposta 100% em HTML para garantir link clic√°vel no final
            return `HTML:<div class="text-sm text-slate-700">
<p><b>Use a etiqueta:</b> "${et.nomeEtiqueta}"</p>
<p class="mt-2"><b>Entra nessa etiqueta:</b><br/>${et.gastosAtrelados}</p>

<p class="mt-4 text-slate-700">
<b>Como lan√ßar na Clara:</b><br/>
1. Anexar a nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar a etiqueta "${et.nomeEtiqueta}";<br/>
3. Escrever uma descri√ß√£o objetiva (ex.: "Teclado PDV loja 1234").<br/>
4. Fazer isso em at√© 48h ap√≥s a compra.<br/>
5. Guardar o documento f√≠sico na loja por 180 dias.
</p>

<p class="mt-4 text-[13px] text-slate-500">
Se n√£o existir etiqueta adequada na lista da Clara, solicite cria√ß√£o de nova etiqueta:
</p>
<p class="text-sm mt-1">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow para criar etiqueta
</a>
</p>
</div>`;
        }

        function respEtiqueta(msgNorm) {
            ultimaIntencao = "etiqueta";
            const e = acharEtiquetaPorMensagem(msgNorm);
            if (e) {
                return respEtiquetaDireta(e);
            }

            // fallback se a pessoa s√≥ escreveu "qual etiqueta?" sem contexto
            return `HTML:<div class="text-sm text-slate-700">
<p>Vou te ajudar a escolher a etiqueta certa üëá</p>

<p class="mt-3"><b>Exemplos comuns:</b></p>
<ul class="list-disc pl-5 mt-1">
<li>√Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL"</li>
<li>Coffee break autorizado / lanche p/ a√ß√£o oficial ‚Üí "LANCHES DE REFEI√á√ïES"</li>
<li>Teclado / mouse / cabo USB / pendrive ‚Üí "MATERIAL DE INFORM√ÅTICA"</li>
<li>Caneta / pasta / bloco / post-it ‚Üí "MATERIAL DE ESCRIT√ìRIO"</li>
<li>Motoboy urgente / sedex ‚Üí "TRANSPORTE SERVI√áOS EMERGENCIAS"</li>
<li>Chaveiro pra abrir estoque/cofre ‚Üí "CHAVEIRO EMERGENCIAL"</li>
<li>Trocar tomada / disjuntor / ajuste ar-condicionado ‚Üí "MANUTEN√á√ÉO ELETRICO" ou "MANUTEN√á√ÉO AR-CONDICIONADO"</li>
<li>Banner, adesivo, m√≠dia local ‚Üí "MARKETING_PUBLICIDADE E PROPAGANDA" ou "SERVI√áOS GR√ÅFICOS E DE COPIADORAS"</li>
</ul>

<p class="mt-4 text-[13px] text-slate-500">
Se nenhuma etiqueta existente encaixa, voc√™ pede cria√ß√£o de etiqueta nova via chamado:
</p>
<p class="text-sm mt-1">
<a class="bot-link" href="${SERVICE_NOW_URL}" target="_blank" rel="noopener noreferrer">
Abrir chamado no ServiceNow para criar etiqueta
</a>
</p>
</div>`;
        }

        function respGenerica() {
            ultimaIntencao = "generica";
            return `HTML:<p class="text-sm text-slate-700">
Vamos validar se isso pode ir no cart√£o Clara üëá<br/><br/>
1. √â despesa operacional da LOJA (necess√°ria pro funcionamento agora)?<br/>
&nbsp;&nbsp;- Ex.: chaveiro emergencial, √°gua pra equipe, motoboy urgente, material de limpeza, teclado do PDV.<br/><br/>
2. Voc√™ vai anexar nota fiscal/recibo, escolher etiqueta correta e descrever o gasto em at√© 48h?<br/><br/>
‚õî N√ÉO pode no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal etc.);<br/>
‚Ä¢ bebida alco√≥lica; lazer / comemora√ß√£o;<br/>
‚Ä¢ itens patrimoniais / equipamentos grandes (geladeira, micro-ondas, TV etc.).<br/><br/>
Se cair em "n√£o pode", precisa ressarcir. Se cair em "pode operacional", lan√ßa certo e dentro do prazo.
</p>`;
        }

        function respFollowup(ultimaIntencaoLocal, msgNorm) {
            // s√≥ responde follow-up contextual se faz sentido
            switch (ultimaIntencaoLocal) {
                case "transportePessoal":   return respTransportePessoalFollowup();
                case "alimentoTime":        return respAlimentoTimeFollowup(msgNorm);
                case "manutencao":          return respManutencaoFollowup(msgNorm);
                case "bloqueio":            return respBloqueioFollowup();
                case "justificar":          return respJustificarFollowup();
                case "etiqueta":
                    const e = acharEtiquetaPorMensagem(msgNorm);
                    if (e) return respEtiquetaDireta(e);
                    return respEtiqueta(msgNorm);
                default:
                    // se n√£o sei continuar contexto, volto pro gen√©rico
                    return respGenerica();
            }
        }

        // -----------------------
        // RENDER DO CHAT
        // -----------------------
        const chatWindow = document.getElementById("chatWindow");
        const chatForm = document.getElementById("chatForm");
        const userInput = document.getElementById("userInput");

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function renderUserMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 justify-end";

            const bubble = document.createElement("div");
            bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line";
            bubble.innerText = text;

            wrapper.appendChild(bubble);
            chatWindow.appendChild(wrapper);
        }

        function renderTyping() {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3 clara-typing";

            const avatar = document.createElement("div");
            avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
            avatar.innerText = "C";

            const bubble = document.createElement("div");
            bubble.className = "typing-bubble px-4 py-3 max-w-[80%] text-[13px]";
            bubble.innerHTML = `
                <span class="dot"></span>
                <span class="dot ml-1"></span>
                <span class="dot ml-1"></span>
                <span class="ml-2 text-slate-500">digitando...</span>
            `;

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);

            chatWindow.appendChild(wrapper);
            scrollToBottom();

            return wrapper;
        }

        // suporta HTML completo (come√ßando com "HTML:")
        function renderBotMessage(text) {
            const wrapper = document.createElement("div");
            wrapper.className = "flex items-start gap-3";

            const avatar = document.createElement("div");
            avatar.className = "w-9 h-9 rounded-xl bot-avatar flex items-center justify-center font-bold text-sm shadow-md flex-shrink-0";
            avatar.innerText = "C";

            const bubble = document.createElement("div");
            bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

            if (text.startsWith("HTML:")) {
                bubble.innerHTML = text.replace(/^HTML:/, "").trim();
            } else {
                bubble.innerText = text;
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);

            chatWindow.appendChild(wrapper);
        }

        // -----------------------
        // PIPELINE DE RESPOSTA
        // -----------------------
        chatForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const textoUsuario = userInput.value.trim();
            if (!textoUsuario) return;

            // mostra msg do usu√°rio
            renderUserMessage(textoUsuario);
            userInput.value = "";

            const typingEl = renderTyping();

            // prepara resposta
            const norm = normalize(textoUsuario);

            let resposta;
            let intent = classificarMensagem(textoUsuario);

            // follow-up curto? usar contexto da √∫ltima inten√ß√£o
            if (ehFollowUpCurto(norm) && ultimaIntencao && intent === "generica") {
                // mant√©m a √∫ltima inten√ß√£o atual
                resposta = respFollowup(ultimaIntencao, norm);
            } else {
                // inten√ß√£o nova
                switch (intent) {
                    case "foraDoEscopo":        resposta = respForaDoEscopo(); break;
                    case "politicaPdf":         resposta = respPoliticaPDF(); break;
                    case "servicenow":          resposta = respAumentoLimite(); break; // servicenow gen√©rico -> tratamos como aumentoLimite base + canal ServiceNow
                    case "aumentoLimite":       resposta = respAumentoLimite(); break;
                    case "bloqueio":            resposta = respBloqueio(); break;
                    case "justificar":          resposta = respJustificar(); break;
                    case "prazo48h":            resposta = respPrazo48h(); break;
                    case "bebidaAlcoolica":     resposta = respBebidaAlcoolica(); break;
                    case "eletronicos":         resposta = respEletronicos(); break;
                    case "eletrodomesticos":    resposta = respEletrodomesticos(); break;
                    case "transportePessoal":   resposta = respTransportePessoal(); break;
                    case "alimentoTime":        resposta = respAlimentoTime(); break;
                    case "manutencao":          resposta = respManutencao(); break;
                    case "emergenciaSangria":   resposta = respEmergenciaSangria(); break;
                    case "usoPessoal":          resposta = respUsoPessoal(); break;
                    case "outraLoja":           resposta = respOutraLoja(); break;
                    case "notaFiscalRetencao":  resposta = respNotaFiscalRetencao(); break;
                    case "etiqueta":            resposta = respEtiqueta(norm); break;
                    default:                    resposta = respGenerica(); break;
                }

                // atualiza √∫ltima inten√ß√£o s√≥ quando for algo "convers√°vel"
                if (["transportePessoal","alimentoTime","manutencao","bloqueio","justificar","etiqueta"].includes(intent)) {
                    ultimaIntencao = intent;
                } else {
                    ultimaIntencao = intent;
                }
            }

            // mostra resposta
            setTimeout(() => {
                typingEl.remove();
                renderBotMessage(resposta);
                scrollToBottom();
            }, 400);
        });
    </script>
</body>
</html>
