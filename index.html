<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Grupo CBF | Agente Clara</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        background-color:#f4f7fa;
    }
    .chat-wrapper {
        background:white;
        border-radius:1rem;
        box-shadow:0 25px 50px -12px rgba(0,0,0,.25);
        border:1px solid rgba(0,0,0,.05);
        max-width:800px;
        margin:2rem auto;
        display:flex;
        flex-direction:column;
        height:90vh;
    }

    /* HEADER */
    .chat-header-area {
        background-color:#FFFFFF;
        border-top-left-radius:1rem;
        border-top-right-radius:1rem;
        border-bottom:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
    }
    .chat-header-inner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        position:relative;
    }
    .chat-header-left {
        width:100%;
        text-align:center;
        color:#005E27;
    }
    .chat-header-left h1 {
        font-size:1.5rem;
        font-weight:800;
        color:#005E27;
        margin-bottom:0.5rem;
        background-color:#005E27;       /* fundo verde escuro */
        color:#B5FF20;                   /* texto verde claro */
        padding:.5rem .75rem;
        border-radius:.5rem;
        display:inline-block;
        text-align:center;
    }
    .chat-header-left p,
    .chat-header-left .examples,
    .chat-header-left .policy-note {
        color:#1e293b;
        text-align:center;
        margin-top:0.5rem;
    }
    .chat-header-avatar {
        position:absolute;
        top:0.5rem;
        right:1rem;
    }
    .chat-header-avatar img {
        height:72px;
        width:auto;
        object-fit:contain;
        filter:none; /* sem sombra */
    }

    /* BODY */
    .chat-body {
        flex:1 1 auto;
        overflow-y:auto;
        padding:1rem 1.25rem;
        background-color:#fff;
    }
    .chat-window {
        display:flex;
        flex-direction:column;
        gap:1rem;
        font-size:.9rem;
        line-height:1.4;
        color:#1e293b;
    }

    /* BUBBLES */
    .bot-bubble {
        background-color:#f1f5f9;
        border:1px solid rgba(0,0,0,.05);
        border-radius:.75rem;
        color:#1e293b;
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .user-bubble {
        background-color:#005E27;
        color:#fff;
        border-radius:.75rem;
        border:1px solid rgba(0,0,0,.2);
        box-shadow:0 10px 15px -3px rgba(0,0,0,0.2);
    }

    .service-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }
    .policy-link {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    /* FOOTER / INPUT */
    .chat-footer {
        border-top:1px solid rgba(0,0,0,.08);
        padding:1rem 1.25rem;
        background-color:#f8fafc;
        border-bottom-left-radius:1rem;
        border-bottom-right-radius:1rem;
    }

    .input-shell {
        background-color:#fff;
        border:1px solid rgba(0,0,0,.12);
        border-radius:.75rem;
        display:flex;
        align-items:flex-start;
        gap:.75rem;
        padding:.75rem 1rem;
        box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
    }
    .input-shell textarea {
        flex:1 1 auto;
        resize:none;
        min-height:40px;    /* caixa de digita√ß√£o menor */
        max-height:120px;
        font-size:0.9rem;
        line-height:1.4;
        color:#1e293b;
        outline:none;
        border:none;
        padding-top:0.5rem;
    }
    .input-shell button {
        background-color:#005E27;
        color:#fff;
        border:none;
        border-radius:.5rem;
        font-size:.8rem;
        font-weight:600;
        padding:.6rem .9rem;
        line-height:1.2;
        white-space:nowrap;
        cursor:pointer;
    }

    /* scrollbar do hist√≥rico */
    .chat-body::-webkit-scrollbar { width:6px; }
    .chat-body::-webkit-scrollbar-track { background:transparent; }
    .chat-body::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:3px; }

    /* links que aparecem nas respostas HTML do bot */
    .bot-bubble a {
        color:#005E27;
        font-weight:600;
        text-decoration:underline;
    }

    @media (max-width:640px){
        .chat-wrapper{
            height:90vh;
            border-radius:0;
            box-shadow:none;
            border:0;
            max-width:none;
            margin:0;
        }
        .chat-header-area{border-radius:0;}
        .chat-footer{border-radius:0;}
    }
</style>
</head>
<body class="text-slate-800">

<div class="chat-wrapper">

    <!-- HEADER -->
    <header class="chat-header-area">
        <div class="chat-header-inner">
            <div class="chat-header-left">
                <h1>Grupo SBF | Vektor</h1>

                <p>Pergunte sobre o uso do cart√£o Clara nas lojas.</p>

                <div class="examples">
                </div>

                <div class="policy-note text-[12px] mt-2">
                </div>
            </div>

            <div class="chat-header-avatar">
                <img src="Gemini_Generated_Image_nzni5znzni5znzni.png"
                     alt="Assistente Clara (rob√¥)" />
            </div>
        </div>
    </header>

    <!-- BODY -->
    <main class="chat-body">
        <div id="chatWindow" class="chat-window">

            <!-- Mensagem inicial do bot -->
            <div class="flex items-start gap-3">
                <img
                    src="Gemini_Generated_Image_nzni5znzni5znzni.png"
                    alt="Assistente Clara (rob√¥)"
                    class="h-14 w-auto object-contain flex-shrink-0"
                />
                <div class="bot-bubble px-4 py-3 max-w-[80%] text-sm text-slate-700">
                    <p class="font-semibold text-slate-800 text-base">
                        Ol√°! üëã Eu sou o Vektor, agente do <b>Grupo SBF</b> especializado na Clara.
                    </p>
                    <p class="text-slate-700 text-sm mt-1">
                        Pode me perguntar direto, tipo:<br/>
                        ‚Ä¢ "Posso comprar mouse?"<br/>
                        ‚Ä¢ "Como aumento o limite?"<br/>
                        ‚Ä¢ "Vou trocar de loja, o que fa√ßo com o cart√£o?"<br/>
                        ‚Ä¢ "Qual etiqueta pra √°gua/mineral?"<br/>
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Se o assunto n√£o tiver rela√ß√£o com a Pol√≠tica de Uso dos Cart√µes da Clara nas lojas eu n√£o estarei apto para responder.
                    </p>
                    <p class="text-[11px] text-slate-500 italic mt-2">
                        Quer o documento oficial completo?
                        <a class="policy-link"
                           href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing"
                           target="_blank" rel="noopener noreferrer">
                            Segue a Pol√≠tica de Uso dos Cart√µes Clara
                        </a>.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER / INPUT -->
    <footer class="chat-footer">
        <form id="chatForm" class="w-full">
            <div class="input-shell">
                <textarea id="userInput" placeholder="Digite sua d√∫vida sobre o cart√£o Clara..."></textarea>
                <button type="submit" id="sendBtn">Enviar</button>
            </div>
        </form>
    </footer>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

// =====================
// CONSULTA BLOQUEIO / PEND√äNCIAS VIA APPS SCRIPT
// =====================

// URL do Web App publicado no Apps Script
const URL_API_PENDENCIAS = "https://script.google.com/a/macros/gruposbf.com.br/s/AKfycbwl2JNiUq2sz2Yhds3Dh76DRFBZ_zqnqMt8AKo0dYhAWgLD-BmdPcFBuI0T4rzrlZTWdA/exec";

// estado para saber se o bot est√° aguardando o n√∫mero da loja
let modoConsultaPendencias = null;
let lojaUltimaConsulta = null;


/* =====================================================
   POL√çTICA (resumo orientador)
   ===================================================== */
const POLITICA_COMPLETA = `
1. O cart√£o Clara √© o meio oficial para despesas operacionais das lojas.
2. Toda compra tem que ser justificada na plataforma Clara em at√© 48h:
   - etiqueta correta,
   - nota fiscal/recibo anexado,
   - descri√ß√£o objetiva.
3. Despesa pessoal (roupa pro filho, almo√ßo pessoal, Uber pessoal, cinema, bebida alco√≥lica etc.) √© proibida.
   - Se acontecer, avisar Financeiro, classificar como "Despesa Pessoal ‚Äì Uso Indevido" e ressarcir em at√© 2 dias √∫teis.
4. Itens patrimoniais/infraestrutura (geladeira, micro-ondas, cafeteira el√©trica, TV, home theater, mesa, cadeira etc.) n√£o entram no cart√£o Clara. Isso segue fluxo de Compras / patrim√¥nio.
5. Lanches/√°gua podem ser pagos pelo cart√£o SOMENTE se forem ligados a opera√ß√£o autorizada:
   - treinamento oficial,
   - a√ß√£o aprovada (VM, regional, diretoria),
   - premia√ß√£o operacional autorizada.
   Usa etiqueta correta e descreve o motivo.
6. Se o gerente saiu e ainda n√£o existe novo gerente, o Financeiro pode autorizar uso tempor√°rio do cart√£o de outra loja.
   - Cada transa√ß√£o precisa ter descri√ß√£o tipo: "Uso tempor√°rio do cart√£o na loja 1234".
7. Aumento de limite: abrir chamado no ServiceNow explicando necessidade operacional e urg√™ncia.
8. Se bloqueou por falta de justificativa, precisa regularizar (nota, etiqueta, descri√ß√£o) para avaliar desbloqueio.
9. Contesta√ß√£o de compra n√£o reconhecida deve ser aberta em at√© 2 dias √∫teis via suporte da Clara, com envolvimento do Financeiro.
10. Sangria de caixa deixa de existir depois que a loja recebe o cart√£o Clara, s√≥ pode ser liberada como exce√ß√£o com autoriza√ß√£o financeira pr√©via.
`;

/* =====================================================
   Etiquetas oficiais padronizadas
   ===================================================== */
const etiquetasOficiais = [
    {
        nome: "AGUA POT√ÅVEL",
        palavrasChave: [
            "agua","√°gua","gal√£o","galao","garrafa de agua","garrafa de √°gua",
            "galao de agua","garrafa de √°gua","garrafa de agua"
        ],
        descricao: "Compra de gal√µes de √°gua mineral ou garrafas para abastecimento da equipe/loja, quando previsto operacionalmente.",
        observacaoUso: ""
    },
    {
        nome: "LANCHES DE REFEI√á√ïES",
        palavrasChave: [
            "lanche","lanche equipe","lanche da equipe","coffee break","cafe","caf√©",
            "pao","p√£o","bolo","salgado","biscoito","biscoitos","refrigerante",
            "refris","suco","suco natural","suquinho","lanchinho","kit lanche",
            "croissant","torta","doces treinamento","premia√ß√£o","premiacao"
        ],
        descricao: "Lanche / coffee break ligado a treinamento interno oficial, a√ß√£o aprovada (VM, regional, diretoria) ou premia√ß√£o operacional autorizada.",
        observacaoUso: "N√£o cobre almo√ßo pessoal ou lazer particular."
    },
    {
        nome: "MATERIAL DE INFORM√ÅTICA",
        palavrasChave: [
            "mouse","teclado","teclado pdv","cabo usb","cabos","pendrive","pen drive",
            "roteador","hub usb","fonte notebook","fonte","adaptador","cabo rede"
        ],
        descricao: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hub USB, cart√µes de mem√≥ria de baixo valor.",
        observacaoUso: "Serve para manter PDV/opera√ß√£o rodando. N√£o cobre TV, monitor grande, console etc."
    },
    {
        nome: "MATERIAL DE ESCRIT√ìRIO",
        palavrasChave: [
            "caneta","canetas","pasta","pastas","papel","bloco","blocos","caderno",
            "cadernos","etiqueta adesiva","grampeador","organizador de mesa","clips","clipes"
        ],
        descricao: "Canetas, clips, pastas, blocos de anota√ß√£o, grampeadores, etiquetas, organizadores de mesa.",
        observacaoUso: ""
    },
    {
        nome: "MATERIAL DE LIMPEZA",
        palavrasChave: [
            "detergente","desinfetante","sabonete","pano de ch√£o","pano de chao","pano",
            "alcool","√°lcool","papel toalha","vassoura","rodo","limpeza loja"
        ],
        descricao: "Detergente, desinfetante, pano de ch√£o, √°lcool, papel toalha, vassoura, rodo etc. para uso da loja.",
        observacaoUso: "Materiais para manuten√ß√£o da limpeza da loja."
    },
    {
        nome: "MATERIAL DE COPA E COZINHA",
        palavrasChave: [
            "copo descartavel","copo","talher","talheres","garrafa t√©rmica","garrafa termica",
            "pano de prato","pano prato","filtro de cafe","filtro de caf√©","pote plastico",
            "pote pl√°stico","potes"
        ],
        descricao: "Pratos, copos, talheres, filtros de caf√©, garrafas t√©rmicas, panos de prato, potes pl√°sticos.",
        observacaoUso: "N√ÉO inclui eletrodom√©stico (cafeteira el√©trica, micro-ondas, etc.)."
    },
    {
        nome: "MANUTEN√á√ÉO EL√âTRICO",
        palavrasChave: [
            "tomada","tomadas","disjuntor","disjuntores","interruptor","interruptores",
            "reator","soquete","soquetes","extensao","extens√£o","fia√ß√£o","fiacao",
            "eletrico","el√©trico"
        ],
        descricao: "Troca de tomadas, disjuntores, interruptores, pequenos reparos de fia√ß√£o de baixa tens√£o.",
        observacaoUso: "Servi√ßos simples e pontuais, baixo valor, para manter a loja operando."
    },
    {
        nome: "MANUTEN√á√ÉO AR-CONDICIONADO",
        palavrasChave: [
            "ar condicionado","ar-condicionado","arcondicionado","limpeza filtro ar",
            "carga de gas ar","controle remoto ar","manutencao ar","manuten√ß√£o ar",
            "controle ar"
        ],
        descricao: "Limpeza de filtro, carga de g√°s, troca de controle remoto ou ajuste simples de ar-condicionado.",
        observacaoUso: "Compra de um ar-condicionado novo n√£o entra."
    },
    {
        nome: "MANUTEN√á√ÉO CIVIL",
        palavrasChave: [
            "parafusar prateleira","arrumar porta","trocar fechadura loja","reparo parede",
            "trocar vidro","ajuste prateleira fixa","conserto parede","manuten√ß√£o civil",
            "manutencao civil"
        ],
        descricao: "Pequenos reparos f√≠sicos na loja (parede, porta, vidro, prateleira fixa), exceto chaveiro emergencial.",
        observacaoUso: ""
    },
    {
        nome: "MANUTEN√á√ÉO EQUIPAMENTOS",
        palavrasChave: [
            "conserto impressora etiqueta","manutencao impressora","ajuste maquina estampar",
            "maquina estampar","reparo computador loja","ferramenta manual",
            "manuten√ß√£o equipamentos","manutencao equipamentos"
        ],
        descricao: "Reparo de impressora de etiqueta, m√°quina de estampar, computador fora de garantia, ferramenta manual pequena.",
        observacaoUso: "Equipamento grande/patrimonial n√£o."
    },
    {
        nome: "CHAVEIRO EMERGENCIAL",
        palavrasChave: [
            "chaveiro","abrir cofre","abrir estoque","abrir vitrine","trocar segredo",
            "perdi a chave","sem chave cofre"
        ],
        descricao: "Servi√ßo emergencial de chaveiro para abrir cofre, estoque, vitrine.",
        observacaoUso: "Somente emerg√™ncia operacional real."
    },
    {
        nome: "TRANSPORTE SERVI√áOS EMERGENCIAS",
        palavrasChave: [
            "motoboy","moto boy","moto-boy","frete urgente","entrega urgente",
            "pegar documento na matriz","levar documento","sedex urgente","courier",
            "lalamove","lala move","frete local","frete local emergencial"
        ],
        descricao: "Frete local emergencial / motoboy para levar/pegar item ou documento cr√≠tico entre loja e matriz.",
        observacaoUso: "Uber / 99 pessoal n√£o entra aqui. Uber pessoal n√£o pode no cart√£o Clara."
    },
    {
        nome: "CORREIOS_SEDEX/AR/POSTAGEM",
        palavrasChave: [
            "sedex","correios","ar","postagem","envio documento",
            "carta registrada","devolucao correios","devolu√ß√£o correios"
        ],
        descricao: "Envio de documentos f√≠sicos via Sedex/AR/postagem oficial; devolu√ß√µes pequenas.",
        observacaoUso: ""
    },
    {
        nome: "SERVI√áOS GR√ÅFICOS E DE COPIADORAS",
        palavrasChave: [
            "banner","adesivo promocional","adesivo","flyer","folder",
            "encadernacao","encaderna√ß√£o","material visual loja",
            "impressao grafica","impress√£o gr√°fica"
        ],
        descricao: "Impress√£o de banners, adesivos promocionais, folders, encaderna√ß√µes, material visual da loja.",
        observacaoUso: ""
    },
    {
        nome: "BOBINA ECF",
        palavrasChave: [
            "bobina","bobina ecf","bobina fiscal","bobina impressora fiscal",
            "ecf","cupom fiscal","bobina pdv","bobina caixa"
        ],
        descricao: "Bobina para ECF / impressora fiscal / PDV onde n√£o h√° fornecimento centralizado.",
        observacaoUso: ""
    }
];

/* =====================================================
   Normaliza√ß√£o
   ===================================================== */
function normalize(str) {
    return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

/* =====================================================
   Inten√ß√£o
   ===================================================== */
function detectarIntencaoPergunta(msgNorm) {

    // fora de escopo
    const foraEscopoPadroes = [
        "palmeiras","corinthians","bolsonaro","lula","eleicao","elei√ß√£o",
        "presidente","futebol","time joga","campeonato","xing","vai tomar",
        "conta de matematica","conta de matem√°tica","2+2","raiz quadrada",
        "piada","xingar","palavr√£o","palavrao"
    ];
    for (const termo of foraEscopoPadroes) {
        if (msgNorm.includes(normalize(termo))) {
            return "foraEscopo";
        }
    }

    // etiqueta
    if (msgNorm.includes("etiqueta") ||
        msgNorm.includes("qual etiqueta") ||
        msgNorm.includes("que etiqueta")) {
        return "etiqueta";
    }

    // limite
    if (
        msgNorm.includes("aumentar limite") ||
        msgNorm.includes("aumento de limite") ||
        msgNorm.includes("limite maior") ||
        msgNorm.includes("limite do cartao") ||
        msgNorm.includes("limite do cart√£o") ||
        msgNorm.includes("limite nao basta") ||
        msgNorm.includes("limite n√£o basta") ||
        msgNorm.includes("limite acabou") ||
        msgNorm.includes("limite estourou")
    ) {
        return "limite";
    }

    // bloqueio
    if (
        msgNorm.includes("bloqueou") ||
        msgNorm.includes("bloqueado") ||
        msgNorm.includes("desbloquear") ||
        msgNorm.includes("cartao travou") ||
        msgNorm.includes("cart√£o travou") ||
        msgNorm.includes("travou o cartao") ||
        msgNorm.includes("travou o cart√£o") ||
        msgNorm.includes("bloqueio preventivo")
    ) {
        return "bloqueio";
    }

    // presta√ß√£o de contas
    if (
        msgNorm.includes("como justificar") ||
        msgNorm.includes("justificar compra") ||
        msgNorm.includes("prestar contas") ||
        msgNorm.includes("prestacao de contas") ||
        msgNorm.includes("presta√ß√£o de contas") ||
        msgNorm.includes("colocar nota") ||
        msgNorm.includes("anexar nota") ||
        msgNorm.includes("descricao na clara") ||
        msgNorm.includes("descri√ß√£o na clara")
    ) {
        return "prestacao";
    }

    // lanche / √°gua / equipe
    if (
        msgNorm.includes("lanche") ||
        msgNorm.includes("lanche pro time") ||
        msgNorm.includes("lanche para o time") ||
        msgNorm.includes("cafe pro time") ||
        msgNorm.includes("caf√© pro time") ||
        msgNorm.includes("coffee break") ||
        msgNorm.includes("agua") ||
        msgNorm.includes("√°gua") ||
        msgNorm.includes("gal√£o") ||
        msgNorm.includes("galao") ||
        msgNorm.includes("premiacao") ||
        msgNorm.includes("premia√ß√£o")
    ) {
        return "alimentoTime";
    }

    // uber / transporte pessoal
    if (
        msgNorm.includes("uber") ||
        msgNorm.includes("Uber") ||
        msgNorm.includes("99") ||
        msgNorm.includes("taxi") ||
        msgNorm.includes("Taxi") ||
        msgNorm.includes("T√°xi") ||
        msgNorm.includes("t√°xi") ||
        msgNorm.includes("app de transporte")
    ) {
        return "transportePessoal";
    }

    // troca de gerente / transfer√™ncia de loja
    if (
        msgNorm.includes("mudar de loja") ||
        msgNorm.includes("troca de loja") ||
        msgNorm.includes("trocar de loja") ||
        msgNorm.includes("mudan√ßa de loja") ||
        msgNorm.includes("mudanca de loja") ||
        msgNorm.includes("vou mudar de loja") ||
        msgNorm.includes("fui transferido") ||
        msgNorm.includes("transferido de loja") ||
        msgNorm.includes("transferencia de loja") ||
        msgNorm.includes("transfer√™ncia de loja") ||
        msgNorm.includes("gerente desligado") ||
        msgNorm.includes("sem gerente") ||
        msgNorm.includes("gerente saiu") ||
        msgNorm.includes("gerente saiu da loja") ||
        msgNorm.includes("cartao de outra loja") ||
        msgNorm.includes("cart√£o de outra loja") ||
        msgNorm.includes("usar cartao de outra loja") ||
        msgNorm.includes("usar cart√£o de outra loja")
    ) {
        return "trocaGerente";
    }

    // sangria
    if (
        msgNorm.includes("sangria") ||
        msgNorm.includes("sangrias") ||
        msgNorm.includes("Sangria") ||
        msgNorm.includes("Sangrias") ||
        msgNorm.includes("fazer sangria") ||
        msgNorm.includes("puxar dinheiro do caixa") ||
        msgNorm.includes("retirar dinheiro do caixa")
    ) {
        return "sangria";
    }

    // fraude / contesta√ß√£o
    if (
        msgNorm.includes("nao reconheco") ||
        msgNorm.includes("n√£o reconhe√ßo") ||
        msgNorm.includes("fraude") ||
        msgNorm.includes("compra indevida") ||
        msgNorm.includes("compra indevida no cartao") ||
        msgNorm.includes("compra indevida no cart√£o") ||
        msgNorm.includes("contestar compra") ||
        msgNorm.includes("contestacao") ||
        msgNorm.includes("contesta√ß√£o")
    ) {
        return "fraudeContestacao";
    }

    // posso comprar...? posso usar...?
    if (
        msgNorm.includes("posso comprar") ||
        msgNorm.includes("posso usar") ||
        msgNorm.includes("pode usar") ||
        msgNorm.includes("pode pagar") ||
        msgNorm.includes("pode gastar") ||
        msgNorm.includes("pode comprar") ||
        msgNorm.includes("pode no cartao") ||
        msgNorm.includes("pode no cart√£o") ||
        msgNorm.includes("pode colocar no cartao") ||
        msgNorm.includes("pode colocar no cart√£o")
    ) {
        return "podeNaoPode";
    }

    return "generica";
}

/* =====================================================
   Achar etiqueta por mensagem
   ===================================================== */

function acharEtiquetaPorMensagem(msgNorm) {
    // palavras que N√ÉO podem sozinhas disparar uma etiqueta,
    // porque s√£o gen√©ricas demais e aparecem em qualquer pergunta
    const stopTerms = [
        "etiqueta",
        "qual etiqueta",
        "que etiqueta",
        "categoria",
        "qual categoria",
        "classificacao",
        "classifica√ß√£o",
        "tag",
        "pode usar",
        "posso usar",
        "posso comprar",
        "pode comprar",
        "cartao",
        "cart√£o",
        "cartao clara",
        "cart√£o clara",
        "clara",
        "limite",
        "ajuda",
        "duvida",
        "d√∫vida"
    ].map(normalize);

    // vamos quebrar a pergunta do usu√°rio em palavras
    const palavras = msgNorm.split(/\s+/);

    // melhor correspond√™ncia encontrada at√© agora
    let melhorMatch = null;
    let melhorForca = 0;

    for (const et of etiquetasOficiais) {
        let forcaAtual = 0;

        for (const termoOriginal of et.palavrasChave) {
            const termoNorm = normalize(termoOriginal);

            // ignora termos gen√©ricos
            if (stopTerms.includes(termoNorm)) {
                continue;
            }

            // match exato de palavra (melhor, mais forte)
            if (palavras.includes(termoNorm)) {
                forcaAtual += 2;
            }

            // match por substring (mais fraco, mas ainda conta)
            if (msgNorm.includes(termoNorm)) {
                forcaAtual += 1;
            }
        }

        // escolhe a etiqueta s√≥ se ela teve alguma for√ßa (>0)
        if (forcaAtual > melhorForca) {
            melhorForca = forcaAtual;
            melhorMatch = et;
        }
    }

    // se nenhuma etiqueta teve match espec√≠fico de verdade, n√£o retorna nada
    if (melhorForca === 0) {
        return null;
    }

    return melhorMatch;
}

/* =====================================================
   Avaliar compra espec√≠fica
   ===================================================== */
function avaliarCompraEspecifica(msgNorm) {
    // 1. casos claramente proibidos (patrim√¥nio grande, uso pessoal, bebida alco√≥lica, etc.)
    const proibidosPatrimonio = [
        "geladeira", "microondas", "micro-ondas", "tv", "televisao", "televis√£o",
        "home theater", "mesa", "cadeira", "friogrifico", "freezer",
        "ar condicionado", "ar-condicionado", "frigobar",
        "carro", "carro da loja", "veiculo", "ve√≠culo", "moto",
        "playstation", "ps5", "xbox", "video game", "videogame",
        "som ambiente", "caixa de som grande", "caixa de som", "soundbar",
        "projetor", "tel√£o", "tela gigante", "foguete", "foguetes", "foguetinho"
    ].map(normalize);

    for (const palavra of proibidosPatrimonio) {
        if (msgNorm.includes(palavra)) {
            return {
                pode: false,
                resposta: `Isso √© item patrimonial / infraestrutura de loja ou bem de alto valor. Esses itens N√ÉO podem ser comprados com o cart√£o Clara. Eles devem seguir o processo de Compras / aprova√ß√£o formal, n√£o o cart√£o da loja.`
            };
        }
    }

    // 2. refei√ß√£o pessoal expl√≠cita ("paguei meu almo√ßo", "meu jantar", etc.)
    const pessoalAlim = [
        "meu almoco","meu almo√ßo","meu jantar","meu lanche","paguei meu almoco",
        "paguei meu almo√ßo","paguei meu jantar","paguei meu lanche","minha comida",
        "comida pra mim","refeicao pessoal","refei√ß√£o pessoal","jantar pessoal",
        "almoco pessoal","almo√ßo pessoal","lanche pessoal"
    ].map(normalize);

    for (const termo of pessoalAlim) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja. Se j√° foi pago no cart√£o, precisa sinalizar como "Despesa Pessoal ‚Äì Uso Indevido", avisar o Financeiro e ressarcir.`
            };
        }
    }

    // 3. bebida alco√≥lica
    const alcool = ["cerveja","vodka","vinho","whisky","whiskey","cacha√ßa","cachaca","gin","tequila"].map(normalize);
    for (const termo of alcool) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Bebida alco√≥lica n√£o √© permitida no cart√£o Clara. Isso n√£o √© considerado despesa operacional autorizada.`
            };
        }
    }

    // 4. transporte pessoal (uber pra voc√™ ir pra casa, etc.)
    const transportePessoal = ["uber","99","taxi","t√°xi","tax√≠","cabify"].map(normalize);
    for (const termo of transportePessoal) {
        if (msgNorm.includes(termo)) {
            return {
                pode: false,
                resposta: `Uber / 99 / t√°xi para deslocamento pessoal n√£o pode no cart√£o Clara. N√£o √© gasto operacional direto da loja.`
            };
        }
    }

    // 5. alimenta√ß√£o/equipe/a√ß√£o autorizada (coffee break, √°gua pra equipe, lanche de treinamento)
    // aqui PODE, mas s√≥ se for claramente pra equipe/treinamento/a√ß√£o oficial
    const palavrasTime = [
        "coffee break","lanche pra equipe","lanche para equipe","lanche equipe",
        "lanche time","lanche pro time","lanche para o time",
        "treinamento","premiacao","premia√ß√£o","acao oficial","a√ß√£o oficial",
        "acao vm","a√ß√£o vm","acao regional","a√ß√£o regional",
        "agua pra equipe","√°gua pra equipe","gal√£o de agua","gal√£o de √°gua",
        "gal√£o","gal√£o de agua","salgadinho pra treinamento","bolo pra treinamento",
        "suco pra treinamento","suco para treinamento","lanche treinamento"
    ].map(normalize);

    for (const termo of palavrasTime) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "LANCHES DE REFEI√á√ïES / √ÅGUA POT√ÅVEL",
                    desc: "Coffee break autorizado, √°gua/lanche para equipe em treinamento interno aprovado, a√ß√£o oficial da loja (VM, regional, diretoria) ou premia√ß√£o operacional.",
                    exemploDescricao: "Coffee break treinamento VM loja 1234"
                },
                resposta: `Pode usar o cart√£o Clara se for a√ß√£o autorizada (treinamento interno, VM, regional, diretoria, premia√ß√£o operacional). Precisa lan√ßar na Clara em at√© 48h com nota fiscal, etiqueta correta e descri√ß√£o objetiva.`
            };
        }
    }

    // 6. perif√©ricos / pequenos itens operacionais (mouse, teclado, cabo USB, pendrive etc.)
    const perifOperacional = [
        "mouse","teclado","cabo usb","usb","pendrive","fonte de notebook",
        "hub usb","roteador","teclado pdv","teclado do pdv","teclado caixa","bobina ecf","bobina fiscal"
    ].map(normalize);

    for (const termo of perifOperacional) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "MATERIAL DE INFORM√ÅTICA",
                    desc: "Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (sem controle patrimonial).",
                    exemploDescricao: "Teclado PDV loja 1234"
                },
                resposta: `Esse tipo de material (ex.: mouse, teclado, cabo) √© considerado suprimento operacional de baixo valor para a loja e pode ser pago no cart√£o Clara, desde que classificado corretamente e lan√ßado em at√© 48h.`
            };
        }
    }

    // 7. chaveiro emergencial, motoboy, sedex
    const servicoEmerg = [
        "chaveiro","abrir cofre","abrir estoque","perdi a chave","motoboy","sedex","correios","envio de documento","postar documento","postar nota","mandar documento","enviar documento"
    ].map(normalize);

    for (const termo of servicoEmerg) {
        if (msgNorm.includes(termo)) {
            return {
                pode: true,
                etiquetaValida: {
                    nome: "TRANSPORTE SERVI√áOS EMERGENCIAS / CORREIOS_SEDEX/AR/POSTAGEM / CHAVEIRO EMERGENCIAL",
                    desc: "Motoboy emergencial, envio urgente de documentos (Sedex/AR/postagem oficial), chaveiro emergencial para abrir estoque/cofre.",
                    exemploDescricao: "Motoboy urgente documenta√ß√£o loja 1234"
                },
                resposta: `Servi√ßos emergenciais (motoboy urgente, Sedex de documento oficial, chaveiro emergencial pra abrir estoque/cofre) podem usar o cart√£o Clara, desde que sejam necessidade imediata da opera√ß√£o e sejam justificados na Clara dentro de 48h.`
            };
        }
    }

    // 8. Se n√£o classificou em nada espec√≠fico:
    return {
        pode: null,
        resposta: `N√£o ficou claro se isso √© uma despesa operacional imediata da loja ou algo pessoal/patrimonial.`
    };
}

/* =====================================================
   Respostas por inten√ß√£o
   ===================================================== */
function respostaForaEscopo() {
    return `HTML:<p class="text-sm text-slate-700">
Sou um agente especializado na Pol√≠tica de Uso dos Cart√µes Clara nas lojas. N√£o consigo responder esse tipo de assunto.
</p>`;
}

function respEtiquetaDireta(et) {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiqueta correta:</b> "${et.nome}".</p>
<p class="mt-1"><b>O que cobre:</b> ${et.descricao}</p>
${et.observacaoUso ? `<p class="mt-1 text-slate-700"><i>${et.observacaoUso}</i></p>` : ""}

<p class="mt-2">
Lan√ßar na Clara em at√© 48h:<br/>
1. Anexar nota fiscal/recibo (foto leg√≠vel);<br/>
2. Selecionar "${et.nome}";<br/>
3. Descrever objetivamente o gasto (ex.: "Teclado PDV loja 1234");<br/>
4. Guardar o documento f√≠sico na loja por pelo menos 180 dias.
</p>
</div>`;
}

function respLimite() {
    return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
}

function respBloqueio() {
    return `HTML:<p class="text-sm text-slate-700">
O bloqueio preventivo acontece quando tem alguma compra sem justificar na Clara dentro do prazo (at√© 48h):<br/>
‚Ä¢ faltou nota fiscal/recibo;<br/>
‚Ä¢ n√£o colocou etiqueta correta;<br/>
‚Ä¢ descri√ß√£o n√£o explica o uso operacional.<br/><br/>
Passos pra desbloquear:<br/>
1. Regulariza a transa√ß√£o na plataforma (anexa nota, escolher etiqueta certa, descrever o motivo real).<br/>
2. Encaminhar chamado via ServiceNow para desbloqueio.<br/><br/>
Reincid√™ncia pode fazer a loja perder permiss√£o de uso do cart√£o.
</p>`;
}

function respPoliticaOficial() {
    return `HTML:<div class="text-sm text-slate-700">
<p>Seguem as regras oficiais de refer√™ncia da empresa.</p>
<p>
<a class="service-link" href="https://drive.google.com/file/d/1pDftfaJOPUra0-0gAeK2ziJ3llyscvjx/view?usp=sharing" target="_blank" rel="noopener noreferrer">
<strong>Pol√≠tica de Uso dos Cart√µes Clara (documento oficial)</strong>
</a>.
</p>
<p>Use sempre esse documento como fonte final.</p>
</div>`;
}

function respCatalogoEtiquetas() {
    return `HTML:<div class="text-sm text-slate-700">
<p><b>Etiquetas oficiais e quando usar:</b></p>

<p class="mt-2"><b>MATERIAL DE INFORM√ÅTICA</b><br/>
Mouse, teclado, cabos, pendrive, suportes de notebook, fontes, roteadores, hubs USB, cart√µes de mem√≥ria (baixo valor, sem controle patrimonial).<br/>
Exemplo de descri√ß√£o: "Teclado PDV loja 1234".</p>

<p class="mt-2"><b>MATERIAL DE ESCRIT√ìRIO</b><br/>
Caneta, pasta, bloco de anota√ß√£o, grampeador, etiqueta adesiva, organizador de mesa, papelaria b√°sica da opera√ß√£o administrativa da loja.</p>

<p class="mt-2"><b>AGUA POT√ÅVEL</b><br/>
Gal√£o de √°gua mineral / garrafas de √°gua para abastecimento da equipe ou uso da loja, quando previsto e autorizado operacionalmente.</p>

<p class="mt-2"><b>LANCHES DE REFEI√á√ïES</b><br/>
Coffee break ou lanche para treinamento interno autorizado, a√ß√£o oficial da √°rea (VM, regional, diretoria) ou premia√ß√£o operacional da equipe (n√£o vale refei√ß√£o pessoal).</p>

<p class="mt-2"><b>TRANSPORTE SERVI√áOS EMERGENCIAS</b><br/>
Motoboy emergencial / frete local urgente para levar ou buscar material importante entre lojas ou matriz.</p>

<p class="mt-2"><b>CORREIOS_SEDEX/AR/POSTAGEM</b><br/>
Envio de documentos oficiais da loja via Sedex/AR/postagem. Tamb√©m serve para devolu√ß√µes pequenas quando for processo formal.</p>

<p class="mt-2"><b>CHAVEIRO EMERGENCIAL</b><br/>
Abertura urgente de cofre / estoque / sala administrativa quando houve perda de chave ou travamento, s√≥ em situa√ß√£o emergencial.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO CIVIL</b><br/>
Pequenos reparos estruturais internos de baixa complexidade: ajuste em porta, troca de vidro quebrado, fixar prateleira, ajuste de revestimento etc.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO EL√âTRICA</b><br/>
Troca de tomada, disjuntor, interruptor, soquete, reator, extens√£o, pequenos reparos de baixa tens√£o necess√°rios pro funcionamento da loja.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO AR-CONDICIONADO</b><br/>
Limpeza de filtro, troca de controle remoto, carga de g√°s simples, pequenos ajustes que mantenham o ar funcionando.</p>

<p class="mt-2"><b>BOBINA ECF</b><br/>
Bobina fiscal / bobina de impressora obrigat√≥ria pro PDV, quando n√£o h√° fornecimento centralizado.</p>

<p class="mt-2"><b>SERVI√áOS GR√ÅFICOS E DE COPIADORAS</b><br/>
Impress√£o de banner, adesivo de campanha, plotagem promocional, encaderna√ß√£o de material de comunica√ß√£o da loja.</p>

<p class="mt-2"><b>MARKETING / PUBLICIDADE E PROPAGANDA</b><br/>
A√ß√£o promocional local autorizada, compra de brindes para campanha, m√≠dia local aprovada, banner promocional, impulsionamento oficial autorizado.</p>

<p class="mt-2"><b>MANUTEN√á√ÉO EQUIPAMENTOS</b><br/>
Ajustes/reparos em m√°quinas de estampar, impressoras de etiqueta, computadores fora de garantia e de baixo valor etc. (nada de compra de equipamento grande).</p>

<p class="mt-4">Se voc√™ n√£o encontrou nada que encaixa no seu caso, abra chamado no 
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer"><strong>ServiceNow</strong></a>
pedindo cria√ß√£o ou libera√ß√£o de etiqueta.</p>
</div>`;
}

function respPrestacaoContas() {
    return `HTML:<p class="text-sm text-slate-700">
Toda compra no cart√£o Clara precisa ser lan√ßada na plataforma Clara em at√© 48h:<br/>
1. Anexar nota fiscal ou recibo;<br/>
2. Selecionar a etiqueta correta (ex.: "MATERIAL DE INFORM√ÅTICA", "AGUA POT√ÅVEL");<br/>
3. Preencher a descri√ß√£o objetiva, dizendo o que foi comprado e para qu√™.<br/><br/>
Os comprovantes f√≠sicos devem ficar guardados na loja por pelo menos 180 dias corridos. N√£o justificar no prazo => risco de bloqueio preventivo.
</p>`;
}

function respAlimentoTime() {
    return `HTML:<p class="text-sm text-slate-700">
Pode usar o cart√£o Clara para √°gua / lanche / coffee break se for algo operacional AUTORIZADO, tipo:<br/>
‚Ä¢ treinamento interno oficial,<br/>
‚Ä¢ a√ß√£o aprovada (VM, regional, diretoria),<br/>
‚Ä¢ premia√ß√£o operacional autorizada.<br/><br/>
N√£o pode usar para lazer pessoal, almo√ßo pessoal ou comemora√ß√£o particular.<br/><br/>
Etiquetas usadas:<br/>
‚Ä¢ √Ågua / gal√£o ‚Üí "AGUA POT√ÅVEL";<br/>
‚Ä¢ Coffee break autorizado / lanche de treinamento ‚Üí "LANCHES DE REFEI√á√ïES".<br/><br/>
Sempre anexar nota e descrever, por ex.: "Coffee break treinamento VM loja 1234".
</p>`;
}

function respTransportePessoal() {
    return `HTML:<p class="text-sm text-slate-700">
Uber / 99 / t√°xi pra deslocamento pessoal n√£o pode ser pago com o cart√£o Clara. Isso n√£o √© gasto operacional direto da loja. O procedimento correto √© solicitar via aplicativo com a conta corporativa da empresa.<br/>
Se j√° usou de forma pessoal (pagando do pr√≥prio bolso) e quer o reembolso:<br/>
‚Ä¢ Solicite o reembolso atrav√©s da plataforma Vexpenses (√© necess√°rio autoriza√ß√£o do seu gestor).

</p>`;
}

function respTrocaGerente() {
    return `HTML:<p class="text-sm text-slate-700">
Troca de gerente / mudan√ßa de loja segue assim:<br/><br/>
1. Se o gerente titular saiu e ainda n√£o tem novo cart√£o da nova gest√£o:<br/>
   ‚Ä¢ O Financeiro pode autorizar uso TEMPOR√ÅRIO do cart√£o de outra loja.<br/>
   ‚Ä¢ Cada compra precisa ter na descri√ß√£o da Clara algo como:<br/>
     "Uso tempor√°rio do cart√£o na loja 1234".<br/>
   ‚Ä¢ Isso garante que o custo v√° pra loja certa no fechamento.<br/><br/>
2. Se √© s√≥ f√©rias/afastamento curto do gerente:<br/>
   ‚Ä¢ o cart√£o da pr√≥pria loja continua sendo usado pelo l√≠der/supervisor autorizado;<br/>
   ‚Ä¢ n√£o √© pra circular cart√£o entre lojas sem autoriza√ß√£o financeira.<br/><br/>
Se tiver caso especial, fale com o Financeiro e, se preciso, abra chamado no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
ServiceNow
</a>.
</p>`;
}

function respSangria() {
    return `HTML:<p class="text-sm text-slate-700">
Depois que a loja recebeu o cart√£o Clara e fez o treinamento, o processo de sangria em dinheiro pra pagar despesa operacional √© DESCONTINUADO.<br/><br/>
Ou seja: a loja n√£o deve mais tirar dinheiro do caixa pra pagar gasto de opera√ß√£o. Tudo vai no cart√£o Clara, com justificativa na plataforma.<br/><br/>
S√≥ em caso de exce√ß√£o real (cart√£o sem funcionar e gasto urgente da opera√ß√£o) o Financeiro pode liberar temporariamente uma sangria. Isso precisa de autoriza√ß√£o pr√©via e justificativa formal.
</p>`;
}

function respFraudeContestacao() {
    return `HTML:<p class="text-sm text-slate-700">
Se apareceu uma compra que voc√™ <b>n√£o reconhece</b> no cart√£o Clara:<br/><br/>
1. Avise o Financeiro imediatamente.<br/>
2. Abrir contesta√ß√£o com o suporte da Clara em at√© 2 dias √∫teis ap√≥s a transa√ß√£o.<br/>
3. Durante a an√°lise a operadora pode bloquear o cart√£o preventivamente.<br/><br/>
Isso √© diferente de gasto pessoal reconhecido (tipo Uber pessoal). Se a compra foi pessoal, a√≠ precisa ressarcir em at√© 2 dias √∫teis; n√£o √© contesta√ß√£o.
</p>`;
}

function consultarPendenciasLoja(lojaCodigo) {
    if (!URL_API_PENDENCIAS) {
        renderBotMessage(
            'HTML:<p class="text-sm text-slate-700">N√£o tenho uma URL configurada para consultar a planilha de pend√™ncias no momento.</p>'
        );
        return;
    }

    const loja = (lojaCodigo || "").toString().replace(/\D/g, "");
    if (!loja) {
        renderBotMessage(
            'HTML:<p class="text-sm text-slate-700">N√£o entendi o n√∫mero da loja. Me envie s√≥ o c√≥digo num√©rico, por exemplo: <b>0171</b>.</p>'
        );
        return;
    }

    renderBotMessage(
        `HTML:<p class="text-sm text-slate-700">Beleza! Vou consultar as pend√™ncias Clara da loja <b>${loja}</b>‚Ä¶</p>`
    );

    fetch(`${URL_API_PENDENCIAS}?mode=json&loja=${encodeURIComponent(loja)}`)
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">N√£o consegui consultar as pend√™ncias da loja <b>${loja}</b>.<br/>Detalhe: ${data.error || "erro desconhecido"}</p>`
                );
                aguardandoLojaPendencias = false;
                aguardandoEmailPendencias = false;
                lojaPendenciasAtual = "";
                return;
            }

            if (!data.rows || data.rows.length === 0) {
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">N√£o encontrei pend√™ncias Clara para a loja <b>${loja}</b> na √∫ltima data de cobran√ßa.</p>`
                );
                aguardandoLojaPendencias = false;
                aguardandoEmailPendencias = false;
                lojaPendenciasAtual = "";
                return;
            }

            // Achou pend√™ncias: guarda loja e pede o e-mail
            lojaPendenciasAtual = loja;
            aguardandoLojaPendencias = false;
            aguardandoEmailPendencias = true;

            renderBotMessage(
                `HTML:<p class="text-sm text-slate-700">
Encontrei pend√™ncias Clara para a loja <b>${loja}</b> (data de cobran√ßa <b>${data.ultimaData || "-"}</b>).<br/>
Me envia agora o seu e-mail corporativo para eu mandar o resumo (ex.: <b>nome.sobrenome@gruposbf.com.br</b>).
</p>`
            );
        })
        .catch(err => {
            console.error("Erro ao chamar API de pend√™ncias:", err);
            renderBotMessage(
                'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar consultar as pend√™ncias dessa loja. Tente novamente mais tarde.</p>'
            );
            aguardandoLojaPendencias = false;
            aguardandoEmailPendencias = false;
            lojaPendenciasAtual = "";
        });
}

function enviarPendenciasPorEmail(emailTexto) {
    if (!URL_API_PENDENCIAS || !lojaPendenciasAtual) {
        renderBotMessage(
            'HTML:<p class="text-sm text-slate-700">N√£o tenho os dados da loja carregados. Tente pedir novamente para consultar as pend√™ncias da sua loja.</p>'
        );
        aguardandoEmailPendencias = false;
        return;
    }

    const email = emailTexto.trim();
    const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!regexEmail.test(email)) {
        renderBotMessage(
            'HTML:<p class="text-sm text-slate-700">Esse e-mail parece inv√°lido. Me envia no formato: <b>nome.sobrenome@gruposbf.com.br</b>.</p>'
        );
        return;
    }

    renderBotMessage(
        `HTML:<p class="text-sm text-slate-700">Perfeito! Vou enviar o resumo das pend√™ncias Clara da loja <b>${lojaPendenciasAtual}</b> para <b>${email}</b>‚Ä¶</p>`
    );

    fetch(
        `${URL_API_PENDENCIAS}?mode=email&loja=${encodeURIComponent(
            lojaPendenciasAtual
        )}&email=${encodeURIComponent(email)}`
    )
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                renderBotMessage(
                    `HTML:<p class="text-sm text-slate-700">Tentei enviar o e-mail, mas deu erro: ${data.error || "erro desconhecido"}.</p>`
                );
            } else {
                renderBotMessage(
                    'HTML:<p class="text-sm text-slate-700">E-mail enviado com sucesso! ‚úÖ<br/>Verifique sua caixa de entrada (e eventualmente o lixo eletr√¥nico).</p>'
                );
            }
            aguardandoEmailPendencias = false;
            lojaPendenciasAtual = "";
        })
        .catch(err => {
            console.error("Erro ao enviar e-mail de pend√™ncias:", err);
            renderBotMessage(
                'HTML:<p class="text-sm text-slate-700">Tive um erro ao tentar enviar o e-mail com as pend√™ncias. Tente novamente mais tarde.</p>'
            );
            aguardandoEmailPendencias = false;
            lojaPendenciasAtual = "";
        });
}

    
/* =====================================================
   Fallback / resposta gen√©rica com pol√≠tica
   ===================================================== */

let ultimaIntencao = null;

// ===== Fluxo de consulta de pend√™ncias Clara (planilha) =====
let aguardandoLojaPendencias = false;
let aguardandoEmailPendencias = false;
let lojaPendenciasAtual = "";

function respGenerica(msgNorm) {
    const avaliacao = avaliarCompraEspecifica(msgNorm);

    // CASO 1: claramente proibido
    if (avaliacao.pode === false) {
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚õî N√£o pode usar o cart√£o Clara pra isso.</b></p>
<p>${avaliacao.resposta}</p>
</div>`;
    }

    // CASO 2: claramente permitido E tem etiqueta coerente
    if (avaliacao.pode === true && avaliacao.etiquetaValida) {
        const et = avaliacao.etiquetaValida;
        return `HTML:<div class="text-sm text-slate-700">
<p><b>‚úÖ Pode usar o cart√£o Clara (despesa operacional autorizada).</b></p>
<p>Use a etiqueta: "<b>${et.nome}</b>".</p>
<p class="mt-1">${et.desc}</p>
<p class="mt-2"><b>Como lan√ßar na Clara (at√© 48h):</b><br/>
‚Ä¢ Anexar a nota fiscal/recibo;<br/>
‚Ä¢ Selecionar "${et.nome}";<br/>
‚Ä¢ Descrever objetivamente o gasto (ex.: "${et.exemploDescricao}");<br/>
‚Ä¢ Guardar o documento f√≠sico na loja pelo prazo indicado pela pol√≠tica.</p>
</div>`;
    }

    // CASO 3: n√£o tenho confian√ßa suficiente pra dizer "pode"
    return `HTML:<div class="text-sm text-slate-700">
<p>Pra usar o cart√£o Clara, o gasto precisa ser <b>necess√°rio pra opera√ß√£o da loja</b (ex.: chaveiro emergencial, motoboy urgente, material de limpeza, perif√©rico de PDV, bobina fiscal, √°gua/coffee break autorizado pra treinamento interno ou a√ß√£o oficial).</p>
<p class="mt-2">O que <b>n√£o pode</b> no cart√£o Clara:<br/>
‚Ä¢ gasto pessoal (refei√ß√£o pessoal, compra pra uso pr√≥prio etc.);<br/>
‚Ä¢ bebida alco√≥lica;<br/>
‚Ä¢ transporte pessoal (Uber/99 pra deslocamento pessoal);<br/>
‚Ä¢ itens patrimoniais / infraestrutura grande (geladeira, micro-ondas, TV, mesa, cadeira etc.).</p>
<p class="mt-2">Se voc√™ acha que √© uma necessidade real da loja, abra chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer"><strong>ServiceNow</strong></a>
informando o caso.</p>
</div>`;
}

function respFollowup(msgNorm) {
    if (ultimaIntencao === "limite") return respLimite();
    if (ultimaIntencao === "bloqueio") return respBloqueio();
    if (ultimaIntencao === "prestacao") return respPrestacaoContas();
    if (ultimaIntencao === "alimentoTime") return respAlimentoTime();
    if (ultimaIntencao === "transportePessoal") return respTransportePessoal();
    if (ultimaIntencao === "trocaGerente") return respTrocaGerente();
    if (ultimaIntencao === "sangria") return respSangria();
    if (ultimaIntencao === "fraudeContestacao") return respFraudeContestacao();
    return respGenerica(msgNorm);
}

/* =====================================================
   Motor principal de resposta
   ===================================================== */
function gerarRespostaDoBot(msgUsuario) {
    const norm = normalize(msgUsuario);
    const intencao = detectarIntencaoPergunta(norm);
    let resposta;

    // üîÅ FLUXO ESPECIAL: consulta de pend√™ncias Clara (planilha) + envio por e-mail
    if (aguardandoLojaPendencias) {
        // Usu√°rio deve ter mandado o c√≥digo da loja agora
        const loja = norm.replace(/\D/g, "");
        if (!loja) {
            return 'HTML:<p class="text-sm text-slate-700">N√£o entendi o c√≥digo da loja. Me envie s√≥ os n√∫meros, por exemplo: <b>0171</b>.</p>';
        }

        // chama a API em modo JSON e, dentro dela, vamos trocar o estado para "aguardandoEmailPendencias"
        consultarPendenciasLoja(loja);
        // aqui j√° devolvo uma mensagem curtinha (consultarPendenciasLoja tamb√©m manda mensagem)
        return ''; // j√° estamos respondendo via renderBotMessage dentro da fun√ß√£o
    }

    if (aguardandoEmailPendencias) {
        // Usu√°rio deve estar mandando o e-mail agora
        enviarPendenciasPorEmail(msgUsuario);
        return ''; // a fun√ß√£o enviarPendenciasPorEmail cuida das mensagens
    }

        // Se estamos aguardando o n√∫mero da loja para consultar pend√™ncias
    if (modoConsultaPendencias === "aguardando_loja") {
        const match = msgUsuario.match(/\d{3,6}/); // captura algo tipo 123, 1234, 12345...
        if (!match) {
            return `HTML:<p class="text-sm text-slate-700">
N√£o entendi o n√∫mero da loja. Me manda s√≥ o c√≥digo num√©rico, por exemplo: <b>1234</b>.
            </p>`;
        }

        const loja = match[0];
        modoConsultaPendencias = null;
        lojaUltimaConsulta = loja;

        // Chama API ass√≠ncrona (Apps Script)
        consultarPendenciasLoja(loja);

        return `HTML:<p class="text-sm text-slate-700">
Beleza, vou consultar as pend√™ncias da loja <b>${loja}</b> e te mostro aqui embaixo üëá
        </p>`;
    }

    // üéØ Detecta fim de conversa / agradecimento
    const frasesEncerramento = [
        "ok", "okay", "okey", "certo", "blz", "beleza", "bl", "OK", "Ok", "oK",
        "entendi", "entendido", "tudo certo", "td certo", "tds certo",
        "t√° bom", "ta bom", "t√° √≥timo", "ta otimo", "t√° otimo", "entendi", "entendido",
        "show", "show de bola", "valeu", "vlw", "obrigado", "obrigada", "Obrigado", "Obrigada", "OBRIGADO", "OBRIGADA",
        "agradecido", "agradecida", "tranquilo", "de boa", "suave", "tks", "thaks",
        "pode deixar", "certinho", "maravilha", "perfeito", "j√≥ia", "joia"
    ].map(normalize);

    // se a mensagem cont√©m s√≥ uma dessas palavras curtas
    for (const frase of frasesEncerramento) {
        if (norm === frase || norm.startsWith(frase + " ") || norm.endsWith(" " + frase)) {
            const respostasEncerramento = [
                "Que bom que consegui ajudar! ü§ó Pode me chamar sempre que precisar.",
                "Show! Fico feliz em ajudar üòÑ",
                "Perfeito üëå qualquer d√∫vida, √© s√≥ chamar de novo!",
                "Valeu! At√© a pr√≥xima üöÄ",
                "Beleza üòé t√¥ por aqui se precisar de novo.",
                "T√° bom, qualquer coisa, √© s√≥ chamar!",
                "#jogamosentrosados",
            ];
            const random = Math.floor(Math.random() * respostasEncerramento.length);
            return `HTML:<p class="text-sm text-slate-700">${respostasEncerramento[random]}</p>`;
        }
    }

    // 0. PEDIR A POL√çTICA / PDF / DOCUMENTO OFICIAL
    const frasesPolitica = [
// Pedidos diretos de envio
        "me envia a politica",
        "me envia a pol√≠tica",
        "me manda a politica",
        "me manda a pol√≠tica",
        "me manda a politica de uso",
        "me manda a pol√≠tica de uso",
        "me manda a politica do cartao",
        "me manda a pol√≠tica do cart√£o",
        "me manda a politica do cartao clara",
        "me manda a pol√≠tica do cart√£o clara",
        "me envia a politica do cartao",
        "me envia a pol√≠tica do cart√£o",
        "manda a politica",
        "manda a pol√≠tica",
        "manda a politica de uso",
        "manda a pol√≠tica de uso",
        "manda a politica do cartao",
        "manda a pol√≠tica do cart√£o",
        "envia a politica",
        "envia a pol√≠tica",
        "envia politica de uso",
        "envia pol√≠tica de uso",
        "envia a politica do cartao",
        "envia a pol√≠tica do cart√£o",
        "me envia o pdf da politica",
        "me envia o pdf da pol√≠tica",
        "manda o pdf da politica",
        "manda o pdf da pol√≠tica",
        "me manda o pdf da politica do cartao",
        "me manda o pdf da pol√≠tica do cart√£o",
        "me envia o pdf da politica do cartao",
        "me envia o pdf da pol√≠tica do cart√£o",

        // Pedidos de link
        "me manda o link da politica",
        "me manda o link da pol√≠tica",
        "manda o link da politica",
        "manda o link da pol√≠tica",
        "manda o link da politica do cartao",
        "manda o link da pol√≠tica do cart√£o",
        "envia o link da politica",
        "envia o link da pol√≠tica",
        "me passa o link da politica",
        "me passa o link da pol√≠tica",
        "link da politica",
        "link da pol√≠tica",
        "link da politica do cartao",
        "link da pol√≠tica do cart√£o",
        "link da politica clara",
        "link da pol√≠tica clara",
        "me manda o link do documento da politica",
        "me manda o link do documento da pol√≠tica",

        // Falar de ‚Äúpol√≠tica do cart√£o‚Äù
        "politica do cartao",
        "pol√≠tica do cart√£o",
        "politica do cartao clara",
        "pol√≠tica do cart√£o clara",
        "politica do cartao das lojas",
        "pol√≠tica do cart√£o das lojas",
        "politica de uso do cartao",
        "pol√≠tica de uso do cart√£o",
        "politica de uso do cartao clara",
        "pol√≠tica de uso do cart√£o clara",
        "politica dos cartoes",
        "pol√≠tica dos cart√µes",
        "politica dos cartoes clara",
        "pol√≠tica dos cart√µes clara",
        "politica de cartoes clara",
        "pol√≠tica de cart√µes clara",

        // Pedido do documento / pdf / arquivo
        "me envia o documento da politica",
        "me envia o documento da pol√≠tica",
        "me manda o documento da politica",
        "me manda o documento da pol√≠tica",
        "documento da politica",
        "documento da pol√≠tica",
        "documento oficial da politica",
        "documento oficial da pol√≠tica",
        "arquivo da politica",
        "arquivo da pol√≠tica",
        "pdf da politica",
        "pdf da pol√≠tica",
        "pdf politica cartao",
        "pdf politica clara",
        "pdf politica do cartao",
        "pdf politica do cart√£o",
        "manual da politica",
        "manual da pol√≠tica",
        "manual do cartao clara",
        "manual do cart√£o clara",
        "manual de uso do cartao",
        "manual de uso do cart√£o",

        // Abrevia√ß√µes / erros / vers√µes curtas
        "politica cartao",
        "politica clara",
        "politica clara cartao",
        "politica cartao clara",
        "politica em pdf",
        "politica pdf",
        "politica de uso dos cartoes",
        "politica de uso dos cart√µes",
        "politica de uso dos cartoes clara",
        "politica de uso dos cart√µes clara",
        "me manda a politica clara",
        "me envia a politica clara",
        "manda politica clara",
        "manda politica do cartao clara",
        "manda politica do cartao pdf",
        "manda politica uso cartao",
        "manda politica cartao clara"
    ].map(normalize);

    for (const frase of frasesPolitica) {
        if (norm.includes(frase)) {
            ultimaIntencao = "politicaOficial";
            return respPoliticaOficial();
        }
    }

    // ...aqui continua o resto da fun√ß√£o (limite, gasto pessoal etc.)
    // 1. BLOCO: PERGUNTAS/ASSUNTOS SOBRE LIMITE
    if (norm.includes("limite")) {
        ultimaIntencao = "limite";
        return 'HTML:Se o limite mensal do cart√£o n√£o cobre a necessidade operacional da loja, o respons√°vel deve abrir chamado no <a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">ServiceNow</a>, explicando:<br>‚Ä¢ Qual gasto precisa fazer,<br>‚Ä¢ Urg√™ncia,<br>‚Ä¢ Por que o limite atual n√£o atende.<br><br>A aprova√ß√£o ou ajuste de limite √© feita pelo Financeiro.';
    }


    // 0. Perguntas gen√©ricas tipo "qual etiqueta usar?"
const perguntaGeralEtiqueta = [
    "qual etiqueta uso",
    "qual etiqueta usar",
    "qual etiqueta eu uso",
    "que etiqueta uso",
    "que etiqueta usar",
    "me fala as etiquetas",
    "todas as etiquetas",
    "lista de etiquetas",
    "quais etiquetas tem",
    "quais etiquetas existem",
    "quais sao as etiquetas",
    "quais s√£o as etiquetas",
    "me passa as etiquetas",
    "me passa as tags",
    "quais tags existem",
    "categorias de gasto",
    "categorias de despesas",
    "categoria de despesa"
].map(normalize);

for (const frase of perguntaGeralEtiqueta) {
    if (norm.includes(frase)) {
        ultimaIntencao = "catalogoEtiquetas";
        return respCatalogoEtiquetas();
    }
}

    // LIMITE (checagem expl√≠cita por palavra "limite")
    if (norm.includes("limite")) {
        ultimaIntencao = "limite";
        return respLimite();
    }

    // GASTO PESSOAL / ALIMENTA√á√ÉO PESSOAL
    const padroesGastoPessoalAlimentacao = [
        "paguei meu almoco","paguei meu almo√ßo","paguei meu jantar",
        "paguei meu lanche","paguei meu caf√©","paguei meu cafe",
        "paguei meu pastel","paguei minha refeicao","paguei minha refei√ß√£o",
        "paguei minha comida","paguei minha janta",

        "meu almo√ßo","meu almoco","meu jantar","minha janta",
        "meu lanche","meu lanche com o cartao","meu lanche com o cart√£o",
        "minha comida",

        "almoco pessoal","almo√ßo pessoal","jantar pessoal",
        "lanche pessoal","refei√ß√£o pessoal","refeicao pessoal",

        "almocei com o cartao","almocei com o cart√£o",
        "jantei com o cartao","jantei com o cart√£o",
        "comi com o cartao","comi com o cart√£o"
    ];

    const isGastoPessoalAlimentacao = padroesGastoPessoalAlimentacao.some(p => norm.includes(p));
    if (isGastoPessoalAlimentacao) {
        ultimaIntencao = "gasto_pessoal_alimentacao";
        return `HTML:<div class="text-sm text-slate-700">
<p>‚õî Refei√ß√£o pessoal (almo√ßo, jantar, lanche etc.) n√£o pode ser paga com o cart√£o Clara. Isso n√£o √© despesa operacional da loja.</p>

<p class="mt-2">Se j√° foi pago com o cart√£o:</p>
<ul class="list-disc ml-4">
<li>Avise o Financeiro e abra chamado no ServiceNow (Contas a Receber &gt; Cart√£o Clara &gt; Gasto Indevido - pessoal);</li>
<li>Classifique na Clara como "Despesa Pessoal ‚Äì Uso Indevido";</li>
<li>Ressar√ßa o valor √† empresa em at√© 2 dias √∫teis.</li>
</ul>

<p class="mt-2">Se n√£o regularizar, o cart√£o pode ficar bloqueado preventivamente.</p>
</div>`;
    }

        // üéØ Gatilho para iniciar fluxo de consulta de pend√™ncias Clara
    const termosPendencias = [
        "pendencia clara",
        "pend√™ncias clara",
        "pendencias clara",
        "ver pendencias",
        "ver pend√™ncias",
        "pendencias",
        "pend√™ncias",
        "consultar pendencias",
        "consultar pend√™ncias",
        "pendencia do cartao",
        "pend√™ncia do cart√£o",
        "bloqueio por pendencia",
        "bloqueio por pend√™ncia"
    ].map(normalize);

    if (termosPendencias.some(t => norm.includes(t))) {
        aguardandoLojaPendencias = true;
        aguardandoEmailPendencias = false;
        lojaPendenciasAtual = "";

        return 'HTML:<p class="text-sm text-slate-700">Consigo consultar as pend√™ncias Clara da sua loja e te mandar por e-mail. Me informa o c√≥digo da loja (somente n√∫meros), por exemplo: <b>0171</b>.</p>';
    }

    // Escolhe resposta por inten√ß√£o
    switch (intencao) {

        case "foraEscopo":
            ultimaIntencao = "foraEscopo";
            resposta = respostaForaEscopo();
            break;

        case "etiqueta":
    ultimaIntencao = "etiqueta";
    (function () {
        // Frases gen√©ricas do tipo "qual etiqueta devo usar?"
    const perguntasGeraisEtiqueta = [
        // Perguntas diretas
        "qual etiqueta devo usar",
        "qual etiqueta usar",
        "qual etiqueta eu uso",
        "que etiqueta devo usar",
        "que etiqueta usar",
        "que etiqueta eu uso",
        "me fala as etiquetas",
        "me diz as etiquetas",
        "me mostra as etiquetas",
        "me envia as etiquetas",
        "me passa as etiquetas",
        "me passa a etiqueta",
        "me passa etiqueta",
        "me diz etiqueta",
        "me diz qual etiqueta usar",
        "me diz qual etiqueta devo usar",
        "me diz etiqueta certa",
        "me fala etiqueta certa",
        "me fala qual etiqueta usar",
        "me fala qual etiqueta devo usar",
        "me ajuda com etiqueta",
        "qual etiqueta usar nesse caso",
        "qual etiqueta usar nesse gasto",
        "qual etiqueta usar pra isso",
        "qual etiqueta uso pra isso",
        "qual etiqueta usar pra compra",
        "qual etiqueta usar na clara",
        "qual etiqueta usar na plataforma",
        "qual etiqueta usar aqui",
        "me ajuda com etiqueta correta",
        "me fala etiqueta certa",
        "etiqueta certa",
        "etiqueta correta",
        "etiqueta pra usar",
        "etiqueta usar",
        "etiqueta devo usar",
        "etiqueta correta pra isso",
        "etiqueta usar nesse gasto",
        "qual etiqueta colocar",
        "que etiqueta colocar",
        "onde coloco etiqueta",
        "que etiqueta marcar",
        "qual categoria de despesa",
        "categoria de despesa",
        "categorias de despesas",
        "categorias de gasto",
        "categoria de gasto",
        "categoria de despesa usar",
        "categoria de despesa correta",
        "categoria correta",
        "categoria certa",
        "categoria usar",
        "categoria devo usar",
        "categoria eu uso",
        "qual categoria uso",
        "qual categoria devo usar",
        "qual categoria usar",
        "categoria clara",
        "etiqueta clara",
        "etiqueta clara usar",
    
        // Pedidos gen√©ricos de listagem
        "todas as etiquetas",
        "todas etiquetas",
        "lista de etiquetas",
        "listagem de etiquetas",
        "me envia a lista de etiquetas",
        "me envia a listagem de etiquetas",
        "me manda as etiquetas",
        "me manda a lista de etiquetas",
        "me manda a listagem de etiquetas",
        "mostra todas as etiquetas",
        "me mostra todas etiquetas",
        "me mostra todas as categorias",
        "quais etiquetas existem",
        "quais etiquetas tem",
        "quais sao as etiquetas",
        "quais s√£o as etiquetas",
        "quais etiquetas posso usar",
        "quais etiquetas devo usar",
        "quais etiquetas usar",
        "quais etiquetas existem na clara",
        "quais categorias de despesa",
        "quais categorias tem",
        "quais categorias existem",
        "quais categorias usar",
        "quais tags tem",
        "quais tags usar",
        "me fala as tags",
        "me manda as tags",
        "tags de despesa",
        "tags de gasto",
        "tags claras",
    
        // Abrevia√ß√µes / erros comuns / varia√ß√µes
        "etiqueta usar",
        "etiqueta ussar",
        "etiqueta uzar",
        "etiqueta usa",
        "etiqueta devo usa",
        "etiqueta devo uzar",
        "etiqueta coreta",
        "etiqueta cerra",
        "etiqueta sertta",
        "etiqueta cerra usar",
        "etiqueta serve pra",
        "etiketa usar",
        "etiketa devo usar",
        "etiquetao usar",
        "etiq usar",
        "etiq devo usar",
        "cat gasto",
        "cat despesa",
        "categoria usar",
        "categoria usar pra isso",
        "categoria uzar",
        "categ usar",
        "categ devo usar",
        "cat usar",
        "cat devo usar",
        "qual etiq usar",
        "qual etiq devo usar",
        "etiq correta",
        "etiq certa",
        "etiq pra usar",
        "etiq",
        "cat",
        "categoria",
        "categoria certa pra isso",
        "me ajuda etiqueta",
        "me ajuda com categoria",
        "me ajuda categoria",
        "me ajuda etiq",
        "qual etiq certa",
        "qual etiq correta",
        "qual etiq",
        "etiqueta qual",
        "cat desp",
        "cat gasto certo",
        "cat correta",
        "cat correta pra isso",
        "cat certa pra isso",
        "me ajuda cat",
        "me ajuda cat correta",
        "me ajuda etiq certa",
        "me ajuda etiq correta"
].map(normalize);

        const isPerguntaGeral = perguntasGeraisEtiqueta.some(f => norm.includes(f));

        const et = acharEtiquetaPorMensagem(norm);

        // üëâ Caso 1: Pergunta gen√©rica de etiqueta, sem item espec√≠fico
        if (!et && isPerguntaGeral) {
            resposta = respCatalogoEtiquetas();
            return;
        }

        // üëâ Caso 2: Achamos uma etiqueta espec√≠fica (mouse, √°gua, motoboy etc.)
        if (et) {
            resposta = respEtiquetaDireta(et);
            return;
        }

        // üëâ Caso 3: Nem √© gen√©rica, nem achou etiqueta -> fallback padr√£o
        resposta = `HTML:<p class="text-sm text-slate-700">
N√£o consegui identificar uma etiqueta espec√≠fica s√≥ com esse texto.<br/>
Se o gasto for operacional e n√£o existir etiqueta adequada na lista da Clara, abra chamado no
<a class="service-link" href="https://sn.gruposbf.com.br/sp?id=ticket&is_new_order=true&table=incident&sys_id=52d2e0ef1b06e1907540a6cae54bcbe6" target="_blank" rel="noopener noreferrer">
<strong>ServiceNow</strong>
</a>
solicitando cria√ß√£o ou ajuste de etiqueta.
</p>`;
    })();
    break;

        case "limite":
            ultimaIntencao = "limite";
            resposta = respLimite();
            break;

        case "bloqueio":
    ultimaIntencao = "bloqueio";
    modoConsultaPendencias = "aguardando_loja";
    resposta = `HTML:<div class="text-sm text-slate-700">
${respBloqueio().replace(/^HTML:/, "").trim()}
<p class="mt-3"><b>Se quiser, me informe o n√∫mero da sua loja</b> (ex.: 1234) que eu consulto se h√° transa√ß√µes pendentes de justificativas.</p>
</div>`;
    break;

        case "prestacao":
            ultimaIntencao = "prestacao";
            resposta = respPrestacaoContas();
            break;

        case "alimentoTime":
            ultimaIntencao = "alimentoTime";
            resposta = respAlimentoTime();
            break;

        case "transportePessoal":
            ultimaIntencao = "transportePessoal";
            resposta = respTransportePessoal();
            break;

        case "trocaGerente":
            ultimaIntencao = "trocaGerente";
            resposta = respTrocaGerente();
            break;

        case "sangria":
            ultimaIntencao = "sangria";
            resposta = respSangria();
            break;

        case "fraudeContestacao":
            ultimaIntencao = "fraudeContestacao";
            resposta = respFraudeContestacao();
            break;

        case "podeNaoPode":
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;

        case "generica":
        default:
            ultimaIntencao = "generica";
            resposta = respGenerica(norm);
            break;
    }

    return resposta;
}

/* =====================================================
   === RENDERIZA√á√ÉO / CHAT UI ===
   ===================================================== */

const chatWindow = document.getElementById("chatWindow");
const chatForm   = document.getElementById("chatForm");
const userInput  = document.getElementById("userInput");
const sendBtn    = document.getElementById("sendBtn");

/* faz o scroll descer sempre pro fim do chat */
function scrollToBottom() {
    requestAnimationFrame(() => {
        chatWindow.scrollTop = chatWindow.scrollHeight;
        setTimeout(() => {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }, 150);
    });
}

/* mensagem do usu√°rio */
function renderUserMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start justify-end gap-3";

    const bubble = document.createElement("div");
    bubble.className = "user-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-white";
    bubble.innerText = text;

    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

/* mensagem do bot */
function renderBotMessage(text) {
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-start gap-3";

    const avatar = document.createElement("img");
    avatar.src = "Gemini_Generated_Image_nzni5znzni5znzni.png";
    avatar.alt = "Assistente Clara (rob√¥)";
    avatar.className = "h-14 w-auto object-contain flex-shrink-0";

    const bubble = document.createElement("div");
    bubble.className = "bot-bubble px-4 py-3 max-w-[80%] text-sm whitespace-pre-line text-slate-700";

    if (typeof text === "string" && text.startsWith("HTML:")) {
        bubble.innerHTML = text.replace(/^HTML:/, "").trim();
    } else {
        bubble.innerText = text;
    }

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    chatWindow.appendChild(wrapper);
    scrollToBottom();
}

/* envia a pergunta, pega resposta, renderiza */
function enviarMensagem() {
    const pergunta = userInput.value.trim();
    if (!pergunta) return;

    renderUserMessage(pergunta);

    const resposta = gerarRespostaDoBot(pergunta);

    renderBotMessage(resposta);

    userInput.value = "";
    userInput.focus();

    scrollToBottom();
}

/* LISTENERS */

/* Enter sem Shift = enviar. Shift+Enter = quebra linha */
userInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem();
    }
});

/* clique no bot√£o Enviar */
sendBtn.addEventListener("click", function (e) {
    e.preventDefault();
    enviarMensagem();
});

// submit do form (mobile etc.)
chatForm.addEventListener("submit", function (e) {
    e.preventDefault();
    enviarMensagem();
});

// ‚¨á‚¨á‚¨á ADICIONE ESTA LINHA LOGO AQUI
}); // fecha o document.addEventListener("DOMContentLoaded", () => { ... )
</script>
</body>
</html>
